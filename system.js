// ç³»çµ±è³‡æ–™å„²å­˜
// ç”¨æˆ¶ç™»å…¥å¾Œçš„è³‡æ–™
let currentUser = null;
let currentUserData = null;

// å…¨åŸŸè‡ªè¨‚æ¬Šé™ï¼ˆCustom Claimsï¼‰å„²å­˜å€
// æ–¼ Firebase ç™»å…¥å¾Œè¼‰å…¥ä½¿ç”¨è€…çš„ ID Token ä¸¦è§£æžå…¶ä¸­çš„è‡ªè¨‚æ¬Šé™ï¼Œå†å­˜å…¥æ­¤å°è±¡
// ä»¥ä¾¿å…¶ä»–æ¨¡çµ„ï¼ˆä¾‹å¦‚ schedule_management.jsï¼‰å¯ç›´æŽ¥å­˜å–
window.currentUserClaims = {};

/**
 * A simple debounce utility to delay the execution of a function until after a specified
 * delay has passed since its last invocation. This helps to avoid triggering expensive
 * operations (like filtering or AJAX requests) too frequently as a user types or
 * performs repetitive actions.
 *
 * @param {Function} func - The function to debounce.
 * @param {number} wait - The number of milliseconds to delay.
 * @param {boolean} immediate - If `true`, trigger on the leading edge instead of the trailing.
 * @returns {Function} A new debounced function.
 */
function debounce(func, wait, immediate = false) {
    let timeout;
    return function (...args) {
        const context = this;
        const later = function () {
            timeout = null;
            if (!immediate) func.apply(context, args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
    };
}

/**
 * å…¨åŸŸçš„åˆ†é è¨­å®šï¼Œç”¨æ–¼æŽ§åˆ¶å„æ¨¡çµ„çš„ç•¶å‰é ç¢¼èˆ‡æ¯é é¡¯ç¤ºæ•¸é‡ã€‚
 * ç•¶æœå°‹æˆ–ç¯©é¸æ¢ä»¶æ”¹è®Šæ™‚ï¼Œæ‡‰é‡ç½® currentPage ç‚º 1ã€‚
 */
const paginationSettings = {
    // å°‡ä¸­è—¥åº«æ¯é é¡¯ç¤ºæ•¸é‡èª¿æ•´ç‚º 9ï¼Œä»¥æ»¿è¶³ç”¨æˆ¶éœ€æ±‚
    herbLibrary: { currentPage: 1, itemsPerPage: 9 },
    personalHerbCombos: { currentPage: 1, itemsPerPage: 6 },
    personalAcupointCombos: { currentPage: 1, itemsPerPage: 6 },
    prescriptionTemplates: { currentPage: 1, itemsPerPage: 6 },
    diagnosisTemplates: { currentPage: 1, itemsPerPage: 6 },
    patientList: { currentPage: 1, itemsPerPage: 10 },
    // æ–°å¢žç—…æ­·ç®¡ç†åˆ—è¡¨çš„åˆ†é è¨­å®š
    medicalRecordList: { currentPage: 1, itemsPerPage: 10 }
};

/**
 * åˆå§‹åŒ–ç©´ä½åœ–æ”¾å¤§é¡æ•ˆæžœã€‚
 * æ­¤å‡½å¼æœƒåœ¨ id="acupointImage" çš„åœ–ç‰‡ä¸Šæ·»åŠ æ”¾å¤§é¡è¦–çª—ï¼Œä½¿ä½¿ç”¨è€…å¯é€éŽæ»‘é¼ æˆ–è§¸æŽ§æ”¾å¤§æŸ¥çœ‹ç´°ç¯€ã€‚
 * è‹¥åœ–ç‰‡ä¸å­˜åœ¨æˆ–å·²ç¶“åˆå§‹åŒ–ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œã€‚
 */
function initAcupointMagnifier() {
    try {
        const img = document.getElementById('acupointImage');
        if (!img) {
            return;
        }
        // é¿å…é‡è¤‡å»ºç«‹æ”¾å¤§é¡
        if (img.dataset && img.dataset.magnified) {
            return;
        }
        // æ¨™è¨˜ç‚ºå·²åˆå§‹åŒ–
        if (img.dataset) {
            img.dataset.magnified = 'true';
        }
        // è¨­å®šæ”¾å¤§å€çŽ‡ï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´
        magnify(img, 2);
    } catch (e) {
        console.warn('åˆå§‹åŒ–ç©´ä½æ”¾å¤§é¡å¤±æ•—:', e);
    }
}

// initAcupointMap å‡½å¼å·²æ¬è‡³ acupointIntegration.js

/**
 * å»ºç«‹æ”¾å¤§é¡æ•ˆæžœçš„æ ¸å¿ƒå‡½å¼ã€‚
 * åœ¨çµ¦å®šçš„åœ–ç‰‡å…ƒç´ ä¸Šç”¢ç”Ÿä¸€å€‹åœ“å½¢é¡ç‰‡ï¼Œéš¨è‘—æ»‘é¼ ç§»å‹•é¡¯ç¤ºæ”¾å¤§çš„åœ–ç‰‡å±€éƒ¨ã€‚
 * @param {HTMLElement} img - å°‡å¥—ç”¨æ”¾å¤§é¡æ•ˆæžœçš„åœ–ç‰‡å…ƒç´ 
 * @param {number} zoom - æ”¾å¤§å€çŽ‡ï¼Œä¾‹å¦‚ 2 è¡¨ç¤ºæ”¾å¤§å…©å€
 */
function magnify(img, zoom) {
    // å»ºç«‹é¡ç‰‡å…ƒç´ 
    const lens = document.createElement('div');
    lens.setAttribute('class', 'img-magnifier-glass');
    // ç¢ºä¿çˆ¶å®¹å™¨ç‚ºç›¸å°å®šä½ï¼Œè‹¥æ²’æœ‰è¨­å®šå‰‡è‡ªå‹•è¨­ç‚º relative
    const container = img.parentElement;
    if (container) {
        const style = window.getComputedStyle(container);
        if (style.position === 'static' || !style.position) {
            container.style.position = 'relative';
        }
        container.insertBefore(lens, img);
    } else {
        document.body.insertBefore(lens, img);
    }
    // è¨­å®šé¡ç‰‡èƒŒæ™¯ç‚ºåŽŸåœ–
    lens.style.backgroundImage = `url('${img.src}')`;
    lens.style.backgroundRepeat = 'no-repeat';
    // å–å¾—é¡ç‰‡å°ºå¯¸ä¸€åŠï¼Œç”¨æ–¼è¨ˆç®—å®šä½
    const w = lens.offsetWidth / 2;
    const h = lens.offsetHeight / 2;
    // ä¾æ“šæ”¾å¤§å€çŽ‡è¨­å®šèƒŒæ™¯å¤§å°
    lens.style.backgroundSize = (img.width * zoom) + 'px ' + (img.height * zoom) + 'px';
    // åœ¨é¡ç‰‡ä¸­å¿ƒåŠ å…¥æŒ‡æ¨™é»ž
    const pointer = document.createElement('div');
    pointer.className = 'magnifier-pointer';
    lens.appendChild(pointer);

    // äº‹ä»¶è™•ç†å‡½å¼ï¼Œæ ¹æ“šæ»‘é¼ ä½ç½®æ›´æ–°é¡ç‰‡ä½ç½®èˆ‡èƒŒæ™¯åç§»
    function moveLens(e) {
        e.preventDefault();
        const pos = getCursorPos(e);
        let x = pos.x;
        let y = pos.y;
        // é˜²æ­¢é¡ç‰‡è¶…å‡ºåœ–ç‰‡é‚Šç•Œ
        if (x > img.width - (w / zoom)) { x = img.width - (w / zoom); }
        if (x < w / zoom) { x = w / zoom; }
        if (y > img.height - (h / zoom)) { y = img.height - (h / zoom); }
        if (y < h / zoom) { y = h / zoom; }
        // æ›´æ–°é¡ç‰‡çš„ä½ç½®
        lens.style.left = (x - w) + 'px';
        lens.style.top = (y - h) + 'px';
        // æ›´æ–°èƒŒæ™¯ä½ç½®ä½¿æ”¾å¤§å€åŸŸå°æº–é¡ç‰‡ä¸­å¿ƒ
        // è€ƒæ…®é¡ç‰‡é‚Šæ¡†å¯¬åº¦ï¼Œä»¥é¿å…è¦–è¦ºåå·®
        const bw = parseInt(window.getComputedStyle(lens).borderTopWidth) || 0;
        lens.style.backgroundPosition = '-' + ((x * zoom) - w + bw) + 'px -' + ((y * zoom) - h + bw) + 'px';
    }
    // è¨ˆç®—æ»‘é¼ åœ¨åœ–ç‰‡å…§çš„åº§æ¨™
    function getCursorPos(e) {
        const rect = img.getBoundingClientRect();
        let x = e.pageX - rect.left - window.pageXOffset;
        let y = e.pageY - rect.top - window.pageYOffset;
        return { x, y };
    }
    // ç¶å®šæ»‘é¼ èˆ‡è§¸æŽ§ç§»å‹•äº‹ä»¶
    lens.addEventListener('mousemove', moveLens);
    img.addEventListener('mousemove', moveLens);
    lens.addEventListener('touchmove', moveLens);
    img.addEventListener('touchmove', moveLens);
}

// ç‚ºç©´ä½åº«æ–°å¢žåˆ†é è¨­å®šï¼Œæ¯é é¡¯ç¤º 6 ç­†è³‡æ–™
paginationSettings.acupointLibrary = { currentPage: 1, itemsPerPage: 6 };

// å–®ä½è½‰æ›è¡¨èˆ‡å–®ä½é¡¯ç¤ºåç¨±ã€‚
// å°‡æ‰€æœ‰åº«å­˜èˆ‡è­¦æˆ’é‡ä»¥å…‹ (g) ç‚ºåŸºæº–å„²å­˜ï¼›é€éŽä¸‹æ–¹è¡¨æ ¼å¯å°‡æ•¸å€¼è½‰æ›ç‚ºä¸åŒå–®ä½ä»¥ä¾›é¡¯ç¤ºã€‚
const UNIT_FACTOR_MAP = {
    g: 1,
    jin: 600,
    liang: 37.5,
    qian: 3.75
};
const UNIT_LABEL_MAP = {
    g: 'å…‹',
    jin: 'æ–¤',
    liang: 'å…©',
    qian: 'éŒ¢'
};

// åœ¨åº«å­˜ç·¨è¼¯å½ˆçª—ä¸­ï¼Œç•¶ç”¨æˆ¶åˆ‡æ›æ•¸é‡å–®ä½æ™‚ï¼Œæ ¹æ“šæ‰€é¸å–®ä½è‡ªå‹•æ›ç®—åº«å­˜èˆ‡è£œè²¨è­¦æˆ’é‡ã€‚
// é€éŽ dataset.prevUnit å„²å­˜å‰ä¸€æ¬¡çš„å–®ä½ï¼Œä»¥ä¾¿è¨ˆç®—è½‰æ›æ¯”ä¾‹ã€‚
document.addEventListener('DOMContentLoaded', function () {
    try {
        const qtyUnitSelect = document.getElementById('inventoryQuantityUnit');
        // è‹¥å…ƒç´ å­˜åœ¨æ‰ç¶å®šäº‹ä»¶ï¼Œä»¥é¿å…å…¶ä»–é é¢ç„¡æ­¤å…ƒç´ å°Žè‡´éŒ¯èª¤ã€‚
        if (qtyUnitSelect) {
            // åˆå§‹åŒ– prevUnit ç‚ºç•¶å‰é¸å®šçš„å–®ä½ï¼ˆé è¨­ç‚º gï¼‰
            qtyUnitSelect.dataset.prevUnit = qtyUnitSelect.value || 'g';
            // è‹¥å…ˆå‰å·²ç¶å®šç›£è½å™¨ï¼Œå…ˆç§»é™¤ï¼Œé¿å…é‡è¤‡ç¶å®š
            if (qtyUnitSelect._unitChangeHandler) {
                qtyUnitSelect.removeEventListener('change', qtyUnitSelect._unitChangeHandler);
            }
            // å®šç¾©æ–°çš„è®Šæ›´è™•ç†å‡½å¼
            qtyUnitSelect._unitChangeHandler = function (e) {
                const selectEl = e && e.target ? e.target : qtyUnitSelect;
                const newUnitVal = selectEl.value || 'g';
                const prevUnitVal = selectEl.dataset.prevUnit || 'g';
                // è‹¥å–®ä½æœªæ”¹è®Šï¼Œå‰‡ä¸éœ€è½‰æ›
                if (newUnitVal === prevUnitVal) {
                    return;
                }
                // è®€å–è¼¸å…¥æ¬„ä½
                const qtyInput = document.getElementById('inventoryQuantity');
                const thrInput = document.getElementById('inventoryThreshold');
                // å–å¾—è½‰æ›å› å­
                const prevFactor = UNIT_FACTOR_MAP[prevUnitVal] || 1;
                const newFactorVal = UNIT_FACTOR_MAP[newUnitVal] || 1;
                // æ›ç®—å‰©é¤˜æ•¸é‡
                if (qtyInput) {
                    const qValRaw = parseFloat(qtyInput.value);
                    if (!isNaN(qValRaw)) {
                        const grams = qValRaw * prevFactor;
                        const convertedQty = grams / newFactorVal;
                        // å››æ¨äº”å…¥åˆ°å°æ•¸é»žåŽä¸‰ä½ï¼Œé¿å…ç²¾åº¦éŽé•·
                        qtyInput.value = (Math.round(convertedQty * 1000) / 1000).toString();
                    }
                }
                // æ›ç®—è£œè²¨è­¦æˆ’é‡
                if (thrInput) {
                    const thrValRaw = parseFloat(thrInput.value);
                    if (!isNaN(thrValRaw)) {
                        const grams = thrValRaw * prevFactor;
                        const convertedThr = grams / newFactorVal;
                        thrInput.value = (Math.round(convertedThr * 1000) / 1000).toString();
                    }
                }
                // æ›´æ–°å‰ä¸€æ¬¡çš„å–®ä½ç‚ºæ–°çš„é¸é …
                selectEl.dataset.prevUnit = newUnitVal;
            };
            // ç¶å®šæ–°çš„ç›£è½å™¨
            qtyUnitSelect.addEventListener('change', qtyUnitSelect._unitChangeHandler);
        }
    } catch (_e) {
        // å¿½ç•¥ä»»ä½•ç•°å¸¸ä»¥é¿å…å½±éŸ¿å…¶ä»–åŠŸèƒ½
    }
});

// DOMContentLoaded äº‹ä»¶ï¼šåˆå§‹åŒ–è™•æ–¹æœå°‹å€åŸŸçš„åº«å­˜æ¨¡å¼é¸å–®
document.addEventListener('DOMContentLoaded', function () {
    try {
        const selectEl = document.getElementById('prescriptionTypeSelect');
        if (selectEl) {
            // è¨­å®šé è¨­å€¼ç‚ºç•¶å‰åº«å­˜æ¨¡å¼ï¼Œè‹¥ä¸å­˜åœ¨å‰‡ä½¿ç”¨ granule
            let defaultMode = 'granule';
            try {
                if (typeof currentInventoryMode !== 'undefined' && (currentInventoryMode === 'granule' || currentInventoryMode === 'slice')) {
                    defaultMode = currentInventoryMode;
                } else {
                    // å˜—è©¦å¾ž localStorage è®€å–
                    const storedMode = (typeof localStorage !== 'undefined') ? localStorage.getItem('inventoryMode') : null;
                    if (storedMode === 'granule' || storedMode === 'slice') {
                        defaultMode = storedMode;
                    }
                }
            } catch (_e) {
                /* å¿½ç•¥ localStorage è®€å–éŒ¯èª¤ */
            }
            selectEl.value = defaultMode;
            // ç¿»è­¯é¸é …æ–‡å­—ï¼ˆè‹¥å¯ç”¨ï¼‰
            const granOpt = selectEl.querySelector('option[value="granule"]');
            const sliceOpt = selectEl.querySelector('option[value="slice"]');
            if (granOpt) {
                let label = 'é¡†ç²’æ²–åŠ‘';
                try {
                    if (typeof window.t === 'function') {
                        const translated = window.t('é¡†ç²’æ²–åŠ‘');
                        if (translated) label = translated;
                    }
                } catch (_e) {
                    /* å¿½ç•¥ç¿»è­¯éŒ¯èª¤ */
                }
                granOpt.textContent = label;
            }
            if (sliceOpt) {
                let label = 'é£²ç‰‡';
                try {
                    if (typeof window.t === 'function') {
                        const translated = window.t('é£²ç‰‡');
                        if (translated) label = translated;
                    }
                } catch (_e) {
                    /* å¿½ç•¥ç¿»è­¯éŒ¯èª¤ */
                }
                sliceOpt.textContent = label;
            }
        }
    } catch (_e) {
        /* å¿½ç•¥åˆå§‹åŒ–éŒ¯èª¤ */
    }
});

// ç”¨æ–¼æŽ›è™Ÿæœå°‹çµæžœçš„éµç›¤å°Žèˆªç´¢å¼•
// ç•¶ç—…äººæœå°‹çµæžœå‡ºç¾æ™‚ï¼Œæ­¤ç´¢å¼•ç”¨æ–¼è¨˜éŒ„ç•¶å‰é¸ä¸­é …ç›®ï¼›-1 è¡¨ç¤ºæœªé¸ä¸­
let patientSearchSelectionIndex = -1;

// ç”¨æ–¼å€‹äººæ…£ç”¨ä¸­è—¥çµ„åˆæœå°‹çµæžœçš„éµç›¤å°Žèˆªç´¢å¼•
// herbIngredientSearchSelectionIndex ç”¨æ–¼è¨˜éŒ„ä¸­è—¥æçµ„åˆæœå°‹ç›®å‰é¸ä¸­çš„é …ç›®ï¼›-1 è¡¨ç¤ºæ²’æœ‰é¸ä¸­
let herbIngredientSearchSelectionIndex = -1;

// ç”¨æ–¼å€‹äººæ…£ç”¨ç©´ä½çµ„åˆæœå°‹çµæžœçš„éµç›¤å°Žèˆªç´¢å¼•
// acupointComboSearchSelectionIndex ç”¨æ–¼è¨˜éŒ„ç©´ä½çµ„åˆæœå°‹ç›®å‰é¸ä¸­çš„é …ç›®ï¼›-1 è¡¨ç¤ºæ²’æœ‰é¸ä¸­
let acupointComboSearchSelectionIndex = -1;

// ç‚ºç—…äººè©³ç´°è³‡æ–™ä¸­çš„å¥—ç¥¨æƒ…æ³æ–°å¢žåˆ†é è¨­å®šã€‚
// è‹¥æ¢ä»¶æ”¹è®Šï¼ˆä¾‹å¦‚é‡æ–°æŸ¥çœ‹å¦ä¸€ä½ç—…äººï¼‰ï¼Œæ‡‰é‡ç½® currentPage ç‚º 1ã€‚
paginationSettings.patientPackageStatus = { currentPage: 1, itemsPerPage: 6 };

// å¿«å–ç—…äººç¯©é¸çµæžœï¼Œç”¨æ–¼åˆ†é é¡¯ç¤º
let patientListFiltered = [];

/**
 * ç›®å‰çš„ä¸­è—¥åº«æŽ’åºæ–¹å¼ã€‚
 * å¯è¨­ç‚º 'most' è¡¨ç¤ºåº«å­˜æœ€å¤šå„ªå…ˆï¼Œ'least' è¡¨ç¤ºåº«å­˜æœ€å°‘å„ªå…ˆï¼Œ
 * æˆ–ç•™ç©ºå­—ä¸²è¡¨ç¤ºä¸é€²è¡Œç‰¹å®šæŽ’åºã€‚
 */
let herbSortOrder = '';

/**
 * è®Šæ›´ä¸­è—¥åº«æŽ’åºæ–¹å¼ä¸¦é‡æ–°è¼‰å…¥åˆ—è¡¨ã€‚
 * ç•¶æŽ’åºæ¢ä»¶æ”¹è®Šæ™‚æœƒé‡ç½®åˆ†é è‡³ç¬¬ä¸€é ï¼Œä»¥ç¢ºä¿é¡¯ç¤ºæ­£ç¢ºã€‚
 * @param {string} order æŽ’åºæ–¹å¼ï¼Œå¯ç‚º 'most'ã€'least' æˆ–ç©ºå­—ä¸²
 */
function changeHerbSortOrder(order) {
    herbSortOrder = order || '';
    // ç•¶æŽ’åºæ–¹å¼è®Šæ›´æ™‚ï¼Œå°‡ä¸­è—¥åº«ç•¶å‰é è¨­ç‚º 1
    if (paginationSettings && paginationSettings.herbLibrary) {
        paginationSettings.herbLibrary.currentPage = 1;
    }
    if (typeof displayHerbLibrary === 'function') {
        displayHerbLibrary();
    }
}

// å°‡æŽ’åºå‡½å¼æš´éœ²åˆ°å…¨åŸŸï¼Œä¾› HTML select å…ƒç´ èª¿ç”¨
window.changeHerbSortOrder = changeHerbSortOrder;

/**
 * åˆ‡æ›é¡†ç²’æ²–åŠ‘èˆ‡é£²ç‰‡çš„é¡¯ç¤ºæ¨¡å¼ã€‚
 * æ ¹æ“šé¸æ“‡æ›´æ–° currentInventoryMode ä¸¦ä¿å­˜åˆ° localStorageï¼Œ
 * ç„¶å¾Œé‡æ–°åˆå§‹åŒ–åº«å­˜è³‡æ–™ä»¥åˆ‡æ›è³‡æ–™ä¾†æºã€‚
 * @param {string} type 'granule' æˆ– 'slice'
 */
function changeInventoryType(type) {
    if (type !== 'granule' && type !== 'slice') {
        return;
    }
    currentInventoryMode = type;
    // ä¿å­˜é¸æ“‡è‡³ localStorageï¼Œä»¥ä¾¿ä¸‹æ¬¡è¼‰å…¥
    try {
        if (typeof localStorage !== 'undefined') {
            localStorage.setItem('inventoryMode', type);
        }
    } catch (_e) {
        // å¿½ç•¥ localStorage éŒ¯èª¤
    }
    // å¼·åˆ¶åˆ·æ–°åº«å­˜è³‡æ–™ï¼Œåˆ‡æ›ç›£è½è·¯å¾‘
    if (typeof initHerbInventory === 'function') {
        initHerbInventory(true).then(() => {
            // é‡æ–°æ¸²æŸ“ä¸­è—¥åº«åˆ—è¡¨
            if (typeof displayHerbLibrary === 'function') {
                displayHerbLibrary();
            }
        }).catch((_err) => {
            // åˆå§‹åŒ–å¤±æ•—æ™‚è‡³å°‘å˜—è©¦åˆ·æ–°ç•«é¢
            if (typeof displayHerbLibrary === 'function') {
                displayHerbLibrary();
            }
        });
    }
}

/**
 * åœ¨è™•æ–¹ä¸­é¸æ“‡é¡†ç²’æ²–åŠ‘æˆ–é£²ç‰‡æ™‚åˆ‡æ›åº«å­˜æ¨¡å¼ã€‚
 * é€™å€‹å‡½å¼æœƒå‘¼å«åŽŸæœ‰çš„ changeInventoryType æ›´æ–°å…¨åŸŸåº«å­˜æ¨¡å¼ï¼Œ
 * ä¸¦åœ¨åˆ‡æ›å¾Œè§¸ç™¼é‡æ–°æœå°‹è™•æ–¹ç”¨è—¥ï¼Œä»¥ä¾¿é¡¯ç¤ºæ–°çš„åº«å­˜é¤˜é‡ã€‚
 * @param {string} type 'granule' æˆ– 'slice'
 */
function onPrescriptionTypeChange(type) {
    // æª¢æŸ¥è¼¸å…¥æ˜¯å¦æœ‰æ•ˆ
    if (type !== 'granule' && type !== 'slice') {
        return;
    }
    // åˆ‡æ›å…¨åŸŸåº«å­˜æ¨¡å¼
    try {
        changeInventoryType(type);
    } catch (_e) {
        // è‹¥åˆ‡æ›å¤±æ•—ï¼Œä»ç„¶å˜—è©¦å¾ŒçºŒå‹•ä½œ
    }

    // åŒæ­¥ä¸­è—¥åº«çš„ä¸‹æ‹‰é¸å–®ï¼Œä½¿å…¶åæ˜ æ–°çš„åº«å­˜æ¨¡å¼
    try {
        const invSel = document.getElementById('inventoryTypeSelect');
        if (invSel && invSel.value !== type) {
            invSel.value = type;
        }
    } catch (_e) {
        /* å¿½ç•¥åŒæ­¥éŒ¯èª¤ */
    }
    // è‹¥ä½¿ç”¨è€…åœ¨è™•æ–¹æœå°‹æ¬„ä¸­å·²è¼¸å…¥é—œéµå­—ï¼Œç¨å¾Œé‡æ–°æœå°‹ä»¥æ›´æ–°çµæžœ
    try {
        const searchEl = document.getElementById('prescriptionSearch');
        const query = searchEl && searchEl.value ? String(searchEl.value).trim() : '';
        if (query && query.length > 0) {
            // å»¶é²åŸ·è¡Œä»¥ç­‰å¾…åº«å­˜è³‡æ–™åˆ·æ–°
            setTimeout(function () {
                try {
                    searchHerbsForPrescription();
                } catch (_e) {
                    /* å¿½ç•¥æœç´¢éŒ¯èª¤ */
                }
            }, 300);
        }
    } catch (_e) {
        /* å¿½ç•¥æœå°‹ç›¸é—œéŒ¯èª¤ */
    }
}

// ç•¶ä½¿ç”¨è€…å¾žä¸­è—¥åº«ä»‹é¢é¸æ“‡é¡†ç²’æ²–åŠ‘æˆ–é£²ç‰‡æ™‚å‘¼å«æ­¤å‡½å¼ã€‚
// æœƒåŒæ­¥èª¿æ•´è¨ºç—‡ç³»çµ±çš„ä¸‹æ‹‰é¸å–®ä¸¦åˆ‡æ›åº«å­˜æ¨¡å¼ï¼Œä½†è‹¥è™•æ–¹å·²æœ‰å…§å®¹å‰‡ä¸å…è¨±åˆ‡æ›ã€‚
function onInventoryTypeChange(type) {
    // æª¢æŸ¥è¼¸å…¥é¡žåž‹æœ‰æ•ˆ
    if (type !== 'granule' && type !== 'slice') {
        return;
    }
    // è‹¥è™•æ–¹ä¸­å·²æœ‰è—¥æä¸”èˆ‡ç•¶å‰åº«å­˜é¡žåˆ¥ä¸åŒï¼Œä¸å…è¨±åˆ‡æ›
    try {
        if (Array.isArray(selectedPrescriptionItems) && selectedPrescriptionItems.length > 0 && currentInventoryMode !== type) {
            // å°‡åº«å­˜ä¸‹æ‹‰é¸å–®çš„å€¼é‚„åŽŸç‚ºç•¶å‰æ¨¡å¼
            const invSel = document.getElementById('inventoryTypeSelect');
            if (invSel) {
                invSel.value = currentInventoryMode;
            }
            // é¡¯ç¤ºæé†’ï¼šå¿…é ˆæ¸…ç©ºè™•æ–¹æ‰èƒ½åˆ‡æ›
            try {
                const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                const zhMsg = 'è«‹å…ˆåˆªé™¤æ‰€æœ‰è™•æ–¹å…§å®¹æ‰èƒ½åˆ‡æ›è—¥æé¡žåˆ¥';
                const enMsg = 'Please remove all prescription items before switching inventory type';
                const msg = (langSel && langSel.toLowerCase().startsWith('en')) ? enMsg : zhMsg;
                showToast(msg, 'warning');
            } catch (_toastErr) {
                /* å¿½ç•¥æç¤ºéŒ¯èª¤ */
            }
            return;
        }
    } catch (_e) {
        /* è‹¥æª¢æŸ¥è™•æ–¹å…§å®¹å¤±æ•—ï¼Œä¸é˜»æ­¢åˆ‡æ› */
    }
    // åŒæ­¥è¨ºç—‡ç³»çµ±çš„ä¸‹æ‹‰é¸å–®ï¼ˆè‹¥æœªç¦ç”¨ï¼‰
    try {
        const presSel = document.getElementById('prescriptionTypeSelect');
        if (presSel) {
            // æ›´æ–°å€¼ï¼›è‹¥ç¦ç”¨å‰‡åªæ”¹å€¼è€Œä¸è§¸ç™¼ onchange
            presSel.value = type;
        }
    } catch (_e) {
        /* å¿½ç•¥åŒæ­¥éŒ¯èª¤ */
    }
    // åŸ·è¡Œåº«å­˜é¡žåž‹åˆ‡æ›
    try {
        changeInventoryType(type);
    } catch (_e) {
        /* å¿½ç•¥åº«å­˜é¡žåž‹åˆ‡æ›éŒ¯èª¤ */
    }
    // è‹¥è™•æ–¹æœå°‹æ¬„æœ‰å…§å®¹ï¼Œæ›´æ–°æœç´¢çµæžœä»¥åæ˜ æ–°åº«å­˜é¤˜é‡
    try {
        const searchEl = document.getElementById('prescriptionSearch');
        const query = searchEl && searchEl.value ? String(searchEl.value).trim() : '';
        if (query && query.length > 0) {
            setTimeout(function () {
                try {
                    searchHerbsForPrescription();
                } catch (_e) {
                    /* å¿½ç•¥æœç´¢éŒ¯èª¤ */
                }
            }, 300);
        }
    } catch (_e) {
        /* å¿½ç•¥æœå°‹éŒ¯èª¤ */
    }
}

// å°‡åº«å­˜é¡žåž‹æ”¹è®Šå‡½å¼æš´éœ²åˆ°å…¨åŸŸï¼Œä»¥ä¾¿ä¸­è—¥åº«é¸å–®ä½¿ç”¨
window.onInventoryTypeChange = onInventoryTypeChange;

// å°‡è™•æ–¹åº«å­˜æ¨¡å¼åˆ‡æ›å‡½å¼å…¬é–‹åˆ°å…¨åŸŸï¼Œä¾› HTML select èª¿ç”¨
window.onPrescriptionTypeChange = onPrescriptionTypeChange;

// å°‡åº«å­˜åˆ‡æ›å‡½å¼æš´éœ²åˆ°å…¨åŸŸï¼Œä¾› HTML äº‹ä»¶èª¿ç”¨
window.changeInventoryType = changeInventoryType;

/**
 * ç¢ºä¿åœ¨æŒ‡å®šçˆ¶å…ƒç´ ä¹‹å¾Œå­˜åœ¨åˆ†é å®¹å™¨ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å»ºç«‹ã€‚
 * åˆ†é å®¹å™¨çµ±ä¸€ä½¿ç”¨ flex æŽ’ç‰ˆèˆ‡ margin-top æå‡é¡¯ç¤ºæ•ˆæžœã€‚
 * @param {string} parentId - å°‡åœ¨å…¶å¾Œæ’å…¥åˆ†é å®¹å™¨çš„å…ƒç´  IDã€‚
 * @param {string} paginationId - åˆ†é å®¹å™¨çš„ IDã€‚
 * @returns {HTMLElement|null} åˆ†é å®¹å™¨å…ƒç´ ã€‚
 */
function ensurePaginationContainer(parentId, paginationId) {
    const parentEl = document.getElementById(parentId);
    if (!parentEl) return null;
    let container = document.getElementById(paginationId);
    // å¦‚æžœåˆ†é å®¹å™¨å°šæœªå‰µå»ºï¼Œå‰‡å…ˆå‰µå»ºå…ƒç´ 
    if (!container) {
        container = document.createElement('div');
        container.id = paginationId;
        // ä½¿ç”¨ flex ç½®ä¸­å’Œå¤–è·è¨­å®š
        container.className = 'mt-4 flex justify-center';
    }

    /**
     * åˆ¤æ–·çˆ¶å…ƒç´ æ˜¯å¦ä½æ–¼è¡¨æ ¼ï¼ˆtable/tbody/thead/tfoot/trï¼‰å…§ã€‚
     * å¦‚æžœæ˜¯ï¼Œç›´æŽ¥å°‡åˆ†é å®¹å™¨æ’å…¥åœ¨ table å…ƒç´ ä¹‹å¾Œï¼Œ
     * é€™æ¨£å¯ä»¥é¿å…åœ¨ table çµæ§‹å…§æ’å…¥ <div> é€ æˆæŽ’ç‰ˆå•é¡Œã€‚
     */
    const parentTag = parentEl.tagName ? parentEl.tagName.toLowerCase() : '';
    // å®šç¾©è¡¨æ ¼ç›¸é—œæ¨™ç±¤
    const tableTags = ['table', 'tbody', 'thead', 'tfoot', 'tr', 'td', 'th'];
    // æ‰¾åˆ°æœ€è¿‘çš„è¡¨æ ¼å…ƒç´ 
    let tableEl = null;
    if (tableTags.includes(parentTag)) {
        // è‹¥ parentEl æœ¬èº«æ˜¯è¡¨æ ¼ç›¸é—œæ¨™ç±¤ï¼Œå˜—è©¦å¾€ä¸Šå°‹æ‰¾æœ€è¿‘çš„ table
        tableEl = parentEl.closest('table');
    }
    if (tableEl) {
        const tableParent = tableEl.parentNode;
        // é è¨­å°‡å®¹å™¨æ’å…¥åœ¨ table ä¹‹å¾Œ
        let insertionParent = tableParent;
        let referenceNode = tableEl.nextSibling;
        // å¦‚æžœè¡¨æ ¼çš„çˆ¶å…ƒç´ æ˜¯ overflow-x-auto å®¹å™¨ï¼Œå‰‡æ‡‰å°‡åˆ†é å®¹å™¨æ”¾åœ¨ overflow å®¹å™¨ä¹‹å¤–
        if (tableParent && tableParent.classList && tableParent.classList.contains('overflow-x-auto')) {
            // å°‡æ’å…¥ç›®æ¨™è¨­ç‚º overflow å®¹å™¨çš„çˆ¶å…ƒç´ 
            const overflowContainer = tableParent;
            insertionParent = overflowContainer.parentNode;
            referenceNode = overflowContainer.nextSibling;
        }
        // å¦‚æžœç•¶å‰å®¹å™¨å°šæœªæ’å…¥åˆ°æ­£ç¢ºçš„çˆ¶å®¹å™¨ä¸­ï¼Œå‰‡åŸ·è¡Œæ’å…¥æˆ–ç§»å‹•
        if (!container.parentNode || container.parentNode !== insertionParent) {
            if (referenceNode) {
                insertionParent.insertBefore(container, referenceNode);
            } else {
                insertionParent.appendChild(container);
            }
        }
    } else {
        // éžè¡¨æ ¼å ´æ™¯ï¼Œæ’å…¥åœ¨ parentEl å¾Œé¢
        const parentContainer = parentEl.parentNode;
        if (!container.parentNode || container.parentNode !== parentContainer) {
            if (parentEl.nextSibling) {
                parentContainer.insertBefore(container, parentEl.nextSibling);
            } else {
                parentContainer.appendChild(container);
            }
        }
    }
    return container;
}

/**
 * åœ¨æŒ‡å®šå®¹å™¨ä¸­æ¸²æŸ“åˆ†é æŽ§åˆ¶æŒ‰éˆ•ã€‚
 * æä¾›ä¸Šä¸€é ã€ä¸‹ä¸€é ä»¥åŠéƒ¨åˆ†é ç¢¼æŒ‰éˆ•ï¼Œé¿å…é æ•¸éŽå¤šæ™‚ç•«é¢æ“æ“ ã€‚
 * @param {number} totalItems ç¸½é …ç›®æ•¸é‡
 * @param {number} itemsPerPage æ¯é é¡¯ç¤ºçš„é …ç›®æ•¸é‡
 * @param {number} currentPage ç•¶å‰é ç¢¼ï¼ˆå¾ž 1 é–‹å§‹ï¼‰
 * @param {Function} onPageChange é ç¢¼è®Šæ›´å›žå‘¼å‡½å¼ï¼ŒæŽ¥å—æ–°é ç¢¼ç‚ºåƒæ•¸
 * @param {HTMLElement} container åˆ†é å®¹å™¨å…ƒç´ 
 */
function renderPagination(totalItems, itemsPerPage, currentPage, onPageChange, container) {
    if (!container) return;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    container.innerHTML = '';
    if (totalPages <= 1) {
        container.classList.add('hidden');
        return;
    }
    container.classList.remove('hidden');
    // å»ºç«‹æŒ‰éˆ•çš„è¼”åŠ©å‡½å¼
    const createBtn = (page, text, disabled = false, active = false) => {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'mx-1 px-3 py-1 rounded border text-sm ' +
            (active
                ? 'bg-blue-500 text-white border-blue-500'
                : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100');
        if (disabled) {
            btn.className += ' cursor-not-allowed opacity-50';
            btn.disabled = true;
        }
        btn.addEventListener('click', () => {
            if (!disabled && page !== currentPage && typeof onPageChange === 'function') {
                onPageChange(page);
            }
        });
        return btn;
    };
    // æœ€å‰ä¸€é æŒ‰éˆ•
    // å§‹çµ‚æä¾›è·³è½‰è‡³ç¬¬ä¸€é çš„æŒ‰éˆ•ï¼Œè‹¥ç›®å‰å·²åœ¨ç¬¬ä¸€é å‰‡ç¦ç”¨
    container.appendChild(createBtn(1, 'æœ€å‰ä¸€é ', currentPage === 1));
    // ä¸Šä¸€é æŒ‰éˆ•
    container.appendChild(createBtn(Math.max(1, currentPage - 1), 'ä¸Šä¸€é ', currentPage === 1));
    // æ±ºå®šè¦é¡¯ç¤ºçš„é ç¢¼ç¯„åœï¼Œæœ€å¤šé¡¯ç¤º 5 å€‹é ç¢¼
    const maxVisible = 5;
    let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let end = Math.min(totalPages, start + maxVisible - 1);
    if (end - start < maxVisible - 1) {
        start = Math.max(1, end - maxVisible + 1);
    }
    for (let i = start; i <= end; i++) {
        container.appendChild(createBtn(i, String(i), false, i === currentPage));
    }
    // ä¸‹ä¸€é æŒ‰éˆ•
    container.appendChild(createBtn(Math.min(totalPages, currentPage + 1), 'ä¸‹ä¸€é ', currentPage === totalPages));
    // æœ€å¾Œä¸€é æŒ‰éˆ•
    // æä¾›å¿«é€Ÿè·³è½‰è‡³æœ€å¾Œä¸€é çš„æŒ‰éˆ•ï¼Œè‹¥ç›®å‰å·²åœ¨æœ€å¾Œä¸€é å‰‡ç¦ç”¨
    container.appendChild(createBtn(totalPages, 'æœ€å¾Œä¸€é ', currentPage === totalPages));
}

/**
 * ä½¿ç”¨æ–¹å‘éµåœ¨ç•¶å‰å¯è¦‹çš„åˆ†é å®¹å™¨ä¸­ç§»å‹•ä¸Šä¸€é æˆ–ä¸‹ä¸€é ã€‚
 *
 * æ­¤å‡½å¼æœƒæœå°‹æ‰€æœ‰ id ä»¥ "Pagination" çµå°¾çš„ div å…ƒç´ ï¼Œ
 * åˆ¤æ–·å…¶æ˜¯å¦å¯è¦‹ï¼ˆæœªè¢«éš±è—ä¸”å¯é»žæ“Šï¼‰ï¼Œä¸¦åœ¨ç¬¬ä¸€å€‹æ‰¾åˆ°çš„å®¹å™¨ä¸­
 * å°‹æ‰¾å°æ‡‰çš„ã€Œä¸Šä¸€é ã€æˆ–ã€Œä¸‹ä¸€é ã€æŒ‰éˆ•ï¼Œä¸¦è§¸ç™¼é»žæ“Šã€‚
 * å¦‚æžœæŒ‰éˆ•ç‚ºç¦ç”¨ç‹€æ…‹æˆ–ä¸å­˜åœ¨ï¼Œå°‡ä¸é€²è¡Œä»»ä½•æ“ä½œã€‚
 * è‹¥æœ‰å¤šå€‹åˆ†é å®¹å™¨åŒæ™‚å¯è¦‹ï¼Œåªæœƒè™•ç†æœ€å…ˆæ‰¾åˆ°çš„ä¸€å€‹ã€‚
 *
 * @param {number} direction - ç§»å‹•æ–¹å‘ï¼Œ-1 è¡¨ç¤ºä¸Šä¸€é ï¼Œ1 è¡¨ç¤ºä¸‹ä¸€é 
 */
function navigatePagination(direction) {
  try {
    // æœå°‹æ‰€æœ‰åˆ†é å®¹å™¨ï¼ˆid ä»¥ Pagination çµå°¾ï¼‰
    const containers = document.querySelectorAll('div[id$="Pagination"]');
    for (const container of containers) {
      // åˆ¤æ–·å®¹å™¨æ˜¯å¦å¯è¦‹ï¼šä¸å­˜åœ¨ hidden é¡žä¸”åœ¨é é¢ä¸Šæœ‰å¯è¦‹å°ºå¯¸
      const isHidden = container.classList && container.classList.contains('hidden');
      const isVisible = !isHidden && container.offsetParent !== null;
      if (!isVisible) {
        continue;
      }
      // å–å¾—æ‰€æœ‰æŒ‰éˆ•
      const buttons = Array.from(container.querySelectorAll('button'));
      // æª¢æŸ¥æ–¹å‘ä¸¦å°‹æ‰¾ç›¸æ‡‰æŒ‰éˆ•
      if (direction < 0) {
        // å°‹æ‰¾ä¸Šä¸€é æŒ‰éˆ•ï¼Œæ”¯æŒä¸­æ–‡èˆ‡è‹±æ–‡æè¿°
        const prevBtn = buttons.find(btn => {
          const text = (btn.textContent || '').trim().toLowerCase();
          return !btn.disabled && (text.includes('ä¸Šä¸€é ') || text.includes('ä¸Šä¸€é¡µ') || text.includes('previous') || text.includes('prev'));
        });
        if (prevBtn && typeof prevBtn.click === 'function') {
          prevBtn.click();
          break;
        }
      } else if (direction > 0) {
        // å°‹æ‰¾ä¸‹ä¸€é æŒ‰éˆ•
        const nextBtn = buttons.find(btn => {
          const text = (btn.textContent || '').trim().toLowerCase();
          return !btn.disabled && (text.includes('ä¸‹ä¸€é ') || text.includes('ä¸‹ä¸€é¡µ') || text.includes('next'));
        });
        if (nextBtn && typeof nextBtn.click === 'function') {
          nextBtn.click();
          break;
        }
      }
    }
  } catch (e) {
    // è‹¥æœå°‹æˆ–é»žæ“Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå¿½ç•¥é¿å…å½±éŸ¿å…¶ä»–æ“ä½œ
    console.error(e);
  }
}

/**
 * è§’è‰²èˆ‡å°æ‡‰å¯å­˜å–çš„ç³»çµ±å€å¡Šå°ç…§è¡¨ã€‚
 * æ¯å€‹è§’è‰²å¯å­˜å–å“ªäº›é é¢ï¼ˆåŠŸèƒ½ï¼‰ï¼Œåœ¨æ­¤é›†ä¸­å®šç¾©ã€‚
 */
const ROLE_PERMISSIONS = {
  // æ–°å¢žå€‹äººçµ±è¨ˆåˆ†æž (personalStatistics) æ¬Šé™ï¼Œè¨ºæ‰€ç®¡ç†è€…èˆ‡é†«å¸«å¯ä½¿ç”¨
  // ç®¡ç†å“¡ä¸éœ€è¦å€‹äººè¨­ç½®èˆ‡å€‹äººçµ±è¨ˆåˆ†æžï¼Œæ•…ç§»é™¤é€™å…©é …
  // å°‡æ¨¡æ¿åº«ç§»è‡³ç©´ä½åº«ä¹‹å¾Œï¼Œä¸¦å°‡ç—…æ­·ç®¡ç†èª¿æ•´è‡³è¨ºç—‡ç³»çµ±ä¹‹ä¸‹ï¼Œä½¿å´é‚Šé¸å–®é †åºç‚ºï¼š
  // æ‚£è€…ç®¡ç† -> è¨ºç—‡ç³»çµ± -> ç—…æ­·ç®¡ç† -> ä¸­è—¥åº« -> ç©´ä½åº« -> æ¨¡æ¿åº« -> é†«ç™‚æŽ’ç­ -> æ”¶è²»ç®¡ç† -> ç”¨æˆ¶ç®¡ç† -> è²¡å‹™å ±è¡¨ -> ç³»çµ±ç®¡ç† -> å¸³è™Ÿå®‰å…¨
  'è¨ºæ‰€ç®¡ç†': ['patientManagement', 'consultationSystem', 'medicalRecordManagement', 'herbLibrary', 'acupointLibrary', 'templateLibrary', 'scheduleManagement', 'billingManagement', 'userManagement', 'financialReports', 'systemManagement', 'accountSecurity'],
  // é†«å¸«ä¸éœ€è¦ç³»çµ±ç®¡ç†æ¬Šé™ï¼Œä¹Ÿå°‡ç—…æ­·ç®¡ç†ç½®æ–¼è¨ºç—‡ç³»çµ±ä¹‹ä¸‹ï¼Œä¸¦å°‡æ¨¡æ¿åº«ç§»è‡³ç©´ä½åº«ä¹‹å¾Œ
  'é†«å¸«': ['patientManagement', 'consultationSystem', 'medicalRecordManagement', 'herbLibrary', 'acupointLibrary', 'templateLibrary', 'scheduleManagement', 'billingManagement', 'personalSettings', 'personalStatistics', 'accountSecurity'],
  // è­·ç†å¸«å¯ä½¿ç”¨ç—…æ­·ç®¡ç†åŠŸèƒ½ï¼Œå› æ­¤å°‡ medicalRecordManagement ç½®æ–¼è¨ºç—‡ç³»çµ±ä¹‹å¾Œï¼ŒåŒæ™‚ä¿ç•™æ¨¡æ¿åº«ç§»è‡³ç©´ä½åº«ä¹‹å¾Œ
  'è­·ç†å¸«': ['patientManagement', 'consultationSystem', 'medicalRecordManagement', 'herbLibrary', 'acupointLibrary', 'templateLibrary', 'scheduleManagement', 'accountSecurity'],
  // ç”¨æˆ¶ç„¡ä¸­è—¥åº«æˆ–ç©´ä½åº«æ¬Šé™ï¼Œç¶­æŒæ¨¡æ¿åº«åœ¨æœ€å¾Œ
  'ç”¨æˆ¶': ['patientManagement', 'consultationSystem', 'templateLibrary', 'accountSecurity']
};

/**
 * åˆ¤æ–·ç•¶å‰ç”¨æˆ¶æ˜¯å¦å…·æœ‰å­˜å–æŒ‡å®šå€å¡Šçš„æ¬Šé™ã€‚
 * @param {string} sectionId
 * @returns {boolean}
 */
function hasAccessToSection(sectionId) {
  // è‹¥å°šæœªå–å¾—ç”¨æˆ¶è³‡æ–™æˆ–æœªè¨­å®šè·ä½ï¼Œå‰‡ç›´æŽ¥æ‹’çµ•å­˜å–
  if (!currentUserData || !currentUserData.position) return false;

  // å–å¾—ç”¨æˆ¶è·ä½ä¸¦ç§»é™¤å‰å¾Œç©ºç™½
  const pos = currentUserData.position.trim ? currentUserData.position.trim() : currentUserData.position;

  // ç‰¹åˆ¥è™•ç†ï¼šç”¨æˆ¶ç®¡ç†åƒ…é™ç®¡ç†å“¡ä½¿ç”¨ã€‚
  // ä½¿ç”¨ window.isAdminUserï¼ˆè‹¥å­˜åœ¨ï¼‰ä¾†åˆ¤æ–·æ˜¯å¦ç‚ºç®¡ç†å“¡ï¼Œ
  // ä»¥æ”¯æ´ä¾‹å¦‚ã€Œç³»çµ±ç®¡ç†ã€æˆ–åŒ…å«ã€Œç®¡ç†ã€çš„å…¶ä»–è·ç¨±ï¼ŒåŒæ™‚ä¿ç•™
  // å°ç‰¹å®šé›»å­éƒµä»¶ (admin@clinic.com) çš„åˆ¤æ–·ã€‚
  if (sectionId === 'userManagement') {
    try {
      if (typeof window.isAdminUser === 'function') {
        // è‹¥æä¾›äº† isAdminUser å‡½å¼ï¼Œç›´æŽ¥ä»¥å…¶çµæžœç‚ºæº–ã€‚
        return window.isAdminUser();
      }
    } catch (_e) {
      // å¿½ç•¥å‡½å¼åŸ·è¡Œä¸­çš„éŒ¯èª¤
    }
    // å¦‚æžœæ²’æœ‰ isAdminUser æˆ–åŸ·è¡Œå¤±æ•—ï¼Œå‰‡æ ¹æ“šè·ç¨±åŠé›»å­éƒµä»¶é€²è¡Œåˆ¤æ–·ã€‚
    const email = (currentUserData && currentUserData.email
      ? String(currentUserData.email).toLowerCase().trim()
      : '');
    return (
      pos === 'è¨ºæ‰€ç®¡ç†' ||
      (pos && pos.includes('ç®¡ç†')) ||
      email === 'admin@clinic.com'
    );
  }

  // æ”¶è²»é …ç›®ç®¡ç†åƒ…é™è¨ºæ‰€ç®¡ç†è€…æˆ–é†«å¸«ä½¿ç”¨
  if (sectionId === 'billingManagement') {
    return pos === 'è¨ºæ‰€ç®¡ç†' || pos === 'é†«å¸«';
  }

  // æ ¹æ“šè§’è‰²æ¬Šé™å®šç¾©åˆ¤æ–·ï¼ˆä½¿ç”¨ä¿®å‰ªå¾Œçš„è·ä½ï¼‰
  const allowed = ROLE_PERMISSIONS[pos] || [];
  return allowed.includes(sectionId);
}

// åˆå§‹åŒ–å…¨åŸŸè®Šæ•¸
let patients = [];
let consultations = [];
let appointments = [];
// å¿«å–ç—…äººåˆ—è¡¨ï¼Œé¿å…é‡è¤‡å¾ž Firestore è®€å–
let patientCache = null;

// å…¨åŸŸä½¿ç”¨æ¬¡æ•¸çµ±è¨ˆï¼Œç”¨æ–¼ä¸­è—¥åº«ä¾ä½¿ç”¨é‡æŽ’åº
let globalUsageCounts = {};
// å€‹äººçµ±è¨ˆåˆ†æžçš„åœ–è¡¨å¯¦ä¾‹ï¼Œç”¨æ–¼æ›´æ–°æ™‚å…ˆéŠ·æ¯€èˆŠåœ–è¡¨
let personalHerbChartInstance = null;
let personalFormulaChartInstance = null;
let personalAcupointChartInstance = null;

/**
 * è¨ˆç®—å…¨é™¢ä¸­è—¥èˆ‡æ–¹åŠ‘çš„ä½¿ç”¨æ¬¡æ•¸ã€‚
 * éæ­· consultations ä¸­çš„ prescriptionï¼Œæ¯è¡Œå–å‡ºè—¥åä¸¦ç´¯è¨ˆã€‚
 * çµæžœå­˜å…¥ globalUsageCountsï¼Œä¸¦æ›´æ–° herbLibrary çš„ usageCount å±¬æ€§ã€‚
 */
async function computeGlobalUsageCounts() {
    // ç¢ºä¿ consultations è³‡æ–™å¯ç”¨ï¼Œå¦‚ç„¡è³‡æ–™å‰‡å˜—è©¦è¼‰å…¥
    try {
        // ç™»å‡ºæ™‚åœæ­¢é–’ç½®ç›£æŽ§ï¼Œä»¥å…ç™»å‡ºå¾Œä»ç„¶è§¸ç™¼è‡ªå‹•ç™»å‡ºå›žèª¿
        try {
            if (typeof stopInactivityMonitoring === 'function') {
                stopInactivityMonitoring();
            }
        } catch (_e) {
            // å¿½ç•¥åœæ­¢ç›£æŽ§æ™‚çš„éŒ¯èª¤
        }
        if (!Array.isArray(consultations) || consultations.length === 0) {
            if (typeof loadConsultationsForFinancial === 'function') {
                await loadConsultationsForFinancial();
            }
        }
    } catch (_e) {
        // å¿½ç•¥è¼‰å…¥éŒ¯èª¤
    }
    globalUsageCounts = {};
    if (Array.isArray(consultations)) {
        consultations.forEach(cons => {
            try {
                const pres = cons && cons.prescription ? cons.prescription : '';
                const lines = pres.split('\n');
                lines.forEach(rawLine => {
                    const line = rawLine.trim();
                    if (!line) return;
                    const match = line.match(/^([^0-9\s\(\)\.]+)/);
                    const name = match ? match[1].trim() : line.split(/[\d\s]/)[0];
                    if (!name) return;
                    globalUsageCounts[name] = (globalUsageCounts[name] || 0) + 1;
                });
            } catch (_e) {
                // å¿½ç•¥å–®ç­†è§£æžéŒ¯èª¤
            }
        });
    }
    if (Array.isArray(herbLibrary)) {
        herbLibrary.forEach(item => {
            try {
                item.usageCount = globalUsageCounts[item.name] || 0;
            } catch (_e) {
                item.usageCount = 0;
            }
        });
    }
}

/**
 * è¨ˆç®—æŒ‡å®šé†«å¸«çš„å€‹äººç”¨è—¥èˆ‡ç©´ä½çµ±è¨ˆã€‚
 * æœƒæ¯”å° consultation.doctor æ˜¯å¦ç­‰æ–¼ doctor (ä½¿ç”¨è€…å¸³è™Ÿ)ã€‚
 * å›žå‚³ç‰©ä»¶åŒ…å« herbCountsã€formulaCounts èˆ‡ acupointCountsã€‚
 */
function computePersonalStatistics(doctor) {
    const herbCounts = {};
    const formulaCounts = {};
    const acupointCounts = {};
    if (!Array.isArray(consultations) || consultations.length === 0) {
        return { herbCounts, formulaCounts, acupointCounts };
    }
    consultations.forEach(cons => {
        try {
            if (doctor && cons.doctor && String(cons.doctor) !== String(doctor)) {
                return;
            }
            const pres = cons && cons.prescription ? cons.prescription : '';
            const lines = pres.split('\n');
            lines.forEach(rawLine => {
                const line = rawLine.trim();
                if (!line) return;
                const match = line.match(/^([^0-9\s\(\)\.]+)/);
                const name = match ? match[1].trim() : line.split(/[\d\s]/)[0];
                if (!name) return;
                let isFormula = false;
                if (Array.isArray(herbLibrary)) {
                    const found = herbLibrary.find(item => item.name === name);
                    if (found && found.type === 'formula') {
                        isFormula = true;
                    }
                }
                if (isFormula) {
                    formulaCounts[name] = (formulaCounts[name] || 0) + 1;
                } else {
                    herbCounts[name] = (herbCounts[name] || 0) + 1;
                }
            });
            // è§£æžé‡ç¸å‚™è¨»ä¸­çš„ç©´ä½åç¨±
            const acNotes = cons && cons.acupunctureNotes ? cons.acupunctureNotes : '';
            const regex = /data-acupoint-name="(.*?)"/g;
            let matchAc;
            while ((matchAc = regex.exec(acNotes)) !== null) {
                const acName = matchAc[1];
                if (acName) {
                    acupointCounts[acName] = (acupointCounts[acName] || 0) + 1;
                }
            }
        } catch (_e) {
            // å¿½ç•¥æ­¤ç­†è¨ºç—‡çš„è§£æžéŒ¯èª¤
        }
    });
    return { herbCounts, formulaCounts, acupointCounts };
}

/**
 * è¼‰å…¥æŒ‡å®šç—…äººéŽå¾€çš„ä¸»è¨´åŠç¾ç—…å²ç´€éŒ„ï¼Œä¸¦ä¾æ—¥æœŸç”±æ–°åˆ°èˆŠå¡«å…¥éŽå¾€è¨˜éŒ„æ¬„ä½ã€‚
 * æ­¤å‡½å¼æœƒå˜—è©¦è¼‰å…¥å…¨éƒ¨è¨ºç—‡è³‡æ–™ï¼ˆè‹¥å°šæœªè¼‰å…¥ï¼‰ï¼Œå†ä¾ç—…äºº ID åŠæŽ’é™¤çš„è¨ºç—‡ ID é€²è¡Œç¯©é¸ã€‚
 * æ¯ä¸€è¡Œæ ¼å¼ç‚ºï¼šYYYY-MM-DD ä¸»è¨´ ç¾ç—…å²ï¼Œå…¶ä¸­ä¸»è¨´åœ¨å‰ï¼Œç¾ç—…å²åœ¨å¾Œï¼›è‹¥ç¼ºå…¶ä¸­ä¸€é …å‰‡åªé¡¯ç¤ºç¾æœ‰è³‡è¨Šã€‚
 *
 * @param {string|number} patientId - ç›®æ¨™ç—…äººçš„ ID
 * @param {string|number|null} excludeConsultationId - è‹¥æä¾›ï¼Œå°‡å¾žç´€éŒ„ä¸­æŽ’é™¤æ­¤è¨ºç—‡ ID
 */
async function loadPastRecords(patientId, excludeConsultationId = null) {
    try {
        // è‹¥ consultations å°šæœªè¼‰å…¥ï¼Œå˜—è©¦å¾ž Firebase å–å¾—å…¨éƒ¨è¨ºç—‡è¨˜éŒ„
        if (!Array.isArray(consultations) || consultations.length === 0) {
            try {
                if (window.firebaseDataManager && typeof window.firebaseDataManager.getConsultations === 'function') {
                    const consResult = await window.firebaseDataManager.getConsultations();
                    if (consResult && consResult.success && Array.isArray(consResult.data)) {
                        consultations = consResult.data;
                    }
                }
            } catch (err) {
                console.error('è¼‰å…¥è¨ºç—‡è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
            }
        }
        if (!Array.isArray(consultations)) {
            return;
        }
        // ç¯©é¸å‡ºåŒä¸€ç—…äººçš„è¨ºç—‡ç´€éŒ„ï¼ŒæŽ’é™¤æ­£åœ¨ç·¨è¼¯çš„ç´€éŒ„ï¼ˆè‹¥æœ‰æä¾›ï¼‰
        const records = consultations.filter(c => {
            if (!c || (typeof c.patientId === 'undefined')) return false;
            if (String(c.patientId) !== String(patientId)) return false;
            if (excludeConsultationId && String(c.id) === String(excludeConsultationId)) return false;
            return true;
        }).sort((a, b) => {
            // ä¾æ—¥æœŸç”±æ–°åˆ°èˆŠæŽ’åº
            const getTime = (c) => {
                let d = null;
                if (c.date) {
                    if (typeof c.date === 'object' && c.date.seconds) {
                        d = new Date(c.date.seconds * 1000);
                    } else {
                        d = new Date(c.date);
                    }
                } else if (c.createdAt) {
                    if (typeof c.createdAt === 'object' && c.createdAt.seconds) {
                        d = new Date(c.createdAt.seconds * 1000);
                    } else {
                        d = new Date(c.createdAt);
                    }
                }
                return d ? d.getTime() : 0;
            };
            return getTime(b) - getTime(a);
        });
        // çµ„åˆæ¯ä¸€è¡Œç´€éŒ„ï¼šæ—¥æœŸ + ä¸»è¨´ + ç¾ç—…å² + èˆŒè±¡ + è„ˆè±¡
        const lines = records.map(c => {
            let dateObj = null;
            if (c.date) {
                if (typeof c.date === 'object' && c.date.seconds) {
                    dateObj = new Date(c.date.seconds * 1000);
                } else {
                    dateObj = new Date(c.date);
                }
            } else if (c.createdAt) {
                if (typeof c.createdAt === 'object' && c.createdAt.seconds) {
                    dateObj = new Date(c.createdAt.seconds * 1000);
                } else {
                    dateObj = new Date(c.createdAt);
                }
            }
            const dateStr = dateObj ? `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}` : '';
            const symptoms = c.symptoms ? String(c.symptoms).replace(/\n/g, ' ').trim() : '';
            const history = c.currentHistory ? String(c.currentHistory).replace(/\n/g, ' ').trim() : '';
            const tongue = c.tongue ? String(c.tongue).replace(/\n/g, ' ').trim() : '';
            const pulse = c.pulse ? String(c.pulse).replace(/\n/g, ' ').trim() : '';
            const parts = [];
            // ä¸»è¨´èˆ‡ç¾ç—…å²ç›´æŽ¥é¡¯ç¤º
            if (symptoms) parts.push(symptoms);
            if (history) parts.push(history);
            // å°‡èˆŒè±¡èˆ‡è„ˆè±¡ä»¥é€—è™Ÿä¸²æŽ¥ä¸¦ç”¨æ‹¬è™ŸåŒ…è¦†ï¼Œä¾‹å¦‚ã€Œ(èˆŒç´…ï¼Œè„ˆå¼±)ã€
            const special = [];
            if (tongue) special.push(tongue);
            if (pulse) special.push(pulse);
            if (special.length) parts.push(`(${special.join('ï¼Œ')})`);
            const content = parts.join(' ').trim();
            return `${dateStr} ${content}`.trim();
        });
        // å°‡çµæžœå¡«å…¥è¡¨å–®æ¬„ä½
        const historyField = document.getElementById('formCurrentHistory');
        if (historyField) {
            // ä½¿ç”¨è¼ƒçŸ­çš„æ©«ç·šä½œç‚ºåˆ†éš”ç¬¦è™Ÿï¼Œä¸¦ç›¡é‡æ¸›å°‘ç¸±å‘é–“è·
            // æŽ¡ç”¨å–®è¡Œåˆ†éš”ç·šï¼Œä¸å†æ–¼å…¶ä¸Šä¸‹é¡å¤–åŠ ç©ºè¡Œï¼Œé¿å…åˆ†å¾—å¤ªé–‹
            const separator = '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
            historyField.value = lines.join(separator);
        }
    } catch (e) {
        console.error('è¼‰å…¥éŽå¾€è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
    }
}

/**
 * è¼‰å…¥å€‹äººçµ±è¨ˆåˆ†æžé é¢ä¸¦æ¸²æŸ“çµ±è¨ˆçµæžœã€‚
 * è‹¥ consultations å°šæœªè¼‰å…¥ï¼Œæœƒå…ˆè¼‰å…¥å…¨éƒ¨è¨ºç—‡è¨˜éŒ„ã€‚
 */
async function loadPersonalStatistics() {
    if (!Array.isArray(consultations) || consultations.length === 0) {
        if (typeof loadConsultationsForFinancial === 'function') {
            try {
                await loadConsultationsForFinancial();
            } catch (_e) {
                console.error('è¼‰å…¥è¨ºç—‡è³‡æ–™å¤±æ•—ï¼š', _e);
            }
        }
    }
    const doctor = currentUser;
    const stats = computePersonalStatistics(doctor);
    renderPersonalStatistics(stats);
}

/**
 * æ ¹æ“šè¨ˆç®—çš„çµ±è¨ˆè³‡æ–™æ›´æ–°åˆ—è¡¨èˆ‡åœ–è¡¨ã€‚
 * åªé¡¯ç¤ºæ¯å€‹é¡žåˆ¥å‰ 10 åã€‚
 */
function renderPersonalStatistics(stats) {
    if (!stats) return;
    const { herbCounts, formulaCounts, acupointCounts } = stats;
    // æ¸²æŸ“åˆ—è¡¨
    function renderList(counts, listId) {
        const listEl = document.getElementById(listId);
        if (!listEl) return [];
        listEl.innerHTML = '';
        const entries = Object.entries(counts || {}).sort((a, b) => b[1] - a[1]).slice(0, 10);
        entries.forEach(([name, count]) => {
            const li = document.createElement('li');
            li.className = 'py-1 flex justify-between';
            li.innerHTML = `<span>${window.escapeHtml(name)}</span><span class="font-semibold">${count}</span>`;
            listEl.appendChild(li);
        });
        return entries;
    }
    // æ¸²æŸ“åœ–è¡¨
    function renderChart(entries, canvasId, oldInstance) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        if (oldInstance && typeof oldInstance.destroy === 'function') {
            try {
                oldInstance.destroy();
            } catch (_e) {}
        }
        const labels = entries.map(e => e[0]);
        const dataVals = entries.map(e => e[1]);
        const ctx = canvas.getContext('2d');
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ä½¿ç”¨æ¬¡æ•¸',
                        data: dataVals,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: true, text: 'åç¨±' } },
                    y: { title: { display: true, text: 'ä½¿ç”¨æ¬¡æ•¸' }, beginAtZero: true },
                },
            },
        });
    }
    const herbEntries = renderList(herbCounts, 'personalHerbList');
    personalHerbChartInstance = renderChart(herbEntries, 'personalHerbChart', personalHerbChartInstance);
    const formulaEntries = renderList(formulaCounts, 'personalFormulaList');
    personalFormulaChartInstance = renderChart(formulaEntries, 'personalFormulaChart', personalFormulaChartInstance);
    const acEntries = renderList(acupointCounts, 'personalAcupointList');
    personalAcupointChartInstance = renderChart(acEntries, 'personalAcupointChart', personalAcupointChartInstance);
}

/**
 * è¼‰å…¥å¸³è™Ÿå®‰å…¨è¨­å®šé ã€‚ä¸»è¦ä½œç”¨æ˜¯é‡ç½®è¼¸å…¥æ¬„ä½ï¼Œé¿å…æ®˜ç•™å‰æ¬¡è¼¸å…¥çš„å¯†ç¢¼ã€‚
 * ç•¶ä½¿ç”¨è€…åˆ‡æ›è‡³å¸³è™Ÿå®‰å…¨è¨­å®šé æ™‚å‘¼å«æ­¤å‡½å¼ã€‚
 */
function loadAccountSecurity() {
    try {
        const currentInput = document.getElementById('changeCurrentPassword');
        const newInput = document.getElementById('changeNewPassword');
        const confirmInput = document.getElementById('changeConfirmPassword');
        const deleteInput = document.getElementById('deleteAccountPassword');
        if (currentInput) currentInput.value = '';
        if (newInput) newInput.value = '';
        if (confirmInput) confirmInput.value = '';
        if (deleteInput) deleteInput.value = '';
    } catch (_e) {
        // ç„¡éœ€è™•ç†éŒ¯èª¤ï¼Œæ¸…ç©ºå¤±æ•—å¯å¿½ç•¥
    }
}

/**
 * è®Šæ›´ç›®å‰ä½¿ç”¨è€…çš„å¯†ç¢¼ã€‚ä½¿ç”¨è€…å¿…é ˆè¼¸å…¥ç¾æœ‰å¯†ç¢¼é€²è¡Œé‡æ–°é©—è­‰ï¼Œä¸¦æŒ‡å®šæ–°çš„å¯†ç¢¼ã€‚
 * é©—è­‰æˆåŠŸå¾Œä½¿ç”¨ updatePassword æ›´æ–°å¯†ç¢¼ï¼Œä¸¦é¡¯ç¤ºæ“ä½œçµæžœã€‚
 */
async function changeCurrentUserPassword() {
    const currentPassEl = document.getElementById('changeCurrentPassword');
    const newPassEl = document.getElementById('changeNewPassword');
    const confirmEl = document.getElementById('changeConfirmPassword');
    if (!currentPassEl || !newPassEl || !confirmEl) {
        showToast('æ‰¾ä¸åˆ°è¼¸å…¥æ¬„ä½ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢', 'error');
        return;
    }
    const currentPassword = (currentPassEl.value || '').trim();
    const newPassword = (newPassEl.value || '').trim();
    const confirmPassword = (confirmEl.value || '').trim();
    const lang = localStorage.getItem('lang') || 'zh';
    if (!currentPassword || !newPassword || !confirmPassword) {
        const msg = lang === 'en' ? 'Please fill in all fields' : 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
        showToast(msg, 'error');
        return;
    }
    if (newPassword !== confirmPassword) {
        const msg = lang === 'en' ? 'New password and confirmation do not match' : 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´';
        showToast(msg, 'error');
        return;
    }
    if (newPassword.length < 6) {
        const msg = lang === 'en' ? 'Password must be at least 6 characters' : 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘ 6 å€‹å­—å…ƒ';
        showToast(msg, 'error');
        return;
    }
    // ç•¶æ‰€æœ‰è¼¸å…¥é©—è­‰é€šéŽå¾Œé¡¯ç¤ºè®€å–åœˆï¼Œé¿å…ä¸€é–‹å§‹å°±è¦†è“‹æŽ‰æŒ‰éˆ•å…§å®¹
    // ä½¿ç”¨å›ºå®šçš„ id å–å¾—æŒ‰éˆ•ï¼Œé¿å…å›  onclick å±¬æ€§è®ŠåŒ–å°Žè‡´æŸ¥æ‰¾å¤±æ•—
    const updateButton = document.getElementById('updatePasswordButton');
    // ä½¿ç”¨ç¿»è­¯å‡½å¼å‹•æ…‹è¨­å®šè¼‰å…¥æ–‡å­—ï¼Œæ ¹æ“šç•¶å‰èªžè¨€é¡¯ç¤ºç›¸æ‡‰çš„æ–‡æ¡ˆ
    setButtonLoading(updateButton, window.t ? window.t('æ›´æ–°ä¸­...') : (lang === 'en' ? 'Updating...' : 'æ›´æ–°ä¸­...'));
    try {
        const auth = window.firebase.auth;
        const user = auth.currentUser;
        if (!user || !user.email) {
            const msg = lang === 'en' ? 'No authenticated user found' : 'æœªæ‰¾åˆ°å·²ç™»å…¥ç”¨æˆ¶';
            showToast(msg, 'error');
            return;
        }
        // ä½¿ç”¨é›»å­éƒµä»¶èˆ‡ç•¶å‰å¯†ç¢¼é€²è¡Œé‡æ–°é©—è­‰
        // åœ¨éƒ¨åˆ†ç‰ˆæœ¬çš„ Firebase JS SDK ä¸­ï¼ŒreauthenticateWithCredential å’Œ updatePassword
        // éœ€è¦ä»¥ auth.currentUser ä½œç‚ºç¬¬ä¸€å€‹åƒæ•¸å‚³å…¥ã€‚å› æ­¤é€™è£¡é¡¯å¼ä½¿ç”¨ auth.currentUser
        // è€Œéžæå‰å­˜å–çš„ user è®Šæ•¸ï¼Œé¿å…å› é—œè¯éŒ¯èª¤å°Žè‡´ auth/invalid-credential
        const credential = window.firebase.EmailAuthProvider.credential(user.email, currentPassword);
        // é‡æ–°é©—è­‰ç•¶å‰ä½¿ç”¨è€…ã€‚è‹¥å¯†ç¢¼éŒ¯èª¤æˆ–æ†‘è­‰ç„¡æ•ˆï¼Œæœƒæ‹‹å‡ºéŒ¯èª¤ã€‚
        await window.firebase.reauthenticateWithCredential(auth.currentUser, credential);
        // æ›´æ–°å¯†ç¢¼ã€‚ä½¿ç”¨ auth.currentUser åšç‚ºç›®æ¨™ä½¿ç”¨è€…ä»¥ç¬¦åˆæ¨¡çµ„åŒ– API
        await window.firebase.updatePassword(auth.currentUser, newPassword);
        const successMsg = lang === 'en' ? 'Password updated successfully' : 'å¯†ç¢¼æ›´æ–°æˆåŠŸ';
        showToast(successMsg, 'success');
        // æ¸…ç©ºè¼¸å…¥
        currentPassEl.value = '';
        newPassEl.value = '';
        confirmEl.value = '';
    } catch (error) {
        console.error('æ›´æ–°å¯†ç¢¼éŒ¯èª¤:', error);
        let errMsg = '';
        if (error && error.code) {
            // ä¾æ“šå¸¸è¦‹éŒ¯èª¤ä»£ç¢¼æä¾›æ›´å‹å¥½çš„æç¤º
            switch (error.code) {
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    // å¦‚æžœéŒ¯èª¤ç‚ºç„¡æ•ˆæ†‘è­‰æˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œçš†è¦–ç‚ºç•¶å‰å¯†ç¢¼è¼¸å…¥éŒ¯èª¤
                    errMsg = lang === 'en' ? 'Current password is incorrect' : 'ç•¶å‰å¯†ç¢¼ä¸æ­£ç¢º';
                    break;
                case 'auth/weak-password':
                    errMsg = lang === 'en' ? 'New password is too weak' : 'æ–°å¯†ç¢¼éŽæ–¼ç°¡å–®';
                    break;
                default:
                    errMsg = error.message || (lang === 'en' ? 'Failed to update password' : 'æ›´æ–°å¯†ç¢¼å¤±æ•—');
            }
        } else {
            errMsg = lang === 'en' ? 'Failed to update password' : 'æ›´æ–°å¯†ç¢¼å¤±æ•—';
        }
        showToast(errMsg, 'error');
    } finally {
        // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—çš†æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        clearButtonLoading(updateButton);
    }
}

/**
 * åˆªé™¤ç›®å‰ä½¿ç”¨è€…çš„ Firebase Authentication å¸³è™Ÿã€‚ä½¿ç”¨è€…éœ€è¼¸å…¥å¯†ç¢¼ä»¥é‡æ–°é©—è­‰ã€‚
 * è‹¥åˆªé™¤æˆåŠŸï¼Œå°‡è‡ªå‹•ç™»å‡ºä¸¦è¿”å›žç™»å…¥é é¢ã€‚
 */
async function deleteCurrentUserAccount() {
    const pwdEl = document.getElementById('deleteAccountPassword');
    const lang = localStorage.getItem('lang') || 'zh';
    if (!pwdEl) {
        showToast(lang === 'en' ? 'Cannot find password field' : 'æ‰¾ä¸åˆ°å¯†ç¢¼è¼¸å…¥æ¬„ä½', 'error');
        return;
    }
    const password = (pwdEl.value || '').trim();
    if (!password) {
        showToast(lang === 'en' ? 'Please enter your password' : 'è«‹è¼¸å…¥å¯†ç¢¼', 'error');
        return;
    }
    // åŸ·è¡Œåˆªé™¤å‰çš„ç•°æ­¥æµç¨‹ã€‚æˆ‘å€‘åªåœ¨ä½¿ç”¨è€…ç¢ºèªåˆªé™¤å¾Œé¡¯ç¤ºè®€å–åœˆï¼Œé¿å…ç„¡æ„ç¾©åœ°é®æ“‹æŒ‰éˆ•ã€‚
    try {
        const user = window.firebase.auth.currentUser;
        if (!user || !user.email) {
            showToast(lang === 'en' ? 'No authenticated user found' : 'æœªæ‰¾åˆ°å·²ç™»å…¥ç”¨æˆ¶', 'error');
            return;
        }
        // ç¢ºèªåˆªé™¤
        const confirmMsg = lang === 'en'
            ? 'Are you sure you want to delete your account?\nThis action cannot be undone.'
            : 'ç¢ºå®šè¦åˆªé™¤æ‚¨çš„å¸³è™Ÿå—Žï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŽŸï¼';
        const confirmedDelAccount = await showConfirmation(confirmMsg, 'warning');
        if (!confirmedDelAccount) {
            return;
        }
        // æ‰¾åˆ°åˆªé™¤æŒ‰éˆ•ä¸¦é¡¯ç¤ºè®€å–åœˆ
        const deleteButton = document.getElementById('deleteAccountButton');
        // ä½¿ç”¨ç¿»è­¯å‡½å¼å‹•æ…‹è¨­å®šè¼‰å…¥æ–‡å­—ï¼Œæ ¹æ“šç•¶å‰èªžè¨€é¡¯ç¤ºç›¸æ‡‰çš„æ–‡æ¡ˆ
        setButtonLoading(deleteButton, window.t ? window.t('åˆªé™¤ä¸­...') : (lang === 'en' ? 'Deleting...' : 'åˆªé™¤ä¸­...'));
        try {
            // é‡æ–°é©—è­‰
            const credential = window.firebase.EmailAuthProvider.credential(user.email, password);
            // ç”±æ–¼éƒ¨åˆ†ç‰ˆæœ¬çš„ SDK éœ€è¦ä»¥ auth.currentUser ä½œç‚ºé‡æ–°é©—è­‰å‡½å¼çš„ç¬¬ä¸€å€‹åƒæ•¸ï¼Œ
            // å› æ­¤ä½¿ç”¨ window.firebase.auth.currentUser é€²è¡Œé‡æ–°é©—è­‰ï¼Œé¿å…å‡ºç¾ invalid-credentialã€‚
            await window.firebase.reauthenticateWithCredential(window.firebase.auth.currentUser, credential);

            // å…ˆåˆªé™¤è¨ºæ‰€ç«¯ç”¨æˆ¶è¨˜éŒ„ï¼ˆFirestore æ–‡ä»¶ï¼‰ã€‚è‹¥å…ˆåˆªé™¤ Auth å¸³è™Ÿï¼Œå¯èƒ½å°Žè‡´ä½¿ç”¨è€…å¤±åŽ»å° Firestore çš„å­˜å–æ¬Šé™è€Œç„¡æ³•åˆªé™¤æ–‡ä»¶ã€‚
            try {
                const userRecordId = currentUserData && currentUserData.id;
                if (userRecordId) {
                    await window.firebaseDataManager.deleteUser(userRecordId);
                    // æ¸…é™¤æœ¬åœ°å¿«å–ï¼Œé¿å…åˆªé™¤çš„ç”¨æˆ¶å†æ¬¡å‡ºç¾
                    if (Array.isArray(userCache)) {
                        userCache = userCache.filter(u => u.id !== userRecordId);
                    }
                }
            } catch (delErr) {
                console.error('åˆªé™¤è¨ºæ‰€ç”¨æˆ¶ç´€éŒ„å¤±æ•—:', delErr);
            }

            // å†åˆªé™¤ Firebase Authentication å¸³è™Ÿã€‚ä½¿ç”¨ auth.currentUser ä»¥ç¬¦åˆæ¨¡çµ„åŒ– APIã€‚
            await window.firebase.deleteAuthUser(window.firebase.auth.currentUser);

            showToast(lang === 'en' ? 'Account deleted' : 'å¸³è™Ÿå·²åˆªé™¤', 'success');
            // ç™»å‡ºä¸¦è¿”å›žç™»å…¥ç•«é¢
            await logout();
        } catch (error) {
            console.error('åˆªé™¤å¸³è™ŸéŒ¯èª¤:', error);
            let errMsg;
            if (error && error.code) {
                switch (error.code) {
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        // ç„¡æ•ˆæ†‘è­‰æˆ–å¯†ç¢¼éŒ¯èª¤çš†è¦–ç‚ºå¯†ç¢¼è¼¸å…¥éŒ¯èª¤
                        errMsg = lang === 'en' ? 'Password is incorrect' : 'å¯†ç¢¼éŒ¯èª¤';
                        break;
                    default:
                        errMsg = error.message || (lang === 'en' ? 'Failed to delete account' : 'åˆªé™¤å¸³è™Ÿå¤±æ•—');
                }
            } else {
                errMsg = lang === 'en' ? 'Failed to delete account' : 'åˆªé™¤å¸³è™Ÿå¤±æ•—';
            }
            showToast(errMsg, 'error');
        } finally {
            // ä¸è«–çµæžœå¦‚ä½•ï¼Œéƒ½è¦æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            clearButtonLoading(deleteButton);
        }
    } catch (error) {
        // å¤–å±¤æ•ç²éŒ¯èª¤ï¼Œä¸»è¦ç”¨æ–¼ user/email ä¸å­˜åœ¨çš„æ—©æœŸè¿”å›ž
        console.error('åˆªé™¤å¸³è™ŸéŒ¯èª¤:', error);
        let errMsg = lang === 'en' ? 'Failed to delete account' : 'åˆªé™¤å¸³è™Ÿå¤±æ•—';
        if (error && error.message) {
            errMsg = error.message;
        }
        showToast(errMsg, 'error');
    }
}

// ç—…äººå¥—ç¥¨èˆ‡è¨ºç™‚è¨˜éŒ„çš„æœ¬åœ°å¿«å–ã€‚
// ä»¥ patientId ç‚ºç´¢å¼•ï¼Œå„²å­˜å…ˆå‰æŸ¥è©¢éŽçš„çµæžœï¼Œç”¨æ–¼æ¸›å°‘é‡è¤‡è®€å–ã€‚
// èª¿ç”¨æŸ¥è©¢å‡½å¼æ™‚è‹¥æœªæŒ‡å®šå¼·åˆ¶åˆ·æ–°ä¸”æœ‰å¿«å–ï¼Œå³ç›´æŽ¥å›žå‚³å¿«å–è³‡æ–™ã€‚
// åœ¨æ–°å¢žã€æ›´æ–°æˆ–æ¶ˆè€—å¥—ç¥¨ï¼è¨ºç™‚è¨˜éŒ„å¾Œï¼Œæœƒä¾æ“šæƒ…æ³æ›´æ–°æˆ–æ¸…é™¤å°æ‡‰å¿«å–ã€‚
let patientPackagesCache = {};
let patientConsultationsCache = {};

// ç”¨æ–¼æ¸¸æ¨™åˆ†é çš„ç—…äººåˆ—è¡¨å¿«å–ã€‚
// patientPagesCache[pageNumber] å„²å­˜æ¯é å·²è¼‰å…¥çš„ç—…äººè³‡æ–™ï¼›
// patientPageCursors[pageNumber] å„²å­˜è©²é æœ€å¾Œä¸€ç­†æ–‡ä»¶çš„å¿«ç…§ï¼Œç”¨æ–¼ä¸‹ä¸€é æŸ¥è©¢ã€‚
let patientPagesCache = {};
let patientPageCursors = {};

// å¿«å–ç—…äººç¸½æ•¸ï¼Œç”¨æ–¼åˆ†é è¨ˆç®—ã€‚è®€å–ä¸€æ¬¡å¾Œæœƒå¿«å–ï¼Œé™¤éžå¼·åˆ¶åˆ·æ–°ã€‚
let patientsCountCache = null;

// æ¨™è¨˜åˆå§‹åŒ–ç‹€æ…‹ï¼Œé¿å…é‡è¤‡åˆå§‹åŒ–ä¸­è—¥åº«ã€ç©´ä½åº«ã€æ”¶è²»é …ç›®èˆ‡æ¨¡æ¿åº«ã€‚
let herbLibraryLoaded = false;
// æ–°å¢žï¼šç©´ä½åº«æ˜¯å¦å·²è¼‰å…¥
let acupointLibraryLoaded = false;
let billingItemsLoaded = false;
let templateLibraryLoaded = false;

// å¿«å–è¨ºç—‡è¨˜éŒ„å’Œç”¨æˆ¶åˆ—è¡¨ï¼Œé¿å…é‡è¤‡å¾ž Firestore è®€å–
let consultationCache = null;
let userCache = null;

// è¿½è¹¤æœ¬æ¬¡è¨ºç—‡æ“ä½œæœŸé–“å°å¥—ç¥¨ä½¿ç”¨é€ æˆçš„æš«æ™‚è®Šæ›´ã€‚
// ç•¶ä½¿ç”¨è€…åœ¨é–‹å•Ÿè¨ºç—‡æˆ–ç·¨è¼¯ç—…æ­·æ™‚ä½¿ç”¨æˆ–å–æ¶ˆä½¿ç”¨å¥—ç¥¨ï¼Œ
// å°‡å°æ‚£è€…å¥—ç¥¨å‰©é¤˜æ¬¡æ•¸ç”¢ç”Ÿå½±éŸ¿ã€‚è‹¥ä½¿ç”¨è€…æœ€çµ‚æœªä¿å­˜ç—…æ­·æˆ–å–æ¶ˆè¨ºç—‡ï¼Œ
// æ‡‰ç•¶å°‡é€™äº›è®Šæ›´å›žå¾©ï¼Œä»¥é¿å…å¥—ç¥¨æ¬¡æ•¸ä¸æ­£ç¢ºã€‚
// æ¯å€‹é …ç›®åŒ…å« patientIdã€packageRecordId ä»¥åŠ deltaï¼Œ
// delta ç‚ºè² æ•¸è¡¨ç¤ºæ¶ˆè€—ä¸€æ¬¡ï¼Œç‚ºæ­£æ•¸è¡¨ç¤ºé€€å›žä¸€æ¬¡ã€‚
let pendingPackageChanges = [];

// è¿½è¹¤æœ¬æ¬¡è¨ºç—‡æœŸé–“æ“¬è³¼è²·çš„å¥—ç¥¨æ¸…å–®ã€‚
// ç”¨æ–¼åœ¨è¨ºç—‡å®ŒæˆæˆåŠŸä¿å­˜å¾Œæ‰çœŸæ­£è³¼è²·å¥—ç¥¨ã€‚
// æ¯å€‹é …ç›®åŒ…å« patientIdã€item èˆ‡ä½¿ç”¨é¦–å¼µæ¬¡æ•¸çš„ç¢ºèªã€‚
let pendingPackagePurchases = [];

/**
 * è¨ˆç®—æŒ‡å®šç—…äººå’Œå¥—ç¥¨çš„æš«å­˜è®Šæ›´ç¸½å’Œã€‚
 * @param {string} patientId
 * @param {string} packageRecordId
 * @returns {number}
 */

/**
 * å°‡æ‰€æœ‰æš«å­˜çš„å¥—ç¥¨è®Šæ›´åŒæ­¥è‡³ Firestoreã€‚
 * åœ¨ä¿å­˜ç—…æ­·æ™‚å‘¼å«æ­¤å‡½å¼ï¼Œæ ¹æ“š pendingPackageChanges ä¸­ç´¯ç©çš„å·®å€¼
 * æ›´æ–°å„å¥—ç¥¨çš„å‰©é¤˜æ¬¡æ•¸ã€‚
 */
async function commitPendingPackageChanges() {
    try {
        // èšåˆè®Šæ›´ï¼Œé¿å…å°åŒä¸€ç­†å¥—ç¥¨é‡è¤‡æ›´æ–°
        const aggregated = {};
        for (const change of pendingPackageChanges) {
            if (!change || !change.patientId || !change.packageRecordId || typeof change.delta !== 'number') continue;
            const key = String(change.patientId) + '||' + String(change.packageRecordId);
            if (!aggregated[key]) {
                aggregated[key] = { patientId: change.patientId, packageRecordId: change.packageRecordId, delta: 0 };
            }
            aggregated[key].delta += change.delta;
        }
        // å¥—ç”¨æ¯å€‹èšåˆå¾Œçš„è®Šæ›´
        for (const key in aggregated) {
            const { patientId, packageRecordId, delta } = aggregated[key];
            // å¦‚æžœ delta ç‚º 0 å‰‡ä¸åšä»»ä½•æ›´æ–°
            if (!delta) continue;
            try {
                // é‡æ–°è®€å–ç•¶å‰ç—…äººçš„å¥—ç¥¨ï¼Œä¸ä½¿ç”¨å¿«å–ä»¥ç¢ºä¿ä½¿ç”¨æœ€æ–°è³‡æ–™
                // å¦‚æžœå¿«å–ä¸­å·²æœ‰è³‡æ–™ï¼Œä½†æˆ‘å€‘éœ€è¦è¨ˆç®—æœ€æ–°çš„å‰©é¤˜æ¬¡æ•¸ï¼Œå¯ç›´æŽ¥å–å¾—å¿«å–è³‡æ–™
                // é‡æ–°è¼‰å…¥ç—…äººçš„å¥—ç¥¨ï¼ˆå¼·åˆ¶åˆ·æ–°ï¼‰ï¼Œé¿å…å› å…¶ä»–è£ç½®è®Šæ›´å°Žè‡´è¨ˆç®—éŒ¯èª¤
                let packages = await getPatientPackages(patientId, true);
                // æ¯”è¼ƒ ID æ™‚çµ±ä¸€è½‰ç‚ºå­—ä¸²ï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´æ‰¾ä¸åˆ°å¥—ç¥¨
                const pkg = packages.find(p => String(p.id) === String(packageRecordId));
                if (!pkg) continue;
                let newRemaining = (pkg.remainingUses || 0) + delta;
                // ç´„æŸ remainingUses ä¸å°æ–¼ 0ï¼Œä¹Ÿä¸è¶…éŽ totalUsesï¼ˆè‹¥ totalUses å®šç¾©ï¼‰
                if (typeof pkg.totalUses === 'number') {
                    newRemaining = Math.max(0, Math.min(pkg.totalUses, newRemaining));
                } else {
                    newRemaining = Math.max(0, newRemaining);
                }
                // çµ„åˆæ›´æ–°å¾Œçš„å¥—ç¥¨è³‡æ–™
                const updatedPackage = { ...pkg, remainingUses: newRemaining };
                // æ›´æ–°å¾Œç«¯è³‡æ–™
                await window.firebaseDataManager.updatePatientPackage(packageRecordId, updatedPackage);
                // æ›´æ–°æœ¬åœ°å¿«å–ï¼Œä»¥ä¾¿ä¹‹å¾Œå‘¼å« getPatientPackages èƒ½å¾—åˆ°æœ€æ–°è³‡æ–™
                if (patientPackagesCache && Array.isArray(patientPackagesCache[patientId])) {
                    patientPackagesCache[patientId] = patientPackagesCache[patientId].map(p => {
                        if (String(p.id) === String(packageRecordId)) {
                            return { ...p, remainingUses: newRemaining };
                        }
                        return p;
                    });
                }
            } catch (err) {
                console.error('å¥—ç”¨æš«å­˜å¥—ç¥¨è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
            }
        }
    } catch (error) {
        console.error('æäº¤æš«å­˜å¥—ç¥¨è®Šæ›´éŒ¯èª¤:', error);
    }
}

/**
 * å°‡æ‰€æœ‰æš«å­˜çš„å¥—ç¥¨è³¼è²·æ“ä½œæäº¤è‡³è³‡æ–™åº«ã€‚
 * åœ¨ä¿å­˜è¨ºç—‡æˆåŠŸå¾Œå‘¼å«æ­¤å‡½å¼ï¼Œæ ¹æ“š pendingPackagePurchases ä¸­çš„ç´€éŒ„è³¼è²·å¥—ç¥¨ï¼Œ
 * å¦‚ä½¿ç”¨è€…é¸æ“‡ç«‹å³ä½¿ç”¨ï¼Œå‰‡æ–¼è³¼è²·å¾Œç«‹å³æ¶ˆè€—ä¸€æ¬¡ã€‚
 * æäº¤å®Œæˆå¾Œï¼Œæœƒæ›´æ–°æ”¶è²»åˆ—è¡¨ä»¥åæ˜ ä½¿ç”¨å¥—ç¥¨çš„æŠ˜æŠµã€‚
 */
async function commitPendingPackagePurchases() {
    try {
        if (!pendingPackagePurchases || pendingPackagePurchases.length === 0) {
            return;
        }
        for (const purchase of pendingPackagePurchases) {
            if (!purchase || !purchase.patientId || !purchase.item) continue;
            const { patientId, item, confirmUse, usageItemId } = purchase;
            // å…ˆè³¼è²·å¥—ç¥¨
            const purchasedPackage = await purchasePackage(patientId, item);
            if (purchasedPackage) {
                // è‹¥ä½¿ç”¨è€…é¸æ“‡ç«‹å³ä½¿ç”¨ï¼Œå‰‡æ¶ˆè€—ä¸€æ¬¡
                if (confirmUse) {
                    try {
                        const useResult = await consumePackage(patientId, purchasedPackage.id);
                        if (useResult && useResult.ok) {
                            // å˜—è©¦æ›´æ–°é å…ˆåŠ å…¥çš„å¥—ç¥¨ä½¿ç”¨é …ç›®çš„ packageRecordId èˆ‡ patientId
                            if (usageItemId) {
                                const idx = selectedBillingItems.findIndex(it => it && it.id === usageItemId);
                                if (idx >= 0) {
                                    // ç”Ÿæˆæ–°çš„ ID ä»¥ç¬¦åˆçµ±ä¸€çš„æ ¼å¼
                                    const newId = `use-${purchasedPackage.id}-${Date.now()}-${Math.random()}`;
                                    selectedBillingItems[idx] = {
                                        ...selectedBillingItems[idx],
                                        id: newId,
                                        patientId: (patientId !== undefined && patientId !== null) ? String(patientId) : '',
                                        packageRecordId: (purchasedPackage && purchasedPackage.id) ? String(purchasedPackage.id) : ''
                                    };
                                } else {
                                    // è‹¥æ‰¾ä¸åˆ°å°æ‡‰çš„æš«å­˜é …ç›®ï¼Œå‰‡å¦è¡Œæ·»åŠ 
                                    selectedBillingItems.push({
                                        id: `use-${purchasedPackage.id}-${Date.now()}-${Math.random()}`,
                                        name: `${item.name} (ä½¿ç”¨å¥—ç¥¨)`,
                                        category: 'packageUse',
                                        price: 0,
                                        unit: 'æ¬¡',
                                        description: 'å¥—ç¥¨æŠµæ‰£ä¸€æ¬¡',
                                        quantity: 1,
                                        includedInDiscount: false,
                                        patientId: (patientId !== undefined && patientId !== null) ? String(patientId) : '',
                                        packageRecordId: (purchasedPackage && purchasedPackage.id) ? String(purchasedPackage.id) : ''
                                    });
                                }
                            } else {
                                // æœªè¨˜éŒ„æš«å­˜ä½¿ç”¨é …ç›®ï¼Œå‰‡ç›´æŽ¥æ·»åŠ 
                                selectedBillingItems.push({
                                    id: `use-${purchasedPackage.id}-${Date.now()}-${Math.random()}`,
                                    name: `${item.name} (ä½¿ç”¨å¥—ç¥¨)`,
                                    category: 'packageUse',
                                    price: 0,
                                    unit: 'æ¬¡',
                                    description: 'å¥—ç¥¨æŠµæ‰£ä¸€æ¬¡',
                                    quantity: 1,
                                    includedInDiscount: false,
                                    patientId: (patientId !== undefined && patientId !== null) ? String(patientId) : '',
                                    packageRecordId: (purchasedPackage && purchasedPackage.id) ? String(purchasedPackage.id) : ''
                                });
                            }
                            {
                                // Show package use success message in selected language
                                const lang = localStorage.getItem('lang') || 'zh';
                                const zhMsg = `å·²ä½¿ç”¨å¥—ç¥¨ï¼š${item.name}ï¼Œå‰©é¤˜ ${useResult.record.remainingUses} æ¬¡`;
                                const enMsg = `Used package: ${item.name}, remaining ${useResult.record.remainingUses} uses`;
                                const msg = lang === 'en' ? enMsg : zhMsg;
                                showToast(msg, 'info');
                            }
                        } else {
                            {
                                const lang = localStorage.getItem('lang') || 'zh';
                                const zhMsg = `ä½¿ç”¨å¥—ç¥¨å¤±æ•—ï¼š${useResult && useResult.msg ? useResult.msg : 'ä¸æ˜ŽéŒ¯èª¤'}`;
                                const enMsg = `Failed to use package: ${useResult && useResult.msg ? useResult.msg : 'Unknown error'}`;
                                const msg = lang === 'en' ? enMsg : zhMsg;
                                showToast(msg, 'error');
                            }
                        }
                    } catch (err) {
                        console.error('ä½¿ç”¨å¥—ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                        {
                            const lang = localStorage.getItem('lang') || 'zh';
                            const zhMsg = 'ä½¿ç”¨å¥—ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤';
                            const enMsg = 'An error occurred while using the package';
                            const msg = lang === 'en' ? enMsg : zhMsg;
                            showToast(msg, 'error');
                        }
                    }
                }
            } else {
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const zhMsg = `å¥—ç¥¨ã€Œ${item.name}ã€è³¼è²·å¤±æ•—`;
                    const enMsg = `Failed to purchase package "${item.name}"`;
                    const msg = lang === 'en' ? enMsg : zhMsg;
                    showToast(msg, 'error');
                }
            }
        }
        // è³¼è²·èˆ‡ä½¿ç”¨è™•ç†å®Œæˆå¾Œï¼Œæ›´æ–°æ”¶è²»é¡¯ç¤ºï¼ˆé›–ç„¶è¡¨å–®å³å°‡é—œé–‰ï¼Œä½†ä»æ›´æ–°ä»¥é¿å…ç•™ä¸‹éŒ¯èª¤ç‹€æ…‹ï¼‰
        if (typeof updateBillingDisplay === 'function') {
            updateBillingDisplay();
        }
        // æ¸…ç©ºæš«å­˜è³¼è²·æ¸…å–®
        pendingPackagePurchases = [];
    } catch (err) {
        console.error('æäº¤æš«å­˜å¥—ç¥¨è³¼è²·æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }
}

/**
 * å¾©åŽŸæ‰€æœ‰æš«å­˜çš„å¥—ç¥¨è³¼è²·ã€‚
 * ç•¶å–æ¶ˆè¨ºç—‡æˆ–é€€å‡ºç·¨è¼¯ä¸”æœªä¿å­˜æ™‚å‘¼å«æ­¤å‡½å¼ï¼Œ
 * åªéœ€æ¸…é™¤ pendingPackagePurchasesï¼Œå› å°šæœªè³¼è²·è³‡æ–™åº«ä¸¦ç„¡éœ€å›žæ»¾ã€‚
 */
function revertPendingPackagePurchases() {
    try {
        // ç§»é™¤æš«å­˜çš„å¥—ç¥¨ä½¿ç”¨é …ç›®ï¼ˆid ä»¥ pending-use- é–‹é ­ï¼‰
        if (Array.isArray(selectedBillingItems) && selectedBillingItems.length > 0) {
            selectedBillingItems = selectedBillingItems.filter(item => {
                return !(item && typeof item.id === 'string' && item.id.startsWith('pending-use-'));
            });
            // æ›´æ–°æ”¶è²»é¡¯ç¤º
            if (typeof updateBillingDisplay === 'function') {
                updateBillingDisplay();
            }
        }
    } catch (err) {
        console.error('å¾©åŽŸæš«å­˜å¥—ç¥¨è³¼è²·æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }
    // æ¸…ç©ºæš«å­˜è³¼è²·æ¸…å–®
    pendingPackagePurchases = [];
}

/**
 * å¾©åŽŸæ‰€æœ‰æš«å­˜çš„å¥—ç¥¨ä½¿ç”¨è®Šæ›´ã€‚
 * ç•¶å–æ¶ˆè¨ºç—‡æˆ–é€€å‡ºç·¨è¼¯ä¸”æœªä¿å­˜æ™‚å‘¼å«æ­¤å‡½å¼ï¼Œ
 * ä¾åºå°‡ pendingPackageChanges ä¸­çš„å„é …æ”¹è®Šå€’è½‰ï¼ˆå³æ¸›åŽ» deltaï¼‰ï¼Œ
 * ä¸¦æ¸…ç©º pendingPackageChangesã€‚
 */
async function revertPendingPackageChanges() {
    // å–æ¶ˆè¨ºç—‡æˆ–é€€å‡ºç·¨è¼¯æ™‚ï¼Œä¸å†å›žå¾©è³‡æ–™åº«ä¸­çš„å¥—ç¥¨æ¬¡æ•¸ã€‚
    // åªéœ€æ¸…é™¤æš«å­˜çš„è®Šæ›´ä¸¦é‡æ–°æ¸²æŸ“å¥—ç¥¨åˆ—è¡¨ï¼Œä»¥æ¢å¾©åŽŸå§‹é¡¯ç¤ºã€‚
    try {
        // å…ˆå¾©åŽŸæš«å­˜çš„å¥—ç¥¨è³¼è²·ï¼ˆåŒ…å«ç§»é™¤æš«å­˜çš„ä½¿ç”¨é …ç›®ï¼‰
        if (typeof revertPendingPackagePurchases === 'function') {
            revertPendingPackagePurchases();
        }
        // æ¸…é™¤æš«å­˜å¥—ç¥¨ä½¿ç”¨è®Šæ›´
        pendingPackageChanges = [];
        // æ¸…é™¤æš«å­˜å¥—ç¥¨è³¼è²·è®Šæ›´
        pendingPackagePurchases = [];
        if (typeof refreshPatientPackagesUI === 'function') {
            await refreshPatientPackagesUI();
        }
    } catch (e) {
        console.error('é‡ç½®æš«å­˜å¥—ç¥¨è®Šæ›´éŒ¯èª¤:', e);
    }
}

/**
 * é€šç”¨çš„è³‡æ–™å¿«å–å™¨ã€‚
 *
 * è¨±å¤šè®€å–è³‡æ–™çš„å‡½å¼åƒ…åœ¨å¿«å–ä¸å­˜åœ¨æˆ–å¼·åˆ¶é‡æ–°è®€å–æ™‚æ‰å¾žè³‡æ–™åº«å–å¾—è³‡æ–™ã€‚
 * é€™å€‹å·¥å…·å‡½å¼ç”¨ä¾†ç°¡åŒ–é€™é¡žæ¨¡å¼ï¼Œé¿å…åœ¨ä¸åŒåœ°æ–¹é‡è¤‡æ’°å¯«å¿«å–é‚è¼¯ã€‚
 *
 * @param {any} cache ç•¶å‰å¿«å–è³‡æ–™
 * @param {Function} fetchFunc å›žå‚³ Promise çš„å‡½å¼ï¼Œç”¨æ–¼å¾žè³‡æ–™åº«è¼‰å…¥è³‡æ–™
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°è¼‰å…¥
 * @returns {Promise<any[]>} æœ€æ–°çš„è³‡æ–™é™£åˆ—
 */
async function fetchDataWithCache(cache, fetchFunc, forceRefresh = false) {
    try {
        // è‹¥éœ€è¦é‡æ–°è®€å–ï¼Œæˆ–å¿«å–ç‚ºç©ºå‰‡å¾žè³‡æ–™åº«è®€å–
        if (forceRefresh || !cache) {
            const result = await fetchFunc();
            if (result && result.success) {
                cache = result.data;
            } else {
                // è‹¥å–å¾—å¤±æ•—ï¼ˆä¾‹å¦‚æ¬Šé™ä¸è¶³ï¼‰ï¼Œä¿ç•™ç¾æœ‰å¿«å–è€Œä¸æ˜¯è¦†å¯«ç‚º null
                // åªæœ‰ç•¶å…ˆå‰æ²’æœ‰å¿«å–æ™‚ï¼Œæ‰å°‡å¿«å–è¨­ç‚º null
                if (!cache) {
                    cache = null;
                }
            }
        }
        // å›žå‚³å¿«å–ï¼Œå¦‚æžœä»ç‚º null å‰‡è¿”å›žç©ºé™£åˆ—
        return cache || [];
    } catch (error) {
        console.error('è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
        return [];
    }
}

/**
 * å–å¾—ç—…äººåˆ—è¡¨ä¸¦ä½¿ç”¨æœ¬åœ°å¿«å–ã€‚
 * åˆ©ç”¨ `fetchDataWithCache` å‡½å¼çµ±ä¸€è®€å–é‚è¼¯ã€‚
 *
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾ž Firestore è®€å–è³‡æ–™
 * @returns {Promise<Array>} ç—…äººè³‡æ–™é™£åˆ—
 */
async function fetchPatients(forceRefresh = false, pageNumber = null) {
    // è‹¥æŒ‡å®šé ç¢¼ï¼Œä½¿ç”¨æ¸¸æ¨™æ–¹å¼åƒ…è®€å–è©²é è³‡æ–™
    if (pageNumber !== null && typeof pageNumber === 'number') {
        return await fetchPatientsPage(pageNumber, forceRefresh);
    }
    // é è¨­è¡Œç‚ºï¼šå¾žå¿«å–è¼‰å…¥å…¨éƒ¨ç—…äººè³‡æ–™
    // ä½¿ç”¨ safeGetPatients æ™‚å°‡ forceRefresh å‚³å…¥ï¼Œä»¥ä¾¿åœ¨è·¨è£ç½®æ“ä½œæ™‚èƒ½å¼·åˆ¶å¾žå¾Œç«¯è¼‰å…¥è³‡æ–™
    patientCache = await fetchDataWithCache(
        patientCache,
        () => safeGetPatients(forceRefresh),
        forceRefresh
    );
    return patientCache;
}

/**
 * æ ¹æ“šç—…äºº ID å–å¾—ç—…äººè³‡æ–™ã€‚æ­¤å‡½å¼å°‡å¾žæœ¬åœ°å¿«å–å°‹æ‰¾ï¼Œ
 * è‹¥æ‰¾ä¸åˆ°å‰‡å¼·åˆ¶é‡æ–°å¾ž Firebase è®€å–ä¸€æ¬¡ï¼Œå†æ¬¡å°‹æ‰¾ã€‚
 * å¦‚æžœä»æœªæ‰¾åˆ°ï¼Œæœ€çµ‚æœƒç›´æŽ¥å¾ž FirebaseDataManager å–å¾—æ‰€æœ‰ç—…äºº
 * ä¸¦åœ¨å…¶ä¸­æœå°‹ï¼Œä»¥é¿å…å¤šè£ç½®é–“å¿«å–ä¸ä¸€è‡´çš„å•é¡Œã€‚
 *
 * @param {string|number} id - ç—…äººæ–‡ä»¶çš„ ID
 * @returns {Promise<Object|null>} æ‰¾åˆ°çš„ç—…äººç‰©ä»¶ï¼Œè‹¥æ‰¾ä¸åˆ°å‰‡ç‚º null
 */
async function getPatientByIdWithRefresh(id) {
    // è‹¥æœªæä¾› IDï¼Œç›´æŽ¥å›žå‚³ null
    if (id === undefined || id === null) return null;
    const idStr = String(id);
    try {
        // å…ˆå¾žæœ¬åœ°å¿«å–å°‹æ‰¾
        let all = await fetchPatients(false);
        if (Array.isArray(all) && all.length > 0) {
            const found = all.find(p => p && String(p.id) === idStr);
            if (found) return found;
        }
        // è‹¥æœªæ‰¾åˆ°ï¼Œå¼·åˆ¶é‡æ–°è®€å–æ•´å€‹åˆ—è¡¨
        all = await fetchPatients(true);
        if (Array.isArray(all) && all.length > 0) {
            const found2 = all.find(p => p && String(p.id) === idStr);
            if (found2) return found2;
        }
        // ä»æœªæ‰¾åˆ°æ™‚ï¼Œå˜—è©¦ç›´æŽ¥å‘ FirebaseDataManager å–å¾—è³‡æ–™
        try {
            // ç¢ºä¿ DataManager å°±ç·’å¾Œä½¿ç”¨ safeGetPatients å–å¾—å®Œæ•´ç—…äººåˆ—è¡¨
            if (typeof waitForFirebaseDataManager === 'function') {
                await waitForFirebaseDataManager();
            }
            // åœ¨è·¨è£ç½®æƒ…æ³ä¸‹å¼·åˆ¶å¾žå¾Œç«¯é‡æ–°è®€å–ç—…äººè³‡æ–™ï¼Œä»¥ç²å–æœ€æ–°è³‡è¨Š
            const result = await safeGetPatients(true);
            if (result && result.success && Array.isArray(result.data)) {
                const found3 = result.data.find(p => p && String(p.id) === idStr);
                if (found3) {
                    return found3;
                }
            }
        } catch (innerErr) {
            console.error('ç›´æŽ¥å¾ž Firebase å–å¾—ç—…äººè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', innerErr);
        }
    } catch (err) {
        console.error('å–å¾—ç—…äººè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }
    return null;
}

/**
 * é€éŽæ¸¸æ¨™åŠ limit æ–¹å¼åˆ†é è®€å–ç—…äººè³‡æ–™ã€‚
 * é æ•¸å¾ž 1 é–‹å§‹è¨ˆç®—ã€‚è®€å–å¾Œæœƒå¿«å–è©²é è³‡æ–™åŠæœ€å¾Œä¸€ç­†æ–‡ä»¶ï¼Œä»¥åˆ©ä¸‹ä¸€é æŸ¥è©¢ã€‚
 * ç•¶ forceRefresh ç‚º true æ™‚ï¼Œæœƒæ¸…é™¤æ‰€æœ‰åˆ†é å¿«å–ä¸¦é‡æ–°è®€å–ã€‚
 *
 * @param {number} pageNumber æ¬²è®€å–çš„é ç¢¼ï¼Œå¾ž 1 èµ·ç®—
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°è¼‰å…¥
 * @returns {Promise<Array>} è©²é ç—…äººè³‡æ–™é™£åˆ—
 */
async function fetchPatientsPage(pageNumber = 1, forceRefresh = false) {
    // åƒæ•¸æª¢æŸ¥
    if (pageNumber < 1) pageNumber = 1;
    // å¦‚æžœå¼·åˆ¶åˆ·æ–°ï¼Œæ¸…ç©ºåˆ†é å¿«å–
    if (forceRefresh) {
        patientPagesCache = {};
        patientPageCursors = {};
    }
    // è‹¥å¿«å–ä¸­å·²æœ‰å°æ‡‰é è³‡æ–™ï¼Œç›´æŽ¥è¿”å›ž
    if (!forceRefresh && patientPagesCache[pageNumber]) {
        return patientPagesCache[pageNumber];
    }

    /*
     * ç‚ºè§£æ±ºè·³é é¡¯ç¤ºç›¸åŒè³‡æ–™çš„å•é¡Œï¼Œç•¶ä½¿ç”¨è€…ç›´æŽ¥è·³è‡³ç¬¬ N é æ™‚ï¼Œè‹¥
     * ä¹‹å‰çš„é é¢å°šæœªè¼‰å…¥ï¼ˆç¼ºå°‘ patientPageCursors[N-1] æˆ–
     * patientPagesCache[N-1]ï¼‰ï¼Œå…ˆä¾åºè¼‰å…¥æ‰€æœ‰å‰ç½®é é¢ã€‚
     * é€™æ¨£å¯å»ºç«‹æ¯ä¸€é å°æ‡‰çš„æ¸¸æ¨™ï¼Œé¿å… Firestore å¾žé ­é–‹å§‹æŸ¥è©¢å°Žè‡´
     * å–å¾—ç›¸åŒè³‡æ–™ã€‚å‘¼å« fetchPatientsPage(i) æœƒéžè¿´åŸ·è¡Œæ­¤é‚è¼¯ã€‚
     */
    if (!forceRefresh && pageNumber > 1) {
        const prevPage = pageNumber - 1;
        // å¦‚æžœç¼ºå°‘å‰ä¸€é çš„æ¸¸æ¨™æˆ–å¿«å–ï¼Œé€é è¼‰å…¥ç¼ºå¤±çš„é é¢
        if (!patientPageCursors[prevPage] || !patientPagesCache[prevPage]) {
            for (let i = 1; i < pageNumber; i++) {
                if (!patientPagesCache[i]) {
                    await fetchPatientsPage(i, forceRefresh);
                }
            }
        }
    }

    await waitForFirebaseDb();
    try {
        const pageSize = paginationSettings && paginationSettings.patientList && paginationSettings.patientList.itemsPerPage
            ? paginationSettings.patientList.itemsPerPage
            : 10;
        // å»ºç«‹åŸºç¤ŽæŸ¥è©¢ï¼šä¾ç…§ patientNumber ç”±æ–°è‡³èˆŠæŽ’åº
        let q = window.firebase.firestoreQuery(
            window.firebase.collection(window.firebase.db, 'patients'),
            window.firebase.orderBy('patientNumber', 'desc'),
            window.firebase.limit(pageSize)
        );
        // å¦‚æžœé ç¢¼å¤§æ–¼ 1ï¼Œä¸”å‰ä¸€é å·²è¨˜éŒ„æœ€å¾Œä¸€ç­†æ–‡ä»¶ï¼Œå‰‡ä»¥è©²æ–‡ä»¶ç‚ºèµ·é»ž
        if (pageNumber > 1) {
            const prevCursor = patientPageCursors[pageNumber - 1];
            if (prevCursor) {
                q = window.firebase.firestoreQuery(q, window.firebase.startAfter(prevCursor));
            }
        }
        const snapshot = await window.firebase.getDocs(q);
        const docs = [];
        snapshot.forEach((doc) => {
            docs.push({ id: doc.id, ...doc.data() });
        });
        // è¨˜éŒ„æœ€å¾Œä¸€å€‹æ–‡ä»¶ä½œç‚ºä¸‹ä¸€é çš„æ¸¸æ¨™
        if (docs.length > 0) {
            const lastDoc = snapshot.docs[snapshot.docs.length - 1];
            patientPageCursors[pageNumber] = lastDoc;
        }
        // å¿«å–æœ¬é è³‡æ–™
        patientPagesCache[pageNumber] = docs;
        return docs;
    } catch (error) {
        console.error('åˆ†é è®€å–ç—…äººè³‡æ–™å¤±æ•—:', error);
        return [];
    }
}

/**
 * å–å¾—ç—…äººç¸½æ•¸ï¼Œé€éŽ Firestore èšåˆæŸ¥è©¢ count()ã€‚
 * çµæžœå°‡å¿«å–ï¼Œä»¥é¿å…é‡è¤‡è¨ˆç®—ï¼›é™¤éž forceRefresh ç‚º true æ‰é‡æ–°æŸ¥è©¢ã€‚
 *
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾ž Firestore è®€å–ç¸½æ•¸
 * @returns {Promise<number>} ç—…äººæ•¸é‡
 */
async function getPatientsCount(forceRefresh = false) {
    // è‹¥å¿«å–å·²å­˜åœ¨ä¸”æœªè¦æ±‚å¼·åˆ¶åˆ·æ–°ï¼Œç›´æŽ¥è¿”å›žå¿«å–å€¼
    if (!forceRefresh && typeof patientsCountCache === 'number') {
        return patientsCountCache;
    }
    try {
        await waitForFirebaseDb();
        // å»ºç«‹æŸ¥è©¢ï¼ˆä¸æŒ‡å®šæŽ’åºæˆ–æ¢ä»¶ï¼‰
        const colRef = window.firebase.collection(window.firebase.db, 'patients');
        // ä½¿ç”¨ Firestore èšåˆæŸ¥è©¢å–å¾—æ–‡ä»¶ç¸½æ•¸
        const countSnap = await window.firebase.getCountFromServer(colRef);
        const count = countSnap.data().count;
        patientsCountCache = typeof count === 'number' ? count : 0;
        return patientsCountCache;
    } catch (error) {
        console.error('å–å¾—ç—…äººç¸½æ•¸å¤±æ•—:', error);
        return 0;
    }
}

/**
 * å–å¾—è¨ºç—‡è¨˜éŒ„åˆ—è¡¨ä¸¦ä½¿ç”¨æœ¬åœ°å¿«å–ã€‚
 * åˆ©ç”¨ `fetchDataWithCache` å‡½å¼çµ±ä¸€è®€å–é‚è¼¯ã€‚
 *
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾ž Firestore è®€å–è³‡æ–™
 * @returns {Promise<Array>} è¨ºç—‡è³‡æ–™é™£åˆ—
 */
async function fetchConsultations(forceRefresh = false) {
    consultationCache = await fetchDataWithCache(
        consultationCache,
        () => window.firebaseDataManager.getConsultations(),
        forceRefresh
    );
    return consultationCache;
}

/**
 * å–å¾—ç”¨æˆ¶åˆ—è¡¨ä¸¦ä½¿ç”¨æœ¬åœ°å¿«å–ã€‚
 * åˆ©ç”¨ `fetchDataWithCache` å‡½å¼çµ±ä¸€è®€å–é‚è¼¯ã€‚
 *
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾ž Firestore è®€å–è³‡æ–™
 * @returns {Promise<Array>} ç”¨æˆ¶è³‡æ–™é™£åˆ—
 */
/**
 * å–å¾—ç”¨æˆ¶åˆ—è¡¨ä¸¦ä½¿ç”¨æœ¬åœ°å¿«å–ã€‚
 *
 * æ­¤å‡½å¼æœƒåˆ©ç”¨ fetchDataWithCache å°è£çš„å¿«å–æ©Ÿåˆ¶ï¼Œ
 * ä½†éœ€æ³¨æ„çš„æ˜¯ï¼Œå®ƒæœƒå°‡ forceRefresh åƒæ•¸å‚³éžè‡³
 * FirebaseDataManager.getUsers(forceRefresh) ä¸­ï¼Œä»¥ä¾¿åœ¨éœ€è¦
 * å¼·åˆ¶é‡æ–°è¼‰å…¥è³‡æ–™æ™‚å¯¦éš›æ¸…ç©ºå¾Œç«¯å¿«å–ä¸¦è®€å–æœ€æ–°æ•¸æ“šã€‚
 * è‹¥ä¸å‚³éž forceRefreshï¼ŒDataManager.getUsers() æ°¸é 
 * é è¨­ç‚º falseï¼Œå°Žè‡´ç„¡æ³•åœ¨ç™»å…¥æ™‚æ›´æ–°èˆŠè³‡æ–™ã€‚
 *
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾ž Firestore è®€å–
 * @returns {Promise<Array>} ç”¨æˆ¶è³‡æ–™é™£åˆ—
 */
async function fetchUsers(forceRefresh = false) {
    // å°‡ forceRefresh åƒæ•¸å‚³éžçµ¦ getUsers()ï¼Œç¢ºä¿å¯åœ¨éœ€è¦æ™‚é‡å–è³‡æ–™
    userCache = await fetchDataWithCache(
        userCache,
        () => window.firebaseDataManager.getUsers(forceRefresh),
        forceRefresh
    );
    return userCache;
}
        
        // è¨ºæ‰€è¨­å®š
        let clinicSettings = JSON.parse(localStorage.getItem('clinicSettings') || '{}');
        if (!clinicSettings.chineseName) {
            clinicSettings.chineseName = 'åé†«è¨ºæ‰€ç³»çµ±';
            // é è¨­è‹±æ–‡åç¨±æ”¹ç‚º Dr.Great Clinicï¼Œè€ŒéžåŽŸæœ¬çš„ TCM Clinic
            clinicSettings.englishName = 'Dr.Great Clinic';
            clinicSettings.businessHours = 'é€±ä¸€è‡³é€±äº” 09:00-18:00';
            clinicSettings.phone = '(852) 2345-6789';
            clinicSettings.address = 'é¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­123è™Ÿ';
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
        }
        
        // æµ®å‹•æç¤ºåŠŸèƒ½æ”¹ç”¨ Toastr æä¾›è¦–è¦ºèˆ‡åŠŸèƒ½æ€§æç¤º
        function showToast(message, type = 'info') {
            // å°‡è¨Šæ¯ç¿»è­¯ç‚ºç•¶å‰èªžè¨€ï¼Œå¦‚æžœå¯ç”¨
            try {
                if (window.t) {
                    message = window.t(message);
                } else {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const dict = window.translations && window.translations[lang] || {};
                    message = dict[message] || message;
                }
            } catch (e) {
                // è‹¥ç¿»è­¯å¤±æ•—å‰‡ä¿æŒåŽŸè¨Šæ¯
            }
            // è¨­å®š Toastr é¸é …ï¼šå¸¶é—œé–‰æŒ‰éˆ•èˆ‡é€²åº¦æ¢ï¼Œä½ç½®å›ºå®šæ–¼å³ä¸Šè§’ï¼Œé¡¯ç¤ºæ™‚é–“ä¾è¨Šæ¯é•·åº¦èª¿æ•´
            const timeout = Math.max(3000, (message || '').length * 100);
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: 'toast-top-right',
                timeOut: timeout,
                extendedTimeOut: timeout + 1000
            };
            // æ ¹æ“šé¡žåž‹å‘¼å«å°æ‡‰çš„ Toastr æ–¹æ³•
            let method = 'info';
            if (type === 'success') method = 'success';
            else if (type === 'error') method = 'error';
            else if (type === 'warning') method = 'warning';
            else if (type === 'info') method = 'info';
            toastr[method](message);
        }

        // å°‡æç¤ºå‡½å¼æŽ›è¼‰åˆ°å…¨åŸŸ window å°è±¡ï¼Œæ–¹ä¾¿åœ¨å…¶ä»–æ¨¡çµ„å‘¼å«ã€‚
        if (!window.showToast) {
            window.showToast = showToast;
        }

        /**
         * ä½¿ç”¨ SweetAlert2 é¡¯ç¤ºç¢ºèªå½ˆçª—ã€‚
         * å‚³å…¥è¨Šæ¯èˆ‡åœ–ç¤ºé¡žåž‹ï¼Œè¿”å›žä¸€å€‹ Promiseï¼Œè§£æžç‚ºå¸ƒæž—å€¼ä»£è¡¨æ˜¯å¦ç¢ºèªã€‚
         * é è¨­åœ–ç¤ºç‚º warningã€‚
         * @param {string} message æç¤ºè¨Šæ¯ï¼Œå¯å«æ›è¡Œç¬¦
         * @param {string} type SweetAlert2 åœ–ç¤ºé¡žåž‹ï¼Œä¾‹å¦‚ 'warning'ã€'info'ã€'question'
         * @returns {Promise<boolean>} ä½¿ç”¨è€…æ˜¯å¦ç¢ºèª
         */
        async function showConfirmation(message, type = 'warning') {
            // ç¿»è­¯è¨Šæ¯
            try {
                if (window.t) {
                    message = window.t(message);
                } else {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const dict = window.translations && window.translations[lang] || {};
                    message = dict[message] || message;
                }
            } catch (e) {
                // ä¿æŒåŽŸè¨Šæ¯
            }
            const lang = localStorage.getItem('lang') || 'zh';
            const okLabel = lang === 'en' ? 'OK' : 'ç¢ºå®š';
            const cancelLabel = lang === 'en' ? 'Cancel' : 'å–æ¶ˆ';
            const result = await Swal.fire({
                icon: type || 'warning',
                html: (message || '').replace(/\n/g, '<br/>'),
                showCancelButton: true,
                confirmButtonText: okLabel,
                cancelButtonText: cancelLabel,
                focusConfirm: false
            });
            return !!(result && result.isConfirmed);
        }
        if (!window.showConfirmation) {
            window.showConfirmation = showConfirmation;
        }

        // æ’­æ”¾å€™è¨ºæé†’éŸ³æ•ˆ
        // ä½¿ç”¨ Web Audio API ç”¢ç”Ÿç°¡å–®çš„çŸ­ä¿ƒéŸ³æ•ˆï¼Œé¿å…è¼‰å…¥å¤–éƒ¨éŸ³è¨Šæª”æ¡ˆã€‚
        // æ­¤å‡½å¼åœ¨ç—…äººç‹€æ…‹è®Šç‚ºå€™è¨ºä¸­æ™‚è¢«å‘¼å«ã€‚
function playNotificationSound() {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.type = 'sine';
        // æŸ”å’Œçš„ 440Hz éŸ³é »
        oscillator.frequency.setValueAtTime(440, ctx.currentTime);
        // åˆå§‹éŸ³é‡è¼ƒä½Ž
        gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.start();
        // ç·©æ…¢é™ä½ŽéŸ³é‡ï¼Œç‡Ÿé€ æ¼¸æ¼¸æ·¡å‡ºçš„æ•ˆæžœ
        gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
        oscillator.stop(ctx.currentTime + 0.8);
    } catch (err) {
        console.error('æ’­æ”¾æé†’éŸ³æ•ˆå¤±æ•—:', err);
    }
}

// åŒ¯å…¥å‚™ä»½æ™‚ä½¿ç”¨çš„é€²åº¦æ¢ç›¸é—œå‡½å¼
/**
 * é¡¯ç¤ºå‚™ä»½åŒ¯å…¥é€²åº¦æ¢ã€‚
 * @param {number} totalSteps ç¸½æ­¥é©Ÿæ•¸ï¼Œç”¨æ–¼è¨ˆç®—ç™¾åˆ†æ¯”
 */
function showBackupProgressBar(totalSteps) {
    const container = document.getElementById('backupProgressContainer');
    const bar = document.getElementById('backupProgressBar');
    const text = document.getElementById('backupProgressText');
    if (container && bar && text) {
             container.classList.remove('hidden');
             bar.style.width = '0%';
             // å–å¾—åŒ¯å…¥é€²åº¦æ¨™ç±¤çš„ç¿»è­¯
             let baseLabel = 'åŒ¯å…¥é€²åº¦';
             try {
                 if (window.t) {
                     baseLabel = window.t('åŒ¯å…¥é€²åº¦');
                 } else {
                     const lang = localStorage.getItem('lang') || 'zh';
                     const dict = window.translations && window.translations[lang] || {};
                     baseLabel = dict['åŒ¯å…¥é€²åº¦'] || baseLabel;
                 }
             } catch (e) {
                 baseLabel = 'åŒ¯å…¥é€²åº¦';
             }
             text.textContent = baseLabel + ' 0%';
             container.dataset.totalSteps = totalSteps;
    }
}

/**
 * æ›´æ–°å‚™ä»½åŒ¯å…¥é€²åº¦æ¢ã€‚
 * @param {number} currentStep å·²å®Œæˆçš„æ­¥é©Ÿæ•¸
 * @param {number} totalSteps ç¸½æ­¥é©Ÿæ•¸
 */
function updateBackupProgressBar(currentStep, totalSteps) {
    const container = document.getElementById('backupProgressContainer');
    const bar = document.getElementById('backupProgressBar');
    const text = document.getElementById('backupProgressText');
    if (container && bar && text) {
        const percent = totalSteps > 0 ? Math.round((currentStep / totalSteps) * 100) : 0;
             bar.style.width = percent + '%';
             let baseLabel = 'åŒ¯å…¥é€²åº¦';
             try {
                 if (window.t) {
                     baseLabel = window.t('åŒ¯å…¥é€²åº¦');
                 } else {
                     const lang = localStorage.getItem('lang') || 'zh';
                     const dict = window.translations && window.translations[lang] || {};
                     baseLabel = dict['åŒ¯å…¥é€²åº¦'] || baseLabel;
                 }
             } catch (e) {
                 baseLabel = 'åŒ¯å…¥é€²åº¦';
             }
             text.textContent = baseLabel + ' ' + percent + '%';
    }
}

/**
 * å®Œæˆå‚™ä»½åŒ¯å…¥é€²åº¦æ¢ã€‚
 * @param {boolean} success æ˜¯å¦åŒ¯å…¥æˆåŠŸ
 */
function finishBackupProgressBar(success) {
    const container = document.getElementById('backupProgressContainer');
    const bar = document.getElementById('backupProgressBar');
    const text = document.getElementById('backupProgressText');
    if (container && bar && text) {
             bar.style.width = '100%';
             let successMsg = 'åŒ¯å…¥å®Œæˆï¼';
             let failureMsg = 'åŒ¯å…¥å¤±æ•—ï¼';
             try {
                 if (window.t) {
                     successMsg = window.t('åŒ¯å…¥å®Œæˆï¼');
                     failureMsg = window.t('åŒ¯å…¥å¤±æ•—ï¼');
                 } else {
                     const lang = localStorage.getItem('lang') || 'zh';
                     const dict = window.translations && window.translations[lang] || {};
                     successMsg = dict['åŒ¯å…¥å®Œæˆï¼'] || successMsg;
                     failureMsg = dict['åŒ¯å…¥å¤±æ•—ï¼'] || failureMsg;
                 }
             } catch (e) {
                 // keep defaults
             }
             text.textContent = success ? successMsg : failureMsg;
        // æ–¼ 2 ç§’å¾Œéš±è—é€²åº¦æ¢
        setTimeout(() => {
            container.classList.add('hidden');
        }, 2000);
    }
}

/**
 * é¡¯ç¤ºè³‡æ–™åŒ¯å…¥/æ¸…é™¤é€²åº¦æ¢ã€‚
 * é€™äº›å‡½å¼èˆ‡å‚™ä»½åŒ¯å…¥é€²åº¦æ¢ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨ä¸åŒçš„å®¹å™¨å…ƒç´ ã€‚
 * @param {number} totalSteps ç¸½æ­¥é©Ÿæ•¸ï¼Œç”¨æ–¼è¨ˆç®—ç™¾åˆ†æ¯”
 */
function showImportProgressBar(totalSteps) {
    const container = document.getElementById('importProgressContainer');
    const bar = document.getElementById('importProgressBar');
    const text = document.getElementById('importProgressText');
    if (container && bar && text) {
             container.classList.remove('hidden');
             bar.style.width = '0%';
             let baseLabel = 'åŒ¯å…¥é€²åº¦';
             try {
                 if (window.t) {
                     baseLabel = window.t('åŒ¯å…¥é€²åº¦');
                 } else {
                     const lang = localStorage.getItem('lang') || 'zh';
                     const dict = window.translations && window.translations[lang] || {};
                     baseLabel = dict['åŒ¯å…¥é€²åº¦'] || baseLabel;
                 }
             } catch (e) {
                 baseLabel = 'åŒ¯å…¥é€²åº¦';
             }
             text.textContent = baseLabel + ' 0%';
             container.dataset.totalSteps = totalSteps;
    }
}

/**
 * æ›´æ–°è³‡æ–™åŒ¯å…¥/æ¸…é™¤é€²åº¦æ¢ã€‚
 * @param {number} currentStep å·²å®Œæˆçš„æ­¥é©Ÿæ•¸
 * @param {number} totalSteps ç¸½æ­¥é©Ÿæ•¸
 */
function updateImportProgressBar(currentStep, totalSteps) {
    const container = document.getElementById('importProgressContainer');
    const bar = document.getElementById('importProgressBar');
    const text = document.getElementById('importProgressText');
    if (container && bar && text) {
        const percent = totalSteps > 0 ? Math.round((currentStep / totalSteps) * 100) : 0;
             bar.style.width = percent + '%';
             let baseLabel = 'åŒ¯å…¥é€²åº¦';
             try {
                 if (window.t) {
                     baseLabel = window.t('åŒ¯å…¥é€²åº¦');
                 } else {
                     const lang = localStorage.getItem('lang') || 'zh';
                     const dict = window.translations && window.translations[lang] || {};
                     baseLabel = dict['åŒ¯å…¥é€²åº¦'] || baseLabel;
                 }
             } catch (e) {
                 baseLabel = 'åŒ¯å…¥é€²åº¦';
             }
             text.textContent = baseLabel + ' ' + percent + '%';
    }
}

/**
 * å®Œæˆè³‡æ–™åŒ¯å…¥/æ¸…é™¤é€²åº¦æ¢ã€‚
 * @param {boolean} success æ˜¯å¦æˆåŠŸ
 */
function finishImportProgressBar(success) {
    const container = document.getElementById('importProgressContainer');
    const bar = document.getElementById('importProgressBar');
    const text = document.getElementById('importProgressText');
    if (container && bar && text) {
             bar.style.width = '100%';
             let successMsg = 'åŒ¯å…¥å®Œæˆï¼';
             let failureMsg = 'åŒ¯å…¥å¤±æ•—ï¼';
             try {
                 if (window.t) {
                     successMsg = window.t('åŒ¯å…¥å®Œæˆï¼');
                     failureMsg = window.t('åŒ¯å…¥å¤±æ•—ï¼');
                 } else {
                     const lang = localStorage.getItem('lang') || 'zh';
                     const dict = window.translations && window.translations[lang] || {};
                     successMsg = dict['åŒ¯å…¥å®Œæˆï¼'] || successMsg;
                     failureMsg = dict['åŒ¯å…¥å¤±æ•—ï¼'] || failureMsg;
                 }
             } catch (e) {
                 // keep defaults
             }
             text.textContent = success ? successMsg : failureMsg;
        setTimeout(() => {
            container.classList.add('hidden');
        }, 2000);
    }
}

/**
 * ç”Ÿæˆå”¯ä¸€çš„ç—…æ­·ç·¨è™Ÿã€‚
 * ä½¿ç”¨ç•¶å‰æ—¥æœŸæ™‚é–“å’Œéš¨æ©Ÿæ•¸çµ„æˆï¼Œæ ¼å¼å¦‚ MR20250101123045-1234ã€‚
 * @returns {string} æ–°çš„ç—…æ­·ç·¨è™Ÿ
 */
function generateMedicalRecordNumber() {
    try {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const datePart = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        const randomPart = Math.floor(1000 + Math.random() * 9000);
        return `MR${datePart}-${randomPart}`;
    } catch (e) {
        // è¬ä¸€æ—¥æœŸå–å¾—å¤±æ•—ï¼Œé€€å›žç›®å‰æ™‚é–“æˆ³è¨˜ç‚ºç·¨è™Ÿ
        return `MR${Date.now()}`;
    }
}
        // æŒ‰éˆ•è®€å–ç‹€æ…‹æŽ§åˆ¶å‡½æ•¸
        // åœ¨æŒ‰éˆ•ä¸Šé¡¯ç¤ºä¸€å€‹åŠé€æ˜Žçš„æ—‹è½‰å°åœˆï¼Œä»¥é¡¯ç¤ºæ­£åœ¨è®€å–ä¸­ã€‚
        // åŽŸå§‹å…§å®¹å°‡å„²å­˜åœ¨ data-originalHtml ä¸­ï¼Œå®Œæˆå¾Œå¯å¾©åŽŸã€‚
        function setButtonLoading(button, loadingText) {
            if (!button) return;
            // Save the original HTML so we can restore it later. Preserve the button's
            // text and any nested elements for restoration once loading is complete.
            if (!button.dataset.originalHtml) {
                button.dataset.originalHtml = button.innerHTML;
            }
            /*
             * Capture and store the button's current width and height the first time we set
             * loading. Without setting these explicitly, replacing the button's content with
             * only a small spinner element can cause the element to shrink, which in turn
             * shifts surrounding layout and alters the button's size. By explicitly setting
             * both dimensions, we ensure the button occupies the same space during loading.
             */
            if (!button.dataset.originalWidth || !button.dataset.originalHeight) {
                const computedWidth = button.offsetWidth;
                const computedHeight = button.offsetHeight;
                // Store and set width if it's a valid positive number
                if (computedWidth > 0) {
                    button.dataset.originalWidth = computedWidth + 'px';
                    button.style.width = button.dataset.originalWidth;
                }
                // Store and set height if it's a valid positive number
                if (computedHeight > 0) {
                    button.dataset.originalHeight = computedHeight + 'px';
                    button.style.height = button.dataset.originalHeight;
                }
            }
            // Always disable the button while loading to prevent further clicks
            button.disabled = true;
            /*
             * Only show a spinning indicator while loading. We intentionally do not display any
             * loading text here (including the value passed in via `loadingText`) to satisfy
             * the requirement of "åªéœ€é¡¯ç¤ºè®€å–åœˆ" (only show the spinner). To avoid affecting
             * the button's intrinsic size, we've captured its original width and height above.
             */
            // To avoid layout shifts, we center the spinner by converting the button into a flex container.
            // Save existing layout-related styles so they can be restored later.
            if (!button.dataset.originalDisplay) {
                button.dataset.originalDisplay = button.style.display || '';
                button.dataset.originalAlignItems = button.style.alignItems || '';
                button.dataset.originalJustifyContent = button.style.justifyContent || '';
            }
            // Set up flexbox centering for the spinner
            button.style.display = 'flex';
            button.style.alignItems = 'center';
            button.style.justifyContent = 'center';
            // Replace the button's content with a spinner. We draw a circular spinner by
            // using a full border with the current text color and hiding the top segment.
            // Using border-t-transparent creates a gap for the spin animation, ensuring the
            // spinner is visible on both light and dark backgrounds. We intentionally
            // omit additional opacity here because border-current should provide sufficient
            // contrast; if the button text color is light on a light background, the
            // spinning border will still remain visible thanks to the missing top segment.
            // æ¢å¾©åŽŸå…ˆçš„è®€å–åœˆæ¨£å¼ï¼šä½¿ç”¨è¼ƒå°çš„åœ“å½¢ä¸¦é€éŽ border-t-transparent ç”¢ç”Ÿç¼ºå£ã€‚
            // border-current è®“å¤–æ¡†é¡è‰²èˆ‡æŒ‰éˆ•æ–‡å­—é¡è‰²ä¸€è‡´ï¼Œé©ç”¨æ–¼æ·±è‰²èƒŒæ™¯ã€‚
            button.innerHTML = `<div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-current border-t-transparent"></div>`;
        }

        // æ¸…é™¤æŒ‰éˆ•è®€å–ç‹€æ…‹ï¼Œé‚„åŽŸåŽŸå§‹å…§å®¹
        function clearButtonLoading(button) {
            if (!button) return;
            // Restore the original HTML content if we stored it
            if (button.dataset.originalHtml) {
                button.innerHTML = button.dataset.originalHtml;
                delete button.dataset.originalHtml;
            }
            // Restore the button's width if we stored it previously
            if (button.dataset.originalWidth) {
                // Clear the inline width style so the button can size itself based on its content again
                button.style.width = '';
                delete button.dataset.originalWidth;
            }
            // Restore the button's height if we stored it previously
            if (button.dataset.originalHeight) {
                // Clear the inline height style so the button can size itself based on its content again
                button.style.height = '';
                delete button.dataset.originalHeight;
            }
            // Restore display and alignment properties if they were modified
            if (button.dataset.originalDisplay !== undefined) {
                button.style.display = button.dataset.originalDisplay;
                delete button.dataset.originalDisplay;
            }
            if (button.dataset.originalAlignItems !== undefined) {
                button.style.alignItems = button.dataset.originalAlignItems;
                delete button.dataset.originalAlignItems;
            }
            if (button.dataset.originalJustifyContent !== undefined) {
                button.style.justifyContent = button.dataset.originalJustifyContent;
                delete button.dataset.originalJustifyContent;
            }
            // Re-enable the button
            button.disabled = false;
        }

        /**
         * å¾žäº‹ä»¶æˆ–å‚™æ´é¸æ“‡å™¨å–å¾—è§¸ç™¼æŒ‰éˆ•çš„é€šç”¨å‡½å¼ã€‚
         *
         * å¤šå€‹æ“ä½œå‡½å¼éœ€è¦å…ˆç²å–ç•¶å‰é»žæ“Šçš„æŒ‰éˆ•ä»¥å¥—ç”¨è®€å–ç‹€æ…‹ï¼Œ
         * ä½†ä¸¦éžæ‰€æœ‰å‡½å¼éƒ½ç›´æŽ¥æŽ¥æ”¶ event åƒæ•¸ã€‚å› æ­¤ï¼Œé€™å€‹è¼”åŠ©å‡½å¼
         * æœƒå„ªå…ˆæª¢æŸ¥å…¨åŸŸçš„ event ç‰©ä»¶ï¼Œè‹¥å…¶ä¸­å­˜åœ¨ currentTarget
         * å‰‡è¦–ç‚ºç•¶å‰è§¸ç™¼çš„æŒ‰éˆ•ï¼›å¦å‰‡å°‡ä½¿ç”¨å‚™æ´é¸æ“‡å™¨æŸ¥æ‰¾ã€‚
         *
         * @param {string} fallbackSelector CSS é¸æ“‡å™¨ï¼Œç”¨æ–¼æŸ¥æ‰¾æŒ‰éˆ•
         * @returns {HTMLElement|null} å°æ‡‰çš„æŒ‰éˆ•å…ƒç´ æˆ– null
         */
        function getLoadingButtonFromEvent(fallbackSelector) {
            let btn = null;
            try {
                if (typeof event !== 'undefined' && event && event.currentTarget) {
                    btn = event.currentTarget;
                }
            } catch (_e) {
                // è‹¥ event ç‰©ä»¶ç„¡æ³•å­˜å–å‰‡å¿½ç•¥
            }
            if (!btn) {
                try {
                    btn = document.querySelector(fallbackSelector);
                } catch (_e) {
                    btn = null;
                }
            }
            return btn;
        }

        // è¨ˆç®—å¹´é½¡å‡½æ•¸
        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // æ ¼å¼åŒ–å¹´é½¡é¡¯ç¤º
        function formatAge(birthDate) {
            if (!birthDate) return 'æœªçŸ¥';

            const birth = new Date(birthDate);
            const today = new Date();

            let years = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                years--;
            }

            // å–å¾—ç¿»è­¯å‡½å¼ï¼Œç”¨æ–¼å–å¾—ä¸åŒèªžè¨€ä¸‹çš„å–®ä½
            const translate = typeof window.t === 'function' ? window.t : (s) => s;

            if (years > 0) {
                // ç¿»è­¯ã€Œæ­²ã€å–®ä½ï¼›è‹¥ç¿»è­¯å¾Œèˆ‡åŽŸæ–‡ä¸åŒï¼Œå‰‡åœ¨æ•¸å­—èˆ‡å–®ä½ä¹‹é–“åŠ ç©ºæ ¼
                const unit = translate('æ­²');
                const joiner = unit !== 'æ­²' ? ' ' : '';
                return `${years}${joiner}${unit}`;
            } else {
                // æœªæ»¿ä¸€æ­²çš„å¬°å¹¼å…’é¡¯ç¤ºæœˆæ•¸æˆ–å¤©æ•¸
                let months = today.getMonth() - birth.getMonth();
                let days = today.getDate() - birth.getDate();

                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }

                if (months < 0) {
                    months += 12;
                }

                if (months > 0) {
                    const unit = translate('å€‹æœˆ');
                    const joiner = unit !== 'å€‹æœˆ' ? ' ' : '';
                    return `${months}${joiner}${unit}`;
                } else {
                    const unit = translate('å¤©');
                    const joiner = unit !== 'å¤©' ? ' ' : '';
                    return `${days}${joiner}${unit}`;
                }
            }
        }
        
        // ç§»é™¤åŽŸå…ˆä¾è³´å…¨åŸŸ patients é™£åˆ—ç”¢ç”Ÿç—…äººç·¨è™Ÿçš„å‡½å¼ï¼Œä»¥é¿å…ä½¿ç”¨æœªåŒæ­¥çš„æœ¬åœ°è³‡æ–™ã€‚
        // ç›®å‰ç³»çµ±åƒ…é€éŽ generatePatientNumberFromFirebase å–å¾—æ–°ç·¨è™Ÿã€‚


// åˆå§‹åŒ–ä¸­è—¥åº«è³‡æ–™
let herbLibrary = [];

// ä¸­è—¥åº«å­˜è³‡æ–™
let herbInventory = {};
let herbInventoryInitialized = false;
let herbInventoryListenerAttached = false;
// ç›®å‰åº«å­˜æ¨¡å¼ï¼š'granule' è¡¨ç¤ºé¡†ç²’æ²–åŠ‘ï¼Œ'slice' è¡¨ç¤ºé£²ç‰‡ã€‚
// é è¨­å¾ž localStorage è®€å–ï¼Œè‹¥ç„¡å‰‡ç‚º 'granule'ã€‚
let currentInventoryMode = 'granule';
try {
    const savedMode = (typeof localStorage !== 'undefined') ? localStorage.getItem('inventoryMode') : null;
    if (savedMode === 'slice' || savedMode === 'granule') {
        currentInventoryMode = savedMode;
    }
} catch (_e) {
    // å¿½ç•¥è®€å– localStorage çš„éŒ¯èª¤
    currentInventoryMode = 'granule';
}
// è·Ÿè¹¤ç•¶å‰åº«å­˜ç›£è½çš„è³‡æ–™è·¯å¾‘ï¼Œä¾¿æ–¼åœ¨åˆ‡æ›æ¨¡å¼æ™‚å–æ¶ˆç›£è½
let herbInventoryRefPath = null;

//
// ===============================
// ç—…äººåˆ—è¡¨å³æ™‚æ›´æ–°ç›£è½è¨­ç½®
//
// ç‚ºäº†åœ¨å…¶ä»–ä½¿ç”¨è€…æ–°å¢žæˆ–ç·¨è¼¯ç—…äººè³‡æ–™æ™‚èƒ½å³æ™‚åˆ·æ–°åˆ—è¡¨ï¼Œ
// ä½¿ç”¨ Firestore çš„ onSnapshot å»ºç«‹å³æ™‚ç›£è½ã€‚ä¸‹é¢çš„å…©å€‹è®Šæ•¸
// è¿½è¹¤ç›£è½æ˜¯å¦å·²æŽ›è¼‰ä»¥åŠç”¨æ–¼è§£é™¤ç›£è½çš„å‡½å¼ã€‚æŽ›è¼‰ç›£è½å¾Œï¼Œç•¶
// ç›£è½å›žèª¿è§¸ç™¼æ™‚æœƒæ¸…ç©ºç—…äººç›¸é—œçš„æœ¬åœ°å¿«å–ä¸¦é‡æ–°è¼‰å…¥ç—…äººåˆ—è¡¨ã€‚

// æ¨™è¨˜æ˜¯å¦å·²é™„åŠ ç—…äººåˆ—è¡¨ç›£è½
let patientListListenerAttached = false;
// å„²å­˜è§£é™¤ç›£è½çš„å‡½å¼ï¼Œç”± onSnapshot å›žå‚³
let patientListUnsubscribe = null;

/**
 * é™„åŠ ç—…äººåˆ—è¡¨çš„å³æ™‚ç›£è½ã€‚åœ¨ç›£è½å›žèª¿ä¸­æœƒæ¸…é™¤ç—…äººå¿«å–ä¸¦åˆ·æ–°åˆ—è¡¨ã€‚
 * è‹¥ç›£è½å·²å­˜åœ¨å‰‡ä¸æœƒé‡è¤‡é™„åŠ ã€‚ç•¶é›¢é–‹ç—…äººç®¡ç†é é¢æ™‚æ‡‰å‘¼å«
 * detachPatientListListener() ä»¥ç§»é™¤ç›£è½ï¼Œé¿å…ä¸å¿…è¦çš„æµé‡ã€‚
 */
async function attachPatientListListener() {
    try {
        // ç­‰å¾… Firebase åˆå§‹åŒ–
        await waitForFirebaseDb();
        // è‹¥å·²é™„åŠ ç›£è½å‰‡ç›´æŽ¥è¿”å›ž
        if (patientListListenerAttached) return;
        // å»ºç«‹æŸ¥è©¢ï¼šæŒ‰ç…§å»ºç«‹æ™‚é–“ç”±æ–°è‡³èˆŠæŽ’åºï¼Œä»¥èˆ‡åˆ—è¡¨æŽ’åºä¸€è‡´
        const colRef = window.firebase.collection(window.firebase.db, 'patients');
        let q;
        try {
            // ä½¿ç”¨ orderBy æŽ’åºï¼›è‹¥ createdAt ä¸å­˜åœ¨æ–¼æŸäº›æ–‡ä»¶ï¼Œå‰‡å›žå‚³é †åºå¯èƒ½ä¸ä¸€è‡´ã€‚
            q = window.firebase.firestoreQuery(colRef, window.firebase.orderBy('createdAt', 'desc'));
        } catch (_e) {
            // è‹¥ orderBy ç„¡æ³•ä½¿ç”¨ï¼Œç›´æŽ¥ç›£è½æ•´å€‹é›†åˆ
            q = colRef;
        }
        // ä½¿ç”¨ onSnapshot ç›£è½æ–‡ä»¶è®ŠåŒ–
        patientListUnsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
            try {
                // ç›£è½å›žèª¿ï¼šæ¸…é™¤ç—…äººè³‡æ–™ç›¸é—œçš„å¿«å–ï¼Œç¢ºä¿ä¸‹æ¬¡è®€å–ç²å¾—æœ€æ–°è³‡æ–™
                patientCache = null;
                patientPagesCache = {};
                patientPageCursors = {};
                patientsCountCache = null;
                try {
                    // ç§»é™¤æœ¬åœ°å„²å­˜çš„å¿«å–ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡æ–°è¼‰å…¥
                    localStorage.removeItem('patients');
                } catch (_lsErr) {
                    /* å¿½ç•¥ localStorage éŒ¯èª¤ */
                }
                // è‹¥ç•¶å‰ä»åœ¨ç—…äººç®¡ç†é é¢ï¼Œç«‹å³åˆ·æ–°åˆ—è¡¨
                const sectionEl = document.getElementById('patientManagement');
                if (sectionEl && !sectionEl.classList.contains('hidden')) {
                    loadPatientList();
                }
            } catch (innerErr) {
                console.error('ç—…äººè³‡æ–™å³æ™‚æ›´æ–°è™•ç†å¤±æ•—:', innerErr);
            }
        }, (err) => {
            console.error('ç›£è½ç—…äººè³‡æ–™å¤±æ•—:', err);
        });
        patientListListenerAttached = true;
    } catch (outerErr) {
        console.error('é™„åŠ ç—…äººè³‡æ–™ç›£è½å¤±æ•—:', outerErr);
    }
}

/**
 * ç§»é™¤ç—…äººåˆ—è¡¨çš„å³æ™‚ç›£è½ã€‚è‹¥å°šæœªé™„åŠ ç›£è½å‰‡ä¸åŸ·è¡Œä»»ä½•å‹•ä½œã€‚
 */
function detachPatientListListener() {
    if (patientListListenerAttached) {
        try {
            if (typeof patientListUnsubscribe === 'function') {
                patientListUnsubscribe();
            }
        } catch (err) {
            console.error('å–æ¶ˆç—…äººè³‡æ–™ç›£è½å¤±æ•—:', err);
        }
        patientListListenerAttached = false;
        patientListUnsubscribe = null;
    }
}

/**
 * åˆå§‹åŒ–ä¸­è—¥åº«å­˜è³‡æ–™ï¼Œå¾ž Firebase Realtime Database è®€å–ã€‚
 * è‹¥å·²æœ‰è³‡æ–™ä¸”éžå¼·åˆ¶åˆ·æ–°ï¼Œç›´æŽ¥è¿”å›žã€‚
 * æ­¤å‡½å¼äº¦æœƒç›£è½åº«å­˜å¯¦æ™‚æ›´æ–°ä¸¦æ›´æ–°æœ¬åœ°å¿«å–ã€‚
 * @param {boolean} forceRefresh
 */
async function initHerbInventory(forceRefresh = false) {
    // æ ¹æ“šç•¶å‰åº«å­˜æ¨¡å¼æ±ºå®šè®€å–è³‡æ–™çš„è·¯å¾‘ã€‚'granule' å°æ‡‰åŽŸæœ‰é¡†ç²’æ²–åŠ‘è³‡æ–™ï¼Œ
    // 'slice' å°æ‡‰é£²ç‰‡è³‡æ–™ã€‚é è¨­ç‚º 'herbInventory'ã€‚
    const dbPath = (currentInventoryMode === 'slice') ? 'herbInventorySlice' : 'herbInventory';
    // å¦‚æžœä¸æ˜¯å¼·åˆ¶åˆ·æ–°ä¸”å·²åˆå§‹åŒ–éŽï¼Œä¸”ç›£è½å™¨ä»ç„¶å­˜åœ¨ä¸”è·¯å¾‘æœªæ”¹è®Šï¼Œç›´æŽ¥è¿”å›žã€‚
    // è‹¥å·²åˆå§‹åŒ–ä½†ç›£è½å™¨å·²è¢«å–æ¶ˆï¼ˆherbInventoryListenerAttached ç‚º falseï¼‰ï¼Œæˆ–è·¯å¾‘æ”¹è®Šæ™‚ï¼Œä»éœ€é‡æ–°æŽ›è¼‰ç›£è½ã€‚
    if (herbInventoryInitialized && herbInventoryListenerAttached && !forceRefresh && herbInventoryRefPath === dbPath) {
        return;
    }
    // ç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆ
    await waitForFirebaseDb();
    const inventoryRef = window.firebase.ref(window.firebase.rtdb, dbPath);
    // è‹¥ç‚ºå¼·åˆ¶åˆ·æ–°æˆ–è·¯å¾‘æ”¹è®Šä¸”ç›£è½å·²ç¶“æŽ›è¼‰ï¼Œå…ˆå–æ¶ˆèˆŠçš„ç›£è½ä»¥é¿å…å¤šé‡å›žå‘¼
    if ((forceRefresh || herbInventoryRefPath !== dbPath) && herbInventoryListenerAttached && typeof window.herbInventoryRef !== 'undefined' && window.herbInventoryRef) {
        try {
            window.firebase.off(window.herbInventoryRef, 'value');
            herbInventoryListenerAttached = false;
        } catch (err) {
            console.error('é‡ç½®ä¸­è—¥åº«å­˜ç›£è½æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        }
    }
    // æ›´æ–°å…¨åŸŸåƒè€ƒåŠè·¯å¾‘ï¼Œä»¥ä¾¿å¾ŒçºŒå–æ¶ˆç›£è½
    try {
        window.herbInventoryRef = inventoryRef;
    } catch (_e) {
        // è‹¥ç„¡æ³•è¨­ç½®å…¨åŸŸï¼Œå¿½ç•¥
    }
    herbInventoryRefPath = dbPath;
    // è®€å–ç•¶å‰åº«å­˜å¿«ç…§
    try {
        const snapshot = await window.firebase.get(inventoryRef);
        herbInventory = snapshot && snapshot.exists() ? snapshot.val() || {} : {};
        herbInventoryInitialized = true;
    } catch (error) {
        console.error('è®€å–ä¸­è—¥åº«å­˜è³‡æ–™å¤±æ•—:', error);
        herbInventory = {};
        herbInventoryInitialized = true;
    }
    // è‹¥å°šæœªæŽ›è¼‰ç›£è½å™¨ï¼Œæˆ–å› å¼·åˆ¶åˆ·æ–°å–æ¶ˆå¾Œéœ€é‡æ–°æŽ›è¼‰ï¼Œå‰‡è¨»å†Šç›£è½å™¨
    if (!herbInventoryListenerAttached) {
        window.firebase.onValue(inventoryRef, (snap) => {
            herbInventory = snap && snap.exists() ? snap.val() || {} : {};
            // è‹¥æœ‰é¡¯ç¤ºä¸­è—¥åº«ï¼Œæ›´æ–°ç•«é¢
            try {
                if (document.getElementById('herbLibraryList')) {
                    displayHerbLibrary();
                }
                // æ›´æ–°è™•æ–¹é¡¯ç¤ºï¼Œé¡¯ç¤ºåº«å­˜è®ŠåŒ–
                if (typeof updatePrescriptionDisplay === 'function') {
                    updatePrescriptionDisplay();
                }
            } catch (_e) {
                /* å¿½ç•¥ UI æ›´æ–°éŒ¯èª¤ */
            }
        });
        herbInventoryListenerAttached = true;
    }
}

/**
 * å–å¾—æŒ‡å®šä¸­è—¥æˆ–æ–¹åŠ‘çš„åº«å­˜è³‡æ–™ã€‚
 * è‹¥è³‡æ–™ä¸å­˜åœ¨ï¼Œå›žå‚³é è¨­å€¼ 0ã€‚
 * @param {string|number} itemId
 * @returns {{quantity: number, threshold: number}}
 */
function getHerbInventory(itemId) {
    const inv = herbInventory && herbInventory[String(itemId)];
    // å›žå‚³åº«å­˜ã€è­¦æˆ’é‡èˆ‡å–®ä½ï¼Œè‹¥ç„¡è³‡æ–™å‰‡æä¾›é è¨­å€¼
    if (inv && typeof inv === 'object') {
        return {
            quantity: inv.quantity ?? 0,
            threshold: inv.threshold ?? 0,
            unit: inv.unit || 'g',
            // è‹¥ inv.disabled ç‚ºçœŸå‰‡è¡¨ç¤ºæ­¤ä¸­è—¥è¢«åœç”¨
            disabled: !!inv.disabled
        };
    }
    // é è¨­ disabled ç‚º falseï¼Œè¡¨ç¤ºå•Ÿç”¨
    return { quantity: 0, threshold: 0, unit: 'g', disabled: false };
}

/**
 * æ›´æ–°æŒ‡å®šä¸­è—¥æˆ–æ–¹åŠ‘çš„åº«å­˜è³‡æ–™ã€‚
 * åƒ…æ›´æ–°æä¾›çš„æ¬„ä½ï¼Œä¸è¦†è“‹å…¶ä»–æ¬„ä½ã€‚
 * @param {string|number} itemId
 * @param {number} quantity
 * @param {number} threshold
 */
async function setHerbInventory(itemId, quantity, threshold, unit, disabled) {
    await waitForFirebaseDb();
    const data = {};
    if (quantity !== undefined && quantity !== null) {
        data.quantity = Number(quantity);
    }
    if (threshold !== undefined && threshold !== null) {
        data.threshold = Number(threshold);
    }
    if (unit !== undefined && unit !== null) {
        // å„²å­˜ä½¿ç”¨è€…é¸æ“‡çš„å–®ä½ï¼Œä»¥ä¾¿æ—¥å¾Œé¡¯ç¤º
        data.unit = unit;
    }
    // æ–°å¢ž disabled å±¬æ€§ï¼šè‹¥æä¾›æ­¤åƒæ•¸å‰‡æ›´æ–°åœç”¨ç‹€æ…‹
    if (disabled !== undefined && disabled !== null) {
        // ç¢ºä¿ç‚ºå¸ƒæž—å€¼
        data.disabled = !!disabled;
    }
    // æ ¹æ“šç•¶å‰åº«å­˜æ¨¡å¼é¸æ“‡å„²å­˜è·¯å¾‘
    const dbPath = (currentInventoryMode === 'slice') ? 'herbInventorySlice' : 'herbInventory';
    const refPath = window.firebase.ref(window.firebase.rtdb, dbPath + '/' + String(itemId));
    await window.firebase.update(refPath, data);
}

/**
 * åœ¨æ’¤å›žæˆ–ä¿®æ”¹è¨ºç—‡æ™‚ï¼Œé‚„åŽŸåº«å­˜ã€‚
 * è®€å– inventoryLogs/{consultationId} ä¸­è¨˜éŒ„çš„æ¶ˆè€—é‡ï¼Œä¾åºåŠ å›žåº«å­˜ä¸¦åˆªé™¤è©²ç´€éŒ„ã€‚
 * @param {string|number} consultationId
 */
async function revertInventoryForConsultation(consultationId) {
    if (!consultationId) return;
    await waitForFirebaseDb();
    // ç¢ºä¿ä¸­è—¥åº«å­˜è³‡æ–™å·²è¼‰å…¥ã€‚è‹¥å°šæœªåˆå§‹åŒ–ï¼Œæˆ–å› é é¢é‡è¼‰ç­‰åŽŸå› å°Žè‡´æœ¬åœ° herbInventory ç‚ºç©ºï¼Œ
    // å‰‡å‘¼å« initHerbInventory() ä»¥è¼‰å…¥æœ€æ–°åº«å­˜è³‡æ–™ã€‚
    try {
        if (typeof initHerbInventory === 'function') {
            // ä½¿ç”¨éžå¼·åˆ¶åˆ·æ–°ã€‚è‹¥å°šæœªåˆå§‹åŒ–å‰‡æœƒè¼‰å…¥è³‡æ–™ï¼Œè‹¥å·²åˆå§‹åŒ–å‰‡ä¸æœƒé€ æˆå¤šé¤˜è®€å–ã€‚
            await initHerbInventory(false);
        }
    } catch (_initErr) {
        // å¿½ç•¥åˆå§‹åŒ–éŒ¯èª¤ï¼Œå¾ŒçºŒä»å˜—è©¦é‚„åŽŸåº«å­˜
    }
    const logRef = window.firebase.ref(window.firebase.rtdb, 'inventoryLogs/' + String(consultationId));
    try {
        const logSnap = await window.firebase.get(logRef);
        if (logSnap && logSnap.exists()) {
            const log = logSnap.val() || {};
            for (const key in log) {
                const consumption = Number(log[key]) || 0;
                // è®€å–ç•¶å‰åº«å­˜è³‡æ–™ã€‚è‹¥å°šæœªå­˜åœ¨è©²é …ç›®ï¼Œæä¾›é è¨­å€¼ã€‚
                const inv = getHerbInventory(key);
                // å°‡æ¶ˆè€—é‡åŠ å›žåº«å­˜
                const newQty = (inv.quantity || 0) + consumption;
                // ä½¿ç”¨åŽŸå–®ä½æ›´æ–°åº«å­˜ã€‚ç•¶ inv.unit ä¸å­˜åœ¨æ™‚ï¼Œé è¨­ç‚º 'g'
                const unitToUse = inv.unit || 'g';
                const thresholdToUse = typeof inv.threshold === 'number' ? inv.threshold : 0;
                await setHerbInventory(key, newQty, thresholdToUse, unitToUse);
                // åŒæ­¥æ›´æ–°æœ¬åœ°å¿«å–ï¼Œé¿å… UI å»¶é²æˆ–æœªåˆå§‹åŒ–æ™‚è·³éŽæ›´æ–°
                try {
                    if (typeof herbInventory !== 'undefined') {
                        herbInventory[String(key)] = {
                            quantity: newQty,
                            threshold: thresholdToUse,
                            unit: unitToUse
                        };
                    }
                } catch (_e) {
                    /* å¿½ç•¥æœ¬åœ°æ›´æ–°éŒ¯èª¤ */
                }
            }
            // ç§»é™¤æ¶ˆè€—è¨˜éŒ„
            await window.firebase.remove(logRef);
        }
    } catch (err) {
        console.error('é‚„åŽŸè¨ºç—‡åº«å­˜è³‡æ–™å¤±æ•—:', err);
    }
}

/**
 * åœ¨ä¿å­˜è¨ºç—‡å¾Œæ›´æ–°åº«å­˜è³‡æ–™ã€‚
 * è‹¥ç‚ºç·¨è¼¯æ¨¡å¼ï¼Œå°‡å…ˆé‚„åŽŸä¹‹å‰çš„æ¶ˆè€—é‡ï¼Œå†æ‰£é™¤æ–°çš„æ¶ˆè€—é‡ï¼Œä¸¦æ›´æ–° inventoryLogs/{consultationId}ã€‚
 * @param {string|number} consultationId
 * @param {Array} items - selectedPrescriptionItems é™£åˆ—
 * @param {number} days - æœè—¥å¤©æ•¸
 * @param {number} freq - æœè—¥æ¬¡æ•¸
 * @param {boolean} isEditing - æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼
 * @param {Object|null} previousLog - ç·¨è¼¯æ¨¡å¼ä¸‹å…ˆå‰çš„æ¶ˆè€—è¨˜éŒ„ï¼Œå¾ž Realtime Database è®€å–
 */
async function updateInventoryAfterConsultation(consultationId, items, days, freq, isEditing = false, previousLog = null) {
    if (!consultationId || !Array.isArray(items)) return;
    await waitForFirebaseDb();
    // ç¢ºä¿åœ¨é€²è¡Œåº«å­˜è¨ˆç®—ä¹‹å‰è¼‰å…¥æœ€æ–°çš„ä¸­è—¥åº«å­˜è³‡æ–™ã€‚
    // è‹¥ herbInventory å°šæœªåˆå§‹åŒ–ï¼ˆä¾‹å¦‚ä½¿ç”¨è€…ç›´æŽ¥é€²å…¥è¨ºç—‡é é¢å°šæœªæŸ¥çœ‹ä¸­è—¥åº«å­˜ï¼‰ï¼Œ
    // å‰‡ initHerbInventory() æœƒè®€å– Realtime Database ä¸¦å¡«å…… herbInventoryï¼Œé¿å…å–å¾—é è¨­ 0 å€¼è€Œå°Žè‡´è¨ˆç®—éŒ¯èª¤ã€‚
    try {
        if (typeof initHerbInventory === 'function') {
            await initHerbInventory(false);
        }
    } catch (_initErr) {
        // è‹¥åˆå§‹åŒ–å¤±æ•—ï¼Œä»ç¹¼çºŒåŸ·è¡Œï¼Œåƒ…ä½¿ç”¨ç•¶å‰æœ¬åœ° herbInventory è³‡æ–™
    }
    // é‚„åŽŸèˆŠçš„æ¶ˆè€—é‡
    if (isEditing && previousLog) {
        for (const key in previousLog) {
            const consumption = Number(previousLog[key]) || 0;
            const inv = getHerbInventory(key);
            const newQty = (inv.quantity || 0) + consumption;
            // ä½¿ç”¨åŽŸå–®ä½é‚„åŽŸåº«å­˜
            await setHerbInventory(key, newQty, inv.threshold, inv.unit);
            // å³æ™‚æ›´æ–°æœ¬åœ°å¿«å–ï¼Œé¿å… UI å»¶é²æ›´æ–°
            try {
                if (typeof herbInventory !== 'undefined') {
                    herbInventory[String(key)] = {
                        quantity: newQty,
                        threshold: inv.threshold,
                        unit: inv.unit
                    };
                }
            } catch (_e) {
                /* å¿½ç•¥æœ¬åœ°æ›´æ–°éŒ¯èª¤ */
            }
        }
    }
    const log = {};
    for (const item of items) {
        if (!item || !item.id) continue;
        const dosageStr = item.customDosage || item.dosage || '';
        const dosage = parseFloat(dosageStr);
        if (isNaN(dosage) || dosage <= 0) continue;
        const consumption = dosage * days * freq;
        const inv = getHerbInventory(item.id);
        const newQty = (inv.quantity || 0) - consumption;
        await setHerbInventory(item.id, newQty, inv.threshold, inv.unit);
        // å³æ™‚æ›´æ–°æœ¬åœ°å¿«å–
        try {
            if (typeof herbInventory !== 'undefined') {
                herbInventory[String(item.id)] = {
                    quantity: newQty,
                    threshold: inv.threshold,
                    unit: inv.unit
                };
            }
        } catch (_e) {
            /* å¿½ç•¥æœ¬åœ°æ›´æ–°éŒ¯èª¤ */
        }
        log[String(item.id)] = consumption;
    }
    // å°‡æ–°çš„æ¶ˆè€—é‡è¨˜éŒ„åˆ° inventoryLogs
    await window.firebase.set(window.firebase.ref(window.firebase.rtdb, 'inventoryLogs/' + String(consultationId)), log);
    // ä¿å­˜å¾Œç«‹å³æ›´æ–°è™•æ–¹é¡¯ç¤ºï¼Œä»¥ä¾¿å‘ˆç¾æœ€æ–°åº«å­˜
    try {
        if (typeof updatePrescriptionDisplay === 'function') {
            updatePrescriptionDisplay();
        }
    } catch (_e) {
        /* å¿½ç•¥ UI æ›´æ–°éŒ¯èª¤ */
    }
}

// ç”¨æ–¼è¿½è¹¤æ­£åœ¨ç·¨è¼¯åº«å­˜çš„é …ç›® ID
let currentInventoryItemId = null;

/**
 * é–‹å•Ÿåº«å­˜ç·¨è¼¯å½ˆçª—ï¼Œå¡«å…¥ç•¶å‰åº«å­˜èˆ‡è­¦æˆ’å€¼ã€‚
 * æœƒè¨˜éŒ„æ­£åœ¨ç·¨è¼¯çš„é …ç›® IDï¼Œä»¥ä¾¿ä¿å­˜æ™‚æ›´æ–°ã€‚
 * @param {string|number} itemId è¦ç·¨è¼¯çš„ä¸­è—¥æˆ–æ–¹åŠ‘ ID
 */
async function openInventoryModal(itemId) {
    try {
        currentInventoryItemId = itemId;
        // åˆå§‹åŒ–åº«å­˜è³‡æ–™ï¼ˆè‹¥å°šæœªåˆå§‹åŒ–ï¼‰
        if (typeof initHerbInventory === 'function' && !herbInventoryInitialized) {
            try { await initHerbInventory(); } catch (_e) {}
        }
        const modal = document.getElementById('inventoryModal');
        const qtyInput = document.getElementById('inventoryQuantity');
        const thrInput = document.getElementById('inventoryThreshold');
        /**
         * åœ¨åº«å­˜ç·¨è¼¯å½ˆçª—ä¸­ï¼Œç•¶ä½¿ç”¨è€…æ–¼ã€Œå‰©é¤˜æ•¸é‡ã€æ¬„ä½æŒ‰ä¸‹ Enter éµæ™‚ï¼Œç›´æŽ¥è§¸ç™¼å„²å­˜å‹•ä½œã€‚
         * é€™è£¡æœƒç‚ºè¼¸å…¥æ¡†å‹•æ…‹æŽ›è¼‰éµç›¤äº‹ä»¶è™•ç†å™¨ï¼Œä¸¦æ–¼é‡è¤‡é–‹å•Ÿå½ˆçª—æ™‚å…ˆç§»é™¤èˆŠçš„è™•ç†å™¨ï¼Œé¿å…é‡è¤‡ç¶å®šã€‚
         * å„²å­˜é‚è¼¯å„ªå…ˆé€éŽé»žæ“Šå½ˆçª—å…§çš„å„²å­˜æŒ‰éˆ•ï¼Œä»¥ä¿æŒèˆ‡å…¶ä»–æ“ä½œä¸€è‡´ï¼›è‹¥æ‰¾ä¸åˆ°æŒ‰éˆ•å‰‡ç›´æŽ¥å‘¼å«
         * saveInventoryChanges()ã€‚
         */
        try {
            // ç¶å®šã€Œå‰©é¤˜æ•¸é‡ã€æ¬„ä½çš„ Enter éµå„²å­˜äº‹ä»¶
            if (qtyInput) {
                // ç§»é™¤å…ˆå‰çš„äº‹ä»¶è™•ç†å™¨ï¼Œé¿å…é‡è¤‡è§¸ç™¼
                if (qtyInput._enterSaveHandler) {
                    qtyInput.removeEventListener('keypress', qtyInput._enterSaveHandler);
                }
                // å®šç¾©æ–°çš„äº‹ä»¶è™•ç†å™¨
                qtyInput._enterSaveHandler = function (ev) {
                    if (ev && ev.key === 'Enter') {
                        ev.preventDefault();
                        try {
                            // å°‹æ‰¾åº«å­˜å½ˆçª—å…§è² è²¬å„²å­˜çš„æŒ‰éˆ•ã€‚ä½¿ç”¨åŒ…å« saveInventoryChanges çš„ onclick ä¾†åŒ¹é…
                            const saveBtn = modal ? modal.querySelector('button[onclick*="saveInventoryChanges"]') : null;
                            if (saveBtn && typeof saveBtn.click === 'function') {
                                saveBtn.click();
                                return;
                            }
                        } catch (_e) {
                            // æ‰¾ä¸åˆ°æŒ‰éˆ•æ™‚å¿½ç•¥ï¼Œæ”¹ä»¥ç›´æŽ¥å‘¼å«å„²å­˜å‡½å¼
                        }
                        // Fallbackï¼šç›´æŽ¥å‘¼å« saveInventoryChanges
                        try {
                            if (typeof saveInventoryChanges === 'function') {
                                saveInventoryChanges();
                            }
                        } catch (_e) {
                            // å¦‚æžœèª¿ç”¨å¤±æ•—ï¼Œåƒ…è¨˜éŒ„éŒ¯èª¤
                            console.error('Enter éµè§¸ç™¼åº«å­˜å„²å­˜å¤±æ•—:', _e);
                        }
                    }
                };
                // ç¶å®šæ–°çš„è™•ç†å™¨
                qtyInput.addEventListener('keypress', qtyInput._enterSaveHandler);
            }
            // æ–°å¢žï¼šç‚ºã€Œè£œè²¨è­¦æˆ’é‡ã€(è­¦æˆ’å€¼)æ¬„ä½ç¶å®š Enter éµäº‹ä»¶ï¼Œèˆ‡å‰©é¤˜æ•¸é‡æ¬„ä½ç›¸åŒé‚è¼¯
            if (thrInput) {
                // ç§»é™¤å…ˆå‰çš„äº‹ä»¶è™•ç†å™¨ï¼Œé¿å…é‡è¤‡è§¸ç™¼
                if (thrInput._enterSaveHandler) {
                    thrInput.removeEventListener('keypress', thrInput._enterSaveHandler);
                }
                thrInput._enterSaveHandler = function (ev) {
                    if (ev && ev.key === 'Enter') {
                        ev.preventDefault();
                        try {
                            const saveBtn = modal ? modal.querySelector('button[onclick*="saveInventoryChanges"]') : null;
                            if (saveBtn && typeof saveBtn.click === 'function') {
                                saveBtn.click();
                                return;
                            }
                        } catch (_e) {
                            /* ignore */
                        }
                        try {
                            if (typeof saveInventoryChanges === 'function') {
                                saveInventoryChanges();
                            }
                        } catch (_e) {
                            console.error('Enter éµè§¸ç™¼åº«å­˜å„²å­˜å¤±æ•—:', _e);
                        }
                    }
                };
                thrInput.addEventListener('keypress', thrInput._enterSaveHandler);
            }
        } catch (_e) {
            // è‹¥ç¶å®šäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œåƒ…è¨˜éŒ„ä½†ä¸æœƒé˜»æ–·å½ˆçª—é–‹å•Ÿ
            console.error('ç¶å®šåº«å­˜æ•¸é‡æˆ–è­¦æˆ’é‡è¼¸å…¥ Enter éµäº‹ä»¶å¤±æ•—:', _e);
        }
        const titleEl = document.getElementById('inventoryModalTitle');
        // è¨­å®šå½ˆçª—æ¨™é¡ŒåŒ…å«è—¥æåç¨±
        let nameStr = '';
        try {
            const item = Array.isArray(herbLibrary) ? herbLibrary.find(h => h && String(h.id) === String(itemId)) : null;
            if (item && item.name) {
                nameStr = String(item.name);
            }
        } catch (_e) {}
        if (titleEl) {
            // Use translation function for the base title.  When nameStr exists,
            // prefix the translated base title to ensure proper language switching.
            const baseTitle = (typeof window.t === 'function') ? window.t('ç·¨è¼¯åº«å­˜') : 'ç·¨è¼¯åº«å­˜';
            titleEl.textContent = nameStr ? `${baseTitle} - ${nameStr}` : baseTitle;
        }
        // å–å¾—ç¾æœ‰åº«å­˜è³‡æ–™
        let inv = { quantity: 0, threshold: 0 };
        try {
            if (typeof getHerbInventory === 'function') {
                inv = getHerbInventory(itemId);
            }
        } catch (_e) {
            inv = { quantity: 0, threshold: 0 };
        }
        if (qtyInput || thrInput) {
            // æ ¹æ“šå„²å­˜çš„å–®ä½å°‡åº«å­˜èˆ‡è­¦æˆ’é‡æ›ç®—æˆç›¸åŒå–®ä½é¡¯ç¤º
            const unit = inv.unit || 'g';
            const factor = UNIT_FACTOR_MAP[unit] || 1;
            if (qtyInput) {
                qtyInput.value = ((inv.quantity ?? 0) / factor).toString();
            }
            if (thrInput) {
                thrInput.value = ((inv.threshold ?? 0) / factor).toString();
            }
            // è¨­å®šå–®ä½é¸æ“‡å™¨çš„å€¼
            try {
                const qtyUnitSel = document.getElementById('inventoryQuantityUnit');
                if (qtyUnitSel) {
                    // è¨­å®šå–®ä½é¸æ“‡å™¨çš„å€¼
                    qtyUnitSel.value = unit;
                    // æ›´æ–° prevUnit å±¬æ€§ä»¥ä¾¿å¾ŒçºŒæ›ç®—ä½¿ç”¨
                    qtyUnitSel.dataset.prevUnit = unit;

                    /**
                     * ç¢ºä¿åœ¨åº«å­˜ç·¨è¼¯å½ˆçª—é–‹å•Ÿæ™‚ç¶å®šå–®ä½è®Šæ›´äº‹ä»¶ã€‚åŽŸæœ¬çš„å–®ä½è®Šæ›´ç›£è½å™¨åƒ…åœ¨ DOMContentLoaded
                     * è§¸ç™¼æ™‚è¨»å†Šï¼Œç”±æ–¼ system.js å¯èƒ½åœ¨ DOMContentLoaded ä¹‹å¾Œè¼‰å…¥ï¼Œå°Žè‡´è©²ç›£è½å™¨ä¸æœƒåŸ·è¡Œï¼Œ
                     * é€ æˆåˆ‡æ›å–®ä½æ™‚æ•¸é‡èˆ‡è­¦æˆ’é‡æœªè‡ªå‹•æ›ç®—ã€‚ç‚ºäº†è§£æ±ºæ­¤å•é¡Œï¼Œæˆ‘å€‘åœ¨é–‹å•Ÿå½ˆçª—æ™‚å‹•æ…‹ç¶å®š
                     * change äº‹ä»¶ï¼Œä¸¦åœ¨é‡è¤‡é–‹å•Ÿå½ˆçª—æ™‚ç§»é™¤èˆŠçš„ç›£è½å™¨ä»¥é¿å…é‡è¤‡ç¶å®šã€‚
                     */
                    try {
                        // ç§»é™¤å…ˆå‰çš„ç›£è½å™¨ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œé¿å…é‡è¤‡è§¸ç™¼
                        if (qtyUnitSel._unitChangeHandler) {
                            qtyUnitSel.removeEventListener('change', qtyUnitSel._unitChangeHandler);
                        }
                        // å®šç¾©æ–°çš„è®Šæ›´è™•ç†å‡½å¼
                        qtyUnitSel._unitChangeHandler = function (e) {
                            const selectEl = e && e.target ? e.target : qtyUnitSel;
                            const newUnitVal = selectEl.value || 'g';
                            const prevUnitVal = selectEl.dataset.prevUnit || 'g';
                            // è‹¥æœªæ”¹è®Šå‰‡ä¸è™•ç†
                            if (newUnitVal === prevUnitVal) {
                                return;
                            }
                            const prevFactor = UNIT_FACTOR_MAP[prevUnitVal] || 1;
                            const newFactorVal = UNIT_FACTOR_MAP[newUnitVal] || 1;
                            // æ›ç®—å‰©é¤˜æ•¸é‡
                            if (qtyInput) {
                                const qValRaw = parseFloat(qtyInput.value);
                                if (!isNaN(qValRaw)) {
                                    const grams = qValRaw * prevFactor;
                                    const convertedQty = grams / newFactorVal;
                                    // å››æ¨äº”å…¥åˆ°å°æ•¸é»žåŽä¸‰ä½ï¼Œé¿å…ç²¾åº¦éŽé•·
                                    qtyInput.value = (Math.round(convertedQty * 1000) / 1000).toString();
                                }
                            }
                            // æ›ç®—è£œè²¨è­¦æˆ’é‡
                            if (thrInput) {
                                const thrValRaw = parseFloat(thrInput.value);
                                if (!isNaN(thrValRaw)) {
                                    const grams = thrValRaw * prevFactor;
                                    const convertedThr = grams / newFactorVal;
                                    thrInput.value = (Math.round(convertedThr * 1000) / 1000).toString();
                                }
                            }
                            // æ›´æ–°ä¸Šä¸€æ¬¡é¸æ“‡çš„å–®ä½
                            selectEl.dataset.prevUnit = newUnitVal;
                        };
                        // ç¶å®šæ–°çš„ç›£è½å™¨
                        qtyUnitSel.addEventListener('change', qtyUnitSel._unitChangeHandler);
                    } catch (_e) {
                        // ç›£è½å™¨ç¶å®šå¤±æ•—å‰‡è¨˜éŒ„éŒ¯èª¤ä½†ä¸é˜»æ–·æµç¨‹
                        console.error('ç¶å®šåº«å­˜å–®ä½è®Šæ›´ç›£è½å™¨å¤±æ•—:', _e);
                    }
                }
            } catch (_e) {}
            // è¨­å®šå•Ÿç”¨/åœç”¨ä¸‹æ‹‰é¸æ“‡çš„å€¼
            try {
                const disSel = document.getElementById('inventoryDisabled');
                if (disSel) {
                    // inv.disabled ç‚º true æ™‚å°‡ä¸‹æ‹‰è¨­ç‚º 'true' è¡¨ç¤ºåœç”¨ï¼Œå¦å‰‡ç‚º 'false' è¡¨ç¤ºå•Ÿç”¨
                    disSel.value = inv && inv.disabled ? 'true' : 'false';
                }
            } catch (_e) {
                /* å¿½ç•¥éŒ¯èª¤ */
            }
        }
        if (modal) {
            modal.classList.remove('hidden');
        }
    } catch (err) {
        console.error('é–‹å•Ÿåº«å­˜ç·¨è¼¯å½ˆçª—éŒ¯èª¤:', err);
    }
}

/**
 * éš±è—åº«å­˜ç·¨è¼¯å½ˆçª—ã€‚
 */
function hideInventoryModal() {
    const modal = document.getElementById('inventoryModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

/**
 * ä¿å­˜åº«å­˜è®Šæ›´åˆ° Firebase Realtime Databaseã€‚
 * æœƒæ›´æ–°å°æ‡‰ç‰©ä»¶åœ¨ herbLibrary çš„ stock/threshold æ¬„ä½ï¼Œä»¥ä¿æŒä¸€è‡´ã€‚
 */
async function saveInventoryChanges() {
    // å–å¾—ç•¶å‰è§¸ç™¼æ­¤æ“ä½œçš„æŒ‰éˆ•ï¼Œé¡¯ç¤ºè®€å–åœˆä»¥é˜²é‡è¤‡æäº¤
    const saveBtn = getLoadingButtonFromEvent('button[onclick="saveInventoryChanges()"]');
    setButtonLoading(saveBtn);
    try {
        const qtyInput = document.getElementById('inventoryQuantity');
        const thrInput = document.getElementById('inventoryThreshold');
        const qVal = qtyInput ? parseFloat(qtyInput.value) : NaN;
        const tVal = thrInput ? parseFloat(thrInput.value) : NaN;
        // è®€å–å–®ä½é¸æ“‡ï¼Œé è¨­ç‚ºå…‹
        const qtyUnitSelect = document.getElementById('inventoryQuantityUnit');
        const qtyUnit = qtyUnitSelect ? qtyUnitSelect.value : 'g';
        // ä½¿ç”¨å…¨åŸŸçš„å–®ä½è½‰æ›è¡¨å°‡è¼¸å…¥é‡è½‰æ›ç‚ºåŸºæº–å…‹ (g)
        const factor = UNIT_FACTOR_MAP[qtyUnit] || 1;
        let quantity = isNaN(qVal) ? 0 : qVal;
        let threshold = isNaN(tVal) ? 0 : tVal;
        const quantityBase = quantity * factor;
        const thresholdBase = threshold * factor;
        const id = currentInventoryItemId;
        // è®€å–å•Ÿç”¨/åœç”¨ç‹€æ…‹
        let disabledVal = false;
        try {
            const disSel = document.getElementById('inventoryDisabled');
            if (disSel) {
                disabledVal = (disSel.value === 'true');
            }
        } catch (_e) {
            disabledVal = false;
        }
        // æ›´æ–° Realtime Databaseï¼ŒåŒ…å«æ‰€é¸å–®ä½èˆ‡åœç”¨ç‹€æ…‹
        if (typeof setHerbInventory === 'function') {
            await setHerbInventory(id, quantityBase, thresholdBase, qtyUnit, disabledVal);
        }
        // æ›´æ–°æœ¬åœ° herbLibrary çš„é è¨­åº«å­˜èˆ‡å–®ä½ï¼ˆè‹¥å­˜åœ¨ï¼‰
        try {
            if (Array.isArray(herbLibrary)) {
                const idx = herbLibrary.findIndex(h => h && String(h.id) === String(id));
                if (idx >= 0 && herbLibrary[idx]) {
                    herbLibrary[idx].stock = quantityBase;
                    herbLibrary[idx].threshold = thresholdBase;
                    herbLibrary[idx].unit = qtyUnit;
                }
            }
        } catch (_e) {}
        // æç¤ºæˆåŠŸè¨Šæ¯
        showToast('åº«å­˜å·²æ›´æ–°ï¼', 'success');
        // éš±è—å½ˆçª—
        hideInventoryModal();
        // ä¸éœ€å¼·åˆ¶åˆ·æ–°åº«å­˜ï¼Œä¾è³´ Realtime Database çš„ onValue ç›£è½è‡ªå‹•æ›´æ–°ï¼Œä»¥æ¸›å°‘è³‡æ–™åº«è®€å–
        // æ›´æ–°ä¸­è—¥åº«èˆ‡è™•æ–¹é¡¯ç¤º
        try {
            if (typeof displayHerbLibrary === 'function') {
                displayHerbLibrary();
            }
        } catch (_e) {}
        try {
            if (typeof updatePrescriptionDisplay === 'function') {
                updatePrescriptionDisplay();
            }
        } catch (_e) {}
    } catch (err) {
            console.error('ä¿å­˜åº«å­˜è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
            showToast('ä¿å­˜åº«å­˜è®Šæ›´å¤±æ•—ï¼', 'error');
        } finally {
            // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            clearButtonLoading(saveBtn);
        }
    }
        // æ‰¹é‡å…¥åº«åŠŸèƒ½å‡½å¼
        function openBatchInventoryModal() {
            try {
                // ç¢ºä¿ä¸­è—¥åº«è³‡æ–™å·²è¼‰å…¥å¾Œå†é–‹å•Ÿå½ˆçª—
                if (typeof initHerbLibrary === 'function' && !herbLibraryLoaded) {
                    initHerbLibrary().then(() => {
                        _openBatchModalInner();
                    });
                } else {
                    _openBatchModalInner();
                }
            } catch (e) {
                console.error('openBatchInventoryModal error:', e);
            }
        }

        function _openBatchModalInner() {
            const modal = document.getElementById('batchInventoryModal');
            if (!modal) return;
            // æ¸…ç©ºæ—¢æœ‰çš„è¡Œ
            const rowsContainer = document.getElementById('batchRows');
            if (rowsContainer) rowsContainer.innerHTML = '';
            // é è¨­æ·»åŠ ä¸€è¡Œ
            addBatchRow();
            // æ ¹æ“šèªžè¨€æ›´æ–°å½ˆçª—æ–‡å­—èˆ‡æŒ‰éˆ•
            try {
                const title = document.getElementById('batchInventoryModalTitle');
                if (title && typeof window.t === 'function') {
                    title.textContent = window.t('æ‰¹é‡å…¥åº«');
                }
                const addButton = modal.querySelector('button[onclick="addBatchRow()"]');
                if (addButton && typeof window.t === 'function') {
                    addButton.textContent = '+ ' + window.t('æ–°å¢žè—¥æ');
                }
                const cancelBtn = modal.querySelector('button[onclick="hideBatchInventoryModal()"]');
                if (cancelBtn && typeof window.t === 'function') {
                    cancelBtn.textContent = window.t('å–æ¶ˆ');
                }
                const saveBtn = modal.querySelector('button[onclick="saveBatchInventory()"]');
                if (saveBtn && typeof window.t === 'function') {
                    saveBtn.textContent = window.t('å„²å­˜');
                }
                const btnLabel = document.getElementById('batchInventoryBtnText');
                if (btnLabel && typeof window.t === 'function') {
                    btnLabel.textContent = window.t('æ‰¹é‡å…¥åº«');
                }
                // é¡¯ç¤ºç•¶å‰åº«å­˜é¡žåž‹æ–¼æ‰¹é‡å…¥åº«å½ˆçª—æ¨™é¡Œå³å´
                const typeDisplay = document.getElementById('batchInventoryTypeDisplay');
                if (typeDisplay) {
                    const mode = (currentInventoryMode === 'slice') ? 'slice' : 'granule';
                    let label = mode === 'slice' ? 'é£²ç‰‡' : 'é¡†ç²’æ²–åŠ‘';
                    // ä½¿ç”¨ç¿»è­¯å‡½å¼è½‰æ›åº«å­˜é¡žåž‹æ–‡å­—
                    if (typeof window.t === 'function') {
                        label = window.t(label);
                    }
                    typeDisplay.textContent = label;
                }
            } catch (_e) {
                /* å¿½ç•¥ç¿»è­¯éŒ¯èª¤ */
            }
            modal.classList.remove('hidden');
        }

        function hideBatchInventoryModal() {
            const modal = document.getElementById('batchInventoryModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function addBatchRow() {
            const rowsContainer = document.getElementById('batchRows');
            if (!rowsContainer) return;
            // è¡Œå®¹å™¨ã€‚æ–°å¢žè‡ªè¨‚é¡žåˆ¥ 'batch-row' ä»¥åˆ©å¾ŒçºŒé©—è­‰é¸æ“‡æ­£ç¢ºçš„è¡Œã€‚
            const row = document.createElement('div');
            row.className = 'batch-row flex flex-wrap items-center gap-2';
            // æœå°‹ä¸­è—¥è¼¸å…¥æ¡†åŠå»ºè­°æ¸…å–®
            const searchContainer = document.createElement('div');
            // flex-1 ä»¥ä¾¿èˆ‡å…¶ä»–æ¬„ä½å‡åˆ†å¯¬åº¦
            searchContainer.className = 'relative flex-1';
            // åˆå§‹æ™‚å»ºç«‹è¼¸å…¥æ¡†è®“ä½¿ç”¨è€…è¼¸å…¥æœå°‹
            const herbInput = document.createElement('input');
            herbInput.type = 'text';
            herbInput.className = 'batch-herb-input border border-gray-300 rounded px-2 py-1 w-full';
            herbInput.placeholder = (typeof window.t === 'function') ? (window.t('æœå°‹è—¥ææˆ–æ–¹åŠ‘') || 'æœå°‹è—¥ææˆ–æ–¹åŠ‘') : 'æœå°‹è—¥ææˆ–æ–¹åŠ‘';
            // å»ºè­°åˆ—è¡¨å®¹å™¨ï¼Œé€éŽçµ•å°å®šä½é¡¯ç¤ºåœ¨è¼¸å…¥æ¡†ä¸‹æ–¹
            const suggestionList = document.createElement('div');
            suggestionList.className = 'absolute z-10 mt-1 max-h-60 overflow-y-auto bg-white border border-gray-300 rounded w-full hidden';
            // è¡Œè³‡æ–™è¨­å®š herbId é»˜èªç‚ºç©º
            row.dataset.herbId = '';
            // ç”¨æ–¼æ­¤è¡Œæœå°‹çµæžœçš„éµç›¤é¸æ“‡ç´¢å¼•
            let suggestionIndex = -1;
            // æ›´æ–°å»ºè­°åˆ—è¡¨çš„å‡½å¼
            function updateSuggestions() {
                // é‡ç½®é¸æ“‡ç´¢å¼•
                suggestionIndex = -1;
                const query = herbInput.value.trim().toLowerCase();
                suggestionList.innerHTML = '';
                if (!query) {
                    suggestionList.classList.add('hidden');
                    row.dataset.herbId = '';
                    return;
                }
                const matches = [];
                if (Array.isArray(herbLibrary)) {
                    for (const h of herbLibrary) {
                        let name = h.name || '';
                        let englishName = h.englishName || '';
                        let searchTarget = name;
                        // æ ¹æ“šèªžè¨€é¸æ“‡æ¯”è¼ƒåç¨±æˆ–è‹±æ–‡åç¨±
                        try {
                            const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                            if (langSel && langSel.toLowerCase().startsWith('en') && englishName) {
                                searchTarget = englishName;
                            }
                        } catch (_e) {}
                        // æ¯”å°è¼¸å…¥å­—ä¸²
                        const lowerSearchTarget = searchTarget.toLowerCase();
                        const lowerEnglishName = englishName.toLowerCase();
                        if (lowerSearchTarget.includes(query) || lowerEnglishName.includes(query)) {
                            // éŽæ¿¾å·²åœç”¨çš„ä¸­è—¥åº«å­˜ï¼šåƒ…é¡¯ç¤ºç•¶å‰åº«å­˜é¡žåž‹ä¸­å•Ÿç”¨çš„é …ç›®
                            let disabled = false;
                            try {
                                if (typeof getHerbInventory === 'function') {
                                    const invInfo = getHerbInventory(h.id);
                                    if (invInfo && invInfo.disabled) {
                                        disabled = true;
                                    }
                                }
                            } catch (_e) {
                                // è‹¥ç„¡æ³•å–å¾—åº«å­˜è³‡è¨Šï¼Œè¦–ç‚ºå•Ÿç”¨
                                disabled = false;
                            }
                            // è‹¥æœªè¢«åœç”¨ï¼ŒåŠ å…¥åŒ¹é…é™£åˆ—
                            if (!disabled) {
                                matches.push(h);
                                if (matches.length >= 10) break;
                            }
                        }
                    }
                }
                if (matches.length === 0) {
                    suggestionList.classList.add('hidden');
                    return;
                }
                matches.forEach(h => {
                    const item = document.createElement('div');
                    item.className = 'px-2 py-1 cursor-pointer hover:bg-gray-100';
                    let displayName = h.name;
                    try {
                        const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                        if (langSel && langSel.toLowerCase().startsWith('en') && h.englishName) {
                            displayName = h.englishName;
                        }
                    } catch (_e) {}
                    item.textContent = displayName;
                    item.addEventListener('click', () => {
                        // é¸å®šå»ºè­°å¾Œï¼Œè¨˜éŒ„ id ä¸¦ç”¨æ–‡å­—æ¨™ç±¤å–ä»£è¼¸å…¥æ¡†
                        row.dataset.herbId = h.id;
                        suggestionList.classList.add('hidden');
                        // å»ºç«‹ span é¡¯ç¤ºè—¥å
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'batch-herb-name px-2 py-1 w-full';
                        nameSpan.textContent = displayName;
                        // æ¸…é™¤ searchContainer å…§å®¹ï¼Œæ’å…¥æ¨™ç±¤
                        searchContainer.innerHTML = '';
                        searchContainer.appendChild(nameSpan);
                        // æ ¹æ“šè—¥æåº«å­˜è¨­å®šé¡¯ç¤ºå–®ä½ï¼Œä¸¦å°‡å–®ä½å­˜æ–¼è¡Œçš„è³‡æ–™é›†
                        try {
                            // å–å¾—è—¥æå–®ä½ï¼Œé è¨­ç‚º g
                            let herbUnit = 'g';
                            if (typeof getHerbInventory === 'function') {
                                const invInfo = getHerbInventory(h.id);
                                if (invInfo && invInfo.unit) {
                                    herbUnit = invInfo.unit;
                                }
                            }
                            // å­˜æ”¾å–®ä½æ–¼ datasetï¼Œä»¥ä¾¿å„²å­˜æ™‚ä½¿ç”¨
                            row.dataset.herbUnit = herbUnit;
                            // æ›´æ–°é¡¯ç¤ºå–®ä½æ–‡å­—
                            const unitDisplay = row.querySelector('span.batch-herb-unit');
                            if (unitDisplay) {
                                let label = (typeof UNIT_LABEL_MAP !== 'undefined' && UNIT_LABEL_MAP && UNIT_LABEL_MAP[herbUnit]) ? UNIT_LABEL_MAP[herbUnit] : herbUnit;
                                // ä½¿ç”¨ç¿»è­¯å‡½å¼è½‰æ›å–®ä½æ–‡å­—
                                label = (typeof window.t === 'function') ? window.t(label) : label;
                                unitDisplay.textContent = label;
                                // æ›´æ–°æ¨£å¼ï¼šç§»é™¤é è¨­æ·¡è‰²æ–‡å­—èˆ‡é€æ˜Žé‚Šæ¡†ï¼Œæ”¹ç‚ºæ­£å¸¸è‰²èˆ‡å¯¦éš›é‚Šæ¡†èˆ‡èƒŒæ™¯
                                try {
                                    unitDisplay.classList.remove('text-gray-400');
                                    unitDisplay.classList.add('text-gray-600');
                                    // è®Šæ›´é‚Šæ¡†ç‚ºå¯¦ç·šé¡è‰²ã€åŠ ä¸Šåœ“è§’å’Œæ·¡èƒŒæ™¯
                                    unitDisplay.classList.remove('border-transparent');
                                    unitDisplay.classList.add('border-gray-300');
                                    // è‹¥ä¹‹å‰æ²’æœ‰åœ“è§’ï¼Œæ–°å¢žåœ“è§’æ¨£å¼
                                    unitDisplay.classList.add('rounded');
                                    // åŠ å…¥æ·¡ç°èƒŒæ™¯ä»¥åˆ©è¾¨è­˜
                                    unitDisplay.classList.remove('bg-transparent');
                                    unitDisplay.classList.add('bg-gray-50');
                                } catch (_e) {
                                    /* å¿½ç•¥éŒ¯èª¤ */
                                }
                            }
                        } catch (_err) {
                            // å¿½ç•¥éŒ¯èª¤
                        }
                    });
                    suggestionList.appendChild(item);
                });
                suggestionList.classList.remove('hidden');
            }
            herbInput.addEventListener('input', updateSuggestions);
            herbInput.addEventListener('focus', updateSuggestions);
            // éµç›¤äº‹ä»¶è™•ç†ï¼šæ”¯æ´æ–¹å‘éµé¸æ“‡èˆ‡ Enter é¸å–å»ºè­°
            herbInput.addEventListener('keydown', function(ev) {
                const key = ev && ev.key;
                if (!key || !(['ArrowUp', 'ArrowDown', 'Enter'].includes(key))) {
                    return;
                }
                // åƒ…åœ¨å»ºè­°åˆ—è¡¨é¡¯ç¤ºæ™‚è™•ç†
                if (suggestionList.classList.contains('hidden')) {
                    return;
                }
                const items = Array.from(suggestionList.children);
                if (!items || items.length === 0) {
                    return;
                }
                if (key === 'ArrowDown') {
                    ev.preventDefault();
                    suggestionIndex = (suggestionIndex + 1) % items.length;
                    items.forEach((el, idx) => {
                        if (idx === suggestionIndex) {
                            el.classList.add('bg-gray-200');
                        } else {
                            el.classList.remove('bg-gray-200');
                        }
                    });
                    const currentEl = items[suggestionIndex];
                    if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                        currentEl.scrollIntoView({ block: 'nearest' });
                    }
                } else if (key === 'ArrowUp') {
                    ev.preventDefault();
                    suggestionIndex = (suggestionIndex - 1 + items.length) % items.length;
                    items.forEach((el, idx) => {
                        if (idx === suggestionIndex) {
                            el.classList.add('bg-gray-200');
                        } else {
                            el.classList.remove('bg-gray-200');
                        }
                    });
                    const currentEl = items[suggestionIndex];
                    if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                        currentEl.scrollIntoView({ block: 'nearest' });
                    }
                } else if (key === 'Enter') {
                    if (suggestionIndex >= 0 && suggestionIndex < items.length) {
                        ev.preventDefault();
                        const selectedEl = items[suggestionIndex];
                        if (selectedEl && typeof selectedEl.click === 'function') {
                            selectedEl.click();
                        }
                    }
                }
            });
            document.addEventListener('click', function(ev) {
                if (!searchContainer.contains(ev.target)) {
                    suggestionList.classList.add('hidden');
                }
            });
            searchContainer.appendChild(herbInput);
            searchContainer.appendChild(suggestionList);
            row.appendChild(searchContainer);
            // æ•¸é‡è¼¸å…¥æ¡†
            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = '0';
            qtyInput.step = '0.5';
            qtyInput.placeholder = (typeof window.t === 'function') ? window.t('æ•¸é‡') : 'æ•¸é‡';
            qtyInput.className = 'batch-herb-qty w-24 border border-gray-300 rounded px-2 py-1';
            row.appendChild(qtyInput);
            // é¡¯ç¤ºå–®ä½ï¼šä¾è—¥æè¨­å®šé¡¯ç¤ºå–®ä½æ¨™ç±¤ï¼Œä¸å¯ä¿®æ”¹
            const unitDisplay = document.createElement('span');
            /*
             * é è¨­åƒ…é¡¯ç¤ºæ·¡è‰²æ–‡å­—è€Œä¸é¡¯ç¤ºé‚Šæ¡†ï¼Œé¿å…åœ¨æœªé¸å–è—¥ææ™‚å‡ºç¾æ˜Žé¡¯çš„é•·æ¡†ã€‚
             * ä½¿ç”¨å›ºå®šå¯¬åº¦ w-20 ä»¥ç¶­æŒæ¬„ä½å°é½Šï¼Œä½†é‚Šæ¡†è¨­ç‚º transparent ä»¥åŽ»é™¤æ¡†ç·šï¼Œ
             * èƒŒæ™¯é€æ˜Žã€æ–‡å­—è‰²åæ·¡ï¼Œé¡žä¼¼ placeholder æ•ˆæžœã€‚ç•¶ä½¿ç”¨è€…é¸æ“‡è—¥æå¾Œï¼Œå†å‹•æ…‹
             * åŠ å›žå¯¦éš›é‚Šæ¡†èˆ‡èƒŒæ™¯é¡è‰²ã€‚
             */
            unitDisplay.className =
                'batch-herb-unit w-20 border border-transparent px-2 py-1 text-sm text-gray-400 bg-transparent flex items-center justify-center';
            // é è¨­é¡¯ç¤ºã€Œå–®ä½ã€å­—æ¨£ï¼ˆå¯é€éŽç¿»è­¯å‡½å¼ç¿»è­¯ï¼‰
            try {
                const placeholderLabel = (typeof window.t === 'function') ? window.t('å–®ä½') : 'å–®ä½';
                unitDisplay.textContent = placeholderLabel;
            } catch (_e) {
                unitDisplay.textContent = 'å–®ä½';
            }
            row.appendChild(unitDisplay);
            // åˆªé™¤æŒ‰éˆ•
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-500 hover:text-red-700 px-2';
            removeBtn.textContent = 'Ã—';
            removeBtn.addEventListener('click', function() {
                row.remove();
            });
            row.appendChild(removeBtn);
            rowsContainer.appendChild(row);
        }

        async function saveBatchInventory() {
            // åœ¨æŒ‰ä¸‹å„²å­˜æ™‚ç«‹å³é¡¯ç¤ºæŒ‰éˆ•è®€å–åœˆï¼Œé˜²æ­¢é‡è¤‡é»žæ“Š
            const saveBtn = getLoadingButtonFromEvent('#batchInventoryModal button[onclick="saveBatchInventory()"]');
            setButtonLoading(saveBtn);
            // è¨˜éŒ„åŽŸæœ¬çš„åº«å­˜æ¨¡å¼ï¼Œä»¥ä¾¿åœ¨å„²å­˜å®Œæˆå¾Œæ¢å¾©
            const originalInventoryMode = currentInventoryMode;
            try {
                // ç¢ºä¿åº«å­˜åˆå§‹åŒ–å®Œæˆ
                if (typeof initHerbInventory === 'function' && !herbInventoryInitialized) {
                    try {
                        await initHerbInventory();
                    } catch (_e) {
                        /* å¿½ç•¥åˆå§‹åŒ–éŒ¯èª¤ */
                    }
                }
                const rowsContainer = document.getElementById('batchRows');
                if (!rowsContainer) {
                    clearButtonLoading(saveBtn);
                    return;
                }
                // åƒ…é¸å–å…·æœ‰ batch-row é¡žåˆ¥çš„è¡Œï¼Œé¿å…é¸åˆ°å–®ä½é¡¯ç¤º span å…§çš„ flex å…ƒç´ 
                const rows = rowsContainer.querySelectorAll('.batch-row');
                if (!rows || rows.length === 0) {
                    hideBatchInventoryModal();
                    clearButtonLoading(saveBtn);
                    return;
                }
                // å¾žæ‰¹é‡å…¥åº«å½ˆçª—çš„ä¸‹æ‹‰é¸æ“‡ä¸­å–å¾—è¦æ›´æ–°çš„åº«å­˜é¡žåž‹
                let selectedInventoryMode = currentInventoryMode;
                try {
                    const typeSelect = document.getElementById('batchInventoryTypeSelect');
                    if (typeSelect) {
                        const val = typeSelect.value;
                        if (val === 'granule' || val === 'slice') {
                            selectedInventoryMode = val;
                        }
                    }
                } catch (_e) {
                    /* å¿½ç•¥éŒ¯èª¤ä¸¦ä½¿ç”¨ç•¶å‰æ¨¡å¼ */
                }
                // é©—è­‰æ¯ä¸€è¡Œæ˜¯å¦æœ‰é¸æ“‡è—¥æä¸¦å¡«å¯«æœ‰æ•ˆæ•¸é‡
                let allValid = true;
                for (const row of rows) {
                    const qtyInputTemp = row.querySelector('input.batch-herb-qty');
                    let herbIdTemp = '';
                    if (row.dataset && row.dataset.herbId) {
                        herbIdTemp = row.dataset.herbId;
                    }
                    if (!herbIdTemp) {
                        const selectElTemp = row.querySelector('select.batch-herb-select');
                        if (selectElTemp) {
                            herbIdTemp = selectElTemp.value;
                        }
                    }
                    const qValTemp = qtyInputTemp ? parseFloat(qtyInputTemp.value) : NaN;
                    if (!herbIdTemp || isNaN(qValTemp) || qValTemp <= 0) {
                        allValid = false;
                        break;
                    }
                }
                if (!allValid) {
                    // é¡¯ç¤ºéŒ¯èª¤æç¤ºï¼Œä¸é€²è¡Œä¿å­˜
                    showToast((typeof window.t === 'function') ? (window.t('è«‹é¸æ“‡ä¸­è—¥') + ' / ' + window.t('æ•¸é‡')) : 'è«‹é¸æ“‡ä¸­è—¥ / æ•¸é‡', 'error');
                    clearButtonLoading(saveBtn);
                    return;
                }
                // è‡¨æ™‚è¨­å®šå…¨åŸŸåº«å­˜æ¨¡å¼ï¼Œè®“å¾ŒçºŒæ›´æ–°åº«å­˜ä½¿ç”¨æŒ‡å®šè·¯å¾‘
                currentInventoryMode = selectedInventoryMode;
                // åœ¨åˆ‡æ›åº«å­˜æ¨¡å¼å¾Œï¼Œé‡æ–°åˆå§‹åŒ–åº«å­˜è³‡æ–™ï¼Œä»¥ç¢ºä¿è®€å–æ­£ç¢ºçš„ç¾æœ‰åº«å­˜ã€‚
                // è‹¥è¼‰å…¥å¤±æ•—ï¼Œä»ç¹¼çºŒåŸ·è¡Œï¼Œåƒ…ä½¿ç”¨ç•¶å‰æœ¬åœ° herbInventory è³‡æ–™ã€‚
                try {
                    if (typeof initHerbInventory === 'function') {
                        await initHerbInventory(true);
                    }
                } catch (_initErr) {
                    /* å¿½ç•¥åˆå§‹åŒ–éŒ¯èª¤ */
                }
                // è™•ç†æ¯ä¸€è¡Œæ–°å¢žçš„ä¸­è—¥ï¼æ–¹åŠ‘
                for (const row of rows) {
                    const qtyInput = row.querySelector('input.batch-herb-qty');
                    let herbId = '';
                    // å…ˆå¾žè¡Œçš„è³‡æ–™é›†å–å¾— herbIdï¼Œé€™æ˜¯æœå°‹ä»‹é¢é¸å–å¾Œè¨­å®šçš„
                    if (row.dataset && row.dataset.herbId) {
                        herbId = row.dataset.herbId;
                    }
                    // å…¼å®¹èˆŠç‰ˆä¸‹æ‹‰é¸å–®
                    if (!herbId) {
                        const selectEl = row.querySelector('select.batch-herb-select');
                        if (selectEl) {
                            herbId = selectEl.value;
                        }
                    }
                    // è¡Œå…§è‹¥æ²’æœ‰è—¥ææˆ–æ•¸é‡è¼¸å…¥æ¡†å‰‡è·³éŽ
                    if (!qtyInput || !herbId) continue;
                    const qVal = parseFloat(qtyInput.value);
                    if (isNaN(qVal) || qVal <= 0) continue;
                    // å–å¾—è©²è—¥æçš„å–®ä½ï¼Œå„ªå…ˆä½¿ç”¨è³‡æ–™é›†ä¿å­˜çš„ herbUnitï¼›è‹¥ç„¡å‰‡å¾žåº«å­˜è³‡æ–™å–å¾—ï¼›æœ€çµ‚é è¨­ç‚º g
                    let inv = { quantity: 0, threshold: 0, unit: 'g', disabled: false };
                    try {
                        if (typeof getHerbInventory === 'function') {
                            inv = getHerbInventory(herbId);
                        }
                    } catch (_errInv) {
                        /* å¿½ç•¥éŒ¯èª¤ */
                    }
                    const unitVal = (row.dataset && row.dataset.herbUnit) ? row.dataset.herbUnit : (inv && inv.unit ? inv.unit : 'g');
                    const factor = UNIT_FACTOR_MAP[unitVal] || 1;
                    const addBase = qVal * factor;
                    const existingBaseQty = typeof inv.quantity === 'number' ? inv.quantity : 0;
                    const existingThreshold = typeof inv.threshold === 'number' ? inv.threshold : 0;
                    const existingUnit = inv.unit || 'g';
                    const existingDisabled = !!inv.disabled;
                    const newBaseQty = existingBaseQty + addBase;
                    // å¯«å…¥æ–°çš„åº«å­˜æ•¸æ“š
                    if (typeof setHerbInventory === 'function') {
                        await setHerbInventory(herbId, newBaseQty, existingThreshold, existingUnit, existingDisabled);
                    }
                    // åŒæ­¥æ›´æ–°æœ¬åœ°å¿«å– herbInventoryï¼ˆæ­¤æ™‚ currentInventoryMode ç‚ºé¸æ“‡çš„é¡žåž‹ï¼‰ã€‚
                    try {
                        if (typeof herbInventory !== 'undefined') {
                            herbInventory[String(herbId)] = {
                                quantity: newBaseQty,
                                threshold: existingThreshold,
                                unit: existingUnit,
                                disabled: existingDisabled
                            };
                        }
                    } catch (_e) {
                        /* å¿½ç•¥æœ¬åœ°æ›´æ–°éŒ¯èª¤ */
                    }
                }
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showToast((typeof window.t === 'function') ? window.t('åº«å­˜å·²æ›´æ–°ï¼') : 'åº«å­˜å·²æ›´æ–°ï¼', 'success');
                // éš±è—æ‰¹é‡å…¥åº«å°è©±æ¡†
                hideBatchInventoryModal();
                // åˆ·æ–°ä¸­è—¥åº«åˆ—è¡¨èˆ‡è™•æ–¹é¡¯ç¤ºï¼Œä»¥åæ˜ åº«å­˜è®ŠåŒ–
                try {
                    if (typeof displayHerbLibrary === 'function') {
                        displayHerbLibrary();
                    }
                    if (typeof updatePrescriptionDisplay === 'function') {
                        updatePrescriptionDisplay();
                    }
                } catch (_e) {
                    /* å¿½ç•¥åˆ·æ–°éŒ¯èª¤ */
                }
            } catch (err) {
                console.error('æ‰¹é‡å…¥åº«éŒ¯èª¤:', err);
                showToast((typeof window.t === 'function') ? window.t('æ‰¹é‡å…¥åº«å¤±æ•—ï¼') : 'æ‰¹é‡å…¥åº«å¤±æ•—ï¼', 'error');
            } finally {
                // åœ¨æ‰¹é‡å…¥åº«å®Œæˆå¾Œï¼Œæ¢å¾©åŽŸæœ¬çš„åº«å­˜æ¨¡å¼
                try {
                    if (typeof originalInventoryMode !== 'undefined') {
                        currentInventoryMode = originalInventoryMode;
                    }
                } catch (_e) {
                    /* å¿½ç•¥éŒ¯èª¤ */
                }
                // é‡æ–°åˆå§‹åŒ–åº«å­˜è³‡æ–™ï¼Œä»¥è¼‰å…¥åŽŸæœ¬åº«å­˜æ¨¡å¼çš„è³‡æ–™ï¼Œé¿å…æœ¬åœ°å¿«å–ç‚ºé¸æ“‡æ¨¡å¼ä¸‹çš„è³‡æ–™
                try {
                    if (typeof initHerbInventory === 'function') {
                        await initHerbInventory(true);
                    }
                } catch (_initErr) {
                    /* å¿½ç•¥éŒ¯èª¤ */
                }
                clearButtonLoading(saveBtn);
            }
        }

        // åˆå§‹åŒ–ç©´ä½åº«è³‡æ–™
        let acupointLibrary = [];
        // ç©´ä½åº«ç·¨è¼¯ç‹€æ…‹èˆ‡ç¯©é¸æ¢ä»¶
        // ç§»é™¤ç©´ä½ç·¨è¼¯ç‹€æ…‹è®Šæ•¸ï¼ˆä¸å†æ”¯æ´æ–°å¢ž/ç·¨è¼¯/åˆªé™¤ï¼‰
        // let editingAcupointId = null;
        let currentAcupointFilter = 'all';
        /**
         * å¾ž Firestore è®€å–ä¸­è—¥åº«è³‡æ–™ï¼Œè‹¥è³‡æ–™ä¸å­˜åœ¨å‰‡è‡ªå‹•ä½¿ç”¨é è¨­å€¼åˆå§‹åŒ–ã€‚
         * æ­¤å‡½å¼æœƒç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆå¾Œå†åŸ·è¡Œã€‚
         */
        async function initHerbLibrary(forceRefresh = false) {
            // è‹¥å·²è¼‰å…¥ä¸”ä¸éœ€è¦å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼Œç›´æŽ¥è¿”å›žä»¥é¿å…é‡è¤‡è®€å–
            if (herbLibraryLoaded && !forceRefresh) {
                return;
            }
            // å¾žæœ¬åœ° JSON æª”æ¡ˆè¼‰å…¥ä¸­è—¥è³‡æ–™èˆ‡æ–¹åŠ‘è³‡æ–™ï¼Œè‹¥æ‰¾ä¸åˆ°å‰‡å›žé€€è‡³ GitHub Raw
            try {
                const herbData = await fetchJsonWithFallback('herbLibrary.json');
                const formulaData = await fetchJsonWithFallback('herbformulaLibrary.json');
                const herbList = Array.isArray(herbData.herbLibrary) ? herbData.herbLibrary : [];
                const formulaList = Array.isArray(formulaData.herbLibrary) ? formulaData.herbLibrary : [];
                herbLibrary = [...herbList, ...formulaList];
                herbLibraryLoaded = true;
            } catch (error) {
                console.error('è®€å–æœ¬åœ° JSON ä¸­è—¥åº«è³‡æ–™å¤±æ•—:', error);
            }
        }

        // é è¨­æ”¶è²»é …ç›®è³‡æ–™ï¼ˆç›®å‰æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥å‚™æ—¥å¾Œæ“´å……ï¼‰
        // ç§»é™¤æœªä½¿ç”¨çš„é è¨­æ”¶è²»é …ç›®é™£åˆ—ä»¥æ¸›å°‘ç¨‹å¼ç¢¼å†—é¤˜

        // åˆå§‹åŒ–æ”¶è²»é …ç›®è³‡æ–™
        let billingItems = [];
        /**
         * å¾ž Firestore è®€å–æ”¶è²»é …ç›®è³‡æ–™ï¼Œè‹¥è³‡æ–™ä¸å­˜åœ¨å‰‡ä½¿ç”¨é è¨­è³‡æ–™åˆå§‹åŒ–ã€‚
         * æ­¤å‡½å¼æœƒç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆå¾Œå†åŸ·è¡Œã€‚
         */
        async function initBillingItems(forceRefresh = false) {
            // è‹¥å·²è¼‰å…¥ä¸”ä¸éœ€è¦å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼Œç›´æŽ¥è¿”å›žä»¥é¿å…é‡è¤‡è®€å–
            if (billingItemsLoaded && !forceRefresh) {
                return;
            }
            // å„ªå…ˆå˜—è©¦å¾ž localStorage è¼‰å…¥æ”¶è²»é …ç›®
            if (!forceRefresh) {
                try {
                    const stored = localStorage.getItem('billingItems');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        if (Array.isArray(localData)) {
                            billingItems = localData;
                            billingItemsLoaded = true;
                            return;
                        }
                    }
                } catch (lsErr) {
                    console.warn('è¼‰å…¥æœ¬åœ°æ”¶è²»é …ç›®å¤±æ•—:', lsErr);
                }
            }
            // ç­‰å¾… Firebase åŠå…¶è³‡æ–™åº«åˆå§‹åŒ–
            await waitForFirebaseDb();
            try {
                // å¾ž Firestore å–å¾— billingItems é›†åˆè³‡æ–™
                const querySnapshot = await window.firebase.getDocs(
                    window.firebase.collection(window.firebase.db, 'billingItems')
                );
                const itemsFromFirestore = [];
                querySnapshot.forEach((docSnap) => {
                    // å°‡æ–‡ä»¶ ID ä½œç‚º id æ¬„ä½ï¼Œé¿å…ä¾è³´è³‡æ–™å…§çš„ id
                    itemsFromFirestore.push({ id: docSnap.id, ...docSnap.data() });
                });
                if (itemsFromFirestore.length === 0) {
                    // Firestore ä¸­æ²’æœ‰è³‡æ–™æ™‚ï¼Œä¸è‡ªå‹•è¼‰å…¥é è¨­è³‡æ–™ï¼Œä¿æŒç©ºé™£åˆ—
                    billingItems = [];
                } else {
                    billingItems = itemsFromFirestore;
                }
                billingItemsLoaded = true;
                // å°‡è³‡æ–™å¯«å…¥ localStorage
                try {
                    localStorage.setItem('billingItems', JSON.stringify(billingItems));
                } catch (lsErr) {
                    console.warn('ä¿å­˜æ”¶è²»é …ç›®åˆ°æœ¬åœ°å¤±æ•—:', lsErr);
                }
            } catch (error) {
                console.error('è®€å–/åˆå§‹åŒ–æ”¶è²»é …ç›®è³‡æ–™å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ–æ¨¡æ¿åº«è³‡æ–™
        /**
         * å¾ž Firestore è®€å–æ¨¡æ¿åº«è³‡æ–™ï¼ŒåŒ…å«é†«å›‘æ¨¡æ¿èˆ‡è¨ºæ–·æ¨¡æ¿ã€‚
         * è‹¥è³‡æ–™å­˜åœ¨æ–¼ Firestoreï¼Œå‰‡å–ä»£æœ¬åœ°ç›®å‰çš„æ¨¡æ¿åˆ—è¡¨ï¼›å¦å‰‡ä¿ç•™ç¾æœ‰è³‡æ–™ã€‚
         * æ­¤å‡½å¼æœƒç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆå¾Œå†åŸ·è¡Œï¼Œä¸¦åœ¨è®€å–å¾Œé‡æ–°æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨ã€‚
         */
        async function initTemplateLibrary(forceRefresh = false) {
            // è‹¥å·²è¼‰å…¥ä¸”ä¸éœ€è¦å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼Œä»åŸ·è¡Œæ¸²æŸ“å‡½å¼ä»¥ç¢ºä¿é é¢é¡¯ç¤ºï¼Œä½†ä¸é‡æ–°è®€å–è³‡æ–™
            if (templateLibraryLoaded && !forceRefresh) {
                if (typeof renderPrescriptionTemplates === 'function') {
                    try { renderPrescriptionTemplates(); } catch (_e) {}
                }
                if (typeof renderDiagnosisTemplates === 'function') {
                    try { renderDiagnosisTemplates(); } catch (_e) {}
                }
                if (typeof refreshTemplateCategoryFilters === 'function') {
                    try { refreshTemplateCategoryFilters(); } catch (_e) {}
                }
                return;
            }
            // å¾žæœ¬åœ° JSON æª”æ¡ˆè¼‰å…¥é†«å›‘æ¨¡æ¿èˆ‡è¨ºæ–·æ¨¡æ¿è³‡æ–™ï¼Œè‹¥æ‰¾ä¸åˆ°å‰‡å›žé€€è‡³ GitHub Raw
            try {
                const presData = await fetchJsonWithFallback('prescriptionTemplates.json');
                const diagData = await fetchJsonWithFallback('diagnosisTemplates.json');
                prescriptionTemplates = Array.isArray(presData.prescriptionTemplates) ? presData.prescriptionTemplates : [];
                diagnosisTemplates = Array.isArray(diagData.diagnosisTemplates) ? diagData.diagnosisTemplates : [];
                templateLibraryLoaded = true;
            } catch (error) {
                console.error('è®€å–æœ¬åœ°æ¨¡æ¿è³‡æ–™å¤±æ•—:', error);
            }
            // æ¸²æŸ“æ¨¡æ¿å…§å®¹
            try {
                if (typeof renderPrescriptionTemplates === 'function') {
                    try { renderPrescriptionTemplates(); } catch (_e) {}
                }
                if (typeof renderDiagnosisTemplates === 'function') {
                    try { renderDiagnosisTemplates(); } catch (_e) {}
                }
                // åœ¨åˆæ¬¡åˆå§‹åŒ–æ¨¡æ¿åº«å¾Œåˆ·æ–°åˆ†é¡žç¯©é¸ä¸‹æ‹‰é¸å–®ï¼Œ
                // ä»¥ç¢ºä¿ã€Œè¨ºæ–·æ¨¡æ¿ã€èˆ‡ã€Œé†«å›‘æ¨¡æ¿ã€ç¯©é¸å™¨é¡¯ç¤ºæœ€æ–°çš„åˆ†é¡ž
                if (typeof refreshTemplateCategoryFilters === 'function') {
                    try { refreshTemplateCategoryFilters(); } catch (_e) {}
                }
            } catch (err) {
                console.error('æ¸²æŸ“æ¨¡æ¿åº«å…§å®¹å¤±æ•—:', err);
            }
        }

        // é è¨­ç”¨æˆ¶è³‡æ–™ï¼ˆç›®å‰æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥å‚™æ—¥å¾Œæ“´å……ï¼‰
        // ç§»é™¤æœªä½¿ç”¨çš„é è¨­ç”¨æˆ¶é™£åˆ—ä»¥æ¸›å°‘ç¨‹å¼ç¢¼å†—é¤˜

        // åˆå§‹åŒ–ç”¨æˆ¶è³‡æ–™ï¼šä¸ä½¿ç”¨æœ¬åœ°é è¨­ï¼Œç”¨ç©ºé™£åˆ—ä»£æ›¿ï¼Œå¾…ç”± Firebase è¼‰å…¥
        let users = [];

// é€šç”¨ç­‰å¾… Firebase åˆå§‹åŒ–çš„è¼”åŠ©å‡½å¼
// é¿å…åœ¨ç¨‹å¼å„è™•åè¦†ä½¿ç”¨ while (!window.firebase) æˆ– while (!window.firebase.db)
async function waitForFirebase() {
  while (!window.firebase) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

async function waitForFirebaseDb() {
  await waitForFirebase();
  while (!window.firebase.db) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

/**
 * ç”Ÿæˆç—…äººæœå°‹é—œéµå­—é™£åˆ—ã€‚
 *
 * é‡å°å§“åã€é›»è©±ã€èº«åˆ†è­‰åŠç—…äººç·¨è™Ÿç­‰æ¬„ä½ç”¢ç”Ÿå¤šçµ„å­å­—ä¸²ï¼Œ
 * ä¾¿æ–¼é€éŽ Firestore çš„ array-contains æŸ¥è©¢æ‰¾åˆ°éƒ¨åˆ†åŒ¹é…çš„ç—…äººã€‚
 * ä¾‹å¦‚å§“åã€Œå¼µä¸‰ã€æœƒç”Ÿæˆã€Œå¼µã€ã€ã€Œä¸‰ã€ã€ã€Œå¼µä¸‰ã€ç­‰å­å­—ä¸²ï¼›
 * é›»è©±è™Ÿç¢¼æœƒç”Ÿæˆå®Œæ•´è™Ÿç¢¼åŠé€£çºŒ 3~4 ä½çš„ç‰‡æ®µã€‚
 * æ‰€æœ‰é—œéµå­—å‡è½‰æˆå°å¯«å¾Œå„²å­˜ã€‚
 *
 * @param {Object} patient ç—…äººè³‡æ–™ç‰©ä»¶
 * @returns {Array<string>} é—œéµå­—é™£åˆ—
 */
function generateSearchKeywords(patient = {}) {
    const keywords = new Set();
    // è™•ç†å§“åï¼šç”¢ç”Ÿæ‰€æœ‰é€£çºŒå­å­—ä¸²
    if (patient.name) {
        const nameLower = String(patient.name).toLowerCase();
        for (let start = 0; start < nameLower.length; start++) {
            for (let end = start + 1; end <= nameLower.length; end++) {
                const sub = nameLower.slice(start, end).trim();
                if (sub) {
                    keywords.add(sub);
                }
            }
        }
    }
    // è™•ç†é›»è©±ï¼šå®Œæ•´è™Ÿç¢¼åŠæ‰€æœ‰é•·åº¦ >= 3 çš„é€£çºŒç‰‡æ®µ
    // å…è¨±ä½¿ç”¨è€…è¼¸å…¥ä»»æ„é•·åº¦çš„å±€éƒ¨è™Ÿç¢¼å³èƒ½æ‰¾åˆ°ç—…äºº
    if (patient.phone) {
        const phone = String(patient.phone).replace(/\s+/g, '').toLowerCase();
        if (phone) {
            // åŠ å…¥å®Œæ•´è™Ÿç¢¼
            keywords.add(phone);
            /*
             * éŽåŽ»åƒ…ç”¢ç”Ÿ 3~4 ä½çš„é€£çºŒç‰‡æ®µï¼Œå°Žè‡´ç•¶ä½¿ç”¨è€…è¼¸å…¥ 5 ä½æˆ–ä»¥ä¸Šçš„é›»è©±å±€éƒ¨æ™‚ç„¡æ³•åŒ¹é…ã€‚
             * ç‚ºäº†åŠ å¼·æœå°‹åŠŸèƒ½ï¼Œé€™è£¡å°‡ç”¢ç”Ÿå¾ž 3 ä½é–‹å§‹åˆ°å®Œæ•´è™Ÿç¢¼é•·åº¦çš„æ‰€æœ‰é€£çºŒç‰‡æ®µã€‚
             * é€™æ¨£ä¸è«–ä½¿ç”¨è€…è¼¸å…¥é›»è©±çš„å‰ã€ä¸­ã€å¾Œæ®µï¼Œåªè¦é•·åº¦å¤§æ–¼ç­‰æ–¼ 3 ä½çš†èƒ½æˆåŠŸåŒ¹é…ã€‚
             */
            const minLen = 3;
            const maxLen = phone.length;
            for (let len = minLen; len <= maxLen; len++) {
                for (let i = 0; i <= phone.length - len; i++) {
                    const fragment = phone.slice(i, i + len);
                    if (fragment) keywords.add(fragment);
                }
            }
        }
    }
    // è™•ç†èº«åˆ†è­‰è™Ÿï¼šå®Œæ•´å­—ä¸²èˆ‡å¾Œå››ä½
    if (patient.idCard) {
        const idLower = String(patient.idCard).toLowerCase();
        if (idLower) {
            keywords.add(idLower);
            if (idLower.length >= 4) {
                keywords.add(idLower.slice(-4));
            }
        }
    }
    // è™•ç†ç—…äººç·¨è™Ÿï¼šå®Œæ•´å­—ä¸²åŠæ‰€æœ‰é•·åº¦ >= 3 çš„é€£çºŒç‰‡æ®µ
    // èˆ‡é›»è©±é¡žä¼¼ï¼Œæ“´å……ç‰‡æ®µé•·åº¦åˆ°æ•´å€‹ç·¨è™Ÿé•·åº¦ï¼Œä»¥æ”¯æ´ä½¿ç”¨è€…è¼¸å…¥è¼ƒé•·çš„éƒ¨åˆ†ç·¨è™Ÿæœå°‹
    if (patient.patientNumber) {
        const numLower = String(patient.patientNumber).replace(/\s+/g, '').toLowerCase();
        if (numLower) {
            keywords.add(numLower);
            const minLen = 3;
            const maxLen = numLower.length;
            for (let len = minLen; len <= maxLen; len++) {
                for (let i = 0; i <= numLower.length - len; i++) {
                    const fragment = numLower.slice(i, i + len);
                    if (fragment) keywords.add(fragment);
                }
            }
            // ç‚ºå‘ä¸‹ç›¸å®¹èˆŠè³‡æ–™ï¼Œä¿ç•™å¾Œå››ç¢¼é‡è¤‡åŠ å…¥ä¸€æ¬¡
            if (numLower.length >= 4) {
                keywords.add(numLower.slice(-4));
            }
        }
    }
    return Array.from(keywords);
}

// ç­‰å¾… FirebaseDataManager åˆå§‹åŒ–çš„è¼”åŠ©å‡½å¼
// æŸäº›å‡½å¼éœ€è¦ç­‰å¾… DataManager isReady å†ç¹¼çºŒ
async function waitForFirebaseDataManager() {
  // å…ˆç¢ºä¿ Firebase æœ¬èº«å·²åˆå§‹åŒ–ï¼Œä»¥é¿å…æ•¸æ“šç®¡ç†å™¨æ°¸é ç„¡æ³•å°±ç·’
  await waitForFirebase();
  while (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

/**
 * å®‰å…¨åœ°å–å¾—ç—…äººåˆ—è¡¨ã€‚
 *
 * æœ¬å‡½å¼æœƒå…ˆæª¢æŸ¥ FirebaseDataManager æ˜¯å¦å­˜åœ¨ï¼Œåƒ…åœ¨å­˜åœ¨æ™‚æ‰ç­‰å¾…å…¶åˆå§‹åŒ–å®Œæˆä¸¦å‘¼å« getPatientsã€‚
 * ç•¶ DataManager å°šæœªå»ºç«‹æˆ–ç„¡æ³•å­˜å–æ™‚ï¼Œç›´æŽ¥å›žå‚³å¤±æ•—çµæžœï¼Œè€Œä¸æœƒé€ æˆé é¢ç„¡é™ç­‰å¾…ã€‚
 * é€™å¯é¿å…åœ¨ç™»å…¥é æˆ–å°šæœªåˆå§‹åŒ–æ•¸æ“šç®¡ç†å™¨çš„æƒ…æ³ä¸‹å‘¼å«ç›¸é—œå‡½å¼æ™‚å‡ºç¾éŒ¯èª¤ã€‚
 *
 * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾žè³‡æ–™åº«è¼‰å…¥
 * @returns {Promise<{ success: boolean, data: Array }>} ç—…äººåˆ—è¡¨è³‡æ–™
 */
async function safeGetPatients(forceRefresh = false) {
  try {
    // è‹¥æ•¸æ“šç®¡ç†å™¨å°šæœªå»ºç«‹ï¼Œå˜—è©¦ç­‰å¾…å…¶å»ºç«‹ï¼Œä½†ä¸è¶…éŽæŒ‡å®šæ™‚é–“ï¼Œé¿å…åœ¨ç™»å…¥é å¡ä½
    if (!window.firebaseDataManager || typeof window.firebaseDataManager.getPatients !== 'function') {
      const startTime = Date.now();
      const maxWait = 3000; // æœ€å¤šç­‰å¾… 3 ç§’
      // ç­‰å¾…æ•¸æ“šç®¡ç†å™¨åˆå§‹åŒ–
      while ((!window.firebaseDataManager || typeof window.firebaseDataManager.getPatients !== 'function') && (Date.now() - startTime < maxWait)) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      // è‹¥ä»æœªå»ºç«‹ï¼Œç›´æŽ¥å›žå‚³å¤±æ•—ï¼Œé¿å…ç­‰å¾…éŽä¹…
      if (!window.firebaseDataManager || typeof window.firebaseDataManager.getPatients !== 'function') {
        return { success: false, data: [] };
      }
    }
    // ç­‰å¾… DataManager å°±ç·’ï¼ˆisReadyï¼‰ï¼Œç¢ºä¿å¯ä»¥æ­£å¸¸å–å¾—è³‡æ–™
    if (typeof waitForFirebaseDataManager === 'function') {
      try {
        await waitForFirebaseDataManager();
      } catch (_e) {
        // å¿½ç•¥ç­‰å¾…éŒ¯èª¤ï¼Œç¹¼çºŒåŸ·è¡Œ
      }
    }
    // å†æ¬¡ç¢ºèª DataManager å¯ç”¨
    if (!window.firebaseDataManager || typeof window.firebaseDataManager.getPatients !== 'function') {
      return { success: false, data: [] };
    }
    // å‘¼å«åŽŸå§‹ getPatients å–å¾—è³‡æ–™
    const result = await window.firebaseDataManager.getPatients(forceRefresh);
    // è‹¥çµæžœç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºä»å›žå‚³å¤±æ•—ç‹€æ…‹
    if (result && typeof result.success === 'boolean' && Array.isArray(result.data)) {
      return result;
    }
    return { success: false, data: [] };
  } catch (err) {
    console.error('safeGetPatients ç™¼ç”ŸéŒ¯èª¤:', err);
    return { success: false, data: [] };
  }
}

/**
 * æ ¹æ“šæŽ›è™Ÿ ID å–å¾—æœ€æ–°çš„æŽ›è™Ÿè³‡æ–™ã€‚
 *
 * åœ¨é•·æ™‚é–“å¾…æ©Ÿå¾Œï¼Œé é¢ä¸­çš„å…¨åŸŸæŽ›è™Ÿé™£åˆ—å¯èƒ½å·²éŽæœŸæˆ–ç‚ºç©ºï¼Œ
 * å°Žè‡´ç„¡æ³•åœ¨æœ¬åœ°æ‰¾åˆ°å°æ‡‰çš„æŽ›è™Ÿè¨˜éŒ„è€Œç„¡æ³•ä¿®æ”¹æˆ–å–æ¶ˆæŽ›è™Ÿã€‚
 * æ­¤å‡½å¼æœƒåœ¨éœ€è¦æ™‚é‡æ–°å¾ž Firebase Realtime Database è¼‰å…¥æŽ›è™Ÿåˆ—è¡¨ï¼Œ
 * ä¸¦å›žå‚³æŒ‡å®š ID çš„æŽ›è™Ÿç‰©ä»¶ã€‚è‹¥å…©æ¬¡æŸ¥è©¢ä»æ‰¾ä¸åˆ°ï¼Œå‰‡å›žå‚³ nullã€‚
 *
 * @param {string|number} appointmentId - æŽ›è™Ÿ ID
 * @returns {Promise<Object|null>} å°æ‡‰çš„æŽ›è™Ÿç‰©ä»¶æˆ– null
 */
async function getLatestAppointmentById(appointmentId) {
    // ç­‰å¾… Firebase DataManager æº–å‚™å¥½
    try {
        await waitForFirebaseDataManager();
    } catch (_e) {
        // å¦‚æžœç­‰å¾…å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œï¼Œä½†å¯èƒ½æœƒå°Žè‡´å¾ŒçºŒèª¿ç”¨å¤±æ•—
    }

    const idStr = String(appointmentId);
    let found = null;

    // å„ªå…ˆå¾žç•¶å‰è¨˜æ†¶é«”çš„ appointments é™£åˆ—æœå°‹
    if (Array.isArray(appointments) && appointments.length > 0) {
        found = appointments.find(apt => apt && String(apt.id) === idStr) || null;
    }

    // è‹¥ä»æœªæ‰¾åˆ°ï¼Œå˜—è©¦å¾ž localStorage è®€å–å¿«å–ä¸¦æ›´æ–°å…¨åŸŸé™£åˆ—
    if (!found) {
        try {
            const stored = localStorage.getItem('appointments');
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed)) {
                    // å¦‚æžœå…¨åŸŸé™£åˆ—å°šæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨å„²å­˜å€¼
                    if (!Array.isArray(appointments) || appointments.length === 0) {
                        appointments = parsed.map(item => ({ ...item }));
                    }
                    found = parsed.find(item => item && String(item.id) === idStr) || null;
                }
            }
        } catch (e) {
            console.error('getLatestAppointmentById: è®€å–æœ¬åœ°æŽ›è™Ÿå¿«å–å¤±æ•—:', e);
        }
    }

    // è‹¥é‚„æ˜¯æ²’æœ‰æ‰¾åˆ°ï¼Œå¾žå¾Œç«¯è®€å–å–®ç­†è³‡æ–™
    if (!found) {
        try {
            const result = await window.firebaseDataManager.getAppointment(appointmentId);
            if (result && result.success && result.data) {
                found = result.data;
                // æ›´æ–°å…¨åŸŸé™£åˆ—åŠæœ¬åœ°å¿«å–
                if (!Array.isArray(appointments)) appointments = [];
                const index = appointments.findIndex(apt => apt && String(apt.id) === idStr);
                if (index >= 0) {
                    appointments[index] = { ...found };
                } else {
                    appointments.push({ ...found });
                }
                try {
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                } catch (_storageErr) {
                    // è‹¥ç„¡æ³•å¯«å…¥ localStorageï¼Œå¿½ç•¥
                }
            }
        } catch (err) {
            console.error('getLatestAppointmentById: è®€å–å–®ç­†æŽ›è™Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        }
    }

    return found || null;
}

/**
 * è®€å–ä½æ–¼ /data ç›®éŒ„æˆ– GitHub Pages raw è·¯å¾‘çš„ JSON æª”æ¡ˆã€‚
 * é€™å€‹è¼”åŠ©å‡½å¼æœƒå…ˆå˜—è©¦ç›¸å°è·¯å¾‘ data/<fileName>ï¼Œè‹¥å›žå‚³ 404 æˆ–å…¶ä»–éžæˆåŠŸç‹€æ…‹ï¼Œ
 * ä¸¦ä¸”ç•¶å‰ç¶²ç«™é‹è¡Œåœ¨ GitHub Pages ç¶²åŸŸï¼ˆxxx.github.ioï¼‰ï¼Œå‰‡å›žé€€è‡³
 * https://raw.githubusercontent.com/<user>/<repo>/main/data/<fileName>ã€‚
 * @param {string} fileName - è¦è®€å–çš„æª”åï¼Œä¾‹å¦‚ 'herbLibrary.json'
 * @returns {Promise<any>} å›žå‚³è§£æžå¾Œçš„ JSON å…§å®¹
 */
async function fetchJsonWithFallback(fileName) {
    const host = window.location.hostname;
    const isGithubPages = host && host.endsWith('github.io');
    // å¦‚æžœä¸æ˜¯é‹è¡Œåœ¨ GitHub Pages åŸŸåä¸‹ï¼Œå…ˆå˜—è©¦å¾žç›¸å°è·¯å¾‘è®€å–è³‡æ–™
    if (!isGithubPages) {
        try {
            const relativeResponse = await fetch(`data/${fileName}`, { cache: 'reload' });
            if (relativeResponse.ok) {
                return await relativeResponse.json();
            }
            // è‹¥éž 2xxï¼Œæ‹‹å‡ºä»¥ä¾¿é€²å…¥å›žé€€é‚è¼¯
            throw new Error(`Relative path HTTP error ${relativeResponse.status}`);
        } catch (relativeErr) {
            // ç¹¼çºŒå˜—è©¦å›žé€€é‚è¼¯
        }
    }
    // è‹¥ç‚º GitHub Pages ç¶²åŸŸï¼Œæˆ–ç›¸å°è®€å–å¤±æ•—ï¼Œå˜—è©¦å¾ž raw.githubusercontent.com è®€å–
    if (host && host.endsWith('github.io')) {
        try {
            const user = host.split('.')[0];
            const pathParts = window.location.pathname.split('/');
            const repo = pathParts.length > 1 ? pathParts[1] : '';
            if (user && repo) {
                // å˜—è©¦å¾žå¤šå€‹åˆ†æ”¯è®€å–æª”æ¡ˆï¼ˆå…ˆå˜—è©¦ mainï¼Œå†å˜—è©¦ masterï¼‰ï¼Œæ–¹ä¾¿å…¼å®¹ä¸åŒé è¨­åˆ†æ”¯åç¨±
                const branches = ['main', 'master'];
                for (const branch of branches) {
                    // æ”¹ç‚ºå¾ž data ç›®éŒ„è®€å–ï¼Œä¸å†ä¾è³´ public ç›®éŒ„
                    const rawUrl = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/data/${fileName}`;
                    try {
                        const rawResponse = await fetch(rawUrl, { cache: 'reload' });
                        if (rawResponse.ok) {
                            return await rawResponse.json();
                        }
                    } catch (fetchErr) {
                        // å¿½ç•¥å–®ä¸€åˆ†æ”¯çš„ fetch éŒ¯èª¤ä¸¦å˜—è©¦ä¸‹ä¸€å€‹åˆ†æ”¯
                    }
                }
            }
        } catch (fallbackErr) {
            console.error(`å›žé€€è‡³ GitHub raw è®€å– ${fileName} å¤±æ•—:`, fallbackErr);
            // å›žé€€å¤±æ•—æ™‚ç¹¼çºŒå¾€ä¸‹æ‹‹å‡º
        }
    }
    // æœ€çµ‚è‹¥ä»ç„¡æ³•å–å¾—è³‡æ–™ï¼Œæ‹‹å‡ºéŒ¯èª¤ä»¥ä¾¿å‘¼å«è€…è™•ç†
    throw new Error(`ç„¡æ³•å–å¾— ${fileName} è³‡æ–™`);
}

    

// ä¸»è¦ç™»å…¥åŠŸèƒ½
async function attemptMainLogin() {
    const email = document.getElementById('mainLoginUsername').value.trim();
    const password = document.getElementById('mainLoginPassword').value.trim();
    
    if (!email || !password) {
        showToast('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼ï¼', 'error');
        return;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼šåœ¨æŒ‰éˆ•ä¸­é¡¯ç¤ºæ—‹è½‰å°åœˆä¸¦ç¦ç”¨æŒ‰éˆ•
    // ç”±æ–¼ä¸å†ä½¿ç”¨ inline onclick å±¬æ€§ï¼Œé€éŽ id å–å¾—ç™»å…¥æŒ‰éˆ•
    const loginButton = document.getElementById('loginButton');
    if (loginButton) {
        setButtonLoading(loginButton, 'ç™»å…¥ä¸­...');
    }

    try {
        // ç­‰å¾… Firebase åˆå§‹åŒ–
        await waitForFirebase();

        // ç­‰å¾… Firebase åˆå§‹åŒ–å¾Œæª¢æŸ¥é€£ç·šç‹€æ…‹ï¼Œè‹¥æœªé€£ç·šå‰‡é¡¯ç¤ºéŒ¯èª¤ä¸¦ä¸­æ­¢
        if (window.firebaseConnected === false) {
            showToast('ç„¡æ³•é€£æŽ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            return;
        }

        // ä½¿ç”¨ Firebase ç™»å…¥
        const userCredential = await window.firebase.signInWithEmailAndPassword(
            window.firebase.auth,
            email,
            password
        );

        console.log('Firebase ç™»å…¥æˆåŠŸ:', userCredential.user.email);

        // å–å¾— Firebase ä½¿ç”¨è€…è³‡è¨Š
        const firebaseUser = userCredential.user;
        const uid = firebaseUser.uid;

        // å–å¾—ä¸¦å­˜å„² Firebase è‡ªè¨‚æ¬Šé™ï¼ˆCustom Claimsï¼‰
        // ç•¶ç®¡ç†å“¡éœ€é€²è¡Œæ›´ç´°ç·»çš„æ¬Šé™ç®¡ç†æ™‚ï¼Œå¯åœ¨å¾Œç«¯è¨­å®šè‡ªè¨‚ claimsï¼ˆä¾‹å¦‚ role: 'admin'ï¼‰ã€‚
        // ä½¿ç”¨è€…ç™»å…¥æ™‚é€éŽ getIdTokenResult() å–å¾— claimsï¼Œä¸¦å­˜å…¥å…¨åŸŸè®Šæ•¸ä»¥ä¾›å…¶ä»–æ¨¡çµ„ä½¿ç”¨ã€‚
        try {
            if (firebaseUser && typeof firebaseUser.getIdTokenResult === 'function') {
                const idTokenResult = await firebaseUser.getIdTokenResult();
                if (idTokenResult && idTokenResult.claims) {
                    // å°‡å–å¾—çš„ claims å„²å­˜åœ¨å…¨åŸŸ currentUserClaims
                    window.currentUserClaims = idTokenResult.claims;
                } else {
                    window.currentUserClaims = {};
                }
            }
        } catch (claimsErr) {
            console.warn('å–å¾—ä½¿ç”¨è€…è‡ªè¨‚æ¬Šé™å¤±æ•—:', claimsErr);
            window.currentUserClaims = {};
        }

        // åŒæ­¥è¼‰å…¥ Firebase ç”¨æˆ¶æ•¸æ“š
        await syncUserDataFromFirebase();

        // åœ¨ç”¨æˆ¶è³‡æ–™ä¸­å°‹æ‰¾å°æ‡‰çš„ UID æˆ–é›»å­éƒµä»¶
        let matchingUser = users.find(u => u.uid && u.uid === uid);
        if (!matchingUser) {
            // è‹¥æœªè¨­å®š uidï¼Œæ”¹ç”¨ email æ¯”å°ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
            matchingUser = users.find(u => u.email && u.email.toLowerCase() === firebaseUser.email.toLowerCase());
            if (matchingUser) {
                // å°‡ Firebase UID è¨­å®šåˆ°ç”¨æˆ¶è³‡æ–™ä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ç›´æŽ¥é€éŽ UID æ¯”å°
                matchingUser.uid = uid;
                
                // æ›´æ–°åˆ° Firebase
                try {
                    await window.firebaseDataManager.updateUser(matchingUser.id, { uid: uid });
                } catch (error) {
                    console.error('æ›´æ–°ç”¨æˆ¶ UID å¤±æ•—:', error);
                }
                
                // æ›´æ–°æœ¬åœ°å­˜å„²
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        if (matchingUser) {
            // æ‰¾åˆ°å°æ‡‰ç”¨æˆ¶ï¼Œæª¢æŸ¥æ˜¯å¦å•Ÿç”¨
            if (!matchingUser.active) {
                showToast('æ‚¨çš„å¸³è™Ÿå·²è¢«åœç”¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡', 'error');
                await window.firebase.signOut(window.firebase.auth);
                return;
            }

            // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
            matchingUser.lastLogin = new Date().toISOString();
            try {
                await window.firebaseDataManager.updateUser(matchingUser.id, { 
                    lastLogin: new Date() 
                });
            } catch (error) {
                console.error('æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“å¤±æ•—:', error);
            }
            
            // ä½¿ç”¨ç”¨æˆ¶è³‡æ–™é€²è¡Œç™»å…¥
            currentUserData = matchingUser;
            currentUser = matchingUser.username;
        } else {
            // è‹¥æ‰¾ä¸åˆ°å°æ‡‰ç”¨æˆ¶ï¼Œè¡¨ç¤ºå°šæœªæŽˆæ¬Šï¼Œä¸å…è¨±ä»¥è‡¨æ™‚å¸³è™Ÿç™»å…¥
            showToast('æ­¤å¸³è™Ÿå°šæœªè¢«æŽˆæ¬Šï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡', 'error');
            // ç™»å‡º Firebase ä½¿ç”¨è€…ï¼Œé¿å…é€•è‡ªé€²å…¥ç³»çµ±
            try {
                await window.firebase.signOut(window.firebase.auth);
            } catch (e) {
                console.error('ç™»å‡º Firebase å¤±æ•—:', e);
            }
            return;
        }

        // åœ¨ç™»å…¥ä¸»ç³»çµ±å‰ä¸¦è¡Œè¼‰å…¥ä¸­è—¥åº«è³‡æ–™ã€ç©´ä½åº«è³‡æ–™ã€æ”¶è²»é …ç›®ã€åˆ†é¡žè³‡æ–™èˆ‡æ¨¡æ¿è³‡æ–™
        // é€éŽ Promise.all åŒæ™‚åŸ·è¡Œå¤šå€‹åˆå§‹åŒ–å‡½å¼ï¼Œæå‡æ•ˆçŽ‡
        try {
            const initTasks = [];
            if (typeof initHerbLibrary === 'function') {
                initTasks.push(initHerbLibrary());
            }
            // åœ¨ç™»å…¥æ™‚é å…ˆè¼‰å…¥ä¸­è—¥åº«å­˜è³‡æ–™ï¼Œé¿å…æœªé–‹å•Ÿä¸­è—¥åº«æ™‚è™•æ–¹é¤˜é‡é¡¯ç¤ºç‚ºé›¶
            if (typeof initHerbInventory === 'function') {
                // ä½¿ç”¨å¼·åˆ¶åˆ·æ–°æ¨¡å¼åˆå§‹åŒ–ä¸­è—¥åº«å­˜
                initTasks.push((async () => {
                    try {
                        // å¼·åˆ¶åˆ·æ–°ä»¥ç¢ºä¿ç›£è½å™¨é‡æ–°æŽ›è¼‰
                        await initHerbInventory(true);
                    } catch (err) {
                        console.error('åˆå§‹åŒ–ä¸­è—¥åº«å­˜è³‡æ–™å¤±æ•—:', err);
                    }
                })());
            }
            if (typeof initBillingItems === 'function') {
                initTasks.push(initBillingItems());
            }
            if (typeof initCategoryData === 'function') {
                initTasks.push((async () => {
                    try {
                        await initCategoryData();
                    } catch (err) {
                        console.error('åˆå§‹åŒ–åˆ†é¡žè³‡æ–™å¤±æ•—:', err);
                    }
                })());
            }
            if (typeof initTemplateLibrary === 'function') {
                initTasks.push((async () => {
                    try {
                        await initTemplateLibrary();
                    } catch (err) {
                        console.error('åˆå§‹åŒ–æ¨¡æ¿åº«è³‡æ–™å¤±æ•—:', err);
                    }
                })());
            }
            // åˆå§‹åŒ–ç©´ä½åº«è³‡æ–™ï¼Œä½¿å…¶èˆ‡ä¸­è—¥åº«å’Œæ¨¡æ¿åº«ä¸€æ¨£æ–¼ç™»å…¥å¾Œå³è¼‰å…¥
            if (typeof initAcupointLibrary === 'function') {
                initTasks.push((async () => {
                    try {
                        await initAcupointLibrary();
                    } catch (err) {
                        console.error('åˆå§‹åŒ–ç©´ä½åº«è³‡æ–™å¤±æ•—:', err);
                    }
                })());
            }
            if (initTasks.length > 0) {
                await Promise.all(initTasks);
            }
        } catch (error) {
            console.error('åˆå§‹åŒ–ä¸­è—¥åº«æˆ–æ”¶è²»é …ç›®è³‡æ–™å¤±æ•—:', error);
        }

        // ç™»å…¥æˆåŠŸï¼Œåˆ‡æ›åˆ°ä¸»ç³»çµ±
        performLogin(currentUserData);
        // ç™»å…¥å¾Œå•Ÿå‹•é–’ç½®ç›£æŽ§ï¼Œç›£æ¸¬é•·æ™‚é–“æœªæ“ä½œè‡ªå‹•ç™»å‡º
        try {
            if (typeof startInactivityMonitoring === 'function') {
                startInactivityMonitoring();
            }
        } catch (_e) {
            // å¿½ç•¥å•Ÿå‹•é–’ç½®ç›£æŽ§æ™‚çš„éŒ¯èª¤
        }
        // ç™»å…¥å¾Œåˆå§‹åŒ–ç³»çµ±è³‡æ–™ï¼ˆè¼‰å…¥æŽ›è™Ÿã€è¨ºç™‚è¨˜éŒ„ã€æ‚£è€…ç­‰ï¼‰
        await initializeSystemAfterLogin();

        // åœ¨ä½¿ç”¨è€…å·²ç™»å…¥çš„æƒ…æ³ä¸‹æ¸…é™¤éŽæœŸçš„å•è¨ºè³‡æ–™ã€‚
        // é€™æ¨£å¯ç¢ºä¿åƒ…åœ¨å…·å‚™é©ç•¶æ¬Šé™æ™‚åŸ·è¡Œåˆªé™¤å‹•ä½œï¼Œ
        // é¿å…æœªæŽˆæ¬Šç‹€æ…‹ä¸‹è§¸ç™¼ Firebase çš„æ¬Šé™éŒ¯èª¤ã€‚
        try {
            if (window.firebaseDataManager && typeof window.firebaseDataManager.clearOldInquiries === 'function') {
                await window.firebaseDataManager.clearOldInquiries();
            }
        } catch (err) {
            console.error('ç™»å…¥å¾Œæ¸…ç†å•è¨ºè³‡æ–™å¤±æ•—:', err);
        }

        // åˆå§‹åŒ–èŠå¤©æ¨¡çµ„ï¼šåœ¨è¼‰å…¥ç³»çµ±è³‡æ–™å¾Œå•Ÿç”¨å…§éƒ¨èŠå¤©ã€‚å‚³å…¥ç•¶å‰ç”¨æˆ¶è³‡æ–™èˆ‡æ‰€æœ‰ç”¨æˆ¶æ¸…å–®
        try {
            if (window.ChatModule && typeof window.ChatModule.initChat === 'function') {
                window.ChatModule.initChat(currentUserData, users);
            }
        } catch (chatErr) {
            console.error('åˆå§‹åŒ–èŠå¤©æ¨¡çµ„å¤±æ•—:', chatErr);
        }

        showToast('ç™»å…¥æˆåŠŸï¼', 'success');

    } catch (error) {
        console.error('ç™»å…¥å¤±æ•—:', error);
        let errorMessage = 'ç™»å…¥å¤±æ•—';
        
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'é›»å­éƒµä»¶ä¸å­˜åœ¨';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'å¯†ç¢¼éŒ¯èª¤';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º';
        }
        
        showToast(errorMessage, 'error');
        document.getElementById('mainLoginPassword').value = '';
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹èˆ‡å…§å®¹
        clearButtonLoading(loginButton);
    }
}

// åŒæ­¥ Firebase ç”¨æˆ¶æ•¸æ“šåˆ°æœ¬åœ°
async function syncUserDataFromFirebase() {
    try {
        if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
            console.log('Firebase æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’ï¼Œè·³éŽåŒæ­¥');
            return;
        }

        // æ”¹ç‚ºé€éŽ fetchUsers(true) è®€å–ç”¨æˆ¶åˆ—è¡¨ï¼Œä¸¦åˆ©ç”¨å¿«å–é¿å…é‡è¤‡è®€å–
        const data = await fetchUsers(true);
        if (Array.isArray(data) && data.length > 0) {
            // æ›´æ–°æœ¬åœ° users è®Šæ•¸ï¼Œåƒ…åŒæ­¥å¿…è¦æ¬„ä½ï¼ˆæŽ’é™¤ personalSettingsï¼‰
            users = data.map(user => {
                const { personalSettings, ...rest } = user || {};
                return {
                    ...rest,
                    createdAt: user.createdAt
                      ? (user.createdAt.seconds
                        ? new Date(user.createdAt.seconds * 1000).toISOString()
                        : user.createdAt)
                      : new Date().toISOString(),
                    updatedAt: user.updatedAt
                      ? (user.updatedAt.seconds
                        ? new Date(user.updatedAt.seconds * 1000).toISOString()
                        : user.updatedAt)
                      : new Date().toISOString(),
                    lastLogin: user.lastLogin
                      ? (user.lastLogin.seconds
                        ? new Date(user.lastLogin.seconds * 1000).toISOString()
                        : user.lastLogin)
                      : null
                };
            });
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ä½œç‚ºå‚™ç”¨
            try {
                localStorage.setItem('users', JSON.stringify(users));
            } catch (lsErr) {
                console.warn('ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ°æœ¬åœ°å¤±æ•—:', lsErr);
            }
            console.log('å·²åŒæ­¥ Firebase ç”¨æˆ¶æ•¸æ“šåˆ°æœ¬åœ°:', users.length, 'ç­† (ä½¿ç”¨å¿«å–)');
        } else {
            // ç„¡æ³•å–å¾—å®Œæ•´ç”¨æˆ¶åˆ—è¡¨æ™‚ï¼Œä¸å›žé€€å–®ä¸€ç”¨æˆ¶è³‡æ–™ï¼Œä»¥é¿å…å½±éŸ¿å…¶ä»–åŠŸèƒ½
            console.warn('ç„¡æ³•å¾ž Firebase å–å¾—å®Œæ•´ç”¨æˆ¶åˆ—è¡¨ï¼Œæœªå›žé€€åŒæ­¥å–®ä¸€ç”¨æˆ¶è³‡æ–™');
        }
    } catch (error) {
        console.error('åŒæ­¥ Firebase ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
    }
}

        
        // åŸ·è¡Œç™»å…¥
        function performLogin(user) {
            // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                users[userIndex].lastLogin = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            currentUser = user.username;
            currentUserData = user;
            
            // åˆ‡æ›åˆ°ä¸»ç³»çµ±
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            // åˆ‡æ›ç‰ˆæ¬Šé¡¯ç¤ºï¼šç™»å…¥é ç‰ˆæ¬Šéš±è—ï¼Œé¡¯ç¤ºå…¨å±€ç‰ˆæ¬Š
            if (typeof showGlobalCopyright === 'function') {
                try {
                    showGlobalCopyright();
                } catch (_e) {
                    // è‹¥ç™¼ç”ŸéŒ¯èª¤å‰‡å¿½ç•¥
                }
            }
            
            document.getElementById('userRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(user)}`;
            document.getElementById('sidebarUserRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(user)}`;
            
            generateSidebarMenu();
            // ç™»å…¥å¾Œæ›´æ–°æ­¡è¿Žé å¡ç‰‡é¡¯ç¤º
            if (typeof updateWelcomeCards === 'function') {
                try {
                    updateWelcomeCards();
                } catch (_e) {
                    // å¿½ç•¥éŒ¯èª¤
                }
            }
            // After generating the sidebar, load the personal settings for this user.
            // We call this asynchronously and do not block the login flow. Any errors will be logged to the console.
            if (typeof loadPersonalSettings === 'function') {
                loadPersonalSettings().catch((err) => {
                    console.error('è¼‰å…¥å€‹äººè¨­ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                });
            }
            // çµ±è¨ˆè³‡è¨Šå°‡åœ¨ç™»å…¥å¾Œåˆå§‹åŒ–ç³»çµ±æ™‚æ›´æ–°

            // Show a welcome message in the appropriate language
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `æ­¡è¿Žå›žä¾†ï¼Œ${getUserDisplayName(user)}ï¼`;
                const enMsg = `Welcome back, ${getUserDisplayName(user)}!`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'success');
            }
        }

        // å´é‚Šé¸å–®æŽ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
async function logout() {
    try {
        // åœ¨æ’¤éŠ· Firebase ç™»å…¥ä¹‹å‰ï¼Œå…ˆé—œé–‰èŠå¤©æ¨¡çµ„ã€‚é€™æ¨£å¯ä»¥ç¢ºä¿æˆ‘å€‘ä»å…·å‚™
        // è¶³å¤ çš„æ¬Šé™åŽ»æ›´æ–° Realtime Database ä¸­çš„ presence ç‹€æ…‹ã€‚è‹¥å…ˆ
        // åŸ·è¡Œ signOutï¼Œå†å‘¼å« destroyChatï¼Œå¯èƒ½å› ç‚ºä½¿ç”¨è€…çš„æ¬Šé™å·²å¤±æ•ˆ
        // è€Œå°Žè‡´ presence ç‹€æ…‹ç„¡æ³•æ­£ç¢ºå¯«å…¥ï¼Œå¾žè€Œå‡ºç¾ç™»å‡ºå¾Œä¾ç„¶é¡¯ç¤ºåœ¨ç·šçš„å•é¡Œã€‚
        try {
            if (window.ChatModule && typeof window.ChatModule.destroyChat === 'function') {
                window.ChatModule.destroyChat();
            }
        } catch (chatErr) {
            console.error('éŠ·æ¯€èŠå¤©æ¨¡çµ„å¤±æ•—:', chatErr);
        }
        // Firebase ç™»å‡º
        if (window.firebase && window.firebase.auth) {
            await window.firebase.signOut(window.firebase.auth);
        }

        // --- å–æ¶ˆä¸­è—¥åº«å­˜ç›£è½å™¨ ---
        // åœ¨ç™»å‡ºæ™‚ç§»é™¤ Realtime Database çš„ä¸­è—¥åº«å­˜ç›£è½ï¼Œ
        // é¿å…èˆŠä½¿ç”¨è€…çš„ç›£è½å›žå‘¼åœ¨æ–°ä½¿ç”¨è€…ç™»å…¥å¾Œç¹¼çºŒåŸ·è¡Œé€ æˆè³‡æ–™ä¸åŒæ­¥ã€‚
        try {
            // ç¢ºèªè®Šæ•¸å­˜åœ¨ä¸”ç›£è½å™¨å·²æŽ›è¼‰
            if (typeof herbInventoryListenerAttached !== 'undefined' && herbInventoryListenerAttached) {
                // å–å¾—ä¸­è—¥åº«å­˜è³‡æ–™çš„åƒè€ƒè·¯å¾‘
                const inventoryRef = window.firebase.ref(window.firebase.rtdb, 'herbInventory');
                // å–æ¶ˆç›£è½ value äº‹ä»¶
                window.firebase.off(inventoryRef, 'value');
                // é‡ç½®æ——æ¨™ï¼Œä¸‹æ¬¡åˆå§‹åŒ–æ™‚é‡æ–°æŽ›è¼‰ç›£è½
                herbInventoryListenerAttached = false;
                herbInventoryInitialized = false;
            }
        } catch (err) {
            console.error('å–æ¶ˆä¸­è—¥åº«å­˜ç›£è½å™¨å¤±æ•—:', err);
        }
        
        // æ¸…ç†æœ¬åœ°æ•¸æ“š
        currentUser = null;
        currentUserData = null;
        
        // åˆ‡æ›é é¢
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainSystem').classList.add('hidden');
        // åˆ‡æ›ç‰ˆæ¬Šé¡¯ç¤ºï¼šé¡¯ç¤ºç™»å…¥é ç‰ˆæ¬Šï¼Œéš±è—å…¨å±€ç‰ˆæ¬Š
        if (typeof hideGlobalCopyright === 'function') {
            try {
                hideGlobalCopyright();
            } catch (_e) {
                // è‹¥ç™¼ç”ŸéŒ¯èª¤å‰‡å¿½ç•¥
            }
        }
        document.getElementById('sidebar').classList.add('-translate-x-full');
        document.getElementById('sidebarOverlay').classList.add('hidden');
        hideAllSections();

        // ç™»å‡ºæ™‚è‹¥æœ‰é–‹å•Ÿè¨ºç—‡ç›¸é—œé¢æ¿ï¼Œå°‡å…¶é—œé–‰
        try {
            // è‹¥æœ‰è¨ºç—‡è¡¨å–®æ­£åœ¨é¡¯ç¤ºï¼Œå‘¼å«é—œé–‰å‡½å¼æˆ–ç›´æŽ¥éš±è—
            if (typeof closeConsultationForm === 'function') {
                closeConsultationForm();
            } else if (document.getElementById('consultationForm')) {
                document.getElementById('consultationForm').classList.add('hidden');
            }

            // è‹¥æœ‰è¨ºç—‡è¨˜éŒ„æŸ¥çœ‹å½ˆçª—æ­£åœ¨é¡¯ç¤ºï¼Œå‘¼å«é—œé–‰å‡½å¼æˆ–ç›´æŽ¥éš±è—
            if (typeof closeMedicalHistoryModal === 'function') {
                closeMedicalHistoryModal();
            } else if (document.getElementById('medicalHistoryModal')) {
                document.getElementById('medicalHistoryModal').classList.add('hidden');
            }

            // è‹¥æœ‰ç—…äººç—…æ­·æŸ¥çœ‹å½ˆçª—æ­£åœ¨é¡¯ç¤ºï¼Œå‘¼å«é—œé–‰å‡½å¼æˆ–ç›´æŽ¥éš±è—
            if (typeof closePatientMedicalHistoryModal === 'function') {
                closePatientMedicalHistoryModal();
            } else if (document.getElementById('patientMedicalHistoryModal')) {
                document.getElementById('patientMedicalHistoryModal').classList.add('hidden');
            }
        } catch (e) {
            console.warn('ç™»å‡ºæ™‚é—œé–‰è¨ºç—‡ç›¸é—œé¢æ¿æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
        }

        // æ¸…ç©ºç™»å…¥è¡¨å–®
        document.getElementById('mainLoginUsername').value = '';
        document.getElementById('mainLoginPassword').value = '';
        
        showToast('å·²æˆåŠŸç™»å‡º', 'success');
        
    } catch (error) {
        console.error('ç™»å‡ºéŒ¯èª¤:', error);
        showToast('ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

        // ç”Ÿæˆå´é‚Šé¸å–®
        function generateSidebarMenu() {
            const menuContainer = document.getElementById('sidebarMenu');
            menuContainer.innerHTML = '';

            // å®šç¾©å„å€‹åŠŸèƒ½çš„æ¨™é¡Œã€åœ–ç¤ºåŠèªªæ˜Ž
            const menuItems = {
                patientManagement: { title: 'ç—…äººè³‡æ–™ç®¡ç†', icon: 'ðŸ‘¥', description: 'æ–°å¢žã€æŸ¥çœ‹ã€ç®¡ç†ç—…äººè³‡æ–™' },
                consultationSystem: { title: 'è¨ºç—‡ç³»çµ±', icon: 'ðŸ©º', description: 'è¨˜éŒ„ç—‡ç‹€ã€è¨ºæ–·ã€é–‹ç«‹è™•æ–¹' },
                herbLibrary: { title: 'ä¸­è—¥åº«', icon: 'ðŸŒ¿', description: 'æŸ¥çœ‹ä¸­è—¥æåŠæ–¹åŠ‘è³‡æ–™' },
                // æ–°å¢žï¼šç©´ä½åº«ç®¡ç†
                acupointLibrary: { title: 'ç©´ä½åº«', icon: 'ðŸ“Œ', description: 'æŸ¥çœ‹ç©´ä½è³‡æ–™' },
                // æ–°å¢žï¼šé†«ç™‚æŽ’ç­ç®¡ç†åŠŸèƒ½
                scheduleManagement: { title: 'é†«ç™‚æŽ’ç­', icon: 'ðŸ“…', description: 'æŽ’ç­èˆ‡è¡Œäº‹æ›†æŸ¥çœ‹' },
                // æ–°å¢žï¼šç—…æ­·ç®¡ç†åŠŸèƒ½
                medicalRecordManagement: { title: 'ç—…æ­·ç®¡ç†', icon: 'ðŸ“‹', description: 'æŸ¥çœ‹åŠæœå°‹ç—…æ­·' },
                billingManagement: { title: 'æ”¶è²»é …ç›®ç®¡ç†', icon: 'ðŸ’°', description: 'ç®¡ç†è¨ºç™‚è²»ç”¨åŠæ”¶è²»é …ç›®' },
                // å°‡è¨ºæ‰€ç”¨æˆ¶ç®¡ç†çš„åœ–ç¤ºæ›´æ–°ç‚ºå–®äººç¬¦è™Ÿï¼Œä»¥ç¬¦åˆäº¤æ›å¾Œçš„é…ç½®
                userManagement: { title: 'è¨ºæ‰€ç”¨æˆ¶ç®¡ç†', icon: 'ðŸ‘¤', description: 'ç®¡ç†è¨ºæ‰€ç”¨æˆ¶æ¬Šé™' },
                financialReports: { title: 'è²¡å‹™å ±è¡¨', icon: 'ðŸ“Š', description: 'æ”¶å…¥åˆ†æžèˆ‡è²¡å‹™çµ±è¨ˆ' },
                systemManagement: { title: 'ç³»çµ±ç®¡ç†', icon: 'âš™ï¸', description: 'çµ±è¨ˆè³‡æ–™ã€å‚™ä»½åŒ¯å‡º' },
                // æ–°å¢žï¼šå€‹äººçµ±è¨ˆåˆ†æžï¼ˆä½¿ç”¨æ¢å½¢åœ–ç¬¦è™Ÿä½œç‚ºåœ–ç¤ºï¼‰
                personalStatistics: { title: 'å€‹äººçµ±è¨ˆåˆ†æž', icon: 'ðŸ“ˆ', description: 'çµ±è¨ˆå€‹äººç”¨è—¥èˆ‡ç©´ä½åå¥½' },
                // æ–°å¢žï¼šå€‹äººè¨­ç½®ï¼ˆä½¿ç”¨æ‰³æ‰‹ç¬¦è™Ÿä½œç‚ºåœ–ç¤ºï¼‰
                personalSettings: { title: 'å€‹äººè¨­ç½®', icon: 'ðŸ”§', description: 'ç®¡ç†æ…£ç”¨è—¥æ–¹åŠç©´ä½çµ„åˆ' },
                // æ–°å¢žï¼šå¸³è™Ÿå®‰å…¨è¨­å®šï¼ˆè®Šæ›´å¯†ç¢¼èˆ‡åˆªé™¤å¸³è™Ÿï¼‰
                accountSecurity: { title: 'å¸³è™Ÿå®‰å…¨è¨­å®š', icon: 'ðŸ”', description: 'è®Šæ›´å¯†ç¢¼åŠåˆªé™¤å¸³è™Ÿ' },
                // æ–°å¢žï¼šæ¨¡æ¿åº«ç®¡ç†
                templateLibrary: { title: 'æ¨¡æ¿åº«', icon: 'ðŸ“š', description: 'æŸ¥çœ‹é†«å›‘èˆ‡è¨ºæ–·æ¨¡æ¿' }
            };

            // æ ¹æ“šç•¶å‰ç”¨æˆ¶è·ä½æ±ºå®šå¯ä½¿ç”¨çš„åŠŸèƒ½åˆ—è¡¨
            const userPosition = (currentUserData && currentUserData.position) || '';
            const permissions = ROLE_PERMISSIONS[userPosition] || [];

            // ä¾åºå»ºç«‹å´é‚Šé¸å–®æŒ‰éˆ•ï¼ˆå†æ¬¡æª¢æŸ¥æ¬Šé™ï¼‰
            permissions.forEach(permission => {
                const item = menuItems[permission];
                if (!item) return;
                // é¿å…é¡¯ç¤ºç„¡æ¬Šå­˜å–çš„åŠŸèƒ½
                if (!hasAccessToSection(permission)) return;
                const button = document.createElement('button');
                // ç§»é™¤é è¨­ margin-bottomï¼Œæ”¹ç”±å¤–å±¤å®¹å™¨æŽ§åˆ¶é–“è·ï¼Œä½¿é¸å–®é …ç›®æ›´åŠ æ•´é½Š
                button.className = 'w-full text-left p-4 rounded-lg hover:bg-gray-100 transition duration-200 border border-gray-200';
                button.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-4">${item.icon}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${item.title}</div>
                            <div class="text-sm text-gray-600">${item.description}</div>
                        </div>
                    </div>
                `;
                button.onclick = () => {
                    showSection(permission);
                    toggleSidebar();
                };
                menuContainer.appendChild(button);
            });
        }

        /**
         * åˆ¤æ–·ç•¶å‰ç”¨æˆ¶æ˜¯å¦å…·å‚™æŒ‡å®šçš„è§’è‰²æ¬Šé™ã€‚
         *
         * åœ¨å¤šè™•éœ€è¦æª¢æŸ¥ç”¨æˆ¶è§’è‰²æ˜¯å¦ç¬¦åˆå­˜å–è³‡æ ¼ï¼Œæ•…æŠ½å‡ºæ­¤å‡½å¼ç°¡åŒ–æ¢ä»¶åˆ¤æ–·ã€‚
         *
         * @param {string[]} allowedRoles å…è¨±å­˜å–çš„è·ä½é™£åˆ—
         * @returns {boolean} è‹¥ç•¶å‰ç”¨æˆ¶å­˜åœ¨ä¸”è·ä½åœ¨å…è¨±åå–®ä¸­å‰‡å›žå‚³ true
         */

        // é¡¯ç¤ºæŒ‡å®šå€åŸŸ
        function showSection(sectionId) {
            // çµ±ä¸€æ¬Šé™æª¢æŸ¥ï¼šè‹¥æ²’æœ‰æ¬Šé™å‰‡æç¤ºä¸¦è¿”å›ž
            if (!hasAccessToSection(sectionId)) {
                showToast('æ¬Šé™ä¸è¶³ï¼Œæ‚¨æ²’æœ‰å­˜å–æ­¤åŠŸèƒ½çš„æ¬Šé™', 'error');
                return;
            }
            hideAllSections();

            // æ ¹æ“šæ‰€é¸çš„å€åŸŸæ±ºå®šæ˜¯å¦é¡¯ç¤ºä¸»è¦å…§å®¹åŒ…è£å€ï¼ˆcontentWrapperï¼‰ã€‚
            // ç•¶é¡¯ç¤ºå€‹äººè¨­ç½®æˆ–æ¨¡æ¿åº«ç®¡ç†æ™‚ï¼Œéš±è—åŒ…è£å€ä»¥é¿å…ç”¢ç”Ÿé¡å¤–çš„ä¸Šæ–¹ç•™ç™½ï¼›
            // å…¶ä»–å€åŸŸå‰‡é¡¯ç¤ºåŒ…è£å€ï¼Œä¿æŒèˆ‡åŽŸå…ˆç‰ˆé¢ä¸€è‡´ã€‚
            try {
                const wrapper = document.getElementById('contentWrapper');
                if (wrapper) {
                    if (sectionId === 'personalSettings' || sectionId === 'templateLibrary') {
                        wrapper.classList.add('hidden');
                    } else {
                        wrapper.classList.remove('hidden');
                    }
                }
            } catch (e) {
                console.error('åˆ‡æ›å€åŸŸæ™‚èª¿æ•´ç‰ˆé¢é¡¯ç¤ºå¤±æ•—ï¼š', e);
            }
            // éš±è—æ­¡è¿Žé 
            document.getElementById('welcomePage').classList.add('hidden');
            // é¡¯ç¤ºæŒ‡å®šå€åŸŸ
            const sectionEl = document.getElementById(sectionId);
            if (sectionEl) sectionEl.classList.remove('hidden');
            // æ ¹æ“š sectionId è¼‰å…¥ç›¸æ‡‰åŠŸèƒ½
            if (sectionId === 'patientManagement') {
                // è¼‰å…¥ç—…äººåˆ—è¡¨å¾Œè¨­ç½®å³æ™‚ç›£è½ï¼Œç¢ºä¿ä»–äººæ–°å¢žæˆ–ç·¨è¼¯ç—…äººè³‡æ–™æ™‚èƒ½å³æ™‚æ›´æ–°ç•«é¢ã€‚
                loadPatientList();
                attachPatientListListener();
            } else if (sectionId === 'consultationSystem') {
                loadConsultationSystem();
            } else if (sectionId === 'herbLibrary') {
                loadHerbLibrary();
            } else if (sectionId === 'acupointLibrary') {
                loadAcupointLibrary();
            } else if (sectionId === 'scheduleManagement') {
                // åƒ…åœ¨ä½¿ç”¨è€…é€²å…¥é†«ç™‚æŽ’ç­å€åŸŸæ™‚æ‰åˆå§‹åŒ–æŽ’ç­ç³»çµ±ã€‚
                if (typeof window.initializeScheduleManagement === 'function') {
                    window.initializeScheduleManagement();
                }
                // å³ä½¿ç³»çµ±å·²åˆå§‹åŒ–ï¼Œä¹Ÿåœ¨æ¯æ¬¡é€²å…¥æŽ’ç­ç®¡ç†æ™‚æ›´æ–°ç®¡ç†å“¡ UI
                if (typeof window.scheduleUpdateAdminUI === 'function') {
                    try {
                        window.scheduleUpdateAdminUI();
                    } catch (uiErr) {
                        console.warn('Failed to update admin UI in navigateTo', uiErr);
                    }
                }
            } else if (sectionId === 'medicalRecordManagement') {
                // è¼‰å…¥ç—…æ­·ç®¡ç†é é¢
                if (typeof loadMedicalRecordManagement === 'function') {
                    loadMedicalRecordManagement();
                }
            } else if (sectionId === 'billingManagement') {
                loadBillingManagement();
            } else if (sectionId === 'financialReports') {
                loadFinancialReports();
            } else if (sectionId === 'userManagement') {
                loadUserManagement();
            } else if (sectionId === 'personalStatistics') {
                // è¼‰å…¥å€‹äººçµ±è¨ˆåˆ†æž
                if (typeof loadPersonalStatistics === 'function') {
                    loadPersonalStatistics();
                }
            } else if (sectionId === 'accountSecurity') {
                // è¼‰å…¥å¸³è™Ÿå®‰å…¨è¨­å®šï¼šç›®å‰åƒ…éœ€è¦æ¸…é™¤è¡¨å–®è¼¸å…¥
                if (typeof loadAccountSecurity === 'function') {
                    loadAccountSecurity();
                }
            }
        }

        // éš±è—æ‰€æœ‰å€åŸŸ
        function hideAllSections() {
            // éš±è—æ‰€æœ‰å€åŸŸï¼ŒåŒ…æ‹¬æ–°å¢žçš„å€‹äººè¨­ç½®èˆ‡æ¨¡æ¿åº«ç®¡ç†
            // æŒ‰ç…§æ–°çš„å´é‚Šé¸å–®æŽ’åºéš±è—å€åŸŸï¼š
            // ç—…æ­·ç®¡ç†æ‡‰ä½æ–¼è¨ºç—‡ç³»çµ±ä¹‹å¾Œï¼Œæ¨¡æ¿åº«æ‡‰ä½æ–¼ç©´ä½åº«ä¹‹å¾Œã€‚
            // å› æ­¤èª¿æ•´é †åºç‚º patientManagement -> consultationSystem -> medicalRecordManagement -> herbLibrary -> acupointLibrary -> templateLibrary -> scheduleManagement -> å…¶ä»–ç®¡ç†é …
            ['patientManagement', 'consultationSystem', 'medicalRecordManagement', 'herbLibrary', 'acupointLibrary', 'templateLibrary', 'scheduleManagement', 'billingManagement', 'userManagement', 'financialReports', 'systemManagement', 'personalSettings', 'personalStatistics', 'accountSecurity', 'welcomePage'].forEach(id => {
                // åœ¨éš±è—ä¸­è—¥åº«æ™‚ï¼Œå–æ¶ˆå…¶è³‡æ–™ç›£è½ä»¥æ¸›å°‘ Realtime Database è®€å–
                if (id === 'herbLibrary') {
                    try {
                        if (typeof herbInventoryListenerAttached !== 'undefined' && herbInventoryListenerAttached) {
                            // ä½¿ç”¨å…ˆå‰å­˜å„²çš„åƒè€ƒå–æ¶ˆç›£è½
                            if (window.herbInventoryRef) {
                                window.firebase.off(window.herbInventoryRef, 'value');
                            } else {
                                // å‚™æ´ä½œæ³•ï¼šé‡æ–°å–å¾—åƒè€ƒä¸¦å–æ¶ˆ
                                const tempRef = window.firebase.ref(window.firebase.rtdb, 'herbInventory');
                                window.firebase.off(tempRef, 'value');
                            }
                            herbInventoryListenerAttached = false;
                        }
                    } catch (err) {
                        console.error('é›¢é–‹ä¸­è—¥åº«æ™‚å–æ¶ˆç›£è½å¤±æ•—:', err);
                    }
                }
                // åœ¨éš±è—æŽ›è™Ÿç³»çµ±æ™‚ï¼Œå–æ¶ˆæŽ›è™Ÿçš„ Realtime Database ç›£è½ï¼Œæ¸›å°‘è®€å–
                if (id === 'consultationSystem') {
                    try {
                        if (window.appointmentsListenerAttached && window.appointmentsQuery && window.appointmentsListener) {
                            window.firebase.off(window.appointmentsQuery, 'value', window.appointmentsListener);
                            window.appointmentsListenerAttached = false;
                        }
                    } catch (err) {
                        console.error('é›¢é–‹æŽ›è™Ÿç³»çµ±æ™‚å–æ¶ˆæŽ›è™Ÿç›£è½å¤±æ•—:', err);
                    }
                }
                // é›¢é–‹ç—…äººè³‡æ–™ç®¡ç†æ™‚ï¼Œå–æ¶ˆç—…äººåˆ—è¡¨çš„ç›£è½ï¼Œä»¥æ¸›å°‘ Firestore è®€å–
                if (id === 'patientManagement') {
                    try {
                        detachPatientListListener();
                    } catch (err) {
                        console.error('é›¢é–‹ç—…äººç®¡ç†æ™‚å–æ¶ˆç—…äººç›£è½å¤±æ•—:', err);
                    }
                }
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }

        /**
         * æ ¹æ“šç•¶å‰ç”¨æˆ¶æ¬Šé™ï¼Œéš±è—æ­¡è¿Žé é¢ä¸­ç„¡æ³•å­˜å–çš„åŠŸèƒ½å¡ç‰‡ã€‚
         */
        function updateWelcomeCards() {
            const welcomePageEl = document.getElementById('welcomePage');
            if (!welcomePageEl) return;
            const cards = welcomePageEl.querySelectorAll('.grid > div');
            cards.forEach(card => {
                const titleEl = card.querySelector('.font-semibold');
                const title = titleEl && titleEl.textContent ? titleEl.textContent.trim() : '';
                let sectionId = null;
                switch (title) {
                    case 'ç—…äººè³‡æ–™ç®¡ç†':
                        sectionId = 'patientManagement';
                        break;
                    case 'è¨ºç—‡ç³»çµ±':
                        sectionId = 'consultationSystem';
                        break;
                    case 'ç”¨æˆ¶ç®¡ç†':
                        sectionId = 'userManagement';
                        break;
                    case 'ç³»çµ±ç®¡ç†':
                        sectionId = 'systemManagement';
                        break;
                    default:
                        sectionId = null;
                }
                if (sectionId && !hasAccessToSection(sectionId)) {
                    card.classList.add('hidden');
                } else {
                    card.classList.remove('hidden');
                }
            });
        }

        // ç—…äººç®¡ç†åŠŸèƒ½
        let editingPatientId = null;
        let filteredPatients = [];
        
        // æ›´æ–°ç—…äººå¹´é½¡é¡¯ç¤º
        function updatePatientAge() {
            const birthDate = document.getElementById('patientBirthDate').value;
            const ageInput = document.getElementById('patientAge');
            
            if (birthDate) {
                const age = calculateAge(birthDate);
                ageInput.value = age;
            } else {
                ageInput.value = '';
            }
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = 'æ–°å¢žç—…äººè³‡æ–™';
            document.getElementById('saveButtonText').textContent = 'å„²å­˜';
            document.getElementById('addPatientModal').classList.remove('hidden');
            clearPatientForm();
        }

        function hideAddPatientForm() {
            document.getElementById('addPatientModal').classList.add('hidden');
            clearPatientForm();
            editingPatientId = null;
        }

        function clearPatientForm() {
            ['patientName', 'patientAge', 'patientGender', 'patientPhone', 'patientIdCard', 'patientBirthDate', 'patientAddress', 'patientAllergies', 'patientHistory'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

async function savePatient() {
    const patient = {
        name: document.getElementById('patientName').value.trim(),
        age: document.getElementById('patientAge').value,
        gender: document.getElementById('patientGender').value,
        phone: document.getElementById('patientPhone').value.trim(),
        idCard: document.getElementById('patientIdCard').value.trim(),
        birthDate: document.getElementById('patientBirthDate').value,
        address: document.getElementById('patientAddress').value.trim(),
        allergies: document.getElementById('patientAllergies').value.trim(),
        history: document.getElementById('patientHistory').value.trim()
    };

    // é©—è­‰å¿…å¡«æ¬„ä½ï¼šå§“åã€æ€§åˆ¥ã€é›»è©±ã€å‡ºç”Ÿæ—¥æœŸèˆ‡èº«åˆ†è­‰å­—è™Ÿ
    if (!patient.name || !patient.gender || !patient.phone || !patient.birthDate || !patient.idCard) {
        showToast('è«‹å¡«å¯«å¿…è¦è³‡æ–™ï¼ˆå§“åã€æ€§åˆ¥ã€é›»è©±ã€å‡ºç”Ÿæ—¥æœŸã€èº«åˆ†è­‰å­—è™Ÿï¼‰ï¼', 'error');
        return;
    }

    // é©—è­‰é›»è©±æ ¼å¼ï¼šåƒ…å…è¨±æ•¸å­—ï¼Œå¯æŽ¥å— 7~15 ä½
    const phonePattern = /^\d{7,15}$/;
    if (!phonePattern.test(patient.phone)) {
        showToast('é›»è©±æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥ 7-15 ä½æ•¸å­—ï¼', 'error');
        return;
    }

    // é©—è­‰å‡ºç”Ÿæ—¥æœŸ
    const birthDate = new Date(patient.birthDate);
    const today = new Date();
    if (birthDate > today) {
        showToast('å‡ºç”Ÿæ—¥æœŸä¸èƒ½æ™šæ–¼ä»Šå¤©ï¼', 'error');
        return;
    }

    // è¨ˆç®—å¹´é½¡
    const calculatedAge = calculateAge(patient.birthDate);
    if (calculatedAge > 120) {
        showToast('è«‹ç¢ºèªå‡ºç”Ÿæ—¥æœŸæ˜¯å¦æ­£ç¢ºï¼', 'error');
        return;
    }

    // é©—è­‰é›»è©±æ ¼å¼
    const phoneRegex = /^[0-9\-\+\(\)\s]+$/;
    if (!phoneRegex.test(patient.phone)) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼ï¼', 'error');
        return;
    }

    // ä¸é™åˆ¶èº«åˆ†è­‰å­—è™Ÿæ ¼å¼ï¼Œå› æ­¤ç„¡éœ€æª¢æŸ¥æ ¼å¼

    // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹ï¼šæ ¹æ“šæ˜¯æ–°å¢žæˆ–æ›´æ–°é¡¯ç¤ºä¸åŒæ–‡å­—
    // ç”±æ–¼æŒ‰éˆ•ä¸å†ä½¿ç”¨ inline onclick äº‹ä»¶ï¼Œå˜—è©¦ç›´æŽ¥é€éŽæŒ‰éˆ• ID å–å¾—å…ƒç´ ã€‚è‹¥ä»æ‰¾ä¸åˆ°ï¼Œé€€å›žå…ˆå‰çš„æŸ¥æ‰¾æ–¹å¼ã€‚
    const saveButton = document.getElementById('savePatientButton') || document.querySelector('[onclick="savePatient()"]');
    if (saveButton) {
        // è‹¥æ­£åœ¨ç·¨è¼¯ï¼Œé¡¯ç¤ºã€Œæ›´æ–°ä¸­...ã€ï¼Œå¦å‰‡é¡¯ç¤ºã€Œå„²å­˜ä¸­...ã€
        const loadingText = (typeof editingPatientId !== 'undefined' && editingPatientId) ? 'æ›´æ–°ä¸­...' : 'å„²å­˜ä¸­...';
        setButtonLoading(saveButton, loadingText);
    }

    try {
        if (editingPatientId) {
            // æ›´æ–°ç¾æœ‰ç—…äºº
            const result = await window.firebaseDataManager.updatePatient(editingPatientId, patient);
            if (result.success) {
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } else {
                showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }
        } else {
            // æ–°å¢žç—…äºº
            // ç”Ÿæˆç—…äººç·¨è™Ÿ
            patient.patientNumber = await generatePatientNumberFromFirebase();
            
            const result = await window.firebaseDataManager.addPatient(patient);
            if (result.success) {
                showToast('ç—…äººè³‡æ–™å·²æˆåŠŸæ–°å¢žï¼', 'success');
            } else {
                showToast('æ–°å¢žå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }
        }

        // æ›´æ–°å¿«å–è³‡æ–™ï¼Œä¸‹ä¸€æ¬¡è®€å–æ™‚é‡æ–°è¼‰å…¥
        // æ–°å¢žæˆ–æ›´æ–°ç—…äººå¾Œï¼Œé™¤äº†æ¸…é™¤ç—…äººåˆ—è¡¨å¿«å–ä¹‹å¤–ï¼Œ
        // ä¹Ÿæ‡‰æ¸…é™¤åˆ†é æ¸¸æ¨™èˆ‡ç—…äººæ•¸é‡å¿«å–ï¼Œ
        // ä»¥é¿å…æ–°å¢žæˆ–æ›´æ–°çš„è³‡æ–™æœªç«‹å³åæ˜ åœ¨åˆ—è¡¨ä¸Šã€‚
        patientCache = null;
        // æ¸…é™¤åˆ†é å¿«å–ï¼ŒåŒ…å«æ¯é è³‡æ–™èˆ‡æ¸¸æ¨™
        if (typeof patientPagesCache === 'object') {
            patientPagesCache = {};
        }
        if (typeof patientPageCursors === 'object') {
            patientPageCursors = {};
        }
        // æ¸…é™¤ç—…äººç¸½æ•¸å¿«å–ä»¥é‡æ–°è¨ˆç®—é æ•¸
        patientsCountCache = null;

        // é‡æ–°è¼‰å…¥ç—…äººåˆ—è¡¨
        await loadPatientListFromFirebase();
        hideAddPatientForm();
        updateStatistics();

    } catch (error) {
        console.error('ä¿å­˜ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('ä¿å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    } finally {
        // é‚„åŽŸæŒ‰éˆ•ç‹€æ…‹èˆ‡å…§å®¹
        if (saveButton) {
            clearButtonLoading(saveButton);
        }
    }

    } // end of savePatient function

        // å¾ž Firebase ç”Ÿæˆç—…äººç·¨è™Ÿ
async function generatePatientNumberFromFirebase() {
    try {
        // å–å¾—ç—…äººåˆ—è¡¨æ™‚å¼·åˆ¶åˆ·æ–°ï¼Œé¿å…è·¨è£ç½®å¿«å–å°Žè‡´å–å¾—èˆŠç—…äººæ•¸
        const result = await safeGetPatients(true);
        if (!result.success) {
            return 'P000001'; // å¦‚æžœç„¡æ³•è®€å–ï¼Œä½¿ç”¨é è¨­ç·¨è™Ÿ
        }

        const existingNumbers = result.data
            .map(p => p.patientNumber)
            .filter(num => num && num.startsWith('P'))
            .map(num => parseInt(num.substring(1)))
            .filter(num => !isNaN(num));

        const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
        const newNumber = maxNumber + 1;
        return `P${newNumber.toString().padStart(6, '0')}`;
    } catch (error) {
        console.error('ç”Ÿæˆç—…äººç·¨è™Ÿå¤±æ•—:', error);
        return `P${Date.now().toString().slice(-6)}`; // å‚™ç”¨æ–¹æ¡ˆ
    }
}

// å¾ž Firebase è¼‰å…¥ç—…äººåˆ—è¡¨
async function loadPatientListFromFirebase() {
    const tbody = document.getElementById('patientList');
    if (!tbody) return;
    const searchInput = document.getElementById('searchPatient');
    const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
    try {
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    <div class="mt-2">è¼‰å…¥ä¸­...</div>
                </td>
            </tr>
        `;
        // è‹¥æœ‰æœå°‹å­—ä¸²ï¼Œé€éŽ Firestore æœå°‹é—œéµå­—
        if (searchTerm) {
            // ä½¿ç”¨è‡ªè¨‚æœå°‹å‡½å¼é¿å…ä¸€æ¬¡è¼‰å…¥æ•´å€‹ç—…äººé›†åˆ
            let searchResult;
            try {
                searchResult = await window.firebaseDataManager.searchPatients(searchTerm, 50);
            } catch (_searchErr) {
                console.error('æœå°‹ç—…äººæ™‚ç™¼ç”ŸéŒ¯èª¤:', _searchErr);
            }
            let filteredPatients = (searchResult && searchResult.success && Array.isArray(searchResult.data)) ? searchResult.data : [];
            // ç‚ºç¢ºä¿ã€Œç·¨è™Ÿæœ€æ–°ã€çš„ç—…äººå„ªå…ˆé¡¯ç¤ºï¼Œæ”¹ç‚ºä¾ç…§ç—…äººç·¨è™ŸæŽ’åºã€‚
            // patientNumber æ ¼å¼ç‚º 'P' åŠ ä¸Šæ•¸å­—ï¼Œä¾‹å¦‚ 'P000001'ã€‚
            // è§£æžæ•¸å­—ä¸¦ä»¥é™åºæŽ’åˆ—ï¼Œæ²’æœ‰æœ‰æ•ˆç·¨è™Ÿçš„ç—…äººè¦–ç‚º 0ã€‚
            filteredPatients = filteredPatients.slice();
            filteredPatients.sort((a, b) => {
                const numA = (() => {
                    const pn = a && a.patientNumber ? String(a.patientNumber) : '';
                    const match = pn.match(/\d+/);
                    return match ? parseInt(match[0], 10) : 0;
                })();
                const numB = (() => {
                    const pn = b && b.patientNumber ? String(b.patientNumber) : '';
                    const match = pn.match(/\d+/);
                    return match ? parseInt(match[0], 10) : 0;
                })();
                return numB - numA;
            });
            patientListFiltered = filteredPatients;
            renderPatientListTable(false);
        } else {
            // ç„¡æœå°‹æ¢ä»¶ï¼Œä½¿ç”¨ä¼ºæœå™¨åˆ†é ä»¥æ¸›å°‘è®€å–é‡
            // å–å¾—ç•¶å‰é ç¢¼ï¼›è‹¥æœªè¨­å®šå‰‡é è¨­ç‚ºç¬¬ä¸€é 
            const currentPage = (paginationSettings && paginationSettings.patientList && paginationSettings.patientList.currentPage) || 1;
            // é€éŽåˆ†é å‡½å¼è®€å–ç•¶å‰é çš„ç—…äººè³‡æ–™
            const pageItems = await fetchPatientsPage(currentPage);
            // å–å¾—ç—…äººç¸½æ•¸ï¼Œç”¨æ–¼è¨ˆç®—ç¸½é æ•¸
            const totalCount = await getPatientsCount();
            // æ¸²æŸ“ç•¶å‰é é¢è³‡æ–™åŠåˆ†é æŽ§åˆ¶
            renderPatientListPage(pageItems, totalCount, currentPage);
        }
    } catch (error) {
        console.error('è¼‰å…¥ç—…äººåˆ—è¡¨éŒ¯èª¤:', error);
        const msg = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æŽ¥
                </td>
            </tr>
        `;
        tbody.innerHTML = msg;
    }
}

function loadPatientList() {
    loadPatientListFromFirebase();
}

/**
 * æ ¹æ“šç•¶å‰çš„ patientListFiltered å…§å®¹æ¸²æŸ“ç—…äººåˆ—è¡¨ï¼Œæ”¯æ´åˆ†é ã€‚
 * åœ¨éžåˆ†é è·³è½‰æƒ…æ³ä¸‹æœƒå°‡é ç¢¼é‡ç½®ç‚ºç¬¬ä¸€é ã€‚
 * @param {boolean} pageChange æ˜¯å¦ç‚ºåˆ†é é»žæ“Šå°Žè‡´çš„é‡æ–°æ¸²æŸ“
 */
function renderPatientListTable(pageChange = false) {
    const tbody = document.getElementById('patientList');
    if (!tbody) return;
    // è‹¥ç„¡ç—…äººè³‡æ–™
    if (!Array.isArray(patientListFiltered) || patientListFiltered.length === 0) {
        const searchTermEl = document.getElementById('searchPatient');
        const searchTerm = searchTermEl ? searchTermEl.value.toLowerCase() : '';
        tbody.innerHTML = `
            <tr>
                <!-- èª¿æ•´ colspan ä»¥ç¬¦åˆå¢žåŠ çš„å»ºæª”æ—¥æœŸæ¬„ä½ -->
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    ${searchTerm ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº' : 'å°šç„¡ç—…äººè³‡æ–™'}
                </td>
            </tr>
        `;
        const paginEl = ensurePaginationContainer('patientList', 'patientListPagination');
        if (paginEl) {
            paginEl.innerHTML = '';
            paginEl.classList.add('hidden');
        }
        return;
    }
    // åˆ†é ï¼šéžé é¢è·³è½‰æ™‚é‡ç½®ç•¶å‰é 
    if (!pageChange) {
        paginationSettings.patientList.currentPage = 1;
    }
    // åœ¨æ¸²æŸ“è¡¨æ ¼ä¹‹å‰ï¼Œæ ¹æ“šç—…äººç·¨è™Ÿç”±æ–°åˆ°èˆŠæŽ’åºç—…äººè³‡æ–™ã€‚
    // ç”±æ–¼ patientListFiltered å¯èƒ½å·²ç¶“æŒ‰ç…§å…¶ä»–æ¢ä»¶æŽ’åºï¼Œåœ¨é€™è£¡é¡å¤–æŽ’åºå¯ä»¥
    // ç¢ºä¿ã€Œç·¨è™Ÿæœ€æ–°ã€çš„ç—…äººé¡¯ç¤ºåœ¨åˆ—è¡¨ä¸Šæ–¹ã€‚ç•¶ patientNumber ä¸å­˜åœ¨æ™‚è¦–ç‚º 0ã€‚
    if (Array.isArray(patientListFiltered) && patientListFiltered.length > 1) {
        patientListFiltered.sort((a, b) => {
            const numA = (() => {
                const pn = a && a.patientNumber ? String(a.patientNumber) : '';
                const match = pn.match(/\d+/);
                return match ? parseInt(match[0], 10) : 0;
            })();
            const numB = (() => {
                const pn = b && b.patientNumber ? String(b.patientNumber) : '';
                const match = pn.match(/\d+/);
                return match ? parseInt(match[0], 10) : 0;
            })();
            return numB - numA;
        });
    }
    const totalItems = patientListFiltered.length;
    const itemsPerPage = paginationSettings.patientList.itemsPerPage;
    let currentPage = paginationSettings.patientList.currentPage;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages) currentPage = totalPages;
    paginationSettings.patientList.currentPage = currentPage;
    const startIdx = (currentPage - 1) * itemsPerPage;
    const endIdx = startIdx + itemsPerPage;
    const pageItems = patientListFiltered.slice(startIdx, endIdx);
    // æ¸…ç©ºè¡¨æ ¼
    tbody.innerHTML = '';
    // åˆ¤æ–·ç•¶å‰ç”¨æˆ¶æ˜¯å¦å…·æœ‰åˆªé™¤ç—…äººæ¬Šé™
    // åˆªé™¤æ¬Šé™é–‹æ”¾çµ¦è¨ºæ‰€ç®¡ç†è€…ã€è­·ç†å¸«èˆ‡é†«å¸«
    const showDelete = currentUserData && currentUserData.position && ['è¨ºæ‰€ç®¡ç†', 'è­·ç†å¸«', 'é†«å¸«'].includes(currentUserData.position.trim());
    // æ¸²æŸ“ç•¶å‰é ç—…äººè³‡æ–™
    pageItems.forEach(patient => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        // è½‰ç¾©é¡¯ç¤ºçš„å€¼ï¼Œé¿å… XSS
        const safeNumber = window.escapeHtml(patient.patientNumber || 'æœªè¨­å®š');
        const safeName = window.escapeHtml(patient.name);
        const safeAge = window.escapeHtml(formatAge(patient.birthDate));
        const safeGender = window.escapeHtml(patient.gender);
        const safePhone = window.escapeHtml(patient.phone);
        // å–å¾—å»ºæª”æ—¥æœŸï¼Œåªé¡¯ç¤ºå¹´æœˆæ—¥ï¼Œä¸é¡¯ç¤ºæ™‚é–“
        let createdAtDateStr = '';
        if (patient && patient.createdAt) {
            let d;
            if (typeof patient.createdAt.seconds !== 'undefined') {
                d = new Date(patient.createdAt.seconds * 1000);
            } else {
                d = new Date(patient.createdAt);
            }
            if (d instanceof Date && !isNaN(d)) {
                // æ ¹æ“šç›®å‰èªžè¨€é¸æ“‡é©ç•¶çš„åœ¨åœ°åŒ–æ ¼å¼
                const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
                const locale = lang === 'en' ? 'en-US' : 'zh-TW';
                createdAtDateStr = d.toLocaleDateString(locale, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }
        }
        const safeCreatedAt = window.escapeHtml(createdAtDateStr || '');
        // ä½¿ç”¨èˆ‡æŽ›è™Ÿç³»çµ±ç›¸åŒçš„æ·ºè‰²é…è‰²ï¼šæ·¡è‰²èƒŒæ™¯æ­é…æ·±è‰²æ–‡å­—
        let actions = `
                <button onclick="handleViewPatient(event, '${patient.id}')" class="text-blue-600 hover:text-blue-800 bg-blue-50 w-14 px-2 py-1 rounded text-xs transition duration-200">æŸ¥çœ‹</button>
                <button onclick="handleShowMedicalHistory(event, '${patient.id}')" class="text-purple-600 hover:text-purple-800 bg-purple-50 w-14 px-2 py-1 rounded text-xs transition duration-200">ç—…æ­·</button>
                <button onclick="handleEditPatient(event, '${patient.id}')" class="text-green-600 hover:text-green-800 bg-green-50 w-14 px-2 py-1 rounded text-xs transition duration-200">ç·¨è¼¯</button>
        `;
        if (showDelete) {
            // åˆªé™¤æŒ‰éˆ•ä¹ŸæŽ¡ç”¨æ·ºè‰²é…è‰²
            actions += `
                <button onclick="handleDeletePatient(event, '${patient.id}')" class="text-red-600 hover:text-red-800 bg-red-50 w-14 px-2 py-1 rounded text-xs transition duration-200">åˆªé™¤</button>
            `;
        }
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-blue-600 font-medium">${safeNumber}</td>
            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${safeName}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safeAge}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safeGender}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safePhone}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safeCreatedAt}</td>
            <!--
              å°‡æ“ä½œæŒ‰éˆ•å®¹å™¨è¨­ç½®ç‚º flex ä¸¦åŠ å…¥ whitespace-nowrapï¼Œ
              ä»¥é¿å…åœ¨æŒ‰éˆ•é¡¯ç¤ºè®€å–åœˆæ™‚é€ æˆæ›è¡Œã€‚space-x-2
              ç”¨æ–¼æŒ‰éˆ•é–“è·ï¼Œitems-center ä½¿æŒ‰éˆ•åž‚ç›´å°é½Šã€‚
            -->
            <td class="px-4 py-3 text-sm whitespace-nowrap">
                <div class="flex items-center space-x-2">
                    ${actions}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    // åˆ†é æŽ§åˆ¶
    const paginEl = ensurePaginationContainer('patientList', 'patientListPagination');
    renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
        paginationSettings.patientList.currentPage = newPage;
        renderPatientListTable(true);
    }, paginEl);
}

/**
 * æ¸²æŸ“ä¼ºæœå™¨åˆ†é çš„ç—…äººåˆ—è¡¨ã€‚
 * ç•¶æœå°‹æ¢ä»¶ç‚ºç©ºæ™‚ï¼Œä½¿ç”¨æ­¤å‡½å¼ä»¥é¿å…è¼‰å…¥æ•´å€‹é›†åˆã€‚
 *
 * @param {Array} pageItems ç•¶å‰é çš„ç—…äººè³‡æ–™é™£åˆ—
 * @param {number} totalItems å…¨éƒ¨ç—…äººçš„ç¸½æ•¸
 * @param {number} currentPage ç•¶å‰é ç¢¼ï¼ˆå¾ž 1 é–‹å§‹ï¼‰
 */
function renderPatientListPage(pageItems, totalItems, currentPage) {
    const tbody = document.getElementById('patientList');
    if (!tbody) return;
    // è‹¥æ²’æœ‰ä»»ä½•ç—…äººè³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
    if (!Array.isArray(pageItems) || pageItems.length === 0) {
        tbody.innerHTML = `
            <tr>
                <!-- èª¿æ•´ colspan ä»¥ç¬¦åˆå¢žåŠ çš„å»ºæª”æ—¥æœŸæ¬„ä½ -->
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    å°šç„¡ç—…äººè³‡æ–™
                </td>
            </tr>
        `;
        const paginEl = ensurePaginationContainer('patientList', 'patientListPagination');
        if (paginEl) {
            paginEl.innerHTML = '';
            paginEl.classList.add('hidden');
        }
        return;
    }
    // é‡æ–°æ¸²æŸ“è¡¨æ ¼å…§å®¹
    tbody.innerHTML = '';
    // åˆ¤æ–·æ˜¯å¦å…·æœ‰åˆªé™¤æ¬Šé™
    // åˆªé™¤æ¬Šé™é–‹æ”¾çµ¦è¨ºæ‰€ç®¡ç†è€…ã€è­·ç†å¸«èˆ‡é†«å¸«
    const showDelete = currentUserData && currentUserData.position && ['è¨ºæ‰€ç®¡ç†', 'è­·ç†å¸«', 'é†«å¸«'].includes(currentUserData.position.trim());
    // å…ˆæŒ‰ç…§ç—…äººç·¨è™Ÿå°‡é é¢é …ç›®ç”±æ–°åˆ°èˆŠæŽ’åºï¼Œç¢ºä¿æœ€æ–°ç·¨è™Ÿçš„ç—…äººä½æ–¼æœ€å‰é¢ã€‚
    let sortedPageItems;
    if (Array.isArray(pageItems) && pageItems.length > 1) {
        sortedPageItems = pageItems.slice().sort((a, b) => {
            const numA = (() => {
                const pn = a && a.patientNumber ? String(a.patientNumber) : '';
                const match = pn.match(/\d+/);
                return match ? parseInt(match[0], 10) : 0;
            })();
            const numB = (() => {
                const pn = b && b.patientNumber ? String(b.patientNumber) : '';
                const match = pn.match(/\d+/);
                return match ? parseInt(match[0], 10) : 0;
            })();
            return numB - numA;
        });
    } else {
        sortedPageItems = pageItems;
    }
    sortedPageItems.forEach(patient => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        // å®‰å…¨è½‰ç¾©é¡¯ç¤ºçš„å€¼
        const safeNumber = window.escapeHtml(patient.patientNumber || 'æœªè¨­å®š');
        const safeName = window.escapeHtml(patient.name);
        const safeAge = window.escapeHtml(formatAge(patient.birthDate));
        const safeGender = window.escapeHtml(patient.gender);
        const safePhone = window.escapeHtml(patient.phone);
        // å–å¾—å»ºæª”æ—¥æœŸï¼Œåªé¡¯ç¤ºå¹´æœˆæ—¥ï¼Œä¸é¡¯ç¤ºæ™‚é–“
        let createdAtDateStr = '';
        if (patient && patient.createdAt) {
            let d;
            if (typeof patient.createdAt.seconds !== 'undefined') {
                d = new Date(patient.createdAt.seconds * 1000);
            } else {
                d = new Date(patient.createdAt);
            }
            if (d instanceof Date && !isNaN(d)) {
                const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
                const locale = lang === 'en' ? 'en-US' : 'zh-TW';
                createdAtDateStr = d.toLocaleDateString(locale, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }
        }
        const safeCreatedAt = window.escapeHtml(createdAtDateStr || '');
        // ä½¿ç”¨è¼ƒæ·¡çš„èƒŒæ™¯è‰²ä½¿æŒ‰éˆ•ä¸é‚£éº¼é®®è‰·
        let actions = `
                <button onclick="handleViewPatient(event, '${patient.id}')" class="text-blue-600 hover:text-blue-800 bg-blue-50 w-14 px-2 py-1 rounded text-xs transition duration-200">æŸ¥çœ‹</button>
                <button onclick="handleShowMedicalHistory(event, '${patient.id}')" class="text-purple-600 hover:text-purple-800 bg-purple-50 w-14 px-2 py-1 rounded text-xs transition duration-200">ç—…æ­·</button>
                <button onclick="handleEditPatient(event, '${patient.id}')" class="text-green-600 hover:text-green-800 bg-green-50 w-14 px-2 py-1 rounded text-xs transition duration-200">ç·¨è¼¯</button>
        `;
        if (showDelete) {
            // åˆªé™¤æŒ‰éˆ•ä½¿ç”¨æ·¡è‰²é…è‰²ï¼Œèˆ‡å…¶ä»–æ“ä½œä¸€è‡´
            actions += `
                <button onclick="handleDeletePatient(event, '${patient.id}')" class="text-red-600 hover:text-red-800 bg-red-50 w-14 px-2 py-1 rounded text-xs transition duration-200">åˆªé™¤</button>
            `;
        }
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-blue-600 font-medium">${safeNumber}</td>
            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${safeName}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safeAge}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safeGender}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safePhone}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safeCreatedAt}</td>
            <!--
              å°‡æ“ä½œæŒ‰éˆ•æ”¾å…¥ flex å®¹å™¨ä¸¦è¨­å®š whitespace-nowrapï¼Œ
              é¿å…æŒ‰ä¸‹æŒ‰éˆ•æ™‚å› ç‚ºè®€å–åœˆæˆ–å¯¬åº¦è®ŠåŒ–è€Œæ›è¡Œã€‚
            -->
            <td class="px-4 py-3 text-sm whitespace-nowrap">
                <div class="flex items-center space-x-2">
                    ${actions}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    // åˆ†é æŽ§åˆ¶
    const paginEl = ensurePaginationContainer('patientList', 'patientListPagination');
    renderPagination(totalItems, paginationSettings.patientList.itemsPerPage, currentPage, function (newPage) {
        // æ›´æ–°ç•¶å‰é ç¢¼ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆä½¿ç”¨ä¼ºæœå™¨åˆ†é ï¼‰
        paginationSettings.patientList.currentPage = newPage;
        loadPatientList();
    }, paginEl);
}


        
async function editPatient(id) {
    try {
        // ä½¿ç”¨æ–°çš„ getPatientByIdWithRefresh å°‹æ‰¾ç—…äººï¼Œé¿å…å› å¿«å–æœªæ›´æ–°è€Œè®€å–ä¸åˆ°
        const patient = await getPatientByIdWithRefresh(id);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }

        editingPatientId = id;
        document.getElementById('formTitle').textContent = 'ç·¨è¼¯ç—…äººè³‡æ–™';
        document.getElementById('saveButtonText').textContent = 'æ›´æ–°';
        
        // å¡«å…¥ç¾æœ‰è³‡æ–™
        document.getElementById('patientName').value = patient.name || '';
        document.getElementById('patientGender').value = patient.gender || '';
        document.getElementById('patientPhone').value = patient.phone || '';
        document.getElementById('patientIdCard').value = patient.idCard || '';
        document.getElementById('patientBirthDate').value = patient.birthDate || '';
        document.getElementById('patientAddress').value = patient.address || '';
        document.getElementById('patientAllergies').value = patient.allergies || '';
        document.getElementById('patientHistory').value = patient.history || '';
        
        // è‡ªå‹•è¨ˆç®—å¹´é½¡
        updatePatientAge();
        
        document.getElementById('addPatientModal').classList.remove('hidden');

    } catch (error) {
        console.error('ç·¨è¼¯ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}
async function deletePatient(id) {
    try {
        // åˆªé™¤ç—…äººæ¬Šé™é–‹æ”¾çµ¦è¨ºæ‰€ç®¡ç†è€…ã€è­·ç†å¸«èˆ‡é†«å¸«
        if (!currentUserData || !currentUserData.position || !['è¨ºæ‰€ç®¡ç†', 'è­·ç†å¸«', 'é†«å¸«'].includes(currentUserData.position.trim())) {
            showToast('åªæœ‰ç®¡ç†å“¡ã€è­·ç†å¸«æˆ–é†«å¸«å¯ä»¥åˆªé™¤ç—…äºº', 'error');
            return;
        }

        // ä½¿ç”¨æ–°çš„ getPatientByIdWithRefresh å–å¾—ç—…äººè³‡æ–™ï¼Œç¢ºä¿è·¨è£ç½®è®€å–æ­£ç¢º
        const patient = await getPatientByIdWithRefresh(id);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }

        // åˆªé™¤ç—…äººç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
        const lang = localStorage.getItem('lang') || 'zh';
        // åˆªé™¤ç—…äººæ™‚æé†’åŒæ™‚åˆªé™¤è¨ºç—‡è¨˜éŒ„ã€æŽ›è™Ÿå’Œå¥—ç¥¨
        const zhConfirmMsg = `ç¢ºå®šè¦åˆªé™¤ç—…äººã€Œ${patient.name}ã€çš„è³‡æ–™å—Žï¼Ÿ\n\næ³¨æ„ï¼šç›¸é—œçš„è¨ºç—‡è¨˜éŒ„ã€æŽ›è™ŸåŠå¥—ç¥¨ä¹Ÿæœƒä¸€ä½µåˆªé™¤ï¼`;
        const enConfirmMsg = `Are you sure you want to delete the patient \"${patient.name}\"?\n\nNote: related consultation records, appointments and packages will also be deleted.`;
        const confirmMessage = lang === 'en' ? enConfirmMsg : zhConfirmMsg;
        const confirmedDelPatient = await showConfirmation(confirmMessage, 'warning');
        if (confirmedDelPatient) {
            // é¡¯ç¤ºåˆªé™¤ä¸­ç‹€æ…‹
            showToast('åˆªé™¤ä¸­...', 'info');

            // åˆªé™¤èˆ‡ç—…äººç›¸é—œçš„è¨ºç—‡è¨˜éŒ„èˆ‡å¥—ç¥¨ç­‰è³‡æ–™
            try {
                await deletePatientAssociatedData(id);
            } catch (assocErr) {
                console.error('åˆªé™¤ç—…äººç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', assocErr);
            }

            // å¾ž Firebase åˆªé™¤ç—…äººè³‡æ–™
            const deleteResult = await window.firebaseDataManager.deletePatient(id);

            if (deleteResult && deleteResult.success) {
                showToast('ç—…äººè³‡æ–™å·²åˆªé™¤ï¼', 'success');
                // æ¸…é™¤å¿«å–ï¼Œä¸‹æ¬¡è®€å–æ™‚é‡æ–°å¾žè³‡æ–™åº«è¼‰å…¥
                // åˆªé™¤ç—…äººå¾Œä¹Ÿéœ€è¦æ¸…é™¤åˆ†é å¿«å–èˆ‡ç—…äººç¸½æ•¸å¿«å–ï¼Œ
                // ä»¥å…åˆªé™¤å¾Œä»é¡¯ç¤ºåœ¨åˆ—è¡¨ä¸­æˆ–ç¸½æ•¸ä¸è®Šã€‚
                patientCache = null;
                if (typeof patientPagesCache === 'object') {
                    patientPagesCache = {};
                }
                if (typeof patientPageCursors === 'object') {
                    patientPageCursors = {};
                }
                patientsCountCache = null;
            // é‡æ–°è¼‰å…¥ç—…äººåˆ—è¡¨ä¸¦æ›´æ–°çµ±è¨ˆå¾Œï¼Œé‡æ–°è¼‰å…¥ä»Šæ—¥æŽ›è™Ÿï¼Œä»¥æ¸…é™¤åˆªé™¤ç—…äººå°æ‡‰çš„æŽ›è™Ÿ
            await loadPatientListFromFirebase();
            updateStatistics();
            try {
                if (typeof loadTodayAppointments === 'function') {
                    await loadTodayAppointments();
                }
            } catch (_e) {
                // å¿½ç•¥æŽ›è™Ÿè¼‰å…¥å¤±æ•—
            }
            } else {
                showToast('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

    } catch (error) {
        console.error('åˆªé™¤ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

/**
 * åˆªé™¤èˆ‡ç—…äººç›¸é—œçš„è¨ºç—‡è¨˜éŒ„ã€å¥—ç¥¨ç­‰è³‡æ–™ã€‚
 * åœ¨åˆªé™¤ç—…äººè¨˜éŒ„ä¹‹å‰å‘¼å«ï¼Œä»¥ç¢ºä¿æ•¸æ“šå®Œæ•´æ€§ã€‚
 * @param {string} patientId ç—…äºº ID
 */
async function deletePatientAssociatedData(patientId) {
    try {
        await waitForFirebaseDb();
        // åˆªé™¤è¨ºç—‡è¨˜éŒ„
        try {
            const consRef = window.firebase.collection(window.firebase.db, 'consultations');
            const consQuery = window.firebase.firestoreQuery(consRef, window.firebase.where('patientId', '==', patientId));
            const consSnap = await window.firebase.getDocs(consQuery);
            const consDocs = consSnap && consSnap.docs ? consSnap.docs : [];
            for (const docSnap of consDocs) {
                try {
                    await window.firebase.deleteDoc(docSnap.ref);
                } catch (delErr) {
                    console.error('åˆªé™¤è¨ºç—‡è¨˜éŒ„å¤±æ•—:', delErr);
                }
            }
            // ç§»é™¤æœ¬åœ°è¨ºç—‡å¿«å–
            if (patientConsultationsCache && patientConsultationsCache[patientId]) {
                delete patientConsultationsCache[patientId];
            }
        } catch (err) {
            console.error('æŸ¥è©¢æˆ–åˆªé™¤è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
        }
        // åˆªé™¤æ‚£è€…å¥—ç¥¨
        try {
            const pkgRef = window.firebase.collection(window.firebase.db, 'patientPackages');
            const pkgQuery = window.firebase.firestoreQuery(pkgRef, window.firebase.where('patientId', '==', patientId));
            const pkgSnap = await window.firebase.getDocs(pkgQuery);
            const pkgDocs = pkgSnap && pkgSnap.docs ? pkgSnap.docs : [];
            for (const docSnap of pkgDocs) {
                try {
                    await window.firebase.deleteDoc(docSnap.ref);
                } catch (delErr) {
                    console.error('åˆªé™¤æ‚£è€…å¥—ç¥¨å¤±æ•—:', delErr);
                }
            }
            // ç§»é™¤æœ¬åœ°å¥—ç¥¨å¿«å–
            if (patientPackagesCache && patientPackagesCache[patientId]) {
                delete patientPackagesCache[patientId];
            }
            // ç§»é™¤æœ¬åœ°å„²å­˜çš„å¥—ç¥¨å¿«å–
            try {
                const localKey = `patientPackages_${patientId}`;
                localStorage.removeItem(localKey);
            } catch (e) {
                console.warn('åˆªé™¤æœ¬åœ°æ‚£è€…å¥—ç¥¨å¿«å–å¤±æ•—:', e);
            }
        } catch (err) {
            console.error('æŸ¥è©¢æˆ–åˆªé™¤æ‚£è€…å¥—ç¥¨å¤±æ•—:', err);
        }

        // åˆªé™¤æŽ›è™Ÿè¨˜éŒ„
        try {
            // ç­‰å¾… DataManager å°±ç·’ï¼Œä»¥ç¢ºä¿å¯å–å¾—å’Œåˆªé™¤æŽ›è™Ÿè³‡æ–™
            if (typeof waitForFirebaseDataManager === 'function') {
                try {
                    await waitForFirebaseDataManager();
                } catch (_e) {
                    // å¿½ç•¥ç­‰å¾…éŒ¯èª¤
                }
            }
            // å¾ž Firebase Realtime Database å–å¾—æ‰€æœ‰æŽ›è™Ÿ
            let apptRes = null;
            try {
                apptRes = await window.firebaseDataManager.getAppointments();
            } catch (getErr) {
                console.error('è®€å–æŽ›è™Ÿè¨˜éŒ„å¤±æ•—:', getErr);
            }
            if (apptRes && apptRes.success && Array.isArray(apptRes.data)) {
                // æ‰¾å‡ºç¬¦åˆç—…äºº ID çš„æŽ›è™Ÿ
                const apptsToDelete = apptRes.data.filter(ap => ap && String(ap.patientId) === String(patientId));
                for (const ap of apptsToDelete) {
                    try {
                        await window.firebaseDataManager.deleteAppointment(String(ap.id));
                    } catch (delErr) {
                        console.error('åˆªé™¤æŽ›è™Ÿè¨˜éŒ„å¤±æ•—:', delErr);
                    }
                }
            }
            // ç§»é™¤æœ¬åœ°å¿«å–åŠå„²å­˜çš„æŽ›è™Ÿ
            try {
                if (Array.isArray(appointments)) {
                    appointments = appointments.filter(ap => ap && String(ap.patientId) !== String(patientId));
                }
                localStorage.setItem('appointments', JSON.stringify(appointments));
            } catch (_lsErr) {
                // å¿½ç•¥æœ¬åœ°å¿«å–å¯«å…¥å¤±æ•—
            }
        } catch (err) {
            console.error('æŸ¥è©¢æˆ–åˆªé™¤æŽ›è™Ÿè¨˜éŒ„å¤±æ•—:', err);
        }
    } catch (error) {
        console.error('åˆªé™¤ç—…äººç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
}

async function viewPatient(id) {
    try {
        // ä½¿ç”¨æ–°çš„ getPatientByIdWithRefresh å°‹æ‰¾ç—…äººï¼Œ
        // é¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´å°Žè‡´æ‰¾ä¸åˆ°å‰›æ–°å¢žçš„ç—…äºº
        const patient = await getPatientByIdWithRefresh(id);
        if (!patient) {
            // è‹¥ç„¡æ³•å–å¾—ç—…äººè³‡æ–™ï¼Œæç¤ºéŒ¯èª¤
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }

        // Prepare safe fields to prevent XSS
        // Declare content variable to hold the HTML for the patient detail. Without declaring
        // it here, assignments below would create a global variable.
        let content = '';
        const safePatientNumber = window.escapeHtml(patient.patientNumber || 'æœªè¨­å®š');
        const safeName = window.escapeHtml(patient.name);
        const safeAge = window.escapeHtml(formatAge(patient.birthDate));
        const safeGender = window.escapeHtml(patient.gender);
        const safePhone = window.escapeHtml(patient.phone);
        const safeIdCard = patient.idCard ? window.escapeHtml(patient.idCard) : null;
        const safeAddress = patient.address ? window.escapeHtml(patient.address) : null;
        const safeHistory = patient.history ? window.escapeHtml(patient.history) : null;
        const safeAllergies = patient.allergies ? window.escapeHtml(patient.allergies) : null;
        const birthDateString = patient.birthDate ? new Date(patient.birthDate).toLocaleDateString('zh-TW') : '';
        // Format creation and update timestamps using 24-hour format
        const createdAtStr = patient.createdAt ? (() => {
            const d = new Date(patient.createdAt.seconds * 1000);
            return d.toLocaleString('zh-TW', { hour12: false });
        })() : 'æœªçŸ¥';
        const updatedAtStr = patient.updatedAt ? (() => {
            const d = new Date(patient.updatedAt.seconds * 1000);
            return d.toLocaleString('zh-TW', { hour12: false });
        })() : '';
        // The package status section is rendered as part of the consultation summary,
        // so leave this placeholder empty. It will be filled later by renderPackageStatusSection.
        let packageStatusHtml = '';

        // Translation helper. If t() is available, use it; otherwise fall back to the original key.
        const _t = typeof t === 'function' ? t : (str) => str;
        // Labels for translation
        const lblBasicInfo = _t('åŸºæœ¬è³‡æ–™');
        const lblMedicalInfo = _t('é†«ç™‚è³‡è¨Š');
        const lblPatientNumber = _t('ç—…äººç·¨è™Ÿï¼š');
        const lblName = _t('å§“åï¼š');
        const lblAge = _t('å¹´é½¡ï¼š');
        const lblGender = _t('æ€§åˆ¥ï¼š');
        const lblPhone = _t('é›»è©±ï¼š');
        const lblIdCard = _t('èº«åˆ†è­‰ï¼š');
        const lblBirthDate = _t('å‡ºç”Ÿæ—¥æœŸï¼š');
        const lblAddress = _t('åœ°å€ï¼š');
        const lblHistoryAndNotes = _t('ç—…å²åŠå‚™è¨»ï¼š');
        const lblAllergies = _t('éŽæ•å²ï¼š');
        const lblCreatedAt = _t('å»ºæª”æ—¥æœŸï¼š');
        const lblUpdatedAt = _t('æ›´æ–°æ—¥æœŸï¼š');
        const lblConsultationSummary = _t('è¨ºç—‡è¨˜éŒ„æ‘˜è¦');
        const lblLoadingConsultations = _t('è¼‰å…¥è¨ºç—‡è¨˜éŒ„ä¸­...');

        // Build the content HTML using sanitized values and translated labels.
        content = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">${lblBasicInfo}</h4>
                <div class="space-y-2">
                    <div><span class="font-medium">${lblPatientNumber}</span><span class="text-blue-600 font-semibold">${safePatientNumber}</span></div>
                    <div><span class="font-medium">${lblName}</span>${safeName}</div>
                    <div><span class="font-medium">${lblAge}</span>${safeAge}</div>
                    <div><span class="font-medium">${lblGender}</span>${safeGender}</div>
                    <div><span class="font-medium">${lblPhone}</span>${safePhone}</div>
                    ${safeIdCard ? `<div><span class="font-medium">${lblIdCard}</span>${safeIdCard}</div>` : ''}
                    ${birthDateString ? `<div><span class="font-medium">${lblBirthDate}</span>${birthDateString}</div>` : ''}
                    ${safeAddress ? `<div><span class="font-medium">${lblAddress}</span>${safeAddress}</div>` : ''}
                </div>
            </div>

            <div class="space-y-4">
                <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">${lblMedicalInfo}</h4>
                <div class="space-y-2">
                    ${safeHistory ? `<div><span class="font-medium">${lblHistoryAndNotes}</span><div class="mt-1 p-2 bg-gray-50 rounded text-sm medical-field">${safeHistory}</div></div>` : ''}
                    ${safeAllergies ? `<div><span class="font-medium">${lblAllergies}</span><div class="mt-1 p-2 bg-red-50 rounded text-sm medical-field">${safeAllergies}</div></div>` : ''}
                    <div><span class="font-medium">${lblCreatedAt}</span>${createdAtStr}</div>
                    ${updatedAtStr ? `<div><span class="font-medium">${lblUpdatedAt}</span>${updatedAtStr}</div>` : ''}
                </div>
            </div>
        </div>
        ${packageStatusHtml}
        <!-- è¨ºç—‡è¨˜éŒ„æ‘˜è¦ -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-lg font-semibold text-gray-800">${lblConsultationSummary}</h4>
            </div>
            <div id="patientConsultationSummary">
                <div class="text-center py-4">
                    <!-- ä½¿ç”¨è¼ƒå¤§çš„è®€å–åœˆä»¥èˆ‡å…¶ä»–é é¢ä¸€è‡´ -->
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    <div class="mt-2 text-sm">${lblLoadingConsultations}</div>
                </div>
            </div>
        </div>
        `;
        // å…ˆå°‡å…§å®¹æ’å…¥ä¸¦é¡¯ç¤ºæ¨¡æ…‹æ¡†
        const detailContainer = document.getElementById('patientDetailContent');
        if (detailContainer) {
            detailContainer.innerHTML = content;
        }
        const modalEl = document.getElementById('patientDetailModal');
        if (modalEl) {
            modalEl.classList.remove('hidden');
        }

        // å¥—ç¥¨å€å¡Šçš„æ¸²æŸ“å·²ç§»è‡³è¨ºç™‚æ‘˜è¦ä¸­è™•ç†ï¼Œæ•…æ­¤è™•ä¸å†å–®ç¨å‘¼å« renderPackageStatusSection

        /**
         * è¼‰å…¥è¨ºç—‡è¨˜éŒ„æ‘˜è¦
         *
         * æ³¨æ„ï¼šè¨ºç—‡è¨˜éŒ„æ‘˜è¦å€å¡Šæ˜¯åœ¨ä¸Šé¢æ’å…¥çš„å…§å®¹ä¸­å‹•æ…‹ç”Ÿæˆçš„ã€‚
         * å¿…é ˆç¢ºä¿ DOM å·²ç¶“æ¸²æŸ“å®Œç•¢å¾Œå†å‘¼å«ï¼Œå¦å‰‡æœƒæ‰¾ä¸åˆ°å®¹å™¨å°Žè‡´éŒ¯èª¤ã€‚
         */
        loadPatientConsultationSummary(id);

    } catch (error) {
        console.error('æŸ¥çœ‹ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}

        function closePatientDetail() {
            document.getElementById('patientDetailModal').classList.add('hidden');
        }





        // æœå°‹åŠŸèƒ½ï¼šå·²ç§»è‡³çµ±ä¸€çš„ DOMContentLoaded äº‹ä»¶ä¸­è™•ç†ï¼Œé¿å…é‡è¤‡ç¶å®šã€‚

        // è¨ºç—‡ç³»çµ±åŠŸèƒ½
        let selectedPatientForRegistration = null;
        let currentConsultingAppointmentId = null;
// å„²å­˜å¾ž Firebase è¼‰å…¥çš„å•è¨ºè³‡æ–™é¸é …ã€‚
// éµç‚ºå•è¨ºç´€éŒ„ IDï¼Œå€¼ç‚ºå®Œæ•´ç´€éŒ„å…§å®¹ï¼Œç”¨æ–¼æŽ›è™Ÿèˆ‡è¨ºç—‡é å¡«ã€‚
let inquiryOptionsData = {};

/**
 * ä¾æ“šå•è¨ºè³‡æ–™ä¸­çš„ä¸»ç—‡ç‹€è³‡è¨Šç”¢ç”Ÿæ‘˜è¦ã€‚
 * ç”¨æ–¼åœ¨è¨ºç—‡è¡¨å–®ä¸­é å¡«ä¸»è¨´æ¬„ä½ã€‚
 *
 * @param {Object} results å•è¨ºè³‡æ–™ä¸­çš„ data æ¬„ä½
 * @returns {string} æ‘˜è¦æ–‡å­—
 */
function getMainSymptomFromResult(results) {
    if (!results) return '';
    // å°‡èº«é«”éƒ¨ä½è‹±æ–‡ä»£ç¢¼è½‰æ›ç‚ºä¸­æ–‡åç¨±
    const bodyPartNames = {
        head: 'é ­éƒ¨',
        neck: 'é ¸éƒ¨',
        chest: 'èƒ¸éƒ¨',
        abdomen: 'è…¹éƒ¨',
        back: 'èƒŒéƒ¨',
        arms: 'æ‰‹è‡‚',
        legs: 'è…¿éƒ¨',
        joints: 'é—œç¯€',
        skin: 'çš®è†š',
        internal: 'å…§ç§‘ç—‡ç‹€',
        gynecology: 'å©¦ç§‘',
        andrology: 'ç”·ç§‘',
        other: 'å…¶ä»–'
    };
    // å°‡è©³ç´°éƒ¨ä½è‹±æ–‡ä»£ç¢¼è½‰æ›ç‚ºä¸­æ–‡åç¨±ã€‚
    // é€™è£¡å½™æ•´å„èº«é«”éƒ¨ä½çš„å°æ‡‰å€¼ï¼Œé¿å…é è¨ºè³‡æ–™ç”¢ç”Ÿè‹±æ–‡ä»£ç¢¼ã€‚
    const detailedLocationNames = {
        // é ­éƒ¨
        forehead: 'å‰é¡',
        temples: 'å¤ªé™½ç©´',
        top_head: 'é ­é ‚',
        back_head: 'å¾Œè…¦å‹º',
        eyes: 'çœ¼éƒ¨',
        nose: 'é¼»éƒ¨',
        ears: 'è€³éƒ¨',
        mouth: 'å£éƒ¨',
        jaw: 'ä¸‹é¡Ž',
        whole_head: 'æ•´å€‹é ­éƒ¨',
        // é ¸éƒ¨
        front_neck: 'å‰é ¸',
        back_neck: 'å¾Œé ¸',
        side_neck: 'å´é ¸',
        throat: 'å–‰åš¨',
        whole_neck: 'æ•´å€‹é ¸éƒ¨',
        // èƒ¸éƒ¨
        upper_chest: 'ä¸Šèƒ¸éƒ¨',
        lower_chest: 'ä¸‹èƒ¸éƒ¨',
        left_chest: 'å·¦èƒ¸',
        right_chest: 'å³èƒ¸',
        heart_area: 'å¿ƒè‡Ÿéƒ¨ä½',
        ribs: 'è‚‹éª¨',
        whole_chest: 'æ•´å€‹èƒ¸éƒ¨',
        // è…¹éƒ¨
        upper_abdomen: 'ä¸Šè…¹éƒ¨',
        lower_abdomen: 'ä¸‹è…¹éƒ¨',
        left_abdomen: 'å·¦è…¹éƒ¨',
        right_abdomen: 'å³è…¹éƒ¨',
        navel: 'è‚šè‡å‘¨åœ',
        stomach: 'èƒƒéƒ¨',
        liver_area: 'è‚å€',
        whole_abdomen: 'æ•´å€‹è…¹éƒ¨',
        // èƒŒéƒ¨
        upper_back: 'ä¸ŠèƒŒéƒ¨',
        middle_back: 'ä¸­èƒŒéƒ¨',
        lower_back: 'ä¸‹èƒŒéƒ¨/è…°éƒ¨',
        left_back: 'å·¦èƒŒ',
        right_back: 'å³èƒŒ',
        spine: 'è„Šæ¤Ž',
        shoulder_blade: 'è‚©èƒ›éª¨',
        whole_back: 'æ•´å€‹èƒŒéƒ¨',
        // æ‰‹è‡‚
        shoulders: 'è‚©è†€',
        upper_arms: 'ä¸Šè‡‚',
        elbows: 'æ‰‹è‚˜',
        forearms: 'å‰è‡‚',
        wrists: 'æ‰‹è…•',
        hands: 'æ‰‹æŽŒ',
        fingers: 'æ‰‹æŒ‡',
        left_arm: 'å·¦æ‰‹è‡‚',
        right_arm: 'å³æ‰‹è‡‚',
        both_arms: 'é›™æ‰‹è‡‚',
        // è…¿éƒ¨
        hips: 'è‡€éƒ¨',
        thighs: 'å¤§è…¿',
        knees: 'è†è“‹',
        calves: 'å°è…¿',
        ankles: 'è…³è¸',
        feet: 'è…³æŽŒ',
        toes: 'è…³è¶¾',
        left_leg: 'å·¦è…¿',
        right_leg: 'å³è…¿',
        both_legs: 'é›™è…¿',
        // é—œç¯€
        shoulder_joint: 'è‚©é—œç¯€',
        elbow_joint: 'è‚˜é—œç¯€',
        wrist_joint: 'è…•é—œç¯€',
        hip_joint: 'é«–é—œç¯€',
        knee_joint: 'è†é—œç¯€',
        ankle_joint: 'è¸é—œç¯€',
        spine_joint: 'è„Šæ¤Žé—œç¯€',
        multiple_joints: 'å¤šå€‹é—œç¯€',
        // çš®è†š
        face_skin: 'é¢éƒ¨çš®è†š',
        body_skin: 'èº«é«”çš®è†š',
        hands_skin: 'æ‰‹éƒ¨çš®è†š',
        feet_skin: 'è¶³éƒ¨çš®è†š',
        scalp: 'é ­çš®',
        widespread_skin: 'å…¨èº«çš®è†š',
        // å…§ç§‘
        breathing: 'å‘¼å¸ç³»çµ±',
        digestion: 'æ¶ˆåŒ–ç³»çµ±',
        circulation: 'å¾ªç’°ç³»çµ±',
        nervous: 'ç¥žç¶“ç³»çµ±',
        urinary: 'æ³Œå°¿ç³»çµ±',
        reproductive: 'ç”Ÿæ®–ç³»çµ±',
        general_weakness: 'å…¨èº«ç„¡åŠ›',
        fever: 'ç™¼ç†±',
        // å©¦ç§‘
        menstrual_issues: 'æœˆç¶“å•é¡Œ',
        vaginal_discharge: 'ç™½å¸¶ç•°å¸¸',
        pelvic_pain: 'éª¨ç›†è…”ç–¼ç—›',
        breast_issues: 'ä¹³æˆ¿å•é¡Œ',
        menopause_symptoms: 'æ›´å¹´æœŸç—‡ç‹€',
        fertility_issues: 'ç”Ÿè‚²ç›¸é—œ',
        urinary_gyneco: 'æ³Œå°¿å©¦ç§‘',
        postpartum_issues: 'ç”¢å¾Œå•é¡Œ',
        // ç”·ç§‘
        erectile_dysfunction: 'å‹ƒèµ·åŠŸèƒ½',
        prostate_issues: 'å‰åˆ—è…ºå•é¡Œ',
        urinary_male: 'æ³Œå°¿å•é¡Œ',
        testicular_pain: 'çªä¸¸ç–¼ç—›',
        fertility_male: 'ç”Ÿè‚²èƒ½åŠ›',
        hormonal_male: 'è·çˆ¾è’™å•é¡Œ',
        sexual_function: 'æ€§åŠŸèƒ½éšœç¤™',
        genital_issues: 'ç”Ÿæ®–å™¨å•é¡Œ',
        // å…¶ä»–
        multiple_areas: 'å¤šå€‹éƒ¨ä½',
        unclear_location: 'ä½ç½®ä¸æ˜Žç¢º',
        whole_body: 'å…¨èº«',
        other_specify: 'å…¶ä»–ï¼ˆè«‹åœ¨è£œå……æè¿°ä¸­èªªæ˜Žï¼‰'
    };
    // å…ˆè½‰æ›èº«é«”éƒ¨ä½åç¨±
    let symptom = bodyPartNames[results.bodyPart] || (results.bodyPart || 'æœªæŒ‡å®šéƒ¨ä½');
    // å¦‚æžœæœ‰è©³ç´°éƒ¨ä½å‰‡è½‰æ›ç‚ºä¸­æ–‡
    if (results.detailedLocation) {
        const locKey = results.detailedLocation;
        const locName = detailedLocationNames[locKey] || results.detailedLocation;
        symptom += ' - ' + locName;
    }
    // æ•´ç†ç›¸é—œç—‡ç‹€ï¼Œç§»é™¤é‡è¤‡å¾Œå–å‰ä¸‰é …
    let related = results.relatedSymptoms;
    if (related) {
        if (!Array.isArray(related)) {
            related = [related];
        }
        // ä½¿ç”¨ Set ç§»é™¤é‡è¤‡çš„ç—‡ç‹€
        const uniqueRelated = Array.from(new Set(related));
        if (uniqueRelated.length > 0) {
            symptom += 'ï¼š' + uniqueRelated.slice(0, 3).join('ã€');
        }
    }
    return symptom;
}

/**
 * æ ¹æ“šå•è¨ºè³‡æ–™ç”Ÿæˆå®Œæ•´çš„ä¸»è¨´æ‘˜è¦ã€‚
 * æ­¤æ‘˜è¦æœƒåŒ…å«ä¸»è¦ç—‡ç‹€ã€è£œå……æè¿°åŠç›¸é—œç—‡ç‹€ï¼Œ
 * ä»¥ä¾¿å¡«å…¥è¨ºç—‡è¡¨å–®çš„ä¸»è¨´æ¬„ä½ã€‚
 *
 * @param {Object} data å•è¨ºè³‡æ–™ä¸­çš„ data æ¬„ä½
 * @returns {string} å®Œæ•´ä¸»è¨´æ‘˜è¦
 */
function generateSymptomSummaryFromInquiry(data) {
    if (!data) return '';
    // é¦–å…ˆä½¿ç”¨å…§å»ºå‡½å¼ç”Ÿæˆä¸»è¦ç—‡ç‹€æ‘˜è¦
    let summary = getMainSymptomFromResult(data) || '';
    const parts = [];
    // è£œå……æè¿°
    if (data.additionalSymptoms && typeof data.additionalSymptoms === 'string' && data.additionalSymptoms.trim()) {
        // ä½¿ç”¨ä¸­æ–‡å…¨å½¢å†’è™Ÿï¼Œé¿å…é è¨ºç³»çµ±å¡«å…¥è‹±æ–‡å­—å…ƒ
        parts.push('è£œå……æè¿°ï¼š' + data.additionalSymptoms.trim());
    }
    // ç›¸é—œç—‡ç‹€ï¼šé¿å…èˆ‡ä¸»è¦ç—‡ç‹€é‡è¤‡é¡¯ç¤ºã€‚è‹¥ç›¸é—œç—‡ç‹€è¶…éŽä¸‰å€‹ï¼Œå‰ä¸‰å€‹å·²åœ¨ä¸»ç—‡ç‹€æ‘˜è¦ä¸­å‘ˆç¾ï¼Œå‰©é¤˜é …ç›®æ–¼æ­¤é¡¯ç¤ºã€‚
    if (data.relatedSymptoms) {
        let relatedList = [];
        if (Array.isArray(data.relatedSymptoms)) {
            relatedList = data.relatedSymptoms;
        } else if (typeof data.relatedSymptoms === 'string') {
            relatedList = [data.relatedSymptoms];
        }
        if (relatedList.length > 0) {
            // ç§»é™¤é‡è¤‡å€¼
            const uniqueRelated = Array.from(new Set(relatedList));
            // å–å‰ä¸‰é …å·²åœ¨ä¸»è¦ç—‡ç‹€æ‘˜è¦å‘ˆç¾
            const remaining = uniqueRelated.slice(3);
            if (remaining.length > 0) {
                // ä½¿ç”¨ä¸­æ–‡å…¨å½¢å†’è™Ÿï¼Œé¿å…é è¨ºç³»çµ±å¡«å…¥è‹±æ–‡å­—å…ƒ
                parts.push('ç›¸é—œç—‡ç‹€ï¼š' + remaining.join('ã€'));
            }
        }
    }
    if (parts.length > 0) {
        if (summary) {
            summary += 'ï¼›' + parts.join('ï¼›');
        } else {
            summary = parts.join('ï¼›');
        }
    }
    return summary;
}

/**
 * æ ¹æ“šå•è¨ºè³‡æ–™ç”Ÿæˆç¾ç—…å²æ‘˜è¦ã€‚
 * å°‡å•è¨ºè¡¨ä¸­çš„å…¶ä»–æ¢ç›®æ•´ç†æˆå¤šè¡Œæ–‡å­—ï¼Œæ¯è¡ŒåŒ…å«æ¬„ä½æ¨™ç±¤èˆ‡å€¼ã€‚
 *
 * @param {Object} data å•è¨ºè³‡æ–™ä¸­çš„ data æ¬„ä½
 * @returns {string} ç¾ç—…å²æ‘˜è¦ï¼Œç”¨æ›è¡Œç¬¦è™Ÿåˆ†éš”å„é …
 */
function generateHistorySummaryFromInquiry(data) {
    if (!data) return '';
    const labels = {
        sweating: 'æ±—å‡ºæƒ…æ³',
        'å‡ºæ±—éƒ¨ä½': 'å‡ºæ±—éƒ¨ä½',
        temperature: 'å¯’ç†±',
        coldHands: 'æ‰‹è…³å†°å†·',
        appetite: 'é£Ÿæ…¾',
        appetiteSymptoms: 'èƒƒå£ç—‡ç‹€',
        foodPreference: 'é£Ÿç‰©åå¥½',
        drinkingPreference: 'é£²æ°´åå¥½',
        drinkingHabits: 'é£²æ°´ç¿’æ…£',
        urination: 'å°ä¾¿ç—‡ç‹€',
        nightUrination: 'å¤œå°¿æ¬¡æ•¸',
        dailyUrination: 'æ—¥é–“å°ä¾¿æ¬¡æ•¸',
        urineColor: 'å°ä¾¿é¡è‰²',
        stoolForm: 'å¤§ä¾¿å½¢ç‹€',
        stoolSymptoms: 'å¤§ä¾¿ç—‡ç‹€',
        stoolFrequency: 'å¤§ä¾¿é »çŽ‡',
        stoolOdor: 'å¤§ä¾¿æ°£å‘³',
        stoolColor: 'å¤§ä¾¿é¡è‰²',
        sleep: 'ç¡çœ ',
        energy: 'ç²¾ç¥žç‹€æ…‹',
        morningEnergy: 'æ™¨èµ·ç²¾ç¥ž',
        concentration: 'æ³¨æ„åŠ›',
        medicalHistory: 'ç—…å²',
        detailedMedicalHistory: 'è©³ç´°ç—…å²',
        currentMeds: 'ç›®å‰ç”¨è—¥',
        allergies: 'éŽæ•å²',
        otherAllergies: 'å…¶ä»–éŽæ•'
    };
    const lines = [];
    Object.keys(labels).forEach(key => {
        const label = labels[key];
        const value = data[key];
        if (value === undefined || value === null) return;
        // Skip empty strings or arrays with no content
        if (Array.isArray(value)) {
            if (value.length === 0) return;
            const joined = value.join('ã€');
            if (joined.trim()) {
                lines.push(label + 'ï¼š' + joined.trim());
            }
        } else {
            const valStr = String(value).trim();
            if (!valStr || valStr === 'ç„¡') return;
            lines.push(label + 'ï¼š' + valStr);
        }
    });
    return lines.join('\n');
}

/**
 * å¾ž Firebase è¼‰å…¥å•è¨ºè³‡æ–™åˆ—è¡¨ï¼Œä¸¦å¡«å……è‡³æŽ›è™Ÿå½ˆçª—çš„ä¸‹æ‹‰é¸å–®ã€‚
 * ä¸å†é™åˆ¶å¿…é ˆèˆ‡ç—…äººå§“ååŒ¹é…ï¼Œå°‡è¼‰å…¥æ‰€æœ‰æœªéŽæœŸçš„å•è¨ºè³‡æ–™ã€‚
 * æ¯å€‹é¸é …æœƒæ¨™ç¤ºå•è¨ºå‰µå»ºæ™‚é–“èˆ‡ç—…äººå§“åï¼Œæ–¹ä¾¿è¾¨è­˜ã€‚
 *
 * @param {Object} patient ç—…äººè³‡æ–™ç‰©ä»¶ï¼ˆå¯é¸ï¼Œä¸ä½¿ç”¨æ™‚ä¾ç„¶æœƒè¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼‰
 */
async function loadInquiryOptions(patient) {
    const select = document.getElementById('inquirySelect');
    if (!select) return;
    // æ¸…ç©ºç¾æœ‰é¸é …ä¸¦åŠ å…¥é è¨­é¸é …
    select.innerHTML = '<option value="">ä¸ä½¿ç”¨å•è¨ºè³‡æ–™</option>';
    try {
        // æ¸…é™¤éŽæœŸå•è¨ºè³‡æ–™ï¼šåƒ…ç•¶ä½¿ç”¨è€…å·²ç™»å…¥æ™‚æ‰åŸ·è¡Œï¼Œä»¥é¿å…æœªæŽˆæ¬ŠéŒ¯èª¤
        const userLoggedIn = (window.firebase && window.firebase.auth && window.firebase.auth.currentUser) ||
                             (typeof currentUserData !== 'undefined' && currentUserData);
        if (userLoggedIn && window.firebaseDataManager && window.firebaseDataManager.clearOldInquiries) {
            await window.firebaseDataManager.clearOldInquiries();
        }
    } catch (err) {
        console.error('æ¸…é™¤éŽæœŸå•è¨ºè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }
    try {
        // å¾ž Firebase å–å¾—å•è¨ºè³‡æ–™ï¼›ä¸å‚³å…¥ patientName ä»¥å–å¾—å…¨éƒ¨æœªéŽæœŸçš„å•è¨ºç´€éŒ„
        let result;
        try {
            result = await window.firebaseDataManager.getInquiryRecords('');
        } catch (e) {
            console.error('è®€å–å…¨éƒ¨å•è¨ºè³‡æ–™å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ç—…äººåç¨±æŸ¥è©¢:', e);
            const nameForSearch = patient && patient.name ? String(patient.name).trim() : '';
            result = await window.firebaseDataManager.getInquiryRecords(nameForSearch);
        }
        inquiryOptionsData = {};
        if (result && result.success && Array.isArray(result.data)) {
            result.data.forEach(rec => {
                // å–å‡ºå•è¨ºè¨˜éŒ„å‰µå»ºæ™‚é–“
                let createdAt = rec.createdAt;
                let dateStr = '';
                if (createdAt && createdAt.seconds !== undefined) {
                    const ts = new Date(createdAt.seconds * 1000);
                    dateStr = ts.toLocaleString('zh-TW', { hour12: false });
                } else if (createdAt) {
                    try {
                        dateStr = new Date(createdAt).toLocaleString('zh-TW', { hour12: false });
                    } catch (_e) {
                        dateStr = '';
                    }
                }
                const opt = document.createElement('option');
                opt.value = rec.id;
                // åŠ å…¥ç—…äººå§“åä»¥ä¾¿è¾¨è­˜
                const patientName = rec.patientName || '';
                if (dateStr) {
                    opt.textContent = `${dateStr} ${patientName} å•è¨ºè³‡æ–™`;
                } else {
                    opt.textContent = `${patientName} å•è¨ºè³‡æ–™ (${rec.id})`;
                }
                select.appendChild(opt);
                inquiryOptionsData[rec.id] = rec;
            });
        }
    } catch (error) {
        console.error('è®€å–å•è¨ºè³‡æ–™éŒ¯èª¤:', error);
    }
}

        /**
         * åˆ¤æ–·ç•¶å‰æ˜¯å¦å¯ä»¥å°å¥—ç¥¨é€²è¡Œæ“ä½œï¼ˆæ–°å¢žã€åˆªé™¤æˆ–èª¿æ•´æ•¸é‡ï¼‰ã€‚
         * ç•¶æŽ›è™Ÿå·²æ¨™è¨˜ç‚ºå®Œæˆï¼ˆappointment.status === 'completed'ï¼‰æ™‚ï¼Œ
         * æ‡‰ç¦æ­¢å¾ŒçºŒå°å¥—ç¥¨çš„ä»»ä½•ä¿®æ”¹ï¼Œä»¥é¿å…è¨ºç—‡å®Œæˆå¾Œä»æ›´å‹•æ”¶è²»é …ç›®ã€‚
         *
         * @returns {boolean} å¦‚æžœå…è¨±ä¿®æ”¹å¥—ç¥¨å‰‡å›žå‚³ trueï¼›è‹¥å·²å®Œæˆå‰‡å›žå‚³ false
         */
        function canModifyPackageItems() {
            try {
                // å¾žå…¨åŸŸ appointments ä¸­å–å¾—ç•¶å‰æŽ›è™Ÿè³‡è¨Š
                if (Array.isArray(appointments) && currentConsultingAppointmentId !== null && currentConsultingAppointmentId !== undefined) {
                    const appt = appointments.find(ap => ap && String(ap.id) === String(currentConsultingAppointmentId));
                    // å¦‚æžœå­˜åœ¨ä¸”ç‹€æ…‹ç‚ºå·²å®Œæˆï¼Œå‰‡ä¸å…è¨±ä¿®æ”¹å¥—ç¥¨
                    if (appt && appt.status === 'completed') {
                        return false;
                    }
                }
            } catch (e) {
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¿æŒå…è¨±ç‹€æ…‹ï¼Œé¿å…é˜»å¡žå…¶ä»–æ“ä½œ
            }
            return true;
        }
        
        /**
         * è¼‰å…¥è¨ºç—‡ï¼ˆæŽ›è™Ÿï¼‰ç³»çµ±ã€‚
         *
         * éŽæœŸæŽ›è™Ÿæ¸…é™¤åƒ…éœ€åœ¨åˆ‡æ›åˆ°æŽ›è™Ÿç³»çµ±æ™‚åŸ·è¡Œä¸€æ¬¡ï¼Œ
         * å› æ­¤åœ¨æ­¤å‡½å¼ä¸­å…ˆåŸ·è¡Œæ¸…é™¤éŽæœŸæŽ›è™Ÿçš„æª¢æŸ¥ï¼Œç„¶å¾Œå†åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨
         * ä¸¦è¼‰å…¥ç•¶å¤©æŽ›è™Ÿåˆ—è¡¨ã€‚ä¹‹å¾Œè§¸ç™¼æ›´æ–°æŽ›è™Ÿåˆ—è¡¨ï¼ˆä¾‹å¦‚æ—¥æœŸè®Šæ›´æˆ–æ–°å¢žæŽ›è™Ÿï¼‰
         * å‰‡ä¸æœƒé‡è¤‡åŸ·è¡Œæ¸…é™¤ã€‚
         */
        function loadConsultationSystem() {
            // å…ˆæ¸…é™¤éŽæœŸæŽ›è™Ÿï¼Œå®Œæˆå¾Œå†è¼‰å…¥æŽ›è™Ÿåˆ—è¡¨
            clearOldAppointments()
                .catch(err => {
                    // å³ä½¿æ¸…é™¤å¤±æ•—ä»ç¹¼çºŒè¼‰å…¥æŽ›è™Ÿåˆ—è¡¨
                    console.error('åˆ‡æ›æŽ›è™Ÿç³»çµ±æ™‚æ¸…é™¤éŽæœŸæŽ›è™ŸéŒ¯èª¤:', err);
                })
                .finally(() => {
                    // æ¯æ¬¡é€²å…¥æŽ›è™Ÿç³»çµ±æ™‚å•Ÿå‹•æŽ›è™Ÿç›£è½ï¼Œåªåœ¨æ­¤é é¢é–‹å§‹ç›£è½å³æ™‚æŽ›è™Ÿè®ŠåŒ–
                    try {
                        if (typeof subscribeToAppointments === 'function') {
                            subscribeToAppointments();
                        }
                    } catch (_err) {
                        console.error('å•Ÿå‹•æŽ›è™Ÿç›£è½æ™‚å¤±æ•—:', _err);
                    }
                    // åˆå§‹åŒ–æŽ›è™Ÿæ—¥æœŸé¸æ“‡å™¨
                    try {
                        setupAppointmentDatePicker();
                    } catch (_e) {
                        // å¿½ç•¥åˆå§‹åŒ–å¤±æ•—
                    }
                    // è¼‰å…¥é¸å®šæ—¥æœŸçš„æŽ›è™Ÿåˆ—è¡¨
                    loadTodayAppointments();
                    // æ¸…ç©ºç—…äººæœå°‹æ¬„ä½
                    clearPatientSearch();
                });
        }

        /**
         * åˆå§‹åŒ–æŽ›è™Ÿæ—¥æœŸé¸æ“‡å™¨ã€‚
         * è¨­å®šæœ€å°å¯é¸æ—¥æœŸç‚ºä»Šæ—¥ 00:00ï¼Œä¸¦åœ¨æœªé¸æ“‡æ—¥æœŸæ™‚é è¨­ç‚ºä»Šæ—¥ 00:00ã€‚
         * ç•¶ä½¿ç”¨è€…æ”¹è®Šæ—¥æœŸæ™‚æœƒé‡æ–°è¼‰å…¥æŽ›è™Ÿåˆ—è¡¨ã€‚
         */
        function setupAppointmentDatePicker() {
            try {
                const picker = document.getElementById('appointmentDatePicker');
                if (!picker) return;
                // è¨­å®šæœ€å°å¯é¸æ—¥æœŸç‚ºä»Šå¤© 00:00
                const now = new Date();
                const minDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const localMin = new Date(minDate.getTime() - minDate.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 10);
                picker.min = localMin;
                // è‹¥å°šæœªæœ‰å€¼ï¼Œé è¨­ç‚ºä»Šæ—¥
                if (!picker.value) {
                    picker.value = localMin;
                }
                // åªç¶å®šä¸€æ¬¡ change äº‹ä»¶
                if (!picker.dataset.bound) {
                    picker.addEventListener('change', function () {
                        try {
                            // é‡æ–°å•Ÿå‹•æŽ›è™Ÿå¯¦æ™‚ç›£è½ä»¥ç›£è½æ–°çš„æ—¥æœŸç¯„åœ
                            if (typeof subscribeToAppointments === 'function') {
                                subscribeToAppointments();
                            }
                            // æ›´æ–°ä»Šæ—¥æŽ›è™Ÿåˆ—è¡¨
                            loadTodayAppointments();
                        } catch (_err) {
                            console.error('æ›´æ–°æŽ›è™Ÿåˆ—è¡¨æˆ–é‡æ–°å•Ÿå‹•ç›£è½å¤±æ•—ï¼š', _err);
                        }
                    });
                    picker.dataset.bound = 'true';
                }
            } catch (err) {
                console.error('åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨å¤±æ•—ï¼š', err);
            }
        }
        
// 1. ä¿®æ”¹ç—…äººæœå°‹å‡½æ•¸ï¼Œæ”¹ç‚ºå¾ž Firebase è®€å–è³‡æ–™
async function searchPatientsForRegistration() {
    const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
    const resultsContainer = document.getElementById('patientSearchResults');
    const resultsList = document.getElementById('searchResultsList');
    
    if (searchTerm.length < 1) {
        resultsContainer.classList.add('hidden');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œä½¿ç”¨å¤§è®€å–åœˆä»¥çµ±ä¸€é¢¨æ ¼
    resultsList.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            <div class="mt-2">æœå°‹ä¸­...</div>
        </div>
    `;
    resultsContainer.classList.remove('hidden');
    
    try {
        // é€éŽ DataManager çš„æœå°‹åŠŸèƒ½æŸ¥è©¢ç—…äºº
        let searchResult;
        try {
            searchResult = await window.firebaseDataManager.searchPatients(searchTerm, 20);
        } catch (_err) {
            console.error('æœå°‹ç—…äººæ™‚ç™¼ç”ŸéŒ¯èª¤:', _err);
        }
        const matchedPatients = (searchResult && searchResult.success && Array.isArray(searchResult.data)) ? searchResult.data : [];
        // è‹¥ç„¡ä»»ä½•åŒ¹é…
        if (matchedPatients.length === 0) {
            resultsList.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                    æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…äºº
                </div>
            `;
            resultsContainer.classList.remove('hidden');
            return;
        }
        // é¡¯ç¤ºæœç´¢çµæžœï¼Œä½¿ç”¨ escapeHtml è½‰ç¾©é¡¯ç¤ºå…§å®¹
        // ç”Ÿæˆæœå°‹çµæžœé …ç›®ï¼Œä¸¦ç‚ºæ¯å€‹é …ç›®è¨­å®š data å±¬æ€§ä»¥åˆ©éµç›¤é¸æ“‡æ™‚å–å¾—ç—…äºº ID
        resultsList.innerHTML = matchedPatients.map(patient => {
            const safeId = String(patient.id).replace(/"/g, '&quot;');
            const safeName = window.escapeHtml(patient.name);
            const safeNumber = window.escapeHtml(patient.patientNumber || '');
            const safeAge = window.escapeHtml(formatAge(patient.birthDate));
            // ä½¿ç”¨åœ‹éš›åŒ–å‡½å¼ç¿»è­¯æ€§åˆ¥åŠæ¨™ç±¤
            const genderTranslated = window.t ? window.t(patient.gender) : patient.gender;
            const safeGender = window.escapeHtml(genderTranslated);
            const safePhone = window.escapeHtml(patient.phone);
            // ç¿»è­¯æ¨™ç±¤ï¼šç·¨è™Ÿã€å¹´é½¡ã€æ€§åˆ¥ã€é›»è©±
            const lblNumber = window.t ? window.t('ç·¨è™Ÿï¼š') : 'ç·¨è™Ÿï¼š';
            const lblAge = window.t ? window.t('å¹´é½¡ï¼š') : 'å¹´é½¡ï¼š';
            const lblGender = window.t ? window.t('æ€§åˆ¥ï¼š') : 'æ€§åˆ¥ï¼š';
            const lblPhone = window.t ? window.t('é›»è©±ï¼š') : 'é›»è©±ï¼š';
            return `
            <div class="p-4 hover:bg-gray-50 cursor-pointer transition duration-200" data-patient-id="${safeId}" onclick="selectPatientForRegistration('${safeId}')">
                <div>
                    <div class="font-semibold text-gray-900">${safeName}</div>
                    <div class="text-sm text-gray-600">${lblNumber}${safeNumber} | ${lblAge}${safeAge} | ${lblGender}${safeGender}</div>
                    <div class="text-sm text-gray-500">${lblPhone}${safePhone}</div>
                </div>
            </div>
            `;
        }).join('');

        // æ¯æ¬¡è¼‰å…¥æœå°‹çµæžœæ™‚é‡ç½®éµç›¤é¸æ“‡ç´¢å¼•
        patientSearchSelectionIndex = -1;
        resultsContainer.classList.remove('hidden');
    } catch (error) {
        console.error('æœå°‹ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
                æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æŽ¥
            </div>
        `;
    }
}

/**
 * è™•ç†æŽ›è™Ÿæœå°‹è¼¸å…¥æ¡†çš„éµç›¤äº‹ä»¶ï¼Œæ”¯æ´ä¸Šä¸‹éµé¸æ“‡æœå°‹çµæžœé …ç›®ï¼Œä¸¦æŒ‰ Enter åŸ·è¡ŒæŽ›è™Ÿã€‚
 * ç•¶æœå°‹çµæžœåˆ—è¡¨é¡¯ç¤ºæ™‚ï¼š
 *  - ArrowDown æœƒç§»å‹•åˆ°ä¸‹ä¸€å€‹çµæžœï¼›
 *  - ArrowUp æœƒç§»å‹•åˆ°ä¸Šä¸€å€‹çµæžœï¼›
 *  - Enter æœƒé¸ä¸­ç•¶å‰é«˜äº®çš„ç—…äººä¸¦åŸ·è¡Œ selectPatientForRegistrationã€‚
 * è‹¥æ²’æœ‰æœå°‹çµæžœæˆ–åˆ—è¡¨æœªé¡¯ç¤ºï¼Œå‰‡ä¸åšä»»ä½•è™•ç†ã€‚
 * @param {KeyboardEvent} ev éµç›¤äº‹ä»¶
 */
function handlePatientSearchKeyDown(ev) {
    const key = ev && ev.key;
    if (!key || !(['ArrowUp', 'ArrowDown', 'Enter'].includes(key))) {
        return;
    }
    try {
        const resultsContainer = document.getElementById('patientSearchResults');
        const resultsList = document.getElementById('searchResultsList');
        // åƒ…ç•¶çµæžœå®¹å™¨å­˜åœ¨ä¸”ç‚ºé¡¯ç¤ºç‹€æ…‹æ™‚è™•ç†
        if (!resultsContainer || resultsContainer.classList.contains('hidden')) {
            return;
        }
        const items = Array.from(resultsList.querySelectorAll('[data-patient-id]'));
        if (!items || items.length === 0) {
            return;
        }
        if (key === 'ArrowDown') {
            ev.preventDefault();
            // é¸æ“‡ä¸‹ä¸€é …ç›®ï¼Œè¶…å‡ºç¯„åœå‰‡å›žåˆ°ç¬¬ä¸€é …
            patientSearchSelectionIndex = (patientSearchSelectionIndex + 1) % items.length;
            // æ›´æ–°é«˜äº®
            items.forEach((el, idx) => {
                if (idx === patientSearchSelectionIndex) {
                    el.classList.add('bg-blue-100');
                } else {
                    el.classList.remove('bg-blue-100');
                }
            });
            // ç¢ºä¿ç›®å‰é¸ä¸­é …ç›®å¯è¦‹
            const currentEl = items[patientSearchSelectionIndex];
            if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                currentEl.scrollIntoView({ block: 'nearest' });
            }
        } else if (key === 'ArrowUp') {
            ev.preventDefault();
            // é¸æ“‡ä¸Šä¸€é …ç›®ï¼Œè¶…å‡ºç¯„åœå‰‡å›žåˆ°æœ€å¾Œä¸€é …
            patientSearchSelectionIndex = (patientSearchSelectionIndex - 1 + items.length) % items.length;
            // æ›´æ–°é«˜äº®
            items.forEach((el, idx) => {
                if (idx === patientSearchSelectionIndex) {
                    el.classList.add('bg-blue-100');
                } else {
                    el.classList.remove('bg-blue-100');
                }
            });
            // ç¢ºä¿ç›®å‰é¸ä¸­é …ç›®å¯è¦‹
            const currentEl = items[patientSearchSelectionIndex];
            if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                currentEl.scrollIntoView({ block: 'nearest' });
            }
        } else if (key === 'Enter') {
            // åƒ…åœ¨å·²é¸ä¸­æŸé …æ™‚è™•ç† Enter
            if (patientSearchSelectionIndex >= 0 && patientSearchSelectionIndex < items.length) {
                ev.preventDefault();
                const selectedEl = items[patientSearchSelectionIndex];
                const pid = selectedEl && selectedEl.dataset ? selectedEl.dataset.patientId : null;
                if (pid) {
                    try {
                        // ç›´æŽ¥å‘¼å«é¸æ“‡ç—…äººå‡½å¼
                        selectPatientForRegistration(pid);
                    } catch (_err) {
                        console.error('éµç›¤é¸æ“‡æŽ›è™Ÿç—…äººå¤±æ•—:', _err);
                    }
                }
            }
        }
    } catch (err) {
        console.error('è™•ç†æŽ›è™Ÿæœå°‹éµç›¤äº‹ä»¶éŒ¯èª¤:', err);
    }
}

/**
 * è™•ç†å€‹äººæ…£ç”¨ä¸­è—¥çµ„åˆæœå°‹æ¬„çš„éµç›¤äº‹ä»¶ã€‚
 * å…è¨±ä½¿ç”¨è€…é€éŽæ–¹å‘éµåœ¨æœå°‹çµæžœä¸­ç§»å‹•é¸æ“‡ï¼Œä¸¦ç”¨ Enter éµé¸å–ã€‚
 * @param {KeyboardEvent} ev éµç›¤äº‹ä»¶
 */
function handleHerbIngredientSearchKeyDown(ev) {
    const key = ev && ev.key;
    // åªè™•ç†ä¸Šä¸‹æ–¹å‘éµèˆ‡ Enter éµ
    if (!key || !(['ArrowUp', 'ArrowDown', 'Enter'].includes(key))) {
        return;
    }
    try {
        const resultsContainer = document.getElementById('herbIngredientSearchResults');
        const resultsList = document.getElementById('herbIngredientSearchList');
        // å¿…é ˆå­˜åœ¨ä¸”ç‚ºé¡¯ç¤ºç‹€æ…‹
        if (!resultsContainer || resultsContainer.classList.contains('hidden')) {
            return;
        }
        // æ‰¾å‡ºå¯é¸é …ç›®ï¼šåƒ…æŒ‘é¸å¸¶æœ‰ cursor-pointer çš„ div
        const items = Array.from(resultsList.querySelectorAll('div.cursor-pointer'));
        if (!items || items.length === 0) {
            return;
        }
        if (key === 'ArrowDown') {
            ev.preventDefault();
            herbIngredientSearchSelectionIndex = (herbIngredientSearchSelectionIndex + 1) % items.length;
            items.forEach((el, idx) => {
                if (idx === herbIngredientSearchSelectionIndex) {
                    el.classList.add('bg-green-200');
                } else {
                    el.classList.remove('bg-green-200');
                }
            });
            const currentEl = items[herbIngredientSearchSelectionIndex];
            if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                currentEl.scrollIntoView({ block: 'nearest' });
            }
        } else if (key === 'ArrowUp') {
            ev.preventDefault();
            herbIngredientSearchSelectionIndex = (herbIngredientSearchSelectionIndex - 1 + items.length) % items.length;
            items.forEach((el, idx) => {
                if (idx === herbIngredientSearchSelectionIndex) {
                    el.classList.add('bg-green-200');
                } else {
                    el.classList.remove('bg-green-200');
                }
            });
            const currentEl = items[herbIngredientSearchSelectionIndex];
            if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                currentEl.scrollIntoView({ block: 'nearest' });
            }
        } else if (key === 'Enter') {
            if (herbIngredientSearchSelectionIndex >= 0 && herbIngredientSearchSelectionIndex < items.length) {
                ev.preventDefault();
                const selectedEl = items[herbIngredientSearchSelectionIndex];
                if (selectedEl && typeof selectedEl.click === 'function') {
                    selectedEl.click();
                }
            }
        }
    } catch (err) {
        console.error('è™•ç†ä¸­è—¥çµ„åˆæœå°‹éµç›¤äº‹ä»¶éŒ¯èª¤:', err);
    }
}

/**
 * è™•ç†å€‹äººæ…£ç”¨ç©´ä½çµ„åˆæœå°‹æ¬„çš„éµç›¤äº‹ä»¶ã€‚
 * å…è¨±ä½¿ç”¨è€…é€éŽæ–¹å‘éµåœ¨æœå°‹çµæžœä¸­ç§»å‹•é¸æ“‡ï¼Œä¸¦ç”¨ Enter éµé¸å–ã€‚
 * @param {KeyboardEvent} ev éµç›¤äº‹ä»¶
 */
function handleAcupointComboSearchKeyDown(ev) {
    const key = ev && ev.key;
    if (!key || !(['ArrowUp', 'ArrowDown', 'Enter'].includes(key))) {
        return;
    }
    try {
        const resultsContainer = document.getElementById('acupointPointSearchResults');
        const resultsList = document.getElementById('acupointPointSearchList');
        if (!resultsContainer || resultsContainer.classList.contains('hidden')) {
            return;
        }
        const items = Array.from(resultsList.querySelectorAll('div.cursor-pointer'));
        if (!items || items.length === 0) {
            return;
        }
        if (key === 'ArrowDown') {
            ev.preventDefault();
            acupointComboSearchSelectionIndex = (acupointComboSearchSelectionIndex + 1) % items.length;
            items.forEach((el, idx) => {
                if (idx === acupointComboSearchSelectionIndex) {
                    el.classList.add('bg-blue-200');
                } else {
                    el.classList.remove('bg-blue-200');
                }
            });
            const currentEl = items[acupointComboSearchSelectionIndex];
            if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                currentEl.scrollIntoView({ block: 'nearest' });
            }
        } else if (key === 'ArrowUp') {
            ev.preventDefault();
            acupointComboSearchSelectionIndex = (acupointComboSearchSelectionIndex - 1 + items.length) % items.length;
            items.forEach((el, idx) => {
                if (idx === acupointComboSearchSelectionIndex) {
                    el.classList.add('bg-blue-200');
                } else {
                    el.classList.remove('bg-blue-200');
                }
            });
            const currentEl = items[acupointComboSearchSelectionIndex];
            if (currentEl && typeof currentEl.scrollIntoView === 'function') {
                currentEl.scrollIntoView({ block: 'nearest' });
            }
        } else if (key === 'Enter') {
            if (acupointComboSearchSelectionIndex >= 0 && acupointComboSearchSelectionIndex < items.length) {
                ev.preventDefault();
                const selectedEl = items[acupointComboSearchSelectionIndex];
                if (selectedEl && typeof selectedEl.click === 'function') {
                    selectedEl.click();
                }
            }
        }
    } catch (err) {
        console.error('è™•ç†ç©´ä½çµ„åˆæœå°‹éµç›¤äº‹ä»¶éŒ¯èª¤:', err);
    }
}
        
// 2. ä¿®æ”¹é¸æ“‡ç—…äººé€²è¡ŒæŽ›è™Ÿå‡½æ•¸
async function selectPatientForRegistration(patientId) {
    // æª¢æŸ¥æ˜¯å¦éœ€è¦é™åˆ¶é†«å¸«æŽ›è™Ÿæ“ä½œï¼šåªæœ‰é†«å¸«åœ¨è¨ºç—‡æ™‚æ‰é™åˆ¶
    let consultingAppointment = null;
    const isDoctorUser = currentUserData && currentUserData.position === 'é†«å¸«';
    if (isDoctorUser) {
        // æª¢æŸ¥ç•¶å¤©æ˜¯å¦æœ‰åŒä¸€é†«å¸«æ­£åœ¨è¨ºç—‡
        consultingAppointment = appointments.find(apt =>
            apt.status === 'consulting' &&
            apt.appointmentDoctor === currentUserData.username &&
            new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
        );
    }
    
    if (consultingAppointment) {
        try {
            // è‹¥é†«å¸«æ­£åœ¨è¨ºç—‡å…¶ä»–ç—…äººï¼Œå–å¾—è©²ç—…äººè³‡æ–™ï¼ˆä½¿ç”¨æ–°å‡½å¼ä»¥é˜²å¿«å–éŽæœŸï¼‰
            const consultingPatient = await getPatientByIdWithRefresh(consultingAppointment.patientId);
            const consultingPatientName = consultingPatient ? consultingPatient.name : 'æŸä½ç—…äºº';
            // If the doctor is currently consulting another patient, inform the user in their chosen language
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•é€²è¡ŒæŽ›è™Ÿï¼æ‚¨ç›®å‰æ­£åœ¨ç‚º ${consultingPatientName} è¨ºç—‡ä¸­ï¼Œè«‹å®Œæˆå¾Œå†é€²è¡ŒæŽ›è™Ÿæ“ä½œã€‚`;
                const enMsg = `Cannot register! You are currently consulting ${consultingPatientName}. Please finish before registering another patient.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'warning');
            }
            return;
        } catch (error) {
            console.error('æª¢æŸ¥è¨ºç—‡ç‹€æ…‹éŒ¯èª¤:', error);
        }
    }
    
    try {
        // ä½¿ç”¨æ–°çš„å‡½å¼å–å¾—é¸æ“‡çš„ç—…äººè³‡æ–™
        const patient = await getPatientByIdWithRefresh(patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }
        selectedPatientForRegistration = patient;
        showRegistrationModal(patient);
    } catch (error) {
        console.error('é¸æ“‡ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}
        
        // æ¸…é™¤ç—…äººæœç´¢
        function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.add('hidden');
            selectedPatientForRegistration = null;
        }
        

        
        // é¡¯ç¤ºæŽ›è™Ÿå½ˆçª—
        function showRegistrationModal(patient) {
            if (!patient) return;
            
            // é¡¯ç¤ºé¸ä¸­çš„ç—…äººè³‡è¨Šï¼Œå°æ–‡å­—é€²è¡Œè½‰ç¾©é¿å… XSS
            const safeName = window.escapeHtml(patient.name);
            const safeNumber = window.escapeHtml(patient.patientNumber || '');
            const safeAge = window.escapeHtml(formatAge(patient.birthDate));
            const safeGender = window.escapeHtml(patient.gender);
            const safePhone = window.escapeHtml(patient.phone);
            document.getElementById('selectedPatientInfo').innerHTML = `
                <div class="space-y-1">
                    <div><span class="font-medium">å§“åï¼š</span>${safeName}</div>
                    <div><span class="font-medium">ç·¨è™Ÿï¼š</span>${safeNumber}</div>
                    <div><span class="font-medium">å¹´é½¡ï¼š</span>${safeAge} | <span class="font-medium">æ€§åˆ¥ï¼š</span>${safeGender}</div>
                    <div><span class="font-medium">é›»è©±ï¼š</span>${safePhone}</div>
                </div>
            `;
            
            // è¼‰å…¥é†«å¸«é¸é …
            loadDoctorOptions();
            
            // è¨­ç½®é è¨­æŽ›è™Ÿæ™‚é–“ç‚ºç•¶å‰æ™‚é–“ï¼ˆåŠ 5åˆ†é˜é¿å…æ™‚é–“éŽæœŸï¼‰
            const nowForDefault = new Date();
            nowForDefault.setMinutes(nowForDefault.getMinutes() + 5); // åŠ 5åˆ†é˜ä½œç‚ºé è¨­å€¼
            const defYear = nowForDefault.getFullYear();
            const defMonth = String(nowForDefault.getMonth() + 1).padStart(2, '0');
            const defDay = String(nowForDefault.getDate()).padStart(2, '0');
            const defHours = String(nowForDefault.getHours()).padStart(2, '0');
            const defMinutes = String(nowForDefault.getMinutes()).padStart(2, '0');
            const localDateTime = `${defYear}-${defMonth}-${defDay}T${defHours}:${defMinutes}`;

            // è¨­ç½®æŽ›è™Ÿæ™‚é–“è¼¸å…¥æ¬„çš„é è¨­å€¼
            const appointmentInput = document.getElementById('appointmentDateTime');
            appointmentInput.value = localDateTime;

            // è¨­ç½®å…è¨±é¸æ“‡çš„æœ€å°æ—¥æœŸæ™‚é–“ç‚ºä»Šæ—¥ 00:00
            // ä¾éœ€æ±‚ï¼ŒæŽ›è™Ÿæ™‚é–“åªèƒ½é¸æ“‡ã€Œä»Šæ—¥ã€æˆ–ä¹‹å¾Œçš„æ—¥æœŸ
            const today = new Date();
            const tYear = today.getFullYear();
            const tMonth = String(today.getMonth() + 1).padStart(2, '0');
            const tDay = String(today.getDate()).padStart(2, '0');
            const minDateTime = `${tYear}-${tMonth}-${tDay}T00:00`;
            appointmentInput.min = minDateTime;
            
            clearRegistrationForm();
            // æ ¹æ“šç—…äººè¼‰å…¥å•è¨ºè³‡æ–™é¸é …
            try {
                loadInquiryOptions(patient);
            } catch (_e) {
                console.warn('è¼‰å…¥å•è¨ºè³‡æ–™é¸é …å¤±æ•—:', _e);
            }
            document.getElementById('registrationModal').classList.remove('hidden');
        }
        
        // è¼‰å…¥é†«å¸«é¸é …
        function loadDoctorOptions() {
            const doctorSelect = document.getElementById('appointmentDoctor');
            
            // ç²å–æ‰€æœ‰å•Ÿç”¨çš„é†«å¸«ç”¨æˆ¶
            const doctors = users.filter(user => 
                user.active && user.position === 'é†«å¸«'
            );
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™é è¨­é¸é …ï¼‰
            doctorSelect.innerHTML = '<option value="">è«‹é¸æ“‡é†«å¸«</option>';
    // å–å¾—ç¿»è­¯å‡½å¼
    const translate = typeof window.t === 'function' ? window.t : (s) => s;

    // æ·»åŠ é†«å¸«é¸é …ï¼Œå‹•æ…‹ç¿»è­¯è·ä½åç¨±ã€‚
    doctors.forEach(doctor => {
        const option = document.createElement('option');
        option.value = doctor.username;
        // å–å¾—ç¿»è­¯å¾Œçš„è·ä½åç¨±
        const translatedRole = translate('é†«å¸«');
        // æ ¹æ“šç¿»è­¯çµæžœæ±ºå®šæ˜¯å¦åœ¨å§“åèˆ‡è·ä½ä¹‹é–“æ’å…¥ç©ºæ ¼ã€‚
        const joiner = translatedRole !== 'é†«å¸«' ? ' ' : '';
        option.textContent = `${doctor.name}${joiner}${translatedRole}`;
        // è‹¥æœ‰è¨»å†Šç·¨è™Ÿå‰‡åŠ å…¥æ‹¬è™Ÿé¡¯ç¤º
        if (doctor.registrationNumber) {
            option.textContent += ` (${doctor.registrationNumber})`;
        }
        doctorSelect.appendChild(option);
    });

    // å¦‚æžœç•¶å‰ç”¨æˆ¶æ˜¯é†«å¸«ï¼Œé è¨­é¸æ“‡è‡ªå·±
    if (currentUserData && currentUserData.position === 'é†«å¸«') {
        doctorSelect.value = currentUserData.username;
    }
        }
        
        // é—œé–‰æŽ›è™Ÿå½ˆçª—
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.add('hidden');
            clearRegistrationForm();
            selectedPatientForRegistration = null;
        }
        
        // æ¸…ç©ºæŽ›è™Ÿè¡¨å–®
        function clearRegistrationForm() {
            document.getElementById('appointmentDoctor').value = '';
            document.getElementById('quickChiefComplaint').value = '';
            // é‡ç½®å•è¨ºè³‡æ–™ä¸‹æ‹‰é¸å–®
            const inquirySelect = document.getElementById('inquirySelect');
            if (inquirySelect) {
                inquirySelect.value = '';
            }

            // é‡è¨­ä¸»è¨´æ¬„ä½é¡¯ç¤ºç‹€æ…‹ï¼ˆè‹¥å·²æœ‰å•è¨ºè³‡æ–™å‰‡éš±è—ï¼Œåä¹‹é¡¯ç¤ºï¼‰
            try {
                const toggler = window.toggleChiefComplaintVisibility;
                if (typeof toggler === 'function') {
                    toggler();
                }
            } catch (_e) {
                // è‹¥æœªå®šç¾©åˆ‡æ›å‡½å¼ï¼Œå¿½ç•¥éŒ¯èª¤
            }
        }
        
        // ç¢ºèªæŽ›è™Ÿ
        async function confirmRegistration() {
            if (!selectedPatientForRegistration) {
                showToast('ç³»çµ±éŒ¯èª¤ï¼šæœªé¸æ“‡ç—…äººï¼', 'error');
                return;
            }
            
            const appointmentDateTime = document.getElementById('appointmentDateTime').value;
            const appointmentDoctor = document.getElementById('appointmentDoctor').value;
            const chiefComplaint = document.getElementById('quickChiefComplaint').value.trim();

            // å–å¾—é¸æ“‡çš„å•è¨ºè³‡æ–™ ID ä¸¦æº–å‚™å°æ‡‰çš„è³‡æ–™
            let selectedInquiryId = '';
            let inquiryDataForAppointment = null;
            let inquirySummaryForAppointment = '';
            try {
                const inquirySelectEl = document.getElementById('inquirySelect');
                if (inquirySelectEl) {
                    selectedInquiryId = inquirySelectEl.value;
                }
                if (selectedInquiryId) {
                    const rec = inquiryOptionsData ? inquiryOptionsData[selectedInquiryId] : null;
                    if (rec && rec.data) {
                        inquiryDataForAppointment = rec.data;
                        // ç”¢ç”Ÿæ‘˜è¦ä¾›é å¡«ä¸»è¨´æˆ–å±•ç¤º
                        inquirySummaryForAppointment = getMainSymptomFromResult(rec.data);
                    }
                }
            } catch (err) {
                console.warn('è™•ç†å•è¨ºè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
            }
            
            if (!appointmentDateTime) {
                showToast('è«‹é¸æ“‡æŽ›è™Ÿæ™‚é–“ï¼', 'error');
                return;
            }
            
            if (!appointmentDoctor) {
                showToast('è«‹é¸æ“‡æŽ›è™Ÿé†«å¸«ï¼', 'error');
                return;
            }
            
            // é©—è­‰é¸æ“‡çš„é†«å¸«æ˜¯å¦å­˜åœ¨ä¸”å•Ÿç”¨
            const selectedDoctor = users.find(user => 
                user.username === appointmentDoctor && 
                user.active && 
                user.position === 'é†«å¸«'
            );
            
            if (!selectedDoctor) {
                showToast('é¸æ“‡çš„é†«å¸«ç„¡æ•ˆï¼Œè«‹é‡æ–°é¸æ“‡ï¼', 'error');
                return;
            }
            
            // é©—è­‰æŽ›è™Ÿæ™‚é–“ä¸èƒ½æ˜¯éŽåŽ»æ™‚é–“ï¼ˆå…è¨±1åˆ†é˜çš„èª¤å·®ï¼‰
            const selectedTime = new Date(appointmentDateTime);
            const now = new Date();
            now.setMinutes(now.getMinutes() - 1); // å…è¨±1åˆ†é˜èª¤å·®
            if (selectedTime < now) {
                showToast('æŽ›è™Ÿæ™‚é–“ä¸èƒ½æ—©æ–¼ç¾åœ¨æ™‚é–“ï¼', 'error');
                return;
            }

            // åœ¨é€²å…¥éžåŒæ­¥è™•ç†å‰ï¼Œç‚ºæŽ›è™ŸæŒ‰éˆ•é¡¯ç¤ºè®€å–åœˆã€‚
            // ä½¿ç”¨é€šç”¨è¼”åŠ©å‡½å¼ä»¥å…¼å®¹äº‹ä»¶èˆ‡éžäº‹ä»¶è§¸ç™¼çš„æƒ…æ³ã€‚
            let loadingButton = getLoadingButtonFromEvent('button[onclick="confirmRegistration()"]');
            if (loadingButton) {
                // å‚³å…¥çš„æ–‡å­—åƒ…ç”¨æ–¼èªžæ„æè¿°ï¼Œå¯¦éš› setButtonLoading åªé¡¯ç¤ºè®€å–åœˆ
                setButtonLoading(loadingButton, 'æŽ›è™Ÿä¸­...');
            }
            
            // å»ºç«‹æŽ›è™Ÿç‰©ä»¶ï¼Œé™¤äº†å‚³å…¥ ID èˆ‡å¸³è™Ÿä¹‹å¤–ï¼ŒåŒæ™‚å„²å­˜ç—…äººå§“åèˆ‡é†«å¸«å§“åã€‚
            // é€™å¯é¿å…æ—¥å¾Œåœ¨ç›£è½æŽ›è™Ÿç‹€æ…‹æ™‚ç‚ºäº†å–å¾—å§“åè€Œå†æ¬¡æŸ¥è©¢ç—…äººé›†åˆã€‚
            const appointment = {
                id: Date.now(),
                patientId: selectedPatientForRegistration.id,
                // æ–°å¢žï¼šç›´æŽ¥ä¿å­˜ç—…äººå§“åï¼Œä¾›å¾ŒçºŒç›£è½æˆ–é¡¯ç¤ºä½¿ç”¨
                patientName: selectedPatientForRegistration.name,
                appointmentTime: selectedTime.toISOString(),
                appointmentDoctor: appointmentDoctor,
                // æ–°å¢žï¼šç›´æŽ¥ä¿å­˜é†«å¸«å§“åï¼Œä¾›å¾ŒçºŒç›£è½æˆ–é¡¯ç¤ºä½¿ç”¨
                doctorName: selectedDoctor.name,
                chiefComplaint: chiefComplaint || 'ç„¡ç‰¹æ®Šä¸»è¨´',
                status: 'registered', // registered, waiting, consulting, completed
                createdAt: new Date().toISOString(),
                createdBy: currentUserData ? currentUserData.username : currentUser
            };

            // è‹¥æœ‰é¸æ“‡å•è¨ºè³‡æ–™ï¼Œåƒ…ä¿å­˜å•è¨º ID èˆ‡æ‘˜è¦ã€‚é¿å…å°‡å®Œæ•´å•è¨ºå…§å®¹å­˜å…¥æŽ›è™Ÿè³‡æ–™ï¼Œ
            // ä»¥ä¾¿åœ¨ä¸åŒè£ç½®ä¸Šéƒ½èƒ½å¾ž Firestore å–å¾—å•è¨ºè©³æƒ…ã€‚ä¿å­˜æ‘˜è¦æ–¹ä¾¿å¿«é€Ÿå±•ç¤ºã€‚
            if (inquiryDataForAppointment) {
                appointment.inquiryId = selectedInquiryId;
                appointment.inquirySummary = inquirySummaryForAppointment || '';
                // è‹¥æœªè¼¸å…¥ä¸»è¨´æˆ–ä¸»è¨´ç‚ºé è¨­å€¼ï¼Œä½¿ç”¨å•è¨ºæ‘˜è¦ä½œç‚ºä¸»è¨´
                if (!chiefComplaint || chiefComplaint === 'ç„¡ç‰¹æ®Šä¸»è¨´') {
                    appointment.chiefComplaint = inquirySummaryForAppointment || 'ç„¡ç‰¹æ®Šä¸»è¨´';
                }
            }

            try {
                // åŠ å…¥æœ¬åœ°é™£åˆ—
                appointments.push(appointment);
                // å°‡æŽ›è™Ÿè³‡è¨Šå­˜å…¥ Firebase Realtime Database
                const result = await window.firebaseDataManager.addAppointment(appointment);
                // æ›´æ–°æœ¬åœ°å„²å­˜ä½œç‚ºå‚™ä»½
                localStorage.setItem('appointments', JSON.stringify(appointments));
                if (result.success) {
                    {
                        // Show registration success message based on language
                        const lang = localStorage.getItem('lang') || 'zh';
                        const zhMsg = `${selectedPatientForRegistration.name} å·²æŽ›è™Ÿçµ¦ ${selectedDoctor.name}é†«å¸«ï¼`;
                        const enMsg = `${selectedPatientForRegistration.name} has been registered to Dr. ${selectedDoctor.name}`;
                        const msg = lang === 'en' ? enMsg : zhMsg;
                        showToast(msg, 'success');
                    }
                    closeRegistrationModal();
                    clearPatientSearch();
                    loadTodayAppointments();
                } else {
                    showToast('æŽ›è™Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            } catch (error) {
                console.error('æŽ›è™Ÿå¤±æ•—:', error);
                showToast('æŽ›è™Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            } finally {
                // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œçš†é‚„åŽŸæŒ‰éˆ•ç‹€æ…‹
                if (loadingButton) {
                    clearButtonLoading(loadingButton);
                }
            }
        }
        
            // æ¯æ—¥è‡ªå‹•æ¸…ç©ºéŽæœŸæŽ›è™Ÿåˆ—è¡¨ï¼ˆåŒæ­¥åˆ° Firebaseï¼‰
            async function clearOldAppointments() {
                /**
                 * å¾ž Firebase Realtime Database è®€å–æ‰€æœ‰æŽ›è™Ÿè¨˜éŒ„ï¼Œ
                 * å°‡æŽ›è™Ÿæ™‚é–“æ—©æ–¼ä»Šæ—¥ 00:00:00 çš„è¨˜éŒ„åˆªé™¤ã€‚
                 *
                 * åˆ¤æ–·é‚è¼¯ï¼š
                 *  - å–å¾—ä»Šå¤©çš„é–‹å§‹æ™‚é–“ï¼ˆæœ¬åœ°æ™‚é–“ï¼‰
                 *  - å°æ¯ç­†æŽ›è™Ÿç´€éŒ„è§£æžå…¶ appointmentTime
                 *  - è‹¥è©²æ™‚é–“æ—©æ–¼ä»Šæ—¥ï¼Œå‰‡å°‡é€™ç­†è³‡æ–™å¾ž Realtime Database åˆªé™¤
                 *
                 * æ­¤å‡½å¼æœƒåŒæ­¥æ›´æ–°æœ¬åœ°çš„ appointments é™£åˆ—èˆ‡ localStorageã€‚
                 */
                try {
                    // è¨ˆç®—ä»Šæ—¥å‡Œæ™¨æ™‚é–“ï¼ˆæœ¬åœ°æ™‚å€ï¼‰
                    const now = new Date();
                    const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                    // ä½¿ç”¨æŸ¥è©¢åƒ…è®€å–éŽæœŸæŽ›è™Ÿè³‡æ–™ï¼Œä»¥ appointmentTime æŽ’åºä¸¦è¨­å®šçµæŸæ¢ä»¶ç‚ºä»Šæ—¥å‡Œæ™¨
                    // è½‰æ›ç‚º ISO å­—ä¸²ï¼Œæ–¹ä¾¿èˆ‡ Firebase è³‡æ–™åº«ä¸­çš„ ISO æ ¼å¼æ—¥æœŸæ¯”è¼ƒ
                    const startIso = startOfToday.toISOString();
                    const expiredQuery = window.firebase.query(
                        window.firebase.ref(window.firebase.rtdb, 'appointments'),
                        window.firebase.orderByChild('appointmentTime'),
                        window.firebase.endAt(startIso)
                    );
                    const snapshot = await window.firebase.get(expiredQuery);
                    const data = (snapshot && typeof snapshot.val === 'function'
                        ? snapshot.val()
                        : snapshot && snapshot.val) || {};

                    const idsToRemove = [];
                    for (const id in data) {
                        if (!Object.prototype.hasOwnProperty.call(data, id)) continue;
                        const apt = data[id] || {};
                        const timeValue = apt.appointmentTime;
                        // å¦‚æžœæ²’æœ‰ appointmentTimeï¼Œè¦–ç‚ºéŽæœŸè³‡æ–™
                        if (!timeValue) {
                            idsToRemove.push(id);
                            continue;
                        }
                        const aptDate = new Date(timeValue);
                        if (isNaN(aptDate.getTime())) {
                            // ç„¡æ³•è§£æžæ—¥æœŸï¼Œè¦–ç‚ºéŽæœŸ
                            idsToRemove.push(id);
                            continue;
                        }
                        // å¦‚æžœæŽ›è™Ÿæ™‚é–“åœ¨ä»Šæ—¥å‡Œæ™¨ä¹‹å‰ï¼ˆæ˜¨å¤©æˆ–æ›´æ—©ï¼‰ï¼Œå‰‡åˆªé™¤
                        if (aptDate < startOfToday) {
                            idsToRemove.push(id);
                        }
                    }

                    // è‹¥æ²’æœ‰éœ€è¦åˆªé™¤çš„æŽ›è™Ÿï¼Œç›´æŽ¥è¿”å›ž
                    if (idsToRemove.length === 0) {
                        console.log('æ²’æœ‰éŽæœŸæŽ›è™Ÿéœ€è¦æ¸…é™¤ã€‚');
                        return;
                    }

                    // åˆªé™¤æ¯ç­†éŽæœŸçš„æŽ›è™Ÿ
                    for (const id of idsToRemove) {
                        try {
                            await window.firebase.remove(
                                window.firebase.ref(window.firebase.rtdb, 'appointments/' + id)
                            );
                        } catch (removeError) {
                            console.error('åˆªé™¤éŽæœŸæŽ›è™Ÿå¤±æ•—:', id, removeError);
                        }
                    }

                    // æ›´æ–°æœ¬åœ° appointments é™£åˆ—
                    if (typeof appointments !== 'undefined' && Array.isArray(appointments)) {
                        appointments = appointments.filter(apt => !idsToRemove.includes(String(apt.id)));
                        localStorage.setItem('appointments', JSON.stringify(appointments));
                    }

                    console.log(`æ¸…é™¤ ${idsToRemove.length} ç­†éŽæœŸæŽ›è™Ÿå®Œæˆã€‚`);
                } catch (error) {
                    console.error('æ¸…é™¤éŽæœŸæŽ›è™Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
            }



// 3. ä¿®æ”¹ä»Šæ—¥æŽ›è™Ÿåˆ—è¡¨è¼‰å…¥åŠŸèƒ½ï¼Œç¢ºä¿èƒ½æ­£ç¢ºé¡¯ç¤ºç—…äººè³‡è¨Š
async function loadTodayAppointments() {
    // å·²åœ¨åˆ‡æ›åˆ°æŽ›è™Ÿç³»çµ±æ™‚æ¸…é™¤éŽæœŸæŽ›è™Ÿï¼Œé€™è£¡ä¸å†é‡è¤‡åŸ·è¡Œã€‚
    // å¦‚æžœéœ€è¦æ‰‹å‹•æ¸…é™¤ï¼Œè«‹åœ¨èª¿ç”¨ loadConsultationSystem å‰å‘¼å« clearOldAppointmentsã€‚
    // await clearOldAppointments();

    // å¦‚æžœå…¨åŸŸ appointments å°šæœªæœ‰è³‡æ–™ï¼Œå‰‡å¾ž Firebase è®€å–æŽ›è™Ÿè³‡æ–™ã€‚è‹¥å·²æœ‰è³‡æ–™å‰‡ç›´æŽ¥ä½¿ç”¨ï¼Œé¿å…é‡è¤‡è®€å–ã€‚
    if (!Array.isArray(appointments) || appointments.length === 0) {
        try {
            const result = await window.firebaseDataManager.getAppointments();
            if (result.success) {
                appointments = result.data.map(apt => {
                    return { ...apt };
                });
                // æ›´æ–°æœ¬åœ°å­˜å„²ä½œç‚ºå‚™ä»½
                localStorage.setItem('appointments', JSON.stringify(appointments));
            } else {
                console.warn('ç„¡æ³•å¾ž Firebase è®€å–æŽ›è™Ÿè³‡æ–™ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
            }
        } catch (error) {
            console.error('è®€å–æŽ›è™Ÿè³‡æ–™éŒ¯èª¤:', error);
        }
    }

    // å–å¾—æŽ›è™Ÿåˆ—è¡¨å®¹å™¨ä¸¦å…ˆé¡¯ç¤ºå¤§è®€å–åœˆã€‚
    try {
        const tbodyLoading = document.getElementById('todayAppointmentsList');
        if (tbodyLoading) {
            tbodyLoading.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                        <div class="mt-2">è¼‰å…¥ä¸­...</div>
                    </td>
                </tr>
            `;
        }
    } catch (_err) {
        // å¦‚æžœæ¸²æŸ“è®€å–åœˆå¤±æ•—ï¼Œä¸å½±éŸ¿å¾ŒçºŒæµç¨‹
    }

    // æ ¹æ“šæ—¥æœŸé¸æ“‡å™¨æ±ºå®šè¦é¡¯ç¤ºçš„æ—¥æœŸï¼›è‹¥æœªé¸æ“‡å‰‡ä½¿ç”¨ä»Šæ—¥
    let targetDate = new Date();
    try {
        const datePicker = document.getElementById('appointmentDatePicker');
        if (datePicker && datePicker.value) {
            const selected = new Date(datePicker.value);
            if (!isNaN(selected.getTime())) {
                targetDate = selected;
            }
        }
    } catch (_e) {
        // è‹¥å–å¾—æ—¥æœŸå¤±æ•—å‰‡ç¶­æŒä»Šæ—¥
    }
    const targetDateStr = targetDate.toDateString();
    let todayAppointments = appointments.filter(apt => 
        new Date(apt.appointmentTime).toDateString() === targetDateStr
    );
    
    // å¦‚æžœç•¶å‰ç”¨æˆ¶æ˜¯é†«å¸«ï¼Œåªé¡¯ç¤ºæŽ›çµ¦è‡ªå·±çš„ç—…äºº
    if (currentUserData && currentUserData.position === 'é†«å¸«') {
        todayAppointments = todayAppointments.filter(apt => 
            apt.appointmentDoctor === currentUserData.username
        );
    }
    
    // æŒ‰æ™‚é–“æŽ’åº
    todayAppointments.sort((a, b) => new Date(a.appointmentTime) - new Date(b.appointmentTime));
    
    const tbody = document.getElementById('todayAppointmentsList');
    document.getElementById('todayTotal').textContent = todayAppointments.length;
    
    if (todayAppointments.length === 0) {
        const message = currentUserData && currentUserData.position === 'é†«å¸«' 
            ? 'ä»Šæ—¥æš«ç„¡æŽ›çµ¦æ‚¨çš„ç—…äºº' 
            : 'ä»Šæ—¥æš«ç„¡æŽ›è™Ÿè¨˜éŒ„';
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    ${message}
                </td>
            </tr>
        `;
        return;
    }
    
    try {
        // å„ªå…ˆä½¿ç”¨å¿«å–çš„ç—…äººè³‡æ–™ä¾†é¿å…é‡è¤‡å¾ž Firebase è®€å–ã€‚
        const patientsData = await fetchPatients();

        // å°æ–¼æ¯ä¸€ç­†æŽ›è™Ÿè³‡æ–™ï¼Œç›´æŽ¥ä½¿ç”¨è©²æ¬¡æŽ›è™Ÿçš„ä¸»è¨´ï¼Œä¸å†å¾žç—…æ­·å›žå¡«ä¸»è¨´ã€‚
        const rows = await Promise.all(todayAppointments.map(async (appointment, index) => {
            // å¾žè³‡æ–™é›†ä¸­å°‹æ‰¾å°æ‡‰ç—…äºº
            let patient = patientsData.find(p => p && p.id === appointment.patientId);
            // è‹¥ç„¡å°æ‡‰ç—…äººè³‡æ–™ï¼Œå˜—è©¦åˆ·æ–°å¾Œå–å¾—
            if (!patient) {
                try {
                    patient = await getPatientByIdWithRefresh(appointment.patientId);
                } catch (_e) {
                    patient = null;
                }
            }
            // è‹¥ä»ç„¡ç—…äººè³‡æ–™ï¼Œå˜—è©¦å¾žå…¨åŸŸ patients è®Šæ•¸å°‹æ‰¾ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
            if (!patient) {
                const localPatient = Array.isArray(patients) ? patients.find(p => p && p.id === appointment.patientId) : null;
                if (localPatient) {
                    // ä½¿ç”¨æœ¬åœ°ç—…äººè³‡æ–™
                    return createAppointmentRow(appointment, localPatient, index);
                }
                // æœ€çµ‚ä»ç„¡ç—…äººè³‡æ–™æ™‚ï¼Œä½¿ç”¨æŽ›è™Ÿç‰©ä»¶ä¸­çš„ç—…äººå§“åä½œç‚ºå¾Œå‚™é¡¯ç¤ºï¼Œé¿å…é¡¯ç¤ºéŒ¯èª¤è¡Œã€‚
                // ç”±æ–¼æ­¤æƒ…æ³é€šå¸¸ç™¼ç”Ÿæ–¼å…¶ä»–ä½¿ç”¨è€…å‰›æ–°å¢žç—…äººå¾Œç«‹å³æŽ›è™Ÿï¼Œæœ¬åœ°å¿«å–å°šæœªæ›´æ–°ã€‚
                // æ­¤è™•ä»¥ appointment.patientName ä½œç‚ºåç¨±ï¼Œç—…æ­·è™Ÿç¢¼æš«ç•™ç©ºã€‚
                const fallbackPatient = {
                    id: appointment.patientId,
                    name: appointment.patientName || (window.t ? window.t('æœªçŸ¥ç—…äºº') : 'æœªçŸ¥ç—…äºº'),
                    patientNumber: ''
                };
                return createAppointmentRow(appointment, fallbackPatient, index);
            }
            // ä½¿ç”¨æ‰¾åˆ°çš„ç—…äººè³‡æ–™å»ºç«‹æŽ›è™Ÿåˆ—
            return createAppointmentRow(appointment, patient, index);
        }));

        tbody.innerHTML = rows.join('');

    } catch (error) {
        console.error('è¼‰å…¥æŽ›è™Ÿåˆ—è¡¨éŒ¯èª¤:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-red-500">
                    è¼‰å…¥æŽ›è™Ÿåˆ—è¡¨å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢
                </td>
            </tr>
        `;
    }
}

// æ–°å¢žï¼šè¨‚é–± Firebase Realtime Database çš„æŽ›è™Ÿè®Šå‹•ï¼Œå¯¦æ™‚æ›´æ–°ä»Šæ—¥æŽ›è™Ÿåˆ—è¡¨
function subscribeToAppointments() {
    // æ ¹æ“šæ—¥æœŸé¸æ“‡å™¨æ±ºå®šè¦ç›£è½çš„æ—¥æœŸç¯„åœï¼›è‹¥æœªé¸æ“‡å‰‡ç›£è½ä»Šæ—¥
    let targetDate = new Date();
    try {
        const datePicker = document.getElementById('appointmentDatePicker');
        if (datePicker && datePicker.value) {
            const selected = new Date(datePicker.value);
            if (!isNaN(selected.getTime())) {
                targetDate = selected;
            }
        }
    } catch (_e) {
        // ignore; fallback to today
    }
    // è¨ˆç®—è©²æ—¥æœŸçš„é–‹å§‹èˆ‡çµæŸæ™‚é–“ï¼ˆUTC ISO æ ¼å¼ï¼‰
    const startOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
    const endOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), 23, 59, 59, 999);
    const startIso = startOfDay.toISOString();
    const endIso = endOfDay.toISOString();

    // æ§‹å»ºåŸºæœ¬åƒè€ƒè·¯å¾‘
    const appointmentsRef = window.firebase.ref(window.firebase.rtdb, 'appointments');
    // ä½¿ç”¨ Realtime Database æŸ¥è©¢ä»¥ç¯©é¸ç•¶å¤©çš„æŽ›è™Ÿè³‡æ–™ï¼Œæ¸›å°‘ç›£è½ç¯„åœ
    const appointmentsQuery = window.firebase.query(
        appointmentsRef,
        window.firebase.orderByChild('appointmentTime'),
        window.firebase.startAt(startIso),
        window.firebase.endAt(endIso)
    );
    // å¦‚æžœå…ˆå‰å·²ç¶“æœ‰ç›£è½å™¨ï¼Œå…ˆå–æ¶ˆä»¥é¿å…é‡è¤‡è§¸ç™¼
    if (window.appointmentsListener && window.appointmentsQuery) {
        try {
            window.firebase.off(window.appointmentsQuery, 'value', window.appointmentsListener);
        } catch (e) {
            console.error('å–æ¶ˆæŽ›è™Ÿç›£è½å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
        }
    }
    // å­˜å„²æœ¬æ¬¡æŸ¥è©¢ï¼Œä»¥ä¾¿å¾ŒçºŒå–æ¶ˆç›£è½
    window.appointmentsQuery = appointmentsQuery;
    // åˆå§‹åŒ–å‰ä¸€æ¬¡ç‹€æ…‹è¨˜éŒ„
    if (!window.previousAppointmentStatuses) {
        window.previousAppointmentStatuses = {};
    }
    // å»ºç«‹æ–°çš„ç›£è½å›žèª¿ï¼Œä½¿ç”¨ async ä»¥ä¾¿åœ¨åµæ¸¬åˆ°ç‹€æ…‹è®Šæ›´æ™‚è®€å–ç—…äººè³‡æ–™
    window.appointmentsListener = async (snapshot) => {
        const data = snapshot.val() || {};
        // å–å¾—æ–°çš„æŽ›è™Ÿè³‡æ–™é™£åˆ—
        const newAppointments = Object.keys(data).map(key => {
            return { id: key, ...data[key] };
        });
        try {
            // åˆ¤æ–·æ˜¯å¦æœ‰ç—…äººç‹€æ…‹è®Šæ›´ç‚ºå€™è¨ºä¸­éœ€è¦é€šçŸ¥
            const toNotify = [];
            // åˆ¤æ–·æ˜¯å¦æœ‰ç—…äººç‹€æ…‹è®Šæ›´ç‚ºå®Œæˆè¨ºç—‡éœ€è¦é€šçŸ¥è¨ºæ‰€åŠ©ç†
            const completedNotify = [];
            for (const apt of newAppointments) {
                const prevStatus = window.previousAppointmentStatuses[apt.id];
                // ç•¶å‰ç‹€æ…‹ç‚ºå€™è¨ºä¸­ä¸”èˆ‡å…ˆå‰ç‹€æ…‹ä¸åŒï¼Œè¦–ç‚ºæ–°çš„å€™è¨ºäº‹ä»¶
                if (prevStatus !== undefined && prevStatus !== apt.status && apt.status === 'waiting') {
                    toNotify.push(apt);
                }
                // è‹¥ç‹€æ…‹ç”±å…¶å®ƒç‹€æ…‹è®Šæ›´ç‚º completedï¼Œè¦–ç‚ºå®Œæˆè¨ºç—‡äº‹ä»¶
                if (prevStatus !== undefined && prevStatus !== apt.status && apt.status === 'completed') {
                    completedNotify.push(apt);
                }
                // æ›´æ–°ç‹€æ…‹ç´€éŒ„
                window.previousAppointmentStatuses[apt.id] = apt.status;
            }
            // å¦‚æžœæœ‰éœ€è¦é€šçŸ¥çš„æŽ›è™Ÿä¸¦ä¸”ç›®å‰ä½¿ç”¨è€…æ˜¯é†«å¸«
            if (toNotify.length > 0 && currentUserData && currentUserData.position === 'é†«å¸«') {
                let patientsList = null;
                for (const apt of toNotify) {
                    // åƒ…é€šçŸ¥è©²é†«å¸«æ‰€å±¬çš„æŽ›è™Ÿ
                    if (apt.appointmentDoctor === currentUserData.username) {
                        // å„ªå…ˆä½¿ç”¨æŽ›è™Ÿç‰©ä»¶ä¸­çš„ç—…äººå§“å
                        let patientName = '';
                        if (apt.patientName) {
                            patientName = apt.patientName;
                        } else {
                            // åƒ…ç•¶ç¼ºå°‘ patientName æ™‚æ‰è®€å–ä¸€æ¬¡å®Œæ•´ç—…äººåˆ—è¡¨
                            if (!patientsList) {
                                try {
                                    patientsList = await fetchPatients();
                                } catch (fetchErr) {
                                    console.error('è®€å–ç—…äººè³‡æ–™ä»¥å–å¾—å§“åæ™‚ç™¼ç”ŸéŒ¯èª¤:', fetchErr);
                                }
                            }
                            if (Array.isArray(patientsList)) {
                                let patient = patientsList.find(p => p && p.id === apt.patientId);
                                // è‹¥æœªæ‰¾åˆ°ï¼Œå˜—è©¦è·¨è£ç½®åˆ·æ–°å–å¾—ç—…äººè³‡æ–™
                                if (!patient) {
                                    try {
                                        patient = await getPatientByIdWithRefresh(apt.patientId);
                                    } catch (_e) {
                                        patient = null;
                                    }
                                }
                                patientName = patient ? patient.name : '';
                            }
                        }
                        if (patientName) {
                            // é¡¯ç¤ºæç¤ºä¸¦æ’­æ”¾éŸ³æ•ˆ
                            {
                                // Notify that the patient has entered the waiting state, with translation
                                const lang = localStorage.getItem('lang') || 'zh';
                                const zhMsg = `ç—…äºº ${patientName} å·²é€²å…¥å€™è¨ºä¸­ï¼Œè«‹æº–å‚™è¨ºç—‡ã€‚`;
                                const enMsg = `Patient ${patientName} has entered the waiting state, please prepare for consultation.`;
                                const msg = lang === 'en' ? enMsg : zhMsg;
                                showToast(msg, 'info');
                                playNotificationSound();
                            }
                        }
                    }
                }
            }

            // å¦‚æžœæœ‰è¨ºç—‡å®Œæˆé€šçŸ¥ï¼Œä¸”ç›®å‰ä½¿ç”¨è€…ç‚ºè­·ç†å¸«ã€è¨ºæ‰€ç®¡ç†æˆ–è¨ºæ‰€åŠ©ç†ï¼Œå‰‡æç¤ºä¸¦æ’­æ”¾éŸ³æ•ˆ
            if (completedNotify.length > 0 && currentUserData && currentUserData.position && ['è­·ç†å¸«', 'è¨ºæ‰€ç®¡ç†', 'è¨ºæ‰€åŠ©ç†'].includes(currentUserData.position)) {
                let patientsList2 = null;
                for (const apt of completedNotify) {
                    // åƒ…é€šçŸ¥è©²å®Œæˆäº‹ä»¶
                    // å„ªå…ˆä½¿ç”¨æŽ›è™Ÿç‰©ä»¶ä¸­çš„ç—…äººå§“å
                    let patientName = '';
                    if (apt.patientName) {
                        patientName = apt.patientName;
                    } else {
                        // åƒ…ç•¶ç¼ºå°‘ patientName æ™‚æ‰è®€å–ä¸€æ¬¡å®Œæ•´ç—…äººåˆ—è¡¨
                        if (!patientsList2) {
                            try {
                                patientsList2 = await fetchPatients();
                            } catch (fetchErr) {
                                console.error('è®€å–ç—…äººè³‡æ–™ä»¥å–å¾—å§“åæ™‚ç™¼ç”ŸéŒ¯èª¤:', fetchErr);
                            }
                        }
                        if (Array.isArray(patientsList2)) {
                            let patient = patientsList2.find(p => p && p.id === apt.patientId);
                            // è‹¥æœªæ‰¾åˆ°ï¼Œå˜—è©¦è·¨è£ç½®åˆ·æ–°å–å¾—ç—…äººè³‡æ–™
                            if (!patient) {
                                try {
                                    patient = await getPatientByIdWithRefresh(apt.patientId);
                                } catch (_e) {
                                    patient = null;
                                }
                            }
                            patientName = patient ? patient.name : '';
                        }
                    }
                    if (patientName) {
                        const lang = localStorage.getItem('lang') || 'zh';
                        const zhMsg = `ç—…äºº ${patientName} å·²å®Œæˆè¨ºç—‡ï¼Œå¯é€²è¡Œå¾ŒçºŒè™•ç†ã€‚`;
                        const enMsg = `Patient ${patientName}'s consultation has been completed. Please proceed with follow-up.`;
                        const msg = lang === 'en' ? enMsg : zhMsg;
                        showToast(msg, 'info');
                        playNotificationSound();
                    }
                }
            }
        } catch (err) {
            console.error('è™•ç†å€™è¨ºé€šçŸ¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        }
        // æ›´æ–°å…¨åŸŸæŽ›è™Ÿè³‡æ–™
        appointments = newAppointments;
        // å„²å­˜åˆ°æœ¬åœ°ä½œç‚ºå‚™ä»½
        localStorage.setItem('appointments', JSON.stringify(appointments));
        // é‡æ–°è¼‰å…¥ä»Šæ—¥æŽ›è™Ÿåˆ—è¡¨
        loadTodayAppointments();
        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        updateStatistics();
    };
    // é å…ˆå®šç¾©æŽ›è™Ÿç›£è½å™¨ç‹€æ…‹ï¼Œç”¨æ–¼å‹•æ…‹æŽ›è¼‰/å–æ¶ˆç›£è½
    if (typeof window.appointmentsListenerAttached === 'undefined') {
        window.appointmentsListenerAttached = false;
    }
    // è¨­ç½®ç›£è½å™¨
    window.firebase.onValue(appointmentsQuery, window.appointmentsListener);
    // æ¨™è¨˜æŽ›è™Ÿç›£è½å™¨å·²æŽ›è¼‰ï¼Œç”¨æ–¼å¾ŒçºŒå‹•æ…‹å–æ¶ˆ/é‡æ–°æŽ›è¼‰
    window.appointmentsListenerAttached = true;
    // åœ¨é é¢å¸è¼‰æ™‚è‡ªå‹•å–æ¶ˆç›£è½ï¼Œä»¥é¿å…é›¢é–‹é é¢å¾Œä»æŒçºŒç›£è½é€ æˆè³‡æºæµªè²»
    window.addEventListener('beforeunload', () => {
        if (window.appointmentsListener && window.appointmentsQuery) {
            try {
                window.firebase.off(window.appointmentsQuery, 'value', window.appointmentsListener);
            } catch (e) {
                console.error('å–æ¶ˆæŽ›è™Ÿç›£è½å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
            }
        }
    });

    /**
     * ç¢ºä¿æŽ›è™Ÿç›£è½å™¨åœ¨éœ€è¦æ™‚æŽ›è¼‰ã€‚
     * è‹¥ç›£è½å™¨å°šæœªæŽ›è¼‰ï¼Œä¸”å·²å­˜åœ¨æŸ¥è©¢åŠå›žèª¿ï¼Œå‰‡é‡æ–°æŽ›è¼‰ä»¥ç²å–å³æ™‚æŽ›è™Ÿæ›´æ–°ã€‚
     * é€™å€‹å‡½å¼å¯åœ¨é€²å…¥æŽ›è™Ÿç›¸é—œé é¢æ™‚èª¿ç”¨ï¼Œä»¥æ¸›å°‘ä¸å¿…è¦çš„æŒçºŒç›£è½ã€‚
     */
    function ensureAppointmentsListener() {
        try {
            if (window.appointmentsListenerAttached) return;
            if (window.appointmentsQuery && window.appointmentsListener) {
                window.firebase.onValue(window.appointmentsQuery, window.appointmentsListener);
                window.appointmentsListenerAttached = true;
            }
        } catch (err) {
            console.error('é‡æ–°æŽ›è¼‰æŽ›è™Ÿç›£è½å™¨å¤±æ•—:', err);
        }
    }

    // å°‡å‡½å¼æš´éœ²åˆ°å…¨åŸŸï¼Œä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹ï¼ˆä¾‹å¦‚è¼‰å…¥æŽ›è™Ÿé é¢æ™‚ï¼‰èª¿ç”¨
    try {
        window.ensureAppointmentsListener = ensureAppointmentsListener;
    } catch (_e) {
        // è‹¥ç„¡æ³•è¨­å®šå…¨åŸŸå‡½å¼å‰‡ç•¥éŽ
    }
}



// æ–°å¢žï¼šå¾ž Firebase è¼‰å…¥è¨ºç—‡è¨˜éŒ„é€²è¡Œç·¨è¼¯
async function loadConsultationForEdit(consultationId) {
    // æ¸…é™¤ä¸Šä¸€å€‹è¨ºç—‡æ“ä½œéºç•™çš„å¥—ç¥¨è®Šæ›´è¨˜éŒ„ã€‚
    pendingPackageChanges = [];
    try {
        // å…ˆå˜—è©¦å¾žæœ¬åœ°æ‰¾
        let consultation = null;
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (consultationResult.success) {
                // æ›´æ–°å…¨åŸŸè¨ºç—‡å¿«å–
                consultations = consultationResult.data;
                consultation = consultationResult.data.find(c => String(c.id) === String(consultationId));
            }
        } catch (error) {
            console.error('è®€å–è¨ºç™‚è¨˜éŒ„éŒ¯èª¤:', error);
        }
        // å¦‚æžœæœ¬åœ°æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç›´æŽ¥å¾ž Firestore è®€å–æŒ‡å®š ID çš„è¨ºç—‡è¨˜éŒ„
        if (!consultation) {
            try {
                const docRef = window.firebase.doc(window.firebase.db, 'consultations', String(consultationId));
                const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap && docSnap.exists()) {
                    consultation = { id: docSnap.id, ...docSnap.data() };
                    // åŠ å…¥æœ¬åœ°å¿«å–
                    consultations.push(consultation);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            } catch (err) {
                console.error('ç›´æŽ¥è®€å–è¨ºç™‚è¨˜éŒ„å¤±æ•—:', err);
            }
        }
        if (consultation) {
            // è¼‰å…¥è¨ºç—‡è¨˜éŒ„å…§å®¹
            document.getElementById('formSymptoms').value = consultation.symptoms || '';
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            // formCurrentHistory ç”¨æ–¼é¡¯ç¤ºéŽå¾€è¨ºç—‡æ‘˜è¦ï¼Œä¸æ‡‰åœ¨ç·¨è¼¯æ¨¡å¼ä¸­è¢«è¦†è“‹ã€‚èˆŠè³‡æ–™çš„ç¾ç—…å²å·²èˆ‡ä¸»è¨´åˆä½µï¼Œæ•…ä¸è¼‰å…¥è‡³æ­¤æ¬„ä½ã€‚
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
            {
              const acnEl = document.getElementById('formAcupunctureNotes');
              if (acnEl) {
                // ä½¿ç”¨ innerText è¼‰å…¥é‡ç¸å‚™è¨»å…§å®¹ï¼Œä»¥æ”¯æ´ contenteditable
                // è¼‰å…¥é‡ç¸å‚™è¨»æ™‚ç›´æŽ¥ä½¿ç”¨ innerHTMLï¼Œä»¥ä¿ç•™æ–¹å¡Šæ¨™è¨˜
                acnEl.innerHTML = consultation.acupunctureNotes || '';
                // è¼‰å…¥å®Œç•¢å¾Œåˆå§‹åŒ–æ—¢æœ‰ç©´ä½æ–¹å¡Šçš„äº‹ä»¶è™•ç†
                if (typeof initializeAcupointNotesSpans === 'function') {
                  initializeAcupointNotesSpans();
                }
                // è¼‰å…¥å®Œç•¢å¾Œåˆå§‹åŒ–æ—¢æœ‰ç©´ä½æ–¹å¡Šçš„äº‹ä»¶è™•ç†
                if (typeof initializeAcupointNotesSpans === 'function') {
                  initializeAcupointNotesSpans();
                }
              }
            }
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';

            // è¼‰å…¥å·²ä¿å­˜çš„æœè—¥å¤©æ•¸èˆ‡æ¯æ—¥æœè—¥æ¬¡æ•¸ï¼Œä»¥é¿å…é è¨­å€¼è¦†è“‹åŽŸå§‹è³‡æ–™
            try {
                const daysInputEl = document.getElementById('medicationDays');
                if (daysInputEl) {
                    if (consultation.medicationDays !== undefined && consultation.medicationDays !== null) {
                        daysInputEl.value = consultation.medicationDays;
                    } else {
                        // è‹¥æœªè¨­å®šï¼Œä½¿ç”¨ç©ºå­—ä¸²è¡¨ç¤ºæœªå®šç¾©
                        daysInputEl.value = '';
                    }
                }
                const freqInputEl = document.getElementById('medicationFrequency');
                if (freqInputEl) {
                    if (consultation.medicationFrequency !== undefined && consultation.medicationFrequency !== null) {
                        freqInputEl.value = consultation.medicationFrequency;
                    } else {
                        freqInputEl.value = '';
                    }
                }
            } catch (_e) {
                console.warn('è¼‰å…¥è¨ºç—‡è¨˜éŒ„æ™‚è¨­å®šæœè—¥å¤©æ•¸èˆ‡æ¯æ—¥æ¬¡æ•¸å¤±æ•—:', _e);
            }
            
            // è™•ç†åˆ°è¨ºæ™‚é–“ - æ”¯æ´å¤šç¨®æ—¥æœŸæ ¼å¼
            if (consultation.visitTime) {
                const visitTime = parseConsultationDate(consultation.visitTime);
                if (visitTime) {
                    const year = visitTime.getFullYear();
                    const month = String(visitTime.getMonth() + 1).padStart(2, '0');
                    const day = String(visitTime.getDate()).padStart(2, '0');
                    const hours = String(visitTime.getHours()).padStart(2, '0');
                    const minutes = String(visitTime.getMinutes()).padStart(2, '0');
                    document.getElementById('formVisitTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }
            }
            
            // è¼‰å…¥ä¼‘æ¯æœŸé–“è¨­å®š
            if (consultation.restStartDate && consultation.restEndDate) {
                document.getElementById('formRestStartDate').value = consultation.restStartDate;
                document.getElementById('formRestEndDate').value = consultation.restEndDate;
                updateRestPeriod();
            } else {
                // ä½¿ç”¨é è¨­å€¼
                const startDate = new Date();
                const endDate = new Date();
                // å°‡çµæŸæ—¥æœŸè¨­ç‚ºèˆ‡é–‹å§‹æ—¥æœŸç›¸åŒï¼Œé è¨­ä¼‘æ¯ 1 å¤©
                endDate.setDate(startDate.getDate());
                
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                
                document.getElementById('formRestStartDate').value = startDateStr;
                document.getElementById('formRestEndDate').value = endDateStr;
                updateRestPeriod();
            }
            
            // è¼‰å…¥è™•æ–¹å…§å®¹
            selectedPrescriptionItems = [];
            // å„ªå…ˆä½¿ç”¨çµæ§‹åŒ–è™•æ–¹è³‡æ–™ï¼ˆJSON æ ¼å¼ï¼‰é€²è¡Œé‡å»ºï¼Œä»¥é¿å…å› æ–‡å­—å–®ä½å·®ç•°å°Žè‡´è§£æžå¤±æ•—
            let loadedStructured = false;
            if (consultation.prescriptionStructured) {
                try {
                    const parsedItems = JSON.parse(consultation.prescriptionStructured);
                    if (Array.isArray(parsedItems) && parsedItems.length > 0) {
                        selectedPrescriptionItems = parsedItems;
                        loadedStructured = true;
                    }
                } catch (_e) {
                    // ignore parse errors and fallback to legacy text format
                    loadedStructured = false;
                }
            }
            if (loadedStructured) {
                // é€éŽæ›´æ–°å‡½å¼æ¸²æŸ“è™•æ–¹é¡¯ç¤ºä¸¦åŒæ­¥éš±è—æ–‡æœ¬åŸŸ
                updatePrescriptionDisplay();
            } else if (consultation.prescription) {
                // fallback: ä½¿ç”¨èˆŠç‰ˆæ–‡å­—è™•æ–¹è§£æž
                // å…ˆå°‡å®Œæ•´è™•æ–¹å…§å®¹å­˜å…¥éš±è—æ–‡æœ¬åŸŸ
                document.getElementById('formPrescription').value = consultation.prescription;
                // å˜—è©¦è§£æžè™•æ–¹å…§å®¹ä¸¦ç”Ÿæˆè™•æ–¹é …ç›®åˆ—è¡¨
                parsePrescriptionToItems(consultation.prescription);
                updatePrescriptionDisplay();
                // å¦‚æžœæœªèƒ½è§£æžå‡ºä»»ä½•è™•æ–¹é …ç›®ï¼ˆä¾‹å¦‚åº«ä¸­ç¼ºå°‘ç›¸é—œè—¥ææˆ–æ–¹åŠ‘è³‡æ–™ï¼‰ï¼Œ
                // å‰‡ç›´æŽ¥å°‡åŽŸå§‹è™•æ–¹æ–‡æœ¬é¡¯ç¤ºæ–¼è™•æ–¹å€åŸŸï¼Œé¿å…é¡¯ç¤ºç‚ºç©ºç™½
                if (selectedPrescriptionItems.length === 0) {
                    // é‚„åŽŸéš±è—æ–‡æœ¬åŸŸç‚ºåŽŸå§‹å…§å®¹ï¼Œå› ç‚º updatePrescriptionDisplay æœƒæ¸…ç©ºå®ƒ
                    document.getElementById('formPrescription').value = consultation.prescription;
                    const containerEl = document.getElementById('selectedPrescriptionItems');
                    if (containerEl) {
                        containerEl.innerHTML = `<div class="text-sm text-gray-900 whitespace-pre-line">${consultation.prescription}</div>`;
                    }
                    // éš±è—æœè—¥å¤©æ•¸èˆ‡æ¬¡æ•¸è¨­å®š
                    const medicationSettingsEl = document.getElementById('medicationSettings');
                    if (medicationSettingsEl) {
                        medicationSettingsEl.style.display = 'none';
                    }
                }
            }
            
            // è¼‰å…¥æ”¶è²»é …ç›®
            selectedBillingItems = [];
            if (consultation.billingItems) {
                document.getElementById('formBillingItems').value = consultation.billingItems;
                // è§£æžèˆŠç—…æ­·ä¸­çš„æ”¶è²»é …ç›®
                parseBillingItemsFromText(consultation.billingItems);
                // å˜—è©¦ç‚ºèˆŠç—…æ­·è¼‰å…¥çš„å¥—ç¥¨ä½¿ç”¨é …ç›®è£œå…¨ metaï¼ˆpatientId å’Œ packageRecordIdï¼‰ï¼Œ
                // å„ªå…ˆä½¿ç”¨è¨ºç—‡è¨˜éŒ„ä¸­çš„ patientIdï¼Œè‹¥ä¸å­˜åœ¨å†å˜—è©¦ä½¿ç”¨ç•¶å‰æŽ›è™Ÿï¼ˆcurrentConsultingAppointmentIdï¼‰æŽ¨æ–·ã€‚
                try {
                    // å„ªå…ˆä½¿ç”¨ consultation.patientIdï¼Œå¦‚æžœè³‡æ–™åº«ä¸­æœ‰å­˜å„²ç—…äºº ID
                    let pid = consultation && consultation.patientId ? consultation.patientId : null;
                    // å¦‚æžœ consultation.patientId ä¸å­˜åœ¨ï¼Œé€€è€Œä½¿ç”¨ç•¶å‰æŽ›è™Ÿçš„ç—…äºº ID
                    if (!pid && typeof currentConsultingAppointmentId !== 'undefined' && Array.isArray(appointments)) {
                        // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…æ•¸å­—èˆ‡å­—ä¸²ä¸ä¸€è‡´å°Žè‡´åŒ¹é…å¤±æ•—
                        const appt = appointments.find(ap => ap && String(ap.id) === String(currentConsultingAppointmentId));
                        if (appt) pid = appt.patientId;
                    }
                    if (pid) {
                        await restorePackageUseMeta(pid);
                    }
                } catch (e) {
                    console.error('è¼‰å…¥èˆŠç—…æ­·æ™‚æ¢å¾©å¥—ç¥¨ meta å¤±æ•—:', e);
                }
                // æ›´æ–°é¡¯ç¤º
                updateBillingDisplay();
            }
            
            // å®‰å…¨ç²å–è¨ºç—‡å„²å­˜æŒ‰éˆ•æ–‡æœ¬å…ƒç´ ï¼Œé¿å…ç‚º null æ™‚å‡ºéŒ¯
            const saveButtonTextEl = document.getElementById('consultationSaveButtonText');
            if (saveButtonTextEl) {
                saveButtonTextEl.textContent = 'ä¿å­˜ç—…æ­·';
            } else {
                // å¦‚æžœæ‰¾ä¸åˆ°å…ƒç´ ï¼Œä¸æŠ›å‡ºéŒ¯èª¤ï¼Œè€Œæ˜¯ç´€éŒ„è­¦å‘Šï¼Œé€™æ¨£ä½¿ç”¨è€…å¯ç¹¼çºŒæ“ä½œ
                console.warn('consultationSaveButtonText element not found when loading consultation for edit. Skipping text update.');
            }
        } else {
            showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼Œå°‡ä½¿ç”¨ç©ºç™½è¡¨å–®', 'warning');
            clearConsultationForm();
        }
    } catch (error) {
        console.error('è¼‰å…¥è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
        showToast('è¼‰å…¥è¨ºç—‡è¨˜éŒ„å¤±æ•—ï¼Œå°‡ä½¿ç”¨ç©ºç™½è¡¨å–®', 'warning');
        clearConsultationForm();
    }
}

// æ–°å¢žï¼šè§£æžè¨ºç—‡æ—¥æœŸçš„é€šç”¨å‡½æ•¸
function parseConsultationDate(dateInput) {
    if (!dateInput) return null;
    
    try {
        // å¦‚æžœæ˜¯ Firebase Timestamp æ ¼å¼
        if (dateInput.seconds) {
            return new Date(dateInput.seconds * 1000);
        }
        
        // å¦‚æžœæ˜¯å­—ç¬¦ä¸²æ ¼å¼
        if (typeof dateInput === 'string') {
            const parsed = new Date(dateInput);
            if (!isNaN(parsed.getTime())) {
                return parsed;
            }
        }
        
        // å¦‚æžœæ˜¯ Date å°è±¡
        if (dateInput instanceof Date) {
            return dateInput;
        }
        
        // å¦‚æžœæ˜¯æ•¸å­—æ ¼å¼ï¼ˆtimestampï¼‰
        if (typeof dateInput === 'number') {
            return new Date(dateInput);
        }
        
        return null;
    } catch (error) {
        console.error('æ—¥æœŸè§£æžéŒ¯èª¤:', error, dateInput);
        return null;
    }
}
// ä¿®å¾©æ ¼å¼åŒ–è¨ºç—‡æ—¥æœŸé¡¯ç¤º

function formatConsultationDateTime(dateInput) {
    const date = parseConsultationDate(dateInput);
    if (!date || isNaN(date.getTime())) {
        // Return a languageâ€‘aware fallback when the date cannot be parsed.
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        const dict = (window.translations && window.translations[lang]) ? window.translations[lang] : {};
        // Use a fallback message if a translation is available; otherwise default to the Chinese phrase.
        return dict['æ™‚é–“æœªçŸ¥'] || 'æ™‚é–“æœªçŸ¥';
    }
    // Format the date/time according to the current language.  English uses
    // en-US locale while Chinese uses zh-TW.  We intentionally keep the
    // format consistent with twoâ€‘digit month/day and hour/minute fields.
    const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
    const locale = lang === 'en' ? 'en-US' : 'zh-TW';
    return date.toLocaleString(locale, {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}


        
// 1. ä¿®æ”¹ createAppointmentRow å‡½æ•¸ï¼Œç¢ºä¿è¨ºç—‡è¨˜éŒ„æŒ‰éˆ•æ­£ç¢ºå‚³éž patientId
function createAppointmentRow(appointment, patient, index) {
    // ç²å–æŽ›è™Ÿé†«å¸«è³‡è¨Šï¼Œä¸¦æ ¹æ“šèªžè¨€ç¿»è­¯é†«å¸«ç¨±è¬‚
    const appointmentDoctor = users.find(u => u.username === appointment.appointmentDoctor);
    let doctorName;
    if (appointmentDoctor) {
        // ç¿»è­¯ã€Œé†«å¸«ã€å¾Œç¶´ï¼›éžä¸­æ–‡æ™‚åœ¨å‰é¢åŠ ç©ºæ ¼
        const suffix = window.t ? window.t('é†«å¸«') : 'é†«å¸«';
        const needsSpace = suffix && suffix !== 'é†«å¸«';
        doctorName = needsSpace ? `${appointmentDoctor.name} ${suffix}` : `${appointmentDoctor.name}${suffix}`;
    } else {
        // æ²’æœ‰æŒ‡å®šé†«å¸«æ™‚ï¼Œä»é¡¯ç¤ºç›¸æ‡‰ç¿»è­¯æˆ–åŽŸæ–‡
        doctorName = window.t ? window.t('æœªæŒ‡å®šé†«å¸«') : 'æœªæŒ‡å®šé†«å¸«';
    }
    
    // --------- é¡¯ç¤ºç—…äººå§“åæ™‚åŠ ä¸Šæ€§åˆ¥ ---------
    // å–å¾—ç—…äººæ€§åˆ¥ä¸¦æ ¹æ“šèªžè¨€é¡¯ç¤ºé©ç•¶æ–‡å­—
    let genderRaw = patient && patient.gender ? patient.gender : '';
    let genderDisplay = genderRaw;
    // ä½¿ç”¨ window.t é€²è¡Œç¿»è­¯ï¼›è‹¥æœªæä¾›ç¿»è­¯å‡½å¼å‰‡å›žé€€ç‚ºåŽŸå§‹å€¼
    if (genderDisplay) {
        try {
            if (typeof window !== 'undefined' && typeof window.t === 'function') {
                const translated = window.t(genderDisplay);
                // window.t å¯èƒ½è¿”å›žèˆ‡è¼¸å…¥ä¸åŒçš„å€¼
                if (translated) {
                    genderDisplay = translated;
                }
            }
        } catch (e) {
            // ignore translation error
        }
    }
    // è‹¥ç•¶å‰èªžè¨€ç‚ºè‹±æ–‡ï¼Œå°‡ä¸åŒè¡¨ç¤ºæ–¹å¼çµ±ä¸€ç‚º Male æˆ– Female
    try {
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        const isEnglish = lang && lang.toLowerCase().startsWith('en');
        if (isEnglish && genderDisplay) {
            const gLower = genderDisplay.toLowerCase();
            // In English, display abbreviated gender with single letter rather than full word.
            // Treat various representations of male and female uniformly.
            if (gLower === 'ç”·' || gLower === 'male' || gLower === 'm') {
                genderDisplay = 'M';
            } else if (gLower === 'å¥³' || gLower === 'female' || gLower === 'f') {
                genderDisplay = 'F';
            }
        }
    } catch (e) {
        // ignore language detection errors
    }
    // æ ¹æ“šæ˜¯å¦å­˜åœ¨æ€§åˆ¥è³‡è¨Šæ§‹é€ å§“åå­—ä¸²
    const nameWithGender = genderDisplay ? `${patient.name} (${genderDisplay})` : patient.name;
    // ç‚ºé¿å… XSSï¼Œä½¿ç”¨ escapeHtml è½‰ç¾©å§“ååŠæ‹¬è™Ÿå…§å®¹ï¼ˆè‹¥å¯ç”¨ï¼‰
    const safeNameWithGender = (typeof window !== 'undefined' && window.escapeHtml) ? window.escapeHtml(nameWithGender) : nameWithGender;

    const statusInfo = getStatusInfo(appointment.status);
    const operationButtons = getOperationButtons(appointment, patient); // å‚³éž patient åƒæ•¸

    return `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-900 font-medium">${index + 1}</td>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
                ${safeNameWithGender}
                <div class="text-xs text-gray-500">${patient.patientNumber}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                <div class="font-medium text-blue-600">${doctorName}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                ${new Date(appointment.appointmentTime).toLocaleString('zh-TW', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                ${(() => {
                    // æŽ›è™Ÿåˆ—è¡¨çš„ä¸»è¨´æ–‡å­—åƒ…é¡¯ç¤ºå‰å…«å€‹å­—ï¼Œè¶…éŽéƒ¨åˆ†ä»¥ã€Œâ‹¯ã€å–ä»£ï¼Œé¿å…éŽé•·å…§å®¹å½±éŸ¿ç‰ˆé¢ã€‚
                    const fullComplaint = appointment.chiefComplaint || '';
                    // å¦‚æžœæ²’æœ‰ä¸»è¨´æˆ–ä¸»è¨´ç‚ºç©ºå­—ä¸²ï¼Œé¡¯ç¤ºã€Œç„¡ã€
                    if (!fullComplaint) {
                        return '<div class="max-w-xs truncate" title="ç„¡">ç„¡</div>';
                    }
                    let truncated = '';
                    if (fullComplaint.length > 8) {
                        // è‹¥è¶…éŽé™åˆ¶ï¼Œæˆªå–å‰å…«å€‹å­—ä¸¦åŠ ä¸Šçœç•¥ç¬¦è™Ÿ
                        truncated = fullComplaint.substring(0, 8) + 'â‹¯';
                    } else {
                        truncated = fullComplaint;
                    }
                    // ä½¿ç”¨ title å±¬æ€§é¡¯ç¤ºå®Œæ•´å…§å®¹
                    return '<div class="max-w-xs truncate" title="' + fullComplaint + '">' + truncated + '</div>';
                })()}
            </td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                    ${statusInfo.text}
                </span>
            </td>
            <!--
              å°‡æ“ä½œæŒ‰éˆ•æ¬„ä¿æŒå…§å®¹å¯¬åº¦ï¼Œä¸å†æ’æ»¿æ•´åˆ—ã€‚
              ç‚ºäº†è®“è¡¨é ­ã€Œæ“ä½œã€èˆ‡è¨ºç—‡è¨˜éŒ„æŒ‰éˆ•å·¦å°é½Šï¼Œç§»é™¤ w-full ä»¥åŠ justify-endï¼Œ
              ä½¿æŒ‰éˆ•è‡ªç„¶é å·¦æŽ’åˆ—ã€‚
            -->
            <td class="px-4 py-3 text-sm whitespace-nowrap">
                <!--
                  å°‡æ“ä½œæŒ‰éˆ•å®¹å™¨æ”¹ç‚ºå–®è¡Œé¡¯ç¤ºä¸¦ç¦æ­¢å…§å®¹æ›è¡Œã€‚
                  ä½¿ç”¨ flex æ­é… items-center ä½¿æŒ‰éˆ•åž‚ç›´ç½®ä¸­ï¼Œspace-x-1 æŽ§åˆ¶æŒ‰éˆ•ä¹‹é–“çš„é–“è·ã€‚
                  é€™å¯ä»¥é¿å…åœ¨æŒ‰éˆ•é€²å…¥è®€å–ç‹€æ…‹æˆ–å› å¯¬åº¦è®ŠåŒ–æ™‚å°‡ä¸‹ä¸€å€‹æŒ‰éˆ•æŽ¨åˆ°ä¸‹ä¸€è¡Œï¼Œä¿æŒæŽ’ç‰ˆç©©å®šã€‚
                -->
                <div class="flex items-center space-x-1">
                    ${operationButtons}
                </div>
            </td>
        </tr>
    `;
}
        
        // ç²å–ç‹€æ…‹è³‡è¨Š
        function getStatusInfo(status) {
            const statusMap = {
                'registered': { text: 'å·²æŽ›è™Ÿ', class: 'bg-blue-100 text-blue-800' },
                'waiting': { text: 'å€™è¨ºä¸­', class: 'bg-yellow-100 text-yellow-800' },
                'consulting': { text: 'è¨ºç—‡ä¸­', class: 'bg-green-100 text-green-800' },
                'completed': { text: 'å·²å®Œæˆ', class: 'bg-gray-100 text-gray-800' }
            };
            return statusMap[status] || { text: 'æœªçŸ¥', class: 'bg-gray-100 text-gray-800' };
        }
        
// 2. ä¿®æ”¹ getOperationButtons å‡½æ•¸ï¼Œç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ patientId
function getOperationButtons(appointment, patient = null) {
    const buttons = [];
    
    // æª¢æŸ¥ç›®å‰ç”¨æˆ¶æ˜¯å¦ç‚ºé†«å¸«
    const isDoctorUser = currentUserData && currentUserData.position === 'é†«å¸«';
    // æª¢æŸ¥åŒä¸€é†«å¸«æ˜¯å¦æœ‰ç—…äººåœ¨ä»Šæ—¥è¨ºç—‡ä¸­
    const isDoctorConsulting = isDoctorUser && appointments.some(apt =>
        apt.status === 'consulting' &&
        apt.appointmentDoctor === currentUserData.username &&
        new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
    );
    
    const isCurrentConsulting = appointment.status === 'consulting';
    
    // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºè©²æŽ›è™Ÿçš„é†«å¸«
    const isAppointmentDoctor = currentUserData && 
        currentUserData.position === 'é†«å¸«' && 
        appointment.appointmentDoctor === currentUserData.username;
    
    // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºç®¡ç†å“¡æˆ–è­·ç†å¸«ï¼ˆå¯ä»¥é€²è¡Œç®¡ç†æ“ä½œï¼‰
    const canManage = currentUserData && 
        (currentUserData.position === 'è¨ºæ‰€ç®¡ç†' || currentUserData.position === 'è­·ç†å¸«');
    
    // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦å¯ä»¥ç¢ºèªåˆ°é”ï¼ˆç®¡ç†å“¡ã€è­·ç†å¸«æˆ–è©²æŽ›è™Ÿçš„é†«å¸«ï¼‰
    const canConfirmArrival = canManage || isAppointmentDoctor;
    
    // ä½¿ç”¨æ­£ç¢ºçš„ patientIdï¼ˆå„ªå…ˆä½¿ç”¨ Firebase IDï¼‰
    const patientId = patient ? patient.id : appointment.patientId;
    
    // æ‰€æœ‰ç‹€æ…‹éƒ½å¯ä»¥æŸ¥çœ‹è¨ºç—‡è¨˜éŒ„
    buttons.push(`<button onclick="viewPatientMedicalHistory('${patientId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">è¨ºç—‡è¨˜éŒ„</button>`);
    
    // åƒ…ç•¶é†«å¸«æ­£åœ¨ç‚ºå…¶ä»–ç—…äººè¨ºç—‡æ™‚ç¦ç”¨å…¶å°å…¶ä»–æŽ›è™Ÿçš„æ“ä½œ
    const isDisabled = isDoctorConsulting && !isCurrentConsulting;
    let disabledTooltip = '';
    if (isDisabled) {
        // æç¤ºé†«å¸«ç›®å‰æ­£åœ¨è¨ºç—‡ä¸­
        disabledTooltip = `title="æ‚¨æ­£åœ¨è¨ºç—‡ä¸­ï¼Œæ“ä½œæš«æ™‚ç¦ç”¨"`;
    }
    
    switch (appointment.status) {
        case 'registered':
            if (isDisabled) {
                if (canConfirmArrival) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs whitespace-nowrap cursor-not-allowed" ${disabledTooltip}>ç¢ºèªåˆ°é”</span>`);
                }
                if (canManage) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs whitespace-nowrap cursor-not-allowed" ${disabledTooltip}>ç§»é™¤æŽ›è™Ÿ</span>`);
                }
            } else {
                if (canConfirmArrival) {
                    buttons.push(`<button onclick="confirmPatientArrival(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">ç¢ºèªåˆ°é”</button>`);
                }
                if (canManage) {
                    buttons.push(`<button onclick="removeAppointment(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">ç§»é™¤æŽ›è™Ÿ</button>`);
                }
            }
            break;
            
        case 'waiting':
            if (isDisabled) {
                if (isAppointmentDoctor) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs whitespace-nowrap cursor-not-allowed" ${disabledTooltip}>é–‹å§‹è¨ºç—‡</span>`);
                }
                // å¦‚æžœç‚ºç®¡ç†å“¡æˆ–è­·ç†å¸«ï¼Œå‰‡ç¦ç”¨å–æ¶ˆå€™è¨ºæŒ‰éˆ•
                if (canManage) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs whitespace-nowrap cursor-not-allowed" ${disabledTooltip}>å–æ¶ˆå€™è¨º</span>`);
                }
            } else {
                if (isAppointmentDoctor) {
                    buttons.push(`<button onclick="startConsultation(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">é–‹å§‹è¨ºç—‡</button>`);
                }
                // ç®¡ç†å“¡æˆ–è­·ç†å¸«å¯ä»¥å–æ¶ˆå€™è¨ºï¼Œå°‡ç‹€æ…‹å›žå¾©ç‚ºå·²æŽ›è™Ÿ
                if (canManage) {
                    buttons.push(`<button onclick="cancelWaiting(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">å–æ¶ˆå€™è¨º</button>`);
                }
            }
            break;
            
        case 'consulting':
            if (isAppointmentDoctor) {
                buttons.push(`<button onclick="continueConsultation(${appointment.id})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">ç¹¼çºŒè¨ºç—‡</button>`);
            }
            break;
            
        case 'completed':
            // åˆ—å°æ”¶æ“šåŠŸèƒ½ä¸å—è¨ºç—‡ç‹€æ…‹é™åˆ¶
            buttons.push(`<button onclick="printReceiptFromAppointment(${appointment.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">åˆ—å°æ”¶æ“š</button>`);
            // æ–°å¢žæ–¹è—¥é†«å›‘åˆ—å°åŠŸèƒ½ï¼Œä½æ–¼åˆ—å°æ”¶æ“šæ—
            buttons.push(`<button onclick="printPrescriptionInstructionsFromAppointment(${appointment.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">è—¥å–®é†«å›‘</button>`);
            buttons.push(`<button onclick="printAttendanceCertificateFromAppointment(${appointment.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">åˆ°è¨ºè­‰æ˜Ž</button>`);
            buttons.push(`<button onclick="printSickLeaveFromAppointment(${appointment.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">ç—…å‡è­‰æ˜Ž</button>`);
            
            if (isDisabled) {
                if (isAppointmentDoctor) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs whitespace-nowrap cursor-not-allowed" ${disabledTooltip}>ä¿®æ”¹ç—…æ­·</span>`);
                }
                if (canManage) {
                    buttons.push(`<span class="bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs whitespace-nowrap cursor-not-allowed" ${disabledTooltip}>æ’¤å›žè¨ºç—‡</span>`);
                }
            } else {
                if (isAppointmentDoctor) {
                    buttons.push(`<button onclick="editMedicalRecord(${appointment.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">ä¿®æ”¹ç—…æ­·</button>`);
                }
                if (canManage) {
                    buttons.push(`<button onclick="withdrawConsultation(${appointment.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap transition duration-200">æ’¤å›žè¨ºç—‡</button>`);
                }
            }
            break;
            
        default:
            buttons.push('<span class="text-gray-400 text-xs">ç‹€æ…‹ç•°å¸¸</span>');
            break;
    }
    
    return buttons.join('');
}

        
// 3. ä¿®æ”¹ç¢ºèªç—…äººåˆ°é”å‡½æ•¸ï¼Œæ”¯æ´ Firebase
async function confirmPatientArrival(appointmentId) {
    // å–å¾—æœ€æ–°çš„æŽ›è™Ÿè³‡æ–™ï¼Œé¿å…é•·æ™‚é–“å¾…æ©Ÿå¾Œæœ¬åœ°è³‡æ–™éŽæœŸ
    const appointment = await getLatestAppointmentById(appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ï¼šå„ªå…ˆä½¿ç”¨äº‹ä»¶ç›®æ¨™ï¼Œå…¶æ¬¡é€éŽ DOM æŸ¥æ‰¾
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        loadingButton = document.querySelector('button[onclick="confirmPatientArrival(' + appointmentId + ')"]');
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const result = await safeGetPatients(true);
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`ç¢ºèªåˆ°é”ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
        // åªæœ‰å·²æŽ›è™Ÿç‹€æ…‹æ‰èƒ½ç¢ºèªåˆ°é”
        if (appointment.status !== 'registered') {
            const statusNames = {
                'waiting': 'å€™è¨ºä¸­',
                'consulting': 'è¨ºç—‡ä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            {
                // Build a status name mapping for English
                const lang = localStorage.getItem('lang') || 'zh';
                const statusNamesEnMap = {
                    'å€™è¨ºä¸­': 'waiting',
                    'è¨ºç—‡ä¸­': 'consulting',
                    'å·²å®Œæˆ': 'completed'
                };
                const currentStatusNameEn = statusNamesEnMap[currentStatusName] || currentStatusName;
                const zhMsg = `ç„¡æ³•ç¢ºèªåˆ°é”ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½å°ã€Œå·²æŽ›è™Ÿã€çš„ç—…äººç¢ºèªåˆ°é”ã€‚`;
                const enMsg = `Unable to confirm arrival! Patient ${patient.name} is currently "${currentStatusNameEn}". You can only confirm arrival for patients who are "registered".`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'warning');
            }
            return;
        }
        // æ›´æ–°ç‹€æ…‹ç‚ºå€™è¨ºä¸­
        appointment.status = 'waiting';
        appointment.arrivedAt = new Date().toISOString();
        appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
        // ä¿å­˜ç‹€æ…‹è®Šæ›´
        localStorage.setItem('appointments', JSON.stringify(appointments));
        await window.firebaseDataManager.updateAppointment(String(appointment.id), appointment);
        {
            // Announce arrival confirmation in appropriate language
            const lang = localStorage.getItem('lang') || 'zh';
            const msg = lang === 'en'
                ? `${patient.name} has been confirmed and is now waiting!`
                : `${patient.name} å·²ç¢ºèªåˆ°é”ï¼Œé€²å…¥å€™è¨ºç‹€æ…‹ï¼`;
            showToast(msg, 'success');
        }
        loadTodayAppointments();
    } catch (error) {
        console.error('ç¢ºèªåˆ°é”éŒ¯èª¤:', error);
        showToast('è™•ç†ç¢ºèªåˆ°é”æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

        
 // 5. ä¿®æ”¹ç§»é™¤æŽ›è™Ÿå‡½æ•¸ï¼Œæ”¯æ´ Firebase
async function removeAppointment(appointmentId) {
    // å–å¾—æœ€æ–°çš„æŽ›è™Ÿè³‡æ–™ï¼Œé¿å…é•·æ™‚é–“å¾…æ©Ÿå¾Œæœ¬åœ°è³‡æ–™éŽæœŸ
    const appointment = await getLatestAppointmentById(appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        loadingButton = document.querySelector('button[onclick="removeAppointment(' + appointmentId + ')"]');
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const result = await safeGetPatients(true);
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`ç§»é™¤æŽ›è™Ÿç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç§»é™¤
        if (appointment.status === 'waiting') {
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•ç§»é™¤æŽ›è™Ÿï¼ç—…äºº ${patient.name} å·²ç¢ºèªåˆ°é”å€™è¨ºä¸­ï¼Œè«‹è¯ç¹«é†«å¸«è™•ç†ã€‚`;
                const enMsg = `Cannot remove registration! Patient ${patient.name} has already arrived and is waiting. Please contact the doctor to proceed.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'warning');
            }
            return;
        }
        if (appointment.status === 'consulting') {
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•ç§»é™¤æŽ›è™Ÿï¼ç—…äºº ${patient.name} ç›®å‰æ­£åœ¨è¨ºç—‡ä¸­ï¼Œè«‹å…ˆçµæŸè¨ºç—‡å¾Œå†ç§»é™¤ã€‚`;
                const enMsg = `Cannot remove registration! Patient ${patient.name} is currently being consulted. Please finish the consultation before removing.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'warning');
            }
            return;
        }
        if (appointment.status === 'completed') {
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•ç§»é™¤æŽ›è™Ÿï¼ç—…äºº ${patient.name} å·²å®Œæˆè¨ºç—‡ï¼Œå·²å®Œæˆçš„è¨˜éŒ„ç„¡æ³•ç§»é™¤ã€‚`;
                const enMsg = `Cannot remove registration! Patient ${patient.name} has completed consultation, completed records cannot be removed.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'warning');
            }
            return;
        }
        // ç¢ºèªç§»é™¤
        // ç§»é™¤æŽ›è™Ÿç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
        const statusNamesZh = {
            'registered': 'å·²æŽ›è™Ÿ',
            'waiting': 'å€™è¨ºä¸­',
            'consulting': 'è¨ºç—‡ä¸­',
            'completed': 'å·²å®Œæˆ'
        };
        const statusNamesEn = {
            'registered': 'Registered',
            'waiting': 'Waiting',
            'consulting': 'Consulting',
            'completed': 'Completed'
        };
        const lang2 = localStorage.getItem('lang') || 'zh';
        const statusTextZh = statusNamesZh[appointment.status] || appointment.status;
        const statusTextEn = statusNamesEn[appointment.status] || appointment.status;
        const timeStr = new Date(appointment.appointmentTime).toLocaleString(lang2 === 'en' ? 'en-US' : 'zh-TW');
        const zhMsg = `ç¢ºå®šè¦ç§»é™¤ ${patient.name} çš„æŽ›è™Ÿå—Žï¼Ÿ\n\nç‹€æ…‹ï¼š${statusTextZh}\næŽ›è™Ÿæ™‚é–“ï¼š${timeStr}\n\næ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŽŸï¼`;
        const enMsg = `Are you sure you want to remove the registration for ${patient.name}?\n\nStatus: ${statusTextEn}\nRegistration time: ${timeStr}\n\nNote: this action cannot be undone!`;
        const confirmMsg = lang2 === 'en' ? enMsg : zhMsg;
        const confirmedRemove = await showConfirmation(confirmMsg, 'warning');
        if (confirmedRemove) {
            // å¾žæŽ›è™Ÿåˆ—è¡¨ä¸­ç§»é™¤
            appointments = appointments.filter(apt => apt.id !== appointmentId);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            // å¾žé ç«¯åˆªé™¤æŽ›è™Ÿ
            await window.firebaseDataManager.deleteAppointment(String(appointmentId));
            // æ ¹æ“šèªžè¨€é¡¯ç¤ºåˆªé™¤æŽ›è™Ÿè¨˜éŒ„æç¤º
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const msg = lang === 'en'
                    ? `Removed registration record for ${patient.name}`
                    : `å·²ç§»é™¤ ${patient.name} çš„æŽ›è™Ÿè¨˜éŒ„`;
                showToast(msg, 'success');
            }
            loadTodayAppointments();
            // å¦‚æžœæ­£åœ¨è¨ºç—‡è¡¨å–®ä¸­é¡¯ç¤ºè©²ç—…äººï¼Œå‰‡é—œé–‰è¡¨å–®
            if (String(currentConsultingAppointmentId) === String(appointmentId)) {
                closeConsultationForm();
                currentConsultingAppointmentId = null;
            }
        }
    } catch (error) {
        console.error('ç§»é™¤æŽ›è™ŸéŒ¯èª¤:', error);
        showToast('ç§»é™¤æŽ›è™Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

/**
 * å–æ¶ˆå€™è¨ºï¼šå°‡ç—…äººç‹€æ…‹å¾žå€™è¨ºä¸­æ”¹å›žå·²æŽ›è™Ÿã€‚
 * åƒ…é™ç®¡ç†å“¡æˆ–è­·ç†å¸«å¯æ“ä½œã€‚
 * @param {number|string} appointmentId - æŽ›è™Ÿ ID
 */
async function cancelWaiting(appointmentId) {
    // å–å¾—æœ€æ–°çš„æŽ›è™Ÿè³‡æ–™ï¼Œé¿å…é•·æ™‚é–“å¾…æ©Ÿå¾Œæœ¬åœ°è³‡æ–™éŽæœŸ
    const appointment = await getLatestAppointmentById(appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ï¼šå„ªå…ˆä½¿ç”¨äº‹ä»¶ç›®æ¨™ï¼Œå…¶æ¬¡é€éŽ DOM æŸ¥æ‰¾
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector('button[onclick="cancelWaiting(' + appointmentId + ')"]');
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™ï¼Œç¢ºä¿å–å¾—æœ€æ–°è³‡æ–™
        const result = await safeGetPatients(true);
        if (!result || !result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        // åªèƒ½å°å€™è¨ºä¸­ç‹€æ…‹çš„æŽ›è™Ÿå–æ¶ˆå€™è¨º
        if (appointment.status !== 'waiting') {
            const statusNames = {
                'registered': 'å·²æŽ›è™Ÿ',
                'consulting': 'è¨ºç—‡ä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            const lang = localStorage.getItem('lang') || 'zh';
            const statusNamesEnMap = {
                'å·²æŽ›è™Ÿ': 'registered',
                'è¨ºç—‡ä¸­': 'consulting',
                'å·²å®Œæˆ': 'completed'
            };
            const currentStatusNameEn = statusNamesEnMap[currentStatusName] || currentStatusName;
            const zhMsg = `ç„¡æ³•å–æ¶ˆå€™è¨ºï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªæœ‰å€™è¨ºä¸­çš„ç—…äººå¯ä»¥å–æ¶ˆå€™è¨ºã€‚`;
            const enMsg = `Cannot cancel waiting! Patient ${patient.name} is currently "${currentStatusNameEn}". Only patients who are "waiting" can cancel waiting.`;
            const msg = lang === 'en' ? enMsg : zhMsg;
            showToast(msg, 'warning');
            return;
        }
        /*
         * å–æ¶ˆå€™è¨ºä¸å†éœ€è¦é¡¯ç¤ºç¢ºèªè¦–çª—ã€‚
         * æŒ‰ä¸‹ã€Œå–æ¶ˆå€™è¨ºã€æŒ‰éˆ•å¾Œï¼Œå°‡ç›´æŽ¥å°‡ç—…äººç‹€æ…‹å¾žå€™è¨ºä¸­æ”¹å›žå·²æŽ›è™Ÿã€‚
         * ä»¥ä¸‹ç•™å­˜é›™èªžè¨Šæ¯å­—ä¸²ä»¥ä¾›æœªä¾†æ“´å……éœ€æ±‚ï¼Œä½†æ­¤ç‰ˆæœ¬å·²ä¸å†å‘¼å« showConfirmationã€‚
         */
        // const langConfirm = localStorage.getItem('lang') || 'zh';
        // const zhMsg2 = `ç¢ºå®šè¦å–æ¶ˆ ${patient.name} çš„å€™è¨ºå—Žï¼Ÿ\n\nç—…äººç‹€æ…‹å°‡å›žåˆ°å·²æŽ›è™Ÿï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ`;
        // const enMsg2 = `Are you sure you want to cancel waiting for ${patient.name}?\n\nThe patient's status will revert to registered. Do you want to proceed?`;
        // const confirmMsg = langConfirm === 'en' ? enMsg2 : zhMsg2;
        // ä¸éœ€è¦ç¢ºèªï¼Œç›´æŽ¥ç¹¼çºŒè™•ç†å–æ¶ˆå€™è¨ºã€‚
        // æ›´æ–°ç‹€æ…‹ç‚ºå·²æŽ›è™Ÿï¼Œç§»é™¤åˆ°é”è³‡è¨Š
        appointment.status = 'registered';
        delete appointment.arrivedAt;
        delete appointment.confirmedBy;
        // æ›´æ–°å…¨åŸŸé™£åˆ—ä¸­çš„å°æ‡‰æŽ›è™Ÿï¼Œä»¥é¿å…åƒç…§ä¸åŒæ­¥
        try {
            if (Array.isArray(appointments)) {
                const idx = appointments.findIndex(apt => apt && String(apt.id) === String(appointment.id));
                if (idx >= 0) {
                    appointments[idx] = { ...appointment };
                }
            }
        } catch (_e) {}
        // ä¿å­˜ç‹€æ…‹è®Šæ›´
        try {
            localStorage.setItem('appointments', JSON.stringify(appointments));
        } catch (_err) {}
        // åŒæ­¥æ›´æ–°åˆ° Firebase
        await window.firebaseDataManager.updateAppointment(String(appointment.id), appointment);
        // é€šçŸ¥ä½¿ç”¨è€…å·²å–æ¶ˆå€™è¨º
        {
            const lang = localStorage.getItem('lang') || 'zh';
            const zhMsg3 = `å·²å–æ¶ˆ ${patient.name} çš„å€™è¨ºï¼Œç—…äººç‹€æ…‹å›žåˆ°å·²æŽ›è™Ÿ`;
            const enMsg3 = `Cancelled waiting for ${patient.name} and reverted status to registered`;
            const msg = lang === 'en' ? enMsg3 : zhMsg3;
            showToast(msg, 'success');
        }
        // é‡æ–°è¼‰å…¥æŽ›è™Ÿåˆ—è¡¨
        loadTodayAppointments();
    } catch (error) {
        console.error('å–æ¶ˆå€™è¨ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        showToast('å–æ¶ˆå€™è¨ºæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

        

        
 // 4. ä¿®æ”¹é–‹å§‹è¨ºç—‡å‡½æ•¸ï¼Œæ”¯æ´ Firebase
async function startConsultation(appointmentId) {
    // åœ¨é–‹å§‹æ–°çš„è¨ºç—‡å‰ï¼Œæ¸…é™¤å…ˆå‰ç•™å­˜çš„å¥—ç¥¨è®Šæ›´è¨˜éŒ„ï¼Œ
    // ä»¥å…ä¸åŒç—…äººçš„æ“ä½œäº’ç›¸å½±éŸ¿ã€‚
    pendingPackageChanges = [];
    // å–å¾—æœ€æ–°çš„æŽ›è™Ÿè³‡æ–™ï¼Œé¿å…é•·æ™‚é–“å¾…æ©Ÿå¾Œæœ¬åœ°è³‡æ–™éŽæœŸ
    const appointment = await getLatestAppointmentById(appointmentId);
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ã€‚ä½¿ç”¨é€šç”¨è¼”åŠ©å‡½å¼ä»¥ç°¡åŒ–å¾ŒçºŒç¨‹å¼ç¢¼ã€‚
    // ä½¿ç”¨æ¨¡æ¿å­—ä¸²ç”¢ç”Ÿå‹•æ…‹é¸æ“‡å™¨ï¼Œä»¥æ­£ç¢ºåŒ…å« appointmentId
    let loadingButton = getLoadingButtonFromEvent(`button[onclick="startConsultation(${appointmentId})"]`);
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const result = await safeGetPatients(true);
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        // æª¢æŸ¥ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºè©²æŽ›è™Ÿçš„é†«å¸«
        if (!currentUserData || currentUserData.position !== 'é†«å¸«' || appointment.appointmentDoctor !== currentUserData.username) {
            showToast('åªæœ‰è©²æŽ›è™Ÿçš„é†«å¸«æ‰èƒ½é–‹å§‹è¨ºç—‡ï¼', 'error');
            return;
        }
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`é–‹å§‹è¨ºç—‡ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
        // æª¢æŸ¥ç—…äººç‹€æ…‹æ˜¯å¦å…è¨±é–‹å§‹è¨ºç—‡
        if (!['waiting', 'registered'].includes(appointment.status)) {
            // ç‹€æ…‹åç¨±æ˜ å°„ï¼Œç”¨æ–¼ä¸­è‹±æ–‡æç¤º
            const statusNames = {
                'consulting': 'è¨ºç—‡ä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            const lang = localStorage.getItem('lang') || 'zh';
            const statusNamesEnMap = {
                'è¨ºç—‡ä¸­': 'consulting',
                'å·²å®Œæˆ': 'completed',
                'å€™è¨ºä¸­': 'waiting',
                'å·²æŽ›è™Ÿ': 'registered'
            };
            const currentStatusNameEn = statusNamesEnMap[currentStatusName] || currentStatusName;
            const zhMsg = `ç„¡æ³•é–‹å§‹è¨ºç—‡ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½å°ã€Œå·²æŽ›è™Ÿã€æˆ–ã€Œå€™è¨ºä¸­ã€çš„ç—…äººé–‹å§‹è¨ºç—‡ã€‚`;
            const enMsg = `Cannot start consultation! Patient ${patient.name} is currently "${currentStatusNameEn}". You can only start a consultation for patients who are "registered" or "waiting".`;
            const msg = lang === 'en' ? enMsg : zhMsg;
            showToast(msg, 'error');
            return;
        }
        // å¦‚æžœæ˜¯å·²æŽ›è™Ÿç‹€æ…‹ï¼Œè‡ªå‹•ç¢ºèªåˆ°é”
        if (appointment.status === 'registered') {
            appointment.arrivedAt = new Date().toISOString();
            appointment.confirmedBy = currentUserData ? currentUserData.username : currentUser;
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const msg = lang === 'en'
                    ? `${patient.name} has been automatically confirmed as arrived`
                    : `${patient.name} å·²è‡ªå‹•ç¢ºèªåˆ°é”`;
                showToast(msg, 'info');
            }
        }
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰å…¶ä»–ç—…äººåœ¨è¨ºç—‡ä¸­ï¼ˆåªæª¢æŸ¥åŒä¸€é†«å¸«çš„ç—…äººï¼‰
        const consultingAppointment = appointments.find(apt =>
            apt &&
            apt.status === 'consulting' &&
            String(apt.id) !== String(appointmentId) &&
            apt.appointmentDoctor === currentUserData.username &&
            new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
        );
        if (consultingAppointment) {
            const consultingPatient = result.data.find(p => p.id === consultingAppointment.patientId);
            const consultingPatientName = consultingPatient ? consultingPatient.name : 'æœªçŸ¥ç—…äºº';
            // æç¤ºç•¶å‰æ­£åœ¨è¨ºç—‡å…¶ä»–ç—…äººï¼Œè©¢å•æ˜¯å¦çµæŸä¸¦é–‹å§‹æ–°è¨ºç—‡ï¼ˆæ”¯æ´ä¸­è‹±æ–‡ï¼‰
            const lang3 = localStorage.getItem('lang') || 'zh';
            const zhMsg2 = `æ‚¨ç›®å‰æ­£åœ¨ç‚º ${consultingPatientName} è¨ºç—‡ã€‚\n\næ˜¯å¦è¦çµæŸè©²ç—…äººçš„è¨ºç—‡ä¸¦é–‹å§‹ç‚º ${patient.name} è¨ºç—‡ï¼Ÿ\n\næ³¨æ„ï¼š${consultingPatientName} çš„ç‹€æ…‹å°‡æ”¹å›žå€™è¨ºä¸­ã€‚`;
            const enMsg2 = `You are currently consulting ${consultingPatientName}.\n\nDo you want to finish that patient's consultation and start consulting ${patient.name}?\n\nNote: ${consultingPatientName}'s status will revert to waiting.`;
            const confirmMsg2 = lang3 === 'en' ? enMsg2 : zhMsg2;
            const confirmedSwitch = await showConfirmation(confirmMsg2, 'warning');
            if (confirmedSwitch) {
                consultingAppointment.status = 'waiting';
                delete consultingAppointment.consultationStartTime;
                delete consultingAppointment.consultingDoctor;
                if (String(currentConsultingAppointmentId) === String(consultingAppointment.id)) {
                    closeConsultationForm();
                }
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const msg = lang === 'en'
                        ? `Finished ${consultingPatientName}'s consultation`
                        : `å·²çµæŸ ${consultingPatientName} çš„è¨ºç—‡`;
                    showToast(msg, 'info');
                }
            } else {
                return;
            }
        }
        // é–‹å§‹æ–°çš„è¨ºç—‡
        appointment.status = 'consulting';
        appointment.consultationStartTime = new Date().toISOString();
        appointment.consultingDoctor = currentUserData ? currentUserData.username : currentUser;
        localStorage.setItem('appointments', JSON.stringify(appointments));
        await window.firebaseDataManager.updateAppointment(String(appointment.id), appointment);
        currentConsultingAppointmentId = appointmentId;
        showConsultationForm(appointment);
        loadTodayAppointments();
        {
            const lang = localStorage.getItem('lang') || 'zh';
            const msg = lang === 'en'
                ? `Started consultation for ${patient.name}`
                : `é–‹å§‹ç‚º ${patient.name} è¨ºç—‡`;
            showToast(msg, 'success');
        }
    } catch (error) {
        console.error('é–‹å§‹è¨ºç—‡éŒ¯èª¤:', error);
        showToast('é–‹å§‹è¨ºç—‡æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}
        
        // ç¹¼çºŒè¨ºç—‡
        async function continueConsultation(appointmentId) {
            // å–å¾—æŒ‰éˆ•ä¸¦é¡¯ç¤ºè®€å–ç‹€æ…‹
            let loadingButton = null;
            try {
                if (typeof event !== 'undefined' && event && event.currentTarget) {
                    loadingButton = event.currentTarget;
                }
            } catch (_e) {}
            if (!loadingButton) {
                try {
                    loadingButton = document.querySelector('button[onclick="continueConsultation(' + appointmentId + ')"]');
                } catch (_e) {
                    loadingButton = null;
                }
            }
            if (loadingButton) {
                setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
            }
            try {
                // å–å¾—æœ€æ–°çš„æŽ›è™Ÿè³‡æ–™ï¼Œé¿å…é•·æ™‚é–“å¾…æ©Ÿå¾Œæœ¬åœ°è³‡æ–™éŽæœŸ
                const appointment = await getLatestAppointmentById(appointmentId);
                if (!appointment) {
                    showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
                    return;
                }
                currentConsultingAppointmentId = appointmentId;
                // ç­‰å¾…é¡¯ç¤ºè¡¨å–®å®Œæˆï¼Œå› å…¶å¯èƒ½æ¶‰åŠç•°æ­¥æ“ä½œ
                await showConsultationForm(appointment);
            } catch (error) {
                console.error('ç¹¼çºŒè¨ºç—‡éŒ¯èª¤:', error);
                showToast('ç¹¼çºŒè¨ºç—‡æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            } finally {
                if (loadingButton) {
                    clearButtonLoading(loadingButton);
                }
            }
        }
        
// ä¿®å¾©è¨ºç—‡è¡¨å–®é¡¯ç¤ºå‡½æ•¸
async function showConsultationForm(appointment) {
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const result = await safeGetPatients(true);
        if (!result.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = result.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è¨­ç½®ç—…äººè³‡è¨Š
        // é¡¯ç¤ºç—…äººå§“åèˆ‡ç·¨è™Ÿ
        document.getElementById('formPatientName').textContent = `${patient.name} (${patient.patientNumber})`;
        // é¡¯ç¤ºæŽ›è™Ÿæ™‚é–“
        document.getElementById('formAppointmentTime').textContent = new Date(appointment.appointmentTime).toLocaleString('zh-TW');
        // é¡¯ç¤ºç—…äººå¹´é½¡ï¼Œè‹¥æ²’æœ‰å‡ºç”Ÿæ—¥æœŸå‰‡é¡¯ç¤ºã€ŒæœªçŸ¥ã€
        const ageEl = document.getElementById('formPatientAge');
        if (ageEl) {
            ageEl.textContent = formatAge(patient.birthDate);
        }
        // é¡¯ç¤ºç—…äººæ€§åˆ¥ï¼Œè‹¥æ²’æœ‰è³‡æ–™å‰‡é¡¯ç¤ºã€ŒæœªçŸ¥ã€
        const genderEl = document.getElementById('formPatientGender');
        if (genderEl) {
            genderEl.textContent = patient.gender || 'æœªçŸ¥';
        }
        // é¡¯ç¤ºéŽæ•å²ï¼Œå¦‚æžœæœ‰è³‡æ–™å‰‡å¡«å…¥ä¸¦é¡¯ç¤ºå®¹å™¨ï¼Œå¦å‰‡éš±è—å®¹å™¨
        const allergiesContainer = document.getElementById('allergiesContainer');
        const allergiesEl = document.getElementById('formPatientAllergies');
        if (allergiesContainer && allergiesEl) {
            if (patient.allergies) {
                allergiesEl.textContent = patient.allergies;
                allergiesContainer.style.display = '';
            } else {
                allergiesEl.textContent = '';
                allergiesContainer.style.display = 'none';
            }
        }
        // é¡¯ç¤ºç—…å²åŠå‚™è¨»ï¼Œå¦‚æžœæœ‰è³‡æ–™å‰‡å¡«å…¥ä¸¦é¡¯ç¤ºå®¹å™¨ï¼Œå¦å‰‡éš±è—å®¹å™¨
        const historyContainer = document.getElementById('historyContainer');
        const historyEl = document.getElementById('formPatientHistory');
        if (historyContainer && historyEl) {
            if (patient.history) {
                historyEl.textContent = patient.history;
                historyContainer.style.display = '';
            } else {
                historyEl.textContent = '';
                historyContainer.style.display = 'none';
            }
        }
        // æ¸²æŸ“ç—…äººç™‚ç¨‹/å¥—é¤è³‡è¨Š
        renderPatientPackages(patient.id);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼
        if (appointment.status === 'completed' && appointment.consultationId) {
            // ç·¨è¼¯æ¨¡å¼ï¼šå¾ž Firebase è¼‰å…¥ç¾æœ‰è¨ºç—‡è¨˜éŒ„
            await loadConsultationForEdit(appointment.consultationId);
        } else {
            // æ–°è¨ºç—‡æ¨¡å¼ï¼šä½¿ç”¨ç©ºç™½è¡¨å–®
            clearConsultationForm();
            
            // è¨­ç½®é è¨­å€¼
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('formVisitTime').value = localDateTime;
            
            // è¨­ç½®é è¨­ä¼‘æ¯æœŸé–“
            const startDate = new Date();
            const endDate = new Date();
            // é è¨­ä¼‘æ¯æœŸé–“ç‚ºä¸€å¤©ï¼ŒçµæŸæ—¥æœŸèˆ‡é–‹å§‹æ—¥æœŸç›¸åŒ
            endDate.setDate(startDate.getDate());
            
            const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
            const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            
            document.getElementById('formRestStartDate').value = startDateStr;
            document.getElementById('formRestEndDate').value = endDateStr;
            updateRestPeriod();

            // è¨­ç½®é è¨­è¤‡è¨ºæ™‚é–“ç‚ºè¨ºç—‡ç•¶å¤©çš„ 7 å¤©å¾Œï¼Œæ™‚é–“ä¿æŒèˆ‡åˆ°è¨ºæ™‚é–“ä¸€è‡´
            try {
                const followUp = new Date(now);
                followUp.setDate(followUp.getDate() + 7);
                const fYear = followUp.getFullYear();
                const fMonth = String(followUp.getMonth() + 1).padStart(2, '0');
                const fDay = String(followUp.getDate()).padStart(2, '0');
                const fHours = String(followUp.getHours()).padStart(2, '0');
                const fMinutes = String(followUp.getMinutes()).padStart(2, '0');
                document.getElementById('formFollowUpDate').value = `${fYear}-${fMonth}-${fDay}T${fHours}:${fMinutes}`;
            } catch (_e) {
                console.warn('ç„¡æ³•è¨­å®šé è¨­è¤‡è¨ºæ™‚é–“', _e);
            }
            
            // å˜—è©¦å¾ž Firestore å–å¾—å•è¨ºè³‡æ–™ï¼Œç”¨æ–¼é å¡«ä¸»è¨´èˆ‡ç¾ç—…å²ã€‚
            // é€™è£¡ä¸å†ä½¿ç”¨ appointment.inquiryDataï¼Œæœ¬åœ°åƒ…ä¿å­˜ inquiryId èˆ‡æ‘˜è¦ã€‚
            let inquiryDataForPrefill = null;
            if (appointment && appointment.inquiryId) {
                try {
                    // å°ç—…äººå§“åé€²è¡Œä¿®å‰ªï¼Œé¿å…å‰å¾Œç©ºç™½å°Žè‡´æŸ¥è©¢ä¸åˆ°
                    const nameForSearch = patient && patient.name ? String(patient.name).trim() : '';
                    let inquiryResult = await window.firebaseDataManager.getInquiryRecords(nameForSearch);
                    let rec = null;
                    if (inquiryResult && inquiryResult.success && Array.isArray(inquiryResult.data)) {
                        rec = inquiryResult.data.find(r => String(r.id) === String(appointment.inquiryId));
                    }
                    // å¦‚æžœæŒ‰å§“åæŸ¥è©¢æ‰¾ä¸åˆ°ï¼Œæ”¹ç‚ºæŸ¥è©¢æ‰€æœ‰è¨˜éŒ„å†æœå°‹ id
                    if (!rec) {
                        try {
                            const allResult = await window.firebaseDataManager.getInquiryRecords('');
                            if (allResult && allResult.success && Array.isArray(allResult.data)) {
                                rec = allResult.data.find(r => String(r.id) === String(appointment.inquiryId));
                            }
                        } catch (e2) {
                            console.warn('å–å¾—å…¨éƒ¨å•è¨ºè¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', e2);
                        }
                    }
                    if (rec && rec.data) {
                        inquiryDataForPrefill = rec.data;
                    }
                } catch (err) {
                    console.error('å–å¾—å•è¨ºè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                }
            }

            // å¦‚æžœæŽ›è™Ÿæ™‚æœ‰å•è¨ºæ‘˜è¦ä¸”æœªå¡«å¯«ä¸»è¨´æˆ–ä¸»è¨´ç‚ºé è¨­ï¼Œå„ªå…ˆä½¿ç”¨å•è¨ºæ‘˜è¦
            const symptomsField = document.getElementById('formSymptoms');
            if (symptomsField) {
                if (appointment && appointment.inquirySummary && (!appointment.chiefComplaint || appointment.chiefComplaint === 'ç„¡ç‰¹æ®Šä¸»è¨´')) {
                    symptomsField.value = appointment.inquirySummary;
                } else if (appointment.chiefComplaint && appointment.chiefComplaint !== 'ç„¡ç‰¹æ®Šä¸»è¨´') {
                    symptomsField.value = appointment.chiefComplaint;
                }
                // æ ¹æ“šå•è¨ºè³‡æ–™é€²ä¸€æ­¥å®Œå–„ä¸»è¨´æ‘˜è¦
                if (inquiryDataForPrefill) {
                    const newSummary = generateSymptomSummaryFromInquiry(inquiryDataForPrefill);
                    if (newSummary) {
                        const currentVal = symptomsField.value ? symptomsField.value.trim() : '';
                        // å¦‚æžœç›®å‰ç‚ºç©ºæˆ–èˆ‡å•è¨ºæ‘˜è¦/ä¸»è¨´ä¸€è‡´ï¼Œå‰‡ç›´æŽ¥è¦†è“‹ï¼›å¦å‰‡é™„åŠ åœ¨å¾Œ
                        if (!currentVal || currentVal === appointment.inquirySummary || currentVal === appointment.chiefComplaint || currentVal === 'ç„¡ç‰¹æ®Šä¸»è¨´') {
                            symptomsField.value = newSummary;
                        } else {
                            symptomsField.value = currentVal + '\n' + newSummary;
                        }
                    }
                }
            }
            // æ ¹æ“šå•è¨ºè³‡æ–™å¡«å……ç¾ç—…å²å…§å®¹
            // è¨ºç—‡ç³»çµ±å·²å°‡ã€Œä¸»è¨´ã€èˆ‡ã€Œç¾ç—…å²ã€åˆä½µè‡³ formSymptoms æ¬„ä½ï¼Œ
            // å› æ­¤å°‡ç¾ç—…å²æ‘˜è¦ç›´æŽ¥è¿½åŠ è‡³ä¸»è¨´æ¬„ä½ï¼Œè€Œä¸å†å¯«å…¥éŽå¾€è¨˜éŒ„æ¬„ä½ï¼ˆformCurrentHistoryï¼‰ã€‚
            if (inquiryDataForPrefill) {
                const historySummary = generateHistorySummaryFromInquiry(inquiryDataForPrefill);
                if (historySummary) {
                    // å°‡ç¾ç—…å²å…§å®¹èˆ‡ä¸»è¨´å…§å®¹åˆä½µ
                    const symptomsEl = document.getElementById('formSymptoms');
                    if (symptomsEl) {
                        const currentVal = symptomsEl.value ? symptomsEl.value.trim() : '';
                        if (!currentVal) {
                            symptomsEl.value = historySummary;
                        } else {
                            symptomsEl.value = currentVal + '\n' + historySummary;
                        }
                    }
                }
            }

            // è‡ªå‹•æ·»åŠ é è¨­è¨ºé‡‘æ”¶è²»é …ç›®
            addDefaultConsultationFee(patient);
            
            // å®‰å…¨ç²å–è¨ºç—‡å„²å­˜æŒ‰éˆ•æ–‡æœ¬å…ƒç´ ï¼Œé¿å…ç‚º null æ™‚å‡ºéŒ¯
            const saveButtonTextElNew = document.getElementById('consultationSaveButtonText');
            if (saveButtonTextElNew) {
                saveButtonTextElNew.textContent = 'å®Œæˆè¨ºç—‡';
            } else {
                // è‹¥æ‰¾ä¸åˆ°å…ƒç´ ï¼Œå‰‡ç´€éŒ„è­¦å‘Šä¸¦è·³éŽï¼Œä¸é€ æˆç¨‹å¼å´©æ½°
                console.warn('consultationSaveButtonText element not found when starting consultation. Skipping text update.');
            }
        }

        // è¼‰å…¥éŽå¾€è¨˜éŒ„ï¼šé¡¯ç¤ºæ‚£è€…æ—¢å¾€çš„ä¸»è¨´åŠç¾ç—…å²ï¼ŒæŽ’é™¤ç•¶å‰ç·¨è¼¯çš„è¨˜éŒ„
        try {
            await loadPastRecords(
                appointment.patientId,
                (appointment.status === 'completed' && appointment.consultationId) ? appointment.consultationId : null
            );
        } catch (err) {
            console.error('è¼‰å…¥éŽå¾€è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        }
        
        document.getElementById('consultationForm').classList.remove('hidden');
        
        // æ»¾å‹•åˆ°è¡¨å–®ä½ç½®
        document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('é¡¯ç¤ºè¨ºç—‡è¡¨å–®éŒ¯èª¤:', error);
        showToast('è¼‰å…¥è¨ºç—‡è¡¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        

        
        // æ¸…ç©ºè¨ºç—‡è¡¨å–®
        function clearConsultationForm() {
            ['formSymptoms', 'formTongue', 'formPulse', 'formCurrentHistory', 'formDiagnosis', 'formSyndrome', 'formAcupunctureNotes', 'formPrescription', 'formFollowUpDate', 'formVisitTime', 'formRestStartDate', 'formRestEndDate'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (id === 'formAcupunctureNotes') {
                    // contenteditable å…ƒç´ ä½¿ç”¨ innerHTML æ¸…ç©ºï¼Œä»¥ä¿ç•™æ¨£å¼å®šç¾©
                    if (el.hasAttribute('contenteditable')) {
                        el.innerHTML = '';
                    } else {
                        el.value = '';
                    }
                } else {
                    // ä¸€èˆ¬è¼¸å…¥æ¬„ä½ä½¿ç”¨ value æ¸…ç©º
                    if ('value' in el) {
                        el.value = '';
                    } else {
                        el.innerText = '';
                    }
                }
            });
            
            // é‡ç½®æœè—¥æ—¥æ•¸å’Œæ¬¡æ•¸ç‚ºé è¨­å€¼
            document.getElementById('medicationDays').value = '5';
            document.getElementById('medicationFrequency').value = '2';
            
            // é‡ç½®ä¼‘æ¯æœŸé–“é¡¯ç¤º
            document.getElementById('restPeriodDisplay').textContent = 'è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ';
            document.getElementById('restPeriodDisplay').className = 'text-sm text-gray-500 font-medium';
            
            // è¨­ç½®é è¨­å€¼
            // å°‡é è¨­æœç”¨æ–¹æ³•ç”±ã€Œæ—©æ™šä¸€æ¬¡ï¼Œé£¯å¾Œæœã€æ”¹ç‚ºã€Œæº«æ°´åŒ–é–‹ï¼Œé£¯å¾Œæœã€
            document.getElementById('formUsage').value = 'æº«æ°´åŒ–é–‹ï¼Œé£¯å¾Œæœ';
            document.getElementById('formInstructions').value = 'æ³¨æ„ä¼‘æ¯ï¼Œé£²é£Ÿæ¸…æ·¡';
            document.getElementById('formTreatmentCourse').value = 'ä¸€å‘¨';
            
            // æ¸…ç©ºè™•æ–¹é …ç›®
            selectedPrescriptionItems = [];
            updatePrescriptionDisplay();
            clearPrescriptionSearch();
            
            // æ¸…ç©ºæ”¶è²»é …ç›®ï¼ˆä½†æœƒåœ¨ prefillWithPreviousRecord ä¸­è‡ªå‹•æ·»åŠ è¨ºé‡‘ï¼‰
            selectedBillingItems = [];
            updateBillingDisplay();
            clearBillingSearch();
        }
        
        // é—œé–‰è¨ºç—‡è¡¨å–®
        async function closeConsultationForm() {
            // åœ¨é—œé–‰è¡¨å–®å‰ï¼Œå¦‚æœ‰æš«å­˜çš„å¥—ç¥¨ä½¿ç”¨è®Šæ›´ä¸”å°šæœªä¿å­˜ï¼Œå˜—è©¦å›žå¾©ã€‚
            try {
                if (pendingPackageChanges && pendingPackageChanges.length > 0) {
                    await revertPendingPackageChanges();
                }
            } catch (_e) {
                // è‹¥å›žå¾©å¤±æ•—ï¼Œä»ç¹¼çºŒé—œé–‰è¡¨å–®
            }
            // æ¸…é™¤æš«å­˜çš„å¥—ç¥¨è³¼è²·è¨˜éŒ„ä¸éœ€å†æ¬¡èª¿ç”¨ï¼Œå·²åœ¨ revertPendingPackageChanges è™•ç†
            // éš±è—è¨ºç—‡è¡¨å–®
            document.getElementById('consultationForm').classList.add('hidden');
            
            // æ¸…ç†å…¨åŸŸè®Šæ•¸
            currentConsultingAppointmentId = null;
            
            // æ¸…ç©ºè™•æ–¹å’Œæ”¶è²»é …ç›®é¸æ“‡
            selectedPrescriptionItems = [];
            selectedBillingItems = [];

            // åœ¨é—œé–‰è¡¨å–®æ™‚ï¼Œç¢ºä¿è™•æ–¹é¡¯ç¤ºèˆ‡åº«å­˜é¡žåž‹é¸å–®ç‹€æ…‹åŒæ­¥æ›´æ–°ã€‚
            try {
                if (typeof updatePrescriptionDisplay === 'function') {
                    updatePrescriptionDisplay();
                }
            } catch (_e) {
                /* å¿½ç•¥æ›´æ–°é¡¯ç¤ºæ™‚çš„éŒ¯èª¤ */
            }
            try {
                if (typeof updatePrescriptionTypeSelectStatus === 'function') {
                    updatePrescriptionTypeSelectStatus();
                }
            } catch (_e) {
                /* å¿½ç•¥éŒ¯èª¤ */
            }
            
            // æ»¾å‹•å›žé ‚éƒ¨
            document.getElementById('consultationSystem').scrollIntoView({ behavior: 'smooth' });
        }
        
        // å–æ¶ˆè¨ºç—‡
        async function cancelConsultation() {
            // é¡¯ç¤ºè®€å–åœˆï¼šå˜—è©¦å–å¾—è§¸ç™¼æŒ‰éˆ•ï¼Œå¦‚æžœç„¡æ³•å¾žäº‹ä»¶å–å¾—ï¼Œå‰‡é€éŽæŸ¥è©¢å°‹æ‰¾å…·æœ‰ cancelConsultation() çš„æŒ‰éˆ•
            let loadingButton = null;
            try {
                if (typeof event !== 'undefined' && event && event.currentTarget) {
                    loadingButton = event.currentTarget;
                }
            } catch (_e) {
                // å¿½ç•¥éŒ¯èª¤
            }
            if (!loadingButton) {
                try {
                    loadingButton = document.querySelector('button[onclick="cancelConsultation()"]');
                } catch (_e) {
                    loadingButton = null;
                }
            }
            if (loadingButton) {
                // é¡¯ç¤ºè®€å–åœˆï¼Œä¸é¡¯ç¤ºæ–‡å­—
                setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
            }
            try {
                if (!currentConsultingAppointmentId) {
                    closeConsultationForm();
                    return;
                }
                // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…æ•¸å­—èˆ‡å­—ä¸²ä¸ä¸€è‡´å°Žè‡´åŒ¹é…å¤±æ•—
                const appointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
                if (!appointment) {
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                    return;
                }
                // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
                const patientResult = await safeGetPatients(true);
                if (!patientResult.success) {
                    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                    return;
                }
                const patient = patientResult.data.find(p => p.id === appointment.patientId);
                if (!patient) {
                    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                    return;
                }
                // è©³ç´°ç‹€æ…‹æª¢æŸ¥
                console.log(`å–æ¶ˆè¨ºç—‡ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}`);
                if (appointment.status === 'consulting') {
                    // å–æ¶ˆè¨ºç—‡ç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
                    const lang5 = localStorage.getItem('lang') || 'zh';
                    const zhMsg5 = `ç¢ºå®šè¦å–æ¶ˆ ${patient.name} çš„è¨ºç—‡å—Žï¼Ÿ\n\nç—…äººç‹€æ…‹å°‡å›žåˆ°å€™è¨ºä¸­ï¼Œå·²å¡«å¯«çš„è¨ºç—‡å…§å®¹å°‡æœƒéºå¤±ã€‚\n\næ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŽŸï¼`;
                    const enMsg5 = `Are you sure you want to cancel the consultation for ${patient.name}?\n\nThe patient's status will return to waiting, and any filled consultation content will be lost.\n\nNote: this action cannot be undone!`;
                    const confirmMsg5 = lang5 === 'en' ? enMsg5 : zhMsg5;
                    const confirmedCancel = await showConfirmation(confirmMsg5, 'warning');
                    if (confirmedCancel) {
                        // å°‡ç‹€æ…‹æ”¹å›žå€™è¨ºä¸­
                        appointment.status = 'waiting';
                        delete appointment.consultationStartTime;
                        delete appointment.consultingDoctor;
                        // ä¿å­˜ç‹€æ…‹è®Šæ›´
                        localStorage.setItem('appointments', JSON.stringify(appointments));
                        // åŒæ­¥æ›´æ–°åˆ° Firebase
                        await window.firebaseDataManager.updateAppointment(String(appointment.id), appointment);
                        // å›žå¾©æš«å­˜å¥—ç¥¨è®Šæ›´
                        await revertPendingPackageChanges();
                        {
                            const lang = localStorage.getItem('lang') || 'zh';
                            const msg = lang === 'en'
                                ? `Cancelled ${patient.name}'s consultation and reverted to waiting`
                                : `å·²å–æ¶ˆ ${patient.name} çš„è¨ºç—‡ï¼Œç—…äººå›žåˆ°å€™è¨ºç‹€æ…‹`;
                            showToast(msg, 'info');
                        }
                        // é—œé–‰è¡¨å–®ä¸¦æ¸…ç†
                        closeConsultationForm();
                        currentConsultingAppointmentId = null;
                        loadTodayAppointments();
                    }
                } else if (appointment.status === 'completed') {
                    // å¦‚æžœæ˜¯å·²å®Œæˆçš„è¨ºç—‡ï¼Œåªæ˜¯é—œé–‰ç·¨è¼¯æ¨¡å¼
                    await revertPendingPackageChanges();
                    showToast('å·²é€€å‡ºç—…æ­·ç·¨è¼¯æ¨¡å¼', 'info');
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                } else {
                    // å…¶ä»–ç‹€æ…‹ç›´æŽ¥é—œé–‰
                    await revertPendingPackageChanges();
                    closeConsultationForm();
                    currentConsultingAppointmentId = null;
                }
            } finally {
                // ç§»é™¤è®€å–åœˆï¼Œæ¢å¾©æŒ‰éˆ•
                if (loadingButton) {
                    clearButtonLoading(loadingButton);
                }
            }
        }
        
        // å„²å­˜è¨ºç—‡è¨˜éŒ„ï¼ˆé†«å¸«æ“ä½œï¼‰
async function saveConsultation() {
    if (!currentConsultingAppointmentId) {
        showToast('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
        return;
    }
    
    const symptoms = document.getElementById('formSymptoms').value.trim();
    const diagnosis = document.getElementById('formDiagnosis').value.trim();
    
    if (!symptoms || !diagnosis) {
        showToast('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼šä¸»è¨´ã€ä¸­é†«è¨ºæ–·ï¼', 'error');
        return;
    }
    // å–å¾—ç•¶å‰æŽ›è™Ÿè³‡è¨Šä¸¦åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼Œä¾›å¾ŒçºŒé è™•ç†å’Œä¿å­˜ä½¿ç”¨
    const appointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
    // åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼šæŽ›è™Ÿç‹€æ…‹ç‚ºå·²å®Œæˆä¸”å­˜åœ¨ consultationId
    const isEditing = appointment && appointment.status === 'completed' && appointment.consultationId;
    // é è™•ç†å¥—ç¥¨è³¼è²·ï¼ˆåƒ…åœ¨éžç·¨è¼¯æ¨¡å¼ä¸‹è™•ç†ï¼Œä»¥å…é‡è¤‡è³¼è²·ï¼‰
    // ä¸ç«‹å³å‘¼å« purchasePackageï¼Œè€Œæ˜¯å°‡æ¬²è³¼è²·çš„å¥—ç¥¨è¨˜éŒ„è‡³ pendingPackagePurchasesï¼Œ
    // ç­‰è¨ºç—‡è¨˜éŒ„æˆåŠŸä¿å­˜å¾Œå†ä¸€æ¬¡æ€§è³¼è²·ï¼Œä»¥å…æœªå®Œæˆè¨ºç—‡æ™‚å·²ç¶“å¯«å…¥è³‡æ–™åº«ã€‚
    if (appointment && !isEditing && Array.isArray(selectedBillingItems)) {
        try {
            // åˆå§‹åŒ–æš«å­˜è³¼è²·æ¸…å–®
            pendingPackagePurchases = [];
            // æ‰¾å‡ºæ‰€æœ‰å¥—ç¥¨é …ç›®
            const packageItems = selectedBillingItems.filter(item => item && item.category === 'package');
            // æŒ‰è³¼è²·æ•¸é‡é€ä¸€è¨˜éŒ„
            for (const item of packageItems) {
                const qty = Math.max(1, Number(item.quantity) || 1);
                for (let i = 0; i < qty; i++) {
                    // å…ˆè©¢å•ä½¿ç”¨è€…æ˜¯å¦ç«‹å³ä½¿ç”¨ç¬¬ä¸€æ¬¡ï¼Œä½†ä¸ç«‹å³è³¼è²·
                    // å¥—ç¥¨è³¼è²·æˆåŠŸå¾Œè©¢å•æ˜¯å¦ç«‹å³ä½¿ç”¨ç¬¬ä¸€æ¬¡ï¼ˆæ”¯æ´ä¸­è‹±æ–‡ï¼‰
                    const lang6 = localStorage.getItem('lang') || 'zh';
                    const zhMsg6 = `å¥—ç¥¨ã€Œ${item.name}ã€è³¼è²·æˆåŠŸï¼\n\næ˜¯å¦ç«‹å³ä½¿ç”¨ç¬¬ä¸€æ¬¡ï¼Ÿ\n\nå¥—ç¥¨è©³æƒ…ï¼š\nâ€¢ ç¸½æ¬¡æ•¸ï¼š${item.packageUses} æ¬¡\nâ€¢ æœ‰æ•ˆæœŸï¼š${item.validityDays} å¤©`;
                    const enMsg6 = `Package \"${item.name}\" purchased successfully!\n\nDo you want to use the first session now?\n\nPackage details:\nâ€¢ Total uses: ${item.packageUses}\nâ€¢ Valid for: ${item.validityDays} days`;
                    const confirmUse = await showConfirmation(lang6 === 'en' ? enMsg6 : zhMsg6, 'question');
                    // å¦‚ä½¿ç”¨è€…é¸æ“‡ç«‹å³ä½¿ç”¨ï¼Œå…ˆåœ¨æ”¶è²»åˆ—è¡¨ä¸­åŠ å…¥ä¸€å€‹å¥—ç¥¨ä½¿ç”¨é …ç›®ï¼ˆå°šæœªå–å¾— packageRecordIdï¼‰
                    let usageItemId = null;
                    if (confirmUse) {
                        usageItemId = `pending-use-${Date.now()}-${Math.random()}`;
                        selectedBillingItems.push({
                            id: usageItemId,
                            name: `${item.name} (ä½¿ç”¨å¥—ç¥¨)`,
                            category: 'packageUse',
                            price: 0,
                            unit: 'æ¬¡',
                            description: 'å¥—ç¥¨æŠµæ‰£ä¸€æ¬¡',
                            quantity: 1,
                            includedInDiscount: false,
                            patientId: (appointment.patientId !== undefined && appointment.patientId !== null) ? String(appointment.patientId) : '',
                            packageRecordId: ''
                        });
                    }
                    // å°‡æ“¬è³¼è²·é …ç›®èˆ‡ä½¿ç”¨é¸æ“‡å­˜å…¥æš«å­˜æ¸…å–®ï¼ŒåŒ…æ‹¬å°æ‡‰çš„æš«å­˜ä½¿ç”¨é …ç›® ID
                    pendingPackagePurchases.push({
                        patientId: appointment.patientId,
                        item: item,
                        confirmUse: confirmUse,
                        usageItemId: usageItemId
                    });
                }
            }
            // æ›´æ–°æ”¶è²»é¡¯ç¤ºä»¥åæ˜ æš«å­˜çš„å¥—ç¥¨ä½¿ç”¨
            if (typeof updateBillingDisplay === 'function') {
                updateBillingDisplay();
            }
        } catch (e) {
            console.error('é è™•ç†å¥—ç¥¨è³¼è²·æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', e);
        }
    }

    // åœ¨é€²å…¥ try å€å¡Šä¹‹å‰ç¦ç”¨ä¿å­˜æŒ‰éˆ•ä¸¦é¡¯ç¤ºè®€å–ä¸­å°åœˆ
    // ç”±æ–¼ saveConsultation å‡½å¼å¯èƒ½é€éŽ onclick ç›´æŽ¥å‘¼å«ï¼Œ
    // ç„¡æ³•ä¿è­‰ event ç‰©ä»¶å§‹çµ‚å­˜åœ¨ï¼Œæ•…ä½¿ç”¨é€šç”¨è¼”åŠ©å‡½å¼å–å¾—æŒ‰éˆ•ã€‚
    let saveButton = getLoadingButtonFromEvent('button[onclick="saveConsultation()"]');
    if (saveButton) {
        // å‚³å…¥çš„æ–‡å­—åƒ…ç”¨æ–¼èªžæ„æè¿°ï¼Œå¯¦éš› setButtonLoading åªé¡¯ç¤ºè®€å–åœˆ
        setButtonLoading(saveButton, 'ä¿å­˜ä¸­...');
    }
    try {
        // é ç•™è®Šæ•¸ä»¥è¨˜éŒ„æ–°è¨ºç—‡ IDï¼Œä¾›å¾ŒçºŒæ›´æ–°åº«å­˜ä½¿ç”¨
        let newConsultationIdForInventory = null;
        // ç¢ºèªé å…ˆå–å¾—çš„ appointment æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å‰‡æç¤ºéŒ¯èª¤
        if (!appointment) {
            showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
            return;
        }

        // Assemble consultation data common to both new and edit operations
        const consultationData = {
            appointmentId: currentConsultingAppointmentId,
            patientId: appointment.patientId,
            symptoms: symptoms,
            tongue: document.getElementById('formTongue').value.trim(),
            pulse: document.getElementById('formPulse').value.trim(),
            // ç¾ç—…å²æ¬„ä½å·²æ•´åˆè‡³ä¸»è¨´è¼¸å…¥å€ï¼Œåƒ…ä¿å­˜æ–¼ä¸»è¨´æ¬„ä½ï¼Œä¸å†å–®ç¨å„²å­˜
            currentHistory: '',
            diagnosis: diagnosis,
            syndrome: document.getElementById('formSyndrome').value.trim(),
            acupunctureNotes: (() => {
                const acnEl = document.getElementById('formAcupunctureNotes');
                // å„²å­˜é‡ç¸å‚™è¨»ä½¿ç”¨ innerHTML ä»¥ä¿ç•™æ–¹å¡Šæ ¼å¼
                return acnEl ? acnEl.innerHTML.trim() : '';
            })(),
            prescription: document.getElementById('formPrescription').value.trim(),
            // æ–°å¢žï¼šå°‡è™•æ–¹é …ç›®ä»¥çµæ§‹åŒ–è³‡æ–™å„²å­˜ï¼Œæ–¹ä¾¿å¾ŒçºŒç·¨è¼¯ï¼Œä¸å†ä¾è³´è§£æžæ–‡å­—ã€‚
            prescriptionStructured: (() => {
                try {
                    // è‹¥ selectedPrescriptionItems å·²å®šç¾©ä¸”ç‚ºé™£åˆ—ï¼Œå‰‡åºåˆ—åŒ–ï¼›å¦å‰‡å›žå‚³ç©ºé™£åˆ—
                    return JSON.stringify(Array.isArray(selectedPrescriptionItems) ? selectedPrescriptionItems : []);
                } catch (_e) {
                    return '[]';
                }
            })(),
            usage: document.getElementById('formUsage').value.trim(),
            treatmentCourse: document.getElementById('formTreatmentCourse').value.trim(),
            instructions: document.getElementById('formInstructions').value.trim(),
            followUpDate: document.getElementById('formFollowUpDate').value,
            visitTime: document.getElementById('formVisitTime').value,
            restStartDate: document.getElementById('formRestStartDate').value,
            restEndDate: document.getElementById('formRestEndDate').value,
            billingItems: document.getElementById('formBillingItems').value.trim(),
            // date and doctor fields are assigned below depending on whether this is a new record or an edit
            status: 'completed'
        };
        // å°‡æœè—¥å¤©æ•¸èˆ‡æ¯æ—¥æ¬¡æ•¸å­˜å…¥è¨ºç—‡è³‡æ–™ï¼Œé è¨­ 0 ä»£è¡¨æœªè¨­å®š
        try {
            const daysInputEl = document.getElementById('medicationDays');
            const freqInputEl = document.getElementById('medicationFrequency');
            const daysVal = daysInputEl ? parseInt(daysInputEl.value) : 0;
            const freqVal = freqInputEl ? parseInt(freqInputEl.value) : 0;
            consultationData.medicationDays = isNaN(daysVal) ? 0 : daysVal;
            consultationData.medicationFrequency = isNaN(freqVal) ? 0 : freqVal;
        } catch (_e) {
            // è‹¥è®€å–å¤±æ•—ï¼Œä»ä¿ç•™é è¨­å€¼
            consultationData.medicationDays = 0;
            consultationData.medicationFrequency = 0;
        }

        // --- è¨˜éŒ„æœ¬æ¬¡è¨ºç—‡æ‰€ä½¿ç”¨çš„å¥—ç¥¨è®Šæ›´ï¼Œæ–¹ä¾¿ä¹‹å¾Œæ’¤å›žè¨ºç—‡æ™‚é‚„åŽŸ ---
        try {
            const aggregatedChanges = {};
            for (const change of pendingPackageChanges) {
                if (!change || !change.patientId || !change.packageRecordId || typeof change.delta !== 'number') continue;
                const key = String(change.patientId) + '||' + String(change.packageRecordId);
                if (!aggregatedChanges[key]) {
                    aggregatedChanges[key] = {
                        patientId: change.patientId,
                        packageRecordId: change.packageRecordId,
                        delta: 0
                    };
                }
                aggregatedChanges[key].delta += change.delta;
            }
            const aggregatedList = Object.values(aggregatedChanges);
            if (aggregatedList.length > 0) {
                consultationData.packageChanges = aggregatedList;
            }
        } catch (agErr) {
            console.error('è¨ˆç®—å¥—ç¥¨è®Šæ›´èšåˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', agErr);
        }

        // Determine whether this is an edit of an existing consultation or a new one
        // isEditing å·²åœ¨å‡½å¼é–‹å§‹æ™‚å®šç¾©ï¼Œé€™è£¡ç›´æŽ¥ä½¿ç”¨
        let operationSuccess = false;
        if (isEditing) {
            // For editing we preserve the original date and doctor information if available
            // å˜—è©¦åœ¨æœ¬åœ°ç·©å­˜ä¸­å°‹æ‰¾å°æ‡‰çš„è¨ºç—‡ç´€éŒ„ï¼Œä½¿ç”¨å­—ä¸²æ¯”å°é¿å…é¡žåž‹ä¸ä¸€è‡´
            let existing = consultations.find(c => String(c.id) === String(appointment.consultationId));
            if (!existing) {
                const consResult = await window.firebaseDataManager.getConsultations();
                if (consResult && consResult.success) {
                    // æ›´æ–°å…¨åŸŸè¨ºç—‡å¿«å–
                    consultations = consResult.data;
                    existing = consResult.data.find(c => String(c.id) === String(appointment.consultationId));
                }
            }
            consultationData.date = existing && existing.date ? existing.date : new Date();
            consultationData.doctor = existing && existing.doctor ? existing.doctor : currentUser;
            // Update the existing consultation record
            const updateResult = await window.firebaseDataManager.updateConsultation(String(appointment.consultationId), consultationData);
            if (updateResult && updateResult.success) {
                operationSuccess = true;
                // Update local cache if present
                const idx = consultations.findIndex(c => String(c.id) === String(appointment.consultationId));
                if (idx >= 0) {
                    // Merge the updated fields back into the local consultations array
                    consultations[idx] = { ...consultations[idx], ...consultationData, updatedAt: new Date(), updatedBy: currentUser };
                }
                // Persist updated consultations to localStorage so that subsequent reads (e.g. printing) use the latest values
                try {
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                } catch (_lsErr) {
                    // ignore localStorage write errors
                }
                // Also update FirebaseDataManager's consultations cache if it exists to keep in-memory cache in sync
                try {
                    if (window.firebaseDataManager && Array.isArray(window.firebaseDataManager.consultationsCache)) {
                        const cacheIdx = window.firebaseDataManager.consultationsCache.findIndex(c => String(c.id) === String(appointment.consultationId));
                        if (cacheIdx >= 0) {
                            window.firebaseDataManager.consultationsCache[cacheIdx] = { ...window.firebaseDataManager.consultationsCache[cacheIdx], ...consultationData, updatedAt: new Date(), updatedBy: currentUser };
                        }
                    }
                } catch (_cacheErr) {
                    // ignore cache update errors
                }
                // æ›´æ–°æŽ›è™Ÿè³‡æ–™ä¸­çš„ä¸»è¨´å…§å®¹ï¼Œç¢ºä¿æŽ›è™Ÿåˆ—è¡¨é¡¯ç¤ºæœ€æ–°çš„ä¸»è¨´
                appointment.chiefComplaint = symptoms;
                // æ›´æ–°æœ¬åœ°å„²å­˜çš„ appointments é™£åˆ—
                localStorage.setItem('appointments', JSON.stringify(appointments));
                // åŒæ­¥æ›´æ–°åˆ° Firebase
                await window.firebaseDataManager.updateAppointment(String(appointment.id), appointment);
                showToast('è¨ºç—‡è¨˜éŒ„å·²æ›´æ–°ï¼', 'success');
            } else {
                showToast('æ›´æ–°è¨ºç—‡è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        } else {
            // New consultation: assign the current date and doctor
            // ç‚ºæ–°çš„ç—…æ­·ç”¢ç”Ÿä¸€å€‹å”¯ä¸€çš„ç—…æ­·ç·¨è™Ÿ
            consultationData.medicalRecordNumber = generateMedicalRecordNumber();
            consultationData.date = new Date();
            consultationData.doctor = currentUser;
            const result = await window.firebaseDataManager.addConsultation(consultationData);
            if (result && result.success) {
                operationSuccess = true;
                // Update appointment status and metadata
                appointment.status = 'completed';
                appointment.completedAt = new Date().toISOString();
                appointment.consultationId = result.id;
                appointment.completedBy = currentUser;
                // å°‡æœ¬æ¬¡ç—‡ç‹€ä¿å­˜è‡³æŽ›è™Ÿè³‡æ–™ä¸­çš„ä¸»è¨´ï¼Œç¢ºä¿æŽ›è™Ÿåˆ—è¡¨é¡¯ç¤ºæœ€æ–°ä¸»è¨´
                appointment.chiefComplaint = symptoms;
                localStorage.setItem('appointments', JSON.stringify(appointments));
                await window.firebaseDataManager.updateAppointment(String(appointment.id), appointment);
                showToast('è¨ºç—‡è¨˜éŒ„å·²ä¿å­˜ï¼', 'success');
                // è¨˜éŒ„æ–°ç”¢ç”Ÿçš„è¨ºç—‡ ID ä¾›å¾ŒçºŒåº«å­˜æ›´æ–°
                newConsultationIdForInventory = result.id;

                // å°‡æ–°å¢žçš„è¨ºç—‡è¨˜éŒ„åŠ å…¥æœ¬åœ° consultations é™£åˆ—ä¸¦æ›´æ–°å¿«å–
                try {
                    // çµ„åˆæ–°çš„è¨ºç—‡è¨˜éŒ„ç‰©ä»¶ï¼ˆå« IDï¼‰ï¼Œä¸¦åˆä½µ consultationData
                    const newRecord = { id: result.id, ...consultationData, createdAt: new Date(), updatedAt: new Date(), updatedBy: currentUser };
                    // è‹¥ consultations ç‚ºé™£åˆ—å‰‡æ–°å¢žè‡³çµå°¾
                    if (Array.isArray(consultations)) {
                        consultations.push(newRecord);
                    } else {
                        consultations = [newRecord];
                    }
                    // å¯«å…¥ localStorage
                    try {
                        localStorage.setItem('consultations', JSON.stringify(consultations));
                    } catch (_lsErr2) {
                        // å¿½ç•¥å¯«å…¥å¤±æ•—
                    }
                    // æ›´æ–° FirebaseDataManager çš„ consultationsCache ä»¥ä¿æŒç·©å­˜åŒæ­¥
                    try {
                        if (window.firebaseDataManager && Array.isArray(window.firebaseDataManager.consultationsCache)) {
                            window.firebaseDataManager.consultationsCache.push(newRecord);
                        }
                    } catch (_cacheErr2) {
                        // å¿½ç•¥å¿«å–æ›´æ–°éŒ¯èª¤
                    }
                } catch (_e2) {
                    // å¿½ç•¥ä»»ä½•æ–°å¢žæœ¬åœ°å¿«å–æ™‚çš„éŒ¯èª¤
                }
            } else {
                showToast('ä¿å­˜è¨ºç—‡è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        if (operationSuccess) {
            // ä¿å­˜æˆåŠŸæ™‚ï¼Œå…ˆæäº¤æš«å­˜çš„å¥—ç¥¨è³¼è²·èˆ‡ä½¿ç”¨
            await commitPendingPackagePurchases();
            // æäº¤æš«å­˜å¥—ç¥¨è³¼è²·å¾Œï¼Œæäº¤æœ¬åœ°æš«å­˜çš„å¥—ç¥¨ä½¿ç”¨è®Šæ›´è‡³è³‡æ–™åº«
            await commitPendingPackageChanges();
            // æäº¤å¾Œæ¸…ç©ºæš«å­˜è®Šæ›´
            pendingPackageChanges = [];
            // æ›´æ–°ä¸­è—¥åº«å­˜
            try {
                // å–å¾—æœè—¥å¤©æ•¸èˆ‡æ¬¡æ•¸
                const days = parseInt(document.getElementById('medicationDays') && document.getElementById('medicationDays').value) || 1;
                const freq = parseInt(document.getElementById('medicationFrequency') && document.getElementById('medicationFrequency').value) || 1;
                // æ±ºå®šè¦ä½¿ç”¨çš„è¨ºç—‡ ID
                let consultationIdForInv = null;
                if (isEditing) {
                    consultationIdForInv = appointment && appointment.consultationId;
                } else {
                    consultationIdForInv = typeof newConsultationIdForInventory !== 'undefined' ? newConsultationIdForInventory : null;
                }
                // è®€å–å…ˆå‰æ¶ˆè€—ç´€éŒ„ï¼ˆåƒ…ç·¨è¼¯æ¨¡å¼ï¼‰
                let prevLog = null;
                if (isEditing && consultationIdForInv) {
                    try {
                        const logSnap = await window.firebase.get(window.firebase.ref(window.firebase.rtdb, 'inventoryLogs/' + String(consultationIdForInv)));
                        if (logSnap && logSnap.exists()) {
                            prevLog = logSnap.val();
                        }
                    } catch (_err) {
                        prevLog = null;
                    }
                }
                if (consultationIdForInv && typeof updateInventoryAfterConsultation === 'function') {
                    await updateInventoryAfterConsultation(
                        consultationIdForInv,
                        Array.isArray(selectedPrescriptionItems) ? selectedPrescriptionItems : [],
                        days,
                        freq,
                        isEditing,
                        prevLog
                    );
                }
            } catch (invErr) {
                console.error('æ›´æ–°ä¸­è—¥åº«å­˜è³‡æ–™å¤±æ•—:', invErr);
            }
            // å®Œæˆå¾Œé—œé–‰è¨ºç—‡è¡¨å–®ä¸¦æ›´æ–° UI
            closeConsultationForm();
            loadTodayAppointments();
            updateStatistics();
            clearAllSearchFields();
        }

    } catch (error) {
        console.error('ä¿å­˜è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
        showToast('ä¿å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹èˆ‡å…§å®¹ã€‚ä½¿ç”¨å‰é¢å–å¾—çš„ saveButton ä»¥é¿å…é‡è¤‡æŸ¥æ‰¾ã€‚
        if (saveButton) {
            clearButtonLoading(saveButton);
        }
    }
}
        
        // ç—…äººè³‡æ–™ç®¡ç†é é¢çš„ç—…æ­·æŸ¥çœ‹åŠŸèƒ½
        let currentPatientConsultations = [];
        let currentPatientHistoryPage = 0;
        
        async function showPatientMedicalHistory(patientId) {
    try {
// ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
const patientResult = await safeGetPatients(true);
if (!patientResult.success) {
    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === patientId);
if (!patient) {
    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
    return;
}
            
            // ç²å–è©²ç—…äººçš„æ‰€æœ‰è¨ºç—‡è¨˜éŒ„ï¼ˆå¾ž Firestore å–å¾—ï¼‰
            // å¼·åˆ¶é‡æ–°å–å¾—è¨ºç—‡è¨˜éŒ„ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
            const consultationResult = await window.firebaseDataManager.getPatientConsultations(patientId, true);
            if (!consultationResult.success) {
                showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            // ä½¿ç”¨é€šç”¨æ—¥æœŸè§£æžå‡½å¼å°è³‡æ–™é€²è¡ŒæŽ’åºï¼ŒæŒ‰æ—¥æœŸå‡åºæŽ’åˆ—ï¼ˆè¼ƒèˆŠè‡³è¼ƒæ–°ï¼‰
            currentPatientConsultations = consultationResult.data.slice().sort((a, b) => {
                const dateA = parseConsultationDate(a.date);
                const dateB = parseConsultationDate(b.date);
                // è‹¥å…¶ä¸­ä¸€å€‹æ—¥æœŸç„¡æ³•è§£æžï¼Œå°‡å…¶æ”¾åˆ°è¼ƒå¾Œé¢
                if (!dateA || isNaN(dateA.getTime())) return 1;
                if (!dateB || isNaN(dateB.getTime())) return -1;
                return dateA - dateB;
            });
            
            // é è¨­é¡¯ç¤ºæœ€æ–°çš„ç—…æ­·ï¼ˆæœ€è¿‘ä¸€æ¬¡è¨ºç—‡ï¼‰
            currentPatientHistoryPage = currentPatientConsultations.length - 1;
            
            // è¨­ç½®æ¨™é¡Œ
            document.getElementById('patientMedicalHistoryTitle').textContent = `${patient.name} çš„ç—…æ­·è¨˜éŒ„`;
            
            // é¡¯ç¤ºç—…äººåŸºæœ¬è³‡è¨Š
            document.getElementById('patientMedicalHistoryPatientInfo').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">ç—…äººç·¨è™Ÿï¼š</span>
                        <span class="text-blue-600 font-semibold">${patient.patientNumber}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">å§“åï¼š</span>
                        <span class="font-semibold">${patient.name}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">å¹´é½¡ï¼š</span>
                        <span>${formatAge(patient.birthDate)}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">æ€§åˆ¥ï¼š</span>
                        <span>${patient.gender}</span>
                    </div>
                ${patient.history ? `
                    <div class="md:col-span-1 lg:col-span-2">
                        <span class="font-medium text-gray-700">ç—…å²åŠå‚™è¨»ï¼š</span>
                        <span class="medical-field text-gray-700">${patient.history}</span>
                    </div>
                    ` : ''}
                ${patient.allergies ? `
                    <div class="md:col-span-1 lg:col-span-2">
                        <span class="font-medium text-red-600">éŽæ•å²ï¼š</span>
                        <span class="medical-field text-red-700 bg-red-50 px-2 py-1 rounded">${patient.allergies}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // é¡¯ç¤ºåˆ†é ç—…æ­·è¨˜éŒ„
            displayPatientMedicalHistoryPage();
            
            document.getElementById('patientMedicalHistoryModal').classList.remove('hidden');
            } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
        }
        
        function displayPatientMedicalHistoryPage() {
            const contentDiv = document.getElementById('patientMedicalHistoryContent');

            // Determine current language and translation dictionary.  Use
            // localStorage to fetch the persisted language; default to
            // Chinese when not found.  This allows us to construct
            // translated dynamic strings below.  The dictionary is used
            // solely for static labels such as 'è¨ºç—‡è¨˜éŒ„', 'è¼ƒèˆŠ', 'è¼ƒæ–°',
            // 'é†«å¸«ï¼š', and 'ç—…æ­·ç·¨è™Ÿï¼š'.
            const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
            const dict = (window.translations && window.translations[lang]) ? window.translations[lang] : {};
            
            if (currentPatientConsultations.length === 0) {
                // Use Chinese strings here so the i18n observer can
                // translate them if necessary.  For zeroâ€‘records state
                // there are no dynamic numbers to handle.
                contentDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ðŸ“‹</div>
                        <div class="text-lg font-medium mb-2">æš«ç„¡è¨ºç—‡è¨˜éŒ„</div>
                        <div class="text-sm">è©²ç—…äººå°šæœªæœ‰è¨ºç—‡è¨˜éŒ„</div>
                    </div>
                `;
                return;
            }
            
            const consultation = currentPatientConsultations[currentPatientHistoryPage];
            const totalPages = currentPatientConsultations.length;
            const currentPageNumber = currentPatientHistoryPage + 1;
            const consultationNumber = currentPatientHistoryPage + 1;

            // Prepare dynamic translation segments.  We look up static labels
            // from the dictionary and build English phrases when needed.
            const recordTitle = dict['è¨ºç—‡è¨˜éŒ„'] || 'è¨ºç—‡è¨˜éŒ„';
            const visitText = lang === 'zh'
                ? `ç¬¬ ${consultationNumber} æ¬¡è¨ºç—‡`
                : `Visit ${consultationNumber}`;
            const totalText = lang === 'zh'
                ? `å…± ${totalPages} æ¬¡è¨ºç—‡è¨˜éŒ„`
                : `Total ${totalPages} consultation records`;
            const prevLabel = dict['è¼ƒèˆŠ'] || 'è¼ƒèˆŠ';
            const nextLabel = dict['è¼ƒæ–°'] || 'è¼ƒæ–°';
            const doctorLabel = dict['é†«å¸«ï¼š'] || 'é†«å¸«ï¼š';
            const recordNumberLabel = dict['ç—…æ­·ç·¨è™Ÿï¼š'] || 'ç—…æ­·ç·¨è™Ÿï¼š';

            contentDiv.innerHTML = `
                <!-- åˆ†é å°Žèˆª -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <h4 class="text-lg font-semibold text-gray-800">${recordTitle}</h4>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            ${visitText}
                        </span>
                        <span class="text-sm text-gray-600">
                            ${totalText}
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="changePatientHistoryPage(-1)" 
                                ${currentPatientHistoryPage === 0 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            â† ${prevLabel}
                        </button>
                        <span class="text-sm text-gray-600 px-2">
                            ${currentPageNumber} / ${totalPages}
                        </span>
                        <button onclick="changePatientHistoryPage(1)" 
                                ${currentPatientHistoryPage === totalPages - 1 ? 'disabled' : ''}
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                            ${nextLabel} â†’
                        </button>
                    </div>
                </div>
                
                <!-- ç•¶å‰ç—…æ­·è¨˜éŒ„ -->
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <span class="font-semibold text-gray-900 text-lg">
                                    ${(() => {
                                        // ä½¿ç”¨é€šç”¨æ—¥æœŸè§£æžå‡½å¼è™•ç†å„ç¨®æ—¥æœŸæ ¼å¼
                                        const parsedDate = parseConsultationDate(consultation.date);
                                        if (!parsedDate || isNaN(parsedDate.getTime())) {
                                            return 'æ—¥æœŸæœªçŸ¥';
                                        }
                                        // æ ¹æ“šèªžè¨€è¨­å®šè¼¸å‡ºæ—¥æœŸæ ¼å¼ã€‚è‹±èªžä½¿ç”¨ en-USï¼Œä¸­æ–‡ä½¿ç”¨ zh-TWã€‚
                                        const locale = lang === 'en' ? 'en-US' : 'zh-TW';
                                        const datePart = parsedDate.toLocaleDateString(locale);
                                        const timePart = parsedDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                                        return datePart + ' ' + timePart;
                                    })()}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    ${doctorLabel}${getDoctorDisplayName(consultation.doctor)}
                                </span>
                                <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                                    ${recordNumberLabel}${consultation.medicalRecordNumber || consultation.id}
                                </span>
                                ${consultation.updatedAt ? `
                                    <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                        å·²ä¿®æ”¹
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex flex-wrap justify-end gap-1">
                                <button onclick="printConsultationRecord('${consultation.id}')" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                                    åˆ—å°æ”¶æ“š
                                </button>
                                <!-- æ–°å¢žè—¥å–®é†«å›‘åˆ—å°æŒ‰éˆ•ï¼Œæ”¾åœ¨æ”¶æ“šå³å´ -->
                                <button onclick="printPrescriptionInstructions('${consultation.id}')" 
                                        class="text-yellow-600 hover:text-yellow-800 text-sm font-medium bg-yellow-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                                    è—¥å–®é†«å›‘
                                </button>
                                <button onclick="printAttendanceCertificate('${consultation.id}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                                    åˆ°è¨ºè­‰æ˜Ž
                                </button>
                                ${(() => {
                                    // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è¨ºç—‡ä¸”ç‚ºç›¸åŒç—…äºº
                                    if (currentConsultingAppointmentId) {
                                        const currentAppointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
                                        if (currentAppointment && String(currentAppointment.patientId) === String(consultation.patientId)) {
                                            return `
                                                <button onclick="loadMedicalRecordToCurrentConsultation('${consultation.id}')" 
                                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                                                    è¼‰å…¥ç—…æ­·
                                                </button>
                                            `;
                                        }
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸»è¨´</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.symptoms || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                                ${consultation.currentHistory ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ç¾ç—…å²</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.currentHistory}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.tongue ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">èˆŒè±¡</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.tongue}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.pulse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è„ˆè±¡</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.pulse}</div>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸­é†«è¨ºæ–·</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 medical-field">${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è­‰åž‹è¨ºæ–·</span>
                                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400 medical-field">${consultation.syndrome || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                                ${consultation.acupunctureNotes ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">é‡ç¸å‚™è¨»</span>
                                    <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400 medical-field">${window.stripHtmlTags(consultation.acupunctureNotes)}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è™•æ–¹å…§å®¹</span>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line medical-field">${consultation.prescription || 'ç„¡è¨˜éŒ„'}</div>
                                </div>
                                
                        ${consultation.usage && consultation.prescription ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">æœç”¨æ–¹æ³•</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">
                                        ${(() => {
                                            try {
                                                const parts = [];
                                                if (consultation.medicationDays && Number(consultation.medicationDays) > 0) {
                                                    parts.push('æœè—¥å¤©æ•¸ï¼š' + consultation.medicationDays + 'å¤©');
                                                }
                                                if (consultation.medicationFrequency && Number(consultation.medicationFrequency) > 0) {
                                                    parts.push('æ¯æ—¥æ¬¡æ•¸ï¼š' + consultation.medicationFrequency + 'æ¬¡');
                                                }
                                                const prefix = parts.length > 0 ? parts.join('ã€€') + 'ã€€' : '';
                                                return prefix + consultation.usage;
                                            } catch (_err) {
                                                return consultation.usage;
                                            }
                                        })()}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${consultation.treatmentCourse ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">ç™‚ç¨‹</span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.treatmentCourse}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.instructions ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">é†«å›‘åŠæ³¨æ„äº‹é …</span>
                                    <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400 medical-field">${consultation.instructions}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.followUpDate ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">è¤‡è¨ºæ™‚é–“</span>
                                    <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400 medical-field">${new Date(consultation.followUpDate).toLocaleString('zh-TW')}</div>
                                </div>
                                ` : ''}
                                
                                ${consultation.billingItems ? `
                                <div>
                                    <span class="text-sm font-semibold text-gray-700 block mb-2">æ”¶è²»é …ç›®</span>
                                    <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line medical-field">${consultation.billingItems}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function changePatientHistoryPage(direction) {
            const newPage = currentPatientHistoryPage + direction;
            if (newPage >= 0 && newPage < currentPatientConsultations.length) {
                currentPatientHistoryPage = newPage;
                displayPatientMedicalHistoryPage();
            }
        }

        // é—œé–‰ç—…äººç—…æ­·æŸ¥çœ‹å½ˆçª—
        function closePatientMedicalHistoryModal() {
            document.getElementById('patientMedicalHistoryModal').classList.add('hidden');
        }



        // è¨ºç—‡ç³»çµ±ä¸­çš„ç—…æ­·æŸ¥çœ‹åŠŸèƒ½
        let currentConsultationConsultations = [];
        let currentConsultationHistoryPage = 0;
        
// 5. ä¿®æ”¹æŸ¥çœ‹ç—…äººè¨ºç—‡è¨˜éŒ„åŠŸèƒ½
async function viewPatientMedicalHistory(patientId) {
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ï¼šå„ªå…ˆä½¿ç”¨äº‹ä»¶ç›®æ¨™ï¼Œå…¶æ¬¡é€éŽ DOM æŸ¥æ‰¾
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector(`button[onclick="viewPatientMedicalHistory('${patientId}')"]`);
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è®€å–ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const patientResult = await safeGetPatients(true);
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™', 'error');
            return;
        }
        
        // ç²å–è©²ç—…äººçš„æ‰€æœ‰è¨ºç—‡è¨˜éŒ„ï¼ˆå¼·åˆ¶åˆ·æ–°ï¼‰ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
        const consultationResult = await window.firebaseDataManager.getPatientConsultations(patientId, true);
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„', 'error');
            return;
        }

        /**
         * Firebase å›žå‚³çš„è¨ºç—‡è¨˜éŒ„é è¨­æŒ‰ç…§æ—¥æœŸé™åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰ï¼Œ
         * ä½†åœ¨ç—…æ­·ç€è¦½é é¢ä¸­å¸Œæœ›å°‡é †åºèª¿æ•´ç‚ºã€Œè¼ƒèˆŠåœ¨å·¦ã€æœ€æ–°åœ¨å³ã€ã€‚
         * å› æ­¤é€™è£¡å…ˆè¤‡è£½ä¸€ä»½è³‡æ–™ï¼Œå†ä½¿ç”¨æ—¥æœŸé€²è¡Œå‡åºæŽ’åºï¼Œ
         * ä¸¦å°‡ç•¶å‰é ç´¢å¼•è¨­ç‚ºæœ€å¾Œä¸€ç­†ï¼Œç¢ºä¿é€²å…¥é é¢æ™‚é¡¯ç¤ºæœ€æ–°çš„ä¸€æ¬¡è¨ºç—‡ã€‚
         */
        currentConsultationConsultations = consultationResult.data.slice().sort((a, b) => {
            const dateA = parseConsultationDate(a.date);
            const dateB = parseConsultationDate(b.date);
            // è‹¥å…¶ä¸­ä¸€å€‹æ—¥æœŸç„¡æ³•è§£æžï¼Œå°‡å…¶æ”¾åˆ°è¼ƒå¾Œé¢
            if (!dateA || isNaN(dateA.getTime())) return 1;
            if (!dateB || isNaN(dateB.getTime())) return -1;
            return dateA - dateB;
        });

        // é è¨­é¡¯ç¤ºæœ€æ–°çš„ç—…æ­·ï¼ˆæœ€è¿‘ä¸€æ¬¡è¨ºç—‡åœ¨æœ€å³ï¼‰
        currentConsultationHistoryPage = currentConsultationConsultations.length - 1;
        
        // è¨­ç½®æ¨™é¡Œï¼ˆè½‰ç¾©ä½¿ç”¨è€…è¼¸å…¥ï¼Œé¿å… XSSï¼‰
        document.getElementById('medicalHistoryTitle').textContent = `${window.escapeHtml(patient.name)} çš„è¨ºç—‡è¨˜éŒ„`;
        
        // é¡¯ç¤ºç—…äººåŸºæœ¬è³‡è¨Š
        document.getElementById('medicalHistoryPatientInfo').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">ç—…äººç·¨è™Ÿï¼š</span>
            <span class="text-blue-600 font-semibold">${window.escapeHtml(patient.patientNumber)}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">å§“åï¼š</span>
            <span class="font-semibold">${window.escapeHtml(patient.name)}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">å¹´é½¡ï¼š</span>
            <span>${window.escapeHtml(formatAge(patient.birthDate))}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">æ€§åˆ¥ï¼š</span>
            <span>${window.escapeHtml(patient.gender)}</span>
                </div>
                ${patient.history ? `
                <div class="md:col-span-1 lg:col-span-2">
                    <span class="font-medium text-gray-700">ç—…å²åŠå‚™è¨»ï¼š</span>
                    <span class="medical-field text-gray-700">${window.escapeHtml(patient.history)}</span>
                </div>
                ` : ''}
                ${patient.allergies ? `
                <div class="md:col-span-1 lg:col-span-2">
                    <span class="font-medium text-red-600">éŽæ•å²ï¼š</span>
                    <span class="medical-field text-red-700 bg-red-50 px-2 py-1 rounded">${window.escapeHtml(patient.allergies)}</span>
                </div>
                ` : ''}
            </div>
        `;
        
        // é¡¯ç¤ºåˆ†é ç—…æ­·è¨˜éŒ„
        displayConsultationMedicalHistoryPage();
        
        document.getElementById('medicalHistoryModal').classList.remove('hidden');
        
    } catch (error) {
        console.error('æŸ¥çœ‹ç—…äººè¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    } finally {
        // æ¸…é™¤æŒ‰éˆ•çš„è®€å–ç‹€æ…‹
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}
        
// ä¿®å¾©ç—…æ­·è¨˜éŒ„é¡¯ç¤ºä¸­çš„æ—¥æœŸå•é¡Œ
function displayConsultationMedicalHistoryPage() {
    const contentDiv = document.getElementById('medicalHistoryContent');

    // Determine the current language and translation dictionary.  We rely on
    // localStorage to persist the selected language (zh or en).  If an
    // unsupported value is found we default to Chinese.  The translation
    // dictionary is used for translating static labels while dynamic
    // segments (such as numbered visits) are constructed below.
    const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
    const dict = (window.translations && window.translations[lang]) ? window.translations[lang] : {};
    
    if (currentConsultationConsultations.length === 0) {
        // When there are no consultation records, we still allow the text
        // content to be translated by the i18n observer.  Therefore
        // Chinese strings are left intact here and will be replaced if the
        // language is set to English via the dictionary.
        contentDiv.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <div class="text-4xl mb-4">ðŸ“‹</div>
                <div class="text-lg font-medium mb-2">æš«ç„¡è¨ºç—‡è¨˜éŒ„</div>
                <div class="text-sm">è©²ç—…äººå°šæœªæœ‰è¨ºç—‡è¨˜éŒ„</div>
            </div>
        `;
        return;
    }
    
    const consultation = currentConsultationConsultations[currentConsultationHistoryPage];
    const totalPages = currentConsultationConsultations.length;
    const currentPageNumber = currentConsultationHistoryPage + 1;
    const consultationNumber = currentConsultationHistoryPage + 1;

    // Build translated dynamic strings.  For Chinese we keep the original
    // formatting; for English we generate equivalent phrases.  The
    // dictionary lookup is used for static terms like 'è¨ºç—‡è¨˜éŒ„',
    // 'è¼ƒèˆŠ', 'è¼ƒæ–°', 'é†«å¸«ï¼š', and 'ç—…æ­·ç·¨è™Ÿï¼š'.
    const recordTitle = dict['è¨ºç—‡è¨˜éŒ„'] || 'è¨ºç—‡è¨˜éŒ„';
    const visitText = lang === 'zh'
        ? `ç¬¬ ${consultationNumber} æ¬¡è¨ºç—‡`
        : `Visit ${consultationNumber}`;
    const totalText = lang === 'zh'
        ? `å…± ${totalPages} æ¬¡è¨ºç—‡è¨˜éŒ„`
        : `Total ${totalPages} consultation records`;
    const prevLabel = dict['è¼ƒèˆŠ'] || 'è¼ƒèˆŠ';
    const nextLabel = dict['è¼ƒæ–°'] || 'è¼ƒæ–°';
    const doctorLabel = dict['é†«å¸«ï¼š'] || 'é†«å¸«ï¼š';
    const recordNumberLabel = dict['ç—…æ­·ç·¨è™Ÿï¼š'] || 'ç—…æ­·ç·¨è™Ÿï¼š';

    // Compose the HTML content with translated dynamic labels.  Chinese
    // strings remain in the markup for static phrases that the i18n
    // framework can translate after insertion.  Dynamic segments are
    // constructed above.
    contentDiv.innerHTML = `
        <!-- åˆ†é å°Žèˆª -->
        <div class="mb-6 flex justify-between items-center bg-gray-50 rounded-lg p-4">
            <div class="flex items-center space-x-4">
                <h4 class="text-lg font-semibold text-gray-800">${recordTitle}</h4>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                    ${visitText}
                </span>
                <span class="text-sm text-gray-600">
                    ${totalText}
                </span>
            </div>
            
            <div class="flex items-center space-x-2">
                <button onclick="changeConsultationHistoryPage(-1)" 
                        ${currentConsultationHistoryPage === 0 ? 'disabled' : ''}
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                    â† ${prevLabel}
                </button>
                <span class="text-sm text-gray-600 px-2">
                    ${currentPageNumber} / ${totalPages}
                </span>
                <button onclick="changeConsultationHistoryPage(1)" 
                        ${currentConsultationHistoryPage === totalPages - 1 ? 'disabled' : ''}
                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm">
                    ${nextLabel} â†’
                </button>
            </div>
        </div>
        
        <!-- ç•¶å‰ç—…æ­·è¨˜éŒ„ -->
        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <span class="font-semibold text-gray-900 text-lg">
                            ${formatConsultationDateTime(consultation.date)}
                        </span>
                        <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                            ${doctorLabel}${getDoctorDisplayName(consultation.doctor)}
                        </span>
                        <!-- æ–°å¢žç—…æ­·ç·¨è™Ÿé¡¯ç¤º -->
                        <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">
                            ${recordNumberLabel}${consultation.medicalRecordNumber || consultation.id}
                        </span>
                        ${consultation.updatedAt ? `
                            <span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">
                                å·²ä¿®æ”¹
                            </span>
                        ` : ''}
                    </div>
                    <div class="flex flex-wrap justify-end gap-1">
                        <button onclick="printConsultationRecord('${consultation.id}')" 
                                class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                            åˆ—å°æ”¶æ“š
                        </button>
                        <!-- æ–°å¢žè—¥å–®é†«å›‘åˆ—å°æŒ‰éˆ•ï¼Œæ”¾åœ¨æ”¶æ“šå³å´ -->
                        <button onclick="printPrescriptionInstructions('${consultation.id}')" 
                                class="text-yellow-600 hover:text-yellow-800 text-sm font-medium bg-yellow-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                            è—¥å–®é†«å›‘
                        </button>
                        <button onclick="printAttendanceCertificate('${consultation.id}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                            åˆ°è¨ºè­‰æ˜Ž
                        </button>
                        ${(() => {
                            // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è¨ºç—‡ä¸”ç‚ºç›¸åŒç—…äºº
                            if (currentConsultingAppointmentId) {
                                const currentAppointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
                                if (currentAppointment && String(currentAppointment.patientId) === String(consultation.patientId)) {
                                    return `
                                        <button onclick="loadMedicalRecordToCurrentConsultation('${consultation.id}')" 
                                                class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">
                                            è¼‰å…¥ç—…æ­·
                                        </button>
                                    `;
                                }
                            }
                            return '';
                        })()}
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸»è¨´</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.symptoms || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        ${consultation.currentHistory ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ç¾ç—…å²</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.currentHistory}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.tongue ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">èˆŒè±¡</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.tongue}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.pulse ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è„ˆè±¡</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.pulse}</div>
                        </div>
                        ` : ''}
                        
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ä¸­é†«è¨ºæ–·</span>
                            <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 medical-field">${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è­‰åž‹è¨ºæ–·</span>
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400 medical-field">${consultation.syndrome || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        ${consultation.acupunctureNotes ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">é‡ç¸å‚™è¨»</span>
                            <div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400 medical-field">${window.stripHtmlTags(consultation.acupunctureNotes)}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è™•æ–¹å…§å®¹</span>
                            <div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line medical-field">${consultation.prescription || 'ç„¡è¨˜éŒ„'}</div>
                        </div>
                        
                        ${consultation.usage && consultation.prescription ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">æœç”¨æ–¹æ³•</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">
                                ${(() => {
                                    try {
                                        const parts = [];
                                        if (consultation.medicationDays && Number(consultation.medicationDays) > 0) {
                                            parts.push('æœè—¥å¤©æ•¸ï¼š' + consultation.medicationDays + 'å¤©');
                                        }
                                        if (consultation.medicationFrequency && Number(consultation.medicationFrequency) > 0) {
                                            parts.push('æ¯æ—¥æ¬¡æ•¸ï¼š' + consultation.medicationFrequency + 'æ¬¡');
                                        }
                                        const prefix = parts.length > 0 ? parts.join('ã€€') + 'ã€€' : '';
                                        return prefix + consultation.usage;
                                    } catch (_err) {
                                        return consultation.usage;
                                    }
                                })()}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${consultation.treatmentCourse ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">ç™‚ç¨‹</span>
                            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${consultation.treatmentCourse}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.instructions ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">é†«å›‘åŠæ³¨æ„äº‹é …</span>
                            <div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400 medical-field">${consultation.instructions}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.followUpDate ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">è¤‡è¨ºæ™‚é–“</span>
                            <div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400 medical-field">${formatConsultationDateTime(consultation.followUpDate)}</div>
                        </div>
                        ` : ''}
                        
                        ${consultation.billingItems ? `
                        <div>
                            <span class="text-sm font-semibold text-gray-700 block mb-2">æ”¶è²»é …ç›®</span>
                            <div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line medical-field">${consultation.billingItems}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}
        
        function changeConsultationHistoryPage(direction) {
            const newPage = currentConsultationHistoryPage + direction;
            if (newPage >= 0 && newPage < currentConsultationConsultations.length) {
                currentConsultationHistoryPage = newPage;
                displayConsultationMedicalHistoryPage();
            }
        }
        
        // é—œé–‰è¨ºç—‡è¨˜éŒ„å½ˆçª—
        function closeMedicalHistoryModal() {
            document.getElementById('medicalHistoryModal').classList.add('hidden');
        }
        

        
// 1. ä¿®æ”¹å¾žæŽ›è™Ÿè¨˜éŒ„åˆ—å°æ”¶æ“šå‡½æ•¸
async function printReceiptFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt && String(apt.id) === String(appointmentId));
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„æ”¶æ“š
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„æ”¶æ“šï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ï¼Œå„ªå…ˆä½¿ç”¨äº‹ä»¶ç›®æ¨™ï¼Œå…¶æ¬¡é€éŽ DOM æŸ¥æ‰¾
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector('button[onclick="printReceiptFromAppointment(' + appointmentId + ')"]');
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'åˆ—å°ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // å˜—è©¦é€éŽå‚³å›žçš„è¨ºç—‡åˆ—è¡¨å°‹æ‰¾å°æ‡‰è¨˜éŒ„ï¼Œä½¿ç”¨å­—ä¸²æ¯”å°é¿å…é¡žåž‹ä¸ä¸€è‡´
        let consultation = consultationResult.data.find(c => String(c.id) === String(appointment.consultationId));
        // æ›´æ–°å…¨åŸŸè¨ºç—‡å¿«å–
        consultations = consultationResult.data;
        // å¦‚æžœæœªæ‰¾åˆ°ï¼Œæ”¹ç”¨ getDoc ç›´æŽ¥è®€å–è©²è¨ºç—‡è¨˜éŒ„
        if (!consultation) {
            try {
                const docRef = window.firebase.doc(window.firebase.db, 'consultations', String(appointment.consultationId));
                const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap && docSnap.exists()) {
                    consultation = { id: docSnap.id, ...docSnap.data() };
                    // å°‡æ–°çš„è¨ºç—‡è¨˜éŒ„åŠ å…¥å¿«å–
                    consultations.push(consultation);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            } catch (err) {
                console.error('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
            }
        }
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // ç›´æŽ¥èª¿ç”¨ç¾æœ‰çš„åˆ—å°åŠŸèƒ½
        await printConsultationRecord(consultation.id, consultation);
    } catch (error) {
        console.error('åˆ—å°æ”¶æ“šéŒ¯èª¤:', error);
        showToast('åˆ—å°æ”¶æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

        
// 2. ä¿®æ”¹å¾žæŽ›è™Ÿè¨˜éŒ„åˆ—å°åˆ°è¨ºè­‰æ˜Žå‡½æ•¸
async function printAttendanceCertificateFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt && String(apt.id) === String(appointmentId));
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„åˆ°è¨ºè­‰æ˜Ž
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„åˆ°è¨ºè­‰æ˜Žï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector('button[onclick="printAttendanceCertificateFromAppointment(' + appointmentId + ')"]');
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'åˆ—å°ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // å˜—è©¦æ–¼è¿”å›žåˆ—è¡¨ä¸­å°‹æ‰¾å°æ‡‰è¨ºç—‡è¨˜éŒ„ï¼Œä½¿ç”¨å­—ä¸²æ¯”å°é¿å…é¡žåž‹ä¸ä¸€è‡´
        let consultation = consultationResult.data.find(c => String(c.id) === String(appointment.consultationId));
        // æ›´æ–°å…¨åŸŸè¨ºç—‡å¿«å–
        consultations = consultationResult.data;
        // è‹¥æœªæ‰¾åˆ°ï¼Œç›´æŽ¥é€šéŽ getDoc å–å¾—
        if (!consultation) {
            try {
                const docRef = window.firebase.doc(window.firebase.db, 'consultations', String(appointment.consultationId));
                const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap && docSnap.exists()) {
                    consultation = { id: docSnap.id, ...docSnap.data() };
                    consultations.push(consultation);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            } catch (err) {
                console.error('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
            }
        }
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // ç›´æŽ¥èª¿ç”¨åˆ°è¨ºè­‰æ˜Žåˆ—å°åŠŸèƒ½
        await printAttendanceCertificate(consultation.id, consultation);
    } catch (error) {
        console.error('åˆ—å°åˆ°è¨ºè­‰æ˜ŽéŒ¯èª¤:', error);
        showToast('åˆ—å°åˆ°è¨ºè­‰æ˜Žæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}
        
// 3. ä¿®æ”¹å¾žæŽ›è™Ÿè¨˜éŒ„åˆ—å°ç—…å‡è­‰æ˜Žå‡½æ•¸
async function printSickLeaveFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt && String(apt.id) === String(appointmentId));
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„ç—…å‡è­‰æ˜Ž
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„ç—…å‡è­‰æ˜Žï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector('button[onclick="printSickLeaveFromAppointment(' + appointmentId + ')"]');
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'åˆ—å°ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // å˜—è©¦æ–¼è¿”å›žåˆ—è¡¨ä¸­å°‹æ‰¾å°æ‡‰è¨ºç—‡è¨˜éŒ„ï¼Œä½¿ç”¨å­—ä¸²æ¯”å°é¿å…é¡žåž‹ä¸ä¸€è‡´
        let consultation = consultationResult.data.find(c => String(c.id) === String(appointment.consultationId));
        // æ›´æ–°å…¨åŸŸè¨ºç—‡å¿«å–
        consultations = consultationResult.data;
        // è‹¥æœªæ‰¾åˆ°ï¼Œç›´æŽ¥é€šéŽ getDoc æ ¹æ“š ID è®€å–
        if (!consultation) {
            try {
                const docRef = window.firebase.doc(window.firebase.db, 'consultations', String(appointment.consultationId));
                const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap && docSnap.exists()) {
                    consultation = { id: docSnap.id, ...docSnap.data() };
                    consultations.push(consultation);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            } catch (err) {
                console.error('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
            }
        }
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // ç›´æŽ¥èª¿ç”¨ç—…å‡è­‰æ˜Žåˆ—å°åŠŸèƒ½
        await printSickLeave(consultation.id, consultation);
    } catch (error) {
        console.error('åˆ—å°ç—…å‡è­‰æ˜ŽéŒ¯èª¤:', error);
        showToast('åˆ—å°ç—…å‡è­‰æ˜Žæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}
        
// 4. ä¿®æ”¹åˆ—å°è¨ºç—‡è¨˜éŒ„å‡½æ•¸
async function printConsultationRecord(consultationId, consultationData = null) {
    let consultation = consultationData;
    // å°‡å‚³å…¥çš„ ID è½‰ç‚ºå­—ä¸²ä»¥ä¾¿æ¯”è¼ƒï¼ˆå…¼å®¹æ•¸å­—èˆ‡å­—ä¸²ï¼‰
    const idToFind = String(consultationId);
    
    // å¦‚æžœæ²’æœ‰æä¾›è¨ºç—‡è³‡æ–™ï¼Œå¾ž Firebase ç²å–
    if (!consultation) {
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (!consultationResult.success) {
                showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            consultation = consultationResult.data.find(c => String(c.id) === idToFind);
            if (!consultation) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
            showToast('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—', 'error');
            return;
        }
    }
    
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const patientResult = await safeGetPatients(true);
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // è§£æžæ”¶è²»é …ç›®ä»¥è¨ˆç®—ç¸½é‡‘é¡
        let totalAmount = 0;
        let billingItemsHtml = '';
        if (consultation.billingItems) {
            const lines = consultation.billingItems.split('\n');
            lines.forEach(line => {
                if (line.includes('=') && line.includes('$')) {
                    const match = line.match(/\$(\d+)/);
                    if (match) {
                        totalAmount += parseInt(match[1]);
                    }
                    billingItemsHtml += `<tr><td style="padding: 5px; border-bottom: 1px dotted #ccc;">${line}</td></tr>`;
                } else if (line.includes('ç¸½è²»ç”¨')) {
                    const match = line.match(/\$(\d+)/);
                    if (match) {
                        totalAmount = parseInt(match[1]);
                    }
                } else if (line.startsWith('æŠ˜æ‰£é©ç”¨æ–¼')) {
                    // é¡¯ç¤ºæŠ˜æ‰£é©ç”¨é …ç›®æ˜Žç´°æ–¼æ”¶æ“šä¸­
                    billingItemsHtml += `<tr><td style="padding: 5px; border-bottom: 1px dotted #ccc;">${line}</td></tr>`;
                }
            });
        }
        
        // ç²å–è¨ºç—‡æ—¥æœŸï¼ˆè™•ç† Firebase Timestampï¼‰
        let consultationDate;
        if (consultation.date && consultation.date.seconds) {
            consultationDate = new Date(consultation.date.seconds * 1000);
        } else if (consultation.date) {
            consultationDate = new Date(consultation.date);
        } else {
            consultationDate = new Date();
        }

        // å–å¾—æœè—¥å¤©æ•¸èˆ‡æ¯æ—¥æ¬¡æ•¸ï¼Œä¾›æ”¶æ“šé¡¯ç¤ºä½¿ç”¨
        // å„ªå…ˆä½¿ç”¨è¨ºç—‡ç´€éŒ„ä¸­çš„ medicationDays/medicationFrequencyï¼›ç•¶ç„¡å°æ‡‰å€¼æ™‚ï¼Œä»¥ç©ºå­—ä¸²ä»£è¡¨æœªå®šç¾©
        let medDays = '';
        let medFreq = '';
        if (consultation && consultation.medicationDays && Number(consultation.medicationDays) > 0) {
            medDays = consultation.medicationDays;
        }
        if (consultation && consultation.medicationFrequency && Number(consultation.medicationFrequency) > 0) {
            medFreq = consultation.medicationFrequency;
        }
        // çµ„åˆé¡¯ç¤ºå­—ä¸²ï¼šè‹¥å¤©æ•¸æˆ–æ¬¡æ•¸å­˜åœ¨ï¼Œåˆ†åˆ¥åŠ ä¸Šæ¨™ç±¤èˆ‡å–®ä½ï¼›è‹¥æœ‰æœç”¨æ–¹æ³•å‰‡é™„åŠ ã€‚
        let medInfoHtml = '';
        if (medDays) {
            medInfoHtml += '<strong>æœè—¥å¤©æ•¸ï¼š</strong>' + medDays + 'å¤©ã€€';
        }
        if (medFreq) {
            medInfoHtml += '<strong>æ¯æ—¥æ¬¡æ•¸ï¼š</strong>' + medFreq + 'æ¬¡ã€€';
        }
        if (consultation.usage) {
            medInfoHtml += '<strong>æœç”¨æ–¹æ³•ï¼š</strong>' + consultation.usage;
        }
        
        // å°‡è™•æ–¹å…§å®¹ã€é†«å›‘ã€è¤‡è¨ºæ—¥æœŸã€æœè—¥å¤©æ•¸ã€æ¯æ—¥æ¬¡æ•¸èˆ‡æœç”¨æ–¹æ³•ç§»è‡³æ–¹è—¥é†«å›‘åŠŸèƒ½
        // åœ¨æ”¶æ“šä¸­ä¸é¡¯ç¤ºé€™äº›è³‡æ–™ï¼Œå› æ­¤æš«æ™‚å°‡é€™äº›å±¬æ€§è¨­ç‚ºç©º
        const originalPrescription = consultation.prescription;
        const originalInstructions  = consultation.instructions;
        const originalFollowUpDate  = consultation.followUpDate;
        consultation.prescription = null;
        consultation.instructions = null;
        consultation.followUpDate = null;

        // Determine language preference and localise receipt fields
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        const isEnglish = lang && lang.startsWith('en');
        const htmlLang = isEnglish ? 'en' : 'zh-TW';
        const dateLocale = isEnglish ? 'en-US' : 'zh-TW';
        const colon = isEnglish ? ':' : 'ï¼š';
        // Rebuild medication information according to language
        let medInfoLocalized = '';
        if (medDays) {
            medInfoLocalized += '<strong>' + (isEnglish ? 'Medication Days' : 'æœè—¥å¤©æ•¸') + colon + '</strong>' + medDays + (isEnglish ? ' days ' : 'å¤©ã€€');
        }
        if (medFreq) {
            medInfoLocalized += '<strong>' + (isEnglish ? 'Daily Frequency' : 'æ¯æ—¥æ¬¡æ•¸') + colon + '</strong>' + medFreq + (isEnglish ? ' times ' : 'æ¬¡ã€€');
        }
        if (consultation.usage) {
            medInfoLocalized += '<strong>' + (isEnglish ? 'Administration Method' : 'æœç”¨æ–¹æ³•') + colon + '</strong>' + consultation.usage;
        }
        // If there is no Chinese medicine prescription, clear medication info
        if (!originalPrescription || (typeof originalPrescription === 'string' && originalPrescription.trim() === '')) {
            medInfoHtml = '';
            medInfoLocalized = '';
        }
        // Translation dictionary for receipt labels
        const TR = {
            title: isEnglish ? 'Receipt' : 'æ”¶ã€€æ“š',
            receiptNo: isEnglish ? 'Receipt No' : 'æ”¶æ“šç·¨è™Ÿ',
            patientName: isEnglish ? 'Patient Name' : 'ç—…äººå§“å',
            medicalRecordNo: isEnglish ? 'Medical Record No' : 'ç—…æ­·ç·¨è™Ÿ',
            patientNumber: isEnglish ? 'Patient ID' : 'ç—…äººè™Ÿç¢¼',
            consultationDate: isEnglish ? 'Date' : 'è¨ºç™‚æ—¥æœŸ',
            consultationTime: isEnglish ? 'Time' : 'è¨ºç™‚æ™‚é–“',
            doctorName: isEnglish ? 'Attending Physician' : 'ä¸»æ²»é†«å¸«',
            registrationNo: isEnglish ? 'Registration No' : 'è¨»å†Šç·¨è™Ÿ',
            diagnosis: isEnglish ? 'Diagnosis' : 'è¨ºæ–·',
            syndrome: isEnglish ? 'Pattern' : 'è­‰åž‹',
            billingDetails: isEnglish ? 'Billing Details' : 'æ”¶è²»æ˜Žç´°',
            amountDue: isEnglish ? 'Amount Due' : 'æ‡‰æ”¶é‡‘é¡',
            prescription: isEnglish ? 'Prescription' : 'è™•æ–¹å…§å®¹',
            instructions: isEnglish ? 'âš ï¸ Instructions & Precautions' : 'âš ï¸ é†«å›‘åŠæ³¨æ„äº‹é …',
            followUp: isEnglish ? 'ðŸ“… Suggested Follow-up Time' : 'ðŸ“… å»ºè­°è¤‡è¨ºæ™‚é–“',
            thankYou: isEnglish ? 'Thank you for your visit. Stay healthy!' : 'è¬è¬æ‚¨çš„å…‰è‡¨ï¼Œç¥æ‚¨èº«é«”å¥åº·ï¼',
            issuedTime: isEnglish ? 'Receipt Issued At' : 'æ”¶æ“šé–‹ç«‹æ™‚é–“',
            clinicHours: isEnglish ? 'Clinic Hours' : 'è¨ºæ‰€ç‡Ÿæ¥­æ™‚é–“',
            keepReceipt: isEnglish ? 'Please keep this receipt properly' : 'æœ¬æ”¶æ“šè«‹å¦¥å–„ä¿å­˜',
            contactCounter: isEnglish ? 'If you have any questions, please contact the counter' : 'å¦‚æœ‰ç–‘å•è«‹æ´½æ«ƒæª¯'
        };
        // Construct receipt HTML with localized labels
        const printContent = `
            <!DOCTYPE html>
            <html lang="${htmlLang}">
            <head>
                <meta charset="UTF-8">
                <title>${TR.title} - ${patient.name}</title>
                <style>
                    body { 
                        font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
                        margin: 0; 
                        padding: 10px; 
                        line-height: 1.3;
                        font-size: 11px;
                    }
                    .receipt-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 2px solid #000;
                        padding: 8px;
                        background: white;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px double #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 2px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 3px;
                    }
                    .receipt-title {
                        font-size: 14px;
                        font-weight: bold;
                        text-align: center;
                        margin: 6px 0;
                        letter-spacing: 2px;
                    }
                    .receipt-info {
                        margin-bottom: 10px;
                    }
                    .info-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 3px;
                        font-size: 11px;
                    }
                    .info-label {
                        font-weight: bold;
                    }
                    .items-section {
                        border-top: 1px solid #000;
                        border-bottom: 1px solid #000;
                        padding: 6px 0;
                        margin: 8px 0;
                    }
                    .items-title {
                        font-weight: bold;
                        text-align: center;
                        margin-bottom: 6px;
                        font-size: 12px;
                    }
                    .items-table {
                        width: 100%;
                        font-size: 10px;
                    }
                    .items-table td {
                        padding: 3px 5px;
                        border-bottom: 1px dotted #999;
                    }
                    .total-section {
                        text-align: right;
                        margin: 4px 0;
                        font-size: 10px;
                        font-weight: bold;
                    }
                    .total-amount {
                        font-size: 10px;
                        color: #000;
                        border: 1px solid #000;
                        padding: 2px;
                        display: inline-block;
                        min-width: 50px;
                        text-align: center;
                    }
                    .prescription-section {
                        margin: 8px 0;
                        border-top: 1px dashed #666;
                        padding-top: 6px;
                    }
                    .prescription-title {
                        font-weight: bold;
                        margin-bottom: 4px;
                        font-size: 11px;
                    }
                    .prescription-content {
                        background: #f9f9f9;
                        padding: 4px;
                        border: 1px solid #ddd;
                        font-size: 10px;
                        line-height: 1.2;
                    }
                    .footer-info {
                        margin-top: 10px;
                        border-top: 1px dashed #666;
                        padding-top: 6px;
                        font-size: 9px;
                        color: #666;
                    }
                    .footer-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 2px;
                    }
                    .thank-you {
                        text-align: center;
                        margin: 8px 0;
                        font-weight: bold;
                        font-size: 11px;
                    }
                    .diagnosis-section {
                        margin: 6px 0;
                        font-size: 10px;
                    }
                    .diagnosis-title {
                        font-weight: bold;
                        margin-bottom: 0;
                        margin-right: 4px;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body { 
                            margin: 0; 
                            padding: 0; 
                            font-size: 11px;
                        }
                        .receipt-container { 
                            border: 2px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="receipt-container">
                    <!-- Clinic Header -->
                    <div class="clinic-header">
                        <div class="clinic-name">${clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±'}</div>
                        <div class="clinic-subtitle">${clinicSettings.englishName || 'Dr.Great Clinic'}</div>
                        <div class="clinic-subtitle">${isEnglish ? 'Tel:' : 'é›»è©±ï¼š'}${clinicSettings.phone || '(852) 2345-6789'}ã€€${isEnglish ? 'Address:' : 'åœ°å€ï¼š'}${clinicSettings.address || 'é¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­123è™Ÿ'}</div>
                    </div>
                    
                    <!-- Receipt Title -->
                    <div class="receipt-title">${TR.title}</div>
                    
                    <!-- Basic Information -->
                    <div class="receipt-info">
                        <div class="info-row">
                            <span class="info-label">${TR.receiptNo}${colon}</span>
                            <span>R${consultation.id.toString().padStart(6, '0')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${TR.patientName}${colon}</span>
                            <span>${patient.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${TR.medicalRecordNo}${colon}</span>
                            <span>${consultation.medicalRecordNumber || consultation.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${TR.patientNumber}${colon}</span>
                            <span>${patient.patientNumber}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${TR.consultationDate}${colon}</span>
                            <span>${consultationDate.toLocaleDateString(dateLocale, {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            })}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${TR.consultationTime}${colon}</span>
                            <span>${consultationDate.toLocaleTimeString(dateLocale, {
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">${TR.doctorName}${colon}</span>
                            <span>${getDoctorDisplayName(consultation.doctor)}</span>
                        </div>
                        ${(() => {
                            const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                            return regNumber ? `
                                <div class="info-row">
                                    <span class="info-label">${TR.registrationNo}${colon}</span>
                                    <span>${regNumber}</span>
                                </div>
                            ` : '';
                        })()}
                    </div>
                    
                    <!-- Diagnosis Info -->
                    ${consultation.diagnosis ? `
                    <div class="diagnosis-section">
                        <div>
                            <span class="diagnosis-title">${TR.diagnosis}${colon}</span>
                            <span>${consultation.diagnosis}</span>
                        </div>
                        ${consultation.syndrome ? `
                        <div>
                            <span class="diagnosis-title">${TR.syndrome}${colon}</span>
                            <span>${consultation.syndrome}</span>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Billing Items -->
                    ${consultation.billingItems ? `
                    <div class="items-section">
                        <div class="items-title">${TR.billingDetails}</div>
                        <table class="items-table">
                            ${billingItemsHtml}
                        </table>
                    </div>
                    ` : ''}
                    
                    <!-- Total Amount -->
                    <div class="total-section">
                        <div style="margin-bottom: 4px; font-size: 9px;">${TR.amountDue}${colon}</div>
                        <div class="total-amount">HK$ ${totalAmount.toLocaleString()}</div>
                    </div>
                    
                    <!-- Prescription Section -->
                    ${consultation.prescription ? `
                    <div class="prescription-section">
                        <div class="prescription-title">ðŸ“‹ ${TR.prescription}</div>
                        <div class="prescription-content">${(() => {
                                const lines = consultation.prescription.split('\n').filter(line => line.trim());
                                // è§£æžçµæ§‹åŒ–è™•æ–¹è³‡æ–™ï¼Œå»ºç«‹åç¨±æ˜ å°„ï¼Œç”¨æ–¼æŸ¥æ‰¾æ–¹åŠ‘çµ„æˆ
                                const structuredMap = {};
                                if (consultation.prescriptionStructured) {
                                    try {
                                        const _arr = JSON.parse(consultation.prescriptionStructured);
                                        if (Array.isArray(_arr)) {
                                            _arr.forEach((itm) => {
                                                if (itm && itm.name) {
                                                    structuredMap[itm.name] = itm;
                                                }
                                            });
                                        }
                                    } catch (_e) {
                                        /* å¿½ç•¥è§£æžéŒ¯èª¤ */
                                    }
                                }
                                const allItems = [];
                            let i = 0;
                            while (i < lines.length) {
                                const line = lines[i].trim();
                                if (!line) {
                                    i++;
                                    continue;
                                }
                                const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                                if (itemMatch) {
                                    const itemName = itemMatch[1].trim();
                                    const dosage = itemMatch[2];
                                    const isFormula = ['æ¹¯','æ•£','ä¸¸','è†','é£²','ä¸¹','ç…Ž','æ–¹','åŠ‘'].some(suffix => itemName.includes(suffix));
                                    if (isFormula) {
                                        // å˜—è©¦å¾žçµæ§‹åŒ–è³‡æ–™å–å¾—æ–¹åŠ‘çµ„æˆ
                                        let compositionText = '';
                                        try {
                                            const structuredItem = structuredMap[itemName];
                                            if (structuredItem && structuredItem.composition) {
                                                compositionText = String(structuredItem.composition);
                                            }
                                        } catch (_e) {
                                            /* å¿½ç•¥éŒ¯èª¤ */
                                        }
                                        // å¦‚æžœçµæ§‹åŒ–è³‡æ–™ç„¡çµ„æˆï¼Œå†å¾ž herbLibrary å–å¾—
                                        if (!compositionText) {
                                            try {
                                                if (Array.isArray(herbLibrary)) {
                                                    const fullItem = herbLibrary.find(h => h && h.name === itemName && h.type === 'formula');
                                                    if (fullItem && fullItem.composition) {
                                                        compositionText = String(fullItem.composition);
                                                    }
                                                }
                                            } catch (_e) {
                                                /* å¿½ç•¥éŒ¯èª¤ */
                                            }
                                        }
                                        // è‹¥ä»æœªå–å¾—çµ„æˆï¼Œæª¢æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦ç‚ºçµ„æˆ
                                        if (!compositionText) {
                                            if (i + 1 < lines.length) {
                                                const nextLine = lines[i + 1].trim();
                                                if (nextLine && !nextLine.match(/^.+?\s+\d+(?:\.\d+)?g$/)) {
                                                    compositionText = nextLine;
                                                    i++;
                                                }
                                            }
                                        }
                                        // å°çµ„æˆåšå¾Œè™•ç†ï¼šåƒ…ä¿ç•™è—¥æåç¨±
                                        let processedComposition = '';
                                        if (compositionText) {
                                            try {
                                                const parts = String(compositionText)
                                                    .replace(/\r/g, '')
                                                    .split(/[ã€\n]/)
                                                    .map(p => p
                                                        .replace(/\d+(?:\.\d+)?\s*(?:g|å…‹|éŒ¢|å…©|ä¸¸|åŒ…)?/gi, '')
                                                        .replace(/[()ï¼ˆï¼‰\[\]]/g, '')
                                                        .trim()
                                                    )
                                                    .filter(p => p);
                                                processedComposition = parts.join('ã€');
                                            } catch (_err) {
                                                processedComposition = String(compositionText).replace(/\n/g, 'ã€');
                                            }
                                        }
                                        // å°‡æ‹¬è™ŸåŠå…¶å…§å®¹ç¸®å°è‡³ä¸‰åˆ†ä¹‹ä¸€å¤§å°
                                        const compWrap = processedComposition ? `<span style="font-size: 0.33em;">ï¼ˆ${processedComposition}ï¼‰</span>` : '';
                                        allItems.push(`${itemName} ${dosage}g${compWrap}`);
                                    } else {
                                        allItems.push(`${itemName}${dosage}g`);
                                    }
                                } else {
                                    allItems.push(`<div style="margin: 2px 0; font-size: 9px; color: #666;">${line}</div>`);
                                }
                                i++;
                            }
                            const regularItems = allItems.filter(item => typeof item === 'string' && !item.includes('<div'));
                            const specialLines = allItems.filter(item => typeof item === 'string' && item.includes('<div'));
                            let result = '';
                            // å…ˆåŠ å…¥å…¶ä»–èªªæ˜Žè¡Œ
                            specialLines.forEach(line => {
                                result += line;
                            });
                            if (regularItems.length > 0) {
                                // èª¿æ•´é †åºï¼šæ–¹åŠ‘åœ¨å‰ã€è—¥æå…¶å¾Œ
                                const formulasArr = [];
                                const herbsArr = [];
                                regularItems.forEach(it => {
                                    try {
                                        const hasDose = /\d+(?:\.\d+)?g/.test(it);
                                        const isFormulaItem = /[æ¹¯æ•£ä¸¸è†é£²ä¸¹ç…Žæ–¹åŠ‘]/.test(it);
                                        if (hasDose && isFormulaItem) {
                                            formulasArr.push(it);
                                        } else {
                                            herbsArr.push(it);
                                        }
                                    } catch (_err) {
                                        herbsArr.push(it);
                                    }
                                });
                                const joined = formulasArr.concat(herbsArr).join('ã€');
                                result += `<div style="margin: 2px 0;">${joined}</div>`;
                            }
                            return result || consultation.prescription.replace(/\n/g, '<br>');
                        })()}</div>
                        ${medInfoLocalized ? `
                        <div style="margin-top: 8px; font-size: 12px;">${medInfoLocalized}</div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Instructions -->
                    ${consultation.instructions ? `
                    <div style="margin: 6px 0; font-size: 10px; background: #fff3cd; padding: 6px; border: 1px solid #ffeaa7;">
                        <strong>${TR.instructions}${colon}</strong><br>
                        ${consultation.instructions}
                    </div>
                    ` : ''}
                    
                    <!-- Follow-up Reminder -->
                    ${consultation.followUpDate ? `
                    <div style="margin: 10px 0; font-size: 12px; background: #e3f2fd; padding: 8px; border: 1px solid #90caf9;">
                        <strong>${TR.followUp}${colon}</strong><br>
                        ${new Date(consultation.followUpDate).toLocaleString(dateLocale)}
                    </div>
                    ` : ''}
                    
                    <!-- Thank You -->
                    <div class="thank-you">
                        ${TR.thankYou}
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer-info">
                        <div class="footer-row">
                            <span>${TR.issuedTime}${colon}</span>
                            <span>${new Date().toLocaleString(dateLocale)}</span>
                        </div>
                        <div class="footer-row">
                            <span>${TR.clinicHours}${colon}</span>
                            <span>${clinicSettings.businessHours || 'é€±ä¸€è‡³é€±äº” 09:00-18:00'}</span>
                        </div>
                        <div class="footer-row">
                            <span>${TR.keepReceipt}</span>
                            <span>${TR.contactCounter}</span>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;
        // Open a new window and print
        const printWindow = window.open('', '_blank', 'width=500,height=700');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();

        // Restore original prescription, instructions and follow-up date after printing
        consultation.prescription = originalPrescription;
        consultation.instructions = originalInstructions;
        consultation.followUpDate = originalFollowUpDate;

        showToast(isEnglish ? 'Receipt is ready for printing!' : 'ä¸­é†«è¨ºæ‰€æ”¶æ“šå·²æº–å‚™åˆ—å°ï¼', 'success');
        
    } catch (error) {
        console.error('åˆ—å°æ”¶æ“šéŒ¯èª¤:', error);
        showToast('åˆ—å°æ”¶æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
// 5. ä¿®æ”¹åˆ—å°åˆ°è¨ºè­‰æ˜Žå‡½æ•¸
async function printAttendanceCertificate(consultationId, consultationData = null) {
    let consultation = consultationData;
    // å°‡å‚³å…¥çš„ ID è½‰ç‚ºå­—ä¸²ä»¥ä¾¿æ¯”è¼ƒï¼ˆå…¼å®¹æ•¸å­—èˆ‡å­—ä¸²ï¼‰
    const idToFind = String(consultationId);
    
    // å¦‚æžœæ²’æœ‰æä¾›è¨ºç—‡è³‡æ–™ï¼Œå¾ž Firebase ç²å–
    if (!consultation) {
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (!consultationResult.success) {
                showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            consultation = consultationResult.data.find(c => String(c.id) === idToFind);
            if (!consultation) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
            showToast('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—', 'error');
            return;
        }
    }
    
    try {
        // å¾ž Firebase ç²å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const patientResult = await safeGetPatients(true);
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // ç²å–è¨ºç—‡æ—¥æœŸï¼ˆè™•ç† Firebase Timestampï¼‰
        let consultationDate;
        if (consultation.date && consultation.date.seconds) {
            consultationDate = new Date(consultation.date.seconds * 1000);
        } else if (consultation.date) {
            consultationDate = new Date(consultation.date);
        } else {
            consultationDate = new Date();
        }
        
        // Determine language preference and build localized arrival certificate
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        const isEnglish = lang && lang.startsWith('en');
        const htmlLang = isEnglish ? 'en' : 'zh-TW';
        const dateLocale = isEnglish ? 'en-US' : 'zh-TW';
        const colon = isEnglish ? ':' : 'ï¼š';
        // Compute gender display
        let genderDisplay = patient.gender;
        if (isEnglish) {
            if (genderDisplay === 'ç”·') genderDisplay = 'Male';
            else if (genderDisplay === 'å¥³') genderDisplay = 'Female';
        }
        // Compute age display
        const rawAge = formatAge(patient.birthDate);
        let ageDisplay = rawAge;
        if (isEnglish) {
            ageDisplay = rawAge.replace(/æ­²$/, ' years').replace(/å€‹æœˆ$/, ' months').replace(/å¤©$/, ' days');
        }
        // ID card display
        const idDisplay = patient.idCard || (isEnglish ? 'Not provided' : 'æœªæä¾›');
        // Determine visit date/time
        const visitDate = consultation.visitTime ? new Date(consultation.visitTime) : consultationDate;
        // Translation dictionary for certificate fields
        const TC = {
            certificateTitle: isEnglish ? 'Arrival Certificate' : 'åˆ°è¨ºè­‰æ˜Žæ›¸',
            certificateNo: isEnglish ? 'Certificate No' : 'è­‰æ˜Žæ›¸ç·¨è™Ÿ',
            name: isEnglish ? 'Name' : 'å§“ã€€ã€€å',
            medicalRecordNo: isEnglish ? 'Medical Record No' : 'ç—…æ­·ç·¨è™Ÿ',
            gender: isEnglish ? 'Gender' : 'æ€§ã€€ã€€åˆ¥',
            age: isEnglish ? 'Age' : 'å¹´ã€€ã€€é½¡',
            idCard: isEnglish ? 'ID No' : 'èº«åˆ†è­‰è™Ÿ',
            attendanceInfo: isEnglish ? 'Arrival Information' : 'åˆ°è¨ºè³‡è¨Š',
            arrivalDate: isEnglish ? 'Arrival Date' : 'åˆ°è¨ºæ—¥æœŸ',
            arrivalTime: isEnglish ? 'Arrival Time' : 'åˆ°è¨ºæ™‚é–“',
            diagnosisResult: isEnglish ? 'Diagnosis Result' : 'è¨ºæ–·çµæžœ',
            confirmSentence: isEnglish ? 'It is hereby certified that the above patient was examined at the clinic on the specified date and time.' : 'èŒ²è­‰æ˜Žä¸Šè¿°ç—…äººç¢ºå¯¦æ–¼ä¸Šè¿°æ—¥æœŸæ™‚é–“åˆ°æœ¬è¨ºæ‰€æŽ¥å—ä¸­é†«è¨ºç™‚ã€‚',
            hereby: isEnglish ? 'Therefore, this certificate is issued.' : 'ç‰¹æ­¤è­‰æ˜Žã€‚',
            doctorSignature: isEnglish ? 'Physician Signature' : 'ä¸»æ²»é†«å¸«ç°½å',
            registrationNo: isEnglish ? 'Registration No' : 'è¨»å†Šç·¨è™Ÿ',
            issueDate: isEnglish ? 'Date of Issue' : 'é–‹ç«‹æ—¥æœŸ',
            clinicSeal: isEnglish ? 'Clinic Seal' : 'è¨ºæ‰€å°ç« ',
            sealNote: isEnglish ? '(Clinic stamp here)' : '(æ­¤è™•æ‡‰è“‹è¨ºæ‰€å°ç« )',
            footerNote1: isEnglish ? 'This certificate only certifies attendance. For inquiries, please contact the clinic.' : 'æœ¬è­‰æ˜Žæ›¸åƒ…è­‰æ˜Žåˆ°è¨ºäº‹å¯¦ï¼Œå¦‚æœ‰ç–‘å•è«‹æ´½æœ¬è¨ºæ‰€',
            footerTel: isEnglish ? 'Clinic Tel' : 'è¨ºæ‰€é›»è©±',
            footerHours: isEnglish ? 'Business Hours' : 'ç‡Ÿæ¥­æ™‚é–“',
            certificateIssuedAt: isEnglish ? 'Certificate Issued At' : 'è­‰æ˜Žæ›¸é–‹ç«‹æ™‚é–“',
            watermark: isEnglish ? 'Arrival Certificate' : 'åˆ°è¨ºè­‰æ˜Ž'
        };
        // Build certificate HTML
        const printContent = `
            <!DOCTYPE html>
            <html lang="${htmlLang}">
            <head>
                <meta charset="UTF-8">
                <title>${TC.certificateTitle} - ${patient.name}</title>
                <style>
                    body { 
                        font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
                        margin: 0; 
                        padding: 8px; 
                        line-height: 1.3;
                        font-size: 10px;
                        background: white;
                    }
                    .certificate-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 3px solid #000;
                        padding: 8px;
                        background: white;
                        position: relative;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 13px;
                        font-weight: bold;
                        margin-bottom: 3px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 4px;
                    }
                    .certificate-title {
                        font-size: 16px;
                        font-weight: bold;
                        text-align: center;
                        margin: 8px 0;
                        letter-spacing: 3px;
                        color: #000;
                    }
                    .certificate-number {
                        text-align: right;
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 10px;
                    }
                    .content-section {
                        margin: 8px 0;
                        font-size: 10px;
                        line-height: 1.4;
                    }
                    .patient-info {
                        margin: 8px 0;
                    }
                    .info-row {
                        margin: 4px 0;
                        display: flex;
                        align-items: center;
                    }
                    .info-label {
                        font-weight: bold;
                        min-width: 80px;
                        display: inline-block;
                        font-size: 10px;
                    }
                    .info-value {
                        border-bottom: 1px solid #000;
                        min-width: 120px;
                        padding: 3px 6px;
                        margin-left: 6px;
                        font-size: 10px;
                    }
                    .attendance-section {
                        margin: 8px 0;
                        background: #e3f2fd;
                        padding: 6px;
                        border: 2px solid #2196f3;
                        border-radius: 4px;
                        text-align: center;
                    }
                    .attendance-title {
                        font-size: 11px;
                        font-weight: bold;
                        color: #1976d2;
                        margin-bottom: 4px;
                    }
                    .attendance-details {
                        font-size: 10px;
                        line-height: 1.3;
                    }
                    .doctor-signature {
                        margin-top: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-end;
                    }
                    .signature-section {
                        text-align: center;
                    }
                    .signature-line {
                        border-bottom: 2px solid #000;
                        width: 60px;
                        height: 25px;
                        margin: 6px auto;
                        position: relative;
                    }
                    .signature-label {
                        font-size: 9px;
                        color: #666;
                        margin-top: 3px;
                    }
                    .date-section {
                        text-align: right;
                        font-size: 10px;
                    }
                    .footer-note {
                        margin-top: 15px;
                        padding-top: 8px;
                        border-top: 1px dashed #666;
                        font-size: 8px;
                        color: #666;
                        text-align: center;
                    }
                    .watermark {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        font-size: 80px;
                        color: rgba(0, 0, 0, 0.05);
                        font-weight: bold;
                        z-index: 0;
                        pointer-events: none;
                    }
                    .content {
                        position: relative;
                        z-index: 1;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body { 
                            margin: 0; 
                            padding: 0; 
                            font-size: 11px;
                        }
                        .certificate-container { 
                            border: 3px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="certificate-container">
                    <!-- Watermark -->
                    <div class="watermark">${TC.watermark}</div>
                    
                    <div class="content">
                        <!-- Clinic Header -->
                        <div class="clinic-header">
                            <div class="clinic-name">${clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±'}</div>
                            <div class="clinic-subtitle">${clinicSettings.englishName || 'Dr.Great Clinic'}</div>
                            <div class="clinic-subtitle">${isEnglish ? 'Tel:' : 'é›»è©±ï¼š'}${clinicSettings.phone || '(852) 2345-6789'}ã€€${isEnglish ? 'Address:' : 'åœ°å€ï¼š'}${clinicSettings.address || 'é¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­123è™Ÿ'}</div>
                        </div>
                        
                        <!-- Certificate Number -->
                        <div class="certificate-number">
                            ${TC.certificateNo}${colon} AC${consultation.id.toString().padStart(6, '0')}
                        </div>
                        
                        <!-- Certificate Title -->
                        <div class="certificate-title">${TC.certificateTitle}</div>
                        
                        <!-- Patient Info -->
                        <div class="patient-info">
                            <div class="info-row">
                                <span class="info-label">${TC.name}${colon}</span>
                                <span class="info-value">${patient.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">${TC.medicalRecordNo}${colon}</span>
                                <span class="info-value">${consultation.medicalRecordNumber || consultation.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">${TC.gender}${colon}</span>
                                <span class="info-value">${genderDisplay}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">${TC.age}${colon}</span>
                                <span class="info-value">${ageDisplay}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">${TC.idCard}${colon}</span>
                                <span class="info-value">${idDisplay}</span>
                            </div>
                        </div>
                        
                        <!-- Attendance Info -->
                        <div class="attendance-section">
                            <div class="attendance-title">${TC.attendanceInfo}</div>
                            <div class="attendance-details">
                                <div><strong>${TC.arrivalDate}${colon}</strong>${visitDate.toLocaleDateString(dateLocale, { year: 'numeric', month: '2-digit', day: '2-digit' })}</div>
                                <div><strong>${TC.arrivalTime}${colon}</strong>${visitDate.toLocaleTimeString(dateLocale, { hour: '2-digit', minute: '2-digit' })}</div>
                            </div>
                        </div>
                        
                        <!-- Diagnosis Info -->
                        ${consultation.diagnosis ? `
                        <div class="content-section">
                            <div style="margin-bottom: 15px;">
                                <strong>${TC.diagnosisResult}${colon}</strong>${consultation.diagnosis}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="content-section">
                            <strong>${TC.confirmSentence}</strong>
                        </div>
                        
                        <div class="content-section">
                            <strong>${TC.hereby}</strong>
                        </div>
                        
                        <!-- Doctor Signature -->
                        <div class="doctor-signature">
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="signature-label">${TC.doctorSignature}</div>
                                <div style="margin-top: 10px; font-weight: bold;">
                                    ${getDoctorDisplayName(consultation.doctor)}
                                </div>
                                ${(() => {
                                    const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                    return regNumber ? `
                                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                            ${TC.registrationNo}${colon}${regNumber}
                                        </div>
                                    ` : '';
                                })()}
                            </div>
                            
                            <div class="date-section">
                                <div style="margin-bottom: 20px;">
                                    <strong>${TC.issueDate}${colon}</strong><br>
                                    ${new Date().toLocaleDateString(dateLocale, {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit'
                                    })}
                                </div>
                                <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${TC.clinicSeal}</div>
                                    <div style="font-size: 12px; color: #666;">${TC.sealNote}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer Note -->
                        <div class="footer-note">
                            <div>${TC.footerNote1}</div>
                            <div>${TC.footerTel}${colon}${clinicSettings.phone || '(852) 2345-6789'} | ${TC.footerHours}${colon}${clinicSettings.businessHours || 'é€±ä¸€è‡³é€±äº” 09:00-18:00'}</div>
                            <div style="margin-top: 10px; font-size: 10px;">
                                ${TC.certificateIssuedAt}${colon}${new Date().toLocaleString(dateLocale)}
                            </div>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        `;
        // Open a new window and print
        const printWindow = window.open('', '_blank', 'width=700,height=900');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        
        showToast(isEnglish ? 'Arrival certificate is ready for printing!' : 'åˆ°è¨ºè­‰æ˜Žæ›¸å·²æº–å‚™åˆ—å°ï¼', 'success');
        
    } catch (error) {
        console.error('åˆ—å°åˆ°è¨ºè­‰æ˜ŽéŒ¯èª¤:', error);
        showToast('åˆ—å°åˆ°è¨ºè­‰æ˜Žæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}
        
// ä¿®å¾©ç—…å‡è­‰æ˜Žå‡½æ•¸
async function printSickLeave(consultationId, consultationData = null) {
    let consultation = consultationData;
    
    // å¦‚æžœæ²’æœ‰æä¾›è¨ºç—‡è³‡æ–™ï¼Œå¾žæœ¬åœ°æŸ¥æ‰¾
    if (!consultation) {
        consultation = consultations.find(c => c.id === consultationId);
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
    }
    
    try {            
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const patientResult = await safeGetPatients(true);
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }

        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        
        // å‹•æ…‹ç”Ÿæˆç—…å‡è­‰æ˜Žå…§å®¹ï¼Œæ ¹æ“šèªžè¨€åˆ‡æ›ä¸­è‹±æ–‡
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        const isEnglish = lang === 'en';
        const htmlLang = isEnglish ? 'en' : 'zh-TW';
        const dateLocale = isEnglish ? 'en-US' : 'zh-TW';
        const colon = isEnglish ? ': ' : 'ï¼š';
        // æ€§åˆ¥ç¿»è­¯
        const genderVal = patient.gender || '';
        let genderDisplay;
        if (isEnglish) {
            if (genderVal === 'ç”·' || genderVal === 'male' || genderVal === 'Male') {
                genderDisplay = 'Male';
            } else if (genderVal === 'å¥³' || genderVal === 'female' || genderVal === 'Female') {
                genderDisplay = 'Female';
            } else {
                genderDisplay = genderVal;
            }
        } else {
            genderDisplay = genderVal;
        }
        // å¹´é½¡ç¿»è­¯
        let ageDisplay = formatAge(patient.birthDate);
        if (isEnglish && ageDisplay) {
            ageDisplay = ageDisplay.replace('æ­²', '').trim();
            if (ageDisplay) ageDisplay += ' years';
        }
        // èº«åˆ†è­‰è™Ÿé¡¯ç¤º
        const idNumberDisplay = patient.idCard || (isEnglish ? 'Not provided' : 'æœªæä¾›');
        // è¨ºç™‚æ—¥æœŸ
        const visitDate = consultation.visitTime ? parseConsultationDate(consultation.visitTime) : parseConsultationDate(consultation.date);
        const visitDateStr = visitDate && !isNaN(visitDate.getTime()) ? visitDate.toLocaleDateString(dateLocale, { year: 'numeric', month: '2-digit', day: '2-digit' }) : (isEnglish ? 'Unknown' : 'æœªçŸ¥æ—¥æœŸ');
        // è¨ºæ–·çµæžœ
        const diagnosisResult = consultation.diagnosis || (isEnglish ? 'Rest and recuperation recommended' : 'éœ€è¦ä¼‘æ¯èª¿é¤Š');
        // è¨ˆç®—å»ºè­°ä¼‘æ¯æœŸé–“çš„é¡¯ç¤ºæ–‡å­—
        const computeRestPeriod = () => {
            // å„ªå…ˆä½¿ç”¨è¨ºç—‡è¨˜éŒ„ä¸­çš„ä¼‘æ¯æœŸé–“è¨­å®š
            if (consultation.restStartDate && consultation.restEndDate) {
                const startDate = parseConsultationDate(consultation.restStartDate);
                const endDate = parseConsultationDate(consultation.restEndDate);
                if (!startDate || isNaN(startDate.getTime()) || !endDate || isNaN(endDate.getTime())) {
                    return isEnglish ? 'Unknown' : 'æœªçŸ¥æ—¥æœŸ';
                }
                const timeDiff = endDate.getTime() - startDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
                return startDate.toLocaleDateString(dateLocale) + (isEnglish ? ' to ' : ' è‡³ ') + endDate.toLocaleDateString(dateLocale) + (isEnglish ? ' (Total ' + daysDiff + ' days)' : ' (å…± ' + daysDiff + ' å¤©)');
            }
            // å¦å‰‡ä½¿ç”¨èˆŠé‚è¼¯ä¼°ç®—
            let restDays = consultation.restDays ? parseInt(consultation.restDays) : 1;
            if (!consultation.restDays) {
                const treatmentCourse = consultation.treatmentCourse || (isEnglish ? '1 week' : 'ä¸€å‘¨');
                if (treatmentCourse.includes('å¤©')) {
                    const match = treatmentCourse.match(/(\d+)å¤©/);
                    if (match) {
                        restDays = Math.min(parseInt(match[1]), 7);
                    }
                } else if (treatmentCourse.includes('é€±') || treatmentCourse.includes('å‘¨') || treatmentCourse.toLowerCase().includes('week')) {
                    const match = treatmentCourse.match(/(\d+)[é€±å‘¨]/) || treatmentCourse.match(/(\d+)\s*week/);
                    if (match) {
                        restDays = Math.min(parseInt(match[1]) * 7, 7);
                    }
                }
            }
            const startDate = consultation.visitTime ? parseConsultationDate(consultation.visitTime) : parseConsultationDate(consultation.date);
            if (!startDate || isNaN(startDate.getTime())) {
                return isEnglish ? 'Unknown' : 'æœªçŸ¥æ—¥æœŸ';
            }
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + restDays - 1);
            return startDate.toLocaleDateString(dateLocale) + (isEnglish ? ' to ' : ' è‡³ ') + endDate.toLocaleDateString(dateLocale) + (isEnglish ? ' (Total ' + restDays + ' days)' : ' (å…± ' + restDays + ' å¤©)');
        };
        const restPeriodStr = computeRestPeriod();
        // åŒ»å¸ˆå»ºè®®å†…å®¹
        const instructionsHtml = consultation.instructions ? consultation.instructions.replace(/\n/g, '<br>') : '';
        // ç¿»è­¯å­—å…¸
        const SL = {
            title: isEnglish ? 'Sick Leave Certificate' : 'ç—…å‡è­‰æ˜Žæ›¸',
            certificateNumber: isEnglish ? 'Certificate No.' : 'è­‰æ˜Žæ›¸ç·¨è™Ÿ',
            name: isEnglish ? 'Name' : 'å§“ã€€ã€€å',
            medicalRecordNo: isEnglish ? 'Medical Record No.' : 'ç—…æ­·ç·¨è™Ÿ',
            genderLabel: isEnglish ? 'Gender' : 'æ€§ã€€ã€€åˆ¥',
            ageLabel: isEnglish ? 'Age' : 'å¹´ã€€ã€€é½¡',
            idNumber: isEnglish ? 'ID No.' : 'èº«åˆ†è­‰è™Ÿ',
            consultationDate: isEnglish ? 'Consultation Date' : 'è¨ºç™‚æ—¥æœŸ',
            diagnosisResult: isEnglish ? 'Diagnosis Result' : 'è¨ºæ–·çµæžœ',
            restPeriod: isEnglish ? 'Recommended Rest Period' : 'å»ºè­°ä¼‘æ¯æœŸé–“',
            doctorAdvice: isEnglish ? "Doctor's advice" : 'é†«å¸«å»ºè­°',
            certify: isEnglish ? 'Hereby certified.' : 'ç‰¹æ­¤è­‰æ˜Žã€‚',
            signature: isEnglish ? 'Physician Signature' : 'ä¸»æ²»é†«å¸«ç°½å',
            registrationNo: isEnglish ? 'Registration No.' : 'è¨»å†Šç·¨è™Ÿ',
            issueDate: isEnglish ? 'Date of Issue' : 'é–‹ç«‹æ—¥æœŸ',
            clinicSeal: isEnglish ? 'Clinic Seal' : 'è¨ºæ‰€å°ç« ',
            sealNote: isEnglish ? '(Clinic stamp here)' : '(æ­¤è™•æ‡‰è“‹è¨ºæ‰€å°ç« )',
            footerNote: isEnglish ? 'This certificate is for sick leave purposes only. If you have any questions, please contact the clinic.' : 'æœ¬è­‰æ˜Žæ›¸åƒ…ä¾›è«‹å‡ä½¿ç”¨ï¼Œå¦‚æœ‰ç–‘å•è«‹æ´½æœ¬è¨ºæ‰€',
            footerTel: isEnglish ? 'Clinic Tel.' : 'è¨ºæ‰€é›»è©±',
            footerHours: isEnglish ? 'Business Hours' : 'ç‡Ÿæ¥­æ™‚é–“',
            issuedAt: isEnglish ? 'Certificate Issued At' : 'è­‰æ˜Žæ›¸é–‹ç«‹æ™‚é–“',
            watermark: isEnglish ? 'Sick Leave' : 'ç—…å‡è­‰æ˜Ž'
        };
        // æ§‹å»º HTML å…§å®¹
        const printContent = `
            <!DOCTYPE html>
            <html lang="${htmlLang}">
            <head>
                <meta charset="UTF-8">
                <title>${SL.title} - ${patient.name}</title>
                <style>
                    body {
                        font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
                        margin: 0;
                        padding: 8px;
                        line-height: 1.3;
                        font-size: 10px;
                        background: white;
                    }
                    .certificate-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 3px solid #000;
                        padding: 8px;
                        background: white;
                        position: relative;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 13px;
                        font-weight: bold;
                        margin-bottom: 3px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 4px;
                    }
                    .certificate-title {
                        font-size: 16px;
                        font-weight: bold;
                        text-align: center;
                        margin: 8px 0;
                        letter-spacing: 3px;
                        color: #000;
                    }
                    .certificate-number {
                        text-align: right;
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 10px;
                    }
                    .content-section {
                        margin: 8px 0;
                        font-size: 10px;
                        line-height: 1.4;
                    }
                    .patient-info {
                        margin: 8px 0;
                    }
                    .info-row {
                        margin: 4px 0;
                        display: flex;
                        align-items: center;
                    }
                    .info-label {
                        font-weight: bold;
                        min-width: 80px;
                        display: inline-block;
                        font-size: 10px;
                    }
                    .info-value {
                        border-bottom: 1px solid #000;
                        min-width: 120px;
                        padding: 3px 6px;
                        margin-left: 6px;
                        font-size: 10px;
                    }
                    .diagnosis-section {
                        margin: 8px 0;
                        background: #f9f9f9;
                        padding: 6px;
                        border: 1px solid #ddd;
                        border-radius: 3px;
                    }
                    .rest-period {
                        margin: 8px 0;
                        font-size: 11px;
                        font-weight: bold;
                        text-align: center;
                        background: #fff3cd;
                        padding: 6px;
                        border: 2px solid #ffc107;
                        border-radius: 4px;
                    }
                    .doctor-signature {
                        margin-top: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-end;
                    }
                    .signature-section {
                        text-align: center;
                    }
                    .signature-line {
                        border-bottom: 2px solid #000;
                        width: 60px;
                        height: 25px;
                        margin: 6px auto;
                        position: relative;
                    }
                    .signature-label {
                        font-size: 9px;
                        color: #666;
                        margin-top: 3px;
                    }
                    .date-section {
                        text-align: right;
                        font-size: 10px;
                    }
                    .footer-note {
                        margin-top: 15px;
                        padding-top: 8px;
                        border-top: 1px dashed #666;
                        font-size: 8px;
                        color: #666;
                        text-align: center;
                    }
                    .watermark {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        font-size: 80px;
                        color: rgba(0, 0, 0, 0.05);
                        font-weight: bold;
                        z-index: 0;
                        pointer-events: none;
                    }
                    .content {
                        position: relative;
                        z-index: 1;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-size: 11px;
                        }
                        .certificate-container {
                            border: 3px solid #000;
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="certificate-container">
                    <div class="watermark">${SL.watermark}</div>
                    <div class="content">
                        <div class="clinic-header">
                            <div class="clinic-name">${clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±'}</div>
                            <div class="clinic-subtitle">${clinicSettings.englishName || 'Dr.Great Clinic'}</div>
                            <div class="clinic-subtitle">${isEnglish ? 'Tel' : 'é›»è©±'}${colon}${clinicSettings.phone || '(852) 2345-6789'}ã€€${isEnglish ? 'Address' : 'åœ°å€'}${colon}${clinicSettings.address || 'é¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­123è™Ÿ'}</div>
                        </div>
                        <div class="certificate-number">${SL.certificateNumber}${colon}SL${consultation.id.toString().padStart(6, '0')}</div>
                        <div class="certificate-title">${SL.title}</div>
                        <div class="patient-info">
                            <div class="info-row"><span class="info-label">${SL.name}${colon}</span><span class="info-value">${patient.name}</span></div>
                            <div class="info-row"><span class="info-label">${SL.medicalRecordNo}${colon}</span><span class="info-value">${consultation.medicalRecordNumber || consultation.id}</span></div>
                            <div class="info-row"><span class="info-label">${SL.genderLabel}${colon}</span><span class="info-value">${genderDisplay}</span></div>
                            <div class="info-row"><span class="info-label">${SL.ageLabel}${colon}</span><span class="info-value">${ageDisplay}</span></div>
                            <div class="info-row"><span class="info-label">${SL.idNumber}${colon}</span><span class="info-value">${idNumberDisplay}</span></div>
                        </div>
                        <div class="diagnosis-section">
                            <div style="margin-bottom: 15px;"><strong>${SL.consultationDate}${colon}</strong>${visitDateStr}</div>
                            <div style="margin-bottom: 15px;"><strong>${SL.diagnosisResult}${colon}</strong>${diagnosisResult}</div>
                        </div>
                        <div class="rest-period">${SL.restPeriod}${colon}${restPeriodStr}</div>
                        ${instructionsHtml ? `<div class="content-section"><strong>${SL.doctorAdvice}${colon}</strong><br>${instructionsHtml}</div>` : ''}
                        <div class="content-section"><strong>${SL.certify}</strong></div>
                        <div class="doctor-signature">
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="signature-label">${SL.signature}</div>
                                <div style="margin-top: 10px; font-weight: bold;">${getDoctorDisplayName(consultation.doctor)}</div>
                                ${(() => {
                                    const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                                    return regNumber ? `<div style="margin-top: 5px; font-size: 12px; color: #666;">${SL.registrationNo}${colon}${regNumber}</div>` : '';
                                })()}
                            </div>
                            <div class="date-section">
                                <div style="margin-bottom: 20px;"><strong>${SL.issueDate}${colon}</strong><br>${new Date().toLocaleDateString(dateLocale, { year: 'numeric', month: '2-digit', day: '2-digit' })}</div>
                                <div style="border: 2px solid #000; padding: 15px; text-align: center; background: #f8f9fa;"><div style="font-weight: bold; margin-bottom: 5px;">${SL.clinicSeal}</div><div style="font-size: 12px; color: #666;">${SL.sealNote}</div></div>
                            </div>
                        </div>
                        <div class="footer-note">
                            <div>${SL.footerNote}</div>
                            <div>${SL.footerTel}${colon}${clinicSettings.phone || '(852) 2345-6789'} | ${SL.footerHours}${colon}${clinicSettings.businessHours || 'é€±ä¸€è‡³é€±äº” 09:00-18:00'}</div>
                            <div style="margin-top: 10px; font-size: 10px;">${SL.issuedAt}${colon}${new Date().toLocaleString(dateLocale)}</div>
                        </div>
                    </div>
                </div>
            </body>
            </html>`;
        // é–‹å•Ÿæ–°è¦–çª—ä¸¦åˆ—å°
        const printWindow = window.open('', '_blank', 'width=700,height=900');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        showToast(isEnglish ? 'Sick leave certificate is ready for printing!' : 'ç—…å‡è­‰æ˜Žæ›¸å·²æº–å‚™åˆ—å°ï¼', 'success');
        
    } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    }
}

// æ–°å¢žï¼šå¾žæŽ›è™Ÿè¨˜éŒ„åˆ—å°æ–¹è—¥é†«å›‘
async function printPrescriptionInstructionsFromAppointment(appointmentId) {
    const appointment = appointments.find(apt => apt && String(apt.id) === String(appointmentId));
    if (!appointment) {
        showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
        return;
    }
    // åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„æ–¹è—¥é†«å›‘
    if (appointment.status !== 'completed' || !appointment.consultationId) {
        showToast('åªèƒ½åˆ—å°å·²å®Œæˆè¨ºç—‡çš„è—¥å–®é†«å›‘ï¼', 'error');
        return;
    }
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ï¼Œå„ªå…ˆä½¿ç”¨äº‹ä»¶ç›®æ¨™ï¼Œå…¶æ¬¡é€éŽ DOM æŸ¥æ‰¾
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector('button[onclick="printPrescriptionInstructionsFromAppointment(' + appointmentId + ')"]');
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'åˆ—å°ä¸­...');
    }
    try {
        // å¾ž Firebase ç²å–è¨ºç—‡è¨˜éŒ„
        const consultationResult = await window.firebaseDataManager.getConsultations();
        if (!consultationResult.success) {
            showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // å…ˆå˜—è©¦åœ¨è¿”å›žåˆ—è¡¨ä¸­å°‹æ‰¾æŒ‡å®šçš„è¨ºç—‡è¨˜éŒ„ï¼Œä½¿ç”¨å­—ä¸²æ¯”å°
        let consultation = consultationResult.data.find(c => String(c.id) === String(appointment.consultationId));
        // æ›´æ–°å…¨åŸŸè¨ºç—‡å¿«å–
        consultations = consultationResult.data;
        // è‹¥æœªæ‰¾åˆ°ï¼Œç›´æŽ¥å¾ž Firestore æ ¹æ“š ID è®€å–
        if (!consultation) {
            try {
                const docRef = window.firebase.doc(window.firebase.db, 'consultations', String(appointment.consultationId));
                const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap && docSnap.exists()) {
                    consultation = { id: docSnap.id, ...docSnap.data() };
                    consultations.push(consultation);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            } catch (err) {
                console.error('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
            }
        }
        if (!consultation) {
            showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
            return;
        }
        // èª¿ç”¨æ–¹è—¥é†«å›‘åˆ—å°åŠŸèƒ½
        await printPrescriptionInstructions(consultation.id, consultation);
    } catch (error) {
        console.error('åˆ—å°è—¥å–®é†«å›‘éŒ¯èª¤:', error);
        showToast('åˆ—å°è—¥å–®é†«å›‘æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

/**
 * åˆ—å°æ–¹è—¥é†«å›‘æ”¶æ“šé é¢ã€‚
 * å…§å®¹åŒ…å«è™•æ–¹å…§å®¹ã€æœè—¥å¤©æ•¸ã€æ¯æ—¥æ¬¡æ•¸ã€æœç”¨æ–¹æ³•ã€é†«å›‘åŠæ³¨æ„äº‹é …ä»¥åŠå»ºè­°è¤‡è¨ºæ™‚é–“ã€‚
 * @param {number|string} consultationId è¨ºç—‡ ID
 * @param {object|null} consultationData å¯é¸ï¼Œè‹¥å·²æä¾›è¨ºç—‡è³‡æ–™å‰‡ç›´æŽ¥ä½¿ç”¨
 */
async function printPrescriptionInstructions(consultationId, consultationData = null) {
    let consultation = consultationData;
    const idToFind = String(consultationId);
    // è‹¥æœªæä¾›è¨ºç—‡è³‡æ–™ï¼Œå¾ž Firebase è®€å–
    if (!consultation) {
        try {
            const consultationResult = await window.firebaseDataManager.getConsultations();
            if (!consultationResult.success) {
                showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            consultation = consultationResult.data.find(c => String(c.id) === idToFind);
            if (!consultation) {
                showToast('æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
            showToast('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—', 'error');
            return;
        }
    }
    try {
        // è®€å–ç—…äººè³‡æ–™
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const patientResult = await safeGetPatients(true);
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        const patient = patientResult.data.find(p => p.id === consultation.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        // è§£æžè¨ºç™‚æ—¥æœŸ
        let consultationDate;
        if (consultation.date && consultation.date.seconds) {
            consultationDate = new Date(consultation.date.seconds * 1000);
        } else if (consultation.date) {
            consultationDate = new Date(consultation.date);
        } else {
            consultationDate = new Date();
        }
        // çµ„åˆè™•æ–¹å…§å®¹ - å°‡è™•æ–¹é …ç›®åˆ†ç‚ºä¸‰æ¬„é¡¯ç¤ºä»¥ç¯€çœç©ºé–“ï¼Œæ–¹åŠ‘çš„çµ„æˆä½¿ç”¨è¼ƒå°å­—é«”é¡¯ç¤ºæ–¼æ–¹åŠ‘åç¨±ä¸‹æ–¹
        let prescriptionHtml = '';
        if (consultation.prescription) {
            try {
                // è§£æžè™•æ–¹å…§å®¹è¡Œä¸¦ç§»é™¤ç©ºè¡Œ
                const lines = consultation.prescription.split('\n').filter(line => line.trim());
                // è§£æžçµæ§‹åŒ–è™•æ–¹ï¼Œå»ºç«‹åç¨±å°æ‡‰çš„çµæ§‹åŒ–é …ç›®æ˜ å°„ï¼Œç”¨æ–¼æŸ¥æ‰¾æ–¹åŠ‘çš„çµ„æˆè³‡è¨Š
                const structuredMap = {};
                if (consultation.prescriptionStructured) {
                    try {
                        const _arr = JSON.parse(consultation.prescriptionStructured);
                        if (Array.isArray(_arr)) {
                            _arr.forEach((itm) => {
                                if (itm && itm.name) {
                                    structuredMap[itm.name] = itm;
                                }
                            });
                        }
                    } catch (_e) {
                        /* å¿½ç•¥ JSON è§£æžéŒ¯èª¤ */
                    }
                }
                const itemsList = [];
                // å„²å­˜æ‰€æœ‰æ–¹åŠ‘åŠå…¶çµ„æˆï¼Œä»¥ä¾¿åœ¨è™•æ–¹å…§å®¹å·¦ä¸‹è§’åˆ—å‡º
                const formulaCompositions = [];
                let i = 0;
                // å°‡æ¯å€‹æ¢ç›®è™•ç†ç‚ºå–®ç¨çš„ HTML å€å¡Š
                while (i < lines.length) {
                    const raw = lines[i].trim();
                    if (!raw) {
                        i++;
                        continue;
                    }
                    // åˆ¤æ–·æ˜¯å¦ç¬¦åˆã€Œåç¨± åŠ‘é‡gã€æ ¼å¼
                    const match = raw.match(/^(.+?)\s+(\d+(?:\.\d+)?)g$/);
                    if (match) {
                        const itemName = match[1].trim();
                        const dosage = match[2];
                        const isFormula = ['æ¹¯','æ•£','ä¸¸','è†','é£²','ä¸¹','ç…Ž','æ–¹','åŠ‘'].some(suffix => itemName.includes(suffix));
                        if (isFormula) {
                            // å¦‚æžœæ˜¯æ–¹åŠ‘ï¼Œå˜—è©¦å…ˆå¾žçµæ§‹åŒ–è™•æ–¹è³‡æ–™ä¸­å–å¾—çµ„æˆè³‡è¨Šï¼›è‹¥ç„¡å‰‡å¾ž herbLibrary æˆ–ä¸‹ä¸€è¡Œç²å–
                            let compositionText = '';
                            // å…ˆå¾žçµæ§‹åŒ–è³‡æ–™å–å¾—
                            try {
                                const structuredItem = structuredMap[itemName];
                                if (structuredItem && structuredItem.composition) {
                                    compositionText = String(structuredItem.composition);
                                }
                            } catch (_e) {
                                /* ignore */
                            }
                            // è‹¥çµæ§‹åŒ–è³‡æ–™ä¸­ç„¡çµ„æˆï¼Œå‰‡æŸ¥æ‰¾ herbLibrary
                            if (!compositionText) {
                                try {
                                    if (Array.isArray(herbLibrary)) {
                                        const fullItem = herbLibrary.find(h => h && h.name === itemName && h.type === 'formula');
                                        if (fullItem && fullItem.composition) {
                                            compositionText = String(fullItem.composition);
                                        }
                                    }
                                } catch (_e) {
                                    /* å¿½ç•¥éŒ¯èª¤ */
                                }
                            }
                            // è‹¥ä»ç„¡çµ„æˆè³‡è¨Šï¼Œå‰‡è¦–ä¸‹ä¸€è¡Œç‚ºçµ„æˆï¼ˆè‹¥éžè—¥ææ ¼å¼ï¼‰
                            if (!compositionText) {
                                if (i + 1 < lines.length) {
                                    const nextLine = lines[i + 1].trim();
                                    if (nextLine && !nextLine.match(/^.+?\s+\d+(?:\.\d+)?g$/)) {
                                        compositionText = nextLine;
                                        i++; // è·³éŽä¸‹ä¸€è¡Œä½œç‚ºçµ„æˆ
                                    }
                                }
                            }
                            // è™•ç†çµ„æˆæ–‡å­—ï¼šå°‡æ›è¡Œèˆ‡é “è™Ÿåˆ†éš”ä¸¦ç§»é™¤åŠ‘é‡èˆ‡å–®ä½ï¼Œåªä¿ç•™è—¥æåç¨±
                            let processedComposition = '';
                            if (compositionText) {
                                try {
                                    const parts = String(compositionText)
                                        .replace(/\r/g, '')
                                        .split(/[ã€\n]/)
                                        .map(p => p
                                            .replace(/\d+(?:\.\d+)?\s*(?:g|å…‹|éŒ¢|å…©|ä¸¸|åŒ…)?/gi, '')
                                            .replace(/[()ï¼ˆï¼‰\[\]]/g, '')
                                            .trim()
                                        )
                                        .filter(p => p);
                                    processedComposition = parts.join('ã€');
                                } catch (_err) {
                                    processedComposition = compositionText.replace(/\n/g, 'ã€');
                                }
                            }
                            // è‹¥æœ‰çµ„æˆè³‡è¨Šï¼Œæ”¶é›†èµ·ä¾†ï¼Œç¨å¾Œåœ¨è™•æ–¹å…§å®¹å·¦ä¸‹è§’åˆ—å‡ºï¼Œä¸å†æ–¼ä¸»åˆ—è¡¨ä¸­é¡¯ç¤º
                            if (processedComposition) {
                                try {
                                    formulaCompositions.push({ name: itemName, composition: processedComposition });
                                } catch (_err) {
                                    // ignore
                                }
                            }
                            // æ–¹åŠ‘åœ¨ä¸»åˆ—è¡¨åƒ…é¡¯ç¤ºåç¨±èˆ‡åŠ‘é‡ï¼Œä¸é¡¯ç¤ºçµ„æˆ
                            itemsList.push(`<div style="margin-bottom: 4px;">${itemName} ${dosage}g</div>`);
                        } else {
                            // æ™®é€šè—¥æå€å¡Š
                            itemsList.push(`<div style="margin-bottom: 4px;">${itemName} ${dosage}g</div>`);
                        }
                    } else {
                        // å…¶ä»–èªªæ˜Žè¡Œç›´æŽ¥ä»¥è¼ƒå°å­—é«”é¡¯ç¤º
                        itemsList.push(`<div style="margin-bottom: 4px; font-size: 9px; color: #666;">${raw}</div>`);
                    }
                    i++;
                }
                if (itemsList.length > 0) {
                    // æŒ‰ç…§åŽŸå§‹æ¬¡åºæŽ’åˆ—è™•æ–¹é …ç›®ï¼Œç›´æŽ¥ä½¿ç”¨ itemsList è€Œä¸å†å°‡æ–¹åŠ‘ç§»è‡³æœ€å‰
                    const orderedItems = itemsList;
                    // å°‡æ¢ç›®æŒ‰è¡Œå„ªå…ˆæ–¹å¼åˆ†é…åˆ°ä¸‰æ¬„
                    const columnsCount = 3;
                    const columns = Array.from({ length: columnsCount }, () => []);
                    orderedItems.forEach((item, idx) => {
                        const colIdx = idx % columnsCount;
                        columns[colIdx].push(item);
                    });
                    // çµ„åˆä¸‰æ¬„çš„ HTML å…§å®¹
                    let html = '<div style="display: flex;">';
                    columns.forEach((colItems) => {
                        html += `<div style="flex: 1; padding-right: 4px;">${colItems.join('')}</div>`;
                    });
                    html += '</div>';
                    // å°‡æ–¹åŠ‘çš„çµ„æˆçµ±ä¸€åˆ—åœ¨è™•æ–¹å…§å®¹çš„å·¦ä¸‹è§’ï¼Œå­—é«”ç¨å¾®æ”¾å¤§
                    let compositionHtml = '';
                    if (formulaCompositions.length > 0) {
                        compositionHtml += '<div style="margin-top: 4px; font-size: 0.5em;">';
                        formulaCompositions.forEach((fc) => {
                            compositionHtml += `<div>${fc.name}ï¼š${fc.composition}</div>`;
                        });
                        compositionHtml += '</div>';
                    }
                    prescriptionHtml = html + compositionHtml;
                } else {
                    // è‹¥æœªèƒ½è§£æžä»»ä½•é …ç›®ï¼Œç›´æŽ¥ä»¥æ›è¡Œé¡¯ç¤ºåŽŸå§‹å…§å®¹
                    prescriptionHtml = consultation.prescription.replace(/\n/g, '<br>');
                }
            } catch (_e) {
                // è§£æžå‡ºéŒ¯æ™‚ï¼Œé€€å›žé¡¯ç¤ºåŽŸå§‹è™•æ–¹å…§å®¹
                prescriptionHtml = consultation.prescription.replace(/\n/g, '<br>');
            }
        } else {
            // ç„¡è™•æ–¹å…§å®¹
            prescriptionHtml = 'ç„¡è¨˜éŒ„';
        }
        // çµ„åˆæœè—¥è³‡è¨Šï¼Œå„ªå…ˆä½¿ç”¨è¨ºç—‡è¨˜éŒ„ä¸­çš„ medicationDays/medicationFrequencyï¼›è‹¥ç„¡å‰‡ä¿æŒç©ºå€¼
        let medDays = '';
        let medFreq = '';
        if (consultation && consultation.medicationDays && Number(consultation.medicationDays) > 0) {
            medDays = consultation.medicationDays;
        }
        if (consultation && consultation.medicationFrequency && Number(consultation.medicationFrequency) > 0) {
            medFreq = consultation.medicationFrequency;
        }
        // æ ¹æ“šèªžè¨€å‹•æ…‹çµ„åˆæœè—¥è³‡è¨Šä¸¦ç¿»è­¯æ¨™ç±¤
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        const isEnglish = lang === 'en';
        const htmlLang = isEnglish ? 'en' : 'zh-TW';
        const dateLocale = isEnglish ? 'en-US' : 'zh-TW';
        const colon = isEnglish ? ': ' : 'ï¼š';
        // çµ„åˆæœè—¥è³‡è¨Š
        let medInfoHtml = '';
        if (medDays) {
            medInfoHtml += `<strong>${isEnglish ? 'Number of days' : 'æœè—¥å¤©æ•¸'}${colon}</strong>${medDays}${isEnglish ? ' days' : 'å¤©'}&nbsp;`;
        }
        if (medFreq) {
            medInfoHtml += `<strong>${isEnglish ? 'Times per day' : 'æ¯æ—¥æ¬¡æ•¸'}${colon}</strong>${medFreq}${isEnglish ? '' : 'æ¬¡'}&nbsp;`;
        }
        if (consultation.usage) {
            medInfoHtml += `<strong>${isEnglish ? 'Usage' : 'æœç”¨æ–¹æ³•'}${colon}</strong>${consultation.usage}`;
        }
        // If there is no prescription (Chinese medicine), clear medication info
        if (!consultation.prescription || (typeof consultation.prescription === 'string' && consultation.prescription.trim() === '')) {
            medInfoHtml = '';
        }
        // é†«å›‘åŠæ³¨æ„äº‹é …
        const instructionsHtml = consultation.instructions ? consultation.instructions.replace(/\n/g, '<br>') : '';
        // å»ºè­°è¤‡è¨ºæ™‚é–“ï¼Œæ ¹æ“šèªžè¨€æ ¼å¼åŒ–
        let followUpHtml = '';
        if (consultation.followUpDate) {
            try {
                if (consultation.followUpDate.seconds) {
                    followUpHtml = new Date(consultation.followUpDate.seconds * 1000).toLocaleString(dateLocale);
                } else {
                    followUpHtml = new Date(consultation.followUpDate).toLocaleString(dateLocale);
                }
            } catch (_err) {
                try {
                    followUpHtml = formatConsultationDateTime(consultation.followUpDate);
                } catch (_e2) {
                    followUpHtml = '';
                }
            }
        }
        // ç¿»è­¯å­—å…¸
        const PI = {
            title: isEnglish ? 'Prescription Instructions' : 'è—¥å–®é†«å›‘',
            patientName: isEnglish ? 'Patient Name' : 'ç—…äººå§“å',
            medicalRecordNo: isEnglish ? 'Medical Record No.' : 'ç—…æ­·ç·¨è™Ÿ',
            patientNo: isEnglish ? 'Patient No.' : 'ç—…äººè™Ÿç¢¼',
            consultationDate: isEnglish ? 'Consultation Date' : 'è¨ºç™‚æ—¥æœŸ',
            consultationTime: isEnglish ? 'Time' : 'è¨ºç™‚æ™‚é–“',
            doctor: isEnglish ? 'Attending Physician' : 'ä¸»æ²»é†«å¸«',
            registrationNo: isEnglish ? 'Registration No.' : 'è¨»å†Šç·¨è™Ÿ',
            diagnosis: isEnglish ? 'Diagnosis' : 'è¨ºæ–·',
            prescriptionContent: isEnglish ? 'Prescription Contents' : 'è™•æ–¹å…§å®¹',
            medicationInfo: isEnglish ? 'Medication Information' : 'æœè—¥è³‡è¨Š',
            instructions: isEnglish ? 'Instructions & Precautions' : 'é†«å›‘åŠæ³¨æ„äº‹é …',
            followUp: isEnglish ? 'Suggested Follow-up Time' : 'å»ºè­°è¤‡è¨ºæ™‚é–“',
            thankYou: isEnglish ? 'Thank you for your visit. Wishing you good health!' : 'è¬è¬æ‚¨çš„å…‰è‡¨ï¼Œç¥æ‚¨èº«é«”å¥åº·ï¼',
            printTime: isEnglish ? 'Print Time' : 'åˆ—å°æ™‚é–“',
            businessHours: isEnglish ? 'Clinic Business Hours' : 'è¨ºæ‰€ç‡Ÿæ¥­æ™‚é–“',
            saveAdvice: isEnglish ? 'Please keep this advice safe, this prescription cannot be refilled.' : 'æœ¬é†«å›‘è«‹å¦¥å–„ä¿å­˜ï¼Œæ­¤è—¥æ–¹ä¸å¯é‡é…',
            contact: isEnglish ? 'If you have any questions, please contact the front desk.' : 'å¦‚æœ‰ç–‘å•è«‹æ´½æ«ƒæª¯'
        };
        // æ§‹å»ºåˆ—å°å…§å®¹
        const printContent = `
            <!DOCTYPE html>
            <html lang="${htmlLang}">
            <head>
                <meta charset="UTF-8">
                <title>${PI.title} - ${patient.name}</title>
                <style>
                    body {
                        font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
                        margin: 0;
                        padding: 10px;
                        line-height: 1.3;
                        font-size: 11px;
                    }
                    .advice-container {
                        width: 148mm;
                        height: 210mm;
                        margin: 0 auto;
                        border: 2px solid #000;
                        padding: 8px;
                        background: white;
                        box-sizing: border-box;
                    }
                    .clinic-header {
                        text-align: center;
                        border-bottom: 2px double #000;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    .clinic-name {
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 2px;
                        letter-spacing: 1px;
                    }
                    .clinic-subtitle {
                        font-size: 10px;
                        color: #666;
                        margin-bottom: 3px;
                    }
                    .advice-title {
                        font-size: 14px;
                        font-weight: bold;
                        text-align: center;
                        margin: 6px 0;
                        letter-spacing: 2px;
                    }
                    .patient-info {
                        margin-bottom: 10px;
                        font-size: 11px;
                    }
                    .info-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 3px;
                        font-size: 11px;
                    }
                    .info-label {
                        font-weight: bold;
                    }
                    .section-title {
                        font-weight: bold;
                        margin-top: 10px;
                        margin-bottom: 4px;
                        font-size: 12px;
                    }
                    .section-content {
                        background: #f9f9f9;
                        padding: 4px;
                        border: 1px solid #ddd;
                        font-size: 10px;
                        line-height: 1.3;
                        border-radius: 3px;
                    }
                    .thank-you {
                        text-align: center;
                        margin: 12px 0;
                        font-size: 11px;
                        font-weight: bold;
                        color: #333;
                    }
                    .footer-info {
                        margin-top: 10px;
                        border-top: 1px dashed #666;
                        padding-top: 6px;
                        font-size: 9px;
                        color: #666;
                    }
                    .footer-row {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 2px;
                    }
                    @media print {
                        @page {
                            size: A5;
                            margin: 10mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-size: 11px;
                        }
                        .advice-container {
                            width: 100%;
                            height: 100%;
                            padding: 8mm;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="advice-container">
                    <div class="clinic-header">
                        <div class="clinic-name">${clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±'}</div>
                        <div class="clinic-subtitle">${clinicSettings.englishName || 'Dr.Great Clinic'}</div>
                        <div class="clinic-subtitle">${isEnglish ? 'Tel' : 'é›»è©±'}${colon}${clinicSettings.phone || '(852) 2345-6789'}ã€€${isEnglish ? 'Address' : 'åœ°å€'}${colon}${clinicSettings.address || 'é¦™æ¸¯ä¸­ç’°çš‡åŽå¤§é“ä¸­123è™Ÿ'}</div>
                    </div>
                    <div class="advice-title">${PI.title}</div>
                    <div class="patient-info">
                        <div class="info-row"><span class="info-label">${PI.patientName}${colon}</span><span>${patient.name}</span></div>
                        <div class="info-row"><span class="info-label">${PI.medicalRecordNo}${colon}</span><span>${consultation.medicalRecordNumber || consultation.id}</span></div>
                        ${patient.patientNumber ? `<div class="info-row"><span class="info-label">${PI.patientNo}${colon}</span><span>${patient.patientNumber}</span></div>` : ''}
                        <div class="info-row"><span class="info-label">${PI.consultationDate}${colon}</span><span>${consultationDate.toLocaleDateString(dateLocale, { year: 'numeric', month: '2-digit', day: '2-digit' })}</span></div>
                        <div class="info-row"><span class="info-label">${PI.consultationTime}${colon}</span><span>${consultationDate.toLocaleTimeString(dateLocale, { hour: '2-digit', minute: '2-digit' })}</span></div>
                        <div class="info-row"><span class="info-label">${PI.doctor}${colon}</span><span>${getDoctorDisplayName(consultation.doctor)}</span></div>
                        ${(() => {
                            const regNumber = getDoctorRegistrationNumber(consultation.doctor);
                            return regNumber ? `<div class="info-row"><span class="info-label">${PI.registrationNo}${colon}</span><span>${regNumber}</span></div>` : '';
                        })()}
                        ${consultation.diagnosis ? `<div class="info-row"><span class="info-label">${PI.diagnosis}${colon}</span><span>${consultation.diagnosis}</span></div>` : ''}
                    </div>
                    <div class="section-title">${PI.prescriptionContent}</div>
                    <div class="section-content" style="font-size: 12px;">${prescriptionHtml}</div>
                    ${medInfoHtml ? `<div class="section-title">${PI.medicationInfo}</div><div class="section-content">${medInfoHtml}</div>` : ''}
                    ${instructionsHtml ? `<div class="section-title">${PI.instructions}</div><div class="section-content">${instructionsHtml}</div>` : ''}
                    ${followUpHtml ? `<div class="section-title">${PI.followUp}</div><div class="section-content">${followUpHtml}</div>` : ''}
                    <div class="thank-you">${PI.thankYou}</div>
                    <div class="footer-info">
                        <div class="footer-row"><span>${PI.printTime}${colon}</span><span>${new Date().toLocaleString(dateLocale)}</span></div>
                        <div class="footer-row"><span>${PI.businessHours}${colon}</span><span>${clinicSettings.businessHours || 'é€±ä¸€è‡³é€±äº” 09:00-18:00'}</span></div>
                        <div class="footer-row"><span>${PI.saveAdvice}</span><span>${PI.contact}</span></div>
                    </div>
                </div>
            </body>
            </html>`;
        // é–‹å•Ÿæ–°è¦–çª—ä¸¦åˆ—å°
        const printWindow = window.open('', '_blank', 'width=500,height=700');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        showToast(isEnglish ? 'Prescription instructions are ready for printing!' : 'è—¥å–®é†«å›‘å·²æº–å‚™åˆ—å°ï¼', 'success');
    } catch (error) {
        console.error('åˆ—å°è—¥å–®é†«å›‘éŒ¯èª¤:', error);
        showToast('åˆ—å°è—¥å–®é†«å›‘æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
}

// ä¿®å¾©æ’¤å›žè¨ºç—‡åŠŸèƒ½
async function withdrawConsultation(appointmentId) {
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ä¸¦é¡¯ç¤ºè®€å–ç‹€æ…‹
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector('button[onclick="withdrawConsultation(' + appointmentId + ')"]');
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // ç¢ºä¿å…¨åŸŸè®Šæ•¸å·²åˆå§‹åŒ–
        if (!Array.isArray(appointments)) {
            try {
                const appointmentResult = await window.firebaseDataManager.getAppointments();
                if (appointmentResult.success) {
                    appointments = appointmentResult.data;
                } else {
                    appointments = [];
                }
            } catch (error) {
                appointments = [];
            }
        }
        if (!Array.isArray(consultations)) {
            try {
                const consultationResult = await window.firebaseDataManager.getConsultations();
                if (consultationResult.success) {
                    consultations = consultationResult.data;
                } else {
                    consultations = [];
                }
            } catch (error) {
                consultations = [];
            }
        }
        const appointment = appointments.find(apt => apt && String(apt.id) === String(appointmentId));
        if (!appointment) {
            showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
            return;
        }
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const patientResult = await safeGetPatients(true);
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        const patient = patientResult.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`æ’¤å›žè¨ºç—‡ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}, è¨ºç—‡è¨˜éŒ„ID: ${appointment.consultationId}`);
        // åªæœ‰å·²å®Œæˆçš„è¨ºç—‡æ‰èƒ½æ’¤å›ž
        if (appointment.status !== 'completed') {
            const statusNames = {
                'registered': 'å·²æŽ›è™Ÿ',
                'waiting': 'å€™è¨ºä¸­',
                'consulting': 'è¨ºç—‡ä¸­'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const statusNamesEnMap = {
                    'å·²æŽ›è™Ÿ': 'registered',
                    'å€™è¨ºä¸­': 'waiting',
                    'è¨ºç—‡ä¸­': 'consulting'
                };
                const currentStatusNameEn = statusNamesEnMap[currentStatusName] || currentStatusName;
                const zhMsg = `ç„¡æ³•æ’¤å›žè¨ºç—‡ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½æ’¤å›žå·²å®Œæˆçš„è¨ºç—‡ã€‚`;
                const enMsg = `Cannot retract consultation! Patient ${patient.name} is currently "${currentStatusNameEn}". You can only retract completed consultations.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'warning');
            }
            return;
        }
        // æª¢æŸ¥æ˜¯å¦æœ‰è¨ºç—‡è¨˜éŒ„
        if (!appointment.consultationId) {
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•æ’¤å›žè¨ºç—‡ï¼ç—…äºº ${patient.name} æ²’æœ‰å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ã€‚`;
                const enMsg = `Cannot retract consultation! Patient ${patient.name} has no corresponding consultation record.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'error');
            }
            return;
        }
        // å˜—è©¦å–å¾—å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ã€‚
        // Step 1: å¾žæœ¬åœ°å¿«å–ä¸­å°‹æ‰¾å°æ‡‰ ID çš„è¨ºç—‡è¨˜éŒ„ã€‚
        let consultation = Array.isArray(consultations)
            ? consultations.find(c => String(c.id) === String(appointment.consultationId))
            : null;

        // Step 2: è‹¥æœ¬åœ°æœªæ‰¾åˆ°ï¼Œç›´æŽ¥å¾ž Firestore è®€å–è©²ç­†è¨ºç—‡è¨˜éŒ„ã€‚
        if (!consultation) {
            try {
                const docRef = window.firebase.doc(
                    window.firebase.db,
                    'consultations',
                    String(appointment.consultationId)
                );
                const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap && docSnap.exists()) {
                    consultation = { id: docSnap.id, ...docSnap.data() };
                    // å°‡æ­¤ç´€éŒ„åŠ å…¥å…¨åŸŸå¿«å–ï¼Œä¾¿æ–¼å¾ŒçºŒä½¿ç”¨
                    if (Array.isArray(consultations)) {
                        consultations.push(consultation);
                    } else {
                        consultations = [consultation];
                    }
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            } catch (err) {
                console.error('ç›´æŽ¥è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
            }
        }

        // Step 3: è‹¥ä»æœªæ‰¾åˆ°ï¼Œé€éŽç—…äºº ID è®€å–è©²ç—…äººæ‰€æœ‰è¨ºç—‡è¨˜éŒ„å¾Œæœå°‹ã€‚
        if (!consultation) {
            try {
                const consResult = await window.firebaseDataManager.getPatientConsultations(
                    appointment.patientId,
                    true
                );
                if (consResult && consResult.success) {
                    const records = consResult.data || [];
                    // å°‡é€™äº›ç´€éŒ„åˆä½µåˆ°å…¨åŸŸ consultations å¿«å–ä¸­
                    if (Array.isArray(consultations)) {
                        records.forEach((rec) => {
                            if (!consultations.find(c => String(c.id) === String(rec.id))) {
                                consultations.push(rec);
                            }
                        });
                    } else {
                        consultations = records.slice();
                    }
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                    // å†å¾žé€™äº›ç´€éŒ„ä¸­å°‹æ‰¾ç›®æ¨™ç´€éŒ„
                    consultation = records.find(
                        (c) => String(c.id) === String(appointment.consultationId)
                    );
                }
            } catch (err) {
                console.error('é€éŽç—…äºº ID è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
            }
        }

        // Step 4: è‹¥æœ€çµ‚ä»ç„¶æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼Œæç¤ºéŒ¯èª¤ä¸¦è¿”å›žã€‚
        if (!consultation) {
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•æ’¤å›žè¨ºç—‡ï¼æ‰¾ä¸åˆ°ç—…äºº ${patient.name} çš„è¨ºç—‡è¨˜éŒ„è³‡æ–™ã€‚`;
                const enMsg = `Cannot retract consultation! Consultation record for ${patient.name} not found.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'error');
            }
            return;
        }

        // ç¢ºèªæ’¤å›žæ“ä½œï¼ˆæ”¯æ´ä¸­è‹±æ–‡ï¼‰
        const lang7 = localStorage.getItem('lang') || 'zh';
        const zhMsg7 = `ç¢ºå®šè¦æ’¤å›ž ${patient.name} çš„è¨ºç—‡å—Žï¼Ÿ\n\næ­¤æ“ä½œå°‡æœƒï¼š\nâ€¢ åˆªé™¤è©²æ¬¡ç—…æ­·è¨˜éŒ„\nâ€¢ ç—…äººç‹€æ…‹å›žåˆ°ã€Œå·²æŽ›è™Ÿã€\nâ€¢ é€€å›žæœ¬æ¬¡ç—…æ­·ä½¿ç”¨çš„å¥—ç¥¨\nâ€¢ æ‰€æœ‰è¨ºç—‡è³‡æ–™å°‡æ°¸ä¹…éºå¤±\n\nè¨ºæ–·ï¼š${consultation.diagnosis || 'ç„¡è¨˜éŒ„'}\n\næ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŽŸï¼`;
        const enMsg7 = `Are you sure you want to retract the consultation for ${patient.name}?\n\nThis action will:\nâ€¢ Delete this medical record\nâ€¢ Revert the patient's status to 'Registered'\nâ€¢ Return the package used for this record\nâ€¢ Permanently erase all consultation data\n\nDiagnosis: ${consultation.diagnosis || 'No record'}\n\nNote: this action cannot be undone!`;
        const confirmMsg7 = lang7 === 'en' ? enMsg7 : zhMsg7;
        const confirmedRetract = await showConfirmation(confirmMsg7, 'warning');
        if (!confirmedRetract) {
            return;
        }
    // åˆªé™¤è¨ºç—‡è¨˜éŒ„
    // å…ˆå¾ž Firebase åˆªé™¤è©²æ¬¡è¨ºç—‡è¨˜éŒ„
    try {
        await window.firebase.deleteDoc(
            window.firebase.doc(
                window.firebase.db,
                'consultations',
                String(appointment.consultationId)
            )
        );
        // å¾žæœ¬åœ°é›†åˆä¸­ç§»é™¤è©²è¨ºç—‡è¨˜éŒ„
        const consultationIndex = consultations.findIndex(
            (c) => String(c.id) === String(appointment.consultationId)
        );
        if (consultationIndex !== -1) {
            consultations.splice(consultationIndex, 1);
            localStorage.setItem(
                'consultations',
                JSON.stringify(consultations)
            );
        }
    } catch (error) {
        console.error('åˆªé™¤è¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
        showToast('åˆªé™¤è¨ºç—‡è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    }

    // --- é€€å›žæœ¬æ¬¡è¨ºç—‡ä½¿ç”¨çš„å¥—ç¥¨ ---
    try {
        if (consultation && Array.isArray(consultation.packageChanges)) {
            for (const change of consultation.packageChanges) {
                if (!change || typeof change.delta !== 'number') continue;
                const patientIdForPkg = change.patientId;
                const packageRecordIdForPkg = change.packageRecordId;
                // å¼·åˆ¶åˆ·æ–°ï¼Œå–å¾—æœ€æ–°å¥—ç¥¨è³‡æ–™
                const pkgs = await getPatientPackages(patientIdForPkg, true);
                const pkg = pkgs.find(p => String(p.id) === String(packageRecordIdForPkg));
                if (!pkg) continue;
                // åœ¨æ’¤å›žæ™‚å°‡ç”¨é‡åŠ å›žï¼ˆåå‘è™•ç† deltaï¼‰
                let newRemaining = (pkg.remainingUses || 0) - change.delta;
                if (typeof pkg.totalUses === 'number') {
                    newRemaining = Math.max(0, Math.min(pkg.totalUses, newRemaining));
                } else {
                    newRemaining = Math.max(0, newRemaining);
                }
                const updatedPackage = { ...pkg, remainingUses: newRemaining };
                await window.firebaseDataManager.updatePatientPackage(packageRecordIdForPkg, updatedPackage);
                // æ›´æ–°æœ¬åœ°å¿«å–
                if (patientPackagesCache && Array.isArray(patientPackagesCache[patientIdForPkg])) {
                    patientPackagesCache[patientIdForPkg] = patientPackagesCache[patientIdForPkg].map(p => {
                        if (String(p.id) === String(packageRecordIdForPkg)) {
                            return { ...p, remainingUses: newRemaining };
                        }
                        return p;
                    });
                }
            }
        }
    } catch (err) {
        console.error('é€€å›žå¥—ç¥¨ä½¿ç”¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        showToast('é€€å›žå¥—ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤', 'warning');
    }
    // --- é‚„åŽŸåº«å­˜æ¶ˆè€— ---
    try {
        if (typeof revertInventoryForConsultation === 'function') {
            // ä½¿ç”¨æŽ›è™Ÿä¸Šçš„ consultationId ä»¥é‚„åŽŸåº«å­˜
            const consultationIdForInv = appointment && appointment.consultationId;
            if (consultationIdForInv) {
                await revertInventoryForConsultation(consultationIdForInv);
            }
        }
    } catch (invErr) {
        console.error('æ’¤å›žè¨ºç—‡åº«å­˜å›žå¾©éŒ¯èª¤:', invErr);
    }
    // å¾žç—…äººè¨ºç—‡å¿«å–ä¸­ç§»é™¤è©²ç´€éŒ„
    try {
        if (patientConsultationsCache && Array.isArray(patientConsultationsCache[patient.id])) {
            patientConsultationsCache[patient.id] = patientConsultationsCache[patient.id].filter(c => String(c.id) !== String(consultation.id));
        }
    } catch (_err) {}

    // å°‡æŽ›è™Ÿç‹€æ…‹æ”¹å›žå·²æŽ›è™Ÿ
    appointment.status = 'registered';
    delete appointment.completedAt;
    delete appointment.consultationId;
    delete appointment.completedBy;
    delete appointment.consultationStartTime;
    delete appointment.consultingDoctor;

    // ä¿å­˜ç‹€æ…‹è®Šæ›´
    localStorage.setItem('appointments', JSON.stringify(appointments));
    // åŒæ­¥æ›´æ–°åˆ° Firebase
    await window.firebaseDataManager.updateAppointment(
        String(appointment.id),
        appointment
    );

    {
        const lang = localStorage.getItem('lang') || 'zh';
        const zhMsg = `å·²æ’¤å›ž ${patient.name} çš„è¨ºç—‡ï¼Œç—…äººç‹€æ…‹å›žåˆ°å·²æŽ›è™Ÿ`;
        const enMsg = `Retracted consultation for ${patient.name} and reverted status to registered`;
        const msg = lang === 'en' ? enMsg : zhMsg;
        showToast(msg, 'success');
    }

    // å¦‚æžœæ­£åœ¨ç·¨è¼¯è©²ç—…æ­·ï¼Œå‰‡é—œé–‰è¡¨å–®
    if (
        String(currentConsultingAppointmentId) === String(appointmentId)
    ) {
        closeConsultationForm();
        currentConsultingAppointmentId = null;
    }
        // é‡æ–°è¼‰å…¥åˆ—è¡¨å’Œçµ±è¨ˆ
        loadTodayAppointments();
        updateStatistics();
        // é‡æ–°è¼‰å…¥è©²ç—…äººçš„è¨ºç™‚æ‘˜è¦ï¼Œç¢ºä¿ç—…æ­·åˆ—è¡¨å’Œå¥—ç¥¨ç‹€æ…‹å³æ™‚æ›´æ–°
        try {
            await loadPatientConsultationSummary(patient.id);
        } catch (_e) {
            // ignore summary loading errors
        }
    } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    } finally {
        // æ¸…é™¤æŒ‰éˆ•çš„è®€å–ç‹€æ…‹
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

// ä¿®å¾©ä¿®æ”¹ç—…æ­·åŠŸèƒ½
async function editMedicalRecord(appointmentId) {
    // å–å¾—è§¸ç™¼æŒ‰éˆ•ä¸¦é¡¯ç¤ºè®€å–ç‹€æ…‹
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            loadingButton = document.querySelector('button[onclick="editMedicalRecord(' + appointmentId + ')"]');
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // ç¢ºä¿å…¨åŸŸè®Šæ•¸å·²åˆå§‹åŒ–
        if (!Array.isArray(appointments)) {
            try {
                const appointmentResult = await window.firebaseDataManager.getAppointments();
                if (appointmentResult.success) {
                    appointments = appointmentResult.data;
                } else {
                    appointments = [];
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–æŽ›è™Ÿæ•¸æ“šéŒ¯èª¤:', error);
                appointments = [];
            }
        }
        if (!Array.isArray(consultations)) {
            try {
                const consultationResult = await window.firebaseDataManager.getConsultations();
                if (consultationResult.success) {
                    consultations = consultationResult.data;
                } else {
                    consultations = [];
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–è¨ºç™‚è¨˜éŒ„éŒ¯èª¤:', error);
                consultations = [];
            }
        }
        const appointment = appointments.find(apt => apt && String(apt.id) === String(appointmentId));
        if (!appointment) {
            showToast('æ‰¾ä¸åˆ°æŽ›è™Ÿè¨˜éŒ„ï¼', 'error');
            return;
        }
        // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
        const patientResult = await safeGetPatients(true);
        if (!patientResult.success) {
            showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        const patient = patientResult.data.find(p => p.id === appointment.patientId);
        if (!patient) {
            showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
            return;
        }
        // è©³ç´°ç‹€æ…‹æª¢æŸ¥
        console.log(`ä¿®æ”¹ç—…æ­·ç‹€æ…‹æª¢æŸ¥ - ç—…äºº: ${patient.name}, ç•¶å‰ç‹€æ…‹: ${appointment.status}, è¨ºç—‡è¨˜éŒ„ID: ${appointment.consultationId}`);
        // åªæœ‰å·²å®Œæˆçš„è¨ºç—‡æ‰èƒ½ä¿®æ”¹ç—…æ­·
        if (appointment.status !== 'completed') {
            const statusNames = {
                'registered': 'å·²æŽ›è™Ÿ',
                'waiting': 'å€™è¨ºä¸­',
                'consulting': 'è¨ºç—‡ä¸­'
            };
            const currentStatusName = statusNames[appointment.status] || appointment.status;
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const statusNamesEnMap = {
                    'å·²æŽ›è™Ÿ': 'registered',
                    'å€™è¨ºä¸­': 'waiting',
                    'è¨ºç—‡ä¸­': 'consulting'
                };
                const currentStatusNameEn = statusNamesEnMap[currentStatusName] || currentStatusName;
                const zhMsg = `ç„¡æ³•ä¿®æ”¹ç—…æ­·ï¼ç—…äºº ${patient.name} ç›®å‰ç‹€æ…‹ç‚ºã€Œ${currentStatusName}ã€ï¼Œåªèƒ½ä¿®æ”¹å·²å®Œæˆè¨ºç—‡çš„ç—…æ­·ã€‚`;
                const enMsg = `Cannot modify medical record! Patient ${patient.name} is currently "${currentStatusNameEn}". You can only modify records of completed consultations.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'warning');
            }
            return;
        }
        // æª¢æŸ¥æ˜¯å¦æœ‰è¨ºç—‡è¨˜éŒ„
        if (!appointment.consultationId) {
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•ä¿®æ”¹ç—…æ­·ï¼ç—…äºº ${patient.name} æ²’æœ‰å°æ‡‰çš„è¨ºç—‡è¨˜éŒ„ã€‚`;
                const enMsg = `Cannot modify medical record! Patient ${patient.name} has no corresponding consultation record.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'error');
            }
            return;
        }
        // å˜—è©¦å¾žæœ¬åœ°æˆ– Firebase å–å¾—è¨ºç™‚è¨˜éŒ„
        let consultation = null;
        try {
            const consResult = await window.firebaseDataManager.getConsultations();
            if (consResult && consResult.success) {
                // æ›´æ–°å…¨åŸŸè¨ºç—‡å¿«å–
                consultations = consResult.data;
                consultation = consResult.data.find(c => String(c.id) === String(appointment.consultationId));
            }
        } catch (error) {
            console.error('è®€å–è¨ºç™‚è¨˜éŒ„éŒ¯èª¤:', error);
        }
        // è‹¥æœªæ‰¾åˆ°ï¼Œå˜—è©¦ä½¿ç”¨ getDoc ç›´æŽ¥è®€å–æŒ‡å®šè¨ºç—‡è¨˜éŒ„
        if (!consultation) {
            try {
                const docRef = window.firebase.doc(window.firebase.db, 'consultations', String(appointment.consultationId));
                const docSnap = await window.firebase.getDoc(docRef);
                if (docSnap && docSnap.exists()) {
                    consultation = { id: docSnap.id, ...docSnap.data() };
                    // å°‡è³‡æ–™å­˜å…¥æœ¬åœ°å¿«å–ï¼Œé¿å…ä¸‹æ¬¡é‡è¤‡è®€å–
                    consultations.push(consultation);
                    localStorage.setItem('consultations', JSON.stringify(consultations));
                }
            } catch (err) {
                console.error('ç›´æŽ¥è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', err);
            }
        }
        if (!consultation) {
            // å¦‚æžœä»ç„¶æ‰¾ä¸åˆ°è¨ºç—‡è¨˜éŒ„ï¼Œæç¤ºéŒ¯èª¤å¾ŒçµæŸ
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const zhMsg = `ç„¡æ³•ä¿®æ”¹ç—…æ­·ï¼æ‰¾ä¸åˆ°ç—…äºº ${patient.name} çš„è¨ºç—‡è¨˜éŒ„è³‡æ–™ã€‚`;
                const enMsg = `Cannot modify medical record! Consultation record for ${patient.name} not found.`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'error');
            }
            return;
        }
        // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç—…äººæ­£åœ¨è¨ºç—‡ä¸­ï¼ˆåƒ…é™åˆ¶åŒä¸€é†«å¸«ï¼‰
        let consultingAppointment = null;
        const isDoctorUser = currentUserData && currentUserData.position === 'é†«å¸«';
        if (isDoctorUser) {
            consultingAppointment = appointments.find(apt =>
                apt.status === 'consulting' &&
                apt.appointmentDoctor === currentUserData.username &&
                new Date(apt.appointmentTime).toDateString() === new Date().toDateString()
            );
        }
        if (consultingAppointment) {
            // å¾ž Firebase ç²å–æ­£åœ¨è¨ºç—‡çš„ç—…äººè³‡æ–™
            const consultingPatient = patientResult.data.find(p => p.id === consultingAppointment.patientId);
            const consultingPatientName = consultingPatient ? consultingPatient.name : 'æœªçŸ¥ç—…äºº';
            // æç¤ºç•¶å‰æ­£åœ¨è¨ºç—‡å…¶ä»–ç—…äººï¼Œè©¢å•æ˜¯å¦çµæŸä¸¦æ”¹ç‚ºä¿®æ”¹ç—…æ­·ï¼ˆæ”¯æ´ä¸­è‹±æ–‡ï¼‰
            const lang4 = localStorage.getItem('lang') || 'zh';
            const zhMsg4 = `æ‚¨ç›®å‰æ­£åœ¨ç‚º ${consultingPatientName} è¨ºç—‡ã€‚\n\næ˜¯å¦è¦çµæŸè©²ç—…äººçš„è¨ºç—‡ä¸¦é–‹å§‹ä¿®æ”¹ ${patient.name} çš„ç—…æ­·ï¼Ÿ\n\næ³¨æ„ï¼š${consultingPatientName} çš„ç‹€æ…‹å°‡æ”¹å›žå€™è¨ºä¸­ã€‚`;
            const enMsg4 = `You are currently consulting ${consultingPatientName}.\n\nDo you want to finish that patient's consultation and start editing ${patient.name}'s medical record?\n\nNote: ${consultingPatientName}'s status will revert to waiting.`;
            const msg4 = lang4 === 'en' ? enMsg4 : zhMsg4;
            const confirmEdit = await showConfirmation(msg4, 'warning');
            if (confirmEdit) {
                // çµæŸç•¶å‰è¨ºç—‡çš„ç—…äºº
                consultingAppointment.status = 'waiting';
                delete consultingAppointment.consultationStartTime;
                delete consultingAppointment.consultingDoctor;
                // é—œé–‰å¯èƒ½é–‹å•Ÿçš„è¨ºç—‡è¡¨å–®
                // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒï¼Œé¿å… ID é¡žåž‹ä¸ä¸€è‡´å°Žè‡´ç„¡æ³•åŒ¹é…
                if (String(currentConsultingAppointmentId) === String(consultingAppointment.id)) {
                    closeConsultationForm();
                }
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const msg = lang === 'en'
                        ? `Finished ${consultingPatientName}'s consultation`
                        : `å·²çµæŸ ${consultingPatientName} çš„è¨ºç—‡`;
                    showToast(msg, 'info');
                }
                localStorage.setItem('appointments', JSON.stringify(appointments));
                // åŒæ­¥æ›´æ–°åˆ° Firebase
                await window.firebaseDataManager.updateAppointment(String(consultingAppointment.id), consultingAppointment);
            } else {
                return; // ç”¨æˆ¶å–æ¶ˆæ“ä½œ
            }
        }
        // è¨­ç½®ç‚ºç·¨è¼¯æ¨¡å¼
        currentConsultingAppointmentId = appointmentId;
        showConsultationForm(appointment);
        {
            const lang = localStorage.getItem('lang') || 'zh';
            const msg = lang === 'en'
                ? `Entered medical record edit mode for ${patient.name}`
                : `é€²å…¥ ${patient.name} çš„ç—…æ­·ç·¨è¼¯æ¨¡å¼`;
            showToast(msg, 'info');
        }
    } catch (error) {
        console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
        showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
    } finally {
        // æ¸…é™¤æŒ‰éˆ•çš„è®€å–ç‹€æ…‹
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}
// è¼‰å…¥ç—…äººè¨ºç™‚è¨˜éŒ„æ‘˜è¦
async function loadPatientConsultationSummary(patientId) {
    const summaryContainer = document.getElementById('patientConsultationSummary');

    // å¦‚æžœå®¹å™¨å°šæœªæ¸²æŸ“ï¼Œç›´æŽ¥è·³éŽï¼Œä»¥å…å° null è¨­å®š innerHTML
    if (!summaryContainer) {
        console.warn('patientConsultationSummary å®¹å™¨ä¸å­˜åœ¨ï¼Œè¨ºç™‚æ‘˜è¦ç„¡æ³•è¼‰å…¥');
        return;
    }

    try {
        // å§‹çµ‚å¼·åˆ¶å¾žè³‡æ–™åº«å–å¾—æœ€æ–°çš„è¨ºç—‡è¨˜éŒ„ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
        const result = await window.firebaseDataManager.getPatientConsultations(patientId, true);
        
        if (!result.success) {
            summaryContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">âŒ</div>
                    <div>ç„¡æ³•è¼‰å…¥è¨ºç™‚è¨˜éŒ„</div>
                </div>
            `;
            return;
        }

        const consultations = result.data;
        const totalConsultations = consultations.length;
        const lastConsultation = consultations[0]; // æœ€æ–°çš„è¨ºç™‚è¨˜éŒ„

        // å–å¾—ä¸¦è¨ˆç®—å¥—ç¥¨ç‹€æ…‹
        let packageStatusHtml = '';
        // å°‡å¥—ç¥¨è³‡æ–™ä¿ç•™åœ¨å¤–å±¤ä½œç”¨åŸŸï¼Œä»¥ä¾¿å¾ŒçºŒè¨ˆç®— activePkgCount
        let pkgs;
        try {
            // å§‹çµ‚å¼·åˆ¶é‡æ–°è¼‰å…¥å¥—ç¥¨ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
            pkgs = await getPatientPackages(patientId, true);
            // å¦‚æžœæœ‰å¥—ç¥¨ç´€éŒ„
            if (Array.isArray(pkgs) && pkgs.length > 0) {
                // åªé¡¯ç¤ºæœ‰å‰©é¤˜æ¬¡æ•¸çš„å¥—ç¥¨
                const activePkgs = pkgs.filter(p => p && p.remainingUses > 0);
                if (activePkgs.length > 0) {
                    // æŒ‰åˆ°æœŸæ—¥æŽ’åºï¼Œè¶Šæ—©åˆ°æœŸè¶Šå‰é¢é¡¯ç¤º
                    activePkgs.sort((a, b) => new Date(a.expiresAt) - new Date(b.expiresAt));
                    
                    packageStatusHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${activePkgs.map(pkg => {
                                const status = formatPackageStatus(pkg);
                                const expiresAt = new Date(pkg.expiresAt);
                                const now = new Date();
                                const daysLeft = Math.ceil((expiresAt - now) / (1000*60*60*24));
                                
                                // æ ¹æ“šå‰©é¤˜å¤©æ•¸æ±ºå®šé¡è‰²
                                let statusColor = 'bg-green-50 border-green-200 text-green-800';
                                let iconColor = 'text-green-600';
                                let progressColor = 'bg-green-500';
                                
                                if (daysLeft <= 7) {
                                    statusColor = 'bg-red-50 border-red-200 text-red-800';
                                    iconColor = 'text-red-600';
                                    progressColor = 'bg-red-500';
                                } else if (daysLeft <= 30) {
                                    statusColor = 'bg-yellow-50 border-yellow-200 text-yellow-800';
                                    iconColor = 'text-yellow-600';
                                    progressColor = 'bg-yellow-500';
                                }
                                
                                // è¨ˆç®—ä½¿ç”¨é€²åº¦
                                const usagePercentage = ((pkg.totalUses - pkg.remainingUses) / pkg.totalUses) * 100;
                                
                                return `
                                    <div class="relative ${statusColor} border rounded-lg p-3 transition-all duration-200 hover:shadow-md">
                                        <!-- å¥—ç¥¨åç¨±å’Œåœ–æ¨™ -->
                                        <div class="flex items-start justify-between mb-2">
                                            <div class="flex items-center space-x-2">
                                                <div class="${iconColor}">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                </div>
                                                <div class="font-medium text-sm truncate">${pkg.name}</div>
                                            </div>
                                            <div class="text-xs font-medium px-2 py-1 rounded-full bg-white bg-opacity-70 whitespace-nowrap">
                                                ${daysLeft <= 0 ? 'å·²åˆ°æœŸ' : `${daysLeft}å¤©`}
                                            </div>
                                        </div>
                                        
                                        <!-- ä½¿ç”¨æ¬¡æ•¸å’Œé€²åº¦æ¢ -->
                                        <div class="space-y-2">
                                            <div class="flex justify-between items-center text-xs">
                                                <span>å‰©é¤˜ ${pkg.remainingUses}/${pkg.totalUses}</span>
                                                <span>${Math.round(100 - usagePercentage)}%</span>
                                            </div>
                                            
                                            <!-- é€²åº¦æ¢ -->
                                            <div class="w-full bg-white bg-opacity-50 rounded-full h-1.5">
                                                <div class="${progressColor} h-1.5 rounded-full transition-all duration-300" 
                                                     style="width: ${usagePercentage}%"></div>
                                            </div>
                                            
                                            <!-- åˆ°æœŸæ—¥ -->
                                            <div class="text-xs opacity-75 truncate">
                                                ${expiresAt.toLocaleDateString('zh-TW')}
                                            </div>
                                        </div>
                                        
                                        <!-- ç·Šæ€¥æ¨™è¨˜ -->
                                        ${daysLeft <= 7 && daysLeft > 0 ? `
                                            <div class="absolute -top-1 -right-1">
                                                <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-bold text-white bg-red-500 rounded-full animate-pulse">
                                                    !
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>`;
                } else {
                    // æœ‰å¥—ç¥¨è¨˜éŒ„ä½†å·²å…¨æ•¸ç”¨ç›¡
                    packageStatusHtml = `
                        <div class="bg-gray-50 border-gray-200 border rounded-lg p-3 text-center">
                            <div class="text-gray-400 mb-1">
                                <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="text-sm font-medium text-gray-600">ç„¡å¯ç”¨å¥—ç¥¨</div>
                            <div class="text-xs text-gray-500 mt-1">æ‰€æœ‰å¥—ç¥¨å·²ç”¨å®Œæˆ–éŽæœŸ</div>
                        </div>
                    `;
                }
            } else {
                // ç„¡å¥—ç¥¨è¨˜éŒ„
                packageStatusHtml = `
                    <div class="bg-blue-50 border-blue-200 border rounded-lg p-3 text-center">
                        <div class="text-blue-400 mb-1">
                            <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-sm font-medium text-blue-700">å°šæœªè³¼è²·å¥—ç¥¨</div>
                        <div class="text-xs text-blue-600 mt-1">å¯æ–¼è¨ºç™‚æ™‚è³¼è²·å¥—ç¥¨äº«å„ªæƒ </div>
                    </div>
                `;
            }
        } catch (err) {
            console.error('å–å¾—å¥—ç¥¨è³‡è¨Šå¤±æ•—:', err);
            packageStatusHtml = `
                <div class="bg-red-50 border-red-200 border rounded-lg p-3 text-center">
                    <div class="text-red-400 mb-1">
                        <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="text-sm font-medium text-red-700">è¼‰å…¥å¤±æ•—</div>
                    <div class="text-xs text-red-600 mt-1">ç„¡æ³•è¼‰å…¥å¥—ç¥¨ç‹€æ…‹</div>
                </div>
            `;
        }

        // è¨ˆç®—å¯ç”¨å¥—ç¥¨æ•¸é‡ï¼ˆactivePkgCountï¼‰ã€‚
        // å„ªå…ˆä½¿ç”¨ç—…äººæ–‡ä»¶ä¸­çš„ packageActiveCount æ¬„ä½ï¼Œè‹¥ä¸å­˜åœ¨å‰‡é€€å›žè‡³åˆ©ç”¨ pkgs è¨ˆç®—ã€‚
        let activePkgCount = 0;
        try {
            // å˜—è©¦å¾žå¿«å–æˆ–è®€å–æ‰€æœ‰ç—…äººè³‡æ–™ä¸­å–å¾—æŒ‡å®šç—…äºº
            let allPatientsForCount = [];
            if (Array.isArray(patientCache) && patientCache.length > 0) {
                allPatientsForCount = patientCache;
            } else {
                // è‹¥å¿«å–ä¸å­˜åœ¨ï¼Œå¾ž Firebase è®€å–
                allPatientsForCount = await fetchPatients();
            }
            const targetPatient = allPatientsForCount.find((p) => String(p.id) === String(patientId));
            if (targetPatient && typeof targetPatient.packageActiveCount === 'number') {
                activePkgCount = targetPatient.packageActiveCount;
            } else {
                // è‹¥ç—…äººè³‡æ–™ä¸­ç„¡å½™ç¸½æ¬„ä½ï¼Œå‰‡ä½¿ç”¨å·²è¼‰å…¥çš„ pkgs è¨ˆç®—
                if (Array.isArray(pkgs)) {
                    activePkgCount = pkgs.filter(p => p && typeof p.remainingUses === 'number' && p.remainingUses > 0).length;
                } else {
                    activePkgCount = 0;
                }
            }
        } catch (activeCountErr) {
            console.error('å–å¾—ç—…äººå¯ç”¨å¥—ç¥¨æ•¸é‡å¤±æ•—:', activeCountErr);
            // ä½œç‚ºæœ€å¾Œä¿éšªï¼Œä½¿ç”¨ pkgs è¨ˆç®—
            if (Array.isArray(pkgs)) {
                try {
                    activePkgCount = pkgs.filter(p => p && typeof p.remainingUses === 'number' && p.remainingUses > 0).length;
                } catch (fallbackErr) {
                    activePkgCount = 0;
                }
            } else {
                activePkgCount = 0;
            }
        }

        // ç”¢ç”Ÿã€Œå¥—ç¥¨æƒ…æ³ã€å€å¡Šçš„ HTMLï¼Œç”¨æ–¼è¨ºç™‚æ‘˜è¦ä¸­é¡¯ç¤ºå¥—ç¥¨è³‡è¨Š
        let packageSituationInnerHtml = '';
        try {
            if (Array.isArray(pkgs) && pkgs.length > 0) {
                const nowPs = new Date();
                const soonThresholdPs = new Date(nowPs.getTime() + 7 * 24 * 60 * 60 * 1000);
                const validPkgsPs = [];
                const invalidPkgsPs = [];
                pkgs.forEach(pkg => {
                    const expDate = new Date(pkg.expiresAt);
                    const expired = expDate < nowPs || (typeof pkg.remainingUses === 'number' && pkg.remainingUses <= 0);
                    if (expired) {
                        invalidPkgsPs.push(pkg);
                    } else {
                        validPkgsPs.push(pkg);
                    }
                });
                const sortedValidPs = validPkgsPs.slice().sort((a, b) => new Date(a.expiresAt) - new Date(b.expiresAt));
                const sortedInvalidPs = invalidPkgsPs.slice().sort((a, b) => new Date(a.expiresAt) - new Date(b.expiresAt));
                packageSituationInnerHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            ${sortedValidPs.length > 0 ? `<div class="font-medium text-gray-700 mb-2">æœ‰æ•ˆå¥—ç¥¨</div>` : ''}
                            <div class="space-y-2">
                                ${sortedValidPs.map(pkg => {
                                    const safePkgName = window.escapeHtml(pkg.name || '');
                                    const statusText = formatPackageStatus(pkg);
                                    const safeStatusText = window.escapeHtml(statusText || '');
                                    const remainingUses = typeof pkg.remainingUses === 'number' ? pkg.remainingUses : '';
                                    const totalUses = typeof pkg.totalUses === 'number' ? pkg.totalUses : '';
                                    const expDate = new Date(pkg.expiresAt);
                                    const lowUses = typeof pkg.remainingUses === 'number' && pkg.remainingUses <= 2;
                                    const highlight = (expDate <= soonThresholdPs) || lowUses;
                                    const containerClasses = highlight ? 'bg-red-50 border border-red-200' : 'bg-purple-50 border border-purple-200';
                                    const nameClass = highlight ? 'text-red-700' : 'text-purple-900';
                                    const statusClass = highlight ? 'text-red-600' : 'text-gray-600';
                                    const usesClass = highlight ? 'text-red-700' : 'text-gray-800';
                                    return `
                                        <div class="flex items-center justify-between ${containerClasses} rounded p-2">
                                            <div>
                                                <div class="font-medium ${nameClass}">${safePkgName}</div>
                                                <div class="text-xs ${statusClass}">${safeStatusText}</div>
                                            </div>
                                            <div class="text-sm ${usesClass}">${remainingUses}${totalUses !== '' ? '/' + totalUses : ''}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div>
                            ${sortedInvalidPs.length > 0 ? `<div class="font-medium text-gray-700 mb-2">å¤±æ•ˆå¥—ç¥¨</div>` : ''}
                            <div class="space-y-2">
                                ${sortedInvalidPs.map(pkg => {
                                    const safePkgName = window.escapeHtml(pkg.name || '');
                                    const statusText = formatPackageStatus(pkg);
                                    const safeStatusText = window.escapeHtml(statusText || '');
                                    const remainingUses = typeof pkg.remainingUses === 'number' ? pkg.remainingUses : '';
                                    const totalUses = typeof pkg.totalUses === 'number' ? pkg.totalUses : '';
                                    return `
                                        <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded p-2">
                                            <div>
                                                <div class="font-medium text-gray-500">${safePkgName}</div>
                                                <div class="text-xs text-gray-400">${safeStatusText}</div>
                                            </div>
                                            <div class="text-sm text-gray-500">${remainingUses}${totalUses !== '' ? '/' + totalUses : ''}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (Array.isArray(pkgs) && pkgs.length === 0) {
                // ç„¡å¥—ç¥¨è¨˜éŒ„
                packageSituationInnerHtml = `
                    <div class="bg-blue-50 border-blue-200 border rounded-lg p-3 text-center">
                        <div class="text-blue-400 mb-1">
                            <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-sm font-medium text-blue-700">å°šæœªè³¼è²·å¥—ç¥¨</div>
                        <div class="text-xs text-blue-600 mt-1">å¯æ–¼è¨ºç™‚æ™‚è³¼è²·å¥—ç¥¨äº«å„ªæƒ </div>
                    </div>
                `;
            } else {
                // å–å¾—å¥—ç¥¨è³‡è¨Šå¤±æ•—
                packageSituationInnerHtml = `
                    <div class="bg-red-50 border-red-200 border rounded-lg p-3 text-center">
                        <div class="text-red-400 mb-1">
                            <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="text-sm font-medium text-red-700">è¼‰å…¥å¤±æ•—</div>
                        <div class="text-xs text-red-600 mt-1">ç„¡æ³•è¼‰å…¥å¥—ç¥¨ç‹€æ…‹</div>
                    </div>
                `;
            }
        } catch (pkgErr) {
            console.error('ç”¢ç”Ÿå¥—ç¥¨æƒ…æ³å¤±æ•—:', pkgErr);
            packageSituationInnerHtml = `
                <div class="bg-red-50 border-red-200 border rounded-lg p-3 text-center">
                    <div class="text-red-400 mb-1">
                        <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="text-sm font-medium text-red-700">è¼‰å…¥å¤±æ•—</div>
                    <div class="text-xs text-red-600 mt-1">ç„¡æ³•è¼‰å…¥å¥—ç¥¨ç‹€æ…‹</div>
                </div>
            `;
        }

        if (totalConsultations === 0) {
            summaryContainer.innerHTML = `
                <!-- ç¬¬ä¸€è¡Œï¼šåŸºæœ¬çµ±è¨ˆè³‡è¨Š -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-blue-800">ç¸½è¨ºç™‚æ¬¡æ•¸</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <div class="text-lg font-semibold text-green-600">ç„¡</div>
                        <div class="text-sm text-green-800">æœ€è¿‘è¨ºç™‚</div>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 text-center">
                        <div class="text-lg font-semibold text-orange-600">ç„¡å®‰æŽ’</div>
                        <div class="text-sm text-orange-800">ä¸‹æ¬¡è¤‡è¨º</div>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šå¥—ç¥¨æƒ…æ³å€åŸŸ -->
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-200 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-purple-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <!-- å°‡æ¨™é¡Œæ”¹ç‚ºã€Œå¥—ç¥¨æƒ…æ³ã€ï¼Œå°æ‡‰æ–°çš„å…§å®¹ -->
                            <h3 class="text-lg font-semibold text-purple-800">å¥—ç¥¨æƒ…æ³</h3>
                        </div>
                        <div class="text-xs text-purple-600 bg-white px-2 py-1 rounded-full">
                            ${activePkgCount} å€‹å¯ç”¨
                        </div>
                    </div>
                    <!-- ä½¿ç”¨å‹•æ…‹æ¸²æŸ“çš„å¥—ç¥¨å€å¡Šï¼Œåˆå§‹é¡¯ç¤ºè¼‰å…¥ä¸­å‹•ç•« -->
                    <div id="packageStatusContent">
                        <div class="text-center py-4">
                            <!-- ä½¿ç”¨è¼ƒå¤§çš„è®€å–åœˆä»¥èˆ‡å…¶ä»–é é¢ä¸€è‡´ -->
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                            <div class="mt-2 text-sm">è¼‰å…¥å¥—ç¥¨è³‡æ–™ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ç„¡è¨ºç™‚è¨˜éŒ„æ™‚ä¸é¡¯ç¤ºæç¤ºæ–‡å­— -->
            `;
            // é€éŽ renderPackageStatusSection åœ¨è¨ºç™‚æ‘˜è¦ä¸­æ¸²æŸ“å¥—ç¥¨åˆ†é èˆ‡å…§å®¹
            await renderPackageStatusSection(patientId);
            return;
        }

        // æ ¼å¼åŒ–æœ€å¾Œè¨ºç™‚æ—¥æœŸ
        const lastConsultationDate = lastConsultation.date ? 
            new Date(lastConsultation.date.seconds * 1000).toLocaleDateString('zh-TW') : 
            new Date(lastConsultation.createdAt.seconds * 1000).toLocaleDateString('zh-TW');

        // æ ¼å¼åŒ–ä¸‹æ¬¡è¤‡è¨ºæ—¥æœŸ
        const nextFollowUp = lastConsultation.followUpDate ? 
            new Date(lastConsultation.followUpDate).toLocaleDateString('zh-TW') : 'ç„¡å®‰æŽ’';

        // æ›´æ–°è¨ºç™‚æ‘˜è¦ï¼šç¬¬ä¸€è¡Œé¡¯ç¤ºåŸºæœ¬çµ±è¨ˆï¼Œç¬¬äºŒè¡Œé¡¯ç¤ºå¥—ç¥¨ç‹€æ…‹
        summaryContainer.innerHTML = `
            <!-- ç¬¬ä¸€è¡Œï¼šåŸºæœ¬çµ±è¨ˆè³‡è¨Š -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600">${totalConsultations}</div>
                    <div class="text-sm text-blue-800">ç¸½è¨ºç™‚æ¬¡æ•¸</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-lg font-semibold text-green-600">${lastConsultationDate}</div>
                    <div class="text-sm text-green-800">æœ€è¿‘è¨ºç™‚</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4 text-center">
                    <div class="text-lg font-semibold text-orange-600">${nextFollowUp}</div>
                    <div class="text-sm text-orange-800">ä¸‹æ¬¡è¤‡è¨º</div>
                </div>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šå¥—ç¥¨æƒ…æ³å€åŸŸ -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-200">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-purple-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <!-- å°‡æ¨™é¡Œæ”¹ç‚ºã€Œå¥—ç¥¨æƒ…æ³ã€ï¼Œå°æ‡‰æ–°çš„å…§å®¹ -->
                        <h3 class="text-lg font-semibold text-purple-800">å¥—ç¥¨æƒ…æ³</h3>
                    </div>
                    <div class="text-xs text-purple-600 bg-white px-2 py-1 rounded-full">
                        ${activePkgCount} å€‹å¯ç”¨
                    </div>
                </div>
                <!-- ä½¿ç”¨å‹•æ…‹æ¸²æŸ“çš„å¥—ç¥¨å€å¡Šï¼Œåˆå§‹é¡¯ç¤ºè¼‰å…¥ä¸­å‹•ç•« -->
                <div id="packageStatusContent">
                    <div class="text-center py-4">
                        <!-- ä½¿ç”¨è¼ƒå¤§çš„è®€å–åœˆä»¥èˆ‡å…¶ä»–é é¢ä¸€è‡´ -->
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                        <div class="mt-2 text-sm">è¼‰å…¥å¥—ç¥¨è³‡æ–™ä¸­...</div>
                    </div>
                </div>
            </div>
        `;
        // é€éŽ renderPackageStatusSection åœ¨è¨ºç™‚æ‘˜è¦ä¸­æ¸²æŸ“å¥—ç¥¨åˆ†é èˆ‡å…§å®¹
        await renderPackageStatusSection(patientId);

    } catch (error) {
        console.error('è¼‰å…¥è¨ºç™‚è¨˜éŒ„æ‘˜è¦éŒ¯èª¤:', error);
        summaryContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-2">âŒ</div>
                <div>è¼‰å…¥è¨ºç™‚è¨˜éŒ„å¤±æ•—</div>
            </div>
        `;
    }
}
        
// æ›´æ–°çµ±è¨ˆåŠŸèƒ½
async function updateStatistics() {
    try {
        // å¦‚æžœ Firebase æ•¸æ“šç®¡ç†å™¨å°šæœªåˆå§‹åŒ–æˆ–å°šæœªæº–å‚™å¥½ï¼Œå‰‡è·³éŽçµ±è¨ˆæ›´æ–°ã€‚
        if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
            console.log('Firebase æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’ï¼Œçµ±è¨ˆè³‡è¨Šå°‡ç¨å¾Œæ›´æ–°');
            return;
        }
        // ç‚ºé¿å…åœ¨ä¸»é å¤šæ¬¡å¾ž Firebase è®€å–æŽ›è™Ÿå’Œç—…äººè³‡æ–™ï¼Œé€™è£¡å„ªå…ˆä½¿ç”¨å·²ç·©å­˜æˆ–æœ¬åœ°å„²å­˜çš„è³‡æ–™è¨ˆç®—çµ±è¨ˆã€‚
        let totalPatients = 0;
        try {
            // å¦‚æžœå…¨åŸŸ patients å·²è¼‰å…¥ä¸”éžç©ºï¼Œç›´æŽ¥ä½¿ç”¨å…¶é•·åº¦
            if (Array.isArray(patients) && patients.length > 0) {
                totalPatients = patients.length;
            } else if (Array.isArray(patientCache) && patientCache.length > 0) {
                // å¦‚æžœæœ‰å¿«å–ï¼Œä½¿ç”¨å¿«å–é•·åº¦
                totalPatients = patientCache.length;
            } else {
                // æœ€å¾Œæª¢æŸ¥æœ¬åœ°å­˜å„²
                const storedPatients = localStorage.getItem('patients');
                if (storedPatients) {
                    try {
                        const parsed = JSON.parse(storedPatients);
                        if (Array.isArray(parsed)) {
                            totalPatients = parsed.length;
                        }
                    } catch (parseError) {
                        // ignore JSON parse error
                    }
                }
            }
        } catch (countError) {
            console.error('è¨ˆç®—ç—…äººæ•¸é‡éŒ¯èª¤:', countError);
            totalPatients = 0;
        }
        // æ›´æ–°ç—…äººç¸½æ•¸é¡¯ç¤º
        const totalPatientsElement = document.getElementById('totalPatients');
        if (totalPatientsElement) {
            totalPatientsElement.textContent = totalPatients;
        }
        // è™•ç†æŽ›è™Ÿè³‡æ–™ï¼šå„ªå…ˆä½¿ç”¨å…¨åŸŸ appointmentsï¼Œå¦‚æžœä¸å­˜åœ¨å†ä½¿ç”¨æœ¬åœ°å„²å­˜ã€‚
        let appointmentsData = [];
        try {
            if (Array.isArray(appointments) && appointments.length > 0) {
                appointmentsData = appointments;
            } else {
                const storedApts = localStorage.getItem('appointments');
                if (storedApts) {
                    try {
                        const parsedApt = JSON.parse(storedApts);
                        if (Array.isArray(parsedApt)) {
                            appointmentsData = parsedApt;
                        }
                    } catch (parseErr) {
                        // ignore JSON parse error
                    }
                }
            }
        } catch (aptError) {
            console.error('è®€å–æŽ›è™Ÿè³‡æ–™éŒ¯èª¤:', aptError);
            appointmentsData = [];
        }
        // è¨ˆç®—ä»Šæ—¥è¨ºç™‚æ•¸ï¼ˆå¾žæŽ›è™Ÿæ•¸æ“šè¨ˆç®—ï¼‰
        const today = new Date().toDateString();
        const todayConsultations = appointmentsData.filter(apt => 
            apt.status === 'completed' && 
            new Date(apt.appointmentTime).toDateString() === today
        ).length;
        const todayConsultationsElement = document.getElementById('todayConsultations');
        if (todayConsultationsElement) {
            todayConsultationsElement.textContent = todayConsultations;
        }
        // è¨ˆç®—æœ¬æœˆè¨ºç™‚æ•¸
        const thisMonth = new Date();
        const monthlyConsultations = appointmentsData.filter(apt => 
            apt.status === 'completed' && 
            new Date(apt.appointmentTime).getMonth() === thisMonth.getMonth() &&
            new Date(apt.appointmentTime).getFullYear() === thisMonth.getFullYear()
        ).length;
        const monthlyConsultationsElement = document.getElementById('monthlyConsultations');
        if (monthlyConsultationsElement) {
            monthlyConsultationsElement.textContent = monthlyConsultations;
        }
    } catch (error) {
        console.error('æ›´æ–°çµ±è¨ˆéŒ¯èª¤:', error);
        // å¦‚æžœè¨ˆç®—å¤±æ•—ï¼Œé¡¯ç¤º 0
        const totalPatientsElement = document.getElementById('totalPatients');
        if (totalPatientsElement) {
            totalPatientsElement.textContent = '0';
        }
    }
}

// åœ¨ç”¨æˆ¶é€éŽ Authentication ç™»å…¥å¾Œåˆå§‹åŒ–ç³»çµ±è³‡æ–™ã€‚
// é€™å€‹å‡½å¼æœƒè¼‰å…¥æŽ›è™Ÿã€è¨ºç™‚è¨˜éŒ„åŠæ‚£è€…è³‡æ–™ï¼Œ
// ä¸¦åœ¨å®Œæˆå¾Œæ›´æ–°çµ±è¨ˆè³‡è¨Šä»¥åŠè¨‚é–±æŽ›è™Ÿå³æ™‚æ›´æ–°ã€‚
async function initializeSystemAfterLogin() {
    // ç¢ºä¿ Firebase è³‡æ–™ç®¡ç†å™¨å·²æº–å‚™å¥½
    await waitForFirebaseDataManager();
    try {
        /**
         * 2025-09: ç‚ºäº†é¿å…åœ¨ç™»å…¥å¾Œç«‹å³å¾ž Firebase è®€å–æ‰€æœ‰ç—…æ­·è¨˜éŒ„ï¼Œ
         * æˆ‘å€‘ä¸å†æ–¼æ­¤è‡ªå‹•è®€å– consultations è³‡æ–™ã€‚
         * ç—…æ­·è¨˜éŒ„å°‡åœ¨å¯¦éš›éœ€è¦é¡¯ç¤ºæˆ–æ“ä½œæ™‚å†å€‹åˆ¥æŸ¥è©¢ï¼Œ
         * ä»¥é™ä½Žåˆå§‹åŒ–æ™‚çš„è®€å–é‡ã€‚
         *
         * æ­¤è™•å…ˆå¾žæœ¬åœ°å­˜å„²è®€å–ä»»ä½•å·²ç·©å­˜çš„è¨ºç™‚è¨˜éŒ„ï¼Œ
         * è‹¥ç„¡ç·©å­˜å‰‡ä¿æŒç©ºé™£åˆ—ï¼Œå¾…ä½¿ç”¨æ™‚å†è®€å–ã€‚
         */
        try {
            const storedConsultations = localStorage.getItem('consultations');
            if (storedConsultations) {
                const parsed = JSON.parse(storedConsultations);
                if (Array.isArray(parsed)) {
                    consultations = parsed;
                } else {
                    consultations = [];
                }
            } else {
                consultations = [];
            }
        } catch (e) {
            console.warn('è®€å–æœ¬åœ°è¨ºç™‚è¨˜éŒ„å¿«å–æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
            consultations = [];
        }
        console.log('ç™»å…¥å¾Œç³»çµ±è³‡æ–™åˆå§‹åŒ–å®Œæˆï¼ˆä¸è‡ªå‹•è®€å–è¨ºç™‚è¨˜éŒ„ï¼‰');
    } catch (error) {
        console.error('åˆå§‹åŒ–ç³»çµ±è³‡æ–™å¤±æ•—:', error);
        consultations = [];
    }
    // ä¸åœ¨æ­¤è™•æ›´æ–°çµ±è¨ˆæˆ–è®€å–æŽ›è™Ÿ/ç—…äººè³‡æ–™ã€‚å¯¦æ™‚æŽ›è™Ÿç›£è½å°‡åœ¨å¾ŒçºŒè™•ç†ã€‚
    // ä¸åœ¨æ­¤è™•å•Ÿå‹•æŽ›è™Ÿå¯¦æ™‚ç›£è½ã€‚æ”¹ç‚ºåœ¨é€²å…¥æŽ›è™Ÿç³»çµ±é é¢æ™‚æ‰å•Ÿå‹•ç›£è½ï¼Œé¿å…åœ¨å…¶ä»–é é¢ä¹ŸæŒçºŒè®€å–æŽ›è™Ÿè³‡æ–™ã€‚
}



        // è¨ºæ‰€è¨­å®šç®¡ç†åŠŸèƒ½
        function showClinicSettingsModal() {
            // è¼‰å…¥ç¾æœ‰è¨­å®š
            document.getElementById('clinicChineseName').value = clinicSettings.chineseName || '';
            document.getElementById('clinicEnglishName').value = clinicSettings.englishName || '';
            document.getElementById('clinicBusinessHours').value = clinicSettings.businessHours || '';
            document.getElementById('clinicPhone').value = clinicSettings.phone || '';
            document.getElementById('clinicAddress').value = clinicSettings.address || '';
            
            document.getElementById('clinicSettingsModal').classList.remove('hidden');
        }
        
        function hideClinicSettingsModal() {
            document.getElementById('clinicSettingsModal').classList.add('hidden');
        }
        
        function saveClinicSettings() {
            const chineseName = document.getElementById('clinicChineseName').value.trim();
            const englishName = document.getElementById('clinicEnglishName').value.trim();
            const businessHours = document.getElementById('clinicBusinessHours').value.trim();
            const phone = document.getElementById('clinicPhone').value.trim();
            const address = document.getElementById('clinicAddress').value.trim();
            
            if (!chineseName) {
                showToast('è«‹è¼¸å…¥è¨ºæ‰€ä¸­æ–‡åç¨±ï¼', 'error');
                return;
            }
            
            // æ›´æ–°è¨ºæ‰€è¨­å®š
            clinicSettings.chineseName = chineseName;
            clinicSettings.englishName = englishName;
            clinicSettings.businessHours = businessHours;
            clinicSettings.phone = phone;
            clinicSettings.address = address;
            clinicSettings.updatedAt = new Date().toISOString();
            
            // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜
            localStorage.setItem('clinicSettings', JSON.stringify(clinicSettings));
            
            // æ›´æ–°ç³»çµ±ç®¡ç†é é¢çš„é¡¯ç¤º
            updateClinicSettingsDisplay();
            
            hideClinicSettingsModal();
            showToast('è¨ºæ‰€è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
        }
        
        function updateClinicSettingsDisplay() {
            // æ›´æ–°ç³»çµ±ç®¡ç†é é¢çš„è¨ºæ‰€è¨­å®šé¡¯ç¤º
            const chineseNameSpan = document.getElementById('displayChineseName');
            const englishNameSpan = document.getElementById('displayEnglishName');
            
            if (chineseNameSpan) {
                chineseNameSpan.textContent = clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±';
            }
            if (englishNameSpan) {
                englishNameSpan.textContent = clinicSettings.englishName || 'Dr.Great Clinic';
            }
            
            // æ›´æ–°ç™»å…¥é é¢çš„è¨ºæ‰€åç¨±
            const loginTitle = document.getElementById('loginTitle');
            const loginEnglishTitle = document.getElementById('loginEnglishTitle');
            if (loginTitle) {
                loginTitle.textContent = clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±';
            }
            if (loginEnglishTitle) {
                loginEnglishTitle.textContent = clinicSettings.englishName || 'Dr.Great Clinic';
            }
            
            // æ›´æ–°ä¸»é é¢çš„è¨ºæ‰€åç¨±
            const systemTitle = document.getElementById('systemTitle');
            const systemEnglishTitle = document.getElementById('systemEnglishTitle');
            if (systemTitle) {
                systemTitle.textContent = clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±';
            }
            if (systemEnglishTitle) {
                systemEnglishTitle.textContent = clinicSettings.englishName || 'Dr.Great Clinic';
            }
            
            // æ›´æ–°æ­¡è¿Žé é¢çš„è¨ºæ‰€åç¨±
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeEnglishTitle = document.getElementById('welcomeEnglishTitle');
            if (welcomeTitle) {
                welcomeTitle.textContent = `æ­¡è¿Žä½¿ç”¨${clinicSettings.chineseName || 'åé†«è¨ºæ‰€ç³»çµ±'}`;
            }
            if (welcomeEnglishTitle) {
                welcomeEnglishTitle.textContent = `Welcome to ${clinicSettings.englishName || 'Dr.Great Clinic'}`;
            }
        }



        // ä¸­è—¥åº«ç®¡ç†åŠŸèƒ½
        let editingHerbId = null;
        let editingFormulaId = null;
        let currentHerbFilter = 'all';
        
        async function loadHerbLibrary() {
            // è‹¥å°šæœªè¼‰å…¥ä¸­è—¥åº«è³‡æ–™ï¼Œæ‰å¾ž Firestore é‡æ–°è¼‰å…¥
            if (typeof initHerbLibrary === 'function' && (!Array.isArray(herbLibrary) || herbLibrary.length === 0)) {
                await initHerbLibrary();
            }
            // åˆå§‹åŒ–åº«å­˜è³‡æ–™
            if (typeof initHerbInventory === 'function') {
                await initHerbInventory();
            }
            // è¨­ç½®åº«å­˜é¡žåž‹ä¸‹æ‹‰é¸å–®çš„é è¨­å€¼
            try {
                const invSelect = document.getElementById('inventoryTypeSelect');
                if (invSelect) {
                    invSelect.value = currentInventoryMode || 'granule';
                }
            } catch (_e) {
                // å¿½ç•¥
            }
            // è¨ˆç®—å…¨é™¢ä¸­è—¥åŠæ–¹åŠ‘ä½¿ç”¨æ¬¡æ•¸ï¼Œä¾›æŽ’åºèˆ‡å¡ç‰‡é¡¯ç¤º
            if (typeof computeGlobalUsageCounts === 'function') {
                try {
                    await computeGlobalUsageCounts();
                } catch (_e) {
                    console.error('è¨ˆç®—å…¨é™¢ä½¿ç”¨æ¬¡æ•¸å¤±æ•—ï¼š', _e);
                }
            }
            displayHerbLibrary();
            
            // æœå°‹åŠŸèƒ½ï¼šç•¶æœå°‹æ¢ä»¶è®ŠåŒ–æ™‚é‡ç½®è‡³ç¬¬ä¸€é ä¸¦é‡æ–°æ¸²æŸ“
            const searchInput = document.getElementById('searchHerb');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    paginationSettings.herbLibrary.currentPage = 1;
                    displayHerbLibrary();
                });
            }
        }
        
        function filterHerbLibrary(type) {
            currentHerbFilter = type;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`filter-${type}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            // åˆ‡æ›åˆ†é¡žæ™‚é‡ç½®è‡³ç¬¬ä¸€é ä¸¦é‡æ–°æ¸²æŸ“
            paginationSettings.herbLibrary.currentPage = 1;
            displayHerbLibrary();
        }
        
        function displayHerbLibrary() {
            const searchTerm = document.getElementById('searchHerb').value.toLowerCase();
            const listContainer = document.getElementById('herbLibraryList');

            // åœ¨æœå°‹æ¢ä»¶ä¸‹çµ±è¨ˆä¸­è—¥åº«æ•¸é‡ï¼Œç„¡è«–ç•¶å‰ç¯©é¸é¡žåž‹ç‚ºä½•ã€‚
            // é€™å…è¨±ã€Œå…¨éƒ¨ã€æŒ‰éˆ•é¡¯ç¤ºåŒ…æ‹¬ä¸­è—¥æèˆ‡æ–¹åŠ‘çš„ç¸½æ•¸é‡ã€‚
            // å¦å¤–ä¹Ÿæ›´æ–°ã€Œä¸­è—¥æã€åŠã€Œæ–¹åŠ‘ã€æŒ‰éˆ•çš„æ•¸é‡æç¤ºï¼Œä»¥ä¾¿ä½¿ç”¨è€…å¿«é€Ÿçž­è§£å„é¡žåž‹ç¸½æ•¸ã€‚
            (function updateHerbFilterCounts() {
                /**
                 * æ ¹æ“šæœå°‹æ¢ä»¶éŽæ¿¾ herbLibraryã€‚
                 * ç‚ºäº†è®“ä½¿ç”¨è€…èƒ½å¤ æœå°‹åˆ°ä¸­è—¥ææˆ–æ–¹åŠ‘çš„è©³ç´°å…§å®¹ï¼Œ
                 * ä¸å†åƒ…åƒ…æ¯”å°åç¨±æˆ–åˆ¥åï¼Œè€Œæ˜¯å°‡ç‰©ä»¶çš„æ‰€æœ‰ä¸»è¦æ¬„ä½
                 * ï¼ˆå­—ä¸²æˆ–æ•¸å€¼ï¼‰åˆä½µç‚ºä¸€æ®µæ–‡å­—é€²è¡Œæœå°‹ã€‚
                 * é€™æ¨£å¯ä»¥æ”¯æ´æœå°‹æ€§å‘³ã€æ­¸ç¶“ã€ä¸»æ²»ã€ç”¨æ³•ç­‰å…§å®¹ã€‚
                 */
                const searchFiltered = Array.isArray(herbLibrary) ? herbLibrary.filter(item => {
                    try {
                        // å°‡æ‰€æœ‰å€¼è½‰ç‚ºå­—ä¸²ä¸¦åˆä½µï¼Œç”¨æ–¼å…¨æ–‡æœå°‹
                        let combined = '';
                        Object.keys(item).forEach(key => {
                            if (key === 'id' || key === 'type') return;
                            const v = item[key];
                            if (!v) return;
                            if (Array.isArray(v)) {
                                combined += ' ' + v.join(' ');
                            } else if (typeof v === 'string' || typeof v === 'number') {
                                combined += ' ' + String(v);
                            }
                        });
                        combined = combined.toLowerCase();
                        return combined.includes(searchTerm);
                    } catch (_e) {
                        return false;
                    }
                }) : [];
                // è¨ˆç®—å„é¡žåˆ¥ç¸½æ•¸æ™‚æŽ’é™¤å·²åœç”¨çš„ä¸­è—¥æ/æ–¹åŠ‘ã€‚
                let totalAll = 0;
                let totalHerbsAll = 0;
                let totalFormulasAll = 0;
                // éæ­·æœå°‹å¾Œçš„åˆ—è¡¨ä¸¦ç´¯è¨ˆéžåœç”¨é …ç›®
                searchFiltered.forEach(item => {
                    let isDisabled = false;
                    try {
                        if (typeof getHerbInventory === 'function') {
                            const inv = getHerbInventory(item.id);
                            isDisabled = inv && inv.disabled;
                        }
                    } catch (_e) {
                        isDisabled = false;
                    }
                    // åªæœ‰åœ¨æœªè¢«åœç”¨æ™‚æ‰ç´å…¥çµ±è¨ˆ
                    if (!isDisabled) {
                        totalAll++;
                        if (item.type === 'herb') totalHerbsAll++;
                        if (item.type === 'formula') totalFormulasAll++;
                    }
                });
                // æ–°å¢žè¨ˆç®—å·²åœç”¨è³‡æ–™æ•¸é‡ï¼šæ ¹æ“šåº«å­˜è³‡è¨Šä¸­çš„ disabled å±¬æ€§
                const totalDisabledAll = searchFiltered.filter(item => {
                    try {
                        if (typeof getHerbInventory === 'function') {
                            const inv = getHerbInventory(item.id);
                            return inv && inv.disabled;
                        }
                    } catch (_e) {
                        // å¿½ç•¥éŒ¯èª¤
                    }
                    return false;
                }).length;
                // æ›´æ–°å„åˆ†é¡žæŒ‰éˆ•çš„é¡¯ç¤ºæ–‡å­—
                const allBtn = document.getElementById('filter-all');
                if (allBtn) {
                    allBtn.innerHTML = `å…¨éƒ¨ (${totalAll})`;
                }
                const herbBtn = document.getElementById('filter-herb');
                if (herbBtn) {
                    herbBtn.innerHTML = `ä¸­è—¥æ (${totalHerbsAll})`;
                }
                const formulaBtn = document.getElementById('filter-formula');
                if (formulaBtn) {
                    formulaBtn.innerHTML = `æ–¹åŠ‘ (${totalFormulasAll})`;
                }
                // æ›´æ–°å·²åœç”¨åˆ†é¡žæŒ‰éˆ•çš„é¡¯ç¤ºæ–‡å­—
                const disabledBtn = document.getElementById('filter-disabled');
                if (disabledBtn) {
                    disabledBtn.innerHTML = `å·²åœç”¨ (${totalDisabledAll})`;
                }
            })();
            // éŽæ¿¾è³‡æ–™ï¼šåŒæ¨£ä½¿ç”¨å…¨æ–‡æœå°‹ï¼Œä¸¦æ ¹æ“šé¡žåž‹ç¯©é¸
            let filteredItems = Array.isArray(herbLibrary) ? herbLibrary.filter(item => {
                let matchesSearch = true;
                try {
                    let combined = '';
                    Object.keys(item).forEach(key => {
                        if (key === 'id' || key === 'type') return;
                        const v = item[key];
                        if (!v) return;
                        if (Array.isArray(v)) {
                            combined += ' ' + v.join(' ');
                        } else if (typeof v === 'string' || typeof v === 'number') {
                            combined += ' ' + String(v);
                        }
                    });
                    combined = combined.toLowerCase();
                    matchesSearch = combined.includes(searchTerm);
                } catch (_e) {
                    matchesSearch = false;
                }
                // æ ¹æ“šç•¶å‰åˆ†é¡žç¯©é¸ã€‚
                let matchesFilter = false;
                if (currentHerbFilter === 'all') {
                    matchesFilter = true;
                } else if (currentHerbFilter === 'herb') {
                    matchesFilter = item.type === 'herb';
                } else if (currentHerbFilter === 'formula') {
                    matchesFilter = item.type === 'formula';
                } else if (currentHerbFilter === 'disabled') {
                    // å·²åœç”¨ï¼šéœ€è¦æª¢æŸ¥åº«å­˜è³‡è¨Šçš„ disabled å±¬æ€§
                    try {
                        if (typeof getHerbInventory === 'function') {
                            const inv = getHerbInventory(item.id);
                            matchesFilter = inv && inv.disabled;
                        }
                    } catch (_e) {
                        matchesFilter = false;
                    }
                }
                return matchesSearch && matchesFilter;
            }) : [];
            // ä¾ç…§åœç”¨ç‹€æ…‹èˆ‡æŽ’åºæ¢ä»¶é‡æ–°æŽ’åº filteredItems
            try {
                filteredItems.sort((a, b) => {
                    // å–å¾—åœç”¨ç‹€æ…‹ï¼Œåœç”¨é …ç›®æ‡‰æŽ’åœ¨æœ€æœ«
                    let invA = { disabled: false };
                    let invB = { disabled: false };
                    try {
                        if (typeof getHerbInventory === 'function') {
                            invA = getHerbInventory(a.id) || { disabled: false };
                            invB = getHerbInventory(b.id) || { disabled: false };
                        }
                    } catch (_e) {
                        invA = { disabled: false };
                        invB = { disabled: false };
                    }
                    const disA = invA && invA.disabled ? 1 : 0;
                    const disB = invB && invB.disabled ? 1 : 0;
                    if (disA !== disB) {
                        // åœç”¨ (1) æŽ’åœ¨å•Ÿç”¨ (0) ä¹‹å¾Œ
                        return disA - disB;
                    }
                    // å¦‚æžœå·²é¸æ“‡æŽ’åºæ–¹å¼ï¼Œå‰‡åœ¨éžåœç”¨æ¢ä»¶ä¸‹é€²è¡Œåº«å­˜æˆ–ä½¿ç”¨æ¬¡æ•¸æŽ’åº
                    if (herbSortOrder) {
                        // åº«å­˜æŽ’åº
                        if (herbSortOrder === 'most' || herbSortOrder === 'least') {
                            const qtyA = invA && typeof invA.quantity === 'number' ? invA.quantity : 0;
                            const qtyB = invB && typeof invB.quantity === 'number' ? invB.quantity : 0;
                            return herbSortOrder === 'most' ? qtyB - qtyA : qtyA - qtyB;
                        }
                        // ä½¿ç”¨æ¬¡æ•¸æŽ’åº
                        if (herbSortOrder === 'useMost' || herbSortOrder === 'useLeast') {
                            const countA = (typeof a.usageCount === 'number') ? a.usageCount : 0;
                            const countB = (typeof b.usageCount === 'number') ? b.usageCount : 0;
                            return herbSortOrder === 'useMost' ? countB - countA : countA - countB;
                        }
                    }
                    // è‹¥æœªè¨­å®šæŽ’åºæ–¹å¼ï¼Œæˆ–æŽ’åºæ¯”è¼ƒå€¼ç›¸åŒï¼Œä¿æŒåŽŸé †åº
                    return 0;
                });
            } catch (_e) {
                // è‹¥æŽ’åºéŽç¨‹å‡ºç¾éŒ¯èª¤å‰‡å¿½ç•¥æŽ’åº
            }
            // è‹¥ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºä¸¦æ¸…é™¤åˆ†é 
            if (!filteredItems || filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ðŸŒ¿</div>
                        <div class="text-lg font-medium mb-2">æ²’æœ‰æ‰¾åˆ°ç›¸é—œè³‡æ–™</div>
                        <div class="text-sm">è«‹å˜—è©¦å…¶ä»–æœå°‹æ¢ä»¶æˆ–æ–°å¢žä¸­è—¥æ/æ–¹åŠ‘</div>
                    </div>
                `;
                // éš±è—åˆ†é å®¹å™¨
                const paginEl = ensurePaginationContainer('herbLibraryList', 'herbLibraryPagination');
                if (paginEl) {
                    paginEl.innerHTML = '';
                    paginEl.classList.add('hidden');
                }
                return;
            }
            // è¨ˆç®—åˆ†é ä¸¦å–å¾—ç•¶å‰é è³‡æ–™
            const totalItems = filteredItems.length;
            const itemsPerPage = paginationSettings.herbLibrary.itemsPerPage;
            let currentPage = paginationSettings.herbLibrary.currentPage;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            // é˜²æ­¢ç•¶å‰é è¶…å‡ºç¯„åœ
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            paginationSettings.herbLibrary.currentPage = currentPage;
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = filteredItems.slice(startIdx, endIdx);
            // è¨ˆç®—ç•¶å‰ç¯©é¸æ¢ä»¶ä¸‹å„é¡žåž‹çš„ç¸½æ•¸ï¼ˆéžé é¢æ•¸é‡ï¼‰
            // herbLibrary åŒ…å«ä¸­è—¥æèˆ‡æ–¹åŠ‘å…©ç¨®é¡žåž‹ï¼Œé€™è£¡çµ±è¨ˆçš„æ˜¯åœ¨ç¯©é¸æ¢ä»¶ä¸‹
            // æ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®ç¸½æ•¸ï¼Œé¿å…åªé¡¯ç¤ºç•¶å‰é çš„æ•¸é‡
            // è¨ˆç®—ç¯©é¸å¾Œä¸­è—¥æèˆ‡æ–¹åŠ‘çš„æ•¸é‡ã€‚
            // é è¨­æŽ’é™¤åœç”¨è³‡æ–™ï¼Œé™¤éžç•¶å‰åˆ†é¡žæ˜¯ disabledï¼Œå‰‡è¨ˆç®—åœç”¨è³‡æ–™ã€‚
            let totalHerbsInFiltered = 0;
            let totalFormulasInFiltered = 0;
            filteredItems.forEach(item => {
                if (item.type === 'herb') {
                    let isDisabled = false;
                    try {
                        if (typeof getHerbInventory === 'function') {
                            const inv = getHerbInventory(item.id);
                            isDisabled = inv && inv.disabled;
                        }
                    } catch (_e) {
                        isDisabled = false;
                    }
                    // æŽ’é™¤åœç”¨é …ç›®ï¼Œé™¤éžç•¶å‰åˆ†é¡žç‚º disabled
                    if (currentHerbFilter === 'disabled' || !isDisabled) {
                        totalHerbsInFiltered++;
                    }
                } else if (item.type === 'formula') {
                    let isDisabled = false;
                    try {
                        if (typeof getHerbInventory === 'function') {
                            const inv = getHerbInventory(item.id);
                            isDisabled = inv && inv.disabled;
                        }
                    } catch (_e) {
                        isDisabled = false;
                    }
                    if (currentHerbFilter === 'disabled' || !isDisabled) {
                        totalFormulasInFiltered++;
                    }
                }
            });
            // æŒ‰é¡žåž‹åˆ†çµ„é¡¯ç¤ºåˆ†é è³‡æ–™
            const herbsInPage = pageItems.filter(item => item.type === 'herb');
            const formulasInPage = pageItems.filter(item => item.type === 'formula');
            let html = '';
            if (herbsInPage.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'herb' || currentHerbFilter === 'disabled')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ðŸŒ¿</span>ä¸­è—¥æ (${totalHerbsInFiltered})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${herbsInPage.map(herb => createHerbCard(herb)).join('')}
                        </div>
                    </div>
                `;
            }
            if (formulasInPage.length > 0 && (currentHerbFilter === 'all' || currentHerbFilter === 'formula' || currentHerbFilter === 'disabled')) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ðŸ“‹</span>æ–¹åŠ‘ (${totalFormulasInFiltered})
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${formulasInPage.map(formula => createFormulaCard(formula)).join('')}
                        </div>
                    </div>
                `;
            }
            listContainer.innerHTML = html;
            // ç”¢ç”Ÿåˆ†é æŽ§åˆ¶
            const paginationEl = ensurePaginationContainer('herbLibraryList', 'herbLibraryPagination');
            renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
                paginationSettings.herbLibrary.currentPage = newPage;
                displayHerbLibrary();
            }, paginationEl);
        }
        
        function createHerbCard(herb) {
            // ç‚ºé¿å… XSSï¼Œå°æ–‡å­—å…§å®¹é€²è¡Œè½‰ç¾©
            const safeName = window.escapeHtml(herb.name);
            const safeAlias = herb.alias ? window.escapeHtml(herb.alias) : null;
            // Retrieve englishName if available and escape it. englishName contains the romanised
            // name generated from the herb name. It may be undefined for legacy data. When
            // displaying the card we choose between the Chinese name or the English name based
            // on the current language stored in localStorage (default is zh). This mirrors
            // the behaviour used for acupoint cards: in English mode we hide the Chinese
            // name and show only the pinyin/English name, while in Chinese mode we show
            // only the Chinese name.
            const safeEnglishName = herb.englishName ? window.escapeHtml(herb.englishName) : null;
            // Determine which name to display
            let displayName = safeName;
            try {
                const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                if (langSel && langSel.toLowerCase().startsWith('en')) {
                    // In English mode prefer the englishName. If englishName is not
                    // available fall back to the Chinese name.
                    displayName = safeEnglishName || safeName;
                }
            } catch (_e) {
                // If accessing localStorage fails just use the Chinese name
                displayName = safeName;
            }
            // æ–°å¢žæ€§å‘³ã€æ­¸ç¶“èˆ‡ä¸»æ²»æ¬„ä½çš„è½‰ç¾©è™•ç†
            const safeNature = herb.nature ? window.escapeHtml(herb.nature) : null;
            const safeMeridian = herb.meridian ? window.escapeHtml(herb.meridian) : null;
            const safeEffects = herb.effects ? window.escapeHtml(herb.effects) : null;
            const safeIndications = herb.indications ? window.escapeHtml(herb.indications) : null;
            const safeDosage = herb.dosage ? window.escapeHtml(String(herb.dosage)) : null;
            const safeCautions = herb.cautions ? window.escapeHtml(herb.cautions) : null;
            // ä¸­è—¥å¡ç‰‡ï¼šåƒ…é¡¯ç¤ºè³‡è¨Šï¼Œä¸æä¾›ç·¨è¼¯/åˆªé™¤æ“ä½œ
            // å–å¾—åº«å­˜è³‡æ–™ï¼ˆå«åœç”¨ç‹€æ…‹ï¼‰
            const inv = typeof getHerbInventory === 'function' ? getHerbInventory(herb.id) : { quantity: 0, threshold: 0 };
            // åˆ¤æ–·æ˜¯å¦åœç”¨ä»¥æ±ºå®šç‹€æ…‹æ¨™ç±¤
            const isDisabled = inv && inv.disabled ? true : false;
            const statusLabel = isDisabled ? 'åœç”¨' : 'å•Ÿç”¨';
            // Tailwind æ¨£å¼ï¼šåœç”¨ç”¨ç´…è‰²èƒŒæ™¯ï¼Œå•Ÿç”¨ç”¨ç¶ è‰²èƒŒæ™¯
            const statusClass = isDisabled ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
            const qty = inv && typeof inv.quantity === 'number' ? inv.quantity : 0;
            const thr = inv && typeof inv.threshold === 'number' ? inv.threshold : 0;
            const unit = (inv && inv.unit) ? inv.unit : 'g';
            const factor = UNIT_FACTOR_MAP[unit] || 1;
            const qtyDisplay = (() => {
                const val = qty / factor;
                return parseFloat(val.toFixed(3)).toString();
            })();
            const thrDisplay = (() => {
                const val = thr / factor;
                return parseFloat(val.toFixed(3)).toString();
            })();
            // Translate unit label and inventory/alert labels based on current language
            const rawUnitLabel = UNIT_FACTOR_MAP && UNIT_LABEL_MAP ? UNIT_LABEL_MAP[unit] || 'å…‹' : 'å…‹';
            const unitLabelTranslated = (typeof window.t === 'function') ? window.t(rawUnitLabel) : rawUnitLabel;
            const inventoryLabel = (typeof window.t === 'function') ? window.t('åº«å­˜ï¼š') : 'åº«å­˜ï¼š';
            const alertLabel = (typeof window.t === 'function') ? window.t('è­¦æˆ’ï¼š') : 'è­¦æˆ’ï¼š';
            const stockColor = qty <= thr ? 'text-red-600 font-bold' : 'text-green-600';
            const inventoryHtml = `
                <div class="mt-2 flex flex-col sm:flex-row items-center text-xs gap-x-3 gap-y-1">
                    <div class="whitespace-nowrap"><span class="font-medium text-gray-700">${inventoryLabel}</span><span class="${stockColor}"> ${qtyDisplay}${unitLabelTranslated}</span></div>
                    <div class="whitespace-nowrap"><span class="font-medium text-gray-700">${alertLabel}</span><span class="text-gray-600"> ${thrDisplay}${unitLabelTranslated}</span></div>
                    <button onclick="openInventoryModal('${herb.id}')" class="mt-2 sm:mt-0 sm:ml-auto bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded">ç·¨è¼¯åº«å­˜</button>
                </div>
            `;
            // Build usage display based on language
            const usageCount = herb.usageCount || 0;
            const usageText = (() => {
                try {
                    const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                    if (langSel && langSel.toLowerCase().startsWith('en')) {
                        return `Used ${usageCount} times`;
                    }
                } catch (_e) {
                    // ignore errors reading localStorage
                }
                return `ä½¿ç”¨ ${usageCount} æ¬¡`;
            })();
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${displayName}</h4>
                            ${safeAlias ? `<p class="text-sm text-gray-600">${safeAlias}</p>` : ''}
                        </div>
                        <span class="ml-2 text-xs px-2 py-1 rounded ${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="space-y-2 text-sm">
                        ${safeNature ? `<div><span class="font-medium text-gray-700">æ€§å‘³ï¼š</span>${safeNature}</div>` : ''}
                        ${safeMeridian ? `<div><span class="font-medium text-gray-700">æ­¸ç¶“ï¼š</span>${safeMeridian}</div>` : ''}
                        ${safeEffects ? `<div><span class="font-medium text-gray-700">åŠŸæ•ˆï¼š</span>${safeEffects}</div>` : ''}
                        ${safeIndications ? `<div><span class="font-medium text-gray-700">ä¸»æ²»ï¼š</span>${safeIndications}</div>` : ''}
                        ${safeDosage ? `<div><span class="font-medium text-gray-700">åŠ‘é‡ï¼š</span><span class="text-blue-600 font-medium">${safeDosage}</span></div>` : ''}
                        ${safeCautions ? `<div><span class="font-medium text-red-600">æ³¨æ„ï¼š</span><span class="text-red-700">${safeCautions}</span></div>` : ''}
                    </div>
                    ${inventoryHtml}
                    <div class="mt-2 text-xs text-gray-500 text-right">${usageText}</div>
                </div>
            `;
        }
        
        function createFormulaCard(formula) {
            // ç‚ºé¿å… XSSï¼Œå°æ–‡å­—å…§å®¹é€²è¡Œè½‰ç¾©
            const safeName = window.escapeHtml(formula.name);
            // Retrieve englishName if available and escape it. englishName contains
            // the romanised name derived from the formula name. It may be undefined
            // for legacy data. Similar to herbs and acupoints, we decide between
            // the Chinese name and the English name based on the current language
            // setting stored in localStorage. In English mode only the englishName
            // is displayed; in Chinese mode only the Chinese name is shown.
            const safeEnglishName = formula.englishName ? window.escapeHtml(formula.englishName) : null;
            let displayName = safeName;
            try {
                const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                if (langSel && langSel.toLowerCase().startsWith('en')) {
                    displayName = safeEnglishName || safeName;
                }
            } catch (_e) {
                displayName = safeName;
            }
            const safeSource = formula.source ? window.escapeHtml(formula.source) : null;
            const safeEffects = formula.effects ? window.escapeHtml(formula.effects) : null;
            // æ–°å¢žä¸»æ²»èˆ‡ç”¨æ³•æ¬„ä½çš„è½‰ç¾©è™•ç†
            const safeIndications = formula.indications ? window.escapeHtml(formula.indications) : null;
            const safeComposition = formula.composition ? window.escapeHtml(formula.composition).replace(/\n/g, '<br>') : null;
            const safeUsage = formula.usage ? window.escapeHtml(formula.usage) : null;
            const safeCautions = formula.cautions ? window.escapeHtml(formula.cautions) : null;
            // æ–¹åŠ‘å¡ç‰‡ï¼šåƒ…é¡¯ç¤ºè³‡è¨Šï¼Œä¸æä¾›ç·¨è¼¯/åˆªé™¤æ“ä½œ
            // å–å¾—åº«å­˜è³‡æ–™ï¼ˆå«åœç”¨ç‹€æ…‹ï¼‰
            const inv = typeof getHerbInventory === 'function' ? getHerbInventory(formula.id) : { quantity: 0, threshold: 0 };
            // åˆ¤æ–·æ˜¯å¦åœç”¨ä»¥æ±ºå®šç‹€æ…‹æ¨™ç±¤
            const isDisabled = inv && inv.disabled ? true : false;
            const statusLabel = isDisabled ? 'åœç”¨' : 'å•Ÿç”¨';
            const statusClass = isDisabled ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
            const qty = inv && typeof inv.quantity === 'number' ? inv.quantity : 0;
            const thr = inv && typeof inv.threshold === 'number' ? inv.threshold : 0;
            const unit = (inv && inv.unit) ? inv.unit : 'g';
            const factor = UNIT_FACTOR_MAP[unit] || 1;
            const qtyDisplay = (() => {
                const val = qty / factor;
                return parseFloat(val.toFixed(3)).toString();
            })();
            const thrDisplay = (() => {
                const val = thr / factor;
                return parseFloat(val.toFixed(3)).toString();
            })();
            const rawUnitLabel = UNIT_LABEL_MAP[unit] || 'å…‹';
            const unitLabelTranslated = (typeof window.t === 'function') ? window.t(rawUnitLabel) : rawUnitLabel;
            const inventoryLabel = (typeof window.t === 'function') ? window.t('åº«å­˜ï¼š') : 'åº«å­˜ï¼š';
            const alertLabel = (typeof window.t === 'function') ? window.t('è­¦æˆ’ï¼š') : 'è­¦æˆ’ï¼š';
            const stockColor = qty <= thr ? 'text-red-600 font-bold' : 'text-green-600';
            const inventoryHtml = `
                <div class="mt-2 flex flex-col sm:flex-row items-center text-xs gap-x-3 gap-y-1">
                    <div class="whitespace-nowrap"><span class="font-medium text-gray-700">${inventoryLabel}</span><span class="${stockColor}"> ${qtyDisplay}${unitLabelTranslated}</span></div>
                    <div class="whitespace-nowrap"><span class="font-medium text-gray-700">${alertLabel}</span><span class="text-gray-600"> ${thrDisplay}${unitLabelTranslated}</span></div>
                    <button onclick="openInventoryModal('${formula.id}')" class="mt-2 sm:mt-0 sm:ml-auto bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded">ç·¨è¼¯åº«å­˜</button>
                </div>
            `;
            // Build usage display based on language
            const usageCountF = formula.usageCount || 0;
            const usageTextF = (() => {
                try {
                    const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                    if (langSel && langSel.toLowerCase().startsWith('en')) {
                        return `Used ${usageCountF} times`;
                    }
                } catch (_e) {
                    /* ignore */
                }
                return `ä½¿ç”¨ ${usageCountF} æ¬¡`;
            })();
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">${displayName}</h4>
                            ${safeSource ? `<p class="text-sm text-gray-600">å‡ºè™•ï¼š${safeSource}</p>` : ''}
                        </div>
                        <span class="ml-2 text-xs px-2 py-1 rounded ${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="space-y-3 text-sm">
                        ${safeEffects ? `<div><span class="font-medium text-gray-700">åŠŸæ•ˆï¼š</span>${safeEffects}</div>` : ''}
                        ${safeIndications ? `<div><span class="font-medium text-gray-700">ä¸»æ²»ï¼š</span>${safeIndications}</div>` : ''}
                        ${safeComposition ? `
                            <div>
                                <span class="font-medium text-gray-700">çµ„æˆï¼š</span>
                                <div class="mt-1 p-2 bg-yellow-50 rounded text-xs whitespace-pre-line border-l-2 border-yellow-400">${safeComposition}</div>
                            </div>
                        ` : ''}
                        ${safeUsage ? `<div><span class="font-medium text-gray-700">ç”¨æ³•ï¼š</span>${safeUsage}</div>` : ''}
                        ${safeCautions ? `<div><span class="font-medium text-red-600">æ³¨æ„ï¼š</span><span class="text-red-700">${safeCautions}</span></div>` : ''}
                    </div>
                    ${inventoryHtml}
                    <div class="mt-2 text-xs text-gray-500 text-right">${usageTextF}</div>
                </div>
            `;
        }
        
        // ä¸­è—¥æè¡¨å–®åŠŸèƒ½
        function showAddHerbForm() {
            editingHerbId = null;
            document.getElementById('herbFormTitle').textContent = 'æ–°å¢žä¸­è—¥æ';
            document.getElementById('herbSaveButtonText').textContent = 'å„²å­˜';
            clearHerbForm();
            document.getElementById('addHerbModal').classList.remove('hidden');
        }
        
        function hideAddHerbForm() {
            document.getElementById('addHerbModal').classList.add('hidden');
            clearHerbForm();
            editingHerbId = null;
        }
        
        function clearHerbForm() {
            // æ¸…é™¤ä¸­è—¥æè¡¨å–®æ¬„ä½ï¼ˆåŒ…å«æ€§å‘³ã€æ­¸ç¶“èˆ‡ä¸»æ²»ï¼‰
            ['herbName', 'herbAlias', 'herbNature', 'herbMeridian', 'herbEffects', 'herbIndications', 'herbDosage', 'herbCautions', 'herbStock', 'herbThreshold'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }
        
        
        
        async function saveHerb() {
            const name = document.getElementById('herbName').value.trim();
            
            if (!name) {
                showToast('è«‹è¼¸å…¥ä¸­è—¥æåç¨±ï¼', 'error');
                return;
            }
            
            // è®€å–åº«å­˜èˆ‡è­¦æˆ’å€¼
            const stockVal = parseFloat(document.getElementById('herbStock') && document.getElementById('herbStock').value);
            const thresholdVal = parseFloat(document.getElementById('herbThreshold') && document.getElementById('herbThreshold').value);
            // çµ„åˆä¸­è—¥ç‰©ä»¶ï¼ˆåŒ…å«æ€§å‘³ã€æ­¸ç¶“èˆ‡ä¸»æ²»æ¬„ä½ï¼Œä»¥åŠåº«å­˜è³‡è¨Šï¼‰
            const herb = {
                id: editingHerbId || Date.now(),
                type: 'herb',
                name: name,
                alias: document.getElementById('herbAlias').value.trim(),
                nature: document.getElementById('herbNature').value.trim(),
                meridian: document.getElementById('herbMeridian').value.trim(),
                effects: document.getElementById('herbEffects').value.trim(),
                indications: document.getElementById('herbIndications').value.trim(),
                dosage: document.getElementById('herbDosage').value.trim(),
                cautions: document.getElementById('herbCautions').value.trim(),
                stock: isNaN(stockVal) ? 0 : stockVal,
                threshold: isNaN(thresholdVal) ? 0 : thresholdVal,
                createdAt: editingHerbId ? herbLibrary.find(h => h.id === editingHerbId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingHerbId) {
                const index = herbLibrary.findIndex(item => item.id === editingHerbId);
                herbLibrary[index] = herb;
                showToast('ä¸­è—¥æè³‡æ–™å·²æ›´æ–°ï¼', 'success');
            } else {
                herbLibrary.push(herb);
                showToast('ä¸­è—¥æå·²æ–°å¢žï¼', 'success');
            }
            // åŒæ­¥åº«å­˜è‡³ Firebase Realtime Database
            try {
                if (typeof setHerbInventory === 'function') {
                    // æ–°å¢žæˆ–æ›´æ–°ä¸­è—¥ææ™‚ï¼Œé è¨­ä½¿ç”¨å…‹ (g) ç‚ºå–®ä½å„²å­˜åº«å­˜
                    await setHerbInventory(herb.id, herb.stock, herb.threshold, 'g');
                }
            } catch (err) {
                console.error('æ›´æ–°ä¸­è—¥åº«å­˜è‡³ Firebase å¤±æ•—:', err);
            }
            // ä¸å†å°‡ä¸­è—¥æè³‡æ–™å¯«å…¥ Firestoreï¼›è³‡æ–™åƒ…ä¿ç•™æ–¼æœ¬åœ°é™£åˆ—
            hideAddHerbForm();
            displayHerbLibrary();
        }
        
        // æ–¹åŠ‘è¡¨å–®åŠŸèƒ½
        function showAddFormulaForm() {
            editingFormulaId = null;
            document.getElementById('formulaFormTitle').textContent = 'æ–°å¢žæ–¹åŠ‘';
            document.getElementById('formulaSaveButtonText').textContent = 'å„²å­˜';
            clearFormulaForm();
            document.getElementById('addFormulaModal').classList.remove('hidden');
        }
        
        function hideAddFormulaForm() {
            document.getElementById('addFormulaModal').classList.add('hidden');
            clearFormulaForm();
            editingFormulaId = null;
        }
        
        function clearFormulaForm() {
            // æ¸…é™¤æ–¹åŠ‘è¡¨å–®æ¬„ä½ï¼ˆåŒ…å«ä¸»æ²»èˆ‡ç”¨æ³•ï¼‰
            ['formulaName', 'formulaSource', 'formulaEffects', 'formulaComposition', 'formulaCautions', 'formulaIndications', 'formulaUsage', 'formulaStock', 'formulaThreshold'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }
        
        
        
        async function saveFormula() {
            const name = document.getElementById('formulaName').value.trim();
            const composition = document.getElementById('formulaComposition').value.trim();
            
            if (!name) {
                showToast('è«‹è¼¸å…¥æ–¹åŠ‘åç¨±ï¼', 'error');
                return;
            }
            
            if (!composition) {
                showToast('è«‹è¼¸å…¥æ–¹åŠ‘çµ„æˆï¼', 'error');
                return;
            }
            
            // è®€å–åº«å­˜èˆ‡è­¦æˆ’å€¼
            const stockValF = parseFloat(document.getElementById('formulaStock') && document.getElementById('formulaStock').value);
            const thresholdValF = parseFloat(document.getElementById('formulaThreshold') && document.getElementById('formulaThreshold').value);
            // çµ„åˆæ–¹åŠ‘ç‰©ä»¶ï¼ˆåŒ…å«ä¸»æ²»èˆ‡ç”¨æ³•æ¬„ä½åŠåº«å­˜è³‡è¨Šï¼‰
            const formula = {
                id: editingFormulaId || Date.now(),
                type: 'formula',
                name: name,
                source: document.getElementById('formulaSource').value.trim(),
                effects: document.getElementById('formulaEffects').value.trim(),
                indications: document.getElementById('formulaIndications').value.trim(),
                composition: composition,
                usage: document.getElementById('formulaUsage').value.trim(),
                cautions: document.getElementById('formulaCautions').value.trim(),
                stock: isNaN(stockValF) ? 0 : stockValF,
                threshold: isNaN(thresholdValF) ? 0 : thresholdValF,
                createdAt: editingFormulaId ? herbLibrary.find(f => f.id === editingFormulaId).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingFormulaId) {
                const index = herbLibrary.findIndex(item => item.id === editingFormulaId);
                herbLibrary[index] = formula;
                showToast('æ–¹åŠ‘è³‡æ–™å·²æ›´æ–°ï¼', 'success');
            } else {
                herbLibrary.push(formula);
                showToast('æ–¹åŠ‘å·²æ–°å¢žï¼', 'success');
            }
            // åŒæ­¥åº«å­˜è‡³ Firebase Realtime Database
            try {
                if (typeof setHerbInventory === 'function') {
                    // æ–°å¢žæˆ–æ›´æ–°æ–¹åŠ‘æ™‚ï¼Œé è¨­ä½¿ç”¨å…‹ (g) ç‚ºå–®ä½å„²å­˜åº«å­˜
                    await setHerbInventory(formula.id, formula.stock, formula.threshold, 'g');
                }
            } catch (err) {
                console.error('æ›´æ–°æ–¹åŠ‘åº«å­˜è‡³ Firebase å¤±æ•—:', err);
            }
            // ä¸å†å°‡æ–¹åŠ‘è³‡æ–™å¯«å…¥ Firestoreï¼›è³‡æ–™åƒ…ä¿ç•™æ–¼æœ¬åœ°é™£åˆ—
            hideAddFormulaForm();
            displayHerbLibrary();
        }
        
        


        // ç©´ä½åº«ç®¡ç†åŠŸèƒ½
        /**
         * åˆå§‹åŒ–ç©´ä½åº«è³‡æ–™ã€‚
         * å¾žæœ¬åœ° data è³‡æ–™å¤¾è®€å– acupointLibrary.jsonã€‚
         * è‹¥æª”æ¡ˆä¸å­˜åœ¨æˆ–è§£æžå¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­è³‡æ–™å¡«å……ã€‚
         * @param {boolean} forceRefresh - æ˜¯å¦å¼·åˆ¶é‡æ–°è¼‰å…¥è³‡æ–™
         */
        async function initAcupointLibrary(forceRefresh = false) {
            if (acupointLibraryLoaded && !forceRefresh) {
                return;
            }
            try {
                const data = await fetchJsonWithFallback('acupointLibrary.json');
                // æ”¯æ´è³‡æ–™æ ¹ç¯€é»žç‚º acupointLibrary æˆ–ç›´æŽ¥ç‚ºé™£åˆ—
                let items = [];
                if (data) {
                    if (Array.isArray(data)) {
                        items = data;
                    } else if (Array.isArray(data.acupointLibrary)) {
                        items = data.acupointLibrary;
                    } else if (Array.isArray(data.acupoints)) {
                        items = data.acupoints;
                    }
                }
                // ç¢ºä¿æ¯ç­†è³‡æ–™å­˜åœ¨ idï¼Œè‹¥ç¼ºå¤±å‰‡ä»¥ç•¶å‰æ™‚é–“æˆ³åŠ ç´¢å¼•ç”Ÿæˆ
                acupointLibrary = items.map((item, idx) => {
                    const newItem = { ...item };
                    if (!newItem.id) {
                        newItem.id = Date.now() + idx;
                    }
                    // è¦ç¯„ functions èˆ‡ indications ç‚ºé™£åˆ—
                    if (newItem.functions && !Array.isArray(newItem.functions)) {
                        newItem.functions = String(newItem.functions).split(/\n+/).map(s => s.trim()).filter(Boolean);
                    }
                    if (newItem.indications && !Array.isArray(newItem.indications)) {
                        newItem.indications = String(newItem.indications).split(/\n+/).map(s => s.trim()).filter(Boolean);
                    }
                    return newItem;
                });
                acupointLibraryLoaded = true;
            } catch (err) {
                console.error('ç„¡æ³•è®€å–ç©´ä½åº«è³‡æ–™ï¼š', err);
                // fallbackï¼šä½¿ç”¨é è¨­ç¯„ä¾‹è³‡æ–™
                acupointLibrary = [
                    {
                        id: Date.now(),
                        name: 'ä¸­åºœ',
                        meridian: 'æ‰‹å¤ªé™°è‚ºç¶“',
                        location: 'èƒ¸å¤–å´éƒ¨ï¼Œé›²é–€ä¸‹1å¯¸ï¼Œå¹³ç¬¬ä¸€è‚‹é–“éš™ï¼Œè·å‰æ­£ä¸­ç·š6å¯¸',
                        functions: ['å®£è‚ºç†æ°£', 'æ­¢å’³å¹³å–˜', 'æ¸…ç†±åŒ–ç—°'],
                        indications: ['å’³å—½', 'æ°£å–˜', 'èƒ¸ç—›', 'è‚©èƒŒç—›', 'çš®è†šç—…'],
                        method: 'æ–œåˆºæˆ–å¹³åˆº0.5-0.8å¯¸',
                        category: 'è‚ºä¹‹å‹Ÿç©´',
                        // createdAt èˆ‡ updatedAt ç•™åœ¨é€™è£¡ï¼Œåº§æ¨™è«‹åœ¨å¤–éƒ¨æ¨¡çµ„ acupointIntegration.js ä¸­å®šç¾©
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                acupointLibraryLoaded = true;
            }
        }

        /**
         * è¼‰å…¥ç©´ä½åº«ç®¡ç†ç•«é¢ã€‚è‹¥è³‡æ–™å°šæœªåˆå§‹åŒ–ï¼Œæœƒå…ˆè®€å–è³‡æ–™ã€‚
         * ç¶å®šæœå°‹è¼¸å…¥æ¡†çš„äº‹ä»¶ï¼Œç•¶æœå°‹å­—ä¸²è®ŠåŒ–æ™‚é‡ç½®é ç¢¼ä¸¦é‡æ–°æ¸²æŸ“åˆ—è¡¨ã€‚
         */
        async function loadAcupointLibrary() {
            // æ¬Šé™æª¢æŸ¥ï¼šè­·ç†å¸«èˆ‡è¨ºæ‰€ç®¡ç†è€…ã€é†«å¸«å¯ä½¿ç”¨ï¼›å…¶ä»–è§’è‰²ç¦æ­¢
            if (!hasAccessToSection('acupointLibrary')) {
                showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•å­˜å–ç©´ä½åº«ç®¡ç†', 'error');
                return;
            }
            // è‹¥å°šæœªè¼‰å…¥è³‡æ–™å‰‡åˆå§‹åŒ–
            if (!acupointLibraryLoaded || !Array.isArray(acupointLibrary) || acupointLibrary.length === 0) {
                await initAcupointLibrary();
            }
            // ç¶å®šæœå°‹äº‹ä»¶ï¼šåƒ…ç¶å®šä¸€æ¬¡
            const searchInput = document.getElementById('searchAcupoint');
            if (searchInput && !searchInput.dataset.listenerAdded) {
                searchInput.addEventListener('input', function() {
                    // æœå°‹æ™‚é‡ç½®é ç¢¼ç‚º 1
                    paginationSettings.acupointLibrary.currentPage = 1;
                    displayAcupointLibrary();
                });
                searchInput.dataset.listenerAdded = 'true';
            }
            // åˆæ¬¡æˆ–é‡æ–°è¼‰å…¥æ™‚é¡¯ç¤ºåˆ—è¡¨
            displayAcupointLibrary();
            // åœ¨è¼‰å…¥åˆ—è¡¨å¾Œåˆå§‹åŒ–ç©´ä½ Leaflet åœ°åœ–ï¼Œç¢ºä¿å®¹å™¨å·²å­˜åœ¨æ–¼ DOM
            if (typeof initAcupointMap === 'function') {
                try {
                    initAcupointMap();
                } catch (_err) {
                    console.warn('åˆå§‹åŒ–ç©´ä½åœ°åœ–å¤±æ•—:', _err);
                }
            }
        }

        /**
         * åˆ‡æ›ç¶“çµ¡ç¯©é¸æ¢ä»¶ä¸¦æ›´æ–°åˆ—è¡¨ã€‚
         * @param {string} meridian - ç¯©é¸çš„ç¶“çµ¡åç¨±æˆ– 'all' è¡¨ç¤ºå…¨éƒ¨
         */
        function filterAcupointLibrary(meridian) {
            currentAcupointFilter = meridian;
            // é‡ç½®ç•¶å‰é ç¢¼ç‚º 1
            paginationSettings.acupointLibrary.currentPage = 1;
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            // å–å¾—åˆ†é¡žç¯©é¸å®¹å™¨ã€‚å‰ç«¯ HTML ä½¿ç”¨ id="acupointFilterContainer"
            // é€™è£¡ä¿®æ­£åç¨±ä»¥é¿å…èˆ‡ä¸å­˜åœ¨çš„ acupointFilterButtons ä¸ç¬¦å°Žè‡´ç„¡æ³•æ›´æ–°æŒ‰éˆ•æ¨£å¼
            const container = document.getElementById('acupointFilterContainer');
            if (container) {
                Array.from(container.children).forEach(btn => {
                    btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
                });
                const safeId = meridian === 'all' ? 'all' : meridian.replace(/\s+/g, '-').replace(/[^\w-]/g, '');
                const selectedBtn = document.getElementById('acupoint-filter-' + safeId);
                if (selectedBtn) {
                    selectedBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
                }
            }
            displayAcupointLibrary();
        }

        /**
         * æ ¹æ“šæœå°‹åŠç¯©é¸æ¢ä»¶é¡¯ç¤ºç©´ä½åº«åˆ—è¡¨ï¼Œä¸¦è™•ç†åˆ†é ã€‚
         */
        function displayAcupointLibrary() {
            const listContainer = document.getElementById('acupointLibraryList');
            const searchInput = document.getElementById('searchAcupoint');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            // ä¾æœå°‹å­—ä¸²éŽæ¿¾è³‡æ–™
            const searchFiltered = Array.isArray(acupointLibrary) ? acupointLibrary.filter(item => {
                const nameMatch = item.name && item.name.toLowerCase().includes(searchTerm);
                const meridianMatch = item.meridian && item.meridian.toLowerCase().includes(searchTerm);
                const locationMatch = item.location && item.location.toLowerCase().includes(searchTerm);
                const funcMatch = item.functions && Array.isArray(item.functions) ? item.functions.join(' ').toLowerCase().includes(searchTerm) : (item.functions ? String(item.functions).toLowerCase().includes(searchTerm) : false);
                const indMatch = item.indications && Array.isArray(item.indications) ? item.indications.join(' ').toLowerCase().includes(searchTerm) : (item.indications ? String(item.indications).toLowerCase().includes(searchTerm) : false);
                // é‡æ³•/æ²»ç™‚æ–¹æ³•æœå°‹
                const methodMatch = item.method && item.method.toLowerCase().includes(searchTerm);
                // åˆ†é¡žæœå°‹
                const categoryMatch = item.category && item.category.toLowerCase().includes(searchTerm);
                return nameMatch || meridianMatch || locationMatch || funcMatch || indMatch || methodMatch || categoryMatch;
            }) : [];
            // è¨ˆç®—å„ç¶“çµ¡çš„ç¸½æ•¸é‡ï¼Œç”¨æ–¼ç¯©é¸æŒ‰éˆ•é¡¯ç¤º
            const meridianCounts = {};
            searchFiltered.forEach(item => {
                const m = item.meridian || '';
                if (!meridianCounts[m]) meridianCounts[m] = 0;
                meridianCounts[m]++;
            });
            // æ›´æ–°ç¯©é¸æŒ‰éˆ•
            // å–å¾—åˆ†é¡žç¯©é¸å®¹å™¨ã€‚å‰ç«¯ HTML ä½¿ç”¨ id="acupointFilterContainer"
            // ä¿®æ­£ ID åç¨±ï¼Œé¿å…å› ç‚ºæ‰¾ä¸åˆ°å…ƒç´ è€Œä¸é¡¯ç¤ºåˆ†é¡žæŒ‰éˆ•
            const filterContainer = document.getElementById('acupointFilterContainer');
            if (filterContainer) {
                filterContainer.innerHTML = '';
                // å…¨éƒ¨æŒ‰éˆ•
                const allBtn = document.createElement('button');
                allBtn.id = 'acupoint-filter-all';
                const totalAll = searchFiltered.length;
                allBtn.textContent = totalAll > 0 ? `å…¨éƒ¨ (${totalAll})` : 'å…¨éƒ¨ (0)';
                allBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium ' + (currentAcupointFilter === 'all' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700 hover:bg-gray-200') + ' transition duration-200';
                allBtn.addEventListener('click', () => filterAcupointLibrary('all'));
                filterContainer.appendChild(allBtn);
                // å…¶ä»–ç¶“çµ¡æŒ‰éˆ•
                Object.keys(meridianCounts).forEach(m => {
                    const btn = document.createElement('button');
                    const safeId = m.replace(/\s+/g, '-').replace(/[^\w-]/g, '');
                    btn.id = 'acupoint-filter-' + safeId;
                    btn.textContent = `${m} (${meridianCounts[m]})`;
                    btn.className = 'px-4 py-2 rounded-lg text-sm font-medium ' + (currentAcupointFilter === m ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700 hover:bg-gray-200') + ' transition duration-200';
                    btn.addEventListener('click', () => filterAcupointLibrary(m));
                    filterContainer.appendChild(btn);
                });
            }
            // æ ¹æ“šç¶“çµ¡ç¯©é¸
            const meridianFiltered = currentAcupointFilter === 'all' ? searchFiltered : searchFiltered.filter(item => item.meridian === currentAcupointFilter);
            // è‹¥ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºä¸¦éš±è—åˆ†é 
            if (!meridianFiltered || meridianFiltered.length === 0) {
                listContainer.innerHTML = `\n                    <div class="text-center py-12 text-gray-500">\n                        <div class="text-4xl mb-4">ðŸ“Œ</div>\n                        <div class="text-lg font-medium mb-2">æ²’æœ‰æ‰¾åˆ°ç›¸é—œç©´ä½</div>\n                        <div class="text-sm">è«‹å˜—è©¦å…¶ä»–æœå°‹æ¢ä»¶</div>\n                    </div>\n                `;
                const paginEl = ensurePaginationContainer('acupointLibraryList', 'acupointLibraryPagination');
                if (paginEl) {
                    paginEl.innerHTML = '';
                    paginEl.classList.add('hidden');
                }
                return;
            }
            // è¨ˆç®—åˆ†é 
            const totalItems = meridianFiltered.length;
            const itemsPerPage = paginationSettings.acupointLibrary.itemsPerPage;
            let currentPage = paginationSettings.acupointLibrary.currentPage;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            paginationSettings.acupointLibrary.currentPage = currentPage;
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = meridianFiltered.slice(startIdx, endIdx);
            // ä¾ç…§ç¶“çµ¡åˆ†çµ„
            const groups = {};
            pageItems.forEach(item => {
                const m = item.meridian || '';
                if (!groups[m]) groups[m] = [];
                groups[m].push(item);
            });
            let html = '';
            Object.keys(groups).forEach(m => {
                // å–å¾—æ­¤ç¶“çµ¡åœ¨æœå°‹æ¢ä»¶ä¸‹çš„ç¸½æ•¸é‡
                const totalForMeridian = meridianCounts[m] || groups[m].length;
                html += `\n                    <div class="mb-8">\n                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">\n                            <span class="mr-2">ðŸ“Œ</span>${window.escapeHtml(m)} (${totalForMeridian})\n                        </h3>\n                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">\n                            ${groups[m].map(ac => createAcupointCard(ac)).join('')}\n                        </div>\n                    </div>\n                `;
            });
            listContainer.innerHTML = html;
            // æ¸²æŸ“åˆ†é æŽ§åˆ¶
            const paginationEl = ensurePaginationContainer('acupointLibraryList', 'acupointLibraryPagination');
            renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
                paginationSettings.acupointLibrary.currentPage = newPage;
                displayAcupointLibrary();
            }, paginationEl);
        }

        /**
         * å»ºç«‹å–®ä¸€ç©´ä½çš„å¡ç‰‡ HTML å­—ä¸²ã€‚
         * @param {object} ac - ç©´ä½è³‡æ–™ç‰©ä»¶
         * @returns {string}
         */
        function createAcupointCard(ac) {
            // å°‡ç©´ä½åç¨±å®šç¾©ç‚ºå¯å†æŒ‡æ´¾çš„è®Šæ•¸ï¼Œä»¥ä¾¿å¾ŒçºŒä½¿ç”¨çµ„åˆåç¨±è¦†è“‹
            let safeName = window.escapeHtml(ac.name || '');
            // æ–°å¢žè‹±è­¯åç¨±èˆ‡åœ‹éš›ç·¨ç¢¼çš„è™•ç†ã€‚å¾žè³‡æ–™ä¸­è®€å–è‹±è­¯åç¨± (englishName) èˆ‡åœ‹éš›ç·¨ç¢¼ (internationalCode)ï¼Œè‹¥ä¸å­˜åœ¨å‰‡ä½¿ç”¨ç©ºå­—ä¸²ã€‚
            const safeEnglishName = ac.englishName ? window.escapeHtml(ac.englishName) : '';
            const safeCode = ac.internationalCode ? window.escapeHtml(ac.internationalCode) : '';
            // çµ„åˆé¡¯ç¤ºåç¨±ï¼šæ ¹æ“šä»‹é¢èªžè¨€æ±ºå®šæ˜¯å¦é¡¯ç¤ºä¸­æ–‡
            // å–å¾—ç›®å‰èªžè¨€è¨­å®šï¼Œé è¨­ç‚ºä¸­æ–‡ï¼ˆzhï¼‰ã€‚localStorage.getItem('lang') åœ¨è‹±æ–‡ç‰ˆæœƒæ˜¯ 'en'
            const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
            let displayName;
            if (lang === 'en' && safeEnglishName) {
                // è‹±æ–‡ä»‹é¢ï¼šåƒ…é¡¯ç¤ºè‹±æ–‡åç¨±ï¼Œä¸å«ä¸­æ–‡
                displayName = safeEnglishName;
            } else {
                // ä¸­æ–‡ä»‹é¢æˆ–æ²’æœ‰è‹±æ–‡åç¨±ï¼šåƒ…é¡¯ç¤ºä¸­æ–‡åç¨±
                displayName = safeName;
            }
            // å¦‚æœ‰åœ‹éš›ç·¨ç¢¼ï¼Œä¸€å¾‹åŠ ä¸Š (åœ‹éš›ç·¨ç¢¼)
            if (safeCode) {
                displayName += ' (' + safeCode + ')';
            }
            // å°‡çµ„åˆå¾Œçš„åç¨±è¦†è“‹å›ž safeNameï¼Œè®“å¡ç‰‡æ¨™é¡Œä½¿ç”¨
            safeName = displayName;
            const safeMeridian = ac.meridian ? window.escapeHtml(ac.meridian) : '';
            const safeLocation = ac.location ? window.escapeHtml(ac.location) : '';
            const funcs = Array.isArray(ac.functions) ? ac.functions : (ac.functions ? [ac.functions] : []);
            const inds = Array.isArray(ac.indications) ? ac.indications : (ac.indications ? [ac.indications] : []);
            const safeFunctions = funcs.length > 0 ? funcs.map(item => window.escapeHtml(item)).join('ã€') : '';
            const safeIndications = inds.length > 0 ? inds.map(item => window.escapeHtml(item)).join('ã€') : '';
            const safeMethod = ac.method ? window.escapeHtml(ac.method) : '';
            const safeCategory = ac.category ? window.escapeHtml(ac.category) : '';
            return `\n                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">\n                    <div class="flex justify-between items-start mb-3">\n                        <div>\n                            <h4 class="text-lg font-semibold text-gray-900">${safeName}</h4>\n                            ${safeMeridian ? `<p class="text-sm text-gray-600">${safeMeridian}</p>` : ''}\n                        </div>\n                    </div>\n                    <div class="space-y-2 text-sm">\n                        ${safeLocation ? `<div><span class="font-medium text-gray-700">å®šä½ï¼š</span>${safeLocation}</div>` : ''}\n                        ${safeFunctions ? `<div><span class="font-medium text-gray-700">åŠŸèƒ½ï¼š</span>${safeFunctions}</div>` : ''}\n                        ${safeIndications ? `<div><span class="font-medium text-gray-700">ä¸»æ²»ï¼š</span>${safeIndications}</div>` : ''}\n                        ${safeMethod ? `<div><span class="font-medium text-gray-700">é‡æ³•ï¼š</span>${safeMethod}</div>` : ''}\n                        ${safeCategory ? `<div><span class="font-medium text-gray-700">ç©´æ€§ï¼š</span>${safeCategory}</div>` : ''}\n                    </div>\n                </div>\n            `;
        }

        /**
         * ä»¥ä¸‹å‡½å¼èˆ‡ UI æ“ä½œç›¸é—œï¼Œç”¨æ–¼æ–°å¢žã€ç·¨è¼¯èˆ‡åˆªé™¤ç©´ä½è³‡æ–™ã€‚
         * ç¾åœ¨ç³»çµ±æ”¹ç”¨åªè®€æ¨¡å¼ï¼Œå¦‚éœ€é‡æ–°å•Ÿç”¨æ­¤åŠŸèƒ½ï¼Œå¯é‡æ–°æ’°å¯«ç›¸æ‡‰çš„è¡¨å–®èˆ‡äº‹ä»¶è™•ç†é‚è¼¯ã€‚
         */

        // æ”¶è²»é …ç›®ç®¡ç†åŠŸèƒ½
        let editingBillingItemId = null;
        let currentBillingFilter = 'all';
        
        async function loadBillingManagement() {
    // æ¬Šé™æª¢æŸ¥ï¼šè­·ç†å¸«æˆ–ä¸€èˆ¬ç”¨æˆ¶ä¸å¾—è¨ªå•æ”¶è²»é …ç›®ç®¡ç†
    if (!hasAccessToSection('billingManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•å­˜å–æ”¶è²»é …ç›®ç®¡ç†', 'error');
        return;
    }
            // æ¯æ¬¡é€²å…¥æ”¶è²»é …ç›®ç®¡ç†æ™‚ï¼Œå¼·åˆ¶å¾ž Firestore å–å¾—æœ€æ–°è³‡æ–™ï¼Œ
            // ä»¥é¿å…å…¶ä»–è£ç½®åœ¨æœ¬åœ°å„²å­˜çš„èˆŠè³‡æ–™æœªåŒæ­¥æ›´æ–°ã€‚
            if (typeof initBillingItems === 'function') {
                await initBillingItems(true);
            }
            displayBillingItems();
            
            // æœå°‹åŠŸèƒ½
            const searchInput = document.getElementById('searchBilling');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    displayBillingItems();
                });
            }
        }
        
        function filterBillingItems(category) {
            currentBillingFilter = category;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('[id^="billing-filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
            });
            document.getElementById(`billing-filter-${category}`).className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
            
            displayBillingItems();
        }
        
        function displayBillingItems() {
            const searchTerm = document.getElementById('searchBilling').value.toLowerCase();
            const listContainer = document.getElementById('billingItemsList');
            
            // éŽæ¿¾è³‡æ–™
            let filteredItems = billingItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesFilter = currentBillingFilter === 'all' || item.category === currentBillingFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            if (filteredItems.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-4">ðŸ’°</div>
                        <div class="text-lg font-medium mb-2">æ²’æœ‰æ‰¾åˆ°ç›¸é—œæ”¶è²»é …ç›®</div>
                        <div class="text-sm">è«‹å˜—è©¦å…¶ä»–æœå°‹æ¢ä»¶æˆ–æ–°å¢žæ”¶è²»é …ç›®</div>
                    </div>
                `;
                return;
            }
            
            // Determine current language and translation dictionary for category
            // names.  We use localStorage to retrieve the saved language and
            // fallback to Chinese if it isn't set.  The dictionary maps
            // Chinese terms to English equivalents, which allows us to
            // translate category names prior to appending counts.  Without
            // preâ€‘translation the dynamic strings (e.g. "è¨ºç™‚è²» (3)") would
            // not match any dictionary key and thus remain untranslated.
            const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
            const dict = (window.translations && window.translations[lang]) ? window.translations[lang] : {};

            // æŒ‰é¡žåˆ¥åˆ†çµ„é¡¯ç¤ºã€‚æ¯å€‹é¡žåˆ¥åŒ…å«ä¸€å€‹ä¸­æ–‡åç¨±ä»¥åŠå°æ‡‰åœ–ç¤ºã€‚
            const billingCategories = {
                consultation: { baseName: 'è¨ºç™‚è²»', icon: 'ðŸ©º', items: [] },
                medicine: { baseName: 'è—¥è²»', icon: 'ðŸ’Š', items: [] },
                treatment: { baseName: 'æ²»ç™‚è²»', icon: 'ðŸ”§', items: [] },
                other: { baseName: 'å…¶ä»–', icon: 'ðŸ“‹', items: [] },
                discount: { baseName: 'æŠ˜æ‰£é …ç›®', icon: 'ðŸ’¸', items: [] },
                package: { baseName: 'å¥—ç¥¨é …ç›®', icon: 'ðŸŽ«', items: [] }
            };

            // å°‡éŽæ¿¾å¾Œçš„é …ç›®åˆ†é…åˆ°å°æ‡‰çš„å¸³å–®åˆ†é¡žä¸­
            filteredItems.forEach(item => {
                if (billingCategories[item.category]) {
                    billingCategories[item.category].items.push(item);
                }
            });

            let html = '';

            // å»ºç«‹å„åˆ†é¡žçš„é¡¯ç¤ºå…§å®¹
            Object.keys(billingCategories).forEach(categoryKey => {
                const category = billingCategories[categoryKey];
                // Translate the category name based on the current language.
                // We look up the base Chinese name in the dictionary; if no
                // translation exists we fall back to the original Chinese.
                const translatedName = dict[category.baseName] || category.baseName;
                if (category.items.length > 0 && (currentBillingFilter === 'all' || currentBillingFilter === categoryKey)) {
                    html += `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">${category.icon}</span>${translatedName} (${category.items.length})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${category.items.map(item => createBillingItemCard(item)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            listContainer.innerHTML = html;
        }
        
        function createBillingItemCard(item) {
            const statusClass = item.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const statusText = item.active ? 'å•Ÿç”¨' : 'åœç”¨';
            
            // æŠ˜æ‰£é …ç›®ä½¿ç”¨ä¸åŒçš„é¡è‰²é¡¯ç¤º
            const priceColor = item.category === 'discount' ? 'text-red-600' : 'text-green-600';
            let pricePrefix = '$';
            let displayPrice = Math.abs(item.price);
            
            // è™•ç†æŠ˜æ‰£é …ç›®çš„é¡¯ç¤º
            if (item.category === 'discount') {
                if (item.price > 0 && item.price < 1) {
                    // ç™¾åˆ†æ¯”æŠ˜æ‰£ (ä¾‹å¦‚ 0.85 = 8.5 æŠ˜)ã€‚
                    // å°‡æŠ˜æ‰£å€çŽ‡ä¹˜ä»¥ 10 ä»¥å–å¾—æŠ˜æ‰£è¡¨ç¤ºï¼Œä¿ç•™ 1 ä½å°æ•¸ä»¥é¿å…å°‡ 8.5 å››æ¨äº”å…¥æˆ 9ã€‚
                    // è‹¥çµæžœç‚ºæ•´æ•¸å‰‡ä¸é¡¯ç¤ºå°æ•¸é»žã€‚
                    pricePrefix = '';
                    const discountRate = item.price * 10;
                    displayPrice = Number.isInteger(discountRate) ? discountRate : discountRate.toFixed(1);
                } else if (item.price < 0) {
                    // å›ºå®šé‡‘é¡æŠ˜æ‰£
                    pricePrefix = '-$';
                    displayPrice = Math.abs(item.price);
                }
            }
            
            // ç‚ºé¿å… XSSï¼Œå°æ–‡å­—å…§å®¹é€²è¡Œè½‰ç¾©
            const safeName = window.escapeHtml(item.name);
            const safeUnit = item.unit ? window.escapeHtml(item.unit) : null;
            const safeDescription = item.description ? window.escapeHtml(item.description) : null;
            // è®€å–è‹±è­¯åç¨±ä¸¦è½‰ç¾©ã€‚æŸäº›æ”¶è²»é …ç›®å¯èƒ½åŒ…å«è‹±æ–‡åç¨±ï¼ˆenglishNameï¼‰
            // ä»¥ä¾¿åœ¨è‹±æ–‡ä»‹é¢é¡¯ç¤ºæ™‚ä½¿ç”¨ã€‚å¦‚æžœæ²’æœ‰æä¾› englishNameï¼Œå‰‡é è¨­ç‚º nullã€‚
            const safeEnglishName = item.englishName ? window.escapeHtml(item.englishName) : null;
            // æ ¹æ“šç•¶å‰èªžè¨€é¸æ“‡é¡¯ç¤ºåç¨±ã€‚é è¨­ç‚ºä¸­æ–‡åç¨±ï¼Œè‹¥ä»‹é¢èªžè¨€ç‚ºè‹±æ–‡ä¸”
            // æœ‰æä¾›è‹±æ–‡åç¨±ï¼Œå‰‡å„ªå…ˆä½¿ç”¨è‹±æ–‡åç¨±ã€‚
            let displayName = safeName;
            try {
                const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                if (langSel && langSel.toLowerCase().startsWith('en')) {
                    displayName = safeEnglishName || safeName;
                }
            } catch (_e) {
                // è‹¥è®€å– localStorage å¤±æ•—æˆ–å…¶ä»–éŒ¯èª¤ï¼Œé€€å›žé¡¯ç¤ºä¸­æ–‡åç¨±
                displayName = safeName;
            }
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 ${!item.active ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">${displayName}</h4>
                            <div class="flex items-center mt-1">
                                <span class="text-2xl font-bold ${priceColor}">${pricePrefix}${displayPrice}</span>
                                ${safeUnit ? `<span class="text-sm text-gray-500 ml-1">/ ${safeUnit}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                            <div class="flex space-x-1">
                                <!--
                                  å°‡ id ä»¥å­—ä¸²å½¢å¼å‚³éžçµ¦ç·¨è¼¯èˆ‡åˆªé™¤å‡½å¼ï¼Œé¿å…ç•¶æ–‡ä»¶ ID ç‚º
                                  å­—ä¸²æ™‚ç”¢ç”Ÿæœªå®£å‘Šè®Šæ•¸çš„éŒ¯èª¤ã€‚ä¾‹å¦‚ Firestore ç”Ÿæˆçš„æ–‡ä»¶ ID
                                  å¤šç‚ºéš¨æ©Ÿå­—ä¸²ï¼Œè‹¥ç›´æŽ¥æ’å…¥ onclick ä¸­å°‡å°Žè‡´ç€è¦½å™¨å°‡å…¶ç•¶ä½œ
                                  è®Šæ•¸è§£æžï¼Œè§¸ç™¼ ReferenceErrorã€‚é€éŽå°‡ id åŒ…è£¹åœ¨å–®å¼•è™Ÿå…§
                                  ï¼ˆä¸¦è½‰æ›ç‚ºå­—ä¸²ï¼‰å¯ç¢ºä¿ onclick ä¸­å‚³éžçš„åƒæ•¸æ­£ç¢ºã€‚
                                -->
                                <button onclick="editBillingItem('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm">ç·¨è¼¯</button>
                                <button onclick="deleteBillingItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    
                    ${safeDescription ? `
                        <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                            ${safeDescription}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // æ”¶è²»é …ç›®è¡¨å–®åŠŸèƒ½
        function showAddBillingItemForm() {
    // è‹¥æ²’æœ‰ç®¡ç†æ”¶è²»é …ç›®çš„æ¬Šé™ï¼Œé˜»æ­¢é–‹å•Ÿè¡¨å–®
    if (!hasAccessToSection('billingManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•æ–°å¢žæ”¶è²»é …ç›®', 'error');
        return;
    }
            editingBillingItemId = null;
            document.getElementById('billingItemFormTitle').textContent = 'æ–°å¢žæ”¶è²»é …ç›®';
            document.getElementById('billingItemSaveButtonText').textContent = 'å„²å­˜';
            clearBillingItemForm();
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        function hideAddBillingItemForm() {
            document.getElementById('addBillingItemModal').classList.add('hidden');
            clearBillingItemForm();
            editingBillingItemId = null;
        }
        
        function clearBillingItemForm() {
            document.getElementById('billingItemPackageUses').value = '';
            document.getElementById('billingItemValidityDays').value = '';
            var pf = document.getElementById('packageFields'); if (pf) pf.classList.add('hidden');
            document.getElementById('billingItemName').value = '';
            document.getElementById('billingItemCategory').value = '';
            document.getElementById('billingItemPrice').value = '';
            document.getElementById('billingItemUnit').value = '';
            document.getElementById('billingItemDescription').value = '';
            document.getElementById('billingItemActive').checked = true;
        }
        
        function editBillingItem(id) {
    // æ¬Šé™æª¢æŸ¥ï¼šç„¡æ¬Šé™è€…ä¸å¾—ç·¨è¼¯
    if (!hasAccessToSection('billingManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•ç·¨è¼¯æ”¶è²»é …ç›®', 'error');
        return;
    }
            // å°‡ id è½‰ç‚ºå­—ä¸²ä»¥é¿å…æ•¸å­—èˆ‡å­—ä¸²æ¯”è¼ƒä¸ç›¸ç­‰
            const idStr = String(id);
            const item = billingItems.find(b => String(b.id) === idStr);
            if (!item) return;
            
            // ç·¨è¼¯ç‹€æ…‹ä¸‹å„²å­˜å­—ä¸²é¡žåž‹çš„ ID
            editingBillingItemId = idStr;
            document.getElementById('billingItemFormTitle').textContent = 'ç·¨è¼¯æ”¶è²»é …ç›®';
            document.getElementById('billingItemSaveButtonText').textContent = 'æ›´æ–°';
            
            document.getElementById('billingItemName').value = item.name || '';
            document.getElementById('billingItemCategory').value = item.category || '';
            document.getElementById('billingItemPrice').value = item.price || '';
            document.getElementById('billingItemUnit').value = item.unit || '';
            document.getElementById('billingItemDescription').value = item.description || '';
            document.getElementById('billingItemActive').checked = item.active !== false;
            document.getElementById('billingItemPackageUses').value = item.packageUses || '';
            document.getElementById('billingItemValidityDays').value = item.validityDays || '';
            {
                const pf = document.getElementById('packageFields');
                if (pf) pf.classList.toggle('hidden', item.category !== 'package');
            }
            
            document.getElementById('addBillingItemModal').classList.remove('hidden');
        }
        
        async function saveBillingItem() {
            // æ¬Šé™æª¢æŸ¥ï¼šç„¡æ¬Šé™è€…ä¸å¾—å„²å­˜
            if (!hasAccessToSection('billingManagement')) {
                showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•ä¿å­˜æ”¶è²»é …ç›®', 'error');
                return;
            }
            const name = document.getElementById('billingItemName').value.trim();
            const category = document.getElementById('billingItemCategory').value;
            let price = parseFloat(document.getElementById('billingItemPrice').value);

            let packageUses = null;
            let validityDays = null;
            if (category === 'package') {
                packageUses = parseInt(document.getElementById('billingItemPackageUses').value);
                validityDays = parseInt(document.getElementById('billingItemValidityDays').value);
                if (!packageUses || packageUses <= 0) {
                    showToast('è«‹è¼¸å…¥å¥—ç¥¨å¯ç”¨æ¬¡æ•¸ï¼', 'error');
                    return;
                }
                if (!validityDays || validityDays <= 0) {
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆå¤©æ•¸ï¼', 'error');
                    return;
                }
            }
            
            if (!name) {
                showToast('è«‹è¼¸å…¥æ”¶è²»é …ç›®åç¨±ï¼', 'error');
                return;
            }
            
            if (!category) {
                showToast('è«‹é¸æ“‡é …ç›®é¡žåˆ¥ï¼', 'error');
                return;
            }
            
            if (isNaN(price)) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ”¶è²»é‡‘é¡ï¼', 'error');
                return;
            }
            
            // æŠ˜æ‰£é …ç›®å…è¨±è² æ•¸æˆ–0-1ä¹‹é–“çš„å°æ•¸ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œå…¶ä»–é …ç›®ä¸å…è¨±è² æ•¸
            if (category !== 'discount' && price < 0) {
                showToast('é™¤æŠ˜æ‰£é …ç›®å¤–ï¼Œæ”¶è²»é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸ï¼', 'error');
                return;
            }
            
            // æŠ˜æ‰£é …ç›®çš„ç‰¹æ®Šé©—è­‰
            if (category === 'discount') {
                if (price > 0 && price >= 1 && price <= 10) {
                    // å¦‚æžœè¼¸å…¥1-10ä¹‹é–“çš„æ•¸å­—ï¼Œè‡ªå‹•è½‰æ›ç‚ºæŠ˜æ‰£æ¯”ä¾‹
                    price = price / 10;
                    document.getElementById('billingItemPrice').value = price;
                    {
                        const lang = localStorage.getItem('lang') || 'zh';
                        const zhMsg = `å·²è‡ªå‹•è½‰æ›ç‚º${(price * 100).toFixed(0)}æŠ˜`;
                        const enMsg = `Automatically converted to ${(price * 100).toFixed(0)}% discount`;
                        const msg = lang === 'en' ? enMsg : zhMsg;
                        showToast(msg, 'info');
                    }
                }
            }
            
            // å–å¾—ç•¶å‰è§¸ç™¼çš„æŒ‰éˆ•ä¸¦åœ¨é–‹å§‹åŸ·è¡Œå„²å­˜æ™‚é¡¯ç¤ºè®€å–åœˆ
            const saveBtn = getLoadingButtonFromEvent('button[onclick="saveBillingItem()"]');
            setButtonLoading(saveBtn);
            try {
                // å§‹çµ‚ä½¿ç”¨å­—ä¸²ä½œç‚º IDï¼Œä»¥é¿å…å­—ä¸²èˆ‡æ•¸å­—æ¯”è¼ƒé€ æˆçš„åŒ¹é…å•é¡Œ
                const newId = editingBillingItemId || String(Date.now());
                const item = {
                    id: newId,
                    name: name,
                    category: category,
                    price: price,
                    unit: document.getElementById('billingItemUnit').value.trim(),
                    description: document.getElementById('billingItemDescription').value.trim(),
                    packageUses: packageUses,
                    validityDays: validityDays,
                    active: document.getElementById('billingItemActive').checked,
                    createdAt: editingBillingItemId ? (billingItems.find(b => String(b.id) === String(editingBillingItemId)) || {}).createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // æ›´æ–°æœ¬åœ°è³‡æ–™åŠæç¤ºè¨Šæ¯
                if (editingBillingItemId) {
                    // ä»¥å­—ä¸²å½¢å¼æ¯”è¼ƒ IDï¼Œä»¥ç¢ºä¿èƒ½æ­£ç¢ºæ‰¾åˆ°ä¸¦è¦†å¯«åŽŸé …ç›®
                    const index = billingItems.findIndex(b => String(b.id) === String(editingBillingItemId));
                    if (index !== -1) {
                        billingItems[index] = item;
                    }
                    showToast('æ”¶è²»é …ç›®å·²æ›´æ–°ï¼', 'success');
                } else {
                    billingItems.push(item);
                    showToast('æ”¶è²»é …ç›®å·²æ–°å¢žï¼', 'success');
                }

                // å°‡æœ€æ–°æ”¶è²»é …ç›®å­˜å›žæœ¬åœ°ä»¥æ”¯æ´è·¨è£ç½®åŒæ­¥è®€å–ã€‚
                try {
                    localStorage.setItem('billingItems', JSON.stringify(billingItems));
                } catch (lsErrUpdate) {
                    console.warn('ä¿å­˜æ”¶è²»é …ç›®åˆ°æœ¬åœ°å¤±æ•—:', lsErrUpdate);
                }

                try {
                    // å°‡æ”¶è²»é …ç›®å¯«å…¥ Firestore
                    // ä¸å„²å­˜ id æ¬„ä½ï¼Œé¿å…èˆ‡æ–‡ä»¶ ID é‡è¤‡
                    let dataToWrite;
                    try {
                        const { id, ...rest } = item || {};
                        dataToWrite = { ...rest };
                    } catch (_omitErr) {
                        dataToWrite = item;
                    }
                    await window.firebase.setDoc(
                        window.firebase.doc(window.firebase.db, 'billingItems', String(item.id)),
                        dataToWrite
                    );
                } catch (error) {
                    console.error('å„²å­˜æ”¶è²»é …ç›®è‡³ Firestore å¤±æ•—:', error);
                }
                hideAddBillingItemForm();
                displayBillingItems();
                // æ–°å¢žæˆ–æ›´æ–°æ”¶è²»é …ç›®å¾Œï¼Œæ¨™è¨˜å·²è¼‰å…¥ï¼Œé¿å…è¨ºç—‡æœå°‹æ™‚åˆ¤å®šç‚ºæœªè¼‰å…¥
                billingItemsLoaded = true;
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹èˆ‡å…§å®¹
                clearButtonLoading(saveBtn);
            }
        }
        
        async function deleteBillingItem(id) {
    // æ¬Šé™æª¢æŸ¥ï¼šç„¡æ¬Šé™è€…ä¸å¾—åˆªé™¤
    if (!hasAccessToSection('billingManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åˆªé™¤æ”¶è²»é …ç›®', 'error');
        return;
    }
            // å°‡ id è½‰ç‚ºå­—ä¸²ä»¥é¿å…æ•¸å­—èˆ‡å­—ä¸²æ¯”è¼ƒä¸ç›¸ç­‰
            const idStr = String(id);
            const item = billingItems.find(b => String(b.id) === idStr);
            if (!item) return;
            
            // åˆªé™¤æ”¶è²»é …ç›®ç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
            {
                const langDel = localStorage.getItem('lang') || 'zh';
                const zhMsgDel = `ç¢ºå®šè¦åˆªé™¤æ”¶è²»é …ç›®ã€Œ${item.name}ã€å—Žï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŽŸï¼`;
                const enMsgDel = `Are you sure you want to delete the billing item \"${item.name}\"?\n\nThis action cannot be undone!`;
                const confirmDel = await showConfirmation(langDel === 'en' ? enMsgDel : zhMsgDel, 'warning');
                if (confirmDel) {
                    billingItems = billingItems.filter(b => String(b.id) !== idStr);
                    try {
                        await window.firebase.deleteDoc(
                            window.firebase.doc(window.firebase.db, 'billingItems', String(id))
                        );
                    } catch (error) {
                        console.error('åˆªé™¤æ”¶è²»é …ç›®è³‡æ–™è‡³ Firestore å¤±æ•—:', error);
                    }
                    // åˆªé™¤å¾Œæ›´æ–°æœ¬åœ°å­˜å„²ï¼Œä»¥ä¾¿å…¶ä»–è£ç½®ä¸‹æ¬¡è¼‰å…¥æ™‚å–å¾—æœ€æ–°è³‡æ–™
                    try {
                        localStorage.setItem('billingItems', JSON.stringify(billingItems));
                    } catch (lsErrDel) {
                        console.warn('åˆªé™¤æ”¶è²»é …ç›®å¾Œä¿å­˜æœ¬åœ°è³‡æ–™å¤±æ•—:', lsErrDel);
                    }
                    const zhToastDel = `æ”¶è²»é …ç›®ã€Œ${item.name}ã€å·²åˆªé™¤ï¼`;
                    const enToastDel = `Billing item \"${item.name}\" has been deleted!`;
                    showToast(langDel === 'en' ? enToastDel : zhToastDel, 'success');
                    displayBillingItems();
                }
            }
        }

        // è™•æ–¹æœç´¢åŠŸèƒ½
        function searchHerbsForPrescription() {
            const searchTerm = document.getElementById('prescriptionSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('prescriptionSearchResults');
            const resultsList = document.getElementById('prescriptionSearchList');
            
            if (searchTerm.length < 1) {
                // ç•¶æœå°‹å­—ä¸²ç‚ºç©ºæ™‚éš±è—çµæžœå®¹å™¨ï¼Œä¸¦åŒæ­¥éš±è—ä»»ä½•æ®˜ç•™çš„æç¤ºæ¡†
                resultsContainer.classList.add('hidden');
                if (typeof hideTooltip === 'function') {
                    hideTooltip();
                }
                return;
            }
            
            // æœç´¢åŒ¹é…çš„ä¸­è—¥æå’Œæ–¹åŠ‘ï¼Œä¸¦æ ¹æ“šåŒ¹é…ç¨‹åº¦æŽ’åº
            let matchedItems = (Array.isArray(herbLibrary) ? herbLibrary : [])
                .filter(item => {
                    // åœç”¨çš„ä¸­è—¥ä¸å‡ºç¾åœ¨è™•æ–¹æœå°‹çµæžœä¸­
                    try {
                        if (typeof getHerbInventory === 'function') {
                            const inv = getHerbInventory(item.id);
                            if (inv && inv.disabled) {
                                return false;
                            }
                        }
                    } catch (_e) {
                        /* è‹¥ç„¡æ³•å–å¾—åº«å­˜è³‡è¨Šå‰‡å¿½ç•¥åœç”¨åˆ¤æ–· */
                    }
                    // å°‡å„å±¬æ€§è½‰ç‚ºå°å¯«ä»¥ä¾¿æ¯”å°
                    const lowerName = item.name ? item.name.toLowerCase() : '';
                    const lowerAlias = item.alias ? item.alias.toLowerCase() : '';
                    const lowerEnglish = item.englishName ? item.englishName.toLowerCase() : '';
                    const lowerEffects = item.effects ? item.effects.toLowerCase() : '';
                    // åŒ…å«åç¨±ã€åˆ¥åã€è‹±æ–‡åæˆ–åŠŸæ•ˆå³å¯è¦–ç‚ºåŒ¹é…
                    return (
                        lowerName.includes(searchTerm) ||
                        lowerAlias.includes(searchTerm) ||
                        lowerEnglish.includes(searchTerm) ||
                        lowerEffects.includes(searchTerm)
                    );
                })
                .map(item => {
                    // è¨ˆç®—åŒ¹é…åˆ†æ•¸ï¼šåç¨±åŒ¹é…å„ªå…ˆï¼Œå…¶æ¬¡ç‚ºåˆ¥åã€è‹±æ–‡åï¼Œå†æ¬¡ç‚ºåŠŸæ•ˆ
                    const lowerName = item.name ? item.name.toLowerCase() : '';
                    const lowerAlias = item.alias ? item.alias.toLowerCase() : '';
                    const lowerEnglish = item.englishName ? item.englishName.toLowerCase() : '';
                    const lowerEffects = item.effects ? item.effects.toLowerCase() : '';
                    let score = Infinity;
                    if (lowerName.includes(searchTerm)) {
                        score = lowerName.indexOf(searchTerm);
                    } else if (lowerAlias.includes(searchTerm)) {
                        score = 100 + lowerAlias.indexOf(searchTerm);
                    } else if (lowerEnglish.includes(searchTerm)) {
                        score = 200 + lowerEnglish.indexOf(searchTerm);
                    } else if (lowerEffects.includes(searchTerm)) {
                        score = 300 + lowerEffects.indexOf(searchTerm);
                    }
                    return { item, score };
                })
                .sort((a, b) => a.score - b.score)
                .map(obj => obj.item);
            // åªå–å‰ 10 å€‹çµæžœ
            matchedItems = matchedItems.slice(0, 10);
            
            if (!matchedItems || matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ä¸­è—¥ææˆ–æ–¹åŠ‘
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                // è‹¥æ²’æœ‰ä»»ä½•åŒ¹é…çµæžœï¼Œä¹Ÿæ‡‰ç•¶éš±è—æç¤ºæ¡†ï¼Œé¿å…æ®˜ç•™
                if (typeof hideTooltip === 'function') {
                    hideTooltip();
                }
                return;
            }
            
            // é¡¯ç¤ºæœç´¢çµæžœï¼Œç§»é™¤åŠ‘é‡æ¬„ï¼Œä¸¦ä½¿ç”¨è‡ªè¨‚ tooltip
            resultsList.innerHTML = matchedItems.map(item => {
                // æ ¹æ“šç•¶å‰ä»‹é¢èªžè¨€æ±ºå®šåç¨±é¡¯ç¤ºã€‚è‹¥ç‚ºè‹±æ–‡ä»‹é¢ä¸”å­˜åœ¨è‹±è­¯åç¨±ï¼Œå„ªå…ˆä½¿ç”¨è‹±è­¯åç¨±ï¼›å¦å‰‡ä½¿ç”¨ä¸­æ–‡åç¨±ã€‚
                let displayName = item.name;
                try {
                    const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                    if (langSel && langSel.toLowerCase().startsWith('en') && item.englishName) {
                        displayName = item.englishName;
                    }
                } catch (_e) {
                    displayName = item.name;
                }
                // ç¿»è­¯é¡žåž‹åç¨±ï¼šä½¿ç”¨ window.t å‡½å¼é€²è¡Œç¿»è­¯ï¼Œé è¨­ç‚ºä¸­æ–‡
                const typeLabelZh = item.type === 'herb' ? 'ä¸­è—¥æ' : 'æ–¹åŠ‘';
                const typeLabel = (typeof window.t === 'function') ? window.t(typeLabelZh) : typeLabelZh;
                const bgColor = 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200';
                // çµ„åˆå®Œæ•´è³‡è¨Šä½œç‚º tooltip å…§å®¹ï¼Œä¸¦é€²è¡Œç·¨ç¢¼
                const details = [];
                details.push('åç¨±ï¼š' + item.name);
                if (item.alias) details.push('åˆ¥åï¼š' + item.alias);
                if (item.type === 'herb') {
                    if (item.nature) details.push('æ€§å‘³ï¼š' + item.nature);
                    if (item.meridian) details.push('æ­¸ç¶“ï¼š' + item.meridian);
                }
                if (item.effects) details.push('åŠŸæ•ˆï¼š' + item.effects);
                if (item.indications) details.push('ä¸»æ²»ï¼š' + item.indications);
                if (item.type === 'formula') {
                    if (item.composition) details.push('çµ„æˆï¼š' + item.composition.replace(/\n/g, 'ã€'));
                    if (item.usage) details.push('ç”¨æ³•ï¼š' + item.usage);
                }
                if (item.cautions) details.push('æ³¨æ„ï¼š' + item.cautions);
                const encoded = encodeURIComponent(details.join('\n'));
                // å–å¾—åº«å­˜è³‡æ–™ä»¥é¡¯ç¤ºå­˜é‡
                let inv = { quantity: 0, threshold: 0 };
                try {
                    if (typeof getHerbInventory === 'function') {
                        inv = getHerbInventory(item.id);
                    }
                } catch (_e) {
                    inv = { quantity: 0, threshold: 0 };
                }
                const qty = inv && typeof inv.quantity === 'number' ? inv.quantity : 0;
                const thr = inv && typeof inv.threshold === 'number' ? inv.threshold : 0;
                const unit = (inv && inv.unit) ? inv.unit : 'g';
                const factor = UNIT_FACTOR_MAP[unit] || 1;
                const qtyDisplay = (() => {
                    const val = qty / factor;
                    return parseFloat(val.toFixed(3)).toString();
                })();
                const rawUnitLabel = UNIT_LABEL_MAP[unit] || 'å…‹';
                const unitTranslated = (typeof window.t === 'function') ? window.t(rawUnitLabel) : rawUnitLabel;
                const remainLabel = (typeof window.t === 'function') ? window.t('é¤˜é‡ï¼š') : 'é¤˜é‡ï¼š';
                const stockClass = qty <= thr ? 'text-red-600' : 'text-gray-600';
                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" data-tooltip="${encoded}"
                         onmouseenter="showTooltip(event, this.getAttribute('data-tooltip'))"
                         onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()"
                         onclick="addToPrescription('${item.type}', ${item.id})">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${window.escapeHtml(displayName)}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${typeLabel}</div>
                            ${item.effects ? `<div class="text-xs text-gray-600 mt-1">${window.escapeHtml(item.effects.substring(0, 30))}${item.effects.length > 30 ? '...' : ''}</div>` : ''}
                            <div class="text-xs mt-1 ${stockClass}">${remainLabel} ${qtyDisplay}${unitTranslated}</div>
                        </div>
                    </div>
                `;
            }).join('');
            resultsContainer.classList.remove('hidden');
        }
        
        // å­˜å„²å·²é¸æ“‡çš„è™•æ–¹é …ç›®
        let selectedPrescriptionItems = [];
        
        // å­˜å„²å·²é¸æ“‡çš„æ”¶è²»é …ç›®
        let selectedBillingItems = [];

        // ----------------------------------------------------------------------------------------
        // ç¦å¿Œé…ä¼è¨­å®š
        //
        // ä¸­é†«è™•æ–¹ä¸­å­˜åœ¨æŸäº›è—¥æå½¼æ­¤ç›¸åæˆ–ç›¸ç•çš„æƒ…æ³ï¼Œå³æ‰€è¬‚ã€Œåå…«åã€èˆ‡ã€Œåä¹ç•ã€ã€‚
        // é€™è£¡å®šç¾©ä¸€å¼µç¦å¿Œé…ä¼å°ç…§è¡¨ï¼Œåˆ©ç”¨è—¥æåç¨±çš„åŒ…å«é—œä¿‚ä¾†æª¢æŸ¥æ˜¯å¦å‡ºç¾ç¦å¿Œçµ„åˆã€‚
        // ç‚ºç°¡ä¾¿èµ·è¦‹ï¼Œè‹¥åç¨±åŒ…å«åœ¨ä»¥ä¸‹ä»»ä½•éµæˆ–å€¼ä¸­ï¼Œå‰‡è¦–ç‚ºåŒä¸€é¡žåˆ¥ã€‚ä¾‹å¦‚ã€Œé™„å­ã€å±¬æ–¼çƒé ­é¡žï¼›
        // ã€Œå·çƒã€ã€Œè‰çƒã€äº¦è¦–ç‚ºçƒé ­ï¼ŒåŒæ¨£èˆ‡è²æ¯ã€åŠå¤ã€ç“œè”žç­‰è—¥ç›¸æ–¥ã€‚
        // æ­¤è¡¨æŽ¡å°ç¨±è¨­è¨ˆï¼Œæ¯å€‹è—¥æéµçš„å€¼ç‚ºä¸€çµ„èˆ‡ä¹‹ç¦å¿Œçš„è—¥æåç¨±é™£åˆ—ã€‚
        const FORBIDDEN_MAP = {
            // ç”˜è‰é¡žç¦å¿Œï¼šç”˜è‰ä¸å¯èˆ‡ç”˜é‚ã€å¤§æˆŸã€èŠ«èŠ±ã€æµ·è—»åŒç”¨
            'ç”˜è‰': ['ç”˜é‚', 'å¤§æˆŸ', 'èŠ«èŠ±', 'æµ·è—»'],
            'ç”˜é‚': ['ç”˜è‰'],
            'å¤§æˆŸ': ['ç”˜è‰'],
            'èŠ«èŠ±': ['ç”˜è‰'],
            'æµ·è—»': ['ç”˜è‰'],
            // çƒé ­é¡žï¼ˆåŒ…æ‹¬é™„å­ã€å·çƒã€è‰çƒï¼‰ç¦å¿Œï¼šä¸å¯èˆ‡è²æ¯ã€ç“œè”žã€åŠå¤ã€ç™½è˜žã€ç™½èŠ¨ã€å¤©èŠ±ç²‰ç­‰åŒç”¨
            'çƒé ­': ['è²æ¯', 'å·è²æ¯', 'æµ™è²æ¯', 'ç“œè”ž', 'ç“œè”žçš®', 'ç“œè”žä»', 'å¤©èŠ±ç²‰', 'åŠå¤', 'ç™½è˜ž', 'ç™½èŠ¨'],
            'é™„å­': ['è²æ¯', 'å·è²æ¯', 'æµ™è²æ¯', 'ç“œè”ž', 'ç“œè”žçš®', 'ç“œè”žä»', 'å¤©èŠ±ç²‰', 'åŠå¤', 'ç™½è˜ž', 'ç™½èŠ¨'],
            'å·çƒ': ['çŠ€è§’', 'è²æ¯', 'å·è²æ¯', 'æµ™è²æ¯', 'ç“œè”ž', 'ç“œè”žçš®', 'ç“œè”žä»', 'å¤©èŠ±ç²‰', 'åŠå¤', 'ç™½è˜ž', 'ç™½èŠ¨'],
            'è‰çƒ': ['çŠ€è§’', 'è²æ¯', 'å·è²æ¯', 'æµ™è²æ¯', 'ç“œè”ž', 'ç“œè”žçš®', 'ç“œè”žä»', 'å¤©èŠ±ç²‰', 'åŠå¤', 'ç™½è˜ž', 'ç™½èŠ¨'],
            // ä¸Šè¿°ç¦å¿Œå°æ‡‰å°ç¨±é—œä¿‚
            'è²æ¯': ['çƒé ­', 'é™„å­'],
            'å·è²æ¯': ['çƒé ­', 'é™„å­'],
            'æµ™è²æ¯': ['çƒé ­', 'é™„å­'],
            'ç“œè”ž': ['çƒé ­', 'é™„å­'],
            'ç“œè”žçš®': ['çƒé ­', 'é™„å­'],
            'ç“œè”žä»': ['çƒé ­', 'é™„å­'],
            'å¤©èŠ±ç²‰': ['çƒé ­', 'é™„å­'],
            'åŠå¤': ['çƒé ­', 'é™„å­'],
            'ç™½è˜ž': ['çƒé ­', 'é™„å­'],
            'ç™½èŠ¨': ['çƒé ­', 'é™„å­'],
            'çŠ€è§’': ['å·çƒ', 'è‰çƒ'],
            // è—œè˜†ç¦å¿Œï¼šè—œè˜†ä¸å¯èˆ‡äººåƒã€æ²™åƒã€ä¸¹åƒã€çŽ„åƒã€è‹¦åƒã€ç´°è¾›ã€èŠè—¥åŒç”¨
            'è—œè˜†': ['äººåƒ', 'æ²™åƒ', 'ä¸¹åƒ', 'çŽ„åƒ', 'è‹¦åƒ', 'ç´°è¾›', 'èŠè—¥'],
            'äººåƒ': ['è—œè˜†', 'äº”éˆè„‚'],
            'æ²™åƒ': ['è—œè˜†'],
            'ä¸¹åƒ': ['è—œè˜†'],
            'çŽ„åƒ': ['è—œè˜†'],
            'è‹¦åƒ': ['è—œè˜†'],
            'ç´°è¾›': ['è—œè˜†'],
            'èŠè—¥': ['è—œè˜†'],
            // ç¡«é»ƒèˆ‡æœ´ç¡ç›¸ç•
            'ç¡«é»ƒ': ['æœ´ç¡'],
            'æœ´ç¡': ['ç¡«é»ƒ'],
            // æ°´éŠ€èˆ‡ç ’éœœç›¸ç•
            'æ°´éŠ€': ['ç ’éœœ'],
            'ç ’éœœ': ['æ°´éŠ€'],
            // ç‹¼æ¯’èˆ‡å¯†é™€åƒ§ç›¸ç•
            'ç‹¼æ¯’': ['å¯†é™€åƒ§'],
            'å¯†é™€åƒ§': ['ç‹¼æ¯’'],
            // å·´è±†èˆ‡ç‰½ç‰›å­ç›¸ç•
            'å·´è±†': ['ç‰½ç‰›å­'],
            'ç‰½ç‰›å­': ['å·´è±†'],
            // ä¸é¦™èˆ‡é¬±é‡‘ç›¸ç•
            'ä¸é¦™': ['é¬±é‡‘'],
            'é¬±é‡‘': ['ä¸é¦™'],
            // ç‰™ç¡èˆ‡ä¸‰æ£±ï¼ˆåˆç¨±äº¬ä¸‰æ£±ã€ä¸‰æ¢­ï¼‰ç›¸ç•
            'ç‰™ç¡': ['ä¸‰æ£±', 'äº¬ä¸‰æ£±', 'ä¸‰æ¢­'],
            'ä¸‰æ£±': ['ç‰™ç¡'],
            'äº¬ä¸‰æ£±': ['ç‰™ç¡'],
            'ä¸‰æ¢­': ['ç‰™ç¡'],
            // å®˜æ¡‚èˆ‡çŸ³è„‚ç›¸ç•
            'å®˜æ¡‚': ['çŸ³è„‚'],
            'çŸ³è„‚': ['å®˜æ¡‚'],
            // äº”éˆè„‚èˆ‡äººåƒç›¸ç•
            'äº”éˆè„‚': ['äººåƒ']
        };

        /**
         * åˆ¤æ–·å…©å€‹è—¥æåç¨±æ˜¯å¦æ§‹æˆç¦å¿Œé…ä¼ã€‚
         * ä»¥åŒ…å«é—œä¿‚é€²è¡Œæ¯”å°ï¼šè‹¥åç¨±åŒ…å«æŒ‡å®šé—œéµå­—å³è¦–ç‚ºåŒ¹é…ã€‚
         * @param {string} nameA
         * @param {string} nameB
         * @returns {boolean} true è¡¨ç¤ºæ§‹æˆç¦å¿Œ
         */
        function isForbiddenCombination(nameA, nameB) {
            if (!nameA || !nameB) return false;
            // è¿­ä»£åœ°åœ–ä¸­çš„æ¯å€‹éµå€¼å°
            for (const key in FORBIDDEN_MAP) {
                if (!Object.prototype.hasOwnProperty.call(FORBIDDEN_MAP, key)) continue;
                const forbiddenList = FORBIDDEN_MAP[key];
                // è‹¥ç¬¬ä¸€å€‹åç¨±åŒ…å«éµï¼Œä¸”ç¬¬äºŒå€‹åç¨±åŒ…å«åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€å€‹é …ç›®
                if (nameA.includes(key)) {
                    for (const forb of forbiddenList) {
                        if (nameB.includes(forb)) {
                            return true;
                        }
                    }
                }
                // äº’æ›æ¯”å°ï¼šè‹¥ç¬¬äºŒå€‹åç¨±åŒ…å«éµï¼Œä¸”ç¬¬ä¸€å€‹åç¨±åŒ…å«åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€å€‹é …ç›®
                if (nameB.includes(key)) {
                    for (const forb of forbiddenList) {
                        if (nameA.includes(forb)) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        /**
         * é¡¯ç¤ºæˆ–æ¸…é™¤è™•æ–¹ç¦å¿Œé…ä¼éŒ¯èª¤è¨Šæ¯ã€‚
         * ç•¶ message ç‚ºç©ºå­—ä¸²æˆ– null æ™‚ï¼Œå°‡éš±è—éŒ¯èª¤å€åŸŸã€‚
         * é€éŽæ­¤å‡½å¼å¯åœ¨é é¢å›ºå®šä½ç½®å‘ˆç¾éŒ¯èª¤æé†’ï¼Œä¸ä½¿ç”¨å½ˆçª—ã€‚
         * @param {string} message éŒ¯èª¤è¨Šæ¯ï¼›ç©ºå€¼æ™‚éš±è—æç¤º
         */
        function displayPrescriptionError(message) {
            try {
                const errorEl = document.getElementById('prescriptionError');
                if (!errorEl) return;
                if (message) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.textContent = '';
                    errorEl.classList.add('hidden');
                }
            } catch (_e) {
                // è‹¥å…ƒç´ ä¸å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤
            }
        }

        /**
         * æª¢æŸ¥ç›®å‰è™•æ–¹ä¸­çš„è—¥ææ˜¯å¦å­˜åœ¨ç¦å¿Œé…ä¼ã€‚
         * è‹¥å­˜åœ¨ç›¸æ–¥çš„è—¥æï¼Œæœƒå°‡ç¬¬ä¸€çµ„ç›¸æ–¥è—¥å°é¡¯ç¤ºæ–¼éŒ¯èª¤å€åŸŸï¼›
         * è‹¥ç„¡ç¦å¿Œé…ä¼ï¼Œå‰‡æ¸…é™¤éŒ¯èª¤æç¤ºã€‚
         */
        function checkPrescriptionConflicts() {
            try {
                // å¦‚æ²’æœ‰æˆ–åƒ…æœ‰ä¸€å€‹é …ç›®ï¼Œç„¡éœ€æª¢æŸ¥
                if (!Array.isArray(selectedPrescriptionItems) || selectedPrescriptionItems.length < 2) {
                    displayPrescriptionError('');
                    return;
                }
                // æª¢æŸ¥æ‰€æœ‰å…©å…©è—¥ææ˜¯å¦æœ‰ç¦å¿Œï¼Œæ”¶é›†æ‰€æœ‰ç¦å¿Œçµ„åˆ
                const conflictMessages = [];
                for (let i = 0; i < selectedPrescriptionItems.length; i++) {
                    const nameA = selectedPrescriptionItems[i].name || '';
                    for (let j = i + 1; j < selectedPrescriptionItems.length; j++) {
                        const nameB = selectedPrescriptionItems[j].name || '';
                        if (isForbiddenCombination(nameA, nameB)) {
                            const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                            const zhMsg = `è—¥æ${nameA}èˆ‡${nameB}å­˜åœ¨ç¦å¿Œé…ä¼ï¼Œè«‹æ³¨æ„ä½¿ç”¨ï¼`;
                            const enMsg = `${nameA} is incompatible with ${nameB} in the prescription; please use with caution.`;
                            const msg = (langSel && langSel.toLowerCase().startsWith('en')) ? enMsg : zhMsg;
                            conflictMessages.push(msg);
                        }
                    }
                }
                if (conflictMessages.length > 0) {
                    // å°‡æ‰€æœ‰ç¦å¿Œè¨Šæ¯ä½¿ç”¨æ›è¡Œç¬¦è™Ÿä¸²æŽ¥ï¼Œé¿å…é‡è¤‡é¡¯ç¤ºç›¸åŒè¨Šæ¯
                    const combined = Array.from(new Set(conflictMessages)).join('\n');
                    displayPrescriptionError(combined);
                } else {
                    // è‹¥æ²’æœ‰ä»»ä½•ç¦å¿Œï¼Œæ¸…é™¤æç¤º
                    displayPrescriptionError('');
                }
            } catch (_e) {
                // ç™¼ç”Ÿç•°å¸¸æ™‚ï¼Œéš±è—éŒ¯èª¤æç¤º
                displayPrescriptionError('');
            }
        }

        /**
         * æ ¹æ“šç•¶å‰è™•æ–¹æ˜¯å¦æœ‰å…§å®¹æ±ºå®šåº«å­˜é¡žåž‹ä¸‹æ‹‰é¸å–®æ˜¯å¦å¯ç”¨ã€‚
         * è‹¥è™•æ–¹ä¸­å·²æœ‰è—¥ææˆ–æ–¹åŠ‘ï¼Œå‰‡ç¦ç”¨é¸æ“‡ä»¥é˜²æ­¢åˆ‡æ›ä¸åŒé¡žåˆ¥ï¼›
         * ç•¶è™•æ–¹ç‚ºç©ºæ™‚ï¼Œé‡æ–°å•Ÿç”¨é¸æ“‡ã€‚
         */
        function updatePrescriptionTypeSelectStatus() {
            try {
                const sel = document.getElementById('prescriptionTypeSelect');
                if (!sel) return;
                // è¨­å®šæç¤ºè¨Šæ¯ï¼Œæ ¹æ“šèªžè¨€åˆ‡æ›
                const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                const zhTitle = 'æ‰€æœ‰è—¥åˆªé™¤å¾Œæ‰å¯è½‰æ›';
                const enTitle = 'Remove all medicines before switching';
                const titleMsg = (langSel && langSel.toLowerCase().startsWith('en')) ? enTitle : zhTitle;

                if (Array.isArray(selectedPrescriptionItems) && selectedPrescriptionItems.length > 0) {
                    // ç¦ç”¨é¸å–®ä¸¦å¥—ç”¨ç°éšŽæ¨£å¼èˆ‡ç¦ç”¨æ¸¸æ¨™
                    sel.disabled = true;
                    sel.classList.add('opacity-50');
                    sel.classList.add('cursor-not-allowed');
                    // è‹¥å­˜åœ¨è‡ªè¨‚èƒŒæ™¯è‰²ï¼Œä¿æŒä¸è®Šï¼›å¦å‰‡è¨­å®šç‚ºç°è‰²ç³»
                    // å°‡æ–‡å­—é¡è‰²èª¿æ·¡
                    sel.style.color = '#9ca3af';
                    // è¨­å®šæ‡¸æµ®æç¤º
                    sel.setAttribute('title', titleMsg);
                } else {
                    // æ¢å¾©å¯ç”¨ç‹€æ…‹èˆ‡åŽŸæœ¬æ¨£å¼
                    sel.disabled = false;
                    sel.classList.remove('opacity-50');
                    sel.classList.remove('cursor-not-allowed');
                    sel.style.color = '';
                    sel.removeAttribute('title');
                }
            } catch (_e) {
                // ignore errors
            }
        }
        
        // æ·»åŠ åˆ°è™•æ–¹å…§å®¹
        function addToPrescription(type, itemId) {
            // å–å¾—ç›®æ¨™è—¥æè³‡æ–™
            const item = herbLibrary.find(h => h.id === itemId);
            if (!item) return;

            // ä¸é˜»æ­¢ç¦å¿Œé…ä¼çš„è—¥æåŠ å…¥è™•æ–¹ï¼Œä½†ç¨å¾Œæœƒåœ¨å…¨å±€æª¢æŸ¥ä¸­é¡¯ç¤ºéŒ¯èª¤æç¤º
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ éŽ
            const existingIndex = selectedPrescriptionItems.findIndex(p => p.id === itemId);
            if (existingIndex !== -1) {
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const zhMsg = `${item.name} å·²ç¶“åœ¨è™•æ–¹ä¸­ï¼`;
                    const enMsg = `${item.name} is already in the prescription!`;
                    const msg = lang === 'en' ? enMsg : zhMsg;
                    showToast(msg, 'warning');
                }
                return;
            }
            
            // æ·»åŠ åˆ°å·²é¸æ“‡é …ç›®
            const prescriptionItem = {
                id: itemId,
                type: type,
                name: item.name,
                // When adding a new item to the prescription, default the dosage based on the item type.
                // Herbs default to 1â€¯g; formulas do not use the `dosage` field for display purposes and remain null.
                dosage: type === 'herb' ? (item.dosage || '1g') : null,
                // Set the custom dosage default based on the item type: 1â€¯g for herbs, 5â€¯g for formulas.
                customDosage: type === 'herb' ? '1' : '5',
                composition: type === 'formula' ? item.composition : null,
                effects: item.effects
            };
            
            selectedPrescriptionItems.push(prescriptionItem);

            // æª¢æŸ¥æ˜¯å¦æœ‰ç¦å¿Œé…ä¼ä¸¦æ›´æ–°éŒ¯èª¤æç¤º
            checkPrescriptionConflicts();

            // æ›´æ–°é¡¯ç¤º
            updatePrescriptionDisplay();

            // æ ¹æ“šæ˜¯å¦æœ‰è™•æ–¹å…§å®¹æ±ºå®šæ˜¯å¦å…è¨±åˆ‡æ›åº«å­˜é¡žåž‹
            updatePrescriptionTypeSelectStatus();
            
            // å¦‚æžœæ˜¯ç¬¬ä¸€å€‹è™•æ–¹é …ç›®ï¼Œè‡ªå‹•æ·»åŠ è—¥è²»
            if (selectedPrescriptionItems.length === 1) {
                const days = parseInt(document.getElementById('medicationDays').value) || 5;
                updateMedicineFeeByDays(days);
            }
            
            // æ¸…é™¤æœç´¢
            clearPrescriptionSearch();
            
            {
                const lang = localStorage.getItem('lang') || 'zh';
                // Determine the labels for herb/formula based on language.
                const zhLabel = type === 'herb' ? 'ä¸­è—¥æ' : 'æ–¹åŠ‘';
                const enLabel = type === 'herb' ? 'herb' : 'formula';
                // Choose the display name for the toast: in English mode use the englishName
                // if provided; otherwise fall back to the Chinese name. In Chinese mode always
                // use the Chinese name.  Do not attempt to translate the herb name via the
                // generic t() function because herbs/formula names are proper nouns and
                // should remain unchanged.
                const displayNameEn = item && item.englishName ? item.englishName : item.name;
                const displayNameZh = item.name;
                const zhMsg = `å·²æ·»åŠ ${zhLabel}ï¼š${displayNameZh}`;
                const enMsg = `Added ${enLabel}: ${displayNameEn}`;
                const msg = lang && lang.toLowerCase().startsWith('en') ? enMsg : zhMsg;
                showToast(msg, 'success');
            }
        }
        

        
        // æ›´æ–°è™•æ–¹é¡¯ç¤º
        function updatePrescriptionDisplay() {
            const container = document.getElementById('selectedPrescriptionItems');
            const hiddenTextarea = document.getElementById('formPrescription');
            const medicationSettings = document.getElementById('medicationSettings');
            
            if (selectedPrescriptionItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        è«‹ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æ·»åŠ ä¸­è—¥ææˆ–æ–¹åŠ‘
                    </div>
                `;
                hiddenTextarea.value = '';
                // éš±è—æœè—¥å¤©æ•¸è¨­å®š
                medicationSettings.style.display = 'none';
                // ç•¶è™•æ–¹å…§å®¹ç‚ºç©ºæ™‚ï¼Œæ‡‰é‡æ–°å•Ÿç”¨åº«å­˜é¡žåž‹é¸å–®
                try {
                    if (typeof updatePrescriptionTypeSelectStatus === 'function') {
                        updatePrescriptionTypeSelectStatus();
                    }
                } catch (_e) {
                    /* å¿½ç•¥éŒ¯èª¤ */
                }
                return;
            }
            
            // é¡¯ç¤ºæœè—¥å¤©æ•¸è¨­å®š
            medicationSettings.style.display = 'block';
            
            // é¡¯ç¤ºå·²æ·»åŠ çš„é …ç›®ï¼Œç‚ºæ¯å€‹é …ç›®å»ºç«‹è‡ªè¨‚ tooltip ä»¥é¡¯ç¤ºå®Œæ•´è³‡è¨Š
            const displayHtml = `
                <div class="space-y-3">
                    ${selectedPrescriptionItems.map((item, index) => {
                        const bgColor = 'bg-yellow-50 border-yellow-200';
                        // å¾ž herbLibrary ä¸­æ‰¾åˆ°å®Œæ•´çš„è—¥ææˆ–æ–¹åŠ‘è³‡æ–™
                        const fullItem = (Array.isArray(herbLibrary) ? herbLibrary : []).find(h => h && h.id === item.id);
                        // æ§‹å»ºè©³ç´°è³‡è¨Šå…§å®¹
                        const details = [];
                        if (fullItem) {
                            details.push('åç¨±ï¼š' + (fullItem.name || ''));
                            if (fullItem.alias) details.push('åˆ¥åï¼š' + fullItem.alias);
                            if (fullItem.type === 'herb') {
                                if (fullItem.nature) details.push('æ€§å‘³ï¼š' + fullItem.nature);
                                if (fullItem.meridian) details.push('æ­¸ç¶“ï¼š' + fullItem.meridian);
                            }
                            if (fullItem.effects) details.push('åŠŸæ•ˆï¼š' + fullItem.effects);
                            if (fullItem.indications) details.push('ä¸»æ²»ï¼š' + fullItem.indications);
                            if (fullItem.type === 'formula') {
                                if (fullItem.composition) details.push('çµ„æˆï¼š' + fullItem.composition.replace(/\n/g, 'ã€'));
                                if (fullItem.usage) details.push('ç”¨æ³•ï¼š' + fullItem.usage);
                            }
                            if (fullItem.cautions) details.push('æ³¨æ„ï¼š' + fullItem.cautions);
                        }
                        const encoded = encodeURIComponent(details.join('\n'));
                        // æ±ºå®šåç¨±é¡¯ç¤ºã€‚è‹±èªžä»‹é¢ä¸”æœ‰è‹±è­¯åç¨±æ™‚ï¼Œé¡¯ç¤ºè‹±è­¯åç¨±ï¼›å¦å‰‡é¡¯ç¤ºä¸­æ–‡åç¨±
                        let displayName = item.name;
                        try {
                            const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                            if (langSel && langSel.toLowerCase().startsWith('en') && fullItem && fullItem.englishName) {
                                displayName = fullItem.englishName;
                            }
                        } catch (_e) {
                            displayName = item.name;
                        }
                        // æ±ºå®šé¡žåž‹æ¨™ç±¤ï¼šä¾èªžè¨€é¸æ“‡è‹±æ–‡æˆ–ä¸­æ–‡
                        let typeLabel;
                        try {
                            const langSel2 = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
                            if (langSel2 && langSel2.toLowerCase().startsWith('en')) {
                                typeLabel = item.type === 'formula' ? 'Formula' : 'Herb';
                            } else {
                                typeLabel = item.type === 'formula' ? 'æ–¹åŠ‘' : 'ä¸­è—¥æ';
                            }
                        } catch (_err) {
                            typeLabel = item.type === 'formula' ? 'æ–¹åŠ‘' : 'ä¸­è—¥æ';
                        }
                        // å»ºç«‹ HTMLï¼Œä¸¦ç¶å®š tooltip äº‹ä»¶æ–¼æ•´å€‹é …ç›®å®¹å™¨
                        return `
                            <div class="${bgColor} border rounded-lg p-3 cursor-pointer"
                                 data-tooltip="${encoded}"
                                 onmouseenter="showTooltip(event, this.getAttribute('data-tooltip'))"
                                 onmousemove="moveTooltip(event)"
                                 onmouseleave="hideTooltip()">
                                <div class="flex items-center">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">${window.escapeHtml(displayName)}</div>
                                        ${item.type === 'formula' ? `<div class="text-xs text-gray-600">${typeLabel}</div>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${(() => {
                                            try {
                                                const inv = typeof getHerbInventory === 'function' ? getHerbInventory(item.id) : { quantity: 0, unit: 'g' };
                                                const qty = inv && typeof inv.quantity === 'number' ? inv.quantity : 0;
                                                const unit = inv && inv.unit ? inv.unit : 'g';
                                                const factor = UNIT_FACTOR_MAP[unit] || 1;
                                                const qtyDisplay = (() => {
                                                    const val = qty / factor;
                                                    return parseFloat(val.toFixed(3)).toString();
                                                })();
                                                const rawUnitLabel = UNIT_LABEL_MAP[unit] || 'å…‹';
                                                const unitTranslated = (typeof window.t === 'function') ? window.t(rawUnitLabel) : rawUnitLabel;
                                                const remainLabel = (typeof window.t === 'function') ? window.t('é¤˜é‡ï¼š') : 'é¤˜é‡ï¼š';
                                                return `<span class="text-xs text-gray-400">${remainLabel} ${qtyDisplay}${unitTranslated}</span>`;
                                            } catch (_e) {
                                                const remainLabel = (typeof window.t === 'function') ? window.t('é¤˜é‡ï¼š') : 'é¤˜é‡ï¼š';
                                                const defaultUnit = (typeof window.t === 'function') ? window.t('å…‹') : 'å…‹';
                                                return `<span class="text-xs text-gray-400">${remainLabel} 0${defaultUnit}</span>`;
                                            }
                                        })()}
                                        <input type="number"
                                               value="${item.customDosage || (item.type === 'herb' ? '1' : '5')}"
                                               min="0.5"
                                               max="100"
                                               step="0.5"
                                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                                               oninput="updatePrescriptionDosageLive(${index}, this.value)"
                                               onchange="updatePrescriptionDosage(${index}, this.value)"
                                               onclick="this.select()">
                                        ${(() => {
                                            try {
                                                // å–å¾—è©²è—¥ææˆ–æ–¹åŠ‘çš„å–®ä½ï¼Œè‹¥ä¸å­˜åœ¨å‰‡é è¨­ç‚ºå…‹ï¼ˆgï¼‰ã€‚
                                                const inv2 = (typeof getHerbInventory === 'function') ? getHerbInventory(item.id) : { unit: 'g' };
                                                const unit2 = (inv2 && inv2.unit) ? inv2.unit : 'g';
                                                // å¾žæ˜ å°„ä¸­å–å¾—åŽŸå§‹å–®ä½æ¨™ç±¤ï¼ˆä¸­æ–‡ï¼‰ï¼Œä¸å­˜åœ¨å‰‡é»˜èªç‚ºã€Žå…‹ã€
                                                const rawUnit2 = (typeof UNIT_LABEL_MAP !== 'undefined' && UNIT_LABEL_MAP && UNIT_LABEL_MAP[unit2]) ? UNIT_LABEL_MAP[unit2] : 'å…‹';
                                                // ä½¿ç”¨ç¿»è­¯å‡½å¼å°‡å–®ä½æ¨™ç±¤è½‰æ›ç‚ºç•¶å‰èªžè¨€
                                                const unitTranslated2 = (typeof window.t === 'function') ? window.t(rawUnit2) : rawUnit2;
                                                return `<span class="text-sm text-gray-600 font-medium">${unitTranslated2}</span>`;
                                            } catch (_err2) {
                                                // è‹¥ç™¼ç”ŸéŒ¯èª¤ï¼Œå›žå‚³é è¨­å–®ä½ã€Žå…‹ã€
                                                const defaultUnit2 = (typeof window.t === 'function') ? window.t('å…‹') : 'å…‹';
                                                return `<span class="text-sm text-gray-600 font-medium">${defaultUnit2}</span>`;
                                            }
                                        })()}
                                    </div>
                                    <button onclick="removePrescriptionItem(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">Ã—</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = displayHtml;
            
            // æ›´æ–°éš±è—çš„æ–‡æœ¬åŸŸ
            let prescriptionText = '';
            
            // å°‡è™•æ–¹åˆ—è¡¨è½‰ç‚ºç´”æ–‡å­—ï¼Œæ¯å€‹é …ç›®å¾Œé¢åŠ ä¸Šä¸€å€‹æ›è¡Œç¬¦è™Ÿã€‚
            // éŽåŽ»ç‰ˆæœ¬å°æ–¹åŠ‘é¡žåž‹ä½¿ç”¨äº†å…©å€‹æ›è¡Œç¬¦è™Ÿ ("\n\n") ä¾†é¡å¤–ç•™ç™½ï¼Œ
            // ä½†é€™æœƒåœ¨ç—…æ­·æˆ–è¨ºç—‡è¨˜éŒ„ä¸­å‘ˆç¾ç‚ºé …ç›®ä¸Šä¸‹å‡ºç¾ç©ºè¡Œã€‚
            // å› æ­¤çµ±ä¸€å°‡ herb èˆ‡ formula é …ç›®éƒ½åªæ·»åŠ ä¸€å€‹æ›è¡Œç¬¦è™Ÿï¼Œé¿å…å¤šé¤˜ç©ºç™½ã€‚
            selectedPrescriptionItems.forEach(item => {
                // ä½¿ç”¨é …ç›®çš„ customDosageï¼ˆå¦‚æžœæœ‰ï¼‰ï¼Œå¦å‰‡æ ¹æ“šé¡žåž‹çµ¦äºˆé è¨­å€¼ï¼šä¸­è—¥æ 1ã€æ–¹åŠ‘ 5ã€‚
                const dosage = item.customDosage || (item.type === 'herb' ? '1' : '5');
                // æ ¹æ“šä¸­è—¥åº«ä¸­çš„å–®ä½è¨­å®šä¾†é¡¯ç¤ºæ­£ç¢ºçš„åŸºç¤Žå–®ä½ï¼›è‹¥æ²’æœ‰å°æ‡‰å–®ä½å‰‡é»˜èªç‚º 'g'
                let unitLabelForText = '';
                try {
                    if (typeof getHerbInventory === 'function') {
                        const inv3 = getHerbInventory(item.id);
                        // ç›´æŽ¥ä½¿ç”¨åº«å­˜çš„åŸºç¤Žå–®ä½ï¼ˆå¦‚ gã€jinã€liang ç­‰ï¼‰ä½œç‚ºå„²å­˜å–®ä½ï¼Œä¸å†ç¿»è­¯ç‚ºä¸­æ–‡ï¼Œ
                        // ä»¥ä¾¿å¾ŒçºŒè§£æžä¿æŒä¸€è‡´
                        unitLabelForText = (inv3 && inv3.unit) ? inv3.unit : 'g';
                    } else {
                        // è‹¥ç„¡æ³•å–å¾— getHerbInventory å‡½å¼ï¼Œé è¨­é¡¯ç¤ºç‚º 'g'
                        unitLabelForText = 'g';
                    }
                } catch (_unitErr) {
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ä»ä½¿ç”¨é è¨­å–®ä½ 'g'
                    unitLabelForText = 'g';
                }
                // çµ„åˆç‚ºå–®è¡Œæ–‡å­—ï¼Œä»¥åŸºç¤Žå–®ä½çµå°¾ï¼ˆä¾‹å¦‚ 3gï¼‰
                prescriptionText += `${item.name} ${dosage}${unitLabelForText}\n`;
            });

            hiddenTextarea.value = prescriptionText.trim();

            // æ›´æ–°åº«å­˜é¡žåž‹é¸å–®ç‹€æ…‹ï¼ˆå•Ÿç”¨æˆ–ç¦ç”¨ï¼‰ã€‚
            // å‘¼å«æ­¤å‡½å¼ä»¥ç¢ºä¿åœ¨è™•æ–¹å…§å®¹è®ŠåŒ–å¾Œï¼Œé¡†ç²’/é£²ç‰‡åˆ‡æ›é¸å–®èƒ½æ­£ç¢ºæ›´æ–°ã€‚
            try {
                if (typeof updatePrescriptionTypeSelectStatus === 'function') {
                    updatePrescriptionTypeSelectStatus();
                }
            } catch (_e) {
                /* å¿½ç•¥ä»»ä½•éŒ¯èª¤ä»¥é¿å…å½±éŸ¿å…¶ä»–åŠŸèƒ½ */
            }
        }
        
        // æ›´æ–°æœè—¥å¤©æ•¸
        function updateMedicationDays(change) {
            const daysInput = document.getElementById('medicationDays');
            const currentDays = parseInt(daysInput.value) || 5;
            const newDays = Math.max(1, Math.min(30, currentDays + change));
            daysInput.value = newDays;
            
            // æ›´æ–°è™•æ–¹é¡¯ç¤º
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // è‡ªå‹•æ›´æ–°è—¥è²»
            updateMedicineFeeByDays(newDays);
        }
        
        // æ›´æ–°æœè—¥æ¬¡æ•¸
        function updateMedicationFrequency(change) {
            const frequencyInput = document.getElementById('medicationFrequency');
            const currentFrequency = parseInt(frequencyInput.value) || 2;
            const newFrequency = Math.max(1, Math.min(6, currentFrequency + change));
            frequencyInput.value = newFrequency;
            
            // æ›´æ–°è™•æ–¹é¡¯ç¤º
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
        }
        
        // æ ¹æ“šé–‹è—¥å¤©æ•¸è‡ªå‹•æ›´æ–°è—¥è²»
        function updateMedicineFeeByDays(days) {
            // åªæœ‰åœ¨æœ‰è™•æ–¹å…§å®¹æ™‚æ‰è‡ªå‹•æ›´æ–°è—¥è²»
            if (selectedPrescriptionItems.length === 0) {
                return;
            }
            
            // å°‹æ‰¾ä¸­è—¥èª¿åŠ‘è²»é …ç›®
            const medicineFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'medicine' && 
                (item.name.includes('ä¸­è—¥') || item.name.includes('è—¥è²»') || item.name.includes('èª¿åŠ‘'))
            );
            
            if (!medicineFeeItem) {
                return; // å¦‚æžœæ²’æœ‰æ‰¾åˆ°è—¥è²»é …ç›®ï¼Œä¸é€²è¡Œè‡ªå‹•æ›´æ–°
            }
            
            // æŸ¥æ‰¾ç¾æœ‰çš„è—¥è²»é …ç›®
            const existingMedicineFeeIndex = selectedBillingItems.findIndex(item => 
                item.id === medicineFeeItem.id
            );
            
            if (existingMedicineFeeIndex !== -1) {
                // æ›´æ–°ç¾æœ‰è—¥è²»é …ç›®çš„æ•¸é‡ç‚ºå¤©æ•¸
                selectedBillingItems[existingMedicineFeeIndex].quantity = days;
                updateBillingDisplay();
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const zhMsg = `å·²æ›´æ–°è—¥è²»ï¼š${medicineFeeItem.name} x${days}å¤©`;
                    const enMsg = `Updated medicine fee: ${medicineFeeItem.name} x${days} days`;
                    const msg = lang === 'en' ? enMsg : zhMsg;
                    showToast(msg, 'info');
                }
            } else {
                // å¦‚æžœæ²’æœ‰è—¥è²»é …ç›®ï¼Œè‡ªå‹•æ·»åŠ 
                const billingItem = {
                    id: medicineFeeItem.id,
                    name: medicineFeeItem.name,
                    category: medicineFeeItem.category,
                    price: medicineFeeItem.price,
                    unit: medicineFeeItem.unit,
                    description: medicineFeeItem.description,
                    quantity: days,
                    // é è¨­è—¥è²»å¯åƒèˆ‡æŠ˜æ‰£
                    includedInDiscount: true
                };
                selectedBillingItems.push(billingItem);
                updateBillingDisplay();
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const zhMsg = `å·²è‡ªå‹•æ·»åŠ è—¥è²»ï¼š${medicineFeeItem.name} x${days}å¤©`;
                    const enMsg = `Auto-added medicine fee: ${medicineFeeItem.name} x${days} days`;
                    const msg = lang === 'en' ? enMsg : zhMsg;
                    showToast(msg, 'info');
                }
            }
        }
        
        // è™•ç†å¤©æ•¸è¼¸å…¥æ¡†ç›´æŽ¥è®Šæ›´
        function updateMedicationDaysFromInput() {
            const daysInput = document.getElementById('medicationDays');
            const days = parseInt(daysInput.value) || 5;
            
            // ç¢ºä¿å¤©æ•¸åœ¨æœ‰æ•ˆç¯„åœå…§
            const validDays = Math.max(1, Math.min(30, days));
            if (validDays !== days) {
                daysInput.value = validDays;
            }
            
            // æ›´æ–°è™•æ–¹é¡¯ç¤º
            if (selectedPrescriptionItems.length > 0) {
                updatePrescriptionDisplay();
            }
            
            // è‡ªå‹•æ›´æ–°è—¥è²»
            updateMedicineFeeByDays(validDays);
        }
        
        // æ›´æ–°ä¼‘æ¯æœŸé–“é¡¯ç¤º
        function updateRestPeriod() {
            const startDateInput = document.getElementById('formRestStartDate');
            const endDateInput = document.getElementById('formRestEndDate');
            const displaySpan = document.getElementById('restPeriodDisplay');
            
            if (!startDateInput || !endDateInput || !displaySpan) return;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end >= start) {
                    const timeDiff = end.getTime() - start.getTime();
                    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // åŒ…å«é–‹å§‹å’ŒçµæŸæ—¥æœŸ
                    displaySpan.textContent = `å…± ${daysDiff} å¤©`;
                    displaySpan.className = 'text-sm text-blue-600 font-medium';
                } else {
                    displaySpan.textContent = 'çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ';
                    displaySpan.className = 'text-sm text-red-600 font-medium';
                }
            } else {
                displaySpan.textContent = 'è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ';
                displaySpan.className = 'text-sm text-gray-500 font-medium';
            }
        }
        

        
        // æ›´æ–°è™•æ–¹è—¥é‡
        function updatePrescriptionDosage(index, newDosage) {
            // ç”¨æ–¼æ›´æ–°è™•æ–¹é …ç›®çš„è—¥æåŠ‘é‡ã€‚ç•¶ä½¿ç”¨è€…å®Œæˆè¼¸å…¥ï¼ˆchange äº‹ä»¶ï¼‰æ™‚è§¸ç™¼ã€‚
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const dosage = parseFloat(newDosage);
                // å…è¨±çš„ç¯„åœï¼š0.5 å…‹è‡³ 100 å…‹ã€‚å›  input çš„ step è¨­ç‚º 0.5ï¼Œä½¿ç”¨ > 0 ä»åŒ…å« 0.5ã€‚
                if (dosage > 0 && dosage <= 100) {
                    // å°‡ä½¿ç”¨è€…è¼¸å…¥å€¼ï¼ˆå­—ä¸²ï¼‰å­˜å›žè‡ªè¨‚åŠ‘é‡æ¬„ï¼Œä»¥ä¾¿é‡æ–°æ¸²æŸ“æ™‚ä½¿ç”¨ç›¸åŒå€¼
                    selectedPrescriptionItems[index].customDosage = newDosage;
                    // é‡æ–°ç”Ÿæˆè™•æ–¹æ–‡æœ¬èˆ‡ç•«é¢
                    updatePrescriptionDisplay();
                } else {
                    // è‹¥è¼¸å…¥ç„¡æ•ˆï¼Œä¸æ›´æ–°è³‡æ–™ï¼Œåƒ…é‡æ–°æ¸²æŸ“ä»¥å›žå¾©åŽŸå€¼
                    updatePrescriptionDisplay();
                    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„è—¥é‡ï¼ˆ0.5-100å…‹ï¼‰', 'warning');
                }
            }
        }

        /**
         * å³æ™‚æ›´æ–°è™•æ–¹è—¥é‡ã€‚
         * åœ¨ä½¿ç”¨è€…è¼¸å…¥éŽç¨‹ä¸­ï¼ˆinput äº‹ä»¶ï¼‰å‘¼å«æ­¤å‡½å¼ï¼Œåªæ›´æ–°è‡ªè¨‚åŠ‘é‡è€Œä¸é‡æ–°æ¸²æŸ“ç•«é¢ã€‚
         * é€™æ¨£å³ä¾¿åœ¨è¼¸å…¥æœŸé–“é é¢å› å…¶ä»–æ“ä½œè€Œé‡æ–°æ¸²æŸ“ï¼Œä¹Ÿæœƒä¿ç•™è¼¸å…¥ä¸­çš„æ•¸å€¼ã€‚
         *
         * @param {number} index é¸å®šè™•æ–¹é …ç›®çš„ç´¢å¼•
         * @param {string} newDosage ä½¿ç”¨è€…è¼¸å…¥çš„æ–°åŠ‘é‡å­—ä¸²
         */
        function updatePrescriptionDosageLive(index, newDosage) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                // ç›´æŽ¥æ›´æ–° customDosageï¼Œä¸å°å€¼åšè§£æžæˆ–é©—è­‰ï¼Œä»¥ä¾¿ä¿ç•™ä½¿ç”¨è€…è¼¸å…¥
                selectedPrescriptionItems[index].customDosage = newDosage;
            }
        }
        

        
        // ç§»é™¤è™•æ–¹é …ç›®
        function removePrescriptionItem(index) {
            if (index >= 0 && index < selectedPrescriptionItems.length) {
                const removedItem = selectedPrescriptionItems.splice(index, 1)[0];
                updatePrescriptionDisplay();
                // ç§»é™¤è™•æ–¹é …ç›®å¾Œï¼Œé‡æ–°æª¢æŸ¥æ˜¯å¦ä»æœ‰ç¦å¿Œé…ä¼
                checkPrescriptionConflicts();
                // åŒæ™‚æ ¹æ“šè™•æ–¹å…§å®¹æ±ºå®šæ˜¯å¦å…è¨±åˆ‡æ›åº«å­˜é¡žåž‹
                updatePrescriptionTypeSelectStatus();
                // ç§»é™¤è™•æ–¹é …ç›®æ™‚ï¼Œè‹¥æ¸¸æ¨™ä»åœ¨åŽŸä½ç½®æœƒå°Žè‡´ tooltip æ®˜ç•™ï¼Œæ•…æ‰‹å‹•éš±è—
                if (typeof hideTooltip === 'function') {
                    hideTooltip();
                }
                
                // å¦‚æžœç§»é™¤å¾Œæ²’æœ‰è™•æ–¹é …ç›®äº†ï¼Œç§»é™¤è—¥è²»
                if (selectedPrescriptionItems.length === 0) {
                    // å°‹æ‰¾ä¸¦ç§»é™¤è—¥è²»é …ç›®
                    const medicineFeeItem = billingItems.find(item => 
                        item.active && 
                        item.category === 'medicine' && 
                        (item.name.includes('ä¸­è—¥') || item.name.includes('è—¥è²»') || item.name.includes('èª¿åŠ‘'))
                    );
                    
                    if (medicineFeeItem) {
                        const medicineFeeIndex = selectedBillingItems.findIndex(item => 
                            item.id === medicineFeeItem.id
                        );
                        
                        if (medicineFeeIndex !== -1) {
                            selectedBillingItems.splice(medicineFeeIndex, 1);
                            updateBillingDisplay();
                        }
                    }
                }
            }
        }
        
        // æ¸…é™¤è™•æ–¹æœç´¢
        function clearPrescriptionSearch() {
            document.getElementById('prescriptionSearch').value = '';
            document.getElementById('prescriptionSearchResults').classList.add('hidden');
            // æ¸…é™¤æœç´¢æ™‚åŒæ­¥éš±è—ä»»ä½•å·²é¡¯ç¤ºçš„ tooltipï¼Œé¿å…æ¸¸æ¨™ä»åœç•™åœ¨åŽŸä½å°Žè‡´æç¤ºæ¡†æ®˜ç•™
            if (typeof hideTooltip === 'function') {
                hideTooltip();
            }
        }
        
        // æ”¶è²»é …ç›®æœç´¢åŠŸèƒ½
async function searchBillingForConsultation() {
            const searchTerm = document.getElementById('billingSearch').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('billingSearchResults');
            const resultsList = document.getElementById('billingSearchList');

            if (searchTerm.length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }

            // ç¢ºä¿æ”¶è²»é …ç›®è³‡æ–™å·²è¼‰å…¥ã€‚è‹¥å°šæœªè¼‰å…¥ï¼Œå‘¼å«åˆå§‹åŒ–å‡½å¼è¼‰å…¥æœ¬åœ°æˆ–é ç«¯è³‡æ–™ã€‚
            try {
                if (typeof initBillingItems === 'function' && !billingItemsLoaded) {
                    await initBillingItems();
                }
            } catch (err) {
                console.error('è¼‰å…¥æ”¶è²»é …ç›®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
            }

            // æª¢æŸ¥æ˜¯å¦ä»ç„¡è³‡æ–™ï¼Œé¿å…æœå°‹å‡ºç¾ç©ºç™½
            const itemsForSearch = Array.isArray(billingItems) ? billingItems : [];

            // æœç´¢åŒ¹é…çš„æ”¶è²»é …ç›®ï¼ˆåªé¡¯ç¤ºå•Ÿç”¨çš„é …ç›®ï¼‰
            const matchedItems = itemsForSearch.filter(item => 
                item && item.active && (
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                )
            ).slice(0, 10); // é™åˆ¶é¡¯ç¤ºå‰10å€‹çµæžœ

            if (!matchedItems || matchedItems.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-3 text-center text-gray-500 text-sm">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ”¶è²»é …ç›®
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }

            // é¡¯ç¤ºæœç´¢çµæžœ
            resultsList.innerHTML = matchedItems.map(item => {
                const categoryNames = {
                    consultation: 'è¨ºç™‚è²»',
                    medicine: 'è—¥è²»',
                    treatment: 'æ²»ç™‚è²»',
                    other: 'å…¶ä»–',
                    discount: 'æŠ˜æ‰£é …ç›®',
                    package: 'å¥—ç¥¨é …ç›®',
                    packageUse: 'å¥—ç¥¨ä½¿ç”¨'
                };
                const categoryName = categoryNames[item.category] || 'æœªåˆ†é¡ž';
                const bgColor = getCategoryBgColor(item.category);

                return `
                    <div class="p-3 ${bgColor} border rounded-lg cursor-pointer transition duration-200" onclick="addToBilling('${item.id}')">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900 text-sm mb-1">${item.name}</div>
                            <div class="text-xs bg-white text-gray-600 px-2 py-1 rounded mb-2">${categoryName}</div>
                            ${item.category !== 'discount' ? `
                                <div class="text-sm font-bold text-green-600">
                                    $${item.price}
                                </div>
                            ` : ''}
                            ${item.unit ? `<div class="text-xs text-gray-600">/ ${item.unit}</div>` : ''}
                            ${item.description ? `<div class="text-xs text-gray-600 mt-1">${item.description.substring(0, 30)}${item.description.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            resultsContainer.classList.remove('hidden');
        }
        
        // ç²å–é¡žåˆ¥èƒŒæ™¯é¡è‰²
        function getCategoryBgColor(category) {
            const colors = {
                consultation: 'bg-blue-50 hover:bg-blue-100 border-blue-200',
                medicine: 'bg-green-50 hover:bg-green-100 border-green-200',
                treatment: 'bg-orange-50 hover:bg-orange-100 border-orange-200',
                other: 'bg-gray-50 hover:bg-gray-100 border-gray-200',
                discount: 'bg-red-50 hover:bg-red-100 border-red-200',
                package: 'bg-purple-50 hover:bg-purple-100 border-purple-200',
                packageUse: 'bg-purple-50 hover:bg-purple-100 border-purple-200'
            };
            return colors[category] || colors.other;
        }
        
        // æ·»åŠ åˆ°æ”¶è²»é …ç›®
        function addToBilling(itemId) {
            // å°‡ ID è½‰ç‚ºå­—ä¸²ä»¥ç¢ºä¿èˆ‡è³‡æ–™ä¸­çš„ ID æ¯”å°ä¸€è‡´
            const idStr = String(itemId);
            const item = billingItems.find(b => String(b.id) === idStr);
            if (!item) return;

            // å¦‚ç‚ºå¥—ç¥¨é …ç›®ä¸”ç›®å‰ä¸å…è¨±ä¿®æ”¹å¥—ç¥¨ï¼Œå‰‡åœæ­¢ä¸¦é¡¯ç¤ºè­¦å‘Š
            if (item.category === 'package' && !canModifyPackageItems()) {
                showToast('è¨ºç—‡å®Œæˆå¾Œç„¡æ³•æ–°å¢žå¥—ç¥¨', 'warning');
                // æ¸…ç†æœå°‹çµæžœé¿å…æ®˜ç•™
                clearBillingSearch();
                return;
            }

            // æª¢æŸ¥æŠ˜æ‰£ä½¿ç”¨é™åˆ¶ï¼šæ¯å€‹è¨ºç—‡åƒ…èƒ½æœ‰ä¸€å€‹æŠ˜æ‰£é …ç›®ã€‚
            if (item.category === 'discount') {
                // å¦‚æžœåˆ—è¡¨ä¸­å·²ç¶“å­˜åœ¨ä»»ä½•æŠ˜æ‰£é …ç›®ï¼Œå‰‡ç¦æ­¢å†æ·»åŠ å…¶ä»–æŠ˜æ‰£
                const hasAnyDiscount = selectedBillingItems.some(b => b && b.category === 'discount');
                if (hasAnyDiscount) {
                    showToast('æ¯å€‹è¨ºç—‡åƒ…èƒ½ä½¿ç”¨ä¸€é …æŠ˜æ‰£å„ªæƒ ', 'warning');
                    // æ¸…ç†æœå°‹çµæžœé¿å…æ®˜ç•™
                    clearBillingSearch();
                    return;
                }
                // å¦‚æžœå·²æœ‰åŒåæŠ˜æ‰£ï¼Œç¦æ­¢å†æ·»åŠ ï¼ˆåç¨±é‡è¤‡ä»ä¸å¯ï¼‰
                const duplicateDiscount = selectedBillingItems.some(b => b && b.category === 'discount' && b.name === item.name);
                if (duplicateDiscount) {
                    showToast('åŒåæŠ˜æ‰£é …ç›®åƒ…èƒ½ä½¿ç”¨ä¸€é …', 'warning');
                    // æ¸…ç†æœå°‹çµæžœé¿å…æ®˜ç•™
                    clearBillingSearch();
                    return;
                }
            }

            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ éŽç›¸åŒ ID
            const existingIndex = selectedBillingItems.findIndex(b => String(b.id) === idStr);
            if (existingIndex !== -1) {
                // å¦‚æžœå·²å­˜åœ¨
                const existingItem = selectedBillingItems[existingIndex];
                // æŠ˜æ‰£é …ç›®ä¸å…è¨±å¢žåŠ æ•¸é‡
                if (existingItem.category === 'discount') {
                    showToast('æŠ˜æ‰£é …ç›®å·²å­˜åœ¨ï¼Œç„¡æ³•é‡è¤‡ä½¿ç”¨', 'warning');
                } else {
                    // å…¶ä»–é¡žåˆ¥é …ç›®å¢žåŠ æ•¸é‡
                    existingItem.quantity += 1;
                }
            } else {
                // æ·»åŠ æ–°é …ç›®
                const billingItem = {
                    id: idStr,
                    name: item.name,
                    category: item.category,
                    price: item.price,
                    unit: item.unit,
                    description: item.description,
                    packageUses: item.packageUses,
                    validityDays: item.validityDays,
                    quantity: 1,
                    // é è¨­é™¤æŠ˜æ‰£é …ç›®å¤–çš†å¯åƒèˆ‡æŠ˜æ‰£
                    includedInDiscount: item.category !== 'discount'
                };
                selectedBillingItems.push(billingItem);
            }

            // æ›´æ–°é¡¯ç¤º
            updateBillingDisplay();

            // æ¸…é™¤æœç´¢
            clearBillingSearch();

            {
                const lang = localStorage.getItem('lang') || 'zh';
                // Determine display names for the billing item. Use the englishName when
                // available in English mode; otherwise default to the Chinese name. Proper
                // nouns should not be passed through the translation function.
                const displayNameEn = item && item.englishName ? item.englishName : item.name;
                const displayNameZh = item.name;
                const zhMsg = `å·²æ·»åŠ æ”¶è²»é …ç›®ï¼š${displayNameZh}`;
                const enMsg = `Added billing item: ${displayNameEn}`;
                const msg = lang && lang.toLowerCase().startsWith('en') ? enMsg : zhMsg;
                showToast(msg, 'success');
            }
        }
        
        // æ›´æ–°æ”¶è²»é …ç›®é¡¯ç¤º
        function updateBillingDisplay() {
            const container = document.getElementById('selectedBillingItems');
            const hiddenTextarea = document.getElementById('formBillingItems');
            const totalAmountSpan = document.getElementById('totalBillingAmount');
            
            if (selectedBillingItems.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        è«‹ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æ·»åŠ æ”¶è²»é …ç›®
                    </div>
                `;
                hiddenTextarea.value = '';
                totalAmountSpan.textContent = '$0';
                return;
            }
            
            // è¨ˆç®—ç¸½è²»ç”¨èˆ‡æŠ˜æ‰£ç›¸é—œæ•¸å€¼
            // åˆ¤æ–·æ˜¯å¦æœ‰æŠ˜æ‰£é …ç›®
            const hasDiscount = selectedBillingItems.some(it => it.category === 'discount');
            let totalAmount = 0;
            let subtotalForDiscount = 0;
            let subtotalAllItems = 0;
            // è¨ˆç®—å…©ç¨®å°è¨ˆï¼šæ‰€æœ‰éžæŠ˜æ‰£é …ç›®åˆè¨ˆèˆ‡æŠ˜æ‰£é©ç”¨é …ç›®åˆè¨ˆ
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    const itemSubtotal = item.price * item.quantity;
                    subtotalAllItems += itemSubtotal;
                    // è‹¥æœ‰æŠ˜æ‰£ï¼Œä¸”æ­¤é …ç›®æœªè¢«æŽ’é™¤ï¼ˆundefined è¦–ç‚º trueï¼‰ï¼Œå‰‡åŠ å…¥æŠ˜æ‰£å°è¨ˆ
                    if (!hasDiscount || item.includedInDiscount !== false) {
                        subtotalForDiscount += itemSubtotal;
                    }
                }
            });
            // åŸºæ–¼æ‰€æœ‰é …ç›®è¨ˆç®—åˆå§‹ç¸½é‡‘é¡
            totalAmount = subtotalAllItems;
            if (hasDiscount) {
                selectedBillingItems.forEach(item => {
                    if (item.category === 'discount') {
                        if (item.price > 0 && item.price < 1) {
                            // ç™¾åˆ†æ¯”æŠ˜æ‰£ï¼šå°æŠ˜æ‰£é©ç”¨å°è¨ˆé€²è¡ŒæŠ˜æ‰£è¨ˆç®—
                            const discountAmount = subtotalForDiscount * (1 - item.price) * item.quantity;
                            totalAmount -= discountAmount;
                        } else {
                            // å›ºå®šé‡‘é¡æŠ˜æ‰£
                            totalAmount += item.price * item.quantity;
                        }
                    }
                });
            }
            // æ›´æ–°é¡¯ç¤ºçš„ç¸½é‡‘é¡
            totalAmountSpan.textContent = `$${totalAmount}`;
            // è¨ˆç®—æ‰€æœ‰æŠ˜æ‰£é©ç”¨é …ç›®çš„åç¨±ï¼Œç”¨æ–¼é¡¯ç¤ºæŠ˜æ‰£æ˜Žç´°
            const includedItemNames = selectedBillingItems
                .filter(it => it.category !== 'discount' && (!hasDiscount || it.includedInDiscount !== false))
                .map(it => it.name);
            
            // åˆ†é›¢æŠ˜æ‰£é …ç›®å’ŒéžæŠ˜æ‰£é …ç›®ï¼Œä½†ä¿æŒå„è‡ªçš„æ·»åŠ é †åº
            const nonDiscountItems = [];
            const discountItems = [];
            
            selectedBillingItems.forEach((item, originalIndex) => {
                if (item.category === 'discount') {
                    discountItems.push({ item, originalIndex });
                } else {
                    nonDiscountItems.push({ item, originalIndex });
                }
            });
            
            // åˆä½µé¡¯ç¤ºï¼šéžæŠ˜æ‰£é …ç›®åœ¨å‰ï¼ŒæŠ˜æ‰£é …ç›®åœ¨å¾Œ
            const displayItems = [...nonDiscountItems, ...discountItems];
            
            // åœ¨æ¸²æŸ“åˆ—è¡¨å‰å…ˆå˜—è©¦å–å¾—ç•¶å‰æŽ›è™Ÿçš„ç—…äºº IDã€‚é€™å°‡ç”¨æ–¼å¾ŒçºŒè™•ç†èˆŠç—…æ­·è¼‰å…¥çš„å¥—ç¥¨ä½¿ç”¨é …ç›®ï¼ˆé€™äº›é …ç›®ç¼ºå°‘ patientId èˆ‡ packageRecordIdï¼‰ï¼Œ
            // ä½¿å¾—ä½¿ç”¨è€…ä»ç„¶å¯ä»¥é»žæ“Šã€Œå–æ¶ˆä½¿ç”¨ã€æŒ‰éˆ•ä»¥å˜—è©¦é€€å›žå¥—ç¥¨æ¬¡æ•¸ã€‚
            let currentPatientIdForDisplay = null;
            try {
                // æ ¹æ“šå…¨åŸŸçš„ currentConsultingAppointmentId å¾ž appointments é™£åˆ—æ‰¾åˆ°ç•¶å‰æŽ›è™Ÿè³‡è¨Š
                // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´åŒ¹é…å¤±æ•—
                const currentAppt = appointments.find(appt => appt && String(appt.id) === String(currentConsultingAppointmentId));
                if (currentAppt) {
                    currentPatientIdForDisplay = currentAppt.patientId;
                }
            } catch (e) {
                // å¿½ç•¥éŒ¯èª¤ï¼Œä¿æŒ currentPatientIdForDisplay ç‚º null
            }
            // é¡¯ç¤ºå·²é¸æ“‡çš„é …ç›®ï¼ˆéžæŠ˜æ‰£é …ç›®åœ¨å‰ï¼ŒæŠ˜æ‰£é …ç›®åœ¨å¾Œï¼‰
            container.innerHTML = `
                <div class="space-y-2">
                    ${displayItems.map(({ item, originalIndex }) => {
                        const categoryNames = {
                            consultation: 'è¨ºç™‚è²»',
                            medicine: 'è—¥è²»',
                            treatment: 'æ²»ç™‚è²»',
                            other: 'å…¶ä»–',
                            discount: 'æŠ˜æ‰£é …ç›®',
                            package: 'å¥—ç¥¨é …ç›®',
                            packageUse: 'å¥—ç¥¨ä½¿ç”¨'
                        };
                        const categoryName = categoryNames[item.category] || 'æœªåˆ†é¡ž';
                        const bgColor = getCategoryBgColor(item.category);
                        let subtotal;
                        let subtotalDisplay;
                        // æª¢æŸ¥æ˜¯å¦ç‚ºå¥—ç¥¨ä½¿ç”¨
                        const isPackageUse = item.category === 'packageUse';
                        // æª¢æŸ¥æ˜¯å¦ç‚ºæŠ˜æ‰£é …ç›®
                        const isDiscountItem = item.category === 'discount';
                        // æ±ºå®šæ˜¯å¦é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•ï¼šå°æ–¼æ‰€æœ‰å¥—ç¥¨ä½¿ç”¨é …ç›®å‡æä¾›å–æ¶ˆåŠŸèƒ½ï¼Œ
                        // å³ä¾¿æ˜¯èˆŠç—…æ­·è¼‰å…¥ï¼ˆç¼ºå°‘ patientId æˆ– packageRecordIdï¼‰ã€‚
                        // å–æ¶ˆæŒ‰éˆ•ç”Ÿæˆæ™‚å„ªå…ˆä½¿ç”¨é …ç›®è‡ªèº«çš„ patientId èˆ‡ packageRecordIdï¼Œè‹¥ç¼ºå¤±å‰‡ä½¿ç”¨ç•¶å‰ç—…äºº ID èˆ‡ç©ºå­—ä¸²ã€‚
                        const patientIdForUndo = (item.patientId || currentPatientIdForDisplay || '').toString();
                        const packageRecordIdForUndo = (item.packageRecordId || '').toString();
                        const canUndo = isPackageUse;
                        const undoBtn = canUndo ? `
                                    <button
                                        type="button"
                                        class="ml-2 text-xs px-2 py-0.5 rounded border border-purple-300 text-purple-700 hover:bg-purple-50"
                                        onclick="undoPackageUse('${patientIdForUndo}', '${packageRecordIdForUndo}', '${item.id}')"
                                    >å–æ¶ˆä½¿ç”¨</button>
                                ` : '';
                        // åˆ¤æ–·æ˜¯å¦ç‚ºå¥—ç¥¨é …ç›®ï¼Œä¸”ç•¶å‰æ˜¯å¦ç¦æ­¢ä¿®æ”¹å¥—ç¥¨
                        const isPackageItem = item.category === 'package';
                        const packageLocked = isPackageItem && !canModifyPackageItems();
                        // æ ¹æ“šé …ç›®æ˜¯å¦ç‚ºå¥—ç¥¨ä½¿ç”¨æˆ–å¥—ç¥¨éŽ–å®šæ±ºå®šæ˜¯å¦é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
                        // å¥—ç¥¨ä½¿ç”¨é …ç›® (packageUse) æˆ–éŽ–å®šçš„å¥—ç¥¨ (package) ä¸æä¾›åˆªé™¤åŠŸèƒ½
                        const removeBtn = (isPackageUse || packageLocked)
                            ? ''
                            : `<button onclick="removeBillingItem(${originalIndex})" class="text-red-500 hover:text-red-700 font-bold text-lg px-2">Ã—</button>`;
                        // æ•¸é‡æŽ§åˆ¶å€ï¼šå¥—ç¥¨ä½¿ç”¨æˆ–éŽ–å®šçš„å¥—ç¥¨åƒ…é¡¯ç¤ºæ¬¡æ•¸ï¼›æŠ˜æ‰£é …ç›®ä¸é¡¯ç¤ºæ•¸é‡ï¼›å…¶ä»–é¡žåž‹å¯å¢žæ¸›æ•¸é‡
                        let quantityControls;
                        if (isDiscountItem) {
                            // æŠ˜æ‰£é …ç›®ä¸éœ€é¡¯ç¤ºæ•¸é‡
                            quantityControls = '';
                        } else if (isPackageUse || packageLocked) {
                            // å¥—ç¥¨ä½¿ç”¨æˆ–éŽ–å®šçš„å¥—ç¥¨åƒ…é¡¯ç¤ºæ¬¡æ•¸
                            quantityControls = `
                                <div class="flex items-center space-x-2 mr-3">
                                    <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                </div>
                            `;
                        } else {
                            // å…¶ä»–é¡žåˆ¥é …ç›®å¯å¢žæ¸›æ•¸é‡
                            quantityControls = `
                                <div class="flex items-center space-x-2 mr-3">
                                    <button onclick="updateBillingQuantity(${originalIndex}, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition duration-200">-</button>
                                    <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                    <button onclick="updateBillingQuantity(${originalIndex}, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600 transition duration-200">+</button>
                                </div>
                            `;
                        }
                        
                        // æ±ºå®šæ˜¯å¦é¡¯ç¤ºæŠ˜æ‰£å‹¾é¸æ¡†ï¼šæœ‰æŠ˜æ‰£é …ç›®ä¸”ç•¶å‰é …ç›®ä¸æ˜¯æŠ˜æ‰£é …äº¦ä¸æ˜¯å¥—ç¥¨ä½¿ç”¨
                        const showDiscountCheckbox = hasDiscount && item.category !== 'discount' && item.category !== 'packageUse';
                        const checkboxHtml = showDiscountCheckbox ? `<div class="mr-2 flex items-center"><input type="checkbox" ${item.includedInDiscount === false ? '' : 'checked'} onchange="toggleDiscountEligibility(${originalIndex})"></div>` : '';
                        // è¨ˆç®—æ¯ä¸€åˆ—çš„é‡‘é¡é¡¯ç¤º
                        if (item.category === 'discount' && item.price > 0 && item.price < 1) {
                            // ç™¾åˆ†æ¯”æŠ˜æ‰£ï¼šé¡¯ç¤ºæŠ˜æ‰£é‡‘é¡ï¼Œä»¥æŠ˜æ‰£é©ç”¨å°è¨ˆç‚ºåŸºæº–
                            const discountAmount = subtotalForDiscount * (1 - item.price) * item.quantity;
                            subtotal = -discountAmount;
                            subtotalDisplay = `-$${discountAmount.toFixed(0)}`;
                        } else {
                            // ä¸€èˆ¬é …ç›®æˆ–å›ºå®šé‡‘é¡æŠ˜æ‰£
                            subtotal = item.price * item.quantity;
                            subtotalDisplay = `$${subtotal}`;
                        }

                        return `
                            <div class="flex items-center ${bgColor} border rounded-lg p-3">
                                ${checkboxHtml}
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${item.name}</div>
                                    <div class="text-xs text-gray-600">${categoryName}</div>
                                    <div class="text-sm font-medium ${item.category === 'discount' ? 'text-red-600' : 'text-green-600'}">
                                        ${(() => {
                                            if (item.category === 'discount') {
                                                if (item.price > 0 && item.price < 1) {
                                                    return `${(item.price * 10).toFixed(1)}æŠ˜`;
                                                } else if (item.price < 0) {
                                                    return `-$${Math.abs(item.price)}`;
                                                } else {
                                                    return `$${item.price}`;
                                                }
                                            }
                                            return `$${item.price}`;
                                        })()}${item.unit ? ` / ${item.unit}` : ''}
                                    </div>
                                </div>
                                ${quantityControls}
                                <div class="mr-3 text-right">
                                    <div class="font-bold ${subtotal < 0 ? 'text-red-600' : 'text-green-600'}">${subtotalDisplay}</div>
                                </div>
                                ${undoBtn}${removeBtn}
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- å°è¨ˆå’Œç¸½è¨ˆé¡¯ç¤º -->
                ${subtotalForDiscount > 0 && hasDiscount ? `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="text-right space-y-1">
                            <div class="text-sm text-gray-600">
                                å°è¨ˆï¼š<span class="font-medium">$${subtotalForDiscount}</span>
                            </div>
                            ${selectedBillingItems.filter(item => item.category === 'discount').map(item => {
                                if (item.price > 0 && item.price < 1) {
                                    const discountAmount = subtotalForDiscount * (1 - item.price) * item.quantity;
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}${includedItemNames.length > 0 ? ` (é©ç”¨ï¼š${includedItemNames.join(',')})` : ''}ï¼š<span class="font-medium">-$${discountAmount.toFixed(0)}</span>
                                    </div>`;
                                } else {
                                    return `<div class="text-sm text-red-600">
                                        ${item.name}${includedItemNames.length > 0 ? ` (é©ç”¨ï¼š${includedItemNames.join(',')})` : ''}ï¼š<span class="font-medium">$${item.price * item.quantity}</span>
                                    </div>`;
                                }
                            }).join('')}
                            <div class="text-base font-bold text-green-600 pt-1 border-t border-gray-300">
                                ç¸½è¨ˆï¼š$${Math.round(totalAmount)}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // æ›´æ–°éš±è—çš„æ–‡æœ¬åŸŸï¼ˆéžæŠ˜æ‰£é …ç›®åœ¨å‰ï¼ŒæŠ˜æ‰£é …ç›®åœ¨å¾Œï¼‰
            let billingText = '';
            // å¦‚æžœæœ‰æŠ˜æ‰£é …ç›®ï¼Œå…ˆé¡¯ç¤ºæŠ˜æ‰£é©ç”¨å°è¨ˆ
            if (hasDiscount) {
                billingText += `å°è¨ˆï¼š$${subtotalForDiscount}\n\n`;
            }
            // å…ˆè¨˜éŒ„éžæŠ˜æ‰£é …ç›®
            selectedBillingItems.forEach(item => {
                if (item.category !== 'discount') {
                    billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                }
            });
            // å†è¨˜éŒ„æŠ˜æ‰£é …ç›®
            selectedBillingItems.forEach(item => {
                if (item.category === 'discount') {
                    if (item.price > 0 && item.price < 1) {
                        // ç™¾åˆ†æ¯”æŠ˜æ‰£
                        const discountAmount = subtotalForDiscount * (1 - item.price) * item.quantity;
                        billingText += `${item.name} x${item.quantity} = -$${discountAmount.toFixed(0)}\n`;
                    } else {
                        // å›ºå®šé‡‘é¡æŠ˜æ‰£
                        billingText += `${item.name} x${item.quantity} = $${item.price * item.quantity}\n`;
                    }
                }
            });
            // è¨˜éŒ„æŠ˜æ‰£é©ç”¨æ˜Žç´°
            if (hasDiscount) {
                billingText += `æŠ˜æ‰£é©ç”¨æ–¼: ${includedItemNames.join(',')}\n`;
            }
            billingText += `\nç¸½è²»ç”¨ï¼š$${Math.round(totalAmount)}`;
            hiddenTextarea.value = billingText.trim();
        }
        
        // æ›´æ–°æ”¶è²»é …ç›®æ•¸é‡
        function updateBillingQuantity(index, change) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const item = selectedBillingItems[index];
                // å¦‚æžœæ˜¯æŠ˜æ‰£é …ç›®ï¼Œä¸å…è¨±ä¿®æ”¹æ•¸é‡
                if (item.category === 'discount') {
                    showToast('æŠ˜æ‰£é …ç›®ä¸å…è¨±ä¿®æ”¹æ•¸é‡', 'warning');
                    return;
                }
                // å¦‚æžœæ˜¯å¥—ç¥¨ä½¿ç”¨ï¼Œä¸” change < 0ï¼Œç›´æŽ¥å–æ¶ˆä½¿ç”¨ä¸¦é€€å›žæ¬¡æ•¸
                if (change < 0 && item.category === 'packageUse') {
                    // èª¿ç”¨å–æ¶ˆå‡½å¼ï¼Œé€™æœƒè‡ªå‹•ç§»é™¤è©²ç­†è¨˜éŒ„ä¸¦é€€å›žæ¬¡æ•¸
                    undoPackageUse(item.patientId, item.packageRecordId, item.id);
                    return;
                }
                // è‹¥ç‚ºå¥—ç¥¨é …ç›®ä¸”ä¸å…è¨±ä¿®æ”¹å¥—ç¥¨ï¼Œå‰‡ä¸èª¿æ•´æ•¸é‡
                if (item && item.category === 'package' && !canModifyPackageItems()) {
                    showToast('è¨ºç—‡å®Œæˆå¾Œç„¡æ³•èª¿æ•´å¥—ç¥¨æ•¸é‡', 'warning');
                    return;
                }
                const newQuantity = item.quantity + change;
                if (newQuantity > 0) {
                    selectedBillingItems[index].quantity = newQuantity;
                    updateBillingDisplay();
                } else if (newQuantity === 0) {
                    // æ•¸é‡ç‚º0æ™‚ç§»é™¤é …ç›®
                    removeBillingItem(index);
                }
            }
        }
        
        // ç§»é™¤æ”¶è²»é …ç›®
        function removeBillingItem(index) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const removedItem = selectedBillingItems[index];
                // å¦‚æžœç‚ºå¥—ç¥¨é …ç›®ä¸”ç›®å‰ä¸å…è¨±ä¿®æ”¹å¥—ç¥¨ï¼Œå‰‡ä¸å…è¨±ç§»é™¤
                if (removedItem && removedItem.category === 'package' && !canModifyPackageItems()) {
                    showToast('è¨ºç—‡å®Œæˆå¾Œç„¡æ³•åˆªé™¤å¥—ç¥¨', 'warning');
                    return;
                }
                // å¦‚æžœæ˜¯å¥—ç¥¨ä½¿ç”¨ï¼Œç§»é™¤æ™‚éœ€è¦é€€å›žå‰©é¤˜æ¬¡æ•¸
                if (removedItem.category === 'packageUse') {
                    // ç›´æŽ¥èª¿ç”¨å–æ¶ˆå‡½å¼ï¼Œå®ƒæœƒè‡ªå‹•å¾žé™£åˆ—ç§»é™¤ä¸¦è™•ç†æ¬¡æ•¸
                    undoPackageUse(removedItem.patientId, removedItem.packageRecordId, removedItem.id);
                    return;
                }
                // å¦å‰‡ï¼Œå–®ç´”ç§»é™¤
                selectedBillingItems.splice(index, 1);
                updateBillingDisplay();
            }
        }

        // åˆ‡æ›æ”¶è²»é …ç›®æ˜¯å¦åƒèˆ‡æŠ˜æ‰£
        function toggleDiscountEligibility(index) {
            if (index >= 0 && index < selectedBillingItems.length) {
                const item = selectedBillingItems[index];
                // åªé‡å°éžæŠ˜æ‰£é …ç›®åˆ‡æ›æŠ˜æ‰£é©ç”¨ç‹€æ…‹
                if (item && item.category !== 'discount') {
                    // è‹¥ undefined æˆ– trueï¼Œè¦–ç‚ºåƒèˆ‡æŠ˜æ‰£ï¼Œåˆ‡æ›ç‚ºä¸åƒèˆ‡ï¼›è‹¥ç‚º false å‰‡æ”¹ç‚ºåƒèˆ‡
                    item.includedInDiscount = item.includedInDiscount === false ? true : false;
                    updateBillingDisplay();
                }
            }
        }
        
        // æ¸…é™¤æ”¶è²»é …ç›®æœç´¢
        function clearBillingSearch() {
            document.getElementById('billingSearch').value = '';
            document.getElementById('billingSearchResults').classList.add('hidden');
        }
        
        // æ¸…ç©ºæ‰€æœ‰æœå°‹æ¬„ä½
        function clearAllSearchFields() {
            // æ¸…ç©ºç—…äººæœå°‹æ¬„
            const patientSearchInput = document.getElementById('patientSearchInput');
            if (patientSearchInput) {
                patientSearchInput.value = '';
            }
            
            // æ¸…ç©ºè™•æ–¹æœå°‹æ¬„
            clearPrescriptionSearch();
            
            // æ¸…ç©ºæ”¶è²»é …ç›®æœå°‹æ¬„
            clearBillingSearch();
        }
        
        // è‡ªå‹•æ·»åŠ é è¨­è¨ºé‡‘æ”¶è²»
        function addDefaultConsultationFee(patient) {
            // å°‹æ‰¾è¨ºé‡‘æ”¶è²»é …ç›®ï¼ˆå„ªå…ˆå°‹æ‰¾åç¨±åŒ…å«ã€Œè¨ºé‡‘ã€çš„é …ç›®ï¼‰
            let consultationFeeItem = billingItems.find(item => 
                item.active && 
                item.category === 'consultation' && 
                item.name.includes('è¨ºé‡‘')
            );
            
            // å¦‚æžœæ²’æœ‰æ‰¾åˆ°è¨ºé‡‘é …ç›®ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹è¨ºç™‚è²»é …ç›®
            if (!consultationFeeItem) {
                consultationFeeItem = billingItems.find(item => 
                    item.active && item.category === 'consultation'
                );
            }
            
            // å¦‚æžœæ‰¾åˆ°è¨ºé‡‘é …ç›®ï¼Œè‡ªå‹•æ·»åŠ 
            if (consultationFeeItem) {
                // æ¸…ç©ºç¾æœ‰æ”¶è²»é …ç›®
                selectedBillingItems = [];
                
                // æ·»åŠ è¨ºé‡‘é …ç›®
                const billingItem = {
                    id: consultationFeeItem.id,
                    name: consultationFeeItem.name,
                    category: consultationFeeItem.category,
                    price: consultationFeeItem.price,
                    unit: consultationFeeItem.unit,
                    description: consultationFeeItem.description,
                    quantity: 1,
                    // é è¨­è¨ºé‡‘å¯åƒèˆ‡æŠ˜æ‰£
                    includedInDiscount: true
                };
                selectedBillingItems.push(billingItem);
                
                // è‡ªå‹•æ·»åŠ é è¨­è—¥è²»ï¼ˆæ ¹æ“šé è¨­5å¤©ï¼‰
                const defaultDays = 5;
                updateMedicineFeeByDays(defaultDays);
                
                // æ›´æ–°é¡¯ç¤º
                updateBillingDisplay();
            } else {
                // å¦‚æžœæ²’æœ‰æ‰¾åˆ°ä»»ä½•è¨ºç™‚è²»é …ç›®ï¼Œåªæ¸…ç©ºæ”¶è²»é …ç›®ä¸¦æ›´æ–°é¡¯ç¤º
                selectedBillingItems = [];
                updateBillingDisplay();
            }
        }
        

        
        // è¼‰å…¥ä¸Šæ¬¡è™•æ–¹å…§å®¹ï¼ˆæŒ‰éˆ•è§¸ç™¼ï¼‰
        async function loadPreviousPrescription() {
            // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¨ºç—‡çš„æŽ›è™Ÿ
            if (!currentConsultingAppointmentId) {
                showToast('è«‹å…ˆé–‹å§‹è¨ºç—‡ï¼', 'error');
                return;
            }
            // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´åŒ¹é…å¤±æ•—
            const appointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°ç•¶å‰è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            // å–å¾—è§¸ç™¼æŒ‰éˆ•ï¼šå„ªå…ˆä½¿ç”¨äº‹ä»¶ç›®æ¨™ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å¾ž DOM æŸ¥æ‰¾
            let loadingButton = null;
            try {
                if (typeof event !== 'undefined' && event && event.currentTarget) {
                    loadingButton = event.currentTarget;
                }
            } catch (_e) {
                // å¿½ç•¥äº‹ä»¶å–å¾—å¤±æ•—
            }
            if (!loadingButton) {
                loadingButton = document.querySelector('button[onclick="loadPreviousPrescription()"]');
            }
            if (loadingButton) {
                setButtonLoading(loadingButton, 'è®€å–ä¸­...');
            }
            try {
                // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
                const patientResult = await safeGetPatients(true);
                if (!patientResult.success) {
                    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
                    return;
                }
                // ä¾æ“š appointment.patientId æ‰¾åˆ°ç—…äºº
                const patient = patientResult.data.find(p => p.id === appointment.patientId);
                if (!patient) {
                    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
                    return;
                }
                // è®€å–ç—…äººçš„è¨ºç—‡è¨˜éŒ„ï¼ˆå¼·åˆ¶åˆ·æ–°ï¼‰ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
                const consultationResult = await window.firebaseDataManager.getPatientConsultations(patient.id, true);
                if (!consultationResult.success) {
                    showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                    return;
                }
                // æŽ’é™¤ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„è¨ºç—‡è¨˜éŒ„ï¼ˆå¦‚æžœæœ‰ï¼‰
                let patientConsultations = consultationResult.data || [];
                if (appointment.consultationId) {
                    patientConsultations = patientConsultations.filter(c => c.id !== appointment.consultationId);
                }
                // å–å¾—æœ€è¿‘ä¸€æ¬¡è¨ºç—‡è¨˜éŒ„
                const lastConsultation = patientConsultations.length > 0 ? patientConsultations[0] : null;
                if (!lastConsultation || !lastConsultation.prescription) {
                    {
                        const lang = localStorage.getItem('lang') || 'zh';
                        const zhMsg = `${patient.name} æ²’æœ‰ä¸Šæ¬¡è™•æ–¹è¨˜éŒ„å¯è¼‰å…¥`;
                        const enMsg = `${patient.name} has no previous prescription record to load`;
                        const msg = lang === 'en' ? enMsg : zhMsg;
                        showToast(msg, 'warning');
                    }
                    return;
                }
                // æ¸…ç©ºä¸¦è§£æžè™•æ–¹
                selectedPrescriptionItems = [];
                parsePrescriptionToItems(lastConsultation.prescription);
                updatePrescriptionDisplay();
                // åœ¨è¼‰å…¥ä¸Šæ¬¡è™•æ–¹å¾Œï¼Œè‡ªå‹•ä¾ç…§ç•¶å‰æœè—¥å¤©æ•¸æ›´æ–°è—¥è²»ã€‚
                // å…ˆè®€å–å¤©æ•¸è¼¸å…¥æ¡†çš„å€¼ï¼Œè‹¥ç„¡æ³•å–å¾—å‰‡ä½¿ç”¨é è¨­5å¤©ã€‚
                try {
                    const daysInputEl = document.getElementById('medicationDays');
                    const daysVal = daysInputEl ? parseInt(daysInputEl.value) || 5 : 5;
                    // åªæœ‰ç•¶è¼‰å…¥çš„è™•æ–¹æœ‰å…§å®¹æ™‚æ‰é€²è¡Œè—¥è²»æ›´æ–°
                    if (selectedPrescriptionItems.length > 0) {
                        updateMedicineFeeByDays(daysVal);
                    }
                } catch (_e) {
                    // å¿½ç•¥ä»»ä½•éŒ¯èª¤ï¼Œé¿å…é˜»æ–·æµç¨‹
                }
            } catch (error) {
                console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
                showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
            } finally {
                if (loadingButton) {
                    clearButtonLoading(loadingButton);
                }
            }
        }
        
        // è§£æžè™•æ–¹å…§å®¹ä¸¦é‡å»ºè™•æ–¹é …ç›®
        function parsePrescriptionToItems(prescriptionText) {
            if (!prescriptionText) return;
            
            const lines = prescriptionText.split('\n');
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i].trim();
                if (!line) {
                    i++;
                    continue;
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºè—¥æ/æ–¹åŠ‘æ ¼å¼ï¼ˆåç¨± + ç©ºæ ¼ + åŠ‘é‡ + å–®ä½ï¼‰ã€‚
                // å–®ä½å¯ç‚ºä¸­æ–‡æˆ–è‹±æ–‡ï¼Œæˆ–ç›´æŽ¥çœç•¥ã€‚èˆŠç‰ˆåƒ…æŽ¥å— g çµå°¾ï¼Œç¾æ”¹ç‚ºæŽ¥å—ä»»æ„å–®ä½ä¸¦å¿½ç•¥å–®ä½éƒ¨ä»½ã€‚
                const itemMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)(?:[a-zA-Z\u4e00-\u9fa5]*)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const dosage = itemMatch[2];
                    
                    // å…ˆåœ¨ä¸­è—¥åº«ä¸­å°‹æ‰¾å°æ‡‰çš„é …ç›®ï¼ˆå„ªå…ˆåŒ¹é…ä¸­è—¥æï¼Œå†åŒ¹é…æ–¹åŠ‘ï¼‰
                    let foundItem = herbLibrary.find(item => 
                        item.type === 'herb' && item.name === itemName
                    );
                    
                    if (foundItem) {
                        // æ‰¾åˆ°ä¸­è—¥æ
                            const prescriptionItem = {
                                id: foundItem.id,
                                type: 'herb',
                                name: foundItem.name,
                                // When reconstructing a prescription from text and the original
                                // entry lacks a dosage, default to 1â€¯g for herbs.
                                dosage: foundItem.dosage || '1g',
                                customDosage: dosage,
                                effects: foundItem.effects
                            };
                        selectedPrescriptionItems.push(prescriptionItem);
                    } else {
                        // æ²’æ‰¾åˆ°ä¸­è—¥æï¼Œå°‹æ‰¾æ–¹åŠ‘
                        foundItem = herbLibrary.find(item => 
                            item.type === 'formula' && item.name === itemName
                        );
                        
                        if (foundItem) {
                            // æ‰¾åˆ°æ–¹åŠ‘
                            const prescriptionItem = {
                                id: foundItem.id,
                                type: 'formula',
                                name: foundItem.name,
                                customDosage: dosage,
                                composition: foundItem.composition,
                                effects: foundItem.effects
                            };
                            selectedPrescriptionItems.push(prescriptionItem);
                        } else {
                            // éƒ½æ²’æ‰¾åˆ°ï¼Œæ ¹æ“šå¸¸è¦‹æ–¹åŠ‘åç¨±ç‰¹å¾µæ™ºèƒ½åˆ¤æ–·é¡žåž‹
                            const isLikelyFormula = isFormulaName(itemName);
                            
                            const prescriptionItem = {
                                id: Date.now() + Math.random(), // è‡¨æ™‚ID
                                type: isLikelyFormula ? 'formula' : 'herb',
                                name: itemName,
                                customDosage: dosage,
                                effects: 'ï¼ˆå¾žä¸Šæ¬¡è™•æ–¹è¼‰å…¥ï¼‰'
                            };
                            
                            if (isLikelyFormula) {
                                prescriptionItem.composition = 'ï¼ˆå¾žä¸Šæ¬¡è™•æ–¹è¼‰å…¥ï¼‰';
                            } else {
                                prescriptionItem.dosage = `${dosage}g`;
                            }
                            
                            selectedPrescriptionItems.push(prescriptionItem);
                        }
                    }
                }
                
                i++;
            }
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºæ–¹åŠ‘åç¨±çš„è¼”åŠ©å‡½æ•¸
        function isFormulaName(name) {
            // å¸¸è¦‹æ–¹åŠ‘åç¨±ç‰¹å¾µ
            const formulaKeywords = [
                'æ¹¯', 'æ•£', 'ä¸¸', 'è†', 'é£²', 'ä¸¹', 'ç…Ž', 'æ–¹', 'åŠ‘',
                'å››å›å­', 'å…­å›å­', 'å…«ç', 'åå…¨', 'è£œä¸­ç›Šæ°£', 'é€é™',
                'ç”˜éº¥å¤§æ£—', 'å°æŸ´èƒ¡', 'å¤§æŸ´èƒ¡', 'åŠå¤ç€‰å¿ƒ', 'é»ƒé€£è§£æ¯’',
                'æ¸…ç†±è§£æ¯’', 'éŠ€ç¿¹', 'æ¡‘èŠ', 'éº»é»ƒ', 'æ¡‚æž', 'è‘›æ ¹',
                'ç™½è™Ž', 'æ‰¿æ°£', 'ç†ä¸­', 'çœŸæ­¦', 'è‹“æ¡‚', 'äº”è‹“'
            ];
            
            return formulaKeywords.some(keyword => name.includes(keyword));
        }
        

        
        // è¼‰å…¥ä¸Šæ¬¡æ”¶è²»é …ç›®ï¼ˆæŒ‰éˆ•è§¸ç™¼ï¼‰
        async function loadPreviousBillingItems() {
            // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¨ºç—‡çš„æŽ›è™Ÿ
            if (!currentConsultingAppointmentId) {
                showToast('è«‹å…ˆé–‹å§‹è¨ºç—‡ï¼', 'error');
                return;
            }
            const appointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
            if (!appointment) {
                showToast('æ‰¾ä¸åˆ°ç•¶å‰è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            // å–å¾—è§¸ç™¼æŒ‰éˆ•
            let loadingButton = null;
            try {
                if (typeof event !== 'undefined' && event && event.currentTarget) {
                    loadingButton = event.currentTarget;
                }
            } catch (_e) {}
            if (!loadingButton) {
                loadingButton = document.querySelector('button[onclick="loadPreviousBillingItems()"]');
            }
            if (loadingButton) {
                setButtonLoading(loadingButton, 'è®€å–ä¸­...');
            }
            try {
                // ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
                const patientResult = await safeGetPatients(true);
                if (!patientResult.success) {
                    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
                    return;
                }
                // ä½¿ç”¨ appointment.patientId å–å¾—ç—…äººè³‡æ–™
                const patient = patientResult.data.find(p => p.id === appointment.patientId);
                if (!patient) {
                    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
                    return;
                }
                // å¾ž Firebase å–å¾—ç—…äººçš„è¨ºç—‡è¨˜éŒ„ä¸¦æŒ‰æ—¥æœŸæŽ’åºï¼ˆå¼·åˆ¶åˆ·æ–°ï¼‰ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
                const consultationResult = await window.firebaseDataManager.getPatientConsultations(patient.id, true);
                if (!consultationResult.success) {
                    showToast('ç„¡æ³•è®€å–è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                    return;
                }
                let patientConsultations = consultationResult.data || [];
                if (appointment.consultationId) {
                    patientConsultations = patientConsultations.filter(c => c.id !== appointment.consultationId);
                }
                // æœ€è¿‘ä¸€æ¬¡è¨ºç—‡è¨˜éŒ„
                const lastConsultation = patientConsultations.length > 0 ? patientConsultations[0] : null;
                if (!lastConsultation || !lastConsultation.billingItems) {
                    {
                        const lang = localStorage.getItem('lang') || 'zh';
                        const zhMsg = `${patient.name} æ²’æœ‰ä¸Šæ¬¡æ”¶è²»è¨˜éŒ„å¯è¼‰å…¥`;
                        const enMsg = `${patient.name} has no previous billing record to load`;
                        const msg = lang === 'en' ? enMsg : zhMsg;
                        showToast(msg, 'warning');
                    }
                    return;
                }
                // ä¿å­˜ç•¶å‰è¨ºç—‡ä¸­å·²ä½¿ç”¨çš„å¥—ç¥¨æŠµæ‰£é …ç›®ï¼ˆcategory ç‚º packageUseï¼‰
                const existingPackageUses = Array.isArray(selectedBillingItems)
                    ? selectedBillingItems.filter(item => item.category === 'packageUse')
                    : [];
                // æ¸…ç©ºç¾æœ‰æ”¶è²»é …ç›®ä¸¦è§£æž
                selectedBillingItems = [];
                parseBillingItemsFromText(lastConsultation.billingItems);
                // æ ¹æ“šè¦æ±‚ï¼šè¼‰å…¥ä¸Šæ¬¡æ”¶è²»æ™‚ï¼ŒæŽ’é™¤ä»»ä½•ã€Œä½¿ç”¨å¥—ç¥¨ã€çš„æŠµæ‰£é …ç›®èˆ‡å¥—ç¥¨è³¼è²·é …ç›®ã€‚
                // åŽŸå…ˆåƒ…æŽ’é™¤ category ç‚º 'packageUse' çš„é …ç›®ï¼ˆå³ä½¿ç”¨å¥—ç¥¨æ™‚ç”¢ç”Ÿçš„æŠµæ‰£ï¼‰ï¼Œ
                // ä½†å¾ŒçºŒéœ€æ±‚ä¹Ÿè¦æŽ’é™¤ category ç‚º 'package' çš„é …ç›®ï¼ˆå³è³¼è²·å¥—ç¥¨çš„æ”¶è²»é …ç›®ï¼‰ã€‚
                if (Array.isArray(selectedBillingItems) && selectedBillingItems.length > 0) {
                    selectedBillingItems = selectedBillingItems.filter(item => item.category !== 'packageUse' && item.category !== 'package');
                }
                // åˆä½µå…ˆå‰çš„å¥—ç¥¨ä½¿ç”¨é …ç›®ï¼Œä½¿å…¶ä¸æœƒè¢«è¦†è“‹
                if (existingPackageUses && existingPackageUses.length > 0) {
                    selectedBillingItems = existingPackageUses.concat(selectedBillingItems);
                }
                // æ›´æ–°é¡¯ç¤º
                updateBillingDisplay();
            } catch (error) {
                console.error('è®€å–ç—…äººè³‡æ–™éŒ¯èª¤:', error);
                showToast('è®€å–ç—…äººè³‡æ–™å¤±æ•—', 'error');
            } finally {
                if (loadingButton) {
                    clearButtonLoading(loadingButton);
                }
            }
        }
        
// è§£æžæ”¶è²»é …ç›®æ–‡å­—ä¸¦è¼‰å…¥
function parseBillingItemsFromText(billingText) {
    if (!billingText) {
        return;
    }
    
    // è§£æžä¸Šæ¬¡æ”¶è²»é …ç›®
    const billingLines = billingText.split('\n');
    // ç”¨æ–¼å„²å­˜æŠ˜æ‰£é©ç”¨çš„é …ç›®åç¨±åˆ—è¡¨ï¼ˆå¾žæ–‡æœ¬ä¸­è§£æžï¼‰
    let discountApplicableNames = null;
    billingLines.forEach(rawLine => {
        let line = (rawLine || '').trim();
        if (!line) return;
        // æª¢æŸ¥æŠ˜æ‰£é©ç”¨æ–¼è¡Œï¼Œæ ¼å¼å¦‚ï¼šæŠ˜æ‰£é©ç”¨æ–¼: é …ç›®1,é …ç›®2
        // ä½¿ç”¨ (.*) å…è¨±æ•ç²ç©ºå­—ä¸²ï¼Œä»¥æ”¯æ´ç„¡é …ç›®é©ç”¨æŠ˜æ‰£ï¼ˆå…¨éƒ¨æŽ’é™¤ï¼‰çš„æƒ…æ³
        const applicabilityMatch = line.match(/^æŠ˜æ‰£é©ç”¨æ–¼[:ï¼š]\s*(.*)$/);
        if (applicabilityMatch) {
            // è§£æžæ‰€æœ‰åç¨±ä¸¦åŽ»é™¤ç©ºç™½
            discountApplicableNames = applicabilityMatch[1]
                .split(',')
                .map(n => n.trim())
                .filter(n => n.length > 0);
            return;
        }
        // ç•¥éŽå°è¨ˆèˆ‡ç¸½è²»ç”¨è¡Œ
        if (line.includes('å°è¨ˆ') || line.includes('ç¸½è²»ç”¨')) return;
        // è§£æžæ”¶è²»é …ç›®æ ¼å¼ï¼šé …ç›®å xæ•¸é‡ = é‡‘é¡
        // åŽŸä¾†çš„é‚è¼¯åªåŒ¹é…å‰ç¶´ç‚ºä¸€å€‹è² è™Ÿæˆ–è²¨å¹£ç¬¦è™Ÿçš„æ•´æ•¸ï¼Œä¾‹å¦‚ "$30" æˆ– "-30"ï¼Œ
        // ä½†å°æ–¼æŠ˜æ‰£é …ç›®ä¾†èªªï¼Œé‡‘é¡å¯èƒ½å‡ºç¾çµ„åˆç¬¦è™Ÿï¼Œä¾‹å¦‚ "-$30" æˆ– "$-30"ï¼Œç”šè‡³å«æœ‰å°æ•¸éƒ¨åˆ†ï¼Œä¾‹å¦‚ "-$30.5"ã€‚
        // å¦‚æžœæ­£å‰‡ç„¡æ³•åŒ¹é…é€™äº›å½¢å¼ï¼ŒæŠ˜æ‰£é …ç›®å°±æœƒè¢«å¿½ç•¥ï¼Œé€²è€Œå°Žè‡´ç„¡æ³•é‚„åŽŸç•¶æ™‚çš„æŠ˜æ‰£ç‹€æ…‹ã€‚
        // å› æ­¤æ”¹ç”¨æ›´å¯¬é¬†çš„æ­£å‰‡å¼ä¾†æˆªå–é …ç›®åç¨±èˆ‡æ•¸é‡ï¼Œå…è¨±é‡‘é¡éƒ¨åˆ†åŒ…å«ä»»æ„çš„ã€Œ-ã€èˆ‡ã€Œ$ã€é †åºä»¥åŠå°æ•¸é»žã€‚
        // æ­¤è™•åªé—œå¿ƒå‰å…©å€‹ç¾¤çµ„ï¼ˆé …ç›®åèˆ‡æ•¸é‡ï¼‰ï¼Œç¬¬ä¸‰å€‹ç¾¤çµ„æ•ç²é‡‘é¡å­—ä¸²ï¼Œä½†å¾ŒçºŒé‚è¼¯ä¸ä½¿ç”¨é€™å€‹å€¼ã€‚
        const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+(-?\$?-?\d+(?:\.\d+)?)$/);
        if (itemMatch) {
            const itemName = itemMatch[1].trim();
            const quantity = parseInt(itemMatch[2]);
            // åœ¨æ”¶è²»é …ç›®ä¸­å°‹æ‰¾å°æ‡‰çš„é …ç›®
            const billingItem = billingItems.find(it => it.active && it.name === itemName);
            if (billingItem) {
                const selectedItem = {
                    id: billingItem.id,
                    name: billingItem.name,
                    category: billingItem.category,
                    price: billingItem.price,
                    unit: billingItem.unit,
                    description: billingItem.description,
                    quantity: quantity,
                    // é è¨­é™¤æŠ˜æ‰£é …ç›®å¤–çš†å¯åƒèˆ‡æŠ˜æ‰£
                    includedInDiscount: billingItem.category !== 'discount'
                };
                selectedBillingItems.push(selectedItem);
            } else {
                // è™•ç†å¥—ç¥¨ä½¿ç”¨é …ç›®ï¼ˆå¾žèˆŠç—…æ­·è¼‰å…¥çš„æƒ…æ³ï¼‰
                // åªè¦åç¨±åŒ…å«ã€Œä½¿ç”¨å¥—ç¥¨ã€ï¼Œå³è¦–ç‚ºå¥—ç¥¨æŠµæ‰£
                if (itemName.includes('ä½¿ç”¨å¥—ç¥¨')) {
                    selectedBillingItems.push({
                        id: `loaded-packageUse-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,
                        name: itemName,
                        category: 'packageUse',
                        price: 0,
                        unit: 'æ¬¡',
                        description: 'å¥—ç¥¨æŠµæ‰£ä¸€æ¬¡',
                        quantity: quantity,
                        // å¥—ç¥¨ä½¿ç”¨ä¸åƒèˆ‡æŠ˜æ‰£
                        includedInDiscount: false,
                        // æ¨™è¨˜ç‚ºå¾žèˆŠç—…æ­·è¼‰å…¥ï¼Œå¾…æ¢å¾© meta å¾Œå¯å–æ¶ˆä½¿ç”¨
                        isHistorical: true,
                        patientId: null,
                        packageRecordId: null
                    });
                } else {
                    // å¦‚æžœåœ¨æ”¶è²»é …ç›®ä¸­æ‰¾ä¸åˆ°ï¼Œå‰µå»ºä¸€å€‹è‡¨æ™‚é …ç›®ï¼ˆç”¨æ–¼å·²åˆªé™¤çš„æ”¶è²»é …ç›®ï¼‰
                    console.log(`æ‰¾ä¸åˆ°æ”¶è²»é …ç›®ï¼š${itemName || line}ï¼Œå¯èƒ½å·²è¢«åˆªé™¤`);
                }
            }
        } else {
            // è‹¥è¡Œä¸ç¬¦åˆæ”¶è²»é …ç›®æ ¼å¼ï¼Œä¸”ä¸æ˜¯æŠ˜æ‰£é©ç”¨æ–¼è¡Œï¼Œå‰‡ç•¥éŽ
            // é€™ç¢ºä¿æ–°çš„æŠ˜æ‰£æ˜Žç´°ä¸æœƒå°Žè‡´éŒ¯èª¤
            return;
        }
    });
    // å¦‚æžœè§£æžåˆ°äº†æŠ˜æ‰£é©ç”¨æ–¼è¡Œï¼Œæ ¹æ“šå…¶ä¸­çš„åç¨±èª¿æ•´å„é …ç›®çš„æŠ˜æ‰£é©ç”¨ç‹€æ…‹
    // æ³¨æ„ï¼šå³ä½¿æŠ˜æ‰£åå–®ç‚ºç©ºï¼ˆè¡¨ç¤ºæ²’æœ‰é …ç›®é©ç”¨æŠ˜æ‰£ï¼‰ï¼Œä¹Ÿæ‡‰è©²èª¿æ•´ includedInDiscount å±¬æ€§ï¼›
    // è‹¥ discountApplicableNames ç‚º nullï¼Œè¡¨ç¤ºåŽŸæ–‡æœ¬æ²’æœ‰è©²è¡Œï¼Œå‰‡ä¿ç•™é è¨­ç‹€æ…‹ã€‚
    if (discountApplicableNames !== null) {
        selectedBillingItems.forEach(item => {
            if (item.category !== 'discount') {
                // è‹¥åç¨±åœ¨æŠ˜æ‰£é©ç”¨åå–®ä¸­å‰‡æ¨™è¨˜ç‚ºå¯åƒèˆ‡æŠ˜æ‰£ï¼Œå¦å‰‡æ¨™è¨˜ç‚ºä¸å¯åƒèˆ‡æŠ˜æ‰£
                item.includedInDiscount = discountApplicableNames.includes(item.name);
            }
        });
    }
}
        
        
        // è¼‰å…¥æŒ‡å®šç—…æ­·è¨˜éŒ„åˆ°ç•¶å‰è¨ºç—‡
        async function loadMedicalRecordToCurrentConsultation(consultationId) {
            if (!currentConsultingAppointmentId) {
                showToast('è«‹å…ˆé–‹å§‹è¨ºç—‡ï¼', 'error');
                return;
            }
            
            // å°‡å‚³å…¥çš„ ID è½‰ç‚ºå­—ä¸²ä»¥ä¾¿æ¯”è¼ƒ
            const idToFind = String(consultationId);
            // å…ˆåœ¨æœ¬åœ°è³‡æ–™ä¸­æŸ¥æ‰¾è¨ºç—‡è¨˜éŒ„ï¼ˆå…¼å®¹æ•¸å­—èˆ‡å­—ä¸²ï¼‰
            let consultation = consultations.find(c => String(c.id) === idToFind);
            // å¦‚æžœæœ¬åœ°æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ž Firebase å–å¾—
            if (!consultation) {
                try {
                    const consultationResult = await window.firebaseDataManager.getConsultations();
                    if (consultationResult.success) {
                        consultation = consultationResult.data.find(c => String(c.id) === idToFind);
                    }
                } catch (error) {
                    console.error('è®€å–è¨ºç—‡è¨˜éŒ„éŒ¯èª¤:', error);
                    // ç•™ç©ºï¼Œå¾ŒçºŒå°‡æç¤ºéŒ¯èª¤
                }
            }
            if (!consultation) {
                showToast('æ‰¾ä¸åˆ°æŒ‡å®šçš„è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…é¡žåž‹ä¸åŒ¹é…
            const currentAppointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
            if (!currentAppointment) {
                showToast('æ‰¾ä¸åˆ°ç•¶å‰è¨ºç—‡è¨˜éŒ„ï¼', 'error');
                return;
            }
            
            // ç¢ºèªæ˜¯å¦ç‚ºç›¸åŒç—…äºº
            if (currentAppointment.patientId !== consultation.patientId) {
                showToast('åªèƒ½è¼‰å…¥ç›¸åŒç—…äººçš„ç—…æ­·è¨˜éŒ„ï¼', 'error');
                return;
            }
            
// ä½¿ç”¨ forceRefresh=true ä»¥ç¢ºä¿è·¨è£ç½®åŒæ­¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
const patientResult = await safeGetPatients(true);
if (!patientResult.success) {
    showToast('ç„¡æ³•è®€å–ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const patient = patientResult.data.find(p => p.id === consultation.patientId);
if (!patient) {
    showToast('æ‰¾ä¸åˆ°ç—…äººè³‡æ–™ï¼', 'error');
    return;
}

const consultationDate = (() => {
    const d = parseConsultationDate(consultation.date);
    return d ? d.toLocaleDateString('zh-TW') : 'æœªçŸ¥æ—¥æœŸ';
})();
            
            // ç›´æŽ¥è¼‰å…¥ç—…æ­·ï¼Œä¸å½ˆå‡ºç¢ºèªæç¤ºè¦–çª—
            // æ³¨æ„ï¼šæ­¤æ“ä½œæœƒè¦†è“‹ç•¶å‰å·²å¡«å¯«çš„è¨ºç—‡å…§å®¹ï¼ˆä¸»è¨´ã€èˆŒè±¡ã€è„ˆè±¡ã€è¨ºæ–·ã€è™•æ–¹ã€æ”¶è²»é …ç›®ã€é†«å›‘ç­‰ï¼‰ï¼Œä¸”ç„¡æ³•å¾©åŽŸã€‚
            // è‹¥éœ€è¦å†æ¬¡é¡¯ç¤ºç¢ºèªæç¤ºï¼Œå¯é‡æ–°åŠ å…¥ confirm ç›¸é—œç¨‹å¼ç¢¼ã€‚
            
            // è¼‰å…¥è¨ºç—‡è³‡æ–™
            // è¼‰å…¥è¨ºç—‡è³‡æ–™
            // ä¸»è¨´åŠç¾ç—…å²çµ±ä¸€å¯«å…¥ formSymptomsï¼›è‹¥èˆŠç´€éŒ„ä»ä½¿ç”¨ currentHistory å„²å­˜ç¾ç—…å²ï¼Œå‰‡åˆä½µ
            const symptomsEl2 = document.getElementById('formSymptoms');
            if (symptomsEl2) {
                const symptomsVal = consultation.symptoms || '';
                const histVal = consultation.currentHistory || '';
                if (symptomsVal && histVal) {
                    symptomsEl2.value = symptomsVal + '\n' + histVal;
                } else if (symptomsVal) {
                    symptomsEl2.value = symptomsVal;
                } else if (histVal) {
                    symptomsEl2.value = histVal;
                } else {
                    symptomsEl2.value = '';
                }
            }
            document.getElementById('formTongue').value = consultation.tongue || '';
            document.getElementById('formPulse').value = consultation.pulse || '';
            // éŽå¾€è¨˜éŒ„æ¬„ä½åƒ…é¡¯ç¤ºæ—¢å¾€ç—…æ­·ï¼Œä¸æ‡‰è¢«è¦†è“‹
            document.getElementById('formDiagnosis').value = consultation.diagnosis || '';
            document.getElementById('formSyndrome').value = consultation.syndrome || '';
                {
                  const acnEl = document.getElementById('formAcupunctureNotes');
                  if (acnEl) {
                    // ä½¿ç”¨ innerHTML è¼‰å…¥é‡ç¸å‚™è¨»ï¼Œä»¥ä¿ç•™æ–¹å¡Šæ¨™è¨˜
                    acnEl.innerHTML = consultation.acupunctureNotes || '';
                    // è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–æ—¢æœ‰ç©´ä½æ–¹å¡Šçš„äº‹ä»¶ï¼Œä»¥ä½¿å…¶å¯åˆªé™¤èˆ‡é¡¯ç¤ºæç¤º
                    if (typeof initializeAcupointNotesSpans === 'function') {
                      try {
                        initializeAcupointNotesSpans();
                      } catch (_e) {}
                    }
                  }
                }
            document.getElementById('formUsage').value = consultation.usage || '';
            document.getElementById('formTreatmentCourse').value = consultation.treatmentCourse || '';
            document.getElementById('formInstructions').value = consultation.instructions || '';
            document.getElementById('formFollowUpDate').value = consultation.followUpDate || '';
            document.getElementById('formVisitTime').value = consultation.visitTime || '';
            
            // è¼‰å…¥ä¼‘æ¯æœŸé–“
            if (consultation.restStartDate && consultation.restEndDate) {
                document.getElementById('formRestStartDate').value = consultation.restStartDate;
                document.getElementById('formRestEndDate').value = consultation.restEndDate;
                updateRestPeriod();
            } else {
                // ä½¿ç”¨é è¨­ä¼‘æ¯æœŸé–“ï¼ˆä»Šå¤©ï¼‰ï¼Œé è¨­å»ºè­°ä¼‘æ¯ 1 å¤©
                const startDate = new Date();
                const endDate = new Date();
                // é è¨­ä¼‘æ¯æœŸé–“ç‚ºä¸€å¤©ï¼ŒçµæŸæ—¥æœŸèˆ‡é–‹å§‹æ—¥æœŸç›¸åŒ
                endDate.setDate(startDate.getDate());
                
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
                
                document.getElementById('formRestStartDate').value = startDateStr;
                document.getElementById('formRestEndDate').value = endDateStr;
                updateRestPeriod();
            }
            
            // è¼‰å…¥è™•æ–¹å…§å®¹
            selectedPrescriptionItems = [];
            // å…ˆå˜—è©¦å¾žçµæ§‹åŒ–è™•æ–¹è³‡æ–™é‡å»º
            let prescriptionLoaded = false;
            if (consultation.prescriptionStructured) {
                try {
                    const parsedItems = JSON.parse(consultation.prescriptionStructured);
                    if (Array.isArray(parsedItems) && parsedItems.length > 0) {
                        selectedPrescriptionItems = parsedItems;
                        prescriptionLoaded = true;
                    }
                } catch (_e) {
                    prescriptionLoaded = false;
                }
            }
            if (prescriptionLoaded) {
                // ä½¿ç”¨æ›´æ–°å‡½å¼æ¸²æŸ“è™•æ–¹ä¸¦åŒæ­¥éš±è—æ–‡æœ¬åŸŸ
                updatePrescriptionDisplay();
            } else if (consultation.prescription) {
                // fallbackï¼šä»ç„¶ä½¿ç”¨èˆŠç‰ˆæ–‡å­—è™•æ–¹é€²è¡Œè§£æž
                document.getElementById('formPrescription').value = consultation.prescription;
                // å˜—è©¦è§£æžè™•æ–¹å…§å®¹ä¸¦ç”Ÿæˆè™•æ–¹é …ç›®åˆ—è¡¨
                parsePrescriptionToItems(consultation.prescription);
                updatePrescriptionDisplay();
                // è‹¥è§£æžå¾Œæ²’æœ‰ä»»ä½•é …ç›®ï¼Œå‰‡ç›´æŽ¥é¡¯ç¤ºåŽŸå§‹æ–‡å­—
                if (selectedPrescriptionItems.length === 0) {
                    document.getElementById('formPrescription').value = consultation.prescription;
                    const containerEl = document.getElementById('selectedPrescriptionItems');
                    if (containerEl) {
                        // ä½¿ç”¨ whitespace-pre-line ä½¿åŽŸå§‹è™•æ–¹æ›è¡Œä¿æŒ
                        containerEl.innerHTML = '<div class="text-sm text-gray-900 whitespace-pre-line">' + consultation.prescription + '</div>';
                    }
                    const medicationSettingsEl = document.getElementById('medicationSettings');
                    if (medicationSettingsEl) {
                        medicationSettingsEl.style.display = 'none';
                    }
                }
            } else {
                // ç„¡è™•æ–¹è³‡æ–™æ™‚æ¸…ç©º
                document.getElementById('formPrescription').value = '';
                updatePrescriptionDisplay();
            }
            
            // è¼‰å…¥æ”¶è²»é …ç›®
            // å…ˆä¿å­˜ç•¶å‰è¨ºç—‡ä¸­å·²ä½¿ç”¨çš„å¥—ç¥¨æŠµæ‰£é …ç›®ï¼ˆcategory ç‚º packageUseï¼‰ï¼Œä»¥é¿å…è¦†è“‹
            const existingPackageUses = Array.isArray(selectedBillingItems)
                ? selectedBillingItems.filter(item => item.category === 'packageUse')
                : [];
            // æ¸…ç©ºç¾æœ‰æ”¶è²»é …ç›®
            selectedBillingItems = [];
            if (consultation.billingItems) {
                // ç›´æŽ¥å°‡æ”¶è²»é …ç›®è¨­ç½®åˆ°éš±è—æ–‡æœ¬åŸŸ
                document.getElementById('formBillingItems').value = consultation.billingItems;

                // è§£æžä¸¦è¼‰å…¥æ”¶è²»é …ç›®
                parseBillingItemsFromText(consultation.billingItems);

                // æ ¹æ“šè¦æ±‚ï¼šè¼‰å…¥ç—…æ­·æ™‚ï¼ŒæŽ’é™¤ä»»ä½•ã€Œä½¿ç”¨å¥—ç¥¨ã€çš„æŠµæ‰£é …ç›®èˆ‡å¥—ç¥¨è³¼è²·é …ç›®ã€‚
                // é€™äº›é …ç›®åœ¨ parseBillingItemsFromText ä¸­æœƒè¢«æ¨™è¨˜ç‚º category === 'packageUse' æˆ– category === 'package'ã€‚
                if (Array.isArray(selectedBillingItems) && selectedBillingItems.length > 0) {
                    selectedBillingItems = selectedBillingItems.filter(item => item.category !== 'packageUse' && item.category !== 'package');
                }

                // åˆä½µä¿ç•™ä¸‹ä¾†çš„å¥—ç¥¨ä½¿ç”¨é …ç›®ï¼Œä½¿å…¶ä¸æœƒè¢«è¦†è“‹
                if (existingPackageUses && existingPackageUses.length > 0) {
                    selectedBillingItems = existingPackageUses.concat(selectedBillingItems);
                }

                // å˜—è©¦ç‚ºèˆŠè¨˜éŒ„è£œå…¨å¥—ç¥¨ä½¿ç”¨çš„ meta è³‡è¨Šï¼ˆpatientId èˆ‡ packageRecordIdï¼‰ã€‚
                // æ­¤æ­¥é©Ÿåœ¨ç§»é™¤å¥—ç¥¨ä½¿ç”¨é …ç›®å¾Œä¾ç„¶å‘¼å«ï¼Œä¸æœƒå°çµæžœé€ æˆå½±éŸ¿ã€‚
                try {
                    // ä»¥å‰çš„ç¨‹å¼ç¢¼ä¸­ç›´æŽ¥ä½¿ç”¨æœªå®£å‘Šçš„ appointment è®Šæ•¸ï¼Œå°Žè‡´ ReferenceErrorã€‚
                    // æ”¹ç‚ºä½¿ç”¨å‰é¢å–å¾—çš„ currentAppointmentï¼ˆç•¶å‰æŽ›è™Ÿï¼‰ä¾†å–å¾—ç—…äºº IDã€‚
                    const pidForRestore = (currentAppointment && currentAppointment.patientId) ? currentAppointment.patientId : null;
                    if (pidForRestore) {
                        await restorePackageUseMeta(pidForRestore);
                    }
                } catch (e) {
                    console.error('æ¢å¾©å¥—ç¥¨ä½¿ç”¨ meta éŒ¯èª¤:', e);
                }

                // æ›´æ–°æ”¶è²»é¡¯ç¤º
                updateBillingDisplay();
            } else {
                // æ²’æœ‰æ–°æ”¶è²»é …ç›®ï¼Œä½†ä»ä¿ç•™å…ˆå‰çš„å¥—ç¥¨ä½¿ç”¨é …ç›®
                if (existingPackageUses && existingPackageUses.length > 0) {
                    selectedBillingItems = existingPackageUses;
                }
                // æ¸…ç©ºéš±è—æ–‡æœ¬åŸŸ
                document.getElementById('formBillingItems').value = '';
                // æ›´æ–°æ”¶è²»é¡¯ç¤º
                updateBillingDisplay();
            }
            
            // æ¸…é™¤æœç´¢æ¡†
            clearPrescriptionSearch();
            clearBillingSearch();
            
            // é—œé–‰ç—…æ­·æŸ¥çœ‹å½ˆçª—
            closeMedicalHistoryModal();
            
            // æ»¾å‹•åˆ°è¨ºç—‡è¡¨å–®
            document.getElementById('consultationForm').scrollIntoView({ behavior: 'smooth' });
            
            {
                const lang = localStorage.getItem('lang') || 'zh';
                const nameStr = patient ? patient.name : 'æœªçŸ¥ç—…äºº';
                const nameEn = patient ? patient.name : 'unknown patient';
                const zhMsg = `å·²è¼‰å…¥ ${nameStr} åœ¨ ${consultationDate} çš„å®Œæ•´ç—…æ­·è¨˜éŒ„`;
                const enMsg = `Loaded full medical record for ${nameEn} on ${consultationDate}`;
                const msg = lang === 'en' ? enMsg : zhMsg;
                showToast(msg, 'success');
            }
        }
        
        // æ¸…ç©ºè¨ºç—‡è¡¨å–®æ™‚ä¹Ÿè¦æ¸…ç©ºè™•æ–¹æœç´¢



        // ç²å–ç”¨æˆ¶é¡¯ç¤ºåç¨±ï¼ˆå§“åå…¨å + è·ä½ï¼‰
        function getUserDisplayName(user) {
            if (!user || !user.name) return 'æœªçŸ¥ç”¨æˆ¶';

            const fullName = user.name;
            const position = user.position || 'ç”¨æˆ¶';

            // ä½¿ç”¨åœ‹éš›åŒ–å‡½å¼ç¿»è­¯è·ä½åç¨±ï¼Œå¦‚æžœç•¶å‰èªžè¨€ç‚ºä¸­æ–‡ï¼Œç¿»è­¯çµæžœæœƒèˆ‡åŽŸæ–‡ä¸€è‡´ã€‚
            const translate = typeof window.t === 'function' ? window.t : (s) => s;
            const translatedPosition = translate(position);
            // è‹¥ç¿»è­¯å¾Œçš„è·ä½èˆ‡åŽŸè·ä½ä¸åŒï¼ˆä¾‹å¦‚è‹±æ–‡ç•Œé¢ï¼‰ï¼Œå‰‡åœ¨å§“åèˆ‡è·ä½ä¹‹é–“æ’å…¥ç©ºæ ¼ã€‚
            const joiner = translatedPosition !== position ? ' ' : '';
            return `${fullName}${joiner}${translatedPosition}`;
        }
        
        // ç²å–é†«å¸«é¡¯ç¤ºåç¨±
        function getDoctorDisplayName(doctorRole) {
            if (!doctorRole) return 'æœªè¨˜éŒ„';
            
            // å¦‚æžœæ˜¯èˆŠçš„å›ºå®šå€¼ï¼Œç›´æŽ¥è¿”å›ž
            if (doctorRole === 'doctor') {
                return 'å¼µä¸­é†«å¸«é†«å¸«';
            }
            
            // å°‹æ‰¾å°æ‡‰çš„é†«å¸«ç”¨æˆ¶
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser) {
                return getUserDisplayName(doctorUser);
            }
            
            // å¦‚æžœæ‰¾ä¸åˆ°ï¼Œè¿”å›žåŽŸå€¼
            return doctorRole;
        }
        
        // ç²å–é†«å¸«è¨»å†Šç·¨è™Ÿ
        function getDoctorRegistrationNumber(doctorRole) {
            if (!doctorRole) return null;
            
            // å¦‚æžœæ˜¯èˆŠçš„å›ºå®šå€¼ï¼Œè¿”å›žé è¨­è¨»å†Šç·¨è™Ÿ
            if (doctorRole === 'doctor') {
                return 'CM001234';
            }
            
            // å°‹æ‰¾å°æ‡‰çš„é†«å¸«ç”¨æˆ¶
            const doctorUser = users.find(u => u.username === doctorRole);
            if (doctorUser && doctorUser.position === 'é†«å¸«') {
                return doctorUser.registrationNumber || null;
            }
            
            return null;
        }
        
// ç”¨æˆ¶ç®¡ç†åŠŸèƒ½
let editingUserId = null;
let currentUserFilter = 'all';
let usersFromFirebase = []; // å„²å­˜å¾ž Firebase è®€å–çš„ç”¨æˆ¶æ•¸æ“š

async function loadUserManagement() {
    await loadUsersFromFirebase();
    displayUsers();
    
    // æœå°‹åŠŸèƒ½
    const searchInput = document.getElementById('searchUser');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            displayUsers();
        });
    }
}

// å¾ž Firebase è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
async function loadUsersFromFirebase() {
    // åœ¨è¼‰å…¥ç”¨æˆ¶è³‡æ–™å‰å…ˆç¢ºä¿ Firebase DataManager å·²å°±ç·’ï¼Œé¿å…å°šæœªåˆå§‹åŒ–é€ æˆè®€å–å¤±æ•—
    if (typeof waitForFirebaseDataManager === 'function') {
        try {
            await waitForFirebaseDataManager();
        } catch (e) {
            console.warn('ç­‰å¾… FirebaseDataManager å°±ç·’æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
        }
    }
    const tbody = document.getElementById('userList');
    // è‹¥æ‰¾ä¸åˆ° userList å…ƒç´ ï¼Œå‰‡æå‰çµæŸ
    if (!tbody) {
        console.warn('æ‰¾ä¸åˆ° userList å…ƒç´ ï¼Œç„¡æ³•è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨');
        return;
    }
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                <div class="mt-2">è¼‰å…¥ä¸­...</div>
            </td>
        </tr>
    `;

    try {
        // æ”¹ç‚ºä½¿ç”¨ fetchUsers() ä»¥åˆ©ç”¨å¿«å–æ¸›å°‘è®€å–æ¬¡æ•¸
        const data = await fetchUsers();
        if (Array.isArray(data) && data.length > 0) {
            usersFromFirebase = data;
            users = data.map(user => ({
                ...user,
                createdAt: user.createdAt ? (user.createdAt.seconds ? new Date(user.createdAt.seconds * 1000).toISOString() : user.createdAt) : new Date().toISOString(),
                updatedAt: user.updatedAt ? (user.updatedAt.seconds ? new Date(user.updatedAt.seconds * 1000).toISOString() : user.updatedAt) : new Date().toISOString(),
                lastLogin: user.lastLogin ? (user.lastLogin.seconds ? new Date(user.lastLogin.seconds * 1000).toISOString() : user.lastLogin) : null
            }));
            console.log('å·²è¼‰å…¥ç”¨æˆ¶æ•¸æ“š (ä½¿ç”¨å¿«å–):', usersFromFirebase.length, 'ç­†');
        } else {
            // å¦‚æžœè®€å–å¤±æ•—æˆ–ç„¡è³‡æ–™ï¼Œä½¿ç”¨æœ¬åœ° users æ•¸æ“š
            usersFromFirebase = users;
            console.log('å¿«å–æˆ– Firebase è®€å–å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°ç”¨æˆ¶æ•¸æ“š');
        }
    } catch (error) {
        console.error('è¼‰å…¥ç”¨æˆ¶æ•¸æ“šéŒ¯èª¤:', error);
        usersFromFirebase = users; // ä½¿ç”¨æœ¬åœ°æ•¸æ“šä½œç‚ºå‚™ç”¨
        showToast('è¼‰å…¥ç”¨æˆ¶æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š', 'warning');
    }
}

function filterUsers(status) {
    currentUserFilter = status;
    
    // æ›´æ–°æŒ‰éˆ•æ¨£å¼
    document.querySelectorAll('[id^="user-filter-"]').forEach(btn => {
        btn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-200';
    });
    // è¨­å®šç•¶å‰ç¯©é¸æŒ‰éˆ•æ¨£å¼ï¼Œè‹¥å…ƒç´ ä¸å­˜åœ¨å‰‡å¿½ç•¥
    const activeBtn = document.getElementById(`user-filter-${status}`);
    if (activeBtn) {
        activeBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 transition duration-200';
    }
    displayUsers();
}

function displayUsers() {
    // å–å¾—æœå°‹é—œéµå­—ï¼Œè‹¥æœå°‹æ¬„ä½ä¸å­˜åœ¨å‰‡ä½¿ç”¨ç©ºå­—ä¸²
    const searchInput = document.getElementById('searchUser');
    const searchTerm = searchInput && searchInput.value
        ? String(searchInput.value).toLowerCase()
        : '';
    const tbody = document.getElementById('userList');
    // è‹¥æ‰¾ä¸åˆ° userList å…ƒç´ å‰‡ä¸é€²è¡Œæ¸²æŸ“
    if (!tbody) {
        console.warn('æ‰¾ä¸åˆ° userList å…ƒç´ ï¼Œç„¡æ³•æ¸²æŸ“ç”¨æˆ¶åˆ—è¡¨');
        return;
    }
    
    // ä½¿ç”¨ Firebase æ•¸æ“šæˆ–æœ¬åœ°æ•¸æ“š
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    
    // éŽæ¿¾ç”¨æˆ¶è³‡æ–™
    let filteredUsers = currentUsers.filter(user => {
        // åƒ…ä»¥å§“åæˆ–é›»å­éƒµä»¶é€²è¡Œæœå°‹ï¼Œä¸åŒ…å«å¸³è™Ÿ
        const matchesSearch = user.name.toLowerCase().includes(searchTerm) ||
                            (user.email && user.email.toLowerCase().includes(searchTerm));
        
        let matchesFilter = true;
        if (currentUserFilter === 'inactive') {
            matchesFilter = !user.active;
        }
        
        return matchesSearch && matchesFilter;
    });
    
        tbody.innerHTML = '';
    
    if (filteredUsers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    ${searchTerm ? 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¨æˆ¶' : 'å°šç„¡ç”¨æˆ¶è³‡æ–™'}
                </td>
            </tr>
        `;
        return;
    }
    
        filteredUsers.forEach(user => {
        const statusClass = user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const statusText = user.active ? 'å•Ÿç”¨' : 'åœç”¨';
        
        // è™•ç† Firebase Timestamp æ ¼å¼
        let lastLogin = 'å¾žæœªç™»å…¥';
        if (user.lastLogin) {
            if (user.lastLogin.seconds) {
                lastLogin = new Date(user.lastLogin.seconds * 1000).toLocaleString('zh-TW');
            } else {
                lastLogin = new Date(user.lastLogin).toLocaleString('zh-TW');
            }
        }
        // å°å‹•æ…‹è³‡æ–™é€²è¡Œè½‰ç¾©
        const safeId = window.escapeHtml(String(user.id));
        const safeName = window.escapeHtml(user.name);
        const safePosition = window.escapeHtml(user.position || 'æœªè¨­å®š');
        const safeRegNumber = user.position === 'é†«å¸«' ? window.escapeHtml(user.registrationNumber || 'æœªè¨­å®š') : '-';
        const safeEmail = window.escapeHtml(user.email || 'æœªè¨­å®š');
        const safeLastLogin = window.escapeHtml(lastLogin);
        let actionsHtml;
        const superAdminEmail = 'admin@clinic.com';
        if (user.email && user.email.toLowerCase() === superAdminEmail) {
            actionsHtml = `<span class="text-gray-400 text-xs">ä¸»ç®¡ç†å“¡ä¸å¯ä¿®æ”¹</span>`;
        } else if (user.id === currentUserData.id) {
            actionsHtml = `
                        <button onclick="editUser('${safeId}')" class="text-blue-600 hover:text-blue-800">ç·¨è¼¯</button>
                        <span class="text-gray-400 text-xs ml-1">ç•¶å‰ç”¨æˆ¶</span>
                    `;
        } else {
            actionsHtml = `
                        <button onclick="editUser('${safeId}')" class="text-blue-600 hover:text-blue-800">ç·¨è¼¯</button>
                        <button onclick="toggleUserStatus('${safeId}')" class="text-orange-600 hover:text-orange-800">
                            ${user.active ? 'åœç”¨' : 'å•Ÿç”¨'}
                        </button>
                        <button onclick="deleteUser('${safeId}')" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                    `;
        }
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${safeName}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${safePosition}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${safeRegNumber}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${safeEmail}</td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                    ${statusText}
                </span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${safeLastLogin}</td>
            <td class="px-4 py-3 text-sm space-x-2">${actionsHtml}</td>
        `;
        tbody.appendChild(row);
    });
}

function showAddUserForm() {
    editingUserId = null;
    // ä½¿ç”¨é˜²å‘†è™•ç†ï¼Œé¿å…ç›®æ¨™å…ƒç´ ä¸å­˜åœ¨æ™‚æ‹‹å‡ºéŒ¯èª¤
    const titleEl = document.getElementById('userFormTitle');
    if (titleEl) {
        titleEl.textContent = 'æ–°å¢žç”¨æˆ¶';
    }
    const saveBtnTextEl = document.getElementById('userSaveButtonText');
    if (saveBtnTextEl) {
        saveBtnTextEl.textContent = 'å„²å­˜';
    }
    clearUserForm();
    const modalEl = document.getElementById('addUserModal');
    if (modalEl) {
        modalEl.classList.remove('hidden');
    }
    // æ–°å¢žç”¨æˆ¶æ™‚é¡¯ç¤ºå¯†ç¢¼æ¬„ä½
    try {
        const pwdField = document.getElementById('passwordFields');
        if (pwdField) {
            pwdField.classList.remove('hidden');
        }
        // æ–°å¢žç”¨æˆ¶æ™‚éš±è— UID æ¬„ä½
        const uidFieldEl = document.getElementById('uidField');
        if (uidFieldEl) {
            uidFieldEl.classList.add('hidden');
        }
    } catch (_e) {}
}

function hideAddUserForm() {
    document.getElementById('addUserModal').classList.add('hidden');
    clearUserForm();
    editingUserId = null;
}

function clearUserForm() {
    ['userDisplayName', 'userPosition', 'userEmail', 'userPhone', 'userRegistrationNumber', 'userUID', 'userPassword', 'userPasswordConfirm'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    document.getElementById('userActive').checked = true;
    
    // éš±è—è¨»å†Šç·¨è™Ÿæ¬„ä½
    document.getElementById('registrationNumberField').classList.add('hidden');
}

// åˆ‡æ›è¨»å†Šç·¨è™Ÿæ¬„ä½é¡¯ç¤º
function toggleRegistrationNumberField() {
    const positionSelect = document.getElementById('userPosition');
    const registrationField = document.getElementById('registrationNumberField');
    
    if (positionSelect.value === 'é†«å¸«') {
        registrationField.classList.remove('hidden');
    } else {
        registrationField.classList.add('hidden');
        // æ¸…ç©ºè¨»å†Šç·¨è™Ÿæ¬„ä½
        document.getElementById('userRegistrationNumber').value = '';
    }
}

async function editUser(id) {
    // æª¢æŸ¥æ¬Šé™ï¼šæœªå…·å‚™ç”¨æˆ¶ç®¡ç†æ¬Šé™å‰‡é˜»æ­¢æ“ä½œ
    if (!hasAccessToSection('userManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åŸ·è¡Œæ­¤æ“ä½œ', 'error');
        return;
    }
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    // ç¦æ­¢ç·¨è¼¯ä¸»ç®¡ç†å“¡å¸³è™Ÿï¼ˆä½¿ç”¨é›»å­éƒµä»¶åˆ¤æ–·ï¼‰
    const superAdminEmail = 'admin@clinic.com';
    if (user.email && user.email.toLowerCase() === superAdminEmail) {
        showToast('ä¸»ç®¡ç†å“¡å¸³è™Ÿä¸å¯ç·¨è¼¯ï¼', 'error');
        return;
    }
    
    editingUserId = id;
    // ä½¿ç”¨é˜²å‘†è™•ç†ï¼Œé¿å…ç›®æ¨™å…ƒç´ ä¸å­˜åœ¨æ™‚æ‹‹å‡ºéŒ¯èª¤
    const titleEl = document.getElementById('userFormTitle');
    if (titleEl) {
        titleEl.textContent = 'ç·¨è¼¯ç”¨æˆ¶';
    }
    const saveBtnTextEl = document.getElementById('userSaveButtonText');
    if (saveBtnTextEl) {
        saveBtnTextEl.textContent = 'æ›´æ–°';
    }
    
    // å¡«å……è¡¨å–®è³‡æ–™
    const displayNameEl = document.getElementById('userDisplayName');
    if (displayNameEl) displayNameEl.value = user.name || '';
    const positionEl = document.getElementById('userPosition');
    if (positionEl) positionEl.value = user.position || '';
    const emailEl = document.getElementById('userEmail');
    if (emailEl) emailEl.value = user.email || '';
    const phoneEl = document.getElementById('userPhone');
    if (phoneEl) phoneEl.value = user.phone || '';
    const regNumEl = document.getElementById('userRegistrationNumber');
    if (regNumEl) regNumEl.value = user.registrationNumber || '';
    const activeEl = document.getElementById('userActive');
    if (activeEl) activeEl.checked = user.active !== false;

    // å¡«å…¥ Firebase UID
    const uidEl = document.getElementById('userUID');
    if (uidEl) uidEl.value = user.uid || '';
    
    // æ ¹æ“šè·ä½é¡¯ç¤ºæˆ–éš±è—è¨»å†Šç·¨è™Ÿæ¬„ä½
    toggleRegistrationNumberField();

    // ç·¨è¼¯ç”¨æˆ¶æ™‚éš±è—å¯†ç¢¼æ¬„ä½
    try {
        const pwdField = document.getElementById('passwordFields');
        if (pwdField) {
            pwdField.classList.add('hidden');
        }
        // ç·¨è¼¯ç”¨æˆ¶æ™‚é¡¯ç¤º UID æ¬„ä½
        const uidFieldEl = document.getElementById('uidField');
        if (uidFieldEl) {
            uidFieldEl.classList.remove('hidden');
        }
    } catch (_e) {}
    
    const modalEl = document.getElementById('addUserModal');
    if (modalEl) {
        modalEl.classList.remove('hidden');
    }
}

async function saveUser() {
    // æª¢æŸ¥æ¬Šé™ï¼šæœªå…·å‚™ç”¨æˆ¶ç®¡ç†æ¬Šé™å‰‡é˜»æ­¢æ“ä½œ
    if (!hasAccessToSection('userManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åŸ·è¡Œæ­¤æ“ä½œ', 'error');
        return;
    }
    const name = document.getElementById('userDisplayName').value.trim();
    const position = document.getElementById('userPosition').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const phone = document.getElementById('userPhone').value.trim();
    const registrationNumber = document.getElementById('userRegistrationNumber').value.trim();
    const active = document.getElementById('userActive').checked;
    const uid = document.getElementById('userUID').value.trim();

    // å–å¾—å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ï¼ˆå¯èƒ½ä¸å­˜åœ¨æ–¼ç·¨è¼¯æ¨¡å¼ï¼‰
    const password = document.getElementById('userPassword') ? document.getElementById('userPassword').value : '';
    const passwordConfirm = document.getElementById('userPasswordConfirm') ? document.getElementById('userPasswordConfirm').value : '';

    // ç”¢ç”Ÿå…§éƒ¨ç”¨æˆ¶è­˜åˆ¥åç¨±ï¼ˆusernameï¼‰
    let username;
    if (uid) {
        username = uid;
    } else if (email) {
        username = email.split('@')[0];
    } else {
        username = 'user_' + Date.now();
    }
    
    // é©—è­‰å¿…å¡«æ¬„ä½ï¼ˆå§“åã€è·ä½èˆ‡é›»å­éƒµä»¶ï¼‰
    if (!email) {
        showToast('è«‹å¡«å¯«é›»å­éƒµä»¶åœ°å€ï¼', 'error');
        return;
    }

    // é©—è­‰å¿…å¡«æ¬„ä½ï¼ˆå§“åèˆ‡è·ä½ï¼‰
    if (!name || !position) {
        showToast('è«‹å¡«å¯«å¿…è¦è³‡æ–™ï¼ˆå§“åã€è·ä½ï¼‰ï¼', 'error');
        return;
    }

    // æª¢æŸ¥é›»å­éƒµä»¶æ ¼å¼
    if (email) {
        // åŸºæœ¬é›»å­éƒµä»¶æ ¼å¼é©—è­‰
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(email)) {
            showToast('é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºï¼', 'error');
            return;
        }
    }

    // æª¢æŸ¥é›»è©±æ ¼å¼ï¼šå…è¨± 7~15 ä½æ•¸å­—
    if (phone) {
        const phonePattern = /^\d{7,15}$/;
        if (!phonePattern.test(phone)) {
            showToast('é›»è©±æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥ 7-15 ä½æ•¸å­—ï¼', 'error');
            return;
        }
    }
    
    // é†«å¸«è·ä½å¿…é ˆå¡«å¯«è¨»å†Šç·¨è™Ÿ
    if (position === 'é†«å¸«' && !registrationNumber) {
        showToast('é†«å¸«è·ä½å¿…é ˆå¡«å¯«ä¸­é†«è¨»å†Šç·¨è™Ÿï¼', 'error');
        return;
    }
    
    // æª¢æŸ¥é›»å­éƒµä»¶æ˜¯å¦é‡è¤‡
    if (email) {
        const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
        const existingUserByEmail = currentUsers.find(u => u.email && u.email.toLowerCase() === email.toLowerCase() && u.id !== editingUserId);
        if (existingUserByEmail) {
            showToast('æ­¤é›»å­éƒµä»¶å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–é›»å­éƒµä»¶ï¼', 'error');
            return;
        }
    }
    
    // é©—è­‰é›»å­éƒµä»¶æ ¼å¼
    if (email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼ï¼', 'error');
            return;
        }
    }

    // å¦‚æžœæ­£åœ¨ç·¨è¼¯ï¼Œä¸”ç”¨æˆ¶ç‚ºä¸»ç®¡ç†å“¡å‰‡ç¦æ­¢ç·¨è¼¯
    if (editingUserId) {
        const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
        const editingUser = currentUsers.find(u => u.id === editingUserId);
        const superAdminEmail = 'admin@clinic.com';
        if (editingUser && editingUser.email && editingUser.email.toLowerCase() === superAdminEmail) {
            showToast('ä¸»ç®¡ç†å“¡å¸³è™Ÿä¸å¯ç·¨è¼¯ï¼', 'error');
            return;
        }
    }

    // é¡¯ç¤ºä¿å­˜ä¸­ç‹€æ…‹ï¼šåœ¨æŒ‰éˆ•ä¸­é¡¯ç¤ºæ—‹è½‰å°åœˆä¸¦ç¦ç”¨æŒ‰éˆ•
    // é€éŽ id å–å¾—æŒ‰éˆ•ï¼Œä»¥é¿å…ä½¿ç”¨ onclick é¸æ“‡å™¨æ™‚ç„¡æ³•ç²¾ç¢ºåŒ¹é…
    const saveButton = document.getElementById('userSaveButton');
    setButtonLoading(saveButton, 'ä¿å­˜ä¸­...');

    try {
        if (editingUserId) {
            // æ›´æ–°ç¾æœ‰ç”¨æˆ¶
            const userData = {
                name: name,
                position: position,
                registrationNumber: position === 'é†«å¸«' ? registrationNumber : null,
                email: email,
                phone: phone,
                uid: uid || '',
                active: active
            };

            const result = await window.firebaseDataManager.updateUser(editingUserId, userData);
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...userData, updatedAt: new Date().toISOString() };
                }

                // æ›´æ–° Firebase æ•¸æ“š
                const firebaseUserIndex = usersFromFirebase.findIndex(u => u.id === editingUserId);
                if (firebaseUserIndex !== -1) {
                    usersFromFirebase[firebaseUserIndex] = { ...usersFromFirebase[firebaseUserIndex], ...userData };
                }
                
                // å¦‚æžœæ›´æ–°çš„æ˜¯ç•¶å‰ç™»å…¥ç”¨æˆ¶ï¼ŒåŒæ­¥æ›´æ–° currentUserData
                if (editingUserId === currentUserData.id) {
                    currentUserData = { ...currentUserData, ...userData };
                    currentUser = users[userIndex].username;
                    
                    // æ›´æ–°é¡¯ç¤ºçš„ç”¨æˆ¶è³‡è¨Š
                    document.getElementById('userRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(currentUserData)}`;
                    document.getElementById('sidebarUserRole').textContent = `ç•¶å‰ç”¨æˆ¶ï¼š${getUserDisplayName(currentUserData)}`;
                }
                
                showToast('ç”¨æˆ¶è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } else {
                showToast('æ›´æ–°ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }
        } else {
            // æ–°å¢žç”¨æˆ¶
            // è‹¥è¼¸å…¥äº†é›»å­éƒµä»¶ä¸”æ²’æœ‰è¼¸å…¥ UIDï¼Œä½¿ç”¨ Firebase Authentication å»ºç«‹æ–°å¸³æˆ¶
            // æ–°å¢žç”¨æˆ¶ä¸€å¾‹é€éŽ Firebase Auth å»ºç«‹å¸³è™Ÿï¼Œå¿½ç•¥æ‰‹å‹•è¼¸å…¥çš„ UID
            let newUid = '';
            if (email) {
                // é©—è­‰å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼
                if (!password || !passwordConfirm) {
                    showToast('è«‹è¼¸å…¥ä¸¦ç¢ºèªå¯†ç¢¼ï¼', 'error');
                    clearButtonLoading(saveButton);
                    return;
                }
                if (password !== passwordConfirm) {
                    showToast('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´ï¼', 'error');
                    clearButtonLoading(saveButton);
                    return;
                }
                if (password.length < 6) {
                    showToast('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 6 ä½æ•¸ï¼', 'error');
                    clearButtonLoading(saveButton);
                    return;
                }
                try {
                    // ä½¿ç”¨ Firebase Auth å‰µå»ºæ–°å¸³è™Ÿ
                    const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                    if (userCredential && userCredential.user) {
                        newUid = userCredential.user.uid;
                        // æ›´æ–°é¡¯ç¤ºåç¨±
                        if (window.firebase.updateProfile && typeof window.firebase.updateProfile === 'function') {
                            try {
                                await window.firebase.updateProfile(userCredential.user, { displayName: name });
                            } catch (_err) {
                                console.error('æ›´æ–°æ–°ç”¨æˆ¶é¡¯ç¤ºåç¨±å¤±æ•—:', _err);
                            }
                        }
                    }
                } catch (authErr) {
                    console.error('å»ºç«‹ Firebase å¸³è™Ÿå¤±æ•—:', authErr);
                    showToast('å»ºç«‹ Firebase å¸³è™Ÿå¤±æ•—ï¼š' + (authErr && authErr.message ? authErr.message : ''), 'error');
                    clearButtonLoading(saveButton);
                    return;
                }
            }
            // æ§‹å»ºç”¨æˆ¶è³‡æ–™
            const userData = {
                username: username,
                name: name,
                position: position,
                registrationNumber: position === 'é†«å¸«' ? registrationNumber : null,
                email: email,
                phone: phone,
                uid: newUid || '',
                active: active,
                lastLogin: null
            };
            const result = await window.firebaseDataManager.addUser(userData);
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                const newUser = {
                    id: result.id,
                    ...userData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                users.push(newUser);
                usersFromFirebase.push(newUser);
                showToast('ç”¨æˆ¶å·²æˆåŠŸæ–°å¢žï¼', 'success');
            } else {
                showToast('æ–°å¢žç”¨æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                clearButtonLoading(saveButton);
                return;
            }
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å„²å­˜ä½œç‚ºå‚™ç”¨
        localStorage.setItem('users', JSON.stringify(users));
        displayUsers();
        hideAddUserForm();

    } catch (error) {
        console.error('ä¿å­˜ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
        showToast('ä¿å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹èˆ‡å…§å®¹
        clearButtonLoading(saveButton);
    }
}

async function toggleUserStatus(id) {
    // æª¢æŸ¥æ¬Šé™ï¼šæœªå…·å‚™ç”¨æˆ¶ç®¡ç†æ¬Šé™å‰‡é˜»æ­¢æ“ä½œ
    if (!hasAccessToSection('userManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åŸ·è¡Œæ­¤æ“ä½œ', 'error');
        return;
    }
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    // é˜²æ­¢åœç”¨è‡ªå·±çš„å¸³è™Ÿ
    if (user.id === currentUserData.id) {
        showToast('ä¸èƒ½åœç”¨è‡ªå·±çš„å¸³è™Ÿï¼', 'error');
        return;
    }
    // ç¦æ­¢åœç”¨ä¸»ç®¡ç†å“¡å¸³è™Ÿï¼ˆä½¿ç”¨é›»å­éƒµä»¶åˆ¤æ–·ï¼‰
    const superAdminEmail = 'admin@clinic.com';
    if (user.email && user.email.toLowerCase() === superAdminEmail) {
        showToast('ä¸»ç®¡ç†å“¡å¸³è™Ÿä¸å¯åœç”¨ï¼', 'error');
        return;
    }
    
    const action = user.active ? 'åœç”¨' : 'å•Ÿç”¨';
    // å•Ÿç”¨/åœç”¨ç”¨æˆ¶ç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
    const lang8 = localStorage.getItem('lang') || 'zh';
    const zhMsg8 = `ç¢ºå®šè¦${action}ç”¨æˆ¶ã€Œ${user.name}ã€å—Žï¼Ÿ\n\n${user.active ? 'åœç”¨å¾Œè©²ç”¨æˆ¶å°‡ç„¡æ³•ç™»å…¥ç³»çµ±ã€‚' : 'å•Ÿç”¨å¾Œè©²ç”¨æˆ¶å¯ä»¥æ­£å¸¸ç™»å…¥ç³»çµ±ã€‚'}`;
    const actionEn = user.active ? 'disable' : 'enable';
    const enMsg8 = `Are you sure you want to ${actionEn} user \"${user.name}\"?\n\n${user.active ? 'Once disabled, this user will not be able to log in.' : 'Once enabled, this user will be able to log in normally.'}`;
    const confirmMsg8 = lang8 === 'en' ? enMsg8 : zhMsg8;
    const confirmedToggle = await showConfirmation(confirmMsg8, 'warning');
    if (confirmedToggle) {
        // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
        showToast('è™•ç†ä¸­...', 'info');

        try {
            const userData = {
                active: !user.active
            };

            const result = await window.firebaseDataManager.updateUser(id, userData);
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                const userIndex = users.findIndex(u => u.id === id);
                if (userIndex !== -1) {
                    users[userIndex].active = !user.active;
                    users[userIndex].updatedAt = new Date().toISOString();
                }

                // æ›´æ–° Firebase æ•¸æ“š
                const firebaseUserIndex = usersFromFirebase.findIndex(u => u.id === id);
                if (firebaseUserIndex !== -1) {
                    usersFromFirebase[firebaseUserIndex].active = !user.active;
                }
                
                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    // Determine English action words
                    const actionZh = action; // 'åœç”¨' or 'å•Ÿç”¨'
                    const actionEn = user.active ? 'disabled' : 'enabled';
                    const zhMsg = `ç”¨æˆ¶ã€Œ${user.name}ã€å·²${actionZh}ï¼`;
                    const enMsg = `User "${user.name}" has been ${actionEn}!`;
                    const msg = lang === 'en' ? enMsg : zhMsg;
                    showToast(msg, 'success');
                }
            } else {
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    // For failure message, refer to the action in English or Chinese
                    const actionEn = user.active ? 'disable' : 'enable';
                    const zhMsg = `${action}ç”¨æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦`;
                    const enMsg = `Failed to ${actionEn} user, please try again later`;
                    const msg = lang === 'en' ? enMsg : zhMsg;
                    showToast(msg, 'error');
                }
            }
        } catch (error) {
            console.error('æ›´æ–°ç”¨æˆ¶ç‹€æ…‹éŒ¯èª¤:', error);
            showToast('æ›´æ–°ç”¨æˆ¶ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
    }
}

async function deleteUser(id) {
    // æª¢æŸ¥æ¬Šé™ï¼šæœªå…·å‚™ç”¨æˆ¶ç®¡ç†æ¬Šé™å‰‡é˜»æ­¢æ“ä½œ
    if (!hasAccessToSection('userManagement')) {
        showToast('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åŸ·è¡Œæ­¤æ“ä½œ', 'error');
        return;
    }
    const currentUsers = usersFromFirebase.length > 0 ? usersFromFirebase : users;
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    // é˜²æ­¢åˆªé™¤è‡ªå·±çš„å¸³è™Ÿ
    if (user.id === currentUserData.id) {
        showToast('ä¸èƒ½åˆªé™¤è‡ªå·±çš„å¸³è™Ÿï¼', 'error');
        return;
    }
    // ç¦æ­¢åˆªé™¤ä¸»ç®¡ç†å“¡å¸³è™Ÿï¼ˆä½¿ç”¨é›»å­éƒµä»¶åˆ¤æ–·ï¼‰
    const superAdminEmail = 'admin@clinic.com';
    if (user.email && user.email.toLowerCase() === superAdminEmail) {
        showToast('ä¸»ç®¡ç†å“¡å¸³è™Ÿä¸å¯åˆªé™¤ï¼', 'error');
        return;
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€å€‹ç®¡ç†å“¡
    const adminUsers = currentUsers.filter(u => u.position === 'è¨ºæ‰€ç®¡ç†' && u.active && u.id !== id);
    if (user.position === 'è¨ºæ‰€ç®¡ç†' && adminUsers.length === 0) {
        showToast('ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹è¨ºæ‰€ç®¡ç†å¸³è™Ÿï¼', 'error');
        return;
    }
    
    // åˆªé™¤ç”¨æˆ¶ç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
    const lang9 = localStorage.getItem('lang') || 'zh';
    const zhMsg9 = `ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${user.name}ã€å—Žï¼Ÿ\n\nè·ä½ï¼š${user.position}\né›»å­éƒµä»¶ï¼š${user.email || 'æœªè¨­å®š'}\n\næ³¨æ„ï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŽŸï¼`;
    const enMsg9 = `Are you sure you want to delete user \"${user.name}\"?\n\nPosition: ${user.position}\nEmail: ${user.email || 'Not set'}\n\nNote: this action cannot be undone!`;
    const confirmMsg9 = lang9 === 'en' ? enMsg9 : zhMsg9;
    const confirmedDelUser = await showConfirmation(confirmMsg9, 'warning');
    if (confirmedDelUser) {
        // é¡¯ç¤ºåˆªé™¤ä¸­ç‹€æ…‹
        showToast('åˆªé™¤ä¸­...', 'info');

        try {
            const result = await window.firebaseDataManager.deleteUser(id);
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                users = users.filter(u => u.id !== id);
                usersFromFirebase = usersFromFirebase.filter(u => u.id !== id);

                // åŒæ­¥ç§»é™¤å…¨åŸŸå¿«å–ï¼Œä»¥å…åˆªé™¤çš„ç”¨æˆ¶é‡æ–°å‡ºç¾
                try {
                    if (Array.isArray(userCache)) {
                        userCache = userCache.filter(u => u.id !== id);
                    }
                } catch (_e) {
                    // å¦‚æžœ userCache æœªå®šç¾©æˆ–ä¸å¯ç”¨å‰‡å¿½ç•¥
                }

                localStorage.setItem('users', JSON.stringify(users));
                displayUsers();
                {
                    const lang = localStorage.getItem('lang') || 'zh';
                    const zhMsg = `ç”¨æˆ¶ã€Œ${user.name}ã€å·²åˆªé™¤ï¼`;
                    const enMsg = `User "${user.name}" has been deleted!`;
                    const msg = lang === 'en' ? enMsg : zhMsg;
                    showToast(msg, 'success');
                }
            } else {
                showToast('åˆªé™¤ç”¨æˆ¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        } catch (error) {
            console.error('åˆªé™¤ç”¨æˆ¶éŒ¯èª¤:', error);
            showToast('åˆªé™¤ç”¨æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
    }
}

// è²¡å‹™å ±è¡¨åŠŸèƒ½
        let currentFinancialTabType = 'summary';
        
        // è¼‰å…¥è²¡å‹™å ±è¡¨é é¢
        async function loadFinancialReports() {
            // è¨­ç½®é è¨­æ—¥æœŸç¯„åœï¼ˆæœ¬æœˆï¼‰
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = formatFinancialDate(firstDayOfMonth);
            document.getElementById('endDate').value = formatFinancialDate(lastDayOfMonth);
            
            // å¾ž Firebase æ›´æ–°ç”¨æˆ¶èˆ‡è¨ºç—‡è³‡æ–™ï¼ˆå¦‚å¯ç”¨ï¼‰
            if (typeof loadUsersForFinancial === 'function') {
                await loadUsersForFinancial();
            }
            if (typeof loadConsultationsForFinancial === 'function') {
                await loadConsultationsForFinancial();
            }
            // è¼‰å…¥é†«å¸«é¸é …
            loadFinancialDoctorOptions();
            // ç”Ÿæˆåˆå§‹å ±è¡¨
            generateFinancialReport();
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
        // ä½¿ç”¨æœ¬åœ°æ™‚å€çµ„åˆå­—ä¸²ï¼Œé¿å…ä½¿ç”¨ toISOString() å°Žè‡´è·¨æ—¥èª¤å·®
        function formatFinancialDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // è¼‰å…¥é†«å¸«é¸é …
        function loadFinancialDoctorOptions() {
            const doctorSelect = document.getElementById('doctorFilter');
            const doctors = users.filter(user => 
                user.active && user.position === 'é†«å¸«'
            );
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ã€Œå…¨éƒ¨é†«å¸«ã€ï¼‰
            doctorSelect.innerHTML = '<option value="">å…¨éƒ¨é†«å¸«</option>';
            
            // æ·»åŠ é†«å¸«é¸é …
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.username;
                option.textContent = `${doctor.name}`;
                doctorSelect.appendChild(option);
            });
        }

        // å¾ž Firebase è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä»¥ä¾›è²¡å‹™å ±è¡¨ä½¿ç”¨
        async function loadUsersForFinancial() {
            // å¦‚æžœ Firebase æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™æˆ–ä¸å­˜åœ¨ï¼Œè·³éŽ
            if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
                return;
            }
            try {
                // ä½¿ç”¨ fetchUsers() ä»¥åˆ©ç”¨å¿«å–æ¸›å°‘è®€å–æ¬¡æ•¸
                const data = await fetchUsers();
                if (Array.isArray(data) && data.length > 0) {
                    users = data.map(user => {
                        const createdAt = user.createdAt
                            ? (user.createdAt.seconds
                                ? new Date(user.createdAt.seconds * 1000).toISOString()
                                : user.createdAt)
                            : new Date().toISOString();
                        const updatedAt = user.updatedAt
                            ? (user.updatedAt.seconds
                                ? new Date(user.updatedAt.seconds * 1000).toISOString()
                                : user.updatedAt)
                            : new Date().toISOString();
                        const lastLogin = user.lastLogin
                            ? (user.lastLogin.seconds
                                ? new Date(user.lastLogin.seconds * 1000).toISOString()
                                : user.lastLogin)
                            : null;
                        return { ...user, createdAt, updatedAt, lastLogin };
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
            }
        }

        // å¾ž Firebase è¼‰å…¥è¨ºç—‡è¨˜éŒ„ä»¥ä¾›è²¡å‹™å ±è¡¨ä½¿ç”¨
        async function loadConsultationsForFinancial() {
            if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
                return;
            }
            try {
                const result = await window.firebaseDataManager.getConsultations();
                if (result.success) {
                    // è½‰æ› Firebase Timestamp ç‚º ISO å­—ä¸²
                    consultations = result.data.map(item => {
                        let dateStr = null;
                        if (item.date) {
                            if (typeof item.date === 'object' && item.date.seconds) {
                                dateStr = new Date(item.date.seconds * 1000).toISOString();
                            } else {
                                dateStr = item.date;
                            }
                        } else if (item.createdAt) {
                            if (typeof item.createdAt === 'object' && item.createdAt.seconds) {
                                dateStr = new Date(item.createdAt.seconds * 1000).toISOString();
                            } else {
                                dateStr = item.createdAt;
                            }
                        }
                        return { ...item, date: dateStr };
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ Firebase è¨ºç—‡è³‡æ–™å¤±æ•—:', error);
            }
        }

        // å¿«é€Ÿæ—¥æœŸé¸æ“‡
        function setQuickDate() {
            /**
             * æ ¹æ“šç›®å‰æ—¥æœŸè¨ˆç®—æœ¬é€±æˆ–ä¸Šé€±çš„èµ·å§‹æ—¥æœŸã€‚
             * ä»¥é€±ä¸€ä½œç‚ºæ¯é€±çš„ç¬¬ä¸€å¤©ï¼Œé€±æ—¥ç‚ºæœ€å¾Œä¸€å¤©ã€‚
             * ä¾‹å¦‚ï¼Œè‹¥ä»Šå¤©æ˜¯é€±ä¸‰ï¼ˆgetDay() å›žå‚³ 3ï¼‰ï¼Œå‰‡æœ¬é€±é–‹å§‹ç‚ºé€±ä¸€ã€‚
             * è‹¥ä»Šå¤©æ˜¯é€±æ—¥ï¼ˆgetDay() å›žå‚³ 0ï¼‰ï¼Œå‰‡æœ¬é€±é–‹å§‹ä»ç‚ºæœ¬é€±é€±ä¸€ã€‚
             * @param {Date} date ç•¶å‰æ—¥æœŸ
             * @returns {Date} ç•¶é€±é€±ä¸€çš„æ—¥æœŸ
             */
            function getStartOfWeek(date) {
                const result = new Date(date);
                const day = result.getDay();
                // å°‡ Sunday (0) è¦–ç‚ºä¸€é€±çš„æœ€å¾Œä¸€å¤©ï¼Œéœ€å›žæº¯ 6 å¤©è‡³é€±ä¸€
                // å…¶é¤˜æƒ…æ³å›žæº¯ day-1 å¤©è‡³é€±ä¸€
                const diff = day === 0 ? -6 : 1 - day;
                result.setDate(result.getDate() + diff);
                return result;
            }

            const quickDate = document.getElementById('quickDate').value;
            const today = new Date();
            let startDate, endDate;
            // å˜—è©¦å–å¾—èˆŠçš„ reportType å…ƒç´ ä¾›å›žå¯«ï¼›å¦‚å…ƒç´ ä¸å­˜åœ¨å‰‡å¿½ç•¥
            const rptElem = document.getElementById('reportType');

            switch (quickDate) {
                case 'today':
                    // ä»Šæ—¥ï¼šé–‹å§‹èˆ‡çµæŸçš†ç‚ºä»Šå¤©
                    startDate = new Date(today);
                    endDate = new Date(today);
                    if (rptElem) rptElem.value = 'daily';
                    break;
                case 'yesterday':
                    // æ˜¨å¤©ï¼šé–‹å§‹èˆ‡çµæŸçš†ç‚ºæ˜¨å¤©
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 1);
                    endDate = new Date(startDate);
                    if (rptElem) rptElem.value = 'daily';
                    break;
                case 'thisWeek': {
                    // æœ¬é€±ï¼šä»¥é€±ä¸€ç‚ºèµ·é»žï¼ŒçµæŸæ—¥æœŸç‚ºä»Šå¤©
                    startDate = getStartOfWeek(today);
                    endDate = new Date(today);
                    if (rptElem) rptElem.value = 'weekly';
                    break;
                }
                case 'lastWeek': {
                    // ä¸Šé€±ï¼šå–å¾—æœ¬é€±é€±ä¸€å¾Œï¼Œå†å¾€å‰æŽ¨ä¸ƒå¤©å¾—åˆ°ä¸Šé€±é€±ä¸€ï¼›çµæŸæ—¥æœŸç‚ºä¸Šé€±é€±æ—¥
                    const startOfThisWeek = getStartOfWeek(today);
                    startDate = new Date(startOfThisWeek);
                    startDate.setDate(startOfThisWeek.getDate() - 7);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    if (rptElem) rptElem.value = 'weekly';
                    break;
                }
                case 'thisMonth':
                    // æœ¬æœˆï¼šèµ·å§‹ç‚ºæœˆåˆ (1 æ—¥)ï¼ŒçµæŸç‚ºæœˆæœ«
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    if (rptElem) rptElem.value = 'monthly';
                    break;
                case 'lastMonth':
                    // ä¸Šæœˆï¼šèµ·å§‹ç‚ºä¸Šå€‹æœˆ 1 æ—¥ï¼ŒçµæŸç‚ºä¸Šå€‹æœˆçš„æœ€å¾Œä¸€å¤©
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    if (rptElem) rptElem.value = 'monthly';
                    break;
                case 'thisYear':
                    // ä»Šå¹´ï¼šèµ·å§‹ç‚ºæœ¬å¹´åº¦ 1 æœˆ 1 æ—¥ï¼ŒçµæŸç‚ºæœ¬å¹´åº¦çš„æœ€å¾Œä¸€å¤©ï¼ˆ12 æœˆ 31 æ—¥ï¼‰ã€‚
                    // ç‚ºç¢ºä¿è·¨æ™‚å€æ—¥æœŸæ­£ç¢ºï¼Œä½¿ç”¨ new Date(ä¸‹ä¸€å¹´, 0, 0) å–å¾—æœ¬å¹´åº¦çš„æœ€å¾Œä¸€å¤©ã€‚
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear() + 1, 0, 0);
                    if (rptElem) rptElem.value = 'yearly';
                    break;
                case 'lastYear':
                    // åŽ»å¹´ï¼šèµ·å§‹ç‚ºåŽ»å¹´ 1 æœˆ 1 æ—¥ï¼ŒçµæŸç‚ºåŽ»å¹´çš„æœ€å¾Œä¸€å¤©ã€‚
                    // ä½¿ç”¨ new Date(ä»Šå¹´, 0, 0) å–å¾—åŽ»å¹´çš„ 12 æœˆ 31 æ—¥ã€‚
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear(), 0, 0);
                    if (rptElem) rptElem.value = 'yearly';
                    break;
                default:
                    return;
            }

            if (startDate && endDate) {
                // å°‡æ—¥æœŸæ ¼å¼åŒ–ç‚º YYYY-MM-DD ä¸¦æ›´æ–° UI
                document.getElementById('startDate').value = formatFinancialDate(startDate);
                document.getElementById('endDate').value = formatFinancialDate(endDate);
                // é‡æ–°ç”Ÿæˆå ±è¡¨
                generateFinancialReport();
            }
        }

        // è§£æžæ”¶è²»é …ç›®æ–‡æœ¬
        function parseFinancialBillingItems(billingText) {
            const items = [];
            const lines = billingText.split('\n');
            let totalAmount = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line || line.includes('å°è¨ˆ') || line.includes('ç¸½è²»ç”¨')) {
                    // æå–ç¸½è²»ç”¨
                    if (line.includes('ç¸½è²»ç”¨')) {
                        const match = line.match(/\$(\d+)/);
                        if (match) {
                            totalAmount = parseInt(match[1]);
                        }
                    }
                    return;
                }

                // è§£æžæ”¶è²»é …ç›®æ ¼å¼ï¼šé …ç›®å xæ•¸é‡ = $é‡‘é¡ æˆ– é …ç›®å xæ•¸é‡ = -$é‡‘é¡
                const itemMatch = line.match(/^(.+?)\s+x(\d+)\s+=\s+([\-\$]?\d+)$/);
                if (itemMatch) {
                    const itemName = itemMatch[1].trim();
                    const quantity = parseInt(itemMatch[2]);
                    const amount = parseInt(itemMatch[3].replace(/[\-\$]/g, ''));
                    const isDiscount = itemMatch[3].includes('-');

                    items.push({
                        name: itemName,
                        quantity: quantity,
                        unitPrice: Math.abs(amount / quantity),
                        totalAmount: isDiscount ? -amount : amount,
                        category: getFinancialCategoryFromItemName(itemName)
                    });
                }
            });

            return { items, totalAmount };
        }

        // æ ¹æ“šé …ç›®åç¨±æŽ¨æ–·é¡žåˆ¥
        function getFinancialCategoryFromItemName(itemName) {
            if (itemName.includes('è¨ºé‡‘') || itemName.includes('è¨ºç™‚') || itemName.includes('è¤‡è¨º')) {
                return 'consultation';
            } else if (itemName.includes('è—¥') || itemName.includes('ä¸­è—¥') || itemName.includes('èª¿åŠ‘')) {
                return 'medicine';
            } else if (itemName.includes('é‡ç¸') || itemName.includes('æŽ¨æ‹¿') || itemName.includes('æ‹”ç½') || itemName.includes('åˆ®ç—§') || itemName.includes('è‰¾ç¸')) {
                return 'treatment';
            } else if (itemName.includes('æŠ˜æ‰£') || itemName.includes('å„ªæƒ ')) {
                return 'discount';
            } else if (itemName.includes('å¥—ç¥¨') || itemName.includes('å¥—é¤') || itemName.includes('ç™‚ç¨‹') || itemName.includes('æ–¹æ¡ˆ')) {
                return 'package';
            } else {
                return 'other';
            }
        }

        // ç”Ÿæˆè²¡å‹™å ±è¡¨
        // æ”¹ç‚º async ä»¥ä¾¿åœ¨æ›´æ–°å ±è¡¨å‰é‡æ–°è¼‰å…¥æœ€æ–°çš„è¨ºç—‡è³‡æ–™ï¼Œç¢ºä¿ã€Œæ›´æ–°å ±è¡¨ã€æŒ‰éˆ•çœŸæ­£æ›´æ–°å…§å®¹ã€‚
        async function generateFinancialReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const doctorFilter = document.getElementById('doctorFilter').value;
            let reportType = '';
            const rptElem = document.getElementById('reportType');
            if (rptElem) {
                reportType = rptElem.value;
            }

            if (!startDate || !endDate) {
                showToast('è«‹é¸æ“‡æ—¥æœŸç¯„åœï¼', 'error');
                return;
            }

            // åœ¨ç”Ÿæˆå ±è¡¨å‰é‡æ–°è¼‰å…¥è¨ºç—‡è³‡æ–™ï¼Œä»¥å–å¾—æœ€æ–°æ”¶å…¥èˆ‡çµ±è¨ˆ
            if (typeof loadConsultationsForFinancial === 'function') {
                try {
                    await loadConsultationsForFinancial();
                } catch (err) {
                    console.error('é‡æ–°è¼‰å…¥è²¡å‹™è³‡æ–™å¤±æ•—:', err);
                }
            }

            // éŽæ¿¾è¨ºç—‡è³‡æ–™
            const filteredConsultations = filterFinancialConsultations(startDate, endDate, doctorFilter);
            
            // è¨ˆç®—çµ±è¨ˆè³‡æ–™
            const stats = calculateFinancialStatistics(filteredConsultations);
            
            // æ›´æ–°é—œéµæŒ‡æ¨™
            updateFinancialKeyMetrics(stats);
            
            // æ›´æ–°è¡¨æ ¼
            updateFinancialTables(filteredConsultations, stats);
            
            // æ›´æ–°æ™‚é–“
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-TW');
            
            showToast('è²¡å‹™å ±è¡¨å·²æ›´æ–°ï¼', 'success');
        }

        // éŽæ¿¾è¨ºç—‡è³‡æ–™
        function filterFinancialConsultations(startDate, endDate, doctorFilter) {
            const start = new Date(startDate);
            const end = new Date(endDate + 'T23:59:59.999Z');

            return consultations.filter(consultation => {
                const consultationDate = new Date(consultation.date);
                const dateInRange = consultationDate >= start && consultationDate <= end;
                const doctorMatch = !doctorFilter || consultation.doctor === doctorFilter;
                const isCompleted = consultation.status === 'completed';

                return dateInRange && doctorMatch && isCompleted;
            });
        }

        // è¨ˆç®—è²¡å‹™çµ±è¨ˆè³‡æ–™
        function calculateFinancialStatistics(consultations) {
            let totalRevenue = 0;
            let totalConsultations = consultations.length;
            const doctorStats = {};
            const serviceStats = {};
            const dailyStats = {};

            consultations.forEach(consultation => {
                const parsed = parseFinancialBillingItems(consultation.billingItems || '');
                const consultationRevenue = parsed.totalAmount;
                totalRevenue += consultationRevenue;

                // é†«å¸«çµ±è¨ˆ
                if (!doctorStats[consultation.doctor]) {
                    doctorStats[consultation.doctor] = {
                        count: 0,
                        revenue: 0
                    };
                }
                doctorStats[consultation.doctor].count += 1;
                doctorStats[consultation.doctor].revenue += consultationRevenue;

                // æœå‹™çµ±è¨ˆ
                parsed.items.forEach(item => {
                    if (!serviceStats[item.category]) {
                        serviceStats[item.category] = {
                            name: getFinancialCategoryDisplayName(item.category),
                            count: 0,
                            revenue: 0,
                            items: []
                        };
                    }
                    serviceStats[item.category].count += item.quantity;
                    serviceStats[item.category].revenue += item.totalAmount;
                    serviceStats[item.category].items.push(item);
                });

                // æ¯æ—¥çµ±è¨ˆ
                const dateKey = consultation.date.split('T')[0];
                if (!dailyStats[dateKey]) {
                    dailyStats[dateKey] = {
                        count: 0,
                        revenue: 0,
                        services: {}
                    };
                }
                dailyStats[dateKey].count += 1;
                dailyStats[dateKey].revenue += consultationRevenue;
            });

            const averageRevenue = totalConsultations > 0 ? totalRevenue / totalConsultations : 0;
            const activeDoctors = Object.keys(doctorStats).length;

            return {
                totalRevenue,
                totalConsultations,
                averageRevenue,
                activeDoctors,
                doctorStats,
                serviceStats,
                dailyStats
            };
        }

        // ç²å–é¡žåˆ¥é¡¯ç¤ºåç¨±
        function getFinancialCategoryDisplayName(category) {
            const names = {
                consultation: 'è¨ºç™‚è²»',
                medicine: 'è—¥è²»',
                treatment: 'æ²»ç™‚è²»',
                other: 'å…¶ä»–è²»ç”¨',
                discount: 'æŠ˜æ‰£',
                package: 'å¥—ç¥¨é …ç›®',
                packageUse: 'å¥—ç¥¨ä½¿ç”¨'
            };
            return names[category] || category;
        }

        // æ›´æ–°é—œéµæŒ‡æ¨™
        function updateFinancialKeyMetrics(stats) {
            document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue.toLocaleString()}`;
            document.getElementById('totalConsultations').textContent = stats.totalConsultations.toLocaleString();
            document.getElementById('averageRevenue').textContent = `$${Math.round(stats.averageRevenue).toLocaleString()}`;
            document.getElementById('activeDoctors').textContent = stats.activeDoctors;
        }

        // æ›´æ–°è²¡å‹™è¡¨æ ¼
        function updateFinancialTables(consultations, stats) {
            updateFinancialSummaryTable(stats);
            updateFinancialDailyTable(stats.dailyStats);
            updateFinancialDoctorTable(stats.doctorStats);
            updateFinancialServiceTable(stats.serviceStats);
        }

        // æ›´æ–°æ”¶å…¥æ‘˜è¦è¡¨æ ¼
        function updateFinancialSummaryTable(stats) {
            const tbody = document.getElementById('financialSummaryTableBody');
            const summaryData = [
                { item: 'è¨ºç™‚è²»æ”¶å…¥', amount: 0, category: 'consultation' },
                { item: 'è—¥è²»æ”¶å…¥', amount: 0, category: 'medicine' },
                { item: 'æ²»ç™‚è²»æ”¶å…¥', amount: 0, category: 'treatment' },
                { item: 'å…¶ä»–æ”¶å…¥', amount: 0, category: 'other' },
                { item: 'å¥—ç¥¨æ”¶å…¥', amount: 0, category: 'package' }
            ];

            // è¨ˆç®—å„é¡žåˆ¥æ”¶å…¥
            Object.keys(stats.serviceStats).forEach(category => {
                const stat = stats.serviceStats[category];
                const summaryItem = summaryData.find(item => item.category === category);
                if (summaryItem) {
                    summaryItem.amount = stat.revenue;
                }
            });

            const totalRevenue = stats.totalRevenue;

            tbody.innerHTML = summaryData.map(item => {
                const percentage = totalRevenue > 0 ? ((item.amount / totalRevenue) * 100).toFixed(1) : '0';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.item}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${item.amount.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-right">çµ±è¨ˆæœŸé–“</td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°æ¯æ—¥æ˜Žç´°è¡¨æ ¼
        function updateFinancialDailyTable(dailyStats) {
            const tbody = document.getElementById('financialDailyTableBody');
            const sortedDates = Object.keys(dailyStats).sort().reverse();

            if (sortedDates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            é¸å®šæœŸé–“å…§æ²’æœ‰è¨ºç—‡è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sortedDates.map(date => {
                const stat = dailyStats[date];
                const averageDaily = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('zh-TW');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${averageDaily.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">è¨ºç™‚ã€è—¥è²»</td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°é†«å¸«æ¥­ç¸¾è¡¨æ ¼
        function updateFinancialDoctorTable(doctorStats) {
            const tbody = document.getElementById('financialDoctorTableBody');
            const totalRevenue = Object.values(doctorStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(doctorStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            é¸å®šæœŸé–“å…§æ²’æœ‰é†«å¸«è¨ºç—‡è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedDoctors = Object.entries(doctorStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedDoctors.map(([doctorUsername, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;
                const doctorName = getDoctorDisplayName(doctorUsername);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${doctorName}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°æœå‹™åˆ†æžè¡¨æ ¼
        function updateFinancialServiceTable(serviceStats) {
            const tbody = document.getElementById('financialServiceTableBody');
            const totalRevenue = Object.values(serviceStats).reduce((sum, stat) => sum + stat.revenue, 0);

            if (Object.keys(serviceStats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            é¸å®šæœŸé–“å…§æ²’æœ‰æœå‹™è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedServices = Object.entries(serviceStats).sort(([,a], [,b]) => b.revenue - a.revenue);

            tbody.innerHTML = sortedServices.map(([category, stat]) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : '0';
                const average = stat.count > 0 ? Math.round(stat.revenue / stat.count) : 0;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${stat.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right">${stat.count}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">$${stat.revenue.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">$${average.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 text-right">${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        // åˆ‡æ›è²¡å‹™æ¨™ç±¤
        function switchFinancialTab(tabType) {
            // æ›´æ–°æ¨™ç±¤æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('[role="tablist"] button').forEach(btn => {
                if (btn.id && btn.id.startsWith('financial')) {
                    btn.className = 'py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm transition duration-200';
                }
            });
            
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Tab`).className = 'py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm transition duration-200';

            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.financial-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(`financial${tabType.charAt(0).toUpperCase() + tabType.slice(1)}Content`).classList.remove('hidden');
            
            currentFinancialTabType = tabType;
        }

        // åŒ¯å‡ºè²¡å‹™å ±è¡¨
function exportFinancialReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    // å˜—è©¦å–å¾—å ±è¡¨é¡žåž‹ï¼šèˆŠçš„ reportType å…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼Œæ”¹ç”¨ quickDate æ–‡å­—æˆ–å€¼
    let reportType = '';
    const rptElem = document.getElementById('reportType');
    if (rptElem) {
        reportType = rptElem.value;
    } else {
        const quickDateElem = document.getElementById('quickDate');
        if (quickDateElem) {
            // ä½¿ç”¨é¸é …çš„é¡¯ç¤ºæ–‡å­—ï¼Œè‹¥æ²’æœ‰å‰‡ä½¿ç”¨å€¼
            const selIndex = quickDateElem.selectedIndex;
            if (selIndex >= 0) {
                reportType = quickDateElem.options[selIndex].text || quickDateElem.value;
            } else {
                reportType = quickDateElem.value;
            }
        }
    }
    // å–å¾—é†«å¸«ç¯©é¸æ¢ä»¶ï¼ˆè‹¥æœ‰ï¼‰
    let doctorFilter = '';
    const doctorFilterInput = document.getElementById('doctorFilter');
    if (doctorFilterInput) {
        doctorFilter = doctorFilterInput.value;
    }
    // éŽæ¿¾è¨ºç—‡è³‡æ–™ä¸¦è¨ˆç®—çµ±è¨ˆä»¥ç”Ÿæˆæ›´è©³ç´°çš„å ±è¡¨
    const filteredConsultations = filterFinancialConsultations(startDate, endDate, doctorFilter);
    const stats = calculateFinancialStatistics(filteredConsultations);
    // æº–å‚™å„å€å¡Šæ–‡å­—
    const doctorLines = Object.keys(stats.doctorStats).map(key => {
        const data = stats.doctorStats[key];
        const doctorName = key || 'æœªçŸ¥é†«å¸«';
        return `${doctorName}: æ¬¡æ•¸ ${data.count.toLocaleString()}ï¼Œæ”¶å…¥ $${data.revenue.toLocaleString()}`;
    }).join('\n');
    const serviceLines = Object.values(stats.serviceStats).map(item => {
        return `${item.name}: æ¬¡æ•¸ ${item.count.toLocaleString()}ï¼Œæ”¶å…¥ $${item.revenue.toLocaleString()}`;
    }).join('\n');
    const dailyLines = Object.keys(stats.dailyStats).map(dateKey => {
        const data = stats.dailyStats[dateKey];
        return `${dateKey}: æ¬¡æ•¸ ${data.count.toLocaleString()}ï¼Œæ”¶å…¥ $${data.revenue.toLocaleString()}`;
    }).join('\n');
    // çµ„åˆæ–‡å­—å ±è¡¨
    let textReport = '';
    if (doctorFilter) {
        textReport += `é¸æ“‡é†«å¸«: ${doctorFilter}\n`;
    }
    textReport += `å ±è¡¨æ¨™é¡Œ: è²¡å‹™å ±è¡¨ - ${reportType}\n`;
    textReport += `æœŸé–“: ${startDate} è‡³ ${endDate}\n`;
    textReport += `ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n`;
    textReport += `ç¸½æ”¶å…¥: $${stats.totalRevenue.toLocaleString()}\n`;
    textReport += `ç¸½è¨ºç—‡æ•¸: ${stats.totalConsultations.toLocaleString()}\n`;
    textReport += `å¹³å‡æ”¶å…¥: $${Math.round(stats.averageRevenue).toLocaleString()}\n`;
    textReport += `æœ‰æ•ˆé†«å¸«æ•¸: ${stats.activeDoctors.toLocaleString()}\n\n`;
    textReport += `é†«å¸«çµ±è¨ˆ:\n${doctorLines || 'ç„¡è³‡æ–™'}\n\n`;
    textReport += `æœå‹™åˆ†é¡žçµ±è¨ˆ:\n${serviceLines || 'ç„¡è³‡æ–™'}\n\n`;
    textReport += `æ¯æ—¥çµ±è¨ˆ:\n${dailyLines || 'ç„¡è³‡æ–™'}\n`;
    // å‰µå»ºä¸‹è¼‰ç‚ºç´”æ–‡å­—æª”æ¡ˆ
    const blob = new Blob([textReport], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `è²¡å‹™å ±è¡¨_${startDate}_${endDate}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('è²¡å‹™å ±è¡¨å·²åŒ¯å‡ºï¼', 'success');
}

// ================== è³‡æ–™å‚™ä»½èˆ‡é‚„åŽŸç›¸é—œå‡½å¼ ==================
/**
 * ç­‰å¾… Firebase DataManager æº–å‚™å°±ç·’çš„è¼”åŠ©å‡½å¼ã€‚
 * æŸäº›æƒ…æ³ä¸‹ç¶²é è¼‰å…¥æ™‚ Firebase ä»åœ¨åˆå§‹åŒ–ï¼Œç›´æŽ¥è®€å–è³‡æ–™æœƒå¤±æ•—ã€‚
 */
async function ensureFirebaseReady() {
    if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
        for (let i = 0; i < 100 && (!window.firebaseDataManager || !window.firebaseDataManager.isReady); i++) {
            await new Promise(resolve => setTimeout(resolve, 50));
        }
    }
}

/**
 * åŒ¯å‡ºè¨ºæ‰€æ‰€æœ‰è³‡æ–™ï¼ˆä¸åŒ…å« Realtime Database çš„æŽ›è™Ÿè³‡æ–™ï¼‰ã€‚
 * è®€å–å„å€‹é›†åˆå¾Œçµ„æˆå–®ä¸€ JSONï¼Œæä¾›ä¸‹è¼‰ã€‚
 */
async function exportClinicBackup() {
    const button = document.getElementById('backupExportBtn');
    setButtonLoading(button);
    try {
        await ensureFirebaseReady();
        // è®€å–ç—…äººã€è¨ºç—‡è¨˜éŒ„èˆ‡ç”¨æˆ¶è³‡æ–™
        // è®€å–ç—…äººèˆ‡è¨ºç—‡è³‡æ–™ï¼Œä¸¦é€éŽ fetchUsers() å–å¾—ç”¨æˆ¶åˆ—è¡¨
        const [patientsRes, consultationsRes] = await Promise.all([
            // å¼·åˆ¶åˆ·æ–°ä»¥å–å¾—æœ€æ–°ç—…äººè³‡æ–™
            safeGetPatients(true),
            (async () => {
                // ç¢ºä¿è³‡æ–™ç®¡ç†å™¨å·²æº–å‚™å¥½
                await waitForFirebaseDataManager();
                /*
                 * è®€å–è¨ºç—‡è¨˜éŒ„æ™‚ä¹Ÿéœ€è¦å‚³å…¥ forceRefresh=trueï¼Œ
                 * ä»¥é¿å…å›žå‚³çš„æ˜¯å¿«å–ä¸­çš„èˆŠè³‡æ–™ã€‚
                 */
                return await window.firebaseDataManager.getConsultations(true);
            })()
        ]);
        const patientsData = patientsRes && patientsRes.success && Array.isArray(patientsRes.data) ? patientsRes.data : [];
        // è‹¥è¨ºç—‡è¨˜éŒ„æœ‰å¤šé ï¼Œå¿…é ˆä¾åºè¼‰å…¥æ‰€æœ‰é é¢ã€‚å…ˆå–å¾—ç¬¬ä¸€é è³‡æ–™ã€‚
        let consultationsData = consultationsRes && consultationsRes.success && Array.isArray(consultationsRes.data) ? consultationsRes.data.slice() : [];
        try {
            // è‹¥è¿”å›žå€¼æŒ‡å‡ºé‚„æœ‰æ›´å¤šé é¢ï¼Œè¿­ä»£è¼‰å…¥ç›´åˆ°æ²’æœ‰æ›´å¤šè³‡æ–™
            let hasMore = consultationsRes && consultationsRes.success && consultationsRes.hasMore;
            while (hasMore) {
                const nextRes = await window.firebaseDataManager.getConsultationsNextPage();
                if (nextRes && nextRes.success && Array.isArray(nextRes.data)) {
                    consultationsData = nextRes.data.slice();
                    hasMore = nextRes.hasMore;
                } else {
                    hasMore = false;
                }
            }
        } catch (_pageErr) {
            // è‹¥è¼‰å…¥ä¸‹ä¸€é æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä¿ç•™å·²ç²å¾—çš„è³‡æ–™ä¸¦åœæ­¢
            console.warn('è®€å–è¨ºç—‡è¨˜éŒ„å…¨éƒ¨é é¢å¤±æ•—ï¼Œåƒ…åŒ¯å‡ºéƒ¨åˆ†è³‡æ–™:', _pageErr);
        }
        // å–å¾—ç”¨æˆ¶åˆ—è¡¨ï¼›ç‚ºç¢ºä¿åŒ…å«å€‹äººè¨­ç½®ï¼ˆpersonalSettingsï¼‰ï¼Œç›´æŽ¥å¾ž Firestore è®€å–
        // ä¸ä½¿ç”¨å¿«å–ä¸­çš„ trimmed è³‡æ–™ï¼Œä»¥ä¾¿åŒ…å«æ‰€æœ‰æ¬„ä½
        let usersData = [];
        try {
            // å¾ž Firestore è®€å–æ‰€æœ‰ users æ–‡ä»¶
            const userSnap = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'users')
            );
            userSnap.forEach((docSnap) => {
                usersData.push({ id: docSnap.id, ...docSnap.data() });
            });
        } catch (_fetchErr) {
            console.warn('åŒ¯å‡ºå‚™ä»½æ™‚å–å¾—ç”¨æˆ¶åˆ—è¡¨å¤±æ•—ï¼Œå°‡ä¸åŒ…å«ç”¨æˆ¶è³‡æ–™');
        }
        // è®€å–æ”¶è²»é …ç›®æ™‚å¼·åˆ¶åˆ·æ–°ï¼Œé¿å…ä½¿ç”¨å¿«å–ä¸­çš„èˆŠè³‡æ–™ã€‚
        if (typeof initBillingItems === 'function') {
            // å¼·åˆ¶å¾ž Firestore é‡æ–°è®€å–æ”¶è²»é …ç›®ï¼Œä»¥ç¢ºä¿å‚™ä»½å…§å®¹ç‚ºæœ€æ–°
            await initBillingItems(true);
        }
        // è®€å–æ‰€æœ‰å¥—ç¥¨è³‡æ–™
        let packageData = [];
        try {
            const snapshot = await window.firebase.getDocs(window.firebase.collection(window.firebase.db, 'patientPackages'));
            snapshot.forEach((docSnap) => {
                // å°‡æ–‡ä»¶ ID ä¸€ä½µå­˜å…¥ï¼Œä»¥ä¾¿é‚„åŽŸæ™‚èƒ½ç¶­æŒåŽŸæœ‰ ID
                packageData.push({ id: docSnap.id, ...docSnap.data() });
            });
        } catch (e) {
            console.error('è®€å–å¥—ç¥¨è³‡æ–™å¤±æ•—:', e);
        }
        const billingData = Array.isArray(billingItems) ? billingItems : [];
        // è®€å– Realtime Database è³‡æ–™ï¼ŒæŽ’é™¤å³æ™‚æŽ›è™ŸåŠè¨ºç—‡è³‡æ–™
        let rtdbData = null;
        try {
            const rtdbSnap = await window.firebase.get(window.firebase.ref(window.firebase.rtdb));
            const allRtdb = (rtdbSnap && rtdbSnap.exists()) ? rtdbSnap.val() : {};
            if (allRtdb && typeof allRtdb === 'object') {
                rtdbData = {};
                for (const key of Object.keys(allRtdb)) {
                    if (!['appointments', 'consultations', 'consultation', 'onlineConsultations'].includes(key)) {
                        rtdbData[key] = allRtdb[key];
                    }
                }
            }
        } catch (e) {
            console.warn('è®€å– Realtime Database è³‡æ–™å¤±æ•—:', e);
            rtdbData = null;
        }
        // çµ„åˆå‚™ä»½è³‡æ–™ï¼šåƒ…åŒ…å«ç—…äººè³‡æ–™ã€è¨ºç—‡è¨˜éŒ„ã€ç”¨æˆ¶è³‡æ–™ã€å¥—ç¥¨è³‡æ–™èˆ‡æ”¶è²»é …ç›®ï¼Œä»¥åŠå¯é¸çš„ Realtime Database
        const backup = {
            patients: patientsData,
            consultations: consultationsData,
            users: usersData,
            billingItems: billingData,
            patientPackages: packageData
        };
        if (rtdbData) {
            backup.rtdb = rtdbData;
        }
        const json = JSON.stringify(backup, null, 2);
        const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        a.download = `clinic_backup_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('å‚™ä»½è³‡æ–™å·²åŒ¯å‡ºï¼', 'success');
    } catch (error) {
        console.error('åŒ¯å‡ºå‚™ä»½å¤±æ•—:', error);
        showToast('åŒ¯å‡ºå‚™ä»½å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    } finally {
        clearButtonLoading(button);
    }
}

/**
 * è§¸ç™¼å‚™ä»½æª”æ¡ˆåŒ¯å…¥æµç¨‹ï¼šæ¸…ç©ºæª”æ¡ˆè¼¸å…¥æ¡†ä¸¦æ‰“é–‹æª”æ¡ˆé¸æ“‡è¦–çª—ã€‚
 */
function triggerBackupImport() {
    const input = document.getElementById('backupFileInput');
    if (input) {
        input.value = '';  // é‡ç½® valueï¼Œç¢ºä¿å¯é‡æ–°é¸æª”
        input.click();
    }
}

/**
 * è™•ç†ä½¿ç”¨è€…é¸æ“‡çš„å‚™ä»½æª”æ¡ˆï¼Œè§£æžå¾Œé€²è¡ŒåŒ¯å…¥ã€‚
 * @param {File} file ä½¿ç”¨è€…é¸æ“‡çš„ JSON æª”æ¡ˆ
 */
async function handleBackupFile(file) {
    if (!file) return;
    {
        const lang = localStorage.getItem('lang') || 'zh';
        const zhMsg = 'åŒ¯å…¥å‚™ä»½å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—Žï¼Ÿ';
        const enMsg = 'Importing a backup will overwrite existing data; are you sure you want to continue?';
        const confirmed = await showConfirmation(lang === 'en' ? enMsg : zhMsg, 'warning');
        if (!confirmed) {
            return;
        }
    }
    const button = document.getElementById('backupImportBtn');
    setButtonLoading(button);
    // å‹•æ…‹è¨ˆç®—åŒ¯å…¥æ­¥é©Ÿã€‚åŸºæœ¬äº”æ­¥ï¼špatientsã€consultationsã€usersã€billingItemsã€patientPackagesã€‚
    let totalStepsForBackupImport = 5;
    let data;
    try {
        const text = await file.text();
        data = JSON.parse(text);
        if (data && typeof data.rtdb === 'object' && data.rtdb !== null) {
            totalStepsForBackupImport++;
        }
    } catch (parseErr) {
        console.error('è®€å–å‚™ä»½æª”æ¡ˆå¤±æ•—:', parseErr);
        showToast('è®€å–å‚™ä»½æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º', 'error');
        clearButtonLoading(button);
        return;
    }
    // é¡¯ç¤ºåŒ¯å…¥é€²åº¦æ¢
    showBackupProgressBar(totalStepsForBackupImport);
    try {
        // å‚³å…¥é€²åº¦å›žèª¿ä»¥æ›´æ–°åŒ¯å…¥é€²åº¦ã€‚ç¬¬ä¸‰å€‹åƒæ•¸ç‚ºç¸½æ­¥é©Ÿæ•¸
        await importClinicBackup(data, function(step, total) {
            updateBackupProgressBar(step, total);
        }, totalStepsForBackupImport);
        showToast('å‚™ä»½è³‡æ–™åŒ¯å…¥å®Œæˆï¼', 'success');
        finishBackupProgressBar(true);
    } catch (error) {
        console.error('åŒ¯å…¥å‚™ä»½å¤±æ•—:', error);
        showToast('åŒ¯å…¥å‚™ä»½å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º', 'error');
        // é€²åº¦æ¢æ¨™è¨˜ç‚ºå¤±æ•—
        finishBackupProgressBar(false);
    } finally {
        clearButtonLoading(button);
    }
}

/**
 * å°‡å‚™ä»½è³‡æ–™å¯«å›ž Firestoreï¼Œè¦†è“‹ç¾æœ‰è³‡æ–™ã€‚Realtime Database è³‡æ–™ä¸å—å½±éŸ¿ã€‚
 * @param {Object} data å‚™ä»½ç‰©ä»¶
 */
async function importClinicBackup(data) {
    let progressCallback = null;
    // åƒ…é‚„åŽŸç—…äººè³‡æ–™ã€è¨ºç—‡è¨˜éŒ„ã€ç”¨æˆ¶è³‡æ–™ã€å¥—ç¥¨è³‡æ–™èˆ‡æ”¶è²»é …ç›®ï¼Œç¸½æ­¥é©Ÿæ•¸ç‚º 5
    let totalSteps = 5;
    // è‹¥ç¬¬äºŒå€‹åƒæ•¸ç‚ºå‡½å¼ï¼Œè¦–ç‚ºé€²åº¦å›žèª¿ï¼›ç¬¬ä¸‰å€‹åƒæ•¸ç‚ºç¸½æ­¥é©Ÿæ•¸ï¼ˆå¯é¸ï¼‰
    if (arguments.length >= 2 && typeof arguments[1] === 'function') {
        progressCallback = arguments[1];
    }
    if (arguments.length >= 3 && typeof arguments[2] === 'number') {
        totalSteps = arguments[2];
    }
    await ensureFirebaseReady();
    // helperï¼šæ¸…ç©ºä¸¦è¦†å¯«é›†åˆè³‡æ–™
    /**
     * å°‡é›†åˆè³‡æ–™æ›¿æ›ç‚ºæŒ‡å®šé …ç›®ï¼Œåƒ…åˆªé™¤ä¸åœ¨ items ä¸­çš„æ–‡ä»¶ï¼Œä¸¦ä½¿ç”¨æ‰¹æ¬¡å¯«å…¥ä»¥æ¸›å°‘ç¶²è·¯å¾€è¿”ã€‚
     * @param {string} collectionName é›†åˆåç¨±
     * @param {Array} items è¦å¯«å…¥çš„æ–°è³‡æ–™é™£åˆ—ï¼Œæ¯å€‹å…ƒç´ éœ€åŒ…å« id å±¬æ€§
     */
    async function replaceCollection(collectionName, items) {
        const colRef = window.firebase.collection(window.firebase.db, collectionName);
        try {
            // å–å¾—ç¾æœ‰æ–‡ä»¶ ID
            const snap = await window.firebase.getDocs(colRef);
            const existingIds = new Set();
            snap.forEach((docSnap) => {
                existingIds.add(docSnap.id);
            });
            // å»ºç«‹æ–°è³‡æ–™ ID é›†åˆ
            const newIds = new Set();
            if (Array.isArray(items)) {
                items.forEach(item => {
                    if (item && item.id !== undefined && item.id !== null) {
                        newIds.add(String(item.id));
                    }
                });
            }
            // è¨ˆç®—éœ€è¦åˆªé™¤çš„æ–‡ä»¶ï¼ˆç¾æœ‰ä½†ä¸åœ¨æ–°çš„ ID é›†åˆä¸­ï¼‰
            const idsToDelete = [];
            existingIds.forEach(id => {
                if (!newIds.has(id)) {
                    idsToDelete.push(id);
                }
            });
            // ä½¿ç”¨æ‰¹æ¬¡å¯«å…¥åˆªé™¤èˆ‡å¯«å…¥ï¼Œå–®æ‰¹æ¬¡æœ€å¤š 500 å€‹æ“ä½œ
            let batch = window.firebase.writeBatch(window.firebase.db);
            let opCount = 0;
            const commitBatch = async () => {
                if (opCount > 0) {
                    await batch.commit();
                    batch = window.firebase.writeBatch(window.firebase.db);
                    opCount = 0;
                }
            };
            // å…ˆè™•ç†åˆªé™¤
            for (const id of idsToDelete) {
                const docRef = window.firebase.doc(window.firebase.db, collectionName, id);
                batch.delete(docRef);
                opCount++;
                if (opCount >= 500) {
                    await commitBatch();
                }
            }
            // å†è™•ç†å¯«å…¥/æ›´æ–°
            if (Array.isArray(items)) {
                for (const item of items) {
                    if (!item || item.id === undefined || item.id === null) continue;
                    const idStr = String(item.id);
                    const docRef = window.firebase.doc(window.firebase.db, collectionName, idStr);
                    // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å°‡ id å¯«å…¥æ–‡ä»¶å…§å®¹
                    let dataToWrite;
                    try {
                        const { id, ...rest } = item || {};
                        dataToWrite = { ...rest };
                    } catch (_omitErr) {
                        dataToWrite = item;
                    }
                    batch.set(docRef, dataToWrite);
                    opCount++;
                    if (opCount >= 500) {
                        await commitBatch();
                    }
                }
            }
            // æäº¤æœ€å¾Œä¸€æ‰¹
            await commitBatch();
        } catch (err) {
            console.error('æ›´æ–° ' + collectionName + ' è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        }
    }
    // è¦†è“‹å„é›†åˆä¸¦æ›´æ–°é€²åº¦
    let stepCount = 0;
    // è¦†è“‹éœ€è¦é‚„åŽŸçš„é›†åˆï¼Œé †åºç‚ºï¼špatients -> consultations -> users -> billingItems -> patientPackages
    await replaceCollection('patients', Array.isArray(data.patients) ? data.patients : []);
    stepCount++;
    if (progressCallback) progressCallback(stepCount, totalSteps);

    await replaceCollection('consultations', Array.isArray(data.consultations) ? data.consultations : []);
    stepCount++;
    if (progressCallback) progressCallback(stepCount, totalSteps);

    await replaceCollection('users', Array.isArray(data.users) ? data.users : []);
    stepCount++;
    if (progressCallback) progressCallback(stepCount, totalSteps);

    await replaceCollection('billingItems', Array.isArray(data.billingItems) ? data.billingItems : []);
    stepCount++;
    if (progressCallback) progressCallback(stepCount, totalSteps);

    await replaceCollection('patientPackages', Array.isArray(data.patientPackages) ? data.patientPackages : []);
    stepCount++;
    if (progressCallback) progressCallback(stepCount, totalSteps);
    // å¦‚æžœå‚™ä»½åŒ…å« Realtime Database è³‡æ–™ï¼Œå°‡å…¶å¯«å›ž
    const rtdbData = data && typeof data.rtdb === 'object' ? data.rtdb : null;
    if (rtdbData) {
        try {
            for (const key of Object.keys(rtdbData)) {
                await window.firebase.set(window.firebase.ref(window.firebase.rtdb, key), rtdbData[key]);
            }
            // æ›´æ–°æœ¬åœ°ä¸­è—¥åº«å­˜æˆ–å…¶ä»–å³æ™‚è³‡æ–™å¿«å–
            if (typeof initHerbInventory === 'function') {
                await initHerbInventory(true);
            } else if (rtdbData.herbInventory) {
                try {
                    herbInventory = rtdbData.herbInventory || {};
                    herbInventoryInitialized = true;
                } catch (_e) {}
            }
        } catch (err) {
            console.error('é‚„åŽŸ Realtime Database è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        }
        stepCount++;
        if (progressCallback) progressCallback(stepCount, totalSteps);
    }
    /*
     * åŒ¯å…¥å®Œæˆå¾Œæ›´æ–°æœ¬åœ°å¿«å–ä¸¦åˆ·æ–°æ‡‰ç”¨ç¨‹å¼è³‡æ–™ã€‚
     * ç‚ºäº†ç¯€çœ Firebase è®€å–é‡ï¼Œæˆ‘å€‘ç›´æŽ¥å°‡å‚™ä»½è³‡æ–™å¯«å…¥å¿«å–èˆ‡å…¨åŸŸè®Šæ•¸ï¼Œ
     * ä¸¦é å…ˆç”¢ç”Ÿåˆ†é å¿«å–èˆ‡ç¸½æ•¸ï¼Œè®“å¾ŒçºŒ API èª¿ç”¨å¯ä½¿ç”¨å¿«å–è€Œéžå†å‘ Firestore è®€å–ã€‚
     */
    try {
        // å°‡æ‚£è€…ã€è¨ºç—‡åŠç”¨æˆ¶è³‡æ–™å¯«å…¥æœ¬åœ°å¿«å–
        patientCache = Array.isArray(data.patients)
            ? data.patients.map(p => {
                // ç¢ºä¿ ID ç‚ºå­—ä¸²ï¼Œé¿å…æ•¸å­—èˆ‡å­—ä¸²æ¯”è¼ƒä¸ç›¸ç­‰è€Œå°Žè‡´æ‰¾ä¸åˆ°ç—…äºº
                const cloned = { ...(p || {}) };
                if (cloned.id !== undefined && cloned.id !== null) {
                    cloned.id = String(cloned.id);
                }
                return cloned;
            })
            : [];
        // å°‡ç—…äººè³‡æ–™ä¾ createdAt ç”±æ–°è‡³èˆŠæŽ’åºï¼Œä»¥æ¨¡æ“¬ Firestore é è¨­æŽ’åº
        if (Array.isArray(patientCache) && patientCache.length > 1) {
            patientCache.sort((a, b) => {
                let dateA = 0;
                let dateB = 0;
                if (a && a.createdAt) {
                    if (a.createdAt.seconds !== undefined) {
                        dateA = a.createdAt.seconds * 1000;
                    } else {
                        const d = new Date(a.createdAt);
                        dateA = d instanceof Date && !isNaN(d) ? d.getTime() : 0;
                    }
                }
                if (b && b.createdAt) {
                    if (b.createdAt.seconds !== undefined) {
                        dateB = b.createdAt.seconds * 1000;
                    } else {
                        const d = new Date(b.createdAt);
                        dateB = d instanceof Date && !isNaN(d) ? d.getTime() : 0;
                    }
                }
                return dateB - dateA;
            });
        }
        consultationCache = Array.isArray(data.consultations)
            ? data.consultations.map(c => {
                const clone = { ...(c || {}) };
                if (clone.id !== undefined && clone.id !== null) {
                    clone.id = String(clone.id);
                }
                if (clone.patientId !== undefined && clone.patientId !== null) {
                    clone.patientId = String(clone.patientId);
                }
                return clone;
            })
            : [];
        userCache = Array.isArray(data.users)
            ? data.users.map(u => {
                const clone = { ...(u || {}) };
                if (clone.id !== undefined && clone.id !== null) {
                    clone.id = String(clone.id);
                }
                return clone;
            })
            : [];
        // å°‡è³‡æ–™åŒæ­¥è‡³å…¨åŸŸè®Šæ•¸ï¼ˆéƒ¨åˆ†åŠŸèƒ½ç›´æŽ¥å¼•ç”¨ï¼‰
        consultations = Array.isArray(consultationCache) ? consultationCache.slice() : [];
        // åŒæ­¥ userCache åˆ°å…¨åŸŸ users è®Šæ•¸ï¼ˆåŽ»é™¤ personalSettings ä»¥æ¸›å°‘å†—é¤˜ï¼‰
        if (Array.isArray(userCache)) {
            users = userCache.map(u => {
                try {
                    const { personalSettings, ...rest } = u || {};
                    return { ...rest };
                } catch (_e) {
                    return { ...(u || {}) };
                }
            });
        } else {
            users = [];
        }
        // å°‡ç—…äººè³‡æ–™åŒæ­¥è‡³å…¨åŸŸ patients è®Šæ•¸ï¼Œä»¥ä¾¿ä¸ä¾è³´ fetchPatients() ä¹Ÿèƒ½ç›´æŽ¥å­˜å–
        patients = Array.isArray(patientCache) ? patientCache.slice() : [];
        // å„²å­˜åˆ°æœ¬åœ°å­˜å„²ä»¥ä¾¿é›¢ç·šä½¿ç”¨æˆ–åˆå§‹è¼‰å…¥
        try {
            localStorage.setItem('patients', JSON.stringify(patients));
        } catch (_lsErr) {
            // å¿½ç•¥ localStorage éŒ¯èª¤
        }
        // æ›´æ–°æ”¶è²»é …ç›®åŠå…¶è¼‰å…¥ç‹€æ…‹
        billingItems = Array.isArray(data.billingItems) ? data.billingItems : [];
        billingItemsLoaded = true;
        try {
            localStorage.setItem('billingItems', JSON.stringify(billingItems));
        } catch (_lsErr) {
            // å¿½ç•¥ localStorage éŒ¯èª¤
        }
        // æ›´æ–°ç—…äººç¸½æ•¸å¿«å–
        patientsCountCache = Array.isArray(patientCache) ? patientCache.length : 0;
        // é‡æ–°ç”¢ç”Ÿç—…äººåˆ†é å¿«å–ï¼Œä½¿ fetchPatientsPage() å¯ä»¥ç›´æŽ¥å¾žå¿«å–å–å¾—è³‡æ–™
        patientPagesCache = {};
        patientPageCursors = {};
        // å–å¾—æ¯é é¡¯ç¤ºæ•¸é‡
        const perPage = (paginationSettings && paginationSettings.patientList && paginationSettings.patientList.itemsPerPage)
            ? paginationSettings.patientList.itemsPerPage
            : 10;
        if (Array.isArray(patientCache)) {
            // å…ˆä¾ createdAt ç”±æ–°è‡³èˆŠæŽ’åºï¼Œæ¨¡æ“¬ Firestore é è¨­æŽ’åº
            const sortedPatients = patientCache.slice().sort((a, b) => {
                let dateA = 0;
                let dateB = 0;
                if (a && a.createdAt) {
                    if (a.createdAt.seconds !== undefined) {
                        dateA = a.createdAt.seconds * 1000;
                    } else {
                        const d = new Date(a.createdAt);
                        dateA = d instanceof Date && !isNaN(d) ? d.getTime() : 0;
                    }
                }
                if (b && b.createdAt) {
                    if (b.createdAt.seconds !== undefined) {
                        dateB = b.createdAt.seconds * 1000;
                    } else {
                        const d = new Date(b.createdAt);
                        dateB = d instanceof Date && !isNaN(d) ? d.getTime() : 0;
                    }
                }
                return dateB - dateA;
            });
            // ä¾æ¯é å¤§å°åˆ‡åˆ†åˆ†é å¿«å–
            for (let i = 0; i < sortedPatients.length; i += perPage) {
                const pageNum = Math.floor(i / perPage) + 1;
                patientPagesCache[pageNum] = sortedPatients.slice(i, i + perPage);
            }
            // è‹¥æœªç”¢ç”Ÿä»»ä½•é é¢å¿«å–ï¼ˆä¾‹å¦‚ç„¡è³‡æ–™ï¼‰ï¼Œç¢ºä¿è‡³å°‘æœ‰ç¬¬ä¸€é ç©ºé™£åˆ—ï¼Œé¿å… fetchPatientsPage è®€å– Firestore
            if (!patientPagesCache[1]) {
                patientPagesCache[1] = [];
            }
        }
        // é‡æ–°è¨ˆç®—ä¸­è—¥åº«ä½¿ç”¨æ¬¡æ•¸ï¼ˆè‹¥æœ‰ç›¸é—œå‡½å¼ï¼‰
        if (typeof computeGlobalUsageCounts === 'function') {
            try { await computeGlobalUsageCounts(); } catch (_e) {}
        }
    } catch (_assignErr) {
        console.error('åŒ¯å…¥å‚™ä»½å¾Œæ›´æ–°æœ¬åœ°å¿«å–å¤±æ•—:', _assignErr);
    }
    // æ›´æ–°ç•Œé¢ï¼ˆä½¿ç”¨å¿«å–è³‡æ–™ï¼‰
    try {
        if (typeof loadPatientList === 'function') {
            loadPatientList();
        }
        if (typeof loadTodayAppointments === 'function') {
            await loadTodayAppointments();
        }
        if (typeof updateStatistics === 'function') {
            updateStatistics();
        }
    } catch (_uiErr) {
        console.error('åŒ¯å…¥å‚™ä»½å¾Œé‡æ–°æ¸²æŸ“ä»‹é¢æ™‚ç™¼ç”ŸéŒ¯èª¤:', _uiErr);
    }
    // è‹¥æœ€å¾Œä»æœªé”åˆ°ç¸½æ­¥é©Ÿæ•¸ï¼Œé€²è¡Œæœ€å¾Œä¸€æ¬¡æ›´æ–°ä»¥é¡¯ç¤º 100%
    if (progressCallback && stepCount < totalSteps) {
        progressCallback(totalSteps, totalSteps);
    }
}

/**
 * è§¸ç™¼æ¨¡æ¿åº«è³‡æ–™åŒ¯å…¥ã€‚
 * é»žæ“ŠåŒ¯å…¥æ¨¡æ¿è³‡æ–™æŒ‰éˆ•æ™‚ï¼Œè§¸ç™¼éš±è—çš„æª”æ¡ˆé¸æ“‡å™¨ã€‚
 */
function triggerTemplateImport() {
  try {
    const input = document.getElementById('templateImportFile');
    if (input) {
      // Reset the input so selecting the same file again triggers change
      input.value = '';
      input.click();
    }
  } catch (e) {
    console.error('è§¸ç™¼æ¨¡æ¿åŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
  }
}

/**
 * è™•ç†é¸æ“‡çš„æ¨¡æ¿åº«åŒ¯å…¥æª”æ¡ˆã€‚
 * æª”æ¡ˆæ‡‰ç‚º JSON æ ¼å¼ï¼ŒåŒ…å« prescriptionTemplates æˆ– diagnosisTemplates é™£åˆ—ï¼Œæˆ–ç›´æŽ¥ç‚ºæ¨¡æ¿é™£åˆ—ã€‚
 * åŒ¯å…¥æœƒè¦†è“‹ç¾æœ‰çš„æ¨¡æ¿åº«è³‡æ–™ã€‚
 * @param {File} file ä½¿ç”¨è€…é¸æ“‡çš„æª”æ¡ˆ
 */
async function handleTemplateImportFile(file) {
  if (!file) return;
  try {
    // æé†’ä½¿ç”¨è€…åŒ¯å…¥å°‡æ–°å¢žè³‡æ–™ï¼Œä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™ï¼ˆæ”¯æ´ä¸­è‹±æ–‡ï¼‰
    {
      const lang = localStorage.getItem('lang') || 'zh';
      const zhMsg = 'åŒ¯å…¥æ¨¡æ¿è³‡æ–™å°‡æ–°å¢žè³‡æ–™ï¼ˆä¸æœƒåˆªé™¤ç¾æœ‰æ¨¡æ¿åº«è³‡æ–™ï¼‰ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ';
      const enMsg = 'Importing template data will add new entries (existing template library data will not be deleted). Do you want to continue?';
      const confirmedTemplate = await showConfirmation(lang === 'en' ? enMsg : zhMsg, 'warning');
      if (!confirmedTemplate) {
        return;
      }
    }
    const text = await file.text();
    const data = JSON.parse(text);
    // å°‡æª”æ¡ˆå…§å®¹æ‹†åˆ†æˆé†«å›‘æ¨¡æ¿èˆ‡è¨ºæ–·æ¨¡æ¿
    let prescriptions = [];
    let diagnoses = [];
    // å¦‚æžœæ˜¯é™£åˆ—ï¼Œæ ¹æ“šæ¬„ä½åˆ¤æ–·é¡žåž‹
    if (Array.isArray(data)) {
      data.forEach(item => {
        if (!item || typeof item !== 'object') return;
        // è‹¥æœªæŒ‡å®š idï¼Œç”¢ç”Ÿä¸€å€‹å”¯ä¸€ id
        if (item.id === undefined || item.id === null) {
          item.id = Date.now() + Math.floor(Math.random() * 10000);
        }
        // è·³éŽä¸­è—¥æˆ–æ–¹åŠ‘è³‡æ–™
        if (item.type === 'herb' || item.type === 'formula') {
          return;
        }
        // é€éŽè¨ºæ–·æ¨¡æ¿ç‰¹æœ‰æ¬„ä½åˆ¤æ–·
        if ('chiefComplaint' in item || 'currentHistory' in item || 'tcmDiagnosis' in item || 'syndromeDiagnosis' in item) {
          diagnoses.push(item);
        } else {
          prescriptions.push(item);
        }
      });
    } else if (data && typeof data === 'object') {
      // JSON ç‰©ä»¶å¯èƒ½åŒ…å« prescriptionTemplatesã€diagnosisTemplates æˆ–å…¶ä»–å‘½å
      if (Array.isArray(data.prescriptionTemplates)) {
        prescriptions = data.prescriptionTemplates.map(item => {
          if (!item || typeof item !== 'object') return null;
          // è·³éŽä¸­è—¥æˆ–æ–¹åŠ‘è³‡æ–™
          if (item.type === 'herb' || item.type === 'formula') {
            return null;
          }
          if (item.id === undefined || item.id === null) {
            item.id = Date.now() + Math.floor(Math.random() * 10000);
          }
          return item;
        }).filter(Boolean);
      }
      if (Array.isArray(data.prescriptions)) {
        // å…¼å®¹åç¨± prescriptions
        const arr = data.prescriptions.map(item => {
          if (!item || typeof item !== 'object') return null;
          // è·³éŽä¸­è—¥æˆ–æ–¹åŠ‘è³‡æ–™
          if (item.type === 'herb' || item.type === 'formula') {
            return null;
          }
          if (item.id === undefined || item.id === null) {
            item.id = Date.now() + Math.floor(Math.random() * 10000);
          }
          return item;
        }).filter(Boolean);
        prescriptions = prescriptions.concat(arr);
      }
      if (Array.isArray(data.diagnosisTemplates)) {
        diagnoses = data.diagnosisTemplates.map(item => {
          if (!item || typeof item !== 'object') return null;
          // è·³éŽä¸­è—¥æˆ–æ–¹åŠ‘è³‡æ–™
          if (item.type === 'herb' || item.type === 'formula') {
            return null;
          }
          if (item.id === undefined || item.id === null) {
            item.id = Date.now() + Math.floor(Math.random() * 10000);
          }
          return item;
        }).filter(Boolean);
      }
      if (Array.isArray(data.diagnoses)) {
        const arr = data.diagnoses.map(item => {
          if (!item || typeof item !== 'object') return null;
          // è·³éŽä¸­è—¥æˆ–æ–¹åŠ‘è³‡æ–™
          if (item.type === 'herb' || item.type === 'formula') {
            return null;
          }
          if (item.id === undefined || item.id === null) {
            item.id = Date.now() + Math.floor(Math.random() * 10000);
          }
          return item;
        }).filter(Boolean);
        diagnoses = diagnoses.concat(arr);
      }
      // è‹¥è³‡æ–™åŒ…å«å–®ä¸€ templates é™£åˆ—
       if (Array.isArray(data.templates)) {
        data.templates.forEach(item => {
          if (!item || typeof item !== 'object') return;
          // è·³éŽä¸­è—¥æˆ–æ–¹åŠ‘è³‡æ–™
          if (item.type === 'herb' || item.type === 'formula') {
            return;
          }
          if (item.id === undefined || item.id === null) {
            item.id = Date.now() + Math.floor(Math.random() * 10000);
          }
          if ('chiefComplaint' in item || 'currentHistory' in item || 'tcmDiagnosis' in item || 'syndromeDiagnosis' in item) {
            diagnoses.push(item);
          } else {
            prescriptions.push(item);
          }
        });
      }
    }
    // å¦‚æœªæ‰¾åˆ°ä»»ä½•æ¨¡æ¿è³‡æ–™ï¼Œæ ¹æ“šæ¨¡å¼æ±ºå®šæ˜¯å¦æç¤ºéŒ¯èª¤
    const hasPrescriptions = Array.isArray(prescriptions) && prescriptions.length > 0;
    const hasDiagnoses = Array.isArray(diagnoses) && diagnoses.length > 0;
    if (!hasPrescriptions && !hasDiagnoses) {
      if (!window.isCombinedImportMode) {
        showToast('æœªåµæ¸¬åˆ°æœ‰æ•ˆçš„æ¨¡æ¿è³‡æ–™', 'error');
      }
      return;
    }
    // è¨ˆç®—ç¸½æ­¥é©Ÿï¼šé†«å›‘æ¨¡æ¿èˆ‡è¨ºæ–·æ¨¡æ¿é …ç›®ç¸½æ•¸
    const totalSteps =
      (Array.isArray(prescriptions) ? prescriptions.length : 0) +
      (Array.isArray(diagnoses) ? diagnoses.length : 0);
    try {
      showImportProgressBar(totalSteps);
      let processedCount = 0;
      await importTemplateLibraryData(
        prescriptions,
        diagnoses,
        () => {
          // å¢žåŠ è™•ç†è¨ˆæ•¸ä¸¦æ›´æ–°é€²åº¦æ¢
          processedCount++;
          updateImportProgressBar(processedCount, totalSteps);
        }
      );
      finishImportProgressBar(true);
      showToast('æ¨¡æ¿è³‡æ–™åŒ¯å…¥å®Œæˆï¼', 'success');
    } catch (err) {
      finishImportProgressBar(false);
      throw err;
    }
  } catch (err) {
    console.error('è™•ç†æ¨¡æ¿åŒ¯å…¥æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    showToast('åŒ¯å…¥æ¨¡æ¿è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º', 'error');
  }
}

/**
 * å°‡æ¨¡æ¿åº«è³‡æ–™å¯«å…¥ Firestoreï¼Œè¦†è“‹ç¾æœ‰çš„é†«å›‘æ¨¡æ¿èˆ‡è¨ºæ–·æ¨¡æ¿é›†åˆã€‚
 * åŒæ­¥æ›´æ–°æœ¬åœ°è®Šæ•¸ä¸¦é‡æ–°æ¸²æŸ“ç•Œé¢ã€‚
 * @param {Array} prescriptions é†«å›‘æ¨¡æ¿é™£åˆ—
 * @param {Array} diagnoses è¨ºæ–·æ¨¡æ¿é™£åˆ—
 */
async function importTemplateLibraryData(prescriptions, diagnoses, progressCallback) {
  try {
    // Firestore ä¸å†ç”¨æ–¼æ¨¡æ¿åº«ç®¡ç†ï¼Œç§»é™¤é ç«¯å¯«å…¥åŠåˆå§‹åŒ–ç­‰å¾…ã€‚
    // å®šç¾©è³‡æ–™è™•ç† helperï¼Œåªç”¨æ–¼èª¿æ•´é€²åº¦æ¢ï¼Œä¸èˆ‡ Firestore äº’å‹•ã€‚
    async function upsertCollectionItems(collectionName, items) {
      if (!Array.isArray(items) || items.length === 0) return;
      for (const item of items) {
        if (!item || typeof item !== 'object') continue;
        // éžå¢žé€²åº¦
        if (typeof progressCallback === 'function') {
          progressCallback();
        }
      }
    }
    // å…ˆåˆå§‹åŒ–æœ¬åœ°å…¨åŸŸè®Šæ•¸ç‚ºç©ºé™£åˆ—ï¼ˆå¦‚æžœå°šæœªå­˜åœ¨ï¼‰
    if (typeof prescriptionTemplates === 'undefined') {
      prescriptionTemplates = [];
    }
    if (typeof diagnosisTemplates === 'undefined') {
      diagnosisTemplates = [];
    }
    // æ›´æ–°/æ–°å¢žé†«å›‘æ¨¡æ¿
    if (Array.isArray(prescriptions) && prescriptions.length > 0) {
      // ä¸å†å¯«å…¥è‡³ Firestoreï¼Œåƒ…æ›´æ–°æœ¬åœ°è³‡æ–™ä¸¦èª¿æ•´é€²åº¦
      await upsertCollectionItems('prescriptionTemplates', prescriptions);
      // åˆä½µåˆ°æœ¬åœ°è³‡æ–™ï¼šæ ¹æ“š id æ›¿æ›æˆ–æ–°å¢ž
      const updated = Array.isArray(prescriptionTemplates) ? [...prescriptionTemplates] : [];
      prescriptions.forEach(item => {
        if (!item || typeof item !== 'object') return;
        const idx = updated.findIndex(p => String(p.id) === String(item.id));
        if (idx >= 0) {
          updated[idx] = { ...updated[idx], ...item };
        } else {
          updated.push(item);
        }
      });
      prescriptionTemplates = updated;
    }
    // æ›´æ–°/æ–°å¢žè¨ºæ–·æ¨¡æ¿
    if (Array.isArray(diagnoses) && diagnoses.length > 0) {
      // ä¸å†å¯«å…¥è‡³ Firestoreï¼Œåƒ…æ›´æ–°æœ¬åœ°è³‡æ–™ä¸¦èª¿æ•´é€²åº¦
      await upsertCollectionItems('diagnosisTemplates', diagnoses);
      const updatedDiag = Array.isArray(diagnosisTemplates) ? [...diagnosisTemplates] : [];
      diagnoses.forEach(item => {
        if (!item || typeof item !== 'object') return;
        const idx = updatedDiag.findIndex(d => String(d.id) === String(item.id));
        if (idx >= 0) {
          updatedDiag[idx] = { ...updatedDiag[idx], ...item };
        } else {
          updatedDiag.push(item);
        }
      });
      diagnosisTemplates = updatedDiag;
    }
    // é‡æ–°æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨
    if (typeof renderPrescriptionTemplates === 'function') {
      try {
        renderPrescriptionTemplates();
      } catch (_e) {}
    }
    if (typeof renderDiagnosisTemplates === 'function') {
      try {
        renderDiagnosisTemplates();
      } catch (_e) {}
    }
    // æ›´æ–°åˆ†é¡žä¸‹æ‹‰é¸å–®
    if (typeof refreshTemplateCategoryFilters === 'function') {
      try {
        refreshTemplateCategoryFilters();
      } catch (_e) {}
    }
  } catch (error) {
    console.error('åŒ¯å…¥æ¨¡æ¿è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    throw error;
  }
}

/**
 * è§¸ç™¼ä¸­è—¥åº«è³‡æ–™åŒ¯å…¥ã€‚
 * é»žæ“ŠåŒ¯å…¥ä¸­è—¥è³‡æ–™æŒ‰éˆ•æ™‚ï¼Œè§¸ç™¼éš±è—çš„æª”æ¡ˆé¸æ“‡å™¨ã€‚
 */
function triggerHerbImport() {
  try {
    const input = document.getElementById('herbImportFile');
    if (input) {
      input.value = '';
      input.click();
    }
  } catch (e) {
    console.error('è§¸ç™¼ä¸­è—¥åº«åŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
  }
}

/**
 * è™•ç†é¸æ“‡çš„ä¸­è—¥åº«åŒ¯å…¥æª”æ¡ˆã€‚
 * æª”æ¡ˆæ‡‰ç‚º JSON æ ¼å¼ï¼ŒåŒ…å« herbLibrary é™£åˆ—ï¼Œæˆ–ç›´æŽ¥ç‚ºä¸­è—¥åº«æ¢ç›®é™£åˆ—ã€‚
 * åŒ¯å…¥æœƒè¦†è“‹ç¾æœ‰çš„ä¸­è—¥åº«è³‡æ–™ã€‚
 * @param {File} file ä½¿ç”¨è€…é¸æ“‡çš„æª”æ¡ˆ
 */
async function handleHerbImportFile(file) {
  if (!file) return;
  try {
    {
      const lang = localStorage.getItem('lang') || 'zh';
      const zhMsg = 'åŒ¯å…¥ä¸­è—¥è³‡æ–™å°‡æ–°å¢žè³‡æ–™ï¼ˆä¸æœƒåˆªé™¤ç¾æœ‰ä¸­è—¥åº«è³‡æ–™ï¼‰ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ';
      const enMsg = 'Importing herbal data will add new entries (existing herb library data will not be deleted). Do you want to continue?';
      const confirmedHerb = await showConfirmation(lang === 'en' ? enMsg : zhMsg, 'warning');
      if (!confirmedHerb) {
        return;
      }
    }
    const text = await file.text();
    const data = JSON.parse(text);
    let items = [];
    if (Array.isArray(data)) {
      items = data;
    } else if (data && typeof data === 'object') {
      if (Array.isArray(data.herbLibrary)) {
        items = data.herbLibrary;
      } else if (Array.isArray(data.herbs)) {
        items = data.herbs;
      } else if (Array.isArray(data.items)) {
        items = data.items;
      }
    }
    // éŽæ¿¾åƒ…ä¿ç•™ä¸­è—¥æˆ–æ–¹åŠ‘è³‡æ–™
    if (Array.isArray(items)) {
      items = items.filter(item => {
        return item && typeof item === 'object' && (item.type === 'herb' || item.type === 'formula');
      });
    }
    if (!Array.isArray(items) || items.length === 0) {
      if (!window.isCombinedImportMode) {
        showToast('æœªåµæ¸¬åˆ°æœ‰æ•ˆçš„ä¸­è—¥åº«è³‡æ–™', 'error');
      }
      return;
    }
    // çµ¦æœªè¨­ç½® id çš„é …ç›®ç”¢ç”Ÿ id
    items = items.map(item => {
      if (!item || typeof item !== 'object') return item;
      if (item.id === undefined || item.id === null) {
        item.id = Date.now() + Math.floor(Math.random() * 10000);
      }
      return item;
    });
    // è¨ˆç®—ç¸½æ­¥é©Ÿ
    const totalSteps = Array.isArray(items) ? items.length : 0;
    try {
      showImportProgressBar(totalSteps);
      let processedCount = 0;
      await importHerbLibraryData(items, () => {
        processedCount++;
        updateImportProgressBar(processedCount, totalSteps);
      });
      finishImportProgressBar(true);
      showToast('ä¸­è—¥è³‡æ–™åŒ¯å…¥å®Œæˆï¼', 'success');
    } catch (err2) {
      finishImportProgressBar(false);
      throw err2;
    }
  } catch (err) {
    console.error('è™•ç†ä¸­è—¥åŒ¯å…¥æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    showToast('åŒ¯å…¥ä¸­è—¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º', 'error');
  }
}

/**
 * å°‡ä¸­è—¥åº«è³‡æ–™å¯«å…¥ Firestoreï¼Œè¦†è“‹ç¾æœ‰çš„ herbLibrary é›†åˆã€‚
 * åŒæ­¥æ›´æ–°æœ¬åœ°è®Šæ•¸ä¸¦é‡æ–°æ¸²æŸ“ä¸­è—¥åº«åˆ—è¡¨ã€‚
 * @param {Array} items ä¸­è—¥åº«è³‡æ–™é™£åˆ—
 */
async function importHerbLibraryData(items, progressCallback) {
  try {
    // ä¸å†ä½¿ç”¨ Firestoreï¼Œç§»é™¤é ç«¯åˆå§‹åŒ–ç­‰å¾…ã€‚
    if (!Array.isArray(items) || items.length === 0) {
      return;
    }
    // ç¢ºä¿æœ¬åœ°è®Šæ•¸å­˜åœ¨
    if (typeof herbLibrary === 'undefined') {
      herbLibrary = [];
    }
    // é€ä¸€æ–°å¢ž/æ›´æ–°è—¥æè³‡æ–™
    for (const item of items) {
      if (!item || typeof item !== 'object') continue;
      const idStr = String(item.id);
      // ä¸å†å¯«å…¥è‡³ Firestoreï¼Œåªæ›´æ–°æœ¬åœ°è³‡æ–™ä¸¦èª¿æ•´é€²åº¦
      if (typeof progressCallback === 'function') {
        progressCallback();
      }
      // æ›´æ–°æœ¬åœ°é™£åˆ—ï¼šè‹¥å·²å­˜åœ¨å‰‡è¦†è“‹ï¼Œå¦å‰‡åŠ å…¥
      const idx = herbLibrary.findIndex(h => String(h.id) === idStr);
      if (idx >= 0) {
        herbLibrary[idx] = { ...herbLibrary[idx], ...item };
      } else {
        herbLibrary.push(item);
      }
    }
    // é‡æ–°è¼‰å…¥ä¸¦é¡¯ç¤ºè³‡æ–™
    if (typeof initHerbLibrary === 'function') {
      try {
        await initHerbLibrary();
      } catch (_e) {}
    }
    if (typeof displayHerbLibrary === 'function') {
      try {
        displayHerbLibrary();
      } catch (_e) {}
    }
  } catch (error) {
    console.error('åŒ¯å…¥ä¸­è—¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    throw error;
  }
}

/**
 * æ¸…é™¤æ‰€æœ‰æ¨¡æ¿è³‡æ–™ï¼ˆé†«å›‘èˆ‡è¨ºæ–·æ¨¡æ¿ï¼‰ã€‚
 * é¡¯ç¤ºé€²åº¦æ¢ä¸¦é€ä¸€åˆªé™¤è³‡æ–™ã€‚
 */

/**
 * æ¸…é™¤æ‰€æœ‰ä¸­è—¥è³‡æ–™ã€‚
 * é¡¯ç¤ºé€²åº¦æ¢ä¸¦é€ä¸€åˆªé™¤è³‡æ–™ã€‚
 */

/**
 * è§¸ç™¼åŒ¯å…¥æ¨¡æ¿èˆ‡ä¸­è—¥è³‡æ–™çš„æª”æ¡ˆé¸æ“‡å™¨ã€‚
 * æ¸…ç©ºæª”æ¡ˆè¼¸å…¥æ¡†ä¸¦æ‰“é–‹æª”æ¡ˆé¸æ“‡å°è©±æ¡†ã€‚
 */

/**
 * è™•ç†é¸æ“‡çš„æ¨¡æ¿åŠä¸­è—¥è³‡æ–™æª”æ¡ˆã€‚
 * æœƒå…ˆé¡¯ç¤ºç¢ºèªæç¤ºï¼Œå†ä¾æ¬¡åŸ·è¡Œæ¨¡æ¿åŒ¯å…¥èˆ‡ä¸­è—¥åŒ¯å…¥ã€‚
 * åœ¨åˆä½µåŒ¯å…¥æ¨¡å¼ä¸‹ï¼Œå°‡æœƒæŠ‘åˆ¶å–®é …åŒ¯å…¥æ™‚çš„ç¢ºèªæç¤ºèˆ‡ç„¡æ•ˆè³‡æ–™éŒ¯èª¤æç¤ºã€‚
 * @param {File} file ä½¿ç”¨è€…é¸æ“‡çš„æª”æ¡ˆ
 */

/**
 * å°‡æ¨¡æ¿èˆ‡ä¸­è—¥åº«è³‡æ–™åŒ¯å‡ºç‚º JSON æª”æ¡ˆã€‚
 * æœƒå¾ž Firestore è®€å–é†«å›‘æ¨¡æ¿ã€è¨ºæ–·æ¨¡æ¿åŠä¸­è—¥åº«è³‡æ–™ï¼Œçµ„åˆæˆå–®ä¸€æª”æ¡ˆä¸‹è¼‰ã€‚
 */

        
// å¥—ç¥¨ç®¡ç†å‡½å¼
// å–å¾—æŒ‡å®šæ‚£è€…çš„å¥—ç¥¨æ¸…å–®ï¼Œä¸¦ä½¿ç”¨æœ¬åœ°å¿«å–é¿å…é‡è¤‡è®€å–ã€‚
// æ–°å¢ž forceRefresh åƒæ•¸å…è¨±å‘¼å«ç«¯å¼·åˆ¶é‡æ–°è®€å–è³‡æ–™ã€‚
async function getPatientPackages(patientId, forceRefresh = false) {
    // ç­‰å¾…æ•¸æ“šç®¡ç†å™¨æº–å‚™å°±ç·’ï¼Œé¿å…åˆå§‹åŒ–éŽç¨‹ä¸­è¿”å›žç©ºé™£åˆ—
    if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
        // æœ€å¤šç­‰å¾…5ç§’ï¼ˆ100 * 50msï¼‰ï¼Œé˜²æ­¢ç„¡é™ç­‰å¾…
        for (let i = 0; i < 100 && (!window.firebaseDataManager || !window.firebaseDataManager.isReady); i++) {
            await new Promise(resolve => setTimeout(resolve, 50));
        }
    }
    // å¦‚æžœä»æœªå°±ç·’ï¼Œå›žå‚³ç©ºé™£åˆ—ä¸¦è­¦å‘Š
    if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
        console.warn('FirebaseDataManager å°šæœªå°±ç·’ï¼Œç„¡æ³•å–å¾—æ‚£è€…å¥—ç¥¨');
        return [];
    }
    // å¦‚æžœæœ‰æœ¬åœ°ç·©å­˜ä¸”ä¸éœ€è¦å¼·åˆ¶åˆ·æ–°ï¼Œå„ªå…ˆå¾ž localStorage è®€å–
    if (!forceRefresh) {
        try {
            const localKey = `patientPackages_${patientId}`;
            const stored = localStorage.getItem(localKey);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed)) {
                    // æ›´æ–°å…§å­˜å¿«å–ä¸¦ç›´æŽ¥å›žå‚³
                    patientPackagesCache[patientId] = parsed;
                    return parsed;
                }
            }
        } catch (e) {
            console.warn('å¾žæœ¬åœ°è®€å–æ‚£è€…å¥—ç¥¨å¿«å–å¤±æ•—:', e);
        }
    }
    // å¦‚æžœæœ‰å…§éƒ¨å¿«å–ä¸”ä¸éœ€è¦å¼·åˆ¶åˆ·æ–°ï¼Œç›´æŽ¥å›žå‚³å…§éƒ¨å¿«å–å…§å®¹
    if (!forceRefresh && patientPackagesCache && Array.isArray(patientPackagesCache[patientId])) {
        return patientPackagesCache[patientId];
    }
    try {
        const result = await window.firebaseDataManager.getPatientPackages(patientId);
        const packages = result.success ? result.data : [];
        // å°‡çµæžœå­˜å…¥å¿«å–ä¾›ä¸‹æ¬¡ä½¿ç”¨
        if (packages) {
            patientPackagesCache[patientId] = packages;
            try {
                const localKey = `patientPackages_${patientId}`;
                localStorage.setItem(localKey, JSON.stringify(packages));
            } catch (e) {
                console.warn('å„²å­˜æ‚£è€…å¥—ç¥¨è‡³æœ¬åœ°å¤±æ•—:', e);
            }
        }
        return packages;
    } catch (error) {
        console.error('ç²å–æ‚£è€…å¥—ç¥¨éŒ¯èª¤:', error);
        return [];
    }
}

async function purchasePackage(patientId, item) {
    const totalUses = Number(item.packageUses || item.totalUses || 0);
    const validityDays = Number(item.validityDays || 0);
    const purchasedAt = new Date();
    const expiresAt = new Date(purchasedAt);
    expiresAt.setDate(expiresAt.getDate() + validityDays);
    
    const record = {
        patientId: patientId,
        packageItemId: item.id,
        name: item.name,
        totalUses: totalUses,
        remainingUses: totalUses,
        purchasedAt: purchasedAt.toISOString(),
        expiresAt: expiresAt.toISOString()
    };
    
    try {
        const result = await window.firebaseDataManager.addPatientPackage(record);
        if (result.success) {
            // å»ºç«‹æ–°å¥—ç¥¨è¨˜éŒ„ä¸¦æ›´æ–°æœ¬åœ°å¿«å–
            const newPkg = { ...record, id: result.id };
            if (Array.isArray(patientPackagesCache[patientId])) {
                // è‹¥å¿«å–å­˜åœ¨ï¼Œé™„åŠ æ–°å¥—ç¥¨
                patientPackagesCache[patientId] = [...patientPackagesCache[patientId], newPkg];
            } else {
                // å»ºç«‹æ–°çš„å¿«å–é™£åˆ—
                patientPackagesCache[patientId] = [newPkg];
            }
            // åŒæ­¥åˆ° localStorage
            try {
                const localKey = `patientPackages_${patientId}`;
                const cached = patientPackagesCache[patientId];
                localStorage.setItem(localKey, JSON.stringify(cached));
            } catch (e) {
                console.warn('å„²å­˜æ‚£è€…å¥—ç¥¨è‡³æœ¬åœ°å¤±æ•—:', e);
            }
            return newPkg;
        }
        return null;
    } catch (error) {
        console.error('è³¼è²·å¥—ç¥¨éŒ¯èª¤:', error);
        return null;
    }
}

async function consumePackage(patientId, packageRecordId) {
    try {
        // å§‹çµ‚å¾žè³‡æ–™åº«é‡æ–°å–å¾—å¥—ç¥¨ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
        const packages = await getPatientPackages(patientId, true);
        // æ¯”å° ID æ™‚çµ±ä¸€è½‰ç‚ºå­—ä¸²ï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´æ‰¾ä¸åˆ°å¥—ç¥¨
        const pkg = packages.find(p => String(p.id) === String(packageRecordId));
        
        if (!pkg) return { ok: false, msg: 'æ‰¾ä¸åˆ°å¥—ç¥¨' };
        
        const now = new Date();
        const exp = new Date(pkg.expiresAt);
        if (now > exp) return { ok: false, msg: 'å¥—ç¥¨å·²éŽæœŸ' };
        if (pkg.remainingUses <= 0) return { ok: false, msg: 'å¥—ç¥¨å·²ç”¨å®Œ' };
        
        const updatedPackage = {
            ...pkg,
            remainingUses: pkg.remainingUses - 1
        };
        
        const result = await window.firebaseDataManager.updatePatientPackage(packageRecordId, updatedPackage);

        if (result.success) {
            // æ›´æ–°æœ¬åœ°å¿«å–ä¸­çš„å°æ‡‰å¥—ç¥¨å‰©é¤˜æ¬¡æ•¸
            if (Array.isArray(patientPackagesCache[patientId])) {
                patientPackagesCache[patientId] = patientPackagesCache[patientId].map(p => {
                    if (String(p.id) === String(packageRecordId)) {
                        return { ...p, remainingUses: (p.remainingUses || 0) - 1 };
                    }
                    return p;
                });
                // æ›´æ–° localStorage ä¸­çš„å¥—ç¥¨è³‡æ–™
                try {
                    const localKey = `patientPackages_${patientId}`;
                    localStorage.setItem(localKey, JSON.stringify(patientPackagesCache[patientId]));
                } catch (e) {
                    console.warn('æ›´æ–°æœ¬åœ°æ‚£è€…å¥—ç¥¨è³‡æ–™å¤±æ•—:', e);
                }
            }
            return { ok: true, record: updatedPackage };
        } else {
            return { ok: false, msg: 'æ›´æ–°å¥—ç¥¨å¤±æ•—' };
        }
    } catch (error) {
        console.error('ä½¿ç”¨å¥—ç¥¨éŒ¯èª¤:', error);
        return { ok: false, msg: 'ç³»çµ±éŒ¯èª¤' };
    }
}

/**
 * åœ¨æœ¬åœ°æ¶ˆè€—å¥—ç¥¨ä½¿ç”¨æ¬¡æ•¸ï¼Œä¸ç«‹å³åŒæ­¥åˆ°è³‡æ–™åº«ã€‚
 * å°‡æ ¹æ“šæš«å­˜è®Šæ›´è¨ˆç®—å¯ç”¨çš„å‰©é¤˜æ¬¡æ•¸ï¼Œä¸¦æ–¼ä¿å­˜ç—…æ­·æ™‚ä¸€æ¬¡æ€§æäº¤ã€‚
 *
 * @param {string} patientId æ‚£è€… ID
 * @param {string} packageRecordId å¥—ç¥¨è¨˜éŒ„ ID
 * @returns {Promise<{ok: boolean, msg?: string, record?: any}>}
 */
async function consumePackageLocally(patientId, packageRecordId) {
    try {
        // å§‹çµ‚é‡æ–°è¼‰å…¥å¥—ç¥¨ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
        const packages = await getPatientPackages(patientId, true);
        // æ¯”å° ID æ™‚çµ±ä¸€è½‰ç‚ºå­—ä¸²ï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´æ‰¾ä¸åˆ°å¥—ç¥¨
        const pkg = packages.find(p => String(p.id) === String(packageRecordId));
        if (!pkg) {
            return { ok: false, msg: 'æ‰¾ä¸åˆ°å¥—ç¥¨' };
        }
        const now = new Date();
        const exp = new Date(pkg.expiresAt);
        if (now > exp) {
            return { ok: false, msg: 'å¥—ç¥¨å·²éŽæœŸ' };
        }
        // æ ¹æ“šæš«å­˜è®Šæ›´è¨ˆç®—å¯ç”¨çš„å‰©é¤˜æ¬¡æ•¸
        const delta = pendingPackageChanges
            .filter(change => {
                if (!change || typeof change.delta !== 'number') return false;
                return String(change.patientId) === String(patientId) && String(change.packageRecordId) === String(packageRecordId);
            })
            .reduce((sum, change) => sum + change.delta, 0);
        const availableUses = (pkg.remainingUses || 0) + delta;
        if (availableUses <= 0) {
            return { ok: false, msg: 'å¥—ç¥¨å·²ç”¨å®Œ' };
        }
        // å›žå‚³å‰©é¤˜æ¬¡æ•¸å·²æ¸› 1 çš„æ¨¡æ“¬è¨˜éŒ„ï¼Œç”¨æ–¼æ›´æ–° UI
        const updatedPackage = { ...pkg, remainingUses: availableUses - 1 };
        return { ok: true, record: updatedPackage };
    } catch (error) {
        console.error('æœ¬åœ°ä½¿ç”¨å¥—ç¥¨éŒ¯èª¤:', error);
        return { ok: false, msg: 'ç³»çµ±éŒ¯èª¤' };
    }
}

function formatPackageStatus(pkg) {
    const exp = new Date(pkg.expiresAt);
    const now = new Date();
    const daysLeft = Math.ceil((exp - now) / (1000 * 60 * 60 * 24));
    const expired = daysLeft < 0;
    // æ ¹æ“šç•¶å‰èªžè¨€è¼¸å‡ºä¸åŒçš„æ–‡å­—ã€‚en è¡¨ç¤ºè‹±æ–‡ï¼Œå…¶é¤˜ä»¥ä¸­æ–‡ç‚ºé è¨­ã€‚
    const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
    if (lang && lang.toLowerCase().startsWith('en')) {
        // Build English string
        return expired
            ? `Expired (${exp.toLocaleDateString('en-US')})`
            : `Remaining ${pkg.remainingUses}/${pkg.totalUses} uses Â· ${exp.toLocaleDateString('en-US')} expires (about ${daysLeft} days)`;
    }
    // Default: Chinese
    return expired
        ? `å·²åˆ°æœŸï¼ˆ${exp.toLocaleDateString('zh-TW')}ï¼‰`
        : `å‰©é¤˜ ${pkg.remainingUses}/${pkg.totalUses} æ¬¡ Â· ${exp.toLocaleDateString('zh-TW')} åˆ°æœŸï¼ˆç´„ ${daysLeft} å¤©ï¼‰`;
}

async function renderPatientPackages(patientId) {
    const container = document.getElementById('patientPackagesList');
    if (!container) return;
    
    try {
        // å§‹çµ‚é‡æ–°è¼‰å…¥å¥—ç¥¨è³‡æ–™ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
        const pkgs = await getPatientPackages(patientId, true);
        // æ‡‰ç”¨æš«å­˜è®Šæ›´ï¼Œèª¿æ•´æ¯å€‹å¥—ç¥¨çš„å‰©é¤˜æ¬¡æ•¸
        const modifiedPkgs = pkgs.map(pkg => {
            const delta = pendingPackageChanges
                .filter(change => {
                    if (!change || typeof change.delta !== 'number') return false;
                    return String(change.patientId) === String(patientId) && String(change.packageRecordId) === String(pkg.id);
                })
                .reduce((sum, change) => sum + change.delta, 0);
            let newRemaining = (pkg.remainingUses || 0) + delta;
            // ç´„æŸ remainingUses ä¸å°æ–¼ 0ï¼Œä¹Ÿä¸è¶…éŽ totalUsesï¼ˆè‹¥ totalUses å®šç¾©ï¼‰
            if (typeof pkg.totalUses === 'number') {
                newRemaining = Math.max(0, Math.min(pkg.totalUses, newRemaining));
            } else {
                newRemaining = Math.max(0, newRemaining);
            }
            return { ...pkg, remainingUses: newRemaining };
        });
        const activePkgs = modifiedPkgs.filter(p => p.remainingUses > 0).sort((a,b) => new Date(a.expiresAt) - new Date(b.expiresAt));
        if (activePkgs.length === 0) {
            container.innerHTML = '<div class="text-gray-500">ç„¡å·²è³¼è²·çš„å¥—ç¥¨</div>';
            return;
        }
        container.innerHTML = activePkgs.map(pkg => {
            const exp = new Date(pkg.expiresAt);
            const now = new Date();
            const expired = now > exp;
            const disabled = expired || pkg.remainingUses <= 0;
            const badge =
              expired ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-red-500">å·²åˆ°æœŸ</span>' :
              (pkg.remainingUses <= 0 ? '<span class="ml-2 text-xs text-white px-2 py-0.5 rounded bg-gray-500">å·²ç”¨å®Œ</span>' : '');
            return `
      <div class="flex items-center justify-between bg-white border border-purple-200 rounded p-2">
        <div>
          <div class="font-medium text-purple-900">${pkg.name}${badge}</div>
          <div class="text-xs text-gray-600">${formatPackageStatus(pkg)}</div>
        </div>
        <button type="button" ${disabled ? 'disabled' : ''} 
          onclick="useOnePackage('${pkg.patientId}', '${pkg.id}')"
          class="px-3 py-1 rounded ${disabled ? 'bg-gray-300 text-gray-600' : 'bg-purple-600 text-white hover:bg-purple-700'}">
          ä½¿ç”¨ä¸€æ¬¡
        </button>
      </div>
    `;
        }).join('');
    } catch (error) {
        console.error('æ¸²æŸ“æ‚£è€…å¥—ç¥¨éŒ¯èª¤:', error);
        container.innerHTML = '<div class="text-red-500">è¼‰å…¥å¥—ç¥¨è³‡æ–™å¤±æ•—</div>';
    }
}

/**
 * ä»¥åˆ†é æ–¹å¼æ¸²æŸ“ç—…äººè©³ç´°è³‡æ–™ä¸­çš„å¥—ç¥¨æƒ…æ³ã€‚
 *
 * æ­¤å‡½å¼åœ¨æŸ¥çœ‹ç—…äººè©³ç´°è³‡æ–™æ™‚ä½¿ç”¨ï¼Œæ”¯æ´åˆ†é ç€è¦½æ‚£è€…è³¼è²·çš„æ‰€æœ‰å¥—ç¥¨ã€‚
 * é¦–æ¬¡å‘¼å«ï¼ˆéžåˆ†é è·³è½‰ï¼‰æ™‚æœƒé‡ç½®é ç¢¼è‡³ç¬¬ä¸€é ã€‚
 * åˆ†é æŽ§åˆ¶å°‡ä½¿ç”¨å…¨åŸŸ paginationSettings.patientPackageStatus è¨­å®šã€‚
 *
 * @param {string} patientId ç—…äºº ID
 * @param {boolean} pageChange æ˜¯å¦ç”±åˆ†é æŽ§åˆ¶è§¸ç™¼
 */
async function renderPackageStatusSection(patientId, pageChange = false) {
    const contentEl = document.getElementById('packageStatusContent');
    if (!contentEl) return;
    try {
        // è‹¥éžåˆ†é è·³è½‰ï¼Œå‰‡é‡ç½®é ç¢¼ç‚ºç¬¬ä¸€é 
        if (!pageChange) {
            paginationSettings.patientPackageStatus.currentPage = 1;
        }
        // è®€å–æ‰€æœ‰å¥—ç¥¨ï¼ˆå¼·åˆ¶åˆ·æ–°ä»¥é¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´ï¼‰
        const pkgs = await getPatientPackages(patientId, true);
        // è‹¥ç„¡å¥—ç¥¨è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºæ–‡å­—ä¸¦éš±è—åˆ†é æŽ§åˆ¶
        if (!Array.isArray(pkgs) || pkgs.length === 0) {
            contentEl.innerHTML = `
                <div class="bg-blue-50 border-blue-200 border rounded-lg p-3 text-center">
                    <div class="text-blue-400 mb-1">
                        <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="text-sm font-medium text-blue-700">å°šæœªè³¼è²·å¥—ç¥¨</div>
                    <div class="text-xs text-blue-600 mt-1">å¯æ–¼è¨ºç™‚æ™‚è³¼è²·å¥—ç¥¨äº«å„ªæƒ </div>
                </div>
            `;
            // ç§»é™¤åˆ†é å®¹å™¨
            const paginEl = ensurePaginationContainer('packageStatusContent', 'patientPackageStatusPagination');
            if (paginEl) {
                paginEl.innerHTML = '';
                paginEl.classList.add('hidden');
            }
            return;
        }
        // å°‡å¥—ç¥¨ä¾æœ‰æ•ˆèˆ‡å¤±æ•ˆåˆ†é¡ž
        const now = new Date();
        const soonThreshold = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        const validPkgs = [];
        const invalidPkgs = [];
        pkgs.forEach(pkg => {
            const expDate = new Date(pkg.expiresAt);
            const expired = expDate < now || (typeof pkg.remainingUses === 'number' && pkg.remainingUses <= 0);
            if (expired) {
                invalidPkgs.push(pkg);
            } else {
                validPkgs.push(pkg);
            }
        });
        // æŒ‰åˆ°æœŸæ—¥æŽ’åº
        validPkgs.sort((a, b) => new Date(a.expiresAt) - new Date(b.expiresAt));
        invalidPkgs.sort((a, b) => new Date(a.expiresAt) - new Date(b.expiresAt));
        // çµ„åˆç‚ºå–®ä¸€é™£åˆ—ï¼Œæ¨™ç¤ºæ˜¯å¦æœ‰æ•ˆ
        const combined = [
            ...validPkgs.map(pkg => ({ pkg, valid: true })),
            ...invalidPkgs.map(pkg => ({ pkg, valid: false }))
        ];
        const totalItems = combined.length;
        const itemsPerPage = paginationSettings.patientPackageStatus.itemsPerPage;
        // è¨ˆç®—ç•¶å‰é ç¢¼
        let currentPage = paginationSettings.patientPackageStatus.currentPage || 1;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        paginationSettings.patientPackageStatus.currentPage = currentPage;
        const startIdx = (currentPage - 1) * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;
        const pageItems = combined.slice(startIdx, endIdx);
        // ä¾æœ‰æ•ˆæ€§å°‡æœ¬é é …ç›®åˆ†é¡ž
        const pageValid = pageItems.filter(item => item.valid).map(item => item.pkg);
        const pageInvalid = pageItems.filter(item => !item.valid).map(item => item.pkg);
        // ç”¢ç”Ÿ HTML
        // é‡æ–°æŽ’åˆ—å¥—ç¥¨ï¼šå°‡å¤±æ•ˆå¥—ç¥¨æŽ¥çºŒåœ¨æœ‰æ•ˆå¥—ç¥¨ä¹‹å¾Œï¼Œé¿å…å³å´ç©ºç™½
        let htmlParts = [];
        // ä½¿ç”¨ä¸€å€‹åž‚ç›´å®¹å™¨ï¼Œä¾åºæ¸²æŸ“æœ‰æ•ˆèˆ‡å¤±æ•ˆå¥—ç¥¨
        htmlParts.push('<div class="space-y-4">');
        // æœ‰æ•ˆå¥—ç¥¨åˆ—è¡¨
        if (pageValid.length > 0) {
            htmlParts.push('<div class="font-medium text-gray-700 mb-2">æœ‰æ•ˆå¥—ç¥¨</div>');
            htmlParts.push('<div class="space-y-2">');
            pageValid.forEach(pkg => {
                const safePkgName = window.escapeHtml(pkg.name || '');
                const statusText = formatPackageStatus(pkg);
                const safeStatusText = window.escapeHtml(statusText || '');
                const remainingUses = typeof pkg.remainingUses === 'number' ? pkg.remainingUses : '';
                const totalUses = typeof pkg.totalUses === 'number' ? pkg.totalUses : '';
                const expDate = new Date(pkg.expiresAt);
                const lowUses = typeof pkg.remainingUses === 'number' && pkg.remainingUses <= 2;
                // åˆ¤æ–·æ˜¯å¦å³å°‡åˆ°æœŸæˆ–å‰©é¤˜æ¬¡æ•¸å°‘æ–¼ç­‰æ–¼ 2
                const highlight = (expDate <= soonThreshold) || lowUses;
                const containerClasses = highlight ? 'bg-red-50 border border-red-200' : 'bg-purple-50 border border-purple-200';
                const nameClass = highlight ? 'text-red-700' : 'text-purple-900';
                const statusClass = highlight ? 'text-red-600' : 'text-gray-600';
                const usesClass = highlight ? 'text-red-700' : 'text-gray-800';
                htmlParts.push(`
                    <div class="flex items-center justify-between ${containerClasses} rounded p-2">
                        <div>
                            <div class="font-medium ${nameClass}">${safePkgName}</div>
                            <div class="text-xs ${statusClass}">${safeStatusText}</div>
                        </div>
                        <div class="text-sm ${usesClass}">${remainingUses}${totalUses !== '' ? '/' + totalUses : ''}</div>
                    </div>
                `);
            });
            htmlParts.push('</div>');
        }
        // å¤±æ•ˆå¥—ç¥¨åˆ—è¡¨
        if (pageInvalid.length > 0) {
            htmlParts.push('<div class="font-medium text-gray-700 mb-2' + (pageValid.length > 0 ? ' mt-4' : '') + '">å¤±æ•ˆå¥—ç¥¨</div>');
            htmlParts.push('<div class="space-y-2">');
            pageInvalid.forEach(pkg => {
                const safePkgName = window.escapeHtml(pkg.name || '');
                const statusText = formatPackageStatus(pkg);
                const safeStatusText = window.escapeHtml(statusText || '');
                const remainingUses = typeof pkg.remainingUses === 'number' ? pkg.remainingUses : '';
                const totalUses = typeof pkg.totalUses === 'number' ? pkg.totalUses : '';
                htmlParts.push(`
                    <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded p-2">
                        <div>
                            <div class="font-medium text-gray-500">${safePkgName}</div>
                            <div class="text-xs text-gray-400">${safeStatusText}</div>
                        </div>
                        <div class="text-sm text-gray-500">${remainingUses}${totalUses !== '' ? '/' + totalUses : ''}</div>
                    </div>
                `);
            });
            htmlParts.push('</div>');
        }
        htmlParts.push('</div>');
        contentEl.innerHTML = htmlParts.join('');
        // æ¸²æŸ“åˆ†é æŽ§åˆ¶
        const paginEl = ensurePaginationContainer('packageStatusContent', 'patientPackageStatusPagination');
        renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
            paginationSettings.patientPackageStatus.currentPage = newPage;
            renderPackageStatusSection(patientId, true);
        }, paginEl);
    } catch (error) {
        console.error('è¼‰å…¥ç—…äººå¥—ç¥¨è³‡æ–™å¤±æ•—:', error);
        contentEl.innerHTML = '<div class="text-sm text-red-600">è¼‰å…¥å¥—ç¥¨è³‡æ–™å¤±æ•—</div>';
        // ç§»é™¤åˆ†é å®¹å™¨
        const paginEl = ensurePaginationContainer('packageStatusContent', 'patientPackageStatusPagination');
        if (paginEl) {
            paginEl.innerHTML = '';
            paginEl.classList.add('hidden');
        }
    }
}

async function refreshPatientPackagesUI() {
    // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´åŒ¹é…å¤±æ•—
    const appointment = appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId));
    if (!appointment) return;
    await renderPatientPackages(appointment.patientId);
}

async function useOnePackage(patientId, packageRecordId) {
    // åœ¨æŒ‰éˆ•ä¸Šé¡¯ç¤ºè®€å–ç‹€æ…‹ï¼šå˜—è©¦å¾žäº‹ä»¶å°è±¡å–å¾—ç•¶å‰æŒ‰éˆ•ï¼Œè‹¥ç„¡å‰‡å¾ž DOM æŸ¥æ‰¾
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            // é€éŽ onclick å±¬æ€§åŒ¹é…å°æ‡‰æŒ‰éˆ•ï¼ˆä½¿ç”¨æ¨¡æ¿å­—ä¸²é¿å…å¼•è™Ÿå•é¡Œï¼‰
            const selector = `button[onclick="useOnePackage('${patientId}', '${packageRecordId}')"]`;
            loadingButton = document.querySelector(selector);
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // åƒ…åœ¨æœ¬åœ°æ¶ˆè€—å¥—ç¥¨æ¬¡æ•¸ï¼Œä¸ç«‹å³åŒæ­¥åˆ°è³‡æ–™åº«
        const res = await consumePackageLocally(patientId, packageRecordId);
        if (!res.ok) {
            showToast(res.msg || 'å¥—ç¥¨ä¸å¯ç”¨', 'warning');
            return;
        }
        const usedName = `${res.record.name} (ä½¿ç”¨å¥—ç¥¨)`;
        selectedBillingItems.push({
            id: `use-${res.record.id}-${Date.now()}`,
            name: usedName,
            category: 'packageUse',
            price: 0,
            unit: 'æ¬¡',
            description: 'å¥—ç¥¨æŠµæ‰£ä¸€æ¬¡',
            quantity: 1,
            // å¥—ç¥¨ä½¿ç”¨ä¸åƒèˆ‡æŠ˜æ‰£
            includedInDiscount: false,
            // ä»¥å­—ä¸²ä¿å­˜ patientId åŠ packageRecordIdï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´åŒ¹é…éŒ¯èª¤
            patientId: patientId !== undefined && patientId !== null ? String(patientId) : '',
            packageRecordId: res.record && res.record.id ? String(res.record.id) : ''
        });
        // è¨˜éŒ„æœ¬æ¬¡å¥—ç¥¨æ¶ˆè€—ï¼Œä»¥ä¾¿å–æ¶ˆè¨ºç—‡æ™‚å›žå¾©ã€‚æ­¤è™• delta è¨­ç‚º -1 è¡¨ç¤ºæ¸›å°‘ä¸€æ¬¡ã€‚
        try {
            // ä½¿ç”¨ res.record.id ä¾†è¨˜éŒ„å¥—ç¥¨è®Šæ›´ï¼Œé¿å…å› å¤–éƒ¨å‚³å…¥çš„ packageRecordId èˆ‡å¯¦éš›å¥—ç¥¨ ID ä¸ä¸€è‡´
            // å°Žè‡´ä¹‹å¾Œé€€å›žå¥—ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤æˆ–å¥—ç¥¨éŒ¯äº‚çš„æƒ…æ³ã€‚
            pendingPackageChanges.push({
                patientId: patientId !== undefined && patientId !== null ? String(patientId) : '',
                packageRecordId: res.record && res.record.id ? String(res.record.id) : String(packageRecordId),
                delta: -1
            });
        } catch (_e) {}
        updateBillingDisplay();
        await refreshPatientPackagesUI();
        {
            const lang = localStorage.getItem('lang') || 'zh';
            const zhMsg = `å·²ä½¿ç”¨å¥—ç¥¨ï¼š${res.record.name}ï¼Œå‰©é¤˜ ${res.record.remainingUses} æ¬¡`;
            const enMsg = `Used package: ${res.record.name}, remaining ${res.record.remainingUses} uses`;
            const msg = lang === 'en' ? enMsg : zhMsg;
            showToast(msg, 'success');
        }
    } catch (error) {
        console.error('ä½¿ç”¨å¥—ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        {
            const lang = localStorage.getItem('lang') || 'zh';
            const zhMsg = 'ä½¿ç”¨å¥—ç¥¨æ™‚ç™¼ç”ŸéŒ¯èª¤';
            const enMsg = 'An error occurred while using the package';
            const msg = lang === 'en' ? enMsg : zhMsg;
            showToast(msg, 'error');
        }
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

async function undoPackageUse(patientId, packageRecordId, usageItemId) {
    // å…ˆå–å¾—è§¸ç™¼æŒ‰éˆ•ï¼šå„ªå…ˆä½¿ç”¨äº‹ä»¶ç›®æ¨™ï¼Œå…¶æ¬¡é€éŽ DOM æŸ¥æ‰¾
    let loadingButton = null;
    try {
        if (typeof event !== 'undefined' && event && event.currentTarget) {
            loadingButton = event.currentTarget;
        }
    } catch (_e) {}
    if (!loadingButton) {
        try {
            // ä½¿ç”¨éƒ¨åˆ†åŒ¹é…ï¼Œä»¥ usageItemId ç‚ºé—œéµå­—æŸ¥æ‰¾å°æ‡‰çš„å–æ¶ˆæŒ‰éˆ•
            loadingButton = document.querySelector(`button[onclick*="undoPackageUse("][onclick*="'${usageItemId}'"]`);
        } catch (_e) {
            loadingButton = null;
        }
    }
    if (loadingButton) {
        setButtonLoading(loadingButton, 'è™•ç†ä¸­...');
    }
    try {
        // ç­‰å¾… Firebase æ•¸æ“šç®¡ç†å™¨æº–å‚™å¥½ï¼Œé¿å…åœ¨åˆå§‹åŒ–éŽç¨‹ä¸­ç„¡æ³•æ›´æ–°å¥—ç¥¨
        if (!window.firebaseDataManager || !window.firebaseDataManager.isReady) {
            for (let i = 0; i < 100 && (!window.firebaseDataManager || !window.firebaseDataManager.isReady); i++) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
        // å…ˆå–å¾—å°æ‡‰çš„é …ç›®
        const item = selectedBillingItems.find(it => it.id === usageItemId);
        if (!item) {
            // æ‰¾ä¸åˆ°é …ç›®ï¼Œå¯èƒ½å·²è¢«åˆªé™¤
            showToast('æ‰¾ä¸åˆ°å¥—ç¥¨ä½¿ç”¨é …ç›®', 'warning');
            return;
        }
        // æŽ¨æ–·ç—…äºº IDï¼šå„ªå…ˆä½¿ç”¨é …ç›®ä¸­çš„ patientIdï¼Œå…¶æ¬¡ä½¿ç”¨å‚³å…¥çš„åƒæ•¸ï¼Œå†é€€è€Œå¾žç•¶å‰æŽ›è™ŸæŽ¨æ–·
        let resolvedPatientId = item.patientId || patientId;
        if (!resolvedPatientId) {
            try {
                if (typeof currentConsultingAppointmentId !== 'undefined' && Array.isArray(appointments)) {
                    // ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´åŒ¹é…å¤±æ•—
                    const currAppt = appointments.find(appt => appt && String(appt.id) === String(currentConsultingAppointmentId));
                    if (currAppt) {
                        resolvedPatientId = currAppt.patientId;
                    }
                }
            } catch (e) {
                // å¿½ç•¥éŒ¯èª¤ï¼Œä¿æŒ resolvedPatientId ç‚º undefined
            }
        }
        // å˜—è©¦æ¢å¾©ç¼ºå¤±çš„å¥—ç¥¨ metaï¼Œä»¥ä¾¿èˆŠç—…æ­·ä¹Ÿèƒ½å–æ¶ˆä½¿ç”¨
        try {
            // restorePackageUseMeta æœƒæ ¹æ“š resolvedPatientId å˜—è©¦ç‚ºæ‰€æœ‰ç¼ºå¤±çš„å¥—ç¥¨ä½¿ç”¨é …ç›®è£œå…¨ patientId å’Œ packageRecordId
            if (typeof restorePackageUseMeta === 'function' && resolvedPatientId) {
                await restorePackageUseMeta(resolvedPatientId);
            }
        } catch (e) {
            console.error('æ¢å¾©å¥—ç¥¨ä½¿ç”¨ meta éŒ¯èª¤:', e);
        }
        // è‹¥ patientId æˆ– packageRecordId ç¼ºå¤±ï¼Œå˜—è©¦ä½¿ç”¨å‚³å…¥çš„åƒæ•¸å¡«å……
        if (!item.patientId && resolvedPatientId) {
            item.patientId = resolvedPatientId;
        }
        if (!item.packageRecordId && packageRecordId) {
            item.packageRecordId = packageRecordId;
        }
        // å¦‚æžœæˆåŠŸè£œé½Š metaï¼Œå–æ¶ˆæ­·å²æ¨™è¨˜
        if (item.isHistorical && item.patientId && item.packageRecordId) {
            item.isHistorical = false;
        }
        // å¦‚æžœä»ç„¶ç¼ºå°‘ metaï¼Œå˜—è©¦æ ¹æ“šåç¨±åŒ¹é…æ‚£è€…çš„å¥—ç¥¨ä»¥æ¢å¾© packageRecordId
        // å…ˆä½¿ç”¨å‚³å…¥çš„ patientId åƒæ•¸å¡«è£œ item.patientIdï¼ˆè‹¥ç¼ºå¤±ï¼‰
        if (!item.patientId && resolvedPatientId) {
            item.patientId = resolvedPatientId;
        }
        // è‹¥ç¼ºå°‘ packageRecordIdï¼Œå˜—è©¦é€éŽåç¨±åŒ¹é…
        if (!item.packageRecordId && item.patientId) {
            try {
                // ä½¿ç”¨å¼·åˆ¶åˆ·æ–°å–å¾—æœ€æ–°å¥—ç¥¨è³‡æ–™ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
                const pkgsForUndo = await getPatientPackages(item.patientId, true);
                // å¾žå“é …åç¨±ä¸­ç§»é™¤ã€Œ(ä½¿ç”¨å¥—ç¥¨)ã€æˆ–ã€Œï¼ˆä½¿ç”¨å¥—ç¥¨ï¼‰ã€ï¼Œä¸¦è™•ç†å¯èƒ½å‡ºç¾çš„å…¨å½¢æˆ–åŠå½¢æ‹¬è™Ÿèˆ‡é¡å¤–ç©ºæ ¼
                let baseName = item.name || '';
                baseName = baseName
                    // ç§»é™¤æ‹¬è™ŸåŒ…è£¹çš„ä½¿ç”¨å¥—ç¥¨å­—ä¸²ï¼Œä¾‹å¦‚ã€ŒæŽ¨æ‹¿ç™‚ç¨‹ (ä½¿ç”¨å¥—ç¥¨)ã€æˆ–ã€ŒæŽ¨æ‹¿ç™‚ç¨‹ï¼ˆä½¿ç”¨å¥—ç¥¨ï¼‰ã€
                    .replace(/\s*[\(ï¼ˆ]\s*ä½¿ç”¨å¥—ç¥¨\s*[\)ï¼‰]\s*/g, '')
                    // ç§»é™¤æœªè¢«æ‹¬è™ŸåŒ…è£¹çš„ã€Œä½¿ç”¨å¥—ç¥¨ã€å­—ä¸²
                    .replace(/\s*ä½¿ç”¨å¥—ç¥¨\s*/g, '')
                    .trim();
                // ä¾åç¨±å®Œå…¨åŒ¹é…ç•¶å‰ç—…äººçš„å¥—ç¥¨
                const candidatesForUndo = pkgsForUndo.filter(p => p.name === baseName);
                if (candidatesForUndo.length === 1) {
                    item.packageRecordId = candidatesForUndo[0].id;
                    item.isHistorical = false;
                } else if (candidatesForUndo.length > 1) {
                    // å¦‚æžœæœ‰å¤šå¼µåŒåå¥—ç¥¨ï¼Œé¸æ“‡ä½¿ç”¨æ¬¡æ•¸è¼ƒå¤šçš„é‚£ä¸€å¼µï¼›è‹¥ä½¿ç”¨æ¬¡æ•¸ç›¸åŒï¼Œå‰‡é¸æ“‡è³¼è²·æ™‚é–“è¼ƒæ—©çš„
                    candidatesForUndo.sort((a, b) => {
                        const usedA = (a.totalUses || 0) - (a.remainingUses || 0);
                        const usedB = (b.totalUses || 0) - (b.remainingUses || 0);
                        if (usedA !== usedB) {
                            // ä½¿ç”¨æ¬¡æ•¸å¤šçš„æŽ’å‰é¢
                            return usedB - usedA;
                        }
                        // ä½¿ç”¨æ¬¡æ•¸ç›¸åŒï¼ŒæŒ‰è³¼è²·æ—¥æœŸæ—©çš„æŽ’å‰é¢
                        const pa = a.purchasedAt ? new Date(a.purchasedAt).getTime() : 0;
                        const pb = b.purchasedAt ? new Date(b.purchasedAt).getTime() : 0;
                        if (pa !== pb) {
                            return pa - pb;
                        }
                        // è‹¥è³¼è²·æ—¥æœŸä¹Ÿç›¸åŒï¼Œä½¿ç”¨ ID çš„å­—å…¸åºé€²è¡Œæœ€å¾ŒæŽ’åºï¼Œç¢ºä¿ deterministic
                        if (a.id && b.id) {
                            return String(a.id).localeCompare(String(b.id));
                        }
                        return 0;
                    });
                    const chosenPkg = candidatesForUndo[0];
                    item.packageRecordId = chosenPkg.id;
                    item.isHistorical = false;
                }
            } catch (e) {
                console.error('å¥—ç¥¨åç¨±åŒ¹é…éŒ¯èª¤:', e);
            }
        }
        // å¦‚æžœå˜—è©¦è£œå…¨å¾Œä»ç¼ºå°‘ metaï¼Œå‰‡ç§»é™¤é …ç›®ä½†ä¸å˜—è©¦é€€å›žæ¬¡æ•¸
        if (!item.patientId || !item.packageRecordId) {
            selectedBillingItems = selectedBillingItems.filter(it => it.id !== usageItemId);
            updateBillingDisplay();
            showToast('å·²ç§»é™¤å¥—ç¥¨ä½¿ç”¨é …ç›®ï¼Œæœªé€€å›žæ¬¡æ•¸', 'info');
            return;
        }
        // ä»¥é …ç›®ä¸­çš„ packageRecordId ç‚ºæº–
        const pkgId = item.packageRecordId;
        try {
            // å–å¾—ç—…äººçš„å¥—ç¥¨ï¼Œå¦‚æžœæ²’æœ‰å–å¾—å‰‡é‡è©¦ä¸€æ¬¡
            // å¼·åˆ¶é‡æ–°å–å¾—ç—…äººçš„å¥—ç¥¨ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
            const packages = await getPatientPackages(item.patientId, true);
            // æ¯”è¼ƒå¥—ç¥¨ ID æ™‚çµ±ä¸€è½‰ç‚ºå­—ä¸²ï¼Œä»¥é¿å…é¡žåž‹ä¸ä¸€è‡´å°Žè‡´åŒ¹é…å¤±æ•—
            const pkg = packages.find(p => String(p.id) === String(pkgId));
            if (!pkg) {
                // æ‰¾ä¸åˆ°å°æ‡‰çš„å¥—ç¥¨ï¼Œç›´æŽ¥ç§»é™¤é …ç›®
                selectedBillingItems = selectedBillingItems.filter(it => it.id !== usageItemId);
                updateBillingDisplay();
                showToast('æ‰¾ä¸åˆ°å°æ‡‰çš„å¥—ç¥¨ï¼Œå·²ç§»é™¤é …ç›®', 'warning');
                return;
            }
            /*
             * ä¸ç«‹å³æ›´æ–°è³‡æ–™åº«ï¼Œåƒ…åœ¨æœ¬åœ°å›žå¾©å¥—ç¥¨ä½¿ç”¨ã€‚
             * å°‡å‰©é¤˜æ¬¡æ•¸å¢žåŠ  1 ä¸¦æ›´æ–°æš«å­˜è®Šæ›´ï¼Œä¿å­˜ç—…æ­·æ™‚å†åŒæ­¥åˆ°è³‡æ–™åº«ã€‚
             */
            {
                // å¦‚æžœå¥—ç¥¨ä½¿ç”¨é …ç›®çš„æ•¸é‡å¤§æ–¼ 1ï¼Œä»£è¡¨ç•¶æ¬¡è¨ºç—‡å·²æŠµæ‰£å¤šæ¬¡ã€‚
                // æ­¤æ™‚å–æ¶ˆä½¿ç”¨åªæ‡‰æ¸›å°‘æ•¸é‡ä¸¦é€€å›žä¸€æ¬¡ï¼Œä¸¦ä¿ç•™é …ç›®ï¼›
                // è‹¥æ•¸é‡ç‚º 1ï¼Œå‰‡å¾žåˆ—è¡¨ä¸­ç§»é™¤è©²é …ç›®ã€‚
                const currentItem = selectedBillingItems.find(it => it.id === usageItemId);
                if (currentItem && typeof currentItem.quantity === 'number' && currentItem.quantity > 1) {
                    currentItem.quantity -= 1;
                } else {
                    selectedBillingItems = selectedBillingItems.filter(it => it.id !== usageItemId);
                }
                // åœ¨ UI æ›´æ–°å‰å…ˆè¨˜éŒ„æœ¬æ¬¡å¥—ç¥¨é€€å›žï¼Œä»¥ä¾¿ renderPatientPackages èƒ½æ­£ç¢ºåæ˜ æ–°çš„å‰©é¤˜æ¬¡æ•¸
                try {
                    const undoPatientIdRaw = (item && item.patientId) ? item.patientId : resolvedPatientId;
                    // åœ¨æš«å­˜è®Šæ›´ä¸­çµ±ä¸€ä½¿ç”¨å­—ä¸²è¡¨ç¤º ID
                    const undoPatientIdStr = (undoPatientIdRaw !== undefined && undoPatientIdRaw !== null) ? String(undoPatientIdRaw) : '';
                    const pkgIdStr = (pkgId !== undefined && pkgId !== null) ? String(pkgId) : '';
                    pendingPackageChanges.push({
                        patientId: undoPatientIdStr,
                        packageRecordId: pkgIdStr,
                        delta: +1
                    });
                } catch (_e) {}
                // æ›´æ–°æ”¶è²»é …ç›®èˆ‡å¥—ç¥¨åˆ—è¡¨é¡¯ç¤º
                updateBillingDisplay();
                await refreshPatientPackagesUI();
                showToast('å·²å–æ¶ˆæœ¬æ¬¡å¥—ç¥¨ä½¿ç”¨ï¼Œæ¬¡æ•¸å·²é€€å›ž', 'success');
            }
        } catch (error) {
            console.error('å–æ¶ˆå¥—ç¥¨ä½¿ç”¨éŒ¯èª¤:', error);
            showToast('å–æ¶ˆå¥—ç¥¨ä½¿ç”¨æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        }
    } finally {
        if (loadingButton) {
            clearButtonLoading(loadingButton);
        }
    }
}

// å˜—è©¦ç‚ºç¼ºå¤± meta çš„å¥—ç¥¨ä½¿ç”¨é …ç›®è£œå…¨ patientId èˆ‡ packageRecordId
// ç•¶èˆŠç—…æ­·ç„¡æ³•å–æ¶ˆå¥—ç¥¨æ™‚ï¼Œæœƒå˜—è©¦é€éŽç—…äººç•¶å‰çš„å¥—ç¥¨è¨˜éŒ„æŽ¨æ–·å°æ‡‰çš„å¥—ç¥¨ID
async function restorePackageUseMeta(patientId) {
    try {
        // å–å¾—ç—…äººçš„æ‰€æœ‰å¥—ç¥¨
        // å¼·åˆ¶é‡æ–°è¼‰å…¥å¥—ç¥¨ï¼Œé¿å…è·¨è£ç½®å¿«å–ä¸ä¸€è‡´
        const packages = await getPatientPackages(patientId, true);
        // éæ­·å·²é¸æ“‡çš„æ”¶è²»é …ç›®ï¼Œå°‹æ‰¾ç¼ºä¹ meta çš„å¥—ç¥¨ä½¿ç”¨é …ç›®
        selectedBillingItems.forEach(item => {
            // åˆ¤æ–·æ˜¯å¦ç‚ºå¥—ç¥¨æŠµæ‰£é …ç›®ï¼šå“é …é¡žåˆ¥ç‚º packageUse æˆ–åç¨±å«æœ‰ã€Œä½¿ç”¨å¥—ç¥¨ã€
            const isPackageUse = item && (item.category === 'packageUse' || (item.name && item.name.includes('ä½¿ç”¨å¥—ç¥¨')));
                if (isPackageUse && (item.isHistorical || !item.patientId || !item.packageRecordId)) {
                // å³ä¾¿æ¨™è¨˜ç‚ºæ­·å²è¨˜éŒ„ï¼Œä¹Ÿå˜—è©¦æ¢å¾© meta ä»¥ä¾¿å¯ä»¥å–æ¶ˆä½¿ç”¨
                
                // è£œå……ç—…äººIDï¼Œçµ±ä¸€è½‰ç‚ºå­—ä¸²
                item.patientId = (patientId !== undefined && patientId !== null) ? String(patientId) : '';
                // å¾žåç¨±ä¸­ç§»é™¤å¾Œç¶´ä»¥æ‰¾å‡ºå¥—ç¥¨åç¨±ï¼Œä¾‹å¦‚ã€ŒæŽ¨æ‹¿ç™‚ç¨‹ (ä½¿ç”¨å¥—ç¥¨)ã€æˆ–ã€ŒæŽ¨æ‹¿ç™‚ç¨‹ï¼ˆä½¿ç”¨å¥—ç¥¨ï¼‰ã€â†’ã€ŒæŽ¨æ‹¿ç™‚ç¨‹ã€
                // ä½¿ç”¨æ­£å‰‡è™•ç†å…¨å½¢ã€åŠå½¢æ‹¬è™ŸåŠå¯èƒ½çš„ç©ºæ ¼ï¼Œä¸¦ç§»é™¤æœªè¢«æ‹¬è™ŸåŒ…è£¹çš„ã€Œä½¿ç”¨å¥—ç¥¨ã€å­—æ¨£
                let baseName = item.name || '';
                baseName = baseName
                    .replace(/\s*[\(ï¼ˆ]\s*ä½¿ç”¨å¥—ç¥¨\s*[\)ï¼‰]\s*/g, '')
                    .replace(/\s*ä½¿ç”¨å¥—ç¥¨\s*/g, '')
                    .trim();
                // åœ¨ç—…äººçš„å¥—ç¥¨ä¸­å°‹æ‰¾åç¨±å®Œå…¨åŒ¹é…çš„é …ç›®
                const candidates = packages.filter(p => p.name === baseName);
                if (candidates.length === 1) {
                    // å°‡åŒ¹é…åˆ°çš„å¥—ç¥¨ ID è½‰ç‚ºå­—ä¸²
                    item.packageRecordId = (candidates[0] && candidates[0].id) ? String(candidates[0].id) : '';
                    // æ‰¾åˆ°å°æ‡‰çš„å¥—ç¥¨ï¼Œå–æ¶ˆæ­·å²æ¨™è¨˜
                    item.isHistorical = false;
                } else if (candidates.length > 1) {
                    // å¦‚æžœæœ‰å¤šå€‹åŒåå¥—ç¥¨ï¼Œé¸æ“‡ä½¿ç”¨æ¬¡æ•¸è¼ƒå¤šçš„é‚£ä¸€å€‹ï¼›è‹¥ä½¿ç”¨æ¬¡æ•¸ç›¸åŒï¼Œå‰‡é¸æ“‡è³¼è²·æ™‚é–“è¼ƒæ—©çš„
                    candidates.sort((a, b) => {
                        const usedA = (a.totalUses || 0) - (a.remainingUses || 0);
                        const usedB = (b.totalUses || 0) - (b.remainingUses || 0);
                        if (usedA !== usedB) {
                            // ä½¿ç”¨æ¬¡æ•¸å¤šçš„æŽ’å‰é¢
                            return usedB - usedA;
                        }
                        // ä½¿ç”¨æ¬¡æ•¸ç›¸åŒï¼ŒæŒ‰è³¼è²·æ—¥æœŸæ—©çš„æŽ’å‰é¢
                        const pa = a.purchasedAt ? new Date(a.purchasedAt).getTime() : 0;
                        const pb = b.purchasedAt ? new Date(b.purchasedAt).getTime() : 0;
                        if (pa !== pb) {
                            return pa - pb;
                        }
                        // è‹¥è³¼è²·æ—¥æœŸä¹Ÿç›¸åŒï¼Œä½¿ç”¨ ID çš„å­—å…¸åºé€²è¡Œæœ€å¾ŒæŽ’åºï¼Œç¢ºä¿ deterministic
                        if (a.id && b.id) {
                            return String(a.id).localeCompare(String(b.id));
                        }
                        return 0;
                    });
                    const chosen = candidates[0];
                    // å°‡åŒ¹é…åˆ°çš„å¥—ç¥¨ ID è½‰ç‚ºå­—ä¸²
                    item.packageRecordId = (chosen && chosen.id) ? String(chosen.id) : '';
                    // æ‰¾åˆ°å°æ‡‰çš„å¥—ç¥¨ï¼Œå–æ¶ˆæ­·å²æ¨™è¨˜
                    item.isHistorical = false;
                } else {
                    // æ‰¾ä¸åˆ°åŒ¹é…çš„å¥—ç¥¨ï¼Œä¿æŒæ­·å²è¨˜éŒ„ç‹€æ…‹
                    item.isHistorical = true;
                }
            }
        });
    } catch (error) {
        console.error('restorePackageUseMeta éŒ¯èª¤:', error);
    }
}
// å°‡å‡½å¼æš´éœ²åˆ°å…¨åŸŸä»¥ä¾¿å…¶ä»–éƒ¨åˆ†èª¿ç”¨
window.restorePackageUseMeta = restorePackageUseMeta;
// Firebase æ•¸æ“šç®¡ç†ç³»çµ±
class FirebaseDataManager {
    constructor() {
        // è¨­ç½®åˆå§‹ç‹€æ…‹èˆ‡å¿«å–æ¬„ä½
        this.isReady = false;
        // ç”¨æ–¼ç·©å­˜ç—…äººåˆ—è¡¨ï¼Œé¿å…åœ¨åŒä¸€å·¥ä½œéšŽæ®µé‡è¤‡å‘ Firestore è®€å–æ•´å€‹ patients é›†åˆ
        this.patientsCache = null;
        // ç”¨æ–¼ç·©å­˜è¨ºç—‡è¨˜éŒ„åˆ—è¡¨èˆ‡å…¶åˆ†é è³‡è¨Š
        this.consultationsCache = null;
        this.consultationsLastVisible = null;
        this.consultationsHasMore = false;
        // ç”¨æ–¼ç·©å­˜ç”¨æˆ¶åˆ—è¡¨èˆ‡å…¶åˆ†é è³‡è¨Š
        this.usersCache = null;
        this.usersLastVisible = null;
        this.usersHasMore = false;
        this.initializeWhenReady();
    }

    async initializeWhenReady() {
        // ç­‰å¾… Firebase åˆå§‹åŒ–ï¼Œä½¿ç”¨é€šç”¨ç­‰å¾…å‡½å¼
        await waitForFirebase();
        this.isReady = true;
        console.log('Firebase æ•¸æ“šç®¡ç†å™¨å·²æº–å‚™å°±ç·’');
    }

    // ç—…äººæ•¸æ“šç®¡ç†
    async addPatient(patientData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }

        try {
            // è¨ˆç®—æœå°‹é—œéµå­—
            const keywords = generateSearchKeywords({
                ...patientData,
                patientNumber: patientData.patientNumber
            });
            // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å„²å­˜åˆ°æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = patientData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = patientData;
            }
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'patients'),
                {
                    ...dataToWrite,
                    searchKeywords: keywords,
                    // åˆå§‹åŒ–å¥—ç¥¨å½™ç¸½æ¬„ä½ï¼Œé¿å…æœªè³¼è²·å¥—ç¥¨æ™‚ç‚º undefined
                    packageActiveCount: 0,
                    packageRemainingUses: 0,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser || 'system'
                }
            );
            
            console.log('ç—…äººæ•¸æ“šå·²æ·»åŠ åˆ° Firebase:', docRef.id);
            // æ–°å¢žç—…äººå¾Œæ¸…é™¤ç·©å­˜ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”ï¼Œè®“ä¸‹ä¸€æ¬¡è®€å–æ™‚é‡æ–°è¼‰å…¥
            this.patientsCache = null;
            try {
                localStorage.removeItem('patients');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ ç—…äººæ•¸æ“šå¤±æ•—:', error);
            showToast('ä¿å­˜ç—…äººæ•¸æ“šå¤±æ•—', 'error');
            return { success: false, error: error.message };
        }
    }

    /**
     * è®€å–ç—…äººåˆ—è¡¨ä¸¦ä½¿ç”¨å…§éƒ¨å¿«å–ã€‚
     * é è¨­æƒ…æ³ä¸‹è‹¥å·²å­˜åœ¨å¿«å–ï¼Œç›´æŽ¥å›žå‚³å¿«å–å…§å®¹ä»¥é¿å…é‡è¤‡è®€å–ã€‚
     * å‚³å…¥ forceRefresh=true å¯å¼·åˆ¶åˆ·æ–°å¿«å–ä¸¦é‡æ–°å¾ž Firestore å–å¾—æœ€æ–°è³‡æ–™ã€‚
     *
     * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°è¼‰å…¥
     * @returns {Promise<{ success: boolean, data: Array }>} ç—…äººè³‡æ–™
     */
    async getPatients(forceRefresh = false) {
        if (!this.isReady) return { success: false, data: [] };
        try {
            // è‹¥å·²å­˜åœ¨å¿«å–ä¸”ä¸éœ€å¼·åˆ¶åˆ·æ–°ï¼Œç›´æŽ¥å›žå‚³å¿«å–
            // åŒ…å«ç©ºé™£åˆ—äº¦æ‡‰è¦–ç‚ºæœ‰æ•ˆå¿«å–ï¼Œé¿å…åœ¨æ²’æœ‰ç—…äººæ™‚æ¯æ¬¡éƒ½åŽ»è®€å–
            if (!forceRefresh && this.patientsCache !== null) {
                return { success: true, data: this.patientsCache };
            }
            // å˜—è©¦å¾ž localStorage è¼‰å…¥ç—…äººè³‡æ–™ï¼Œä»¥æ¸›å°‘ Firebase è®€å–æ¬¡æ•¸
            if (!forceRefresh) {
                try {
                    const stored = localStorage.getItem('patients');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        if (Array.isArray(localData)) {
                            this.patientsCache = localData;
                            return { success: true, data: this.patientsCache };
                        }
                    }
                } catch (lsErr) {
                    console.warn('è¼‰å…¥æœ¬åœ°ç—…äººè³‡æ–™å¤±æ•—:', lsErr);
                }
            }
            const querySnapshot = await window.firebase.getDocs(
                window.firebase.collection(window.firebase.db, 'patients')
            );
            const patients = [];
            querySnapshot.forEach((doc) => {
                patients.push({ id: doc.id, ...doc.data() });
            });
            // å°‡çµæžœå¯«å…¥å¿«å–èˆ‡ localStorage
            this.patientsCache = patients;
            try {
                localStorage.setItem('patients', JSON.stringify(patients));
            } catch (lsErr) {
                console.warn('ä¿å­˜ç—…äººè³‡æ–™åˆ°æœ¬åœ°å¤±æ•—:', lsErr);
            }
            console.log('å·²å¾ž Firebase è®€å–ç—…äººæ•¸æ“š:', patients.length, 'ç­†');
            return { success: true, data: patients };
        } catch (error) {
            console.error('è®€å–ç—…äººæ•¸æ“šå¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    async updatePatient(patientId, patientData) {
        try {
            // è¨ˆç®—æœå°‹é—œéµå­—ï¼Œä»¥ä¾¿å¾ŒçºŒæœå°‹
            const keywords = generateSearchKeywords({
                ...patientData,
                patientNumber: patientData.patientNumber
            });
            // ç§»é™¤ id å±¬æ€§ï¼Œä»¥é¿å… id è¢«å„²å­˜åˆ°æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = patientData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = patientData;
            }
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'patients', patientId),
                {
                    ...dataToWrite,
                    searchKeywords: keywords,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                }
            );
            // æ›´æ–°ç—…äººè³‡æ–™å¾Œæ¸…é™¤ç·©å­˜ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”ï¼Œè®“ä¸‹ä¸€æ¬¡è®€å–æ™‚é‡æ–°è¼‰å…¥
            this.patientsCache = null;
            try {
                localStorage.removeItem('patients');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°ç—…äººæ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async deletePatient(patientId) {
        try {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'patients', patientId)
            );
            // åˆªé™¤ç—…äººå¾Œæ¸…é™¤ç·©å­˜ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”
            this.patientsCache = null;
            try {
                localStorage.removeItem('patients');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            return { success: true };
        } catch (error) {
            console.error('åˆªé™¤ç—…äººæ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * æ ¹æ“šæœå°‹å­—ä¸²æœå°‹ç—…äººã€‚
     *
     * æ­¤æ–¹æ³•æœƒå„ªå…ˆä½¿ç”¨å­˜æ–¼æ¯ç­†ç—…äººæ–‡ä»¶ä¸­çš„ searchKeywords æ¬„ä½é€²è¡Œ array-contains æ¢ä»¶æŸ¥è©¢ï¼Œ
     * å¿«é€Ÿå–å¾—åŒ¹é…çš„ç—…äººåˆ—è¡¨ã€‚è‹¥æœå°‹çµæžœä¸è¶³ä¸”æœ¬åœ°å·²æœ‰å®Œæ•´çš„ç—…äººå¿«å–ï¼Œå‰‡æœƒåœ¨å¿«å–ä¸­
     * ä»¥é—œéµå­—åŒ…å«é‚è¼¯é€²è¡ŒéŽæ¿¾ï¼Œæ”¯æ´å°šæœªå»ºç«‹ searchKeywords æ¬„ä½çš„èˆŠè³‡æ–™ã€‚
     *
     * @param {string} term è¦æœå°‹çš„é—œéµå­—
     * @param {number} limit è¿”å›žçµæžœæ•¸é‡ä¸Šé™
     * @returns {Promise<{success: boolean, data: Array}>}
     */
    async searchPatients(term, limit = 20) {
        if (!this.isReady) {
            return { success: false, data: [] };
        }
        try {
            await waitForFirebaseDb();
            const searchTerm = (term || '').trim().toLowerCase();
            if (!searchTerm) {
                return { success: true, data: [] };
            }
            const results = [];
            // é€éŽ searchKeywords é€²è¡ŒæŸ¥è©¢
            try {
                const colRef = window.firebase.collection(window.firebase.db, 'patients');
                const q = window.firebase.query(
                    colRef,
                    window.firebase.where('searchKeywords', 'array-contains', searchTerm),
                    window.firebase.limit(limit)
                );
                const snapshot = await window.firebase.getDocs(q);
                snapshot.forEach(doc => {
                    results.push({ id: doc.id, ...doc.data() });
                });
            } catch (err) {
                console.error('æœå°‹ç—…äººæ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
            }
            /*
             * é€éŽ searchKeywords æŸ¥è©¢å¾Œï¼Œæˆ‘å€‘é‚„éœ€è¦åœ¨æœ¬åœ°å¿«å–ä¸­é€²è¡Œè£œå¼·æœå°‹ã€‚
             * éŽåŽ»åƒ…ç•¶ Firestore æŸ¥è©¢çµæžœä¸è¶³æ™‚æ‰é€²è¡Œå¿«å–æœå°‹ï¼Œé€™æœƒå°Žè‡´ç•¶
             * searchKeywords ä¸­æ²’æœ‰åŒ…å«ä½¿ç”¨è€…è¼¸å…¥çš„å­—ä¸²æ™‚ï¼Œè‹¥ç›®å‰å¿«å–å°šæœªè¼‰å…¥ï¼Œ
             * ä½¿ç”¨è€…è¼¸å…¥çš„é›»è©±æˆ–ç—…äººç·¨è™Ÿç‰‡æ®µç­‰æ¢ä»¶ç„¡æ³•è¢«åŒ¹é…åˆ°ã€‚
             * ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼Œæˆ‘å€‘æ”¹ç‚ºç¸½æ˜¯è¼‰å…¥å¿«å–ï¼ˆè‹¥å°šæœªå­˜åœ¨ï¼‰ï¼Œä¸¦åœ¨
             * æœ¬åœ°è³‡æ–™ä¸Šæ¯”å°åç¨±ã€é›»è©±ã€èº«åˆ†è­‰èˆ‡ç—…äººç·¨è™Ÿç­‰æ¬„ä½æ˜¯å¦åŒ…å«è¼¸å…¥å­—ä¸²ã€‚
             */
            let localPatients = [];
            try {
                // å¦‚æžœ patientsCache å°šæœªè¼‰å…¥ï¼Œä¸»å‹•è®€å–å…¨é«”ç—…äººåˆ—è¡¨ä»¥åˆ©æœå°‹
                if (!Array.isArray(this.patientsCache)) {
                    const patientRes = await this.getPatients();
                    if (patientRes && patientRes.success && Array.isArray(patientRes.data)) {
                        localPatients = patientRes.data;
                        // æ›´æ–°å¿«å–ä»¥ä¾›ä¸‹æ¬¡ä½¿ç”¨
                        this.patientsCache = patientRes.data;
                    }
                } else {
                    localPatients = this.patientsCache;
                }
            } catch (cacheErr) {
                console.error('è®€å–ç—…äººå¿«å–æ™‚ç™¼ç”ŸéŒ¯èª¤:', cacheErr);
                localPatients = Array.isArray(this.patientsCache) ? this.patientsCache : [];
            }
            // åœ¨æœ¬åœ°è³‡æ–™ä¸­è£œå¼·æœå°‹ï¼Œé¿å…é‡è¤‡åŠ å…¥å·²åœ¨ results ä¸­çš„ç—…äººã€‚
            if (Array.isArray(localPatients) && localPatients.length > 0) {
                const seen = new Set(results.map(p => String(p.id)));
                const low = searchTerm;
                for (const p of localPatients) {
                    // æŽ§åˆ¶è¿”å›žæ•¸é‡ä¸è¶…éŽæŒ‡å®š limit
                    if (results.length >= limit) break;
                    if (seen.has(String(p.id))) continue;
                    // æ¯”å°å§“åã€é›»è©±ã€èº«åˆ†è­‰å­—è™Ÿèˆ‡ç—…äººç·¨è™Ÿæ¬„ä½
                    const nameMatch = p.name && String(p.name).toLowerCase().includes(low);
                    const phoneMatch = p.phone && String(p.phone).toLowerCase().includes(low);
                    const idMatch = p.idCard && String(p.idCard).toLowerCase().includes(low);
                    const numberMatch = p.patientNumber && String(p.patientNumber).toLowerCase().includes(low);
                    if (nameMatch || phoneMatch || idMatch || numberMatch) {
                        results.push(p);
                        seen.add(String(p.id));
                    }
                }
            }
            return { success: true, data: results };
        } catch (error) {
            console.error('searchPatients ç™¼ç”ŸéŒ¯èª¤:', error);
            return { success: false, data: [] };
        }
    }
// è¨ºç—‡è¨˜éŒ„ç®¡ç†
    async addConsultation(consultationData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }

        try {
            // When creating a new consultation record we only set the createdAt timestamp
            // and createdBy. The updatedAt field should be reserved for subsequent edits.
            // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å„²å­˜åˆ°æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = consultationData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = consultationData;
            }
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'consultations'),
                {
                    ...dataToWrite,
                    createdAt: new Date(),
                    createdBy: currentUser
                }
            );
            
            console.log('è¨ºç—‡è¨˜éŒ„å·²æ·»åŠ åˆ° Firebase:', docRef.id);
            // æ–°å¢žè¨ºç—‡å¾Œæ¸…é™¤å…¨åŸŸè¨ºç—‡å¿«å–ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”
            this.consultationsCache = null;
            try {
                localStorage.removeItem('consultations');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            // åŒæ™‚æ¸…é™¤æˆ–æ›´æ–°å–®ä¸€ç—…äººçš„è¨ºç—‡å¿«å–ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡æ–°è®€å–
            try {
                if (consultationData && consultationData.patientId) {
                    delete patientConsultationsCache[consultationData.patientId];
                } else {
                    // å¦‚æžœç¼ºå°‘ç—…äºº IDï¼Œæ¸…é™¤æ‰€æœ‰ç—…äººè¨ºç—‡å¿«å–
                    patientConsultationsCache = {};
                }
            } catch (_err) {
                // è‹¥åŸ·è¡Œå¿«å–æ¸…ç†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œç›´æŽ¥é‡ç½®å¿«å–
                patientConsultationsCache = {};
            }
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ è¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            showToast('ä¿å­˜è¨ºç—‡è¨˜éŒ„å¤±æ•—', 'error');
            return { success: false, error: error.message };
        }
    }

    /**
     * è®€å–è¨ºç—‡è¨˜éŒ„åˆ—è¡¨ä¸¦ä½¿ç”¨å…§éƒ¨å¿«å–ã€‚
     * é è¨­æƒ…æ³ä¸‹è‹¥å·²å­˜åœ¨å¿«å–ï¼Œç›´æŽ¥å›žå‚³å¿«å–å…§å®¹ä»¥é¿å…é‡è¤‡è®€å–ã€‚
     * å‚³å…¥ forceRefresh=true å¯å¼·åˆ¶åˆ·æ–°å¿«å–ä¸¦é‡æ–°å¾ž Firestore å–å¾—æœ€æ–°è³‡æ–™ã€‚
     *
     * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°è¼‰å…¥
     * @returns {Promise<{ success: boolean, data: Array }>} è¨ºç—‡è¨˜éŒ„è³‡æ–™
     */
    /**
     * å–å¾—è¨ºç—‡è¨˜éŒ„åˆ—è¡¨ã€‚
     * é è¨­åƒ…è®€å–ç¬¬ä¸€æ‰¹è³‡æ–™ï¼Œä¸¦å°‡æ¸¸æ¨™èˆ‡å¿«å–å­˜å…¥å¯¦ä¾‹å±¬æ€§ï¼Œä¾›å¾ŒçºŒåˆ†é ä½¿ç”¨ã€‚
     * è‹¥å‚³å…¥ forceRefresh=true å‰‡é‡ç½®æ¸¸æ¨™ä¸¦é‡æ–°è®€å–ç¬¬ä¸€æ‰¹è³‡æ–™ã€‚
     *
     * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾ž Firestore è®€å–ç¬¬ä¸€é è³‡æ–™
     * @returns {Promise<{ success: boolean, data: Array, hasMore: boolean }>}
     */
    async getConsultations(forceRefresh = false) {
        if (!this.isReady) return { success: false, data: [] };
        try {
            // æœ‰å…§å­˜å¿«å–ä¸”ä¸éœ€å¼·åˆ¶åˆ·æ–°æ™‚ç›´æŽ¥è¿”å›ž
            if (!forceRefresh && this.consultationsCache !== null) {
                return { success: true, data: this.consultationsCache, hasMore: !!this.consultationsHasMore };
            }
            // å„ªå…ˆå¾ž localStorage è¼‰å…¥è¨ºç—‡è¨˜éŒ„ï¼ˆåƒ…é™ç¬¬ä¸€é ï¼‰
            if (!forceRefresh) {
                try {
                    const stored = localStorage.getItem('consultations');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        if (Array.isArray(localData)) {
                            this.consultationsCache = localData;
                            // æœ¬åœ°å¿«å–ä¸ä¿å­˜åˆ†é æ¸¸æ¨™æˆ–æ˜¯å¦æœ‰æ›´å¤šè³‡æ–™
                            this.consultationsLastVisible = null;
                            this.consultationsHasMore = false;
                            return { success: true, data: this.consultationsCache, hasMore: this.consultationsHasMore };
                        }
                    }
                } catch (lsErr) {
                    console.warn('è¼‰å…¥æœ¬åœ°è¨ºç—‡è¨˜éŒ„å¤±æ•—:', lsErr);
                }
            }
            // æ¸…é™¤æ—¢æœ‰å¿«å–èˆ‡æ¸¸æ¨™
            this.consultationsCache = [];
            this.consultationsLastVisible = null;
            this.consultationsHasMore = false;
            const pageSize = 100;
            // å»ºç«‹æŸ¥è©¢ï¼šä½¿ç”¨ limit æŽ§åˆ¶å–®æ¬¡è¼‰å…¥ç­†æ•¸
            const q = window.firebase.firestoreQuery(
                window.firebase.collection(window.firebase.db, 'consultations'),
                window.firebase.limit(pageSize)
            );
            const querySnapshot = await window.firebase.getDocs(q);
            const consultations = [];
            querySnapshot.forEach((docSnap) => {
                consultations.push({ id: docSnap.id, ...docSnap.data() });
            });
            // è¨­å®šæ¸¸æ¨™ç‚ºæœ€å¾Œä¸€ç­†æ–‡ä»¶
            this.consultationsLastVisible = querySnapshot.docs.length > 0 ? querySnapshot.docs[querySnapshot.docs.length - 1] : null;
            // åˆ¤æ–·æ˜¯å¦é‚„æœ‰ä¸‹ä¸€é 
            this.consultationsHasMore = querySnapshot.docs.length === pageSize;
            // æ›´æ–°å¿«å–
            this.consultationsCache = consultations;
            // å°‡çµæžœå¯«å…¥ localStorage ä¾›ä¸‹æ¬¡ä½¿ç”¨
            try {
                localStorage.setItem('consultations', JSON.stringify(consultations));
            } catch (lsErr) {
                console.warn('ä¿å­˜è¨ºç—‡è¨˜éŒ„åˆ°æœ¬åœ°å¤±æ•—:', lsErr);
            }
            console.log('å·²å¾ž Firebase è®€å–è¨ºç—‡è¨˜éŒ„ï¼Œè¼‰å…¥', consultations.length, 'ç­†');
            return { success: true, data: consultations, hasMore: this.consultationsHasMore };
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    /**
     * å–å¾—è¨ºç—‡è¨˜éŒ„çš„ä¸‹ä¸€é è³‡æ–™ã€‚
     * éœ€è¦å…ˆå‘¼å« getConsultations() è®€å–ç¬¬ä¸€æ‰¹è³‡æ–™å¾Œï¼Œæ‰èƒ½ä½¿ç”¨æœ¬æ–¹æ³•ã€‚
     * æœ¬æ–¹æ³•æœƒæ›´æ–°å¿«å–åŠæ¸¸æ¨™ä¸¦å°‡æ–°åŠ å…¥çš„è³‡æ–™é™„åŠ è‡³å¿«å–é™£åˆ—ã€‚
     * è‹¥æ²’æœ‰æ›´å¤šè³‡æ–™å¯è®€å–ï¼Œå°‡å›žå‚³ç©ºé™£åˆ—ä¸¦ç¶­æŒ hasMore ç‚º falseã€‚
     *
     * @returns {Promise<{ success: boolean, data: Array, hasMore: boolean }>}
     */
    async getConsultationsNextPage() {
        if (!this.isReady) return { success: false, data: [] };
        try {
            // è‹¥ä¸Šä¸€é æ²’æœ‰è®€å–æ»¿ pageSizeï¼Œè¡¨ç¤ºæ²’æœ‰æ›´å¤šè³‡æ–™
            if (!this.consultationsHasMore || !this.consultationsLastVisible) {
                return { success: true, data: [], hasMore: false };
            }
            const pageSize = 100;
            // å»ºç«‹æŸ¥è©¢ï¼šå¾žä¸Šä¸€é æœ€å¾Œä¸€ç­†ä¹‹å¾Œé–‹å§‹
            const q = window.firebase.firestoreQuery(
                window.firebase.collection(window.firebase.db, 'consultations'),
                window.firebase.startAfter(this.consultationsLastVisible),
                window.firebase.limit(pageSize)
            );
            const snapshot = await window.firebase.getDocs(q);
            const newData = [];
            snapshot.forEach((docSnap) => {
                newData.push({ id: docSnap.id, ...docSnap.data() });
            });
            // æ›´æ–°æ¸¸æ¨™
            this.consultationsLastVisible = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : this.consultationsLastVisible;
            // åˆ¤æ–·æ˜¯å¦é‚„æœ‰æ›´å¤šè³‡æ–™
            this.consultationsHasMore = snapshot.docs.length === pageSize;
            // å°‡æ–°è³‡æ–™é™„åŠ è‡³å¿«å–
            this.consultationsCache = Array.isArray(this.consultationsCache) ? this.consultationsCache.concat(newData) : newData;
            // æ›´æ–° localStorage å¿«å–ï¼Œç”¨æ–¼ä¸‹æ¬¡é é¢è¼‰å…¥
            try {
                localStorage.setItem('consultations', JSON.stringify(this.consultationsCache));
            } catch (lsErr) {
                console.warn('ä¿å­˜è¨ºç—‡è¨˜éŒ„åˆ°æœ¬åœ°å¤±æ•—:', lsErr);
            }
            return { success: true, data: this.consultationsCache, hasMore: this.consultationsHasMore };
        } catch (error) {
            console.error('è®€å–è¨ºç—‡è¨˜éŒ„ä¸‹ä¸€é å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    async updateConsultation(consultationId, consultationData) {
        try {
            // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å°‡ id å¯«å…¥æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = consultationData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = consultationData;
            }
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'consultations', consultationId),
                {
                    ...dataToWrite,
                    updatedAt: new Date(),
                    updatedBy: currentUser
                }
            );
            // æ›´æ–°è¨ºç—‡å¾Œæ¸…é™¤å…¨åŸŸè¨ºç—‡å¿«å–ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”
            this.consultationsCache = null;
            try {
                localStorage.removeItem('consultations');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            // æ›´æ–°å–®ä¸€ç—…äººè¨ºç—‡å¿«å–æˆ–æ¸…é™¤å…¨éƒ¨å¿«å–
            try {
                if (consultationData && consultationData.patientId) {
                    delete patientConsultationsCache[consultationData.patientId];
                } else {
                    // å¦‚æžœç„¡æ³•ç¢ºå®šç—…äºº IDï¼Œå‰‡æ¸…é™¤æ‰€æœ‰ç—…äººè¨ºç—‡å¿«å–
                    patientConsultationsCache = {};
                }
            } catch (_err) {
                patientConsultationsCache = {};
            }
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°è¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async getPatientConsultations(patientId, forceRefresh = false) {
        if (!this.isReady) return { success: false, data: [] };

        try {
            // è‹¥å¿«å–å­˜åœ¨ä¸”ä¸éœ€è¦å¼·åˆ¶åˆ·æ–°ï¼Œç›´æŽ¥å›žå‚³å¿«å–è³‡æ–™
            if (!forceRefresh && patientConsultationsCache && Array.isArray(patientConsultationsCache[patientId])) {
                return { success: true, data: patientConsultationsCache[patientId] };
            }
            /**
             * æ”¹ç‚ºç›´æŽ¥ä½¿ç”¨ Firestore æŸ¥è©¢ç‰¹å®š patientId çš„è¨ºç™‚è¨˜éŒ„ï¼Œé¿å…å…ˆè®€å–å…¨éƒ¨å¾Œå†éŽæ¿¾ã€‚
             * é€™æ¨£å¯é™ä½Žè®€å–é‡ï¼Œåƒ…åœ¨é–‹å•Ÿç—…æ­·æ™‚è®€å–è©²ç—…æ‚£ç›¸é—œçš„è¨ºç™‚è¨˜éŒ„ã€‚
             */
            // ä½¿ç”¨ where æ¢ä»¶å»ºç«‹æŸ¥è©¢
            const colRef = window.firebase.collection(window.firebase.db, 'consultations');
            const q = window.firebase.firestoreQuery(colRef, window.firebase.where('patientId', '==', patientId));
            const querySnapshot = await window.firebase.getDocs(q);
            const patientConsultations = [];
            querySnapshot.forEach((docSnap) => {
                patientConsultations.push({ id: docSnap.id, ...docSnap.data() });
            });
            // æŒ‰æ—¥æœŸï¼ˆè‹¥æœ‰ date æ¬„ä½ï¼‰æˆ– createdAt æŽ’åºï¼Œæœ€æ–°åœ¨å‰
            patientConsultations.sort((a, b) => {
                const dateA = a.date
                    ? (a.date.seconds ? new Date(a.date.seconds * 1000) : new Date(a.date))
                    : (a.createdAt && a.createdAt.seconds ? new Date(a.createdAt.seconds * 1000) : new Date(a.createdAt));
                const dateB = b.date
                    ? (b.date.seconds ? new Date(b.date.seconds * 1000) : new Date(b.date))
                    : (b.createdAt && b.createdAt.seconds ? new Date(b.createdAt.seconds * 1000) : new Date(b.createdAt));
                return dateB - dateA;
            });
            // å„²å­˜è‡³å¿«å–ä»¥ä¾›å¾ŒçºŒä½¿ç”¨
            patientConsultationsCache[patientId] = patientConsultations;
            return { success: true, data: patientConsultations };
        } catch (error) {
            console.error('è®€å–ç—…äººè¨ºç—‡è¨˜éŒ„å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }
    // ç”¨æˆ¶æ•¸æ“šç®¡ç†
    async addUser(userData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }

        try {
            // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å„²å­˜åˆ°æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = userData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = userData;
            }
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'users'),
                {
                    ...dataToWrite,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    createdBy: currentUser || 'system'
                }
            );
            
            console.log('ç”¨æˆ¶æ•¸æ“šå·²æ·»åŠ åˆ° Firebase:', docRef.id);
            // æ–°å¢žç”¨æˆ¶å¾Œæ¸…é™¤å¿«å–ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”
            this.usersCache = null;
            try {
                localStorage.removeItem('users');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            showToast('ä¿å­˜ç”¨æˆ¶æ•¸æ“šå¤±æ•—', 'error');
            return { success: false, error: error.message };
        }
    }

    /**
     * å–å¾—ç”¨æˆ¶åˆ—è¡¨ã€‚
     * é è¨­åƒ…è®€å–ç¬¬ä¸€æ‰¹è³‡æ–™ï¼Œä¸¦å°‡æ¸¸æ¨™èˆ‡å¿«å–å­˜å…¥å¯¦ä¾‹å±¬æ€§ï¼Œä¾›å¾ŒçºŒåˆ†é ä½¿ç”¨ã€‚
     * è‹¥å‚³å…¥ forceRefresh=true å‰‡é‡ç½®æ¸¸æ¨™ä¸¦é‡æ–°è®€å–ç¬¬ä¸€æ‰¹è³‡æ–™ã€‚
     *
     * @param {boolean} forceRefresh æ˜¯å¦å¼·åˆ¶é‡æ–°å¾ž Firestore è®€å–ç¬¬ä¸€é è³‡æ–™
     * @returns {Promise<{ success: boolean, data: Array, hasMore: boolean }>}
     */
    async getUsers(forceRefresh = false) {
        if (!this.isReady) return { success: false, data: [] };
        try {
            // å¦‚æžœå°šæœªç™»å…¥ï¼ˆç„¡ auth.currentUserï¼‰ï¼Œä¸è¦å˜—è©¦å¾ž Firestore è®€å–ï¼Œä»¥é¿å…è§¸ç™¼æ¬Šé™éŒ¯èª¤ã€‚
            const authCurrent = window.firebase && window.firebase.auth && window.firebase.auth.currentUser;
            if (!authCurrent) {
                // æœªç™»å…¥æ™‚ï¼Œå„ªå…ˆè¿”å›žå¿«å–æˆ–æœ¬åœ°è³‡æ–™ï¼›ä¸å˜—è©¦é ç«¯è®€å–
                if (!forceRefresh && this.usersCache !== null) {
                    return { success: true, data: this.usersCache, hasMore: !!this.usersHasMore };
                }
                if (!forceRefresh) {
                    try {
                        const stored = localStorage.getItem('users');
                        if (stored) {
                            const localData = JSON.parse(stored);
                            if (Array.isArray(localData)) {
                                this.usersCache = localData;
                                this.usersLastVisible = null;
                                this.usersHasMore = false;
                                return { success: true, data: this.usersCache, hasMore: false };
                            }
                        }
                    } catch (lsErr) {
                        console.warn('è¼‰å…¥æœ¬åœ°ç”¨æˆ¶è³‡æ–™å¤±æ•—:', lsErr);
                    }
                }
                // æœªç™»å…¥ä¸”ç„¡å¯ç”¨è³‡æ–™ï¼Œè¿”å›žç©ºé™£åˆ—
                return { success: true, data: [], hasMore: false };
            }
            // å·²ç™»å…¥ï¼šè‹¥æœ‰å¿«å–ä¸”ä¸éœ€å¼·åˆ¶åˆ·æ–°ï¼Œç›´æŽ¥å›žå‚³ç¾æœ‰å¿«å–
            if (!forceRefresh && this.usersCache !== null) {
                return { success: true, data: this.usersCache, hasMore: !!this.usersHasMore };
            }
            // å˜—è©¦å¾ž localStorage è¼‰å…¥ç”¨æˆ¶è³‡æ–™
            if (!forceRefresh) {
                try {
                    const stored = localStorage.getItem('users');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        if (Array.isArray(localData)) {
                            this.usersCache = localData;
                            this.usersLastVisible = null;
                            this.usersHasMore = false;
                            return { success: true, data: this.usersCache, hasMore: false };
                        }
                    }
                } catch (lsErr) {
                    console.warn('è¼‰å…¥æœ¬åœ°ç”¨æˆ¶è³‡æ–™å¤±æ•—:', lsErr);
                }
            }
            // é‡ç½®å¿«å–èˆ‡æ¸¸æ¨™
            this.usersCache = [];
            this.usersLastVisible = null;
            this.usersHasMore = false;
            const pageSize = 100;
            const q = window.firebase.firestoreQuery(
                window.firebase.collection(window.firebase.db, 'users'),
                window.firebase.limit(pageSize)
            );
            const snapshot = await window.firebase.getDocs(q);
            const users = [];
            snapshot.forEach((docSnap) => {
                users.push({ id: docSnap.id, ...docSnap.data() });
            });
            this.usersLastVisible = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : null;
            this.usersHasMore = snapshot.docs.length === pageSize;
            this.usersCache = users;
            // å­˜å…¥ localStorage ä»¥ä¾¿ä¸‹æ¬¡è¼‰å…¥
            try {
                localStorage.setItem('users', JSON.stringify(users));
            } catch (lsErr) {
                console.warn('ä¿å­˜ç”¨æˆ¶è³‡æ–™åˆ°æœ¬åœ°å¤±æ•—:', lsErr);
            }
            console.log('å·²å¾ž Firebase è®€å–ç”¨æˆ¶æ•¸æ“šï¼Œè¼‰å…¥', users.length, 'ç­†');
            return { success: true, data: users, hasMore: this.usersHasMore };
        } catch (error) {
            console.error('è®€å–ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¸è¦è¦†å¯«ç¾æœ‰å¿«å–ï¼Œä»è¿”å›žç•¶å‰å¿«å–è³‡æ–™ä»¥é¿å…è¦†è“‹
            const fallbackData = Array.isArray(this.usersCache) ? this.usersCache : [];
            return { success: true, data: fallbackData, hasMore: !!this.usersHasMore };
        }
    }

    /**
     * å–å¾—ç”¨æˆ¶åˆ—è¡¨çš„ä¸‹ä¸€é è³‡æ–™ã€‚
     * éœ€è¦å…ˆå‘¼å« getUsers() å–å¾—ç¬¬ä¸€é å¾Œï¼Œæ‰èƒ½ä½¿ç”¨æœ¬æ–¹æ³•ã€‚
     * æœ¬æ–¹æ³•æœƒæ›´æ–°å¿«å–åŠæ¸¸æ¨™ä¸¦å°‡æ–°è³‡æ–™é™„åŠ è‡³å¿«å–ã€‚
     * è‹¥æ²’æœ‰æ›´å¤šè³‡æ–™å¯è®€å–ï¼Œå°‡å›žå‚³ç©ºé™£åˆ—ä¸¦ç¶­æŒ hasMore ç‚º falseã€‚
     *
     * @returns {Promise<{ success: boolean, data: Array, hasMore: boolean }>}
     */
    async getUsersNextPage() {
        if (!this.isReady) return { success: false, data: [] };
        try {
            if (!this.usersHasMore || !this.usersLastVisible) {
                return { success: true, data: [], hasMore: false };
            }
            const pageSize = 100;
            const q = window.firebase.firestoreQuery(
                window.firebase.collection(window.firebase.db, 'users'),
                window.firebase.startAfter(this.usersLastVisible),
                window.firebase.limit(pageSize)
            );
            const snapshot = await window.firebase.getDocs(q);
            const newData = [];
            snapshot.forEach((docSnap) => {
                newData.push({ id: docSnap.id, ...docSnap.data() });
            });
            this.usersLastVisible = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : this.usersLastVisible;
            this.usersHasMore = snapshot.docs.length === pageSize;
            this.usersCache = Array.isArray(this.usersCache) ? this.usersCache.concat(newData) : newData;
            return { success: true, data: this.usersCache, hasMore: this.usersHasMore };
        } catch (error) {
            console.error('è®€å–ç”¨æˆ¶è³‡æ–™ä¸‹ä¸€é å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    async updateUser(userId, userData) {
        try {
            // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å°‡ id å¯«å…¥æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = userData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = userData;
            }
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'users', userId),
                {
                    ...dataToWrite,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                }
            );
            // æ›´æ–°ç”¨æˆ¶å¾Œæ¸…é™¤ç”¨æˆ¶ç·©å­˜ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”
            this.usersCache = null;
            try {
                localStorage.removeItem('users');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async deleteUser(userId) {
        try {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'users', userId)
            );
            // åˆªé™¤ç”¨æˆ¶å¾Œæ¸…é™¤ç·©å­˜ä¸¦ç§»é™¤æœ¬åœ°å­˜æª”
            this.usersCache = null;
            try {
                localStorage.removeItem('users');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
            return { success: true };
        } catch (error) {
            console.error('åˆªé™¤ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    // æŽ›è™Ÿè³‡æ–™ç®¡ç†ï¼ˆä½¿ç”¨ Realtime Databaseï¼‰
    async addAppointment(appointmentData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }
        try {
            const id = appointmentData.id;
            // å°‡æŽ›è™Ÿè³‡æ–™å­˜å…¥ Realtime Databaseï¼Œä»¥æŽ›è™Ÿ ID ä½œç‚ºéµ
            await window.firebase.set(
                window.firebase.ref(window.firebase.rtdb, 'appointments/' + id),
                { ...appointmentData }
            );
            console.log('æŽ›è™Ÿè³‡æ–™å·²æ·»åŠ åˆ° Firebase Realtime Database:', id);
            return { success: true, id: id };
        } catch (error) {
            console.error('æ·»åŠ æŽ›è™Ÿæ•¸æ“šå¤±æ•—:', error);
            showToast('ä¿å­˜æŽ›è™Ÿæ•¸æ“šå¤±æ•—', 'error');
            return { success: false, error: error.message };
        }
    }

    async getAppointments() {
        if (!this.isReady) return { success: false, data: [] };
        try {
            const snapshot = await window.firebase.get(
                window.firebase.ref(window.firebase.rtdb, 'appointments')
            );
            const data = snapshot.val() || {};
            const appointments = Object.keys(data).map(key => {
                return { id: key, ...data[key] };
            });
            console.log('å·²å¾ž Firebase Realtime Database è®€å–æŽ›è™Ÿæ•¸æ“š:', appointments.length, 'ç­†');
            return { success: true, data: appointments };
        } catch (error) {
            console.error('è®€å–æŽ›è™Ÿæ•¸æ“šå¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    /**
     * è®€å–å–®ä¸€æŽ›è™Ÿè³‡æ–™ã€‚
     * é€éŽæŒ‡å®šæŽ›è™Ÿ ID çš„è·¯å¾‘è®€å–ï¼Œé¿å…ä¸€æ¬¡è¼‰å…¥æ•´å€‹ appointments æ¸…å–®ï¼Œ
     * ä»¥æ¸›å°‘ç„¡ç”¨çš„è³‡æ–™å‚³è¼¸ã€‚ç•¶è³‡æ–™å­˜åœ¨æ™‚å›žå‚³ { id, ...data }ï¼›
     * è‹¥ç¯€é»žä¸å­˜åœ¨å‰‡å›žå‚³ nullã€‚
     *
     * @param {string|number} id - æŽ›è™Ÿ ID
     * @returns {Promise<{ success: boolean, data: Object|null }>}
     */
    async getAppointment(id) {
        if (!this.isReady) return { success: false, data: null };
        try {
            const snapshot = await window.firebase.get(
                window.firebase.ref(window.firebase.rtdb, 'appointments/' + id)
            );
            const data = snapshot.val();
            if (data !== null && data !== undefined) {
                return { success: true, data: { id: String(id), ...data } };
            } else {
                return { success: false, data: null };
            }
        } catch (error) {
            console.error('è®€å–å–®ä¸€æŽ›è™Ÿå¤±æ•—:', error);
            return { success: false, data: null };
        }
    }

    async updateAppointment(id, appointmentData) {
        try {
            await window.firebase.update(
                window.firebase.ref(window.firebase.rtdb, 'appointments/' + id),
                { ...appointmentData }
            );
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°æŽ›è™Ÿæ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async deleteAppointment(id) {
        try {
            await window.firebase.remove(
                window.firebase.ref(window.firebase.rtdb, 'appointments/' + id)
            );
            return { success: true };
        } catch (error) {
            console.error('åˆªé™¤æŽ›è™Ÿæ•¸æ“šå¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }
// æ‚£è€…å¥—ç¥¨æ•¸æ“šç®¡ç†
    async addPatientPackage(packageData) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }

        try {
            // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å„²å­˜åˆ°æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = packageData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = packageData;
            }
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'patientPackages'),
                {
                    ...dataToWrite,
                    createdAt: new Date(),
                    createdBy: currentUser || 'system'
                }
            );
            
            console.log('æ‚£è€…å¥—ç¥¨å·²æ·»åŠ åˆ° Firebase:', docRef.id);
            // åœ¨æˆåŠŸæ·»åŠ å¥—ç¥¨å¾Œï¼Œæ›´æ–°ç—…äººæ–‡ä»¶ä¸­çš„å¥—ç¥¨å½™ç¸½æ¬„ä½ã€‚
            try {
                // å¥—ç¥¨è³‡æ–™ä¸­æ‡‰åŒ…å« patientId
                if (packageData && packageData.patientId) {
                    await this.updatePatientPackageAggregates(packageData.patientId);
                }
            } catch (aggErr) {
                console.error('æ–°å¢žå¥—ç¥¨å¾Œæ›´æ–°å¥—ç¥¨å½™ç¸½æ¬„ä½å¤±æ•—:', aggErr);
            }
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ æ‚£è€…å¥—ç¥¨å¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    async getPatientPackages(patientId) {
        if (!this.isReady) return { success: false, data: [] };
        try {
            // ä½¿ç”¨æ¢ä»¶æŸ¥è©¢åƒ…å–å¾—è©²ç—…äººçš„å¥—ç¥¨ï¼Œé¿å…ä¸€æ¬¡è®€å–æ•´å€‹ patientPackages é›†åˆ
            const q = window.firebase.firestoreQuery(
                window.firebase.collection(window.firebase.db, 'patientPackages'),
                window.firebase.where('patientId', '==', patientId)
            );
            const querySnapshot = await window.firebase.getDocs(q);
            const packages = [];
            querySnapshot.forEach((doc) => {
                packages.push({ id: doc.id, ...doc.data() });
            });
            return { success: true, data: packages };
        } catch (error) {
            console.error('è®€å–æ‚£è€…å¥—ç¥¨å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    async updatePatientPackage(packageId, packageData) {
        try {
            // ç§»é™¤ id å±¬æ€§ï¼Œé¿å…å°‡ id å¯«å…¥æ–‡ä»¶å…§å®¹
            let dataToWrite;
            try {
                const { id, ...rest } = packageData || {};
                dataToWrite = rest;
            } catch (_omitErr) {
                dataToWrite = packageData;
            }
            await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'patientPackages', packageId),
                {
                    ...dataToWrite,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                }
            );
            // æ›´æ–°æœ¬åœ°å¿«å–ä¸­çš„å¥—ç¥¨è³‡æ–™
            try {
                // å¦‚æžœ packageData ä¸­åŒ…å« patientIdï¼Œä¸” global çš„ patientPackagesCache æœ‰è©²ç—…äººçš„è³‡æ–™
                if (packageData && packageData.patientId && patientPackagesCache && Array.isArray(patientPackagesCache[packageData.patientId])) {
                    const pidStr = String(packageData.patientId);
                    patientPackagesCache[pidStr] = patientPackagesCache[pidStr].map(p => {
                        if (String(p.id) === String(packageId)) {
                            // å°‡æ›´æ–°å¾Œçš„è³‡æ–™åˆä½µåˆ°æœ¬åœ°å¿«å–ä¸­
                            return { ...p, ...packageData };
                        }
                        return p;
                    });
                    // åŒæ­¥æœ¬åœ°å¿«å–åˆ° localStorage
                    try {
                        const localKey = `patientPackages_${pidStr}`;
                        localStorage.setItem(localKey, JSON.stringify(patientPackagesCache[pidStr]));
                    } catch (e) {
                        console.warn('æ›´æ–°æœ¬åœ°æ‚£è€…å¥—ç¥¨è³‡æ–™å¤±æ•—:', e);
                    }
                }
            } catch (cacheErr) {
                console.warn('æ›´æ–°å¥—ç¥¨å¾Œæ›´æ–°æœ¬åœ°å¿«å–å¤±æ•—:', cacheErr);
            }
            // å¥—ç¥¨æ›´æ–°å¾Œï¼ŒåŒæ­¥æ›´æ–°å°æ‡‰ç—…äººçš„å¥—ç¥¨å½™ç¸½æ¬„ä½ã€‚
            try {
                if (packageData && packageData.patientId) {
                    await this.updatePatientPackageAggregates(packageData.patientId);
                }
            } catch (aggErr) {
                console.error('æ›´æ–°å¥—ç¥¨å¾Œæ›´æ–°å¥—ç¥¨å½™ç¸½æ¬„ä½å¤±æ•—:', aggErr);
            }
            return { success: true };
        } catch (error) {
            console.error('æ›´æ–°æ‚£è€…å¥—ç¥¨å¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * æ›´æ–°æŒ‡å®šç—…äººæ–‡ä»¶çš„å¥—ç¥¨å½™ç¸½æ¬„ä½ã€‚
     * å½™ç¸½æ¬„ä½åŒ…æ‹¬ï¼š
     * - packageActiveCountï¼šç•¶å‰ä»æœ‰å‰©é¤˜æ¬¡æ•¸çš„å¥—ç¥¨æ•¸é‡
     * - packageRemainingUsesï¼šç•¶å‰æ‰€æœ‰æœ‰æ•ˆå¥—ç¥¨å‰©é¤˜æ¬¡æ•¸ä¹‹å’Œ
     * æ­¤å‡½å¼åœ¨æ·»åŠ æˆ–æ›´æ–°å¥—ç¥¨å¾Œå‘¼å«ï¼Œç”¨æ–¼åŽ»æ­£è¦åŒ–åŒ…å¥—ç¥¨è³‡æ–™ï¼Œ
     * é¿å…åœ¨é¡¯ç¤ºç—…äººåˆ—è¡¨æ™‚åè¦†æŸ¥è©¢ patientPackagesã€‚
     * è‹¥æŸ¥è©¢ getCountFromServer å¤±æ•—ï¼Œå°‡å›žé€€è‡³è®€å–æ–‡ä»¶æ•¸é‡ä¸¦çµ±è¨ˆã€‚
     *
     * @param {string} patientId ç—…äºº ID
     * @returns {Promise<{success: boolean, error?: string}>}
     */
    async updatePatientPackageAggregates(patientId) {
        // å¦‚æžœè³‡æ–™ç®¡ç†å™¨å°šæœªæº–å‚™å¥½ï¼Œå‰‡ç•¥éŽæ›´æ–°
        if (!this.isReady) {
            return { success: false, error: 'Data manager not ready' };
        }
        try {
            // æ§‹å»ºæŸ¥è©¢ï¼šç¯©é¸æ­¤ç—…äººçš„å¥—ç¥¨ä¸”å‰©é¤˜æ¬¡æ•¸å¤§æ–¼ 0
            const packagesCollection = window.firebase.collection(window.firebase.db, 'patientPackages');
            const activeQuery = window.firebase.firestoreQuery(
                packagesCollection,
                window.firebase.where('patientId', '==', patientId),
                window.firebase.where('remainingUses', '>', 0)
            );
            // ä½¿ç”¨å–®æ¬¡ getDocs å–å¾—æ‰€æœ‰æœ‰æ•ˆå¥—ç¥¨ï¼Œè¨ˆç®—æ•¸é‡åŠå‰©é¤˜æ¬¡æ•¸
            let activeCount = 0;
            let totalRemainingUses = 0;
            try {
                const snap = await window.firebase.getDocs(activeQuery);
                activeCount = snap.size;
                snap.forEach((docSnap) => {
                    const d = docSnap.data();
                    if (d && typeof d.remainingUses === 'number') {
                        totalRemainingUses += d.remainingUses;
                    }
                });
            } catch (err) {
                console.warn('å–å¾—æœ‰æ•ˆå¥—ç¥¨è³‡æ–™å¤±æ•—:', err);
                activeCount = 0;
                totalRemainingUses = 0;
            }
            // æ›´æ–°ç—…äººæ–‡ä»¶ä¸­çš„å½™ç¸½æ¬„ä½
            try {
                const patientRef = window.firebase.doc(window.firebase.db, 'patients', patientId);
                await window.firebase.updateDoc(patientRef, {
                    packageActiveCount: activeCount,
                    packageRemainingUses: totalRemainingUses,
                    updatedAt: new Date(),
                    updatedBy: currentUser || 'system'
                });
            } catch (updateErr) {
                console.error('æ›´æ–°ç—…äººå¥—ç¥¨å½™ç¸½æ¬„ä½å¤±æ•—:', updateErr);
                return { success: false, error: updateErr.message };
            }
            return { success: true };
        } catch (err) {
            console.error('æ›´æ–°æ‚£è€…å¥—ç¥¨å½™ç¸½æ¬„ä½éŒ¯èª¤:', err);
            return { success: false, error: err.message };
        }
    }

    /**
     * æ–°å¢žä¸€ç­†å•è¨ºè³‡æ–™ã€‚
     * æ­¤æ–¹æ³•ä¸»è¦ç”¨æ–¼å¾Œç«¯æˆ–å…¶ä»–ç®¡ç†ä»‹é¢ï¼Œå¦‚åœ¨å•è¨ºè¡¨å–®é é¢å¯ç›´æŽ¥ä½¿ç”¨ Firebase APIã€‚
     *
     * @param {string} patientName ç—…äººå§“å
     * @param {Object} data å•è¨ºè³‡æ–™å…§å®¹
     * @returns {Promise<{success: boolean, id?: string, error?: string}>}
     */
    async addInquiryRecord(patientName, data) {
        if (!this.isReady) {
            showToast('æ•¸æ“šç®¡ç†å™¨å°šæœªæº–å‚™å°±ç·’', 'error');
            return { success: false };
        }
        try {
            const now = new Date();
            const expireDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // 24 å°æ™‚å¾ŒéŽæœŸ
            const docRef = await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'inquiries'),
                {
                    patientName: patientName,
                    data: data,
                    createdAt: now,
                    expireAt: expireDate
                }
            );
            return { success: true, id: docRef.id };
        } catch (error) {
            console.error('æ·»åŠ å•è¨ºè³‡æ–™å¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * è®€å–æŒ‡å®šç—…äººå§“åçš„å•è¨ºè³‡æ–™ã€‚
     * åƒ…è¿”å›žå°šæœªéŽæœŸçš„è³‡æ–™ï¼Œä¸¦ä¾ç…§å‰µå»ºæ™‚é–“é™åºæŽ’åˆ—ã€‚
     *
     * @param {string} patientName ç—…äººå§“å
     * @returns {Promise<{success: boolean, data: Array}>}
     */
    async getInquiryRecords(patientName) {
        if (!this.isReady) return { success: false, data: [] };
        try {
            let baseRef = window.firebase.collection(window.firebase.db, 'inquiries');
            // è‹¥æœ‰æä¾› patientNameï¼Œå‰‡ä½¿ç”¨ where æ¢ä»¶
            let q;
            if (patientName) {
                q = window.firebase.firestoreQuery(
                    baseRef,
                    window.firebase.where('patientName', '==', patientName),
                    window.firebase.orderBy('createdAt', 'desc')
                );
            } else {
                q = window.firebase.firestoreQuery(baseRef, window.firebase.orderBy('createdAt', 'desc'));
            }
            const snapshot = await window.firebase.getDocs(q);
            const now = new Date();
            const records = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                let expireDate = null;
                if (data.expireAt) {
                    if (data.expireAt.seconds !== undefined) {
                        expireDate = new Date(data.expireAt.seconds * 1000);
                    } else {
                        expireDate = new Date(data.expireAt);
                    }
                }
                // è‹¥ç„¡ expireAt æˆ–æœªéŽæœŸå‰‡åŠ å…¥
                if (!expireDate || expireDate >= now) {
                    records.push({ id: doc.id, ...data });
                }
            });
            return { success: true, data: records };
        } catch (error) {
            console.error('è®€å–å•è¨ºè³‡æ–™å¤±æ•—:', error);
            return { success: false, data: [] };
        }
    }

    /**
     * åˆªé™¤æŒ‡å®šå•è¨ºè³‡æ–™ã€‚
     *
     * @param {string} inquiryId å•è¨ºç´€éŒ„ ID
     */
    async deleteInquiryRecord(inquiryId) {
        try {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'inquiries', inquiryId)
            );
            return { success: true };
        } catch (error) {
            console.error('åˆªé™¤å•è¨ºè³‡æ–™å¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * æ¸…é™¤éŽæœŸçš„å•è¨ºè³‡æ–™ã€‚
     *
     * æ­¤å‡½å¼æœƒéæ­· `inquiries` é›†åˆï¼Œä¸¦åˆªé™¤é‚£äº›
     * `createdAt` ç™¼ç”Ÿåœ¨ä»Šæ—¥ 00:00 ä¹‹å‰ï¼ˆå³æ˜¨å¤©æˆ–æ›´æ—©ï¼‰çš„å•è¨ºç´€éŒ„ã€‚
     * è‹¥æŸç­†è¨˜éŒ„ç¼ºå°‘ `createdAt` æ¬„ä½ï¼Œå‰‡æœƒæ”¹ç”¨ `expireAt` ä½œç‚ºåˆ¤æ–·ä¾æ“šã€‚
     * å› ç‚ºç³»çµ±è¨­è¨ˆèˆ‡ Realtime Database çš„æŽ›è™Ÿæ¸…ç†é‚è¼¯ä¸€è‡´ï¼Œ
     * åªä¿ç•™ä»Šå¤©åŠæœªä¾†çš„è³‡æ–™ï¼Œæ‰€æœ‰èˆŠè³‡æ–™å°‡è¢«ç§»é™¤ã€‚
     *
     * @returns {Promise<{success: boolean, deletedCount?: number}>}
     */
    async clearOldInquiries() {
        if (!this.isReady) return { success: false };
        try {
            const now = new Date();
            // è¨ˆç®—ä»Šæ—¥å‡Œæ™¨æ™‚é–“ï¼ˆæœ¬åœ°æ™‚å€ï¼‰ã€‚ä»»ä½•ç™¼ç”Ÿåœ¨æ­¤æ™‚é–“ä¹‹å‰çš„ç´€éŒ„å°‡è¢«è¦–ç‚ºéŽæœŸã€‚
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const inquiriesRef = window.firebase.collection(window.firebase.db, 'inquiries');

            // å„²å­˜å¾…åˆªé™¤æ–‡ä»¶çš„ IDï¼Œé¿å…é‡è¤‡è™•ç†
            const idsToDelete = new Set();
            const docsToDelete = [];

            /*
             * Firestore æ”¯æ´æ¢ä»¶æŸ¥è©¢ã€‚å¦‚æžœ Firebase æä¾› or æŸ¥è©¢ï¼Œæˆ‘å€‘åªåŸ·è¡Œä¸€æ¬¡æŸ¥è©¢ï¼Œ
             * ä»¥ createdAt æˆ– expireAt æ—©æ–¼ä»Šæ—¥å‡Œæ™¨çš„æ–‡ä»¶ä½œç‚ºåˆªé™¤å°è±¡ï¼Œæ¸›å°‘è®€å–æ¬¡æ•¸ã€‚
             * è‹¥ç’°å¢ƒä¸­ä¸æ”¯æ´ or æŸ¥è©¢ï¼Œå°‡å›žé€€åˆ°åˆ†åˆ¥æŸ¥è©¢ createdAt èˆ‡ expireAt çš„æ–¹å¼ã€‚
             */
            try {
                let fetchedDocs = [];
                if (window.firebase && typeof window.firebase.or === 'function') {
                    // ä½¿ç”¨ or æ¢ä»¶ä¸€æ¬¡æŸ¥è©¢å…©ç¨®éŽæœŸæ¢ä»¶
                    const combinedQuery = window.firebase.firestoreQuery(
                        inquiriesRef,
                        window.firebase.or(
                            window.firebase.where('createdAt', '<', startOfToday),
                            window.firebase.where('expireAt', '<', startOfToday)
                        )
                    );
                    const snapshot = await window.firebase.getDocs(combinedQuery);
                    snapshot.forEach((doc) => {
                        fetchedDocs.push(doc);
                    });
                } else {
                    // ç’°å¢ƒä¸æ”¯æ´ orï¼Œå›žé€€è‡³åŽŸæœ¬çš„å…©æ¬¡æŸ¥è©¢
                    try {
                        const qCreated = window.firebase.firestoreQuery(
                            inquiriesRef,
                            window.firebase.where('createdAt', '<', startOfToday)
                        );
                        const snapshotCreated = await window.firebase.getDocs(qCreated);
                        snapshotCreated.forEach((doc) => {
                            fetchedDocs.push(doc);
                        });
                    } catch (err) {
                        console.warn('æŸ¥è©¢éŽæœŸ createdAt å•è¨ºè³‡æ–™å¤±æ•—:', err);
                    }
                    try {
                        const qExpire = window.firebase.firestoreQuery(
                            inquiriesRef,
                            window.firebase.where('expireAt', '<', startOfToday)
                        );
                        const snapshotExpire = await window.firebase.getDocs(qExpire);
                        snapshotExpire.forEach((doc) => {
                            fetchedDocs.push(doc);
                        });
                    } catch (err) {
                        console.warn('æŸ¥è©¢éŽæœŸ expireAt å•è¨ºè³‡æ–™å¤±æ•—:', err);
                    }
                }
                fetchedDocs.forEach((doc) => {
                    docsToDelete.push(doc);
                });
            } catch (err) {
                console.warn('æŸ¥è©¢éŽæœŸå•è¨ºè³‡æ–™å¤±æ•—:', err);
            }

            const deletions = [];
            // é©—è­‰ä¸¦å½™æ•´éœ€è¦åˆªé™¤çš„æ–‡ä»¶
            docsToDelete.forEach((doc) => {
                // é¿å…åŒä¸€æ–‡ä»¶è¢«é‡è¤‡åŠ å…¥
                if (idsToDelete.has(doc.id)) return;
                const data = doc.data();
                let createdDate = null;
                if (data.createdAt) {
                    if (data.createdAt.seconds !== undefined) {
                        createdDate = new Date(data.createdAt.seconds * 1000);
                    } else {
                        createdDate = new Date(data.createdAt);
                    }
                }
                let targetDate = createdDate;
                if (!targetDate && data.expireAt) {
                    if (data.expireAt.seconds !== undefined) {
                        targetDate = new Date(data.expireAt.seconds * 1000);
                    } else {
                        targetDate = new Date(data.expireAt);
                    }
                }
                // å¦‚æžœç›®æ¨™æ—¥æœŸå­˜åœ¨ä¸”æ—©æ–¼ä»Šæ—¥å‡Œæ™¨ï¼Œå‰‡åŠ å…¥åˆªé™¤ä½‡åˆ—
                if (targetDate && targetDate < startOfToday) {
                    idsToDelete.add(doc.id);
                    deletions.push(
                        window.firebase.deleteDoc(
                            window.firebase.doc(window.firebase.db, 'inquiries', doc.id)
                        )
                    );
                }
            });

            let count = 0;
            if (deletions.length > 0) {
                await Promise.all(deletions);
                count = deletions.length;
            }
            return { success: true, deletedCount: count };
        } catch (error) {
            console.error('æ¸…é™¤éŽæœŸå•è¨ºè³‡æ–™å¤±æ•—:', error);
            return { success: false, error: error.message };
        }
    }
}

// åˆå§‹åŒ–æ•¸æ“šç®¡ç†å™¨
let firebaseDataManager;
window.addEventListener('load', async () => {
    // åªåˆå§‹åŒ– FirebaseDataManagerï¼Œé¿å…åœ¨ä½¿ç”¨è€…ç™»å…¥å‰è¼‰å…¥å¤§é‡è³‡æ–™ã€‚
    firebaseDataManager = new FirebaseDataManager();
    window.firebaseDataManager = firebaseDataManager; // å…¨åŸŸä½¿ç”¨
    // ç­‰å¾…ç®¡ç†å™¨æº–å‚™å¥½å†ç¹¼çºŒï¼Œä½†ä¸è®€å–è³‡æ–™ï¼Œåƒ…ç¢ºä¿å¾ŒçºŒå‘¼å«ä¸å¤±æ•—ã€‚
    while (!firebaseDataManager.isReady) {
        await new Promise(resolve => setTimeout(resolve, 100));
    }

    // ç§»é™¤ç³»çµ±è¼‰å…¥æ™‚æ¸…é™¤éŽæœŸå•è¨ºè³‡æ–™çš„é‚è¼¯ï¼Œæ”¹ç‚ºåœ¨ä½¿ç”¨è€…ç™»å…¥å¾ŒåŸ·è¡Œã€‚
    // é€™æ˜¯ç‚ºäº†é¿å…åœ¨æœªæŽˆæ¬Šç‹€æ…‹ä¸‹å‘¼å«åˆªé™¤è³‡æ–™è€Œå°Žè‡´æ¬Šé™éŒ¯èª¤ã€‚

    // è¨­ç½®å®šæ™‚ä»»å‹™ï¼šæ¯æ—¥è‡ªå‹•æ¸…ç†ä¸€æ¬¡éŽæœŸçš„å•è¨ºè³‡æ–™ï¼Œä½†åƒ…åœ¨ä½¿ç”¨è€…å·²ç™»å…¥æ™‚åŸ·è¡Œ
    try {
        const dayMs = 24 * 60 * 60 * 1000;
        setInterval(() => {
            try {
                // ç¢ºèªä½¿ç”¨è€…å·²ç™»å…¥ï¼ˆé€éŽ Firebase auth æˆ–æœ¬åœ° currentUserDataï¼‰
                const userLoggedIn = (window.firebase && window.firebase.auth && window.firebase.auth.currentUser) ||
                                     (typeof currentUserData !== 'undefined' && currentUserData);
                if (userLoggedIn && firebaseDataManager && typeof firebaseDataManager.clearOldInquiries === 'function') {
                    firebaseDataManager.clearOldInquiries().catch(err => {
                        console.error('å®šæ™‚æ¸…ç†å•è¨ºè³‡æ–™å¤±æ•—:', err);
                    });
                }
            } catch (e) {
                console.error('å®šæ™‚èª¿ç”¨æ¸…ç†å•è¨ºè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
            }
        }, dayMs);
    } catch (_e) {
        // è‹¥ç„¡æ³•è¨­ç½®å®šæ™‚ä»»å‹™å‰‡å¿½ç•¥
    }
});
        
// åˆå§‹åŒ–ç³»çµ±
document.addEventListener('DOMContentLoaded', function() {
    
    // ç³»çµ±ç®¡ç†ç›¸é—œåˆå§‹åŒ–ç§»è‡³ systemmanagement.jsï¼Œé¿å…åœ¨æ­¤è™•éŽæ—©èª¿ç”¨

    // ä¿æŒæ‰€æœ‰ä¸­è—¥æåŠæ–¹åŠ‘æ¬„ä½å¯è¦‹ï¼ˆåŒ…å«æ€§å‘³ã€æ­¸ç¶“ã€ä¸»æ²»ã€ç”¨æ³•ï¼‰
    
    
    // è‡ªå‹•èšç„¦åˆ°é›»å­éƒµä»¶è¼¸å…¥æ¡†
    const usernameInput = document.getElementById('mainLoginUsername');
    if (usernameInput) {
        setTimeout(() => {
            usernameInput.focus();
        }, 100);
    }

    // ä»¥ä¸‹äº‹ä»¶ç¶å®šå·²å¾žå…ˆå‰é‡è¤‡çš„ DOMContentLoaded äº‹ä»¶åˆä½µè‡³æ­¤è™•ã€‚
    // é‡å°æ”¶è²»é¡žåˆ¥çš„ã€Œå¥—ç¥¨ã€é¸é …ï¼Œåˆ‡æ›å°æ‡‰çš„æ¬„ä½é¡¯ç¤ºã€‚
    const categorySelect = document.getElementById('billingItemCategory');
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            const isPackage = this.value === 'package';
            const pf = document.getElementById('packageFields');
            if (pf) {
                pf.classList.toggle('hidden', !isPackage);
            }
        });
    }

    // ç—…äººç®¡ç†æœå°‹æ¬„ä½ï¼šè¼¸å…¥æ™‚é‡æ–°è¼‰å…¥ç—…äººåˆ—è¡¨ï¼ˆåŠ å…¥é˜²æŠ–è™•ç†ï¼‰
    const searchInput = document.getElementById('searchPatient');
    if (searchInput) {
        // å»ºç«‹é˜²æŠ–å‡½å¼ï¼Œæ–¼è¼¸å…¥å¾Œå»¶é²ä¸€æ®µæ™‚é–“å†è¼‰å…¥ç—…äººåˆ—è¡¨
        const debouncedLoadPatientList = debounce(() => {
            try {
                // æœå°‹æ™‚é‡ç½®åˆ†é è‡³ç¬¬ä¸€é 
                paginationSettings.patientList.currentPage = 1;
                loadPatientList();
            } catch (_err) {
                console.error('è¼‰å…¥ç—…äººåˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', _err);
            }
        }, 300);
        searchInput.addEventListener('input', debouncedLoadPatientList);
    }

    // æŽ›è™Ÿå½ˆçª—çš„ç—…äººæœå°‹æ¬„ä½ï¼šåŠ å…¥é˜²æŠ–è™•ç†
    const patientSearchInput = document.getElementById('patientSearchInput');
    if (patientSearchInput) {
        // ç§»é™¤ HTML ä¸­è¨­å®šçš„ oninput ä»¥é¿å…é‡è¤‡è§¸ç™¼
        try {
            patientSearchInput.removeAttribute('oninput');
        } catch (_e) {
            // è‹¥ç§»é™¤å¤±æ•—å‰‡å¿½ç•¥
        }
        const debouncedSearchPatients = debounce(() => {
            try {
                if (typeof searchPatientsForRegistration === 'function') {
                    searchPatientsForRegistration();
                }
            } catch (_err) {
                console.error('æœå°‹æŽ›è™Ÿç—…äººæ™‚ç™¼ç”ŸéŒ¯èª¤:', _err);
            }
        }, 300);
        patientSearchInput.addEventListener('input', debouncedSearchPatients);
        // åŠ å…¥éµç›¤äº‹ä»¶è™•ç†ï¼Œæ”¯æ´æ–¹å‘éµå°Žèˆªæœå°‹çµæžœåŠ Enter å¿«æ·æŽ›è™Ÿ
        patientSearchInput.addEventListener('keydown', handlePatientSearchKeyDown);
    }

    // æŽ›è™Ÿæ™‚é¸æ“‡é†«å¸«çš„ä¸‹æ‹‰é¸å–®ï¼šæŒ‰ä¸‹ Enter æ™‚ç›´æŽ¥ç¢ºèªæŽ›è™Ÿ
    const appointmentDoctorSelect = document.getElementById('appointmentDoctor');
    if (appointmentDoctorSelect) {
        // é¿å…é‡è¤‡ç¶å®šäº‹ä»¶ï¼Œå¯é€éŽè‡ªå®šç¾©å±¬æ€§åˆ¤æ–·æ˜¯å¦å·²ç¶å®š
        if (!appointmentDoctorSelect.dataset.bindEnterListener) {
            appointmentDoctorSelect.addEventListener('keydown', function (ev) {
                if (ev && ev.key === 'Enter') {
                    ev.preventDefault();
                    try {
                        if (typeof confirmRegistration === 'function') {
                            confirmRegistration();
                        }
                    } catch (_err) {
                        console.error('å¾žé†«å¸«ä¸‹æ‹‰é¸å–®æŒ‰ Enter ç¢ºèªæŽ›è™Ÿå¤±æ•—:', _err);
                    }
                }
            });
            appointmentDoctorSelect.dataset.bindEnterListener = 'true';
        }
    }

    // æŽ›è™Ÿæ™‚é–“è¼¸å…¥æ¬„åŠå…¶ä»–æ¬„ä½ï¼šæŒ‰ä¸‹ Enter æ™‚ç›´æŽ¥ç¢ºèªæŽ›è™Ÿ
    // æ—¥æœŸæ™‚é–“è¼¸å…¥æ¬„ (datetime-local)
    const appointmentDateTimeInput = document.getElementById('appointmentDateTime');
    if (appointmentDateTimeInput) {
        if (!appointmentDateTimeInput.dataset.bindEnterListener) {
            appointmentDateTimeInput.addEventListener('keydown', function(ev) {
                if (ev && ev.key === 'Enter') {
                    ev.preventDefault();
                    try {
                        if (typeof confirmRegistration === 'function') {
                            confirmRegistration();
                        }
                    } catch (err) {
                        console.error('æŒ‰ Enter ç¢ºèªæŽ›è™Ÿï¼ˆæ™‚é–“è¼¸å…¥ï¼‰å¤±æ•—:', err);
                    }
                }
            });
            appointmentDateTimeInput.dataset.bindEnterListener = 'true';
        }
    }
    // å•è¨ºè³‡æ–™ä¸‹æ‹‰é¸å–®
    const inquirySelectInput = document.getElementById('inquirySelect');
    if (inquirySelectInput) {
        if (!inquirySelectInput.dataset.bindEnterListener) {
            inquirySelectInput.addEventListener('keydown', function(ev) {
                if (ev && ev.key === 'Enter') {
                    ev.preventDefault();
                    try {
                        if (typeof confirmRegistration === 'function') {
                            confirmRegistration();
                        }
                    } catch (err) {
                        console.error('æŒ‰ Enter ç¢ºèªæŽ›è™Ÿï¼ˆå•è¨ºé¸æ“‡ï¼‰å¤±æ•—:', err);
                    }
                }
            });
            inquirySelectInput.dataset.bindEnterListener = 'true';
        }
    }
    // ä¸»è¨´ç—‡ç‹€è¼¸å…¥æ¬„ (textarea)
    const chiefComplaintInput = document.getElementById('quickChiefComplaint');
    if (chiefComplaintInput) {
        if (!chiefComplaintInput.dataset.bindEnterListener) {
            chiefComplaintInput.addEventListener('keydown', function(ev) {
                if (ev && ev.key === 'Enter') {
                    ev.preventDefault();
                    try {
                        if (typeof confirmRegistration === 'function') {
                            confirmRegistration();
                        }
                    } catch (err) {
                        console.error('æŒ‰ Enter ç¢ºèªæŽ›è™Ÿï¼ˆä¸»è¨´ç—‡ç‹€ï¼‰å¤±æ•—:', err);
                    }
                }
            });
            chiefComplaintInput.dataset.bindEnterListener = 'true';
        }
    }

    // ç•¶é¸æ“‡å•è¨ºè³‡æ–™æ™‚ï¼Œè‡ªå‹•éš±è—ä¸»è¨´ç—‡ç‹€è¼¸å…¥æ¬„ä½ã€‚
    // ç”±æ–¼ä¸»è¨´æ¬„ä½èˆ‡å…¶æ¨™ç±¤ä½æ–¼åŒä¸€çˆ¶å±¤ <div>ï¼Œä½¿ç”¨ parentElement/closest('div')
    // å°‡å®¹å™¨åˆ‡æ› displayã€‚ç•¶å•è¨ºè³‡æ–™æœªé¸æ“‡æ™‚å‰‡é¡¯ç¤ºä¸»è¨´æ¬„ä½ã€‚
    const inquirySelectElem = document.getElementById('inquirySelect');
    const quickChiefComplaintElem = document.getElementById('quickChiefComplaint');
    if (inquirySelectElem && quickChiefComplaintElem) {
        // å˜—è©¦å–å¾—æœ€è¿‘çš„ div ä½œç‚ºå®¹å™¨ï¼Œå¦‚æžœæ‰¾ä¸åˆ°å‰‡é€€è€Œæ±‚å…¶æ¬¡ä½¿ç”¨ parentElement
        const complaintContainer = quickChiefComplaintElem.closest('div') || quickChiefComplaintElem.parentElement;
        function toggleChiefComplaintVisibility() {
            try {
                // æ ¹æ“šå•è¨ºä¸‹æ‹‰é¸æ“‡å€¼æ±ºå®šé¡¯ç¤ºæˆ–éš±è—
                if (inquirySelectElem.value && inquirySelectElem.value !== '') {
                    // å·²é¸æ“‡å•è¨ºè³‡æ–™ï¼Œéš±è—ä¸»è¨´æ¬„ä½
                    complaintContainer.style.display = 'none';
                } else {
                    // ç„¡å•è¨ºè³‡æ–™æˆ–æ¸…ç©ºé¸æ“‡ï¼Œé¡¯ç¤ºä¸»è¨´æ¬„ä½
                    complaintContainer.style.display = '';
                }
            } catch (_e) {
                // è‹¥å®¹å™¨ä¸å­˜åœ¨æˆ–é‡åˆ°éŒ¯èª¤å‰‡å¿½ç•¥ï¼Œé¿å…å½±éŸ¿å…¶ä»–é‚è¼¯
            }
        }
        // ç¶å®šä¸‹æ‹‰è®Šæ›´äº‹ä»¶
        inquirySelectElem.addEventListener('change', toggleChiefComplaintVisibility);
        // å°‡å‡½å¼æŽ›åˆ°å…¨åŸŸï¼Œä¾›å…¶ä»–å‡½å¼ï¼ˆä¾‹å¦‚æ¸…ç©ºè¡¨å–®æ™‚ï¼‰å‘¼å«
        window.toggleChiefComplaintVisibility = toggleChiefComplaintVisibility;
        // æ ¹æ“šé è¨­å€¼åˆå§‹åŒ–é¡¯ç¤ºç‹€æ…‹
        toggleChiefComplaintVisibility();
    }

    /*
     * ç™»å…¥é èˆ‡å´é‚Šæ¬„äº‹ä»¶ç¶å®š
     * ç‚ºäº†é¿å…åœ¨ HTML ä¸­ä½¿ç”¨ inline äº‹ä»¶è™•ç†å™¨ï¼Œæˆ‘å€‘åœ¨ DOMContentLoaded ä¹‹å¾Œ
     * ä½¿ç”¨ addEventListener ç¶å®šå°æ‡‰çš„äº‹ä»¶ã€‚é€™äº›å…ƒç´ åœ¨ç³»çµ±å„è™•ä½¿ç”¨ï¼Œé€éŽ
     * id æˆ– data-* å±¬æ€§å–å¾—å¾Œç¶å®šäº‹ä»¶è™•ç†å‡½å¼ã€‚
     */
    try {
        // ç™»å…¥æŒ‰éˆ•ï¼šé»žæ“Šè§¸ç™¼ç™»å…¥
        const loginBtn = document.getElementById('loginButton');
        if (loginBtn) {
            loginBtn.addEventListener('click', function () {
                try {
                    attemptMainLogin();
                } catch (e) {
                    console.error('ç™»å…¥æŒ‰éˆ•äº‹ä»¶éŒ¯èª¤:', e);
                }
            });
        }

        // ç™»å…¥é è¼¸å…¥æ¡†ï¼šæŒ‰ä¸‹ Enter éµè§¸ç™¼ç™»å…¥
        const loginEmailInput = document.querySelector('[data-login-email]');
        const loginPasswordInput = document.querySelector('[data-login-password]');
        const loginKeyListener = function (ev) {
            if (ev && ev.key === 'Enter') {
                try {
                    attemptMainLogin();
                } catch (e) {
                    console.error('ç™»å…¥è¼¸å…¥æ¡†éµç›¤äº‹ä»¶éŒ¯èª¤:', e);
                }
            }
        };
        if (loginEmailInput) {
            loginEmailInput.addEventListener('keypress', loginKeyListener);
        }
        if (loginPasswordInput) {
            loginPasswordInput.addEventListener('keypress', loginKeyListener);
        }

        // å´é‚Šæ¬„é–‹é—œæŒ‰éˆ•èˆ‡é®ç½©ï¼šé»žæ“Šæ™‚åˆ‡æ›å´é‚Šæ¬„ç‹€æ…‹
        const openSidebarBtn = document.getElementById('openSidebarButton');
        if (openSidebarBtn) {
            openSidebarBtn.addEventListener('click', function () {
                try {
                    toggleSidebar();
                } catch (e) {
                    console.error('é–‹å•Ÿå´é‚Šæ¬„æŒ‰éˆ•äº‹ä»¶éŒ¯èª¤:', e);
                }
            });
        }
        const closeSidebarBtn = document.getElementById('closeSidebarButton');
        if (closeSidebarBtn) {
            closeSidebarBtn.addEventListener('click', function () {
                try {
                    toggleSidebar();
                } catch (e) {
                    console.error('é—œé–‰å´é‚Šæ¬„æŒ‰éˆ•äº‹ä»¶éŒ¯èª¤:', e);
                }
            });
        }
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', function () {
                try {
                    toggleSidebar();
                } catch (e) {
                    console.error('é»žæ“Šé®ç½©éŒ¯èª¤:', e);
                }
            });
        }

        // ç™»å‡ºæŒ‰éˆ•ï¼ˆé ‚éƒ¨èˆ‡å´é‚Šæ¬„ï¼‰ï¼šé»žæ“Šå¾Œèª¿ç”¨ logout
        const logoutBtn = document.getElementById('logoutButton');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function () {
                try {
                    logout();
                } catch (e) {
                    console.error('é ‚éƒ¨ç™»å‡ºæŒ‰éˆ•äº‹ä»¶éŒ¯èª¤:', e);
                }
            });
        }
        const sidebarLogoutBtn = document.getElementById('sidebarLogoutButton');
        if (sidebarLogoutBtn) {
            sidebarLogoutBtn.addEventListener('click', function () {
                try {
                    logout();
                } catch (e) {
                    console.error('å´é‚Šæ¬„ç™»å‡ºæŒ‰éˆ•äº‹ä»¶éŒ¯èª¤:', e);
                }
            });
        }

        // ç—…äººè³‡æ–™ç®¡ç†ï¼šæ–°å¢ž/éš±è—/å„²å­˜äº‹ä»¶ç¶å®š
        // æ–°å¢žç—…äººæŒ‰éˆ•
        const showAddPatientBtn = document.getElementById('showAddPatientButton');
        if (showAddPatientBtn) {
            showAddPatientBtn.addEventListener('click', function () {
                try {
                    showAddPatientForm();
                } catch (e) {
                    console.error('é¡¯ç¤ºæ–°å¢žç—…äººè¡¨å–®éŒ¯èª¤:', e);
                }
            });
        }
        // é—œé–‰æ–°å¢žç—…äººè¡¨å–®ï¼ˆæ¨™é¡Œåˆ—å‰è™Ÿï¼‰
        const hideAddPatientBtnTop = document.getElementById('hideAddPatientButtonTop');
        if (hideAddPatientBtnTop) {
            hideAddPatientBtnTop.addEventListener('click', function () {
                try {
                    hideAddPatientForm();
                } catch (e) {
                    console.error('é—œé–‰æ–°å¢žç—…äººè¡¨å–®ï¼ˆæ¨™é¡Œï¼‰éŒ¯èª¤:', e);
                }
            });
        }
        // å–æ¶ˆæŒ‰éˆ•ï¼šéš±è—æ–°å¢žç—…äººè¡¨å–®
        const cancelAddPatientBtn = document.getElementById('cancelAddPatientButton');
        if (cancelAddPatientBtn) {
            cancelAddPatientBtn.addEventListener('click', function () {
                try {
                    hideAddPatientForm();
                } catch (e) {
                    console.error('å–æ¶ˆæ–°å¢žç—…äººè¡¨å–®éŒ¯èª¤:', e);
                }
            });
        }
        // å„²å­˜ç—…äººæŒ‰éˆ•ï¼šæäº¤è¡¨å–®
        const savePatientBtn = document.getElementById('savePatientButton');
        if (savePatientBtn) {
            savePatientBtn.addEventListener('click', function () {
                try {
                    savePatient();
                } catch (e) {
                    console.error('å„²å­˜ç—…äººè³‡æ–™éŒ¯èª¤:', e);
                }
            });
        }

        /**
         * ä¸€æ¬¡æ€§ç§»é™¤é é¢ä¸Šæ‰€æœ‰å…§åµŒçš„ onclick/onchange äº‹ä»¶è™•ç†å™¨ï¼Œæ”¹ä»¥é€éŽ
         * addEventListener ç¶å®šã€‚é€™æ¨£å¯é¿å… HTML ä¸­çš„ inline äº‹ä»¶æ±¡æŸ“
         * å…¨åŸŸå‘½åç©ºé–“ï¼Œä¹Ÿæ–¹ä¾¿å¾ŒçºŒç¶­è­·èˆ‡é‡æ§‹ã€‚æ­¤é‚è¼¯å°‡åœ¨é é¢è¼‰å…¥æ™‚
         * æŽƒæå¸¶æœ‰ onclick æˆ– onchange å±¬æ€§çš„å…ƒç´ ï¼Œè§£æžå…¶ä¸­çš„å‡½å¼åç¨±
         * èˆ‡åƒæ•¸ï¼Œä¸¦ä»¥äº‹ä»¶å§”æ´¾çš„æ–¹å¼åœ¨ç›¸åŒå…ƒç´ ä¸Šç¶å®šå°æ‡‰çš„äº‹ä»¶è™•ç†
         * å‡½å¼ã€‚åŽŸå§‹çš„ onclick/onchange å±¬æ€§æœƒè¢«ç§»é™¤ï¼Œé¿å…é‡è¤‡åŸ·è¡Œã€‚
         */
        (function initInlineEventHandlers() {
            /**
             * å°‡å­—ä¸²å½¢å¼çš„åƒæ•¸åˆ—è¡¨è½‰æ›ç‚ºå¯¦éš›çš„å¼•æ•¸é™£åˆ—ã€‚
             * æ­¤å‡½å¼æœƒç‰¹åˆ¥è™•ç†å­—é¢å€¼ 'event' èˆ‡ 'this'ï¼š
             *   - 'event' æœƒæ›¿æ›ç‚ºè§¸ç™¼äº‹ä»¶çš„ç‰©ä»¶
             *   - 'this'  æœƒæ›¿æ›ç‚ºç¶å®šçš„ DOM å…ƒç´ 
             * å…¶é¤˜å­—ä¸²æœƒç›´æŽ¥ä»¥ JavaScript å­—é¢é‡è§£æžï¼ˆä¾‹å¦‚æ•¸å­—æˆ–å¸¶å¼•è™Ÿçš„å­—ä¸²ï¼‰ã€‚
             * @param {string} argsStr åŽŸå§‹åƒæ•¸å­—ä¸²ï¼Œä¾‹å¦‚ "-1, 'herbs'"
             * @param {Event} event äº‹ä»¶å°è±¡
             * @param {HTMLElement} el è§¸ç™¼äº‹ä»¶çš„å…ƒç´ 
             * @returns {Array} è§£æžå¾Œçš„å¼•æ•¸é™£åˆ—
             */
            function parseArgs(argsStr, event, el) {
                const trimmed = argsStr.trim();
                if (!trimmed) {
                    return [];
                }
                // å…ˆæ›¿æ› 'event' èˆ‡ 'this' ç‚ºç‰¹æ®Šæ¨™è¨˜ï¼Œé¿å…ç›´æŽ¥ eval è§£æžéŒ¯èª¤
                const replaced = trimmed
                    .replace(/\bevent\b/g, '__EVENT__')
                    .replace(/\bthis\b/g, '__THIS__');
                let args;
                try {
                    /*
                     * ä½¿ç”¨å‹•æ…‹å‡½å¼çš„æ–¹å¼ä¾†è§£æžåŒ…å« __EVENT__/__THIS__ æ¨™è¨˜çš„å¼•æ•¸å­—ä¸²ï¼Œ
                     * ä¸¦å°‡å¯¦éš›çš„ event èˆ‡å…ƒç´ ç‰©ä»¶ä½œç‚ºåƒæ•¸æ³¨å…¥ã€‚é€™æ¨£å°±å¯ä»¥æ­£ç¢ºè§£æž
                     * è¤‡é›œçš„å±¬æ€§å­˜å–è¡¨é”å¼ï¼ˆä¾‹å¦‚ __THIS__.files[0]ï¼‰ï¼Œé¿å…å°‡ __THIS__
                     * ç•¶ä½œå­—ä¸²è™•ç†å°Žè‡´ç„¡æ³•è®€å–å±¬æ€§ã€‚
                     */
                    const fn = new Function('__EVENT__', '__THIS__', 'return [' + replaced + '];');
                    args = fn(event, el);
                } catch (e) {
                    console.error('è§£æž inline äº‹ä»¶åƒæ•¸å¤±æ•—:', argsStr, e);
                    args = [];
                }
                // args ç¾åœ¨å·²ç¶“æ˜¯åŒ…å«æ­£ç¢ºå€¼çš„é™£åˆ—ï¼Œç„¡éœ€å†æ›¿æ›ç‰¹æ®Šæ¨™è¨˜
                return args;
            }

            /**
             * ç¶å®šæŒ‡å®šå±¬æ€§çš„ inline äº‹ä»¶è™•ç†å™¨ã€‚æ­¤å‡½å¼æœƒå¾žå…ƒç´ ä¸Šè®€å–
             * äº‹ä»¶å±¬æ€§ï¼ˆä¾‹å¦‚ onclick æˆ– onchangeï¼‰çš„å…§å®¹ä¸¦è§£æžå‡ºå‡½å¼
             * åç¨±èˆ‡åƒæ•¸ï¼Œå†é€éŽ addEventListener é‡æ–°ç¶å®šäº‹ä»¶ã€‚
             * @param {string} attrName å±¬æ€§åç¨±ï¼Œä¾‹å¦‚ 'onclick' æˆ– 'onchange'
             * @param {string} eventName å°æ‡‰çš„äº‹ä»¶åç¨±ï¼Œä¾‹å¦‚ 'click' æˆ– 'change'
             */
            function bindInlineHandlers(attrName, eventName) {
                const selector = '[' + attrName + ']';
                document.querySelectorAll(selector).forEach(function (el) {
                    const handlerCode = el.getAttribute(attrName);
                    if (!handlerCode) return;
                    // ç§»é™¤ inline å±¬æ€§ï¼Œé¿å…ç€è¦½å™¨åŽŸç”ŸåŸ·è¡Œ
                    el.removeAttribute(attrName);
                    el.addEventListener(eventName, function (event) {
                        try {
                            // åŒ¹é…é¡žä¼¼ "functionName(arg1, arg2)" çš„å­—ä¸²
                            const match = handlerCode.match(/^\s*([^(]+)\s*\((.*)\)\s*$/);
                            if (!match) {
                                return;
                            }
                            const fnName = match[1].trim();
                            const argsStr = match[2];
                            // è§£æžåƒæ•¸
                            const args = parseArgs(argsStr, event, el);
                            // è‹¥å‡½å¼åç¨±åŒ…å« "."ï¼Œä»£è¡¨å¯èƒ½ç‚ºæŸç‰©ä»¶çš„å±¬æ€§æˆ–æ–¹æ³•
                            if (fnName.indexOf('.') >= 0) {
                                const parts = fnName.split('.');
                                // è‹¥ç¬¬ä¸€æ®µæ˜¯ 'this'ï¼Œå‰‡å¾žå…ƒç´ æœ¬èº«å–ç”¨
                                let target;
                                if (parts[0] === 'this') {
                                    target = el;
                                    parts.shift();
                                } else {
                                    // å…¶é¤˜æ ¹æ“š window å°‹æ‰¾
                                    target = window[parts.shift()];
                                }
                                let prop;
                                while (parts.length > 1 && target) {
                                    prop = parts.shift();
                                    target = target[prop];
                                }
                                const methodName = parts.shift();
                                if (target && typeof target[methodName] === 'function') {
                                    target[methodName].apply(target, args);
                                }
                            } else {
                                // å¾žå…¨åŸŸ window å–ç”¨å‡½å¼
                                const fn = window[fnName];
                                if (typeof fn === 'function') {
                                    fn.apply(el, args);
                                }
                            }
                        } catch (err) {
                            console.error('åŸ·è¡Œ inline äº‹ä»¶è™•ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', handlerCode, err);
                        }
                    });
                });
            }

            // ç¶å®šæ‰€æœ‰ç¾æœ‰çš„ onclick èˆ‡ onchange äº‹ä»¶
            bindInlineHandlers('onclick', 'click');
            bindInlineHandlers('onchange', 'change');

            /**
             * ç›£è½ DOM è®Šæ›´ï¼Œå‹•æ…‹ç¶å®šå¾ŒçºŒæ–°å¢žçš„å…ƒç´ ä¸Šçš„ inline äº‹ä»¶ã€‚
             * æœ‰äº›æŒ‰éˆ•æœƒåœ¨åŸ·è¡ŒæœŸé–“å‹•æ…‹æ’å…¥ï¼ˆä¾‹å¦‚æœå°‹çµæžœåˆ—è¡¨ï¼‰ï¼Œè‹¥ä¸åœ¨æ­¤
             * ç›£è½ï¼Œå°‡æœƒå°Žè‡´å…§åµŒäº‹ä»¶ä»ç„¶å­˜åœ¨ã€‚é€éŽ MutationObserver ç›£
             * çœ‹æ–°å¢žçš„ç¯€é»žï¼Œä¸¦å°å…¶åŠå…¶å­å­«ç¯€é»žåŸ·è¡Œç›¸åŒçš„ç¶å®šé‚è¼¯ã€‚
             */
            const observer = new MutationObserver(function (mutationsList) {
                mutationsList.forEach(function (mutation) {
                    mutation.addedNodes.forEach(function (node) {
                        if (node.nodeType !== 1) return;
                        // å°æ–°å¢žç¯€é»žåŠå…¶å­å­«ç¯€é»žè™•ç†
                        [node, ...node.querySelectorAll('[onclick], [onchange]')].forEach(function (el) {
                            if (el.hasAttribute && el.hasAttribute('onclick')) {
                                const code = el.getAttribute('onclick');
                                el.removeAttribute('onclick');
                                // è‹¥å·²æœ‰äº‹ä»¶ç›£è½ï¼Œé¿å…é‡è¤‡ç¶å®šï¼ˆé€éŽ dataset æ¨™è¨˜ï¼‰
                                if (!el.dataset.inlineClickBound) {
                                    el.dataset.inlineClickBound = 'true';
                                    el.addEventListener('click', function (event) {
                                        try {
                                            const match = code.match(/^\s*([^(]+)\s*\((.*)\)\s*$/);
                                            if (!match) return;
                                            const fnName = match[1].trim();
                                            const argsStr = match[2];
                                            const args = parseArgs(argsStr, event, el);
                                            if (fnName.indexOf('.') >= 0) {
                                                const parts = fnName.split('.');
                                                let target;
                                                if (parts[0] === 'this') {
                                                    target = el;
                                                    parts.shift();
                                                } else {
                                                    target = window[parts.shift()];
                                                }
                                                let prop;
                                                while (parts.length > 1 && target) {
                                                    prop = parts.shift();
                                                    target = target[prop];
                                                }
                                                const methodName = parts.shift();
                                                if (target && typeof target[methodName] === 'function') {
                                                    target[methodName].apply(target, args);
                                                }
                                            } else {
                                                const fn = window[fnName];
                                                if (typeof fn === 'function') {
                                                    fn.apply(el, args);
                                                }
                                            }
                                        } catch (err) {
                                            console.error('åŸ·è¡Œå‹•æ…‹ inline äº‹ä»¶è™•ç†å™¨éŒ¯èª¤:', code, err);
                                        }
                                    });
                                }
                            }
                            if (el.hasAttribute && el.hasAttribute('onchange')) {
                                const code = el.getAttribute('onchange');
                                el.removeAttribute('onchange');
                                if (!el.dataset.inlineChangeBound) {
                                    el.dataset.inlineChangeBound = 'true';
                                    el.addEventListener('change', function (event) {
                                        try {
                                            const match = code.match(/^\s*([^(]+)\s*\((.*)\)\s*$/);
                                            if (!match) return;
                                            const fnName = match[1].trim();
                                            const argsStr = match[2];
                                            const args = parseArgs(argsStr, event, el);
                                            if (fnName.indexOf('.') >= 0) {
                                                const parts = fnName.split('.');
                                                let target;
                                                if (parts[0] === 'this') {
                                                    target = el;
                                                    parts.shift();
                                                } else {
                                                    target = window[parts.shift()];
                                                }
                                                let prop;
                                                while (parts.length > 1 && target) {
                                                    prop = parts.shift();
                                                    target = target[prop];
                                                }
                                                const methodName = parts.shift();
                                                if (target && typeof target[methodName] === 'function') {
                                                    target[methodName].apply(target, args);
                                                }
                                            } else {
                                                const fn = window[fnName];
                                                if (typeof fn === 'function') {
                                                    fn.apply(el, args);
                                                }
                                            }
                                        } catch (err) {
                                            console.error('åŸ·è¡Œå‹•æ…‹ inline äº‹ä»¶è™•ç†å™¨éŒ¯èª¤:', code, err);
                                        }
                                    });
                                }
                            }
                        });
                    });
                });
            });
            observer.observe(document.body, { childList: true, subtree: true });
        })();
    } catch (e) {
        console.error('ç¶å®šç™»å…¥èˆ‡å´é‚Šæ¬„äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
    }
});

// ç—…æ­·ç®¡ç†ç›¸é—œå‡½å¼èˆ‡è®Šæ•¸
// å„²å­˜æ‰€æœ‰ç—…æ­·èˆ‡å°æ‡‰ç—…äººåç¨±ï¼Œä»¥ä¾›åˆ—è¡¨èˆ‡æœå°‹ä½¿ç”¨
let medicalRecords = [];
let medicalRecordPatients = {};
/**
 * è¼‰å…¥ç—…æ­·ç®¡ç†é é¢ï¼šé‡ç½®æœå°‹æ¬„ã€è®€å–è¨ºç—‡è¨˜éŒ„èˆ‡ç—…äººè³‡æ–™ï¼Œä¸¦ç¶å®šæœå°‹äº‹ä»¶ã€‚
 */
function loadMedicalRecordManagement() {
    try {
        // ç¢ºä¿åˆ†é è¨­å®šå­˜åœ¨ä¸¦é‡ç½®ç•¶å‰é 
        if (!paginationSettings.medicalRecordList) {
            paginationSettings.medicalRecordList = { currentPage: 1, itemsPerPage: 10 };
        }
        paginationSettings.medicalRecordList.currentPage = 1;
        const searchInput = document.getElementById('searchMedicalRecord');
        if (searchInput) {
            searchInput.value = '';
            // ç§»é™¤èˆŠçš„ç›£è½å™¨ä»¥é¿å…é‡è¤‡ç¶å®š
            if (searchInput._medicalRecordListener) {
                searchInput.removeEventListener('input', searchInput._medicalRecordListener);
            }
            const listener = debounce(() => {
                // æ¯ç•¶æœå°‹æ¢ä»¶è®Šæ›´æ™‚ï¼Œå°‡é ç¢¼é‡ç½®ç‚º 1 ä¸¦é‡æ–°é¡¯ç¤ºåˆ—è¡¨
                paginationSettings.medicalRecordList.currentPage = 1;
                displayMedicalRecords(false);
            }, 300);
            searchInput.addEventListener('input', listener);
            searchInput._medicalRecordListener = listener;
        }
        // åŒæ™‚è®€å–è¨ºç—‡è¨˜éŒ„èˆ‡ç—…äººåˆ—è¡¨ï¼ˆä½¿ç”¨å®‰å…¨æ–¹æ³•ç­‰å¾… DataManager å°±ç·’ï¼‰
        Promise.all([
            window.firebaseDataManager && typeof window.firebaseDataManager.getConsultations === 'function'
                ? (async () => {
                      await waitForFirebaseDataManager();
                      return await window.firebaseDataManager.getConsultations(true);
                  })()
                : { success: false, data: [] },
            // ä½¿ç”¨ safeGetPatients ä»¥é¿å… DataManager å°šæœªè¼‰å…¥
            safeGetPatients(true)
        ]).then(([consRes, patientsRes]) => {
            medicalRecords = (consRes && consRes.success && Array.isArray(consRes.data)) ? consRes.data : [];
            const patients = (patientsRes && patientsRes.success && Array.isArray(patientsRes.data)) ? patientsRes.data : [];
            medicalRecordPatients = {};
            patients.forEach(p => {
                const name = p.name || p.patientName || p.fullName || p.displayName || p.chineseName || p.englishName || '';
                medicalRecordPatients[p.id] = name;
            });
            displayMedicalRecords(false);
        }).catch(err => {
            console.error('è¼‰å…¥ç—…æ­·è³‡æ–™å¤±æ•—:', err);
            // è‹¥è¼‰å…¥å¤±æ•—ä»æ¸…ç©ºåˆ—è¡¨
            medicalRecords = [];
            medicalRecordPatients = {};
            displayMedicalRecords(false);
        });
    } catch (error) {
        console.error('åˆå§‹åŒ–ç—…æ­·ç®¡ç†æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
}

/**
 * é¡¯ç¤ºç—…æ­·åˆ—è¡¨ï¼Œå¯ä¾æœå°‹æ¢ä»¶ç¯©é¸ä¸¦é€²è¡Œåˆ†é ã€‚
 * @param {boolean} pageChange è‹¥ç‚º true è¡¨ç¤ºåƒ…æ›´æ›é ç¢¼ï¼Œä¸é‡ç½®ç›®å‰é 
 */
function displayMedicalRecords(pageChange = false) {
    const tbody = document.getElementById('medicalRecordTableBody');
    if (!tbody) return;
    const searchInput = document.getElementById('searchMedicalRecord');
    const term = searchInput && searchInput.value ? searchInput.value.toLowerCase().trim() : '';
    // ä¾ç…§æœå°‹æ¢ä»¶éŽæ¿¾
    let filtered = medicalRecords;
    if (term) {
        filtered = medicalRecords.filter(rec => {
            // ä½¿ç”¨ç—…æ­·ç·¨è™Ÿé€²è¡Œæœå°‹æ™‚å„ªå…ˆæŽ¡ç”¨ rec.medicalRecordNumber
            // è‹¥ä¸å­˜åœ¨å‰‡å›žé€€è‡³ Firebase æ–‡ä»¶ IDã€‚é€™æ¨£å¯è®“ä½¿ç”¨è€…è¼¸å…¥ã€ŒMRã€é–‹é ­çš„ç·¨è™Ÿ
            // å°±èƒ½æœå°‹åˆ°å°æ‡‰ç—…æ­·ï¼Œè€Œä¸æœƒåªæ¯”å°éš±æ™¦çš„æ–‡ä»¶ IDã€‚ã€857813225103928â€ L1617-L1625ã€‘
            const recordNum = String(rec.medicalRecordNumber || rec.id || '').toLowerCase();
            const patientName = String(medicalRecordPatients[rec.patientId] || '').toLowerCase();
            let doctorName = '';
            // ä¾æ“šé†«å¸«è³‡æ–™è¨­å®šé¡¯ç¤ºåç¨±ï¼Œè‹¥ç‚ºå­—ä¸²ï¼ˆå¯èƒ½ç‚º username æˆ–è§’è‰²ï¼‰ï¼Œ
            // å‰‡ä½¿ç”¨ getDoctorDisplayName() å˜—è©¦å¾žç”¨æˆ¶åˆ—è¡¨å–å¾—é¡¯ç¤ºåç¨±ï¼›
            // è‹¥ç‚ºç‰©ä»¶ï¼Œå‰‡å„ªå…ˆä½¿ç”¨å…¶ username å†ä»¥ getDoctorDisplayName() è½‰æ›ï¼Œ
            // å¦å‰‡å›žé€€è‡³å…¶è‡ªèº«çš„ displayName/name/fullName æˆ– emailã€‚
            if (rec.doctor) {
                try {
                    if (typeof rec.doctor === 'string') {
                        doctorName = typeof getDoctorDisplayName === 'function'
                            ? getDoctorDisplayName(rec.doctor) : rec.doctor;
                    } else if (rec.doctor.username) {
                        doctorName = typeof getDoctorDisplayName === 'function'
                            ? getDoctorDisplayName(rec.doctor.username) : (rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '');
                    } else {
                        doctorName = rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '';
                    }
                } catch (_err) {
                    doctorName = rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '';
                }
            }
            doctorName = doctorName.toLowerCase();
            return recordNum.includes(term) || patientName.includes(term) || doctorName.includes(term);
        });
    }
    // å°‡éŽæ¿¾å¾Œçš„ç—…æ­·ä¾æ—¥æœŸæŽ’åºï¼Œæœ€æ–°æ—¥æœŸå„ªå…ˆã€‚
    // é€éŽ parseConsultationDate è§£æž dateã€createdAt æˆ– updatedAtï¼Œè‹¥è§£æžå¤±æ•—è¦–ç‚º 0ã€‚
    try {
        const getTimestamp = (rec) => {
            try {
                const raw = rec.date || rec.createdAt || rec.updatedAt || null;
                const parsed = parseConsultationDate(raw);
                return parsed && !isNaN(parsed.getTime()) ? parsed.getTime() : 0;
            } catch (_err) {
                return 0;
            }
        };
        filtered = filtered.slice().sort((a, b) => {
            const tA = getTimestamp(a);
            const tB = getTimestamp(b);
            return tB - tA;
        });
    } catch (_sortErr) {
        // å¿½ç•¥æŽ’åºå¤±æ•—
    }
    if (!pageChange) {
        // é‡ç½®ç•¶å‰é è‡³ç¬¬ä¸€é 
        if (paginationSettings.medicalRecordList) {
            paginationSettings.medicalRecordList.currentPage = 1;
        }
    }
    const itemsPerPage = (paginationSettings.medicalRecordList && paginationSettings.medicalRecordList.itemsPerPage) ? paginationSettings.medicalRecordList.itemsPerPage : 10;
    let currentPage = (paginationSettings.medicalRecordList && paginationSettings.medicalRecordList.currentPage) ? paginationSettings.medicalRecordList.currentPage : 1;
    const totalItems = filtered.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
    if (currentPage > totalPages) {
        currentPage = totalPages;
    }
    if (paginationSettings.medicalRecordList) {
        paginationSettings.medicalRecordList.currentPage = currentPage;
    }
    const startIdx = (currentPage - 1) * itemsPerPage;
    const pageItems = filtered.slice(startIdx, startIdx + itemsPerPage);
    tbody.innerHTML = '';
    // æ±ºå®šèªžè¨€é¡¯ç¤º
    let lang = 'zh';
    try {
        lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
    } catch (_e) {}
    const translations = (typeof window !== 'undefined' && window.translations && window.translations[lang]) ? window.translations[lang] : {};
    const viewLabel = translations['æª¢è¦–'] || 'æª¢è¦–';
    // æ–°å¢žåˆªé™¤æŒ‰éˆ•æ¨™ç±¤ï¼Œå¯æ ¹æ“šèªžè¨€è¨­å®š
    const deleteLabel = translations['åˆªé™¤'] || (lang === 'en' ? 'Delete' : 'åˆªé™¤');
    const noMatchText = term ? (lang === 'en' ? 'No matching records found' : 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç—…æ­·') : (lang === 'en' ? 'No medical records yet' : 'å°šç„¡ç—…æ­·è³‡æ–™');
    if (!pageItems || pageItems.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    ${window.escapeHtml(noMatchText)}
                </td>
            </tr>
        `;
    } else {
        pageItems.forEach(rec => {
            // é¡¯ç¤ºçµ¦ä½¿ç”¨è€…çœ‹çš„ç—…æ­·ç·¨è™Ÿæ‡‰ç‚ºç³»çµ±ç”¢ç”Ÿçš„ medicalRecordNumberï¼›è‹¥ç„¡å‰‡å›žé€€è‡³æ–‡ä»¶ IDã€‚
            const recordNumDisplay = rec.medicalRecordNumber || rec.id || '';
            // å¯¦éš›ç”¨æ–¼è¼‰å…¥èˆ‡åˆªé™¤çš„ç—…æ­· ID å¿…é ˆä½¿ç”¨ Firebase æ–‡ä»¶ ID
            const recordId = rec.id || '';
            const patientName = medicalRecordPatients[rec.patientId] || '';
            let doctorName = '';
            if (rec.doctor) {
                try {
                    if (typeof rec.doctor === 'string') {
                        doctorName = typeof getDoctorDisplayName === 'function'
                            ? getDoctorDisplayName(rec.doctor)
                            : rec.doctor;
                    } else if (rec.doctor.username) {
                        doctorName = typeof getDoctorDisplayName === 'function'
                            ? getDoctorDisplayName(rec.doctor.username)
                            : (rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '');
                    } else {
                        doctorName = rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '';
                    }
                } catch (_err) {
                    doctorName = rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '';
                }
            }
            let dateStr = '';
            try {
                const rawDate = rec.date || rec.createdAt || rec.updatedAt || null;
                const parsed = parseConsultationDate(rawDate);
                if (parsed && !isNaN(parsed.getTime())) {
                    const locale = lang === 'en' ? 'en-US' : 'zh-TW';
                    dateStr = parsed.toLocaleDateString(locale, { year: 'numeric', month: '2-digit', day: '2-digit' });
                }
            } catch (_err) {}
            // èª¿æ•´ä¸»è¨´æ¬„ä½çš„ä¾†æºé †åºï¼šè‹¥è¨˜éŒ„å·²æœ‰ä¸­é†«è¨ºæ–·ï¼ˆdiagnosis æˆ– tcmDiagnosisï¼‰ï¼Œ
            // å‰‡å„ªå…ˆé¡¯ç¤ºè©²è¨ºæ–·å…§å®¹ï¼›è‹¥ç„¡å‰‡é€€å›žè‡³ä¸»è¨´/å•è¨ºæ‘˜è¦/ç¾ç—…å²ç­‰å…¶ä»–æ¬„ä½ã€‚
            let complaint = rec.diagnosis || rec.tcmDiagnosis || rec.symptoms || rec.inquirySummary || rec.chiefComplaint || rec.currentHistory || '';
            let complaintDisplay = '';
            if (complaint) {
                const firstLine = complaint.split('\n').find(l => l.trim() !== '');
                complaintDisplay = firstLine || '';
                // å°‡ä¸»è¨´æ¬„ä½çš„é¡¯ç¤ºé•·åº¦ç¸®çŸ­ç‚º 8 å€‹å­—å…ƒï¼Œè¶…å‡ºéƒ¨åˆ†é¡¯ç¤ºçœç•¥è™Ÿï¼Œ
                // ä»¥å…åˆ—è¡¨ä½”ç”¨éŽå¤šå¯¬åº¦
                if (complaintDisplay.length > 8) {
                    complaintDisplay = complaintDisplay.substring(0, 8) + '...';
                }
            }
            tbody.innerHTML += `
                <tr>
                    <td class="px-4 py-2 whitespace-nowrap">${window.escapeHtml(recordNumDisplay)}</td>
                    <td class="px-4 py-2 whitespace-nowrap">${window.escapeHtml(patientName)}</td>
                    <td class="px-4 py-2 whitespace-nowrap">${window.escapeHtml(complaintDisplay)}</td>
                    <td class="px-4 py-2 whitespace-nowrap">${window.escapeHtml(doctorName)}</td>
                    <td class="px-4 py-2 whitespace-nowrap">${window.escapeHtml(dateStr)}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        <button class="text-blue-600 hover:underline mr-2" onclick="viewMedicalRecord('${recordId}', '${rec.patientId}')">${window.escapeHtml(viewLabel)}</button>
                        <button class="text-red-600 hover:underline" onclick="confirmDeleteMedicalRecord('${recordId}', '${patientName}')">${window.escapeHtml(deleteLabel)}</button>
                    </td>
                </tr>
            `;
        });
    }
    // ç¢ºä¿åˆ†é å®¹å™¨å­˜åœ¨ä¸¦æ¸²æŸ“
    const paginEl = ensurePaginationContainer('medicalRecordList', 'medicalRecordPagination');
    if (paginEl) {
        renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
            if (paginationSettings.medicalRecordList) {
                paginationSettings.medicalRecordList.currentPage = newPage;
            }
            displayMedicalRecords(true);
        }, paginEl);
    }
}

/**
 * æª¢è¦–å–®ç­†ç—…æ­·è¨˜éŒ„ï¼Œé¡¯ç¤ºæ–¼å½ˆçª—ä¸­ã€‚
 * @param {string} recordId ç—…æ­·æª”æ¡ˆç·¨è™Ÿ
 * @param {string} patientId ç—…äººç·¨è™Ÿï¼Œç”¨æ–¼æŸ¥è©¢ç—…äººå§“å
 */
function viewMedicalRecord(recordId, patientId) {
    try {
        // å–å¾—å°æ‡‰ç—…æ­·ç´€éŒ„
        const rec = medicalRecords.find(r => String(r.id) === String(recordId));
        if (!rec) {
            showToast('æ‰¾ä¸åˆ°ç—…æ­·è¨˜éŒ„', 'error');
            return;
        }
        // å–å¾—èªžè¨€èˆ‡åœ°å€è¨­å®šï¼Œé è¨­ç‚ºä¸­æ–‡
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        const locale = lang === 'en' ? 'en-US' : 'zh-TW';
        // å–å¾—ç¿»è­¯å­—å…¸ï¼Œä»¥ä¾¿å¾ŒçºŒæ¨™ç±¤å¯æ ¹æ“šèªžè¨€é¡¯ç¤º
        const dict = (window.translations && window.translations[lang]) ? window.translations[lang] : {};
        // å–å¾—é†«å¸«åç¨±ï¼Œå„ªå…ˆé€éŽ getDoctorDisplayName è½‰æ›ç”¨æˆ¶åç¨±
        let doctorName = '';
        if (rec.doctor) {
            try {
                if (typeof rec.doctor === 'string') {
                    doctorName = typeof getDoctorDisplayName === 'function'
                        ? getDoctorDisplayName(rec.doctor) : rec.doctor;
                } else if (rec.doctor.username) {
                    doctorName = typeof getDoctorDisplayName === 'function'
                        ? getDoctorDisplayName(rec.doctor.username) : (rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '');
                } else {
                    doctorName = rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '';
                }
            } catch (_err) {
                doctorName = rec.doctor.displayName || rec.doctor.name || rec.doctor.fullName || rec.doctor.email || '';
            }
        }
        // è§£æžæ—¥æœŸèˆ‡æ™‚é–“ï¼Œä¸¦çµ„åˆç‚ºå®Œæ•´å­—ä¸²
        const rawDate = rec.date || rec.createdAt || rec.updatedAt || null;
        let dateTimeStr = 'æ—¥æœŸæœªçŸ¥';
        try {
            const parsed = parseConsultationDate(rawDate);
            if (parsed && !isNaN(parsed.getTime())) {
                const datePart = parsed.toLocaleDateString(locale);
                const timePart = parsed.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                dateTimeStr = datePart + ' ' + timePart;
            }
        } catch (_e) {}
        // æº–å‚™é†«å¸«èˆ‡ç—…æ­·ç·¨è™Ÿæ¨™ç±¤ï¼ˆå«å†’è™Ÿï¼‰ï¼Œå¦‚æžœç¿»è­¯å­˜åœ¨å‰‡ä½¿ç”¨ç¿»è­¯
        const doctorLabel = dict['é†«å¸«ï¼š'] || 'é†«å¸«ï¼š';
        const recordNumberLabel = dict['ç—…æ­·ç·¨è™Ÿï¼š'] || 'ç—…æ­·ç·¨è™Ÿï¼š';
        // æ§‹å»ºå¯é¸æ“‡è¼‰å…¥ç—…æ­·æŒ‰éˆ•çš„ HTML
        let loadButtonHtml = '';
        try {
            if (typeof currentConsultingAppointmentId !== 'undefined' && currentConsultingAppointmentId) {
                const currentAppointment = appointments && Array.isArray(appointments) ? appointments.find(apt => apt && String(apt.id) === String(currentConsultingAppointmentId)) : null;
                if (currentAppointment && String(currentAppointment.patientId) === String(rec.patientId)) {
                    loadButtonHtml = `<button onclick="loadMedicalRecordToCurrentConsultation('${rec.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">è¼‰å…¥ç—…æ­·</button>`;
                }
            }
        } catch (_e) {}
        // çµ„åˆè©³ç´°å…§å®¹çš„ HTMLï¼Œä½¿ç”¨èˆ‡ç—…äººç—…æ­·æŸ¥çœ‹ä¸€è‡´çš„å¡ç‰‡æ¨£å¼
        let detailHtml = '';
        detailHtml += '<div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">';
        // Header å€å¡Š
        detailHtml += '<div class="bg-gradient-to-r from-gray-50 to-blue-50 px-6 py-4 border-b border-gray-200">';
        detailHtml += '<div class="flex justify-between items-center">';
        // å·¦å´æ—¥æœŸèˆ‡æ¨™ç±¤
        detailHtml += '<div class="flex items-center space-x-4">';
        detailHtml += `<span class="font-semibold text-gray-900 text-lg">${window.escapeHtml(dateTimeStr)}</span>`;
        detailHtml += `<span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">${window.escapeHtml(doctorLabel)}${window.escapeHtml(doctorName)}</span>`;
        detailHtml += `<span class="text-sm text-gray-600 bg-white px-3 py-1 rounded">${window.escapeHtml(recordNumberLabel)}${window.escapeHtml(rec.medicalRecordNumber || rec.id)}</span>`;
        if (rec.updatedAt) {
            detailHtml += '<span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded">å·²ä¿®æ”¹</span>';
        }
        detailHtml += '</div>'; // é—œé–‰å·¦å´ä¿¡æ¯
        // å³å´æŒ‰éˆ•
        detailHtml += '<div class="flex flex-wrap justify-end gap-1">';
        detailHtml += `<button onclick="printConsultationRecord('${rec.id}')" class="text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">åˆ—å°æ”¶æ“š</button>`;
        detailHtml += `<button onclick="printPrescriptionInstructions('${rec.id}')" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium bg-yellow-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">è—¥å–®é†«å›‘</button>`;
        detailHtml += `<button onclick="printAttendanceCertificate('${rec.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium bg-blue-50 px-3 py-2 rounded" style="transform: scale(0.75); transform-origin: left;">åˆ°è¨ºè­‰æ˜Ž</button>`;
        detailHtml += loadButtonHtml;
        detailHtml += '</div>'; // æŒ‰éˆ•å€å¡ŠçµæŸ
        detailHtml += '</div>'; // flex å®¹å™¨çµæŸ
        detailHtml += '</div>'; // header çµæŸ
        // å…§å®¹å€å¡Š
        detailHtml += '<div class="p-6">';
        detailHtml += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">';
        // å·¦æ¬„ï¼šç—‡ç‹€èˆ‡è¨ºæ–·
        detailHtml += '<div class="space-y-4">';
        // ä¸»è¨´
        detailHtml += '<div>';
        detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">ä¸»è¨´</span>';
        detailHtml += `<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${rec.symptoms ? window.escapeHtml(rec.symptoms) : 'ç„¡è¨˜éŒ„'}</div>`;
        detailHtml += '</div>';
        // ç¾ç—…å²
        if (rec.currentHistory) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">ç¾ç—…å²</span>';
            detailHtml += `<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${window.escapeHtml(rec.currentHistory)}</div>`;
            detailHtml += '</div>';
        }
        // èˆŒè±¡
        if (rec.tongue) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">èˆŒè±¡</span>';
            detailHtml += `<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${window.escapeHtml(rec.tongue)}</div>`;
            detailHtml += '</div>';
        }
        // è„ˆè±¡
        if (rec.pulse) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">è„ˆè±¡</span>';
            detailHtml += `<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${window.escapeHtml(rec.pulse)}</div>`;
            detailHtml += '</div>';
        }
        // ä¸­é†«è¨ºæ–·
        detailHtml += '<div>';
        detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">ä¸­é†«è¨ºæ–·</span>';
        detailHtml += `<div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 medical-field">${rec.diagnosis ? window.escapeHtml(rec.diagnosis) : 'ç„¡è¨˜éŒ„'}</div>`;
        detailHtml += '</div>';
        // è­‰åž‹è¨ºæ–·
        detailHtml += '<div>';
        detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">è­‰åž‹è¨ºæ–·</span>';
        detailHtml += `<div class="bg-blue-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-blue-400 medical-field">${rec.syndrome ? window.escapeHtml(rec.syndrome) : 'ç„¡è¨˜éŒ„'}</div>`;
        detailHtml += '</div>';
        // é‡ç¸å‚™è¨»
        if (rec.acupunctureNotes) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">é‡ç¸å‚™è¨»</span>';
            detailHtml += `<div class="bg-orange-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-orange-400 medical-field">${window.escapeHtml(window.stripHtmlTags(rec.acupunctureNotes))}</div>`;
            detailHtml += '</div>';
        }
        detailHtml += '</div>'; // å·¦æ¬„çµæŸ
        // å³æ¬„ï¼šè™•æ–¹èˆ‡ç”¨æ³•
        detailHtml += '<div class="space-y-4">';
        // è™•æ–¹å…§å®¹
        detailHtml += '<div>';
        detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">è™•æ–¹å…§å®¹</span>';
        detailHtml += `<div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-yellow-400 whitespace-pre-line medical-field">${rec.prescription ? window.escapeHtml(rec.prescription) : 'ç„¡è¨˜éŒ„'}</div>`;
        detailHtml += '</div>';
        // æœç”¨æ–¹æ³•
if (rec.usage && rec.prescription) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">æœç”¨æ–¹æ³•</span>';
            let usageText = '';
            try {
                const parts = [];
                if (rec.medicationDays && Number(rec.medicationDays) > 0) {
                    parts.push('æœè—¥å¤©æ•¸ï¼š' + rec.medicationDays + 'å¤©');
                }
                if (rec.medicationFrequency && Number(rec.medicationFrequency) > 0) {
                    parts.push('æ¯æ—¥æ¬¡æ•¸ï¼š' + rec.medicationFrequency + 'æ¬¡');
                }
                const prefix = parts.length > 0 ? parts.join('ã€€') + 'ã€€' : '';
                usageText = prefix + rec.usage;
            } catch (_err) {
                usageText = rec.usage;
            }
            detailHtml += `<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${window.escapeHtml(usageText)}</div>`;
            detailHtml += '</div>';
        }
        // ç™‚ç¨‹
        if (rec.treatmentCourse) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">ç™‚ç¨‹</span>';
            detailHtml += `<div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-900 medical-field">${window.escapeHtml(rec.treatmentCourse)}</div>`;
            detailHtml += '</div>';
        }
        // é†«å›‘åŠæ³¨æ„äº‹é …
        if (rec.instructions) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">é†«å›‘åŠæ³¨æ„äº‹é …</span>';
            detailHtml += `<div class="bg-red-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-red-400 medical-field">${window.escapeHtml(rec.instructions)}</div>`;
            detailHtml += '</div>';
        }
        // è¤‡è¨ºæ™‚é–“
        if (rec.followUpDate) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">è¤‡è¨ºæ™‚é–“</span>';
            try {
                const followDate = new Date(rec.followUpDate);
                detailHtml += `<div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400 medical-field">${followDate.toLocaleString(locale)}</div>`;
            } catch (_err) {
                detailHtml += `<div class="bg-purple-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-purple-400 medical-field">${window.escapeHtml(rec.followUpDate)}</div>`;
            }
            detailHtml += '</div>';
        }
        // æ”¶è²»é …ç›®
        if (rec.billingItems) {
            detailHtml += '<div>';
            detailHtml += '<span class="text-sm font-semibold text-gray-700 block mb-2">æ”¶è²»é …ç›®</span>';
            detailHtml += `<div class="bg-green-50 p-3 rounded-lg text-sm text-gray-900 border-l-4 border-green-400 whitespace-pre-line medical-field">${window.escapeHtml(rec.billingItems)}</div>`;
            detailHtml += '</div>';
        }
        detailHtml += '</div>'; // å³æ¬„çµæŸ
        detailHtml += '</div>'; // grid çµæŸ
        detailHtml += '</div>'; // p-6 çµæŸ
        detailHtml += '</div>'; // å¡ç‰‡å®¹å™¨çµæŸ
        // å°‡å…§å®¹æ’å…¥å½ˆçª—ä¸¦é¡¯ç¤º
        const modal = document.getElementById('medicalRecordDetailModal');
        const content = document.getElementById('medicalRecordDetailContent');
        if (content) {
            content.innerHTML = detailHtml;
        }
        if (modal) {
            modal.classList.remove('hidden');
        }
    } catch (error) {
        console.error('æª¢è¦–ç—…æ­·è¨˜éŒ„éŒ¯èª¤:', error);
    }
}

/**
 * é—œé–‰ç—…æ­·è©³ç´°è³‡è¨Šå½ˆçª—ã€‚
 */
function closeMedicalRecordDetail() {
    const modal = document.getElementById('medicalRecordDetailModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

/**
 * é¡¯ç¤ºåˆªé™¤ç—…æ­·ç¢ºèªå°è©±æ¡†ä¸¦åŸ·è¡Œåˆªé™¤ã€‚
 * å°‡æç¤ºè¨Šæ¯æ ¹æ“šç•¶å‰èªžè¨€ç¿»è­¯ï¼Œé¿å…ä½¿ç”¨è€…èª¤æ“ä½œã€‚
 * @param {string} recordId - è¦åˆªé™¤çš„ç—…æ­·è¨˜éŒ„ ID
 * @param {string} patientName - ç—…äººåç¨±ï¼Œç”¨æ–¼æç¤ºä¸­é¡¯ç¤º
 */
async function confirmDeleteMedicalRecord(recordId, patientName) {
    try {
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        let message;
        if (lang === 'en') {
            message = `Are you sure you want to delete the record for ${patientName} (ID: ${recordId})?\nThis action cannot be undone.`;
        } else {
            // ä¸­æ–‡æç¤º
            message = `ç¢ºå®šè¦åˆªé™¤ç—…æ­·ã€Œ${patientName} - ${recordId}ã€å—Žï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•æ¢å¾©ï¼`;
        }
        const confirmed = await showConfirmation(message, 'warning');
        if (!confirmed) {
            return;
        }
        deleteMedicalRecord(recordId);
    } catch (_err) {
        // è‹¥å‡ºç¾æ„å¤–éŒ¯èª¤ï¼Œç›´æŽ¥å‘¼å«åˆªé™¤ä»¥ç¢ºä¿æµç¨‹ä¸ä¸­æ–·
        deleteMedicalRecord(recordId);
    }
}

/**
 * åˆªé™¤æŒ‡å®šç—…æ­·ï¼Œå¾ž Firebase çš„ consultations é›†åˆä¸­ç§»é™¤ä¸¦æ›´æ–°æœ¬åœ°åˆ—è¡¨ã€‚
 * å¦‚ Firebase DataManager æä¾› deleteConsultation åŠŸèƒ½ï¼Œå‰‡å„ªå…ˆä½¿ç”¨ï¼›
 * è‹¥ç„¡å‰‡ç›´æŽ¥èª¿ç”¨ firebase.deleteDocã€‚
 * @param {string} recordId - è¦åˆªé™¤çš„ç—…æ­·è¨˜éŒ„ ID
 */
async function deleteMedicalRecord(recordId) {
    try {
        // å¦‚æžœ firebaseDataManager æä¾›åˆªé™¤è¨ºç—‡ç´€éŒ„çš„æ–¹æ³•ï¼Œå„ªå…ˆä½¿ç”¨
        let deleted = false;
        if (window.firebaseDataManager && typeof window.firebaseDataManager.deleteConsultation === 'function') {
            const result = await window.firebaseDataManager.deleteConsultation(recordId);
            if (result && result.success) {
                deleted = true;
            }
        }
        // å¦‚æžœ deleteConsultation æ²’æœ‰æˆåŠŸæˆ–ä¸å­˜åœ¨ï¼Œå˜—è©¦ç›´æŽ¥èª¿ç”¨ firebase.deleteDoc
        if (!deleted && window.firebase && window.firebase.deleteDoc && window.firebase.doc && window.firebase.db) {
            await window.firebase.deleteDoc(
                window.firebase.doc(window.firebase.db, 'consultations', recordId)
            );
            deleted = true;
        }
        if (!deleted) {
            throw new Error('Delete function not available');
        }
        // å¾žæœ¬åœ° medicalRecords é™£åˆ—ä¸­ç§»é™¤é€™ç­†è¨˜éŒ„
        if (Array.isArray(medicalRecords)) {
            medicalRecords = medicalRecords.filter(rec => String(rec.id) !== String(recordId));
        }
        // ä¹Ÿåœ¨å…¨åŸŸ consultations é™£åˆ—ä¸­ç§»é™¤
        if (Array.isArray(consultations)) {
            consultations = consultations.filter(rec => String(rec.id) !== String(recordId));
        }
        // æ¸…é™¤ patientConsultationsCache å…§ç›¸é—œå¿«å–
        try {
            if (typeof patientConsultationsCache !== 'undefined' && patientConsultationsCache && typeof patientConsultationsCache === 'object') {
                Object.keys(patientConsultationsCache).forEach(pid => {
                    const arr = patientConsultationsCache[pid];
                    if (Array.isArray(arr)) {
                        patientConsultationsCache[pid] = arr.filter(rec => String(rec.id) !== String(recordId));
                    }
                });
            }
        } catch (_cacheErr) {
            // å¿½ç•¥å¿«å–æ›´æ–°éŒ¯èª¤
        }
        // æ¸…é™¤ consultationsCache ä»¥é¿å…ä¸‹æ¬¡å¾žå¿«å–è®€å–å·²åˆªé™¤çš„è¨˜éŒ„
        try {
            if (window.firebaseDataManager && typeof window.firebaseDataManager.consultationsCache !== 'undefined') {
                window.firebaseDataManager.consultationsCache = null;
            }
            // ç§»é™¤ localStorage ä¸­çš„ consultations é …ç›®
            try {
                localStorage.removeItem('consultations');
            } catch (_lsErr) {
                // å¿½ç•¥ localStorage éŒ¯èª¤
            }
        } catch (_err) {
            // å¿½ç•¥éŒ¯èª¤
        }
        // æ›´æ–°åˆ—è¡¨é¡¯ç¤º
        displayMedicalRecords(false);
        // é¡¯ç¤ºæç¤º
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        showToast(lang === 'en' ? 'Record deleted' : 'ç—…æ­·å·²åˆªé™¤', 'success');
    } catch (error) {
        console.error('åˆªé™¤ç—…æ­·è¨˜éŒ„å¤±æ•—:', error);
        const lang = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) || 'zh';
        showToast(lang === 'en' ? 'Failed to delete record' : 'åˆªé™¤ç—…æ­·å¤±æ•—', 'error');
    }
}

// ç‚º HTML å…§ä½¿ç”¨çš„å‡½å¼å»ºç«‹å…¨åŸŸå¼•ç”¨ã€‚
// é€™äº›å‡½å¼æœƒè¢« HTML å±¬æ€§ï¼ˆä¾‹å¦‚ onclickã€onkeypressï¼‰å‘¼å«ï¼Œè‹¥ä¸æŽ›åœ¨ window ä¸Šï¼Œç€è¦½å™¨æœƒæ‰¾ä¸åˆ°å°æ‡‰å‡½å¼ã€‚
(function() {
  window.attemptMainLogin = attemptMainLogin;
  window.cancelConsultation = cancelConsultation;
  // å°‡å–æ¶ˆå€™è¨ºå‡½å¼æŽ›è¼‰è‡³å…¨åŸŸï¼Œä¾› HTML å…§çš„ onclick èª¿ç”¨
  window.cancelWaiting = cancelWaiting;
  window.clearBillingSearch = clearBillingSearch;
  window.clearPatientSearch = clearPatientSearch;
  window.clearPrescriptionSearch = clearPrescriptionSearch;
  window.closeMedicalHistoryModal = closeMedicalHistoryModal;
  window.closePatientDetail = closePatientDetail;
  window.closePatientMedicalHistoryModal = closePatientMedicalHistoryModal;
  window.closeRegistrationModal = closeRegistrationModal;
  window.confirmRegistration = confirmRegistration;
  window.exportFinancialReport = exportFinancialReport;
  window.exportClinicBackup = exportClinicBackup;
  window.triggerBackupImport = triggerBackupImport;
  window.handleBackupFile = handleBackupFile;

  // æ•¸æ“šåŒ¯å…¥ç›¸é—œå‡½å¼
  window.triggerTemplateImport = triggerTemplateImport;
  window.handleTemplateImportFile = handleTemplateImportFile;
  window.triggerHerbImport = triggerHerbImport;
  window.handleHerbImportFile = handleHerbImportFile;

  // é ç•™ isCombinedImportMode æ——æ¨™ç‚º falseï¼Œä»¥ç¶­æŒæ—¢æœ‰åŒ¯å…¥æµç¨‹çš„é‚è¼¯åˆ¤æ–·
  window.isCombinedImportMode = false;

  /**
   * å®‰å…¨åœ°è½‰ç¾©ä½¿ç”¨è€…æä¾›çš„å­—ä¸²ï¼Œç”¨æ–¼é¿å… XSS æ”»æ“Šã€‚
   * å°‡ç‰¹æ®Šå­—å…ƒæ›¿æ›ç‚º HTML å¯¦é«”ï¼Œç¢ºä¿ä¸æœƒè¢«ç•¶æˆ HTML æ’å…¥ã€‚
   * @param {any} str å¯èƒ½åŒ…å« HTML çš„å­—ä¸²æˆ–å…¶ä»–åž‹åˆ¥
   * @returns {string} è½‰ç¾©å¾Œçš„å­—ä¸²
   */
  window.escapeHtml = function(str) {
    // å°æ–¼ null æˆ– undefined ç›´æŽ¥è½‰ç‚ºç©ºå­—ä¸²
    const s = String(str == null ? '' : str);
    return s
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  };
  window.filterBillingItems = filterBillingItems;
  window.filterHerbLibrary = filterHerbLibrary;
  window.filterUsers = filterUsers;
  window.generateFinancialReport = generateFinancialReport;
  window.hideAddBillingItemForm = hideAddBillingItemForm;
  window.hideAddFormulaForm = hideAddFormulaForm;
  window.hideAddHerbForm = hideAddHerbForm;
  window.hideAddPatientForm = hideAddPatientForm;
  window.hideAddUserForm = hideAddUserForm;
  window.hideClinicSettingsModal = hideClinicSettingsModal;
  window.loadPreviousBillingItems = loadPreviousBillingItems;
  window.loadPreviousPrescription = loadPreviousPrescription;
  window.logout = logout;
  window.refreshPatientPackagesUI = refreshPatientPackagesUI;
  window.saveBillingItem = saveBillingItem;
  window.saveClinicSettings = saveClinicSettings;
  window.saveConsultation = saveConsultation;
  window.saveFormula = saveFormula;
  window.saveHerb = saveHerb;
  window.savePatient = savePatient;
  window.saveUser = saveUser;
  window.searchBillingForConsultation = searchBillingForConsultation;
  window.searchHerbsForPrescription = searchHerbsForPrescription;
  window.searchPatientsForRegistration = searchPatientsForRegistration;
  window.setQuickDate = setQuickDate;
  window.showAddBillingItemForm = showAddBillingItemForm;
  window.showAddFormulaForm = showAddFormulaForm;
  window.showAddHerbForm = showAddHerbForm;
  window.showAddPatientForm = showAddPatientForm;
  window.showAddUserForm = showAddUserForm;
  window.showClinicSettingsModal = showClinicSettingsModal;
  window.switchFinancialTab = switchFinancialTab;
  window.toggleRegistrationNumberField = toggleRegistrationNumberField;
  window.toggleSidebar = toggleSidebar;
  window.updateMedicationDays = updateMedicationDays;
  window.updateMedicationDaysFromInput = updateMedicationDaysFromInput;
  window.updateMedicationFrequency = updateMedicationFrequency;
  window.updatePatientAge = updatePatientAge;
  // å°‡å€‹äººæ…£ç”¨çµ„åˆçš„æ¸²æŸ“å‡½å¼å…¬é–‹è‡³å…¨åŸŸï¼Œæ–¹ä¾¿åœ¨æœå°‹æˆ–åˆ†é¡žè®Šæ›´æ™‚å‘¼å«
  window.renderHerbCombinations = renderHerbCombinations;
  window.renderAcupointCombinations = renderAcupointCombinations;
  window.updateRestPeriod = updateRestPeriod;
  window.useOnePackage = useOnePackage;
  window.undoPackageUse = undoPackageUse;

  // ç—…æ­·åˆªé™¤ç›¸é—œå‡½å¼
  window.confirmDeleteMedicalRecord = confirmDeleteMedicalRecord;
  window.deleteMedicalRecord = deleteMedicalRecord;

  // å°‡å€‹äººè¨­ç½®èˆ‡æ…£ç”¨çµ„åˆç›¸é—œå‡½å¼æŽ›è¼‰è‡³å…¨åŸŸï¼Œè®“ HTML æŒ‰éˆ•å¯ä»¥ç›´æŽ¥èª¿ç”¨ã€‚
  window.loadPersonalSettings = loadPersonalSettings;
  window.updatePersonalSettings = updatePersonalSettings;
  window.showHerbComboModal = showHerbComboModal;
  window.hideHerbComboModal = hideHerbComboModal;
  window.selectHerbCombo = selectHerbCombo;
  window.showAcupointComboModal = showAcupointComboModal;
  window.hideAcupointComboModal = hideAcupointComboModal;
  window.selectAcupointCombo = selectAcupointCombo;

  // ç—…æ­·ç®¡ç†åŠŸèƒ½ï¼šå°‡ç›¸é—œå‡½å¼æŽ›è¼‰è‡³å…¨åŸŸï¼Œä¾› HTML ç›´æŽ¥èª¿ç”¨ã€‚
  // é€™äº›å‡½å¼è² è²¬è¼‰å…¥ç—…æ­·åˆ—è¡¨ã€é¡¯ç¤ºåˆ—è¡¨ã€æª¢è¦–å€‹åˆ¥ç—…æ­·ä»¥åŠé—œé–‰è©³æƒ…å½ˆçª—ã€‚
  window.loadMedicalRecordManagement = loadMedicalRecordManagement;
  window.displayMedicalRecords = displayMedicalRecords;
  window.viewMedicalRecord = viewMedicalRecord;
  window.closeMedicalRecordDetail = closeMedicalRecordDetail;

  // æ–°å¢žå°è£å‡½å¼ï¼šç‚ºå¸¸ç”¨è—¥æ–¹å’Œç©´ä½è¼‰å…¥æŒ‰éˆ•æä¾›çµ±ä¸€çš„è®€å–åœˆæ•ˆæžœã€‚
  // èˆ‡ openDiagnosisTemplate/openPrescriptionTemplate é¢¨æ ¼ä¸€è‡´ï¼ŒæŒ‰ä¸‹æŒ‰éˆ•å¾Œé¡¯ç¤ºè®€å–åœ–ç¤ºå†é–‹å•Ÿå½ˆçª—ã€‚
  async function openHerbCombo(ev) {
    let btn = null;
    try {
      if (ev && ev.currentTarget) btn = ev.currentTarget;
      if (!btn) {
        btn = document.querySelector('button[onclick*="openHerbCombo"]');
      }
      if (btn) {
        setButtonLoading(btn);
      }
      // è¼•å¾®å»¶é²ï¼Œè®“ä½¿ç”¨è€…æ„Ÿå—è®€å–ç‹€æ…‹
      await new Promise(resolve => setTimeout(resolve, 200));
      if (typeof showHerbComboModal === 'function') {
        showHerbComboModal();
      }
    } catch (err) {
      console.error('é–‹å•Ÿå¸¸ç”¨è—¥æ–¹æŒ‰éˆ•éŒ¯èª¤:', err);
    } finally {
      if (btn) {
        clearButtonLoading(btn);
      }
    }
  }

  async function openAcupointCombo(ev) {
    let btn = null;
    try {
      if (ev && ev.currentTarget) btn = ev.currentTarget;
      if (!btn) {
        btn = document.querySelector('button[onclick*="openAcupointCombo"]');
      }
      if (btn) {
        setButtonLoading(btn);
      }
      await new Promise(resolve => setTimeout(resolve, 200));
      if (typeof showAcupointComboModal === 'function') {
        showAcupointComboModal();
      }
    } catch (err) {
      console.error('é–‹å•Ÿå¸¸ç”¨ç©´ä½æŒ‰éˆ•éŒ¯èª¤:', err);
    } finally {
      if (btn) {
        clearButtonLoading(btn);
      }
    }
  }

  // å°‡å°è£å‡½å¼æŽ›è¼‰è‡³å…¨åŸŸï¼Œä»¥ä¾¿ HTML æŒ‰éˆ•å‘¼å«
  window.openHerbCombo = openHerbCombo;
  window.openAcupointCombo = openAcupointCombo;
  // ä¸­è—¥åº«åº«å­˜å½ˆçª—åŠŸèƒ½
  window.openInventoryModal = openInventoryModal;
  window.hideInventoryModal = hideInventoryModal;
  window.saveInventoryChanges = saveInventoryChanges;

  // æ‰¹é‡å…¥åº«åŠŸèƒ½æŽ›è¼‰è‡³å…¨åŸŸ
  window.openBatchInventoryModal = openBatchInventoryModal;
  window.hideBatchInventoryModal = hideBatchInventoryModal;
  window.addBatchRow = addBatchRow;
  window.saveBatchInventory = saveBatchInventory;

  // åœ¨è…³æœ¬è¼‰å…¥æ™‚ç‚ºæ‰¹é‡å…¥åº«å½ˆçª—è¨»å†Šé»žæ“Šäº‹ä»¶ï¼Œä»¥ä¾¿ç•¶ä½¿ç”¨è€…é»žæ“Šå½ˆçª—é®ç½©ï¼ˆé»‘è‰²èƒŒæ™¯ï¼‰æ™‚å³å¯é—œé–‰å½ˆçª—ã€‚
  // å…¶ä»–å½ˆçª—é è¨­å·²æ”¯æ´é»žæ“Šé®ç½©é—œé–‰ï¼Œæ‰¹é‡å…¥åº«å½ˆçª—åœ¨å…ˆå‰ç‰ˆæœ¬ä¸­æœªå¯¦ä½œæ­¤è¡Œç‚ºï¼Œæ•…æ–¼æ­¤è£œä¸Šã€‚
  (function attachBatchModalOutsideClick() {
    try {
      const modal = document.getElementById('batchInventoryModal');
      if (modal && !modal.dataset.outsideClickBound) {
        modal.addEventListener('click', function (evt) {
          // åƒ…ç•¶é»žæ“Šç›®æ¨™ç‚ºè¦†è“‹å±¤æœ¬èº«ï¼ˆå³é»‘è‰²èƒŒæ™¯ï¼‰æ™‚æ‰é—œé–‰ï¼Œé¿å…åœ¨å…§éƒ¨è¡¨å–®é»žæ“Šæ™‚é—œé–‰å½ˆçª—
          if (evt.target === modal) {
            hideBatchInventoryModal();
          }
        });
        // ä½¿ç”¨è³‡æ–™å±¬æ€§æ¨™è¨˜ä»¥é¿å…é‡è¤‡ç¶å®šäº‹ä»¶
        modal.dataset.outsideClickBound = 'true';
      }
    } catch (e) {
      console.error('æ‰¹é‡å…¥åº«å½ˆçª—å¤–éƒ¨é»žæ“Šäº‹ä»¶ç¶å®šå¤±æ•—:', e);
    }
  })();

  // å¸³è™Ÿå®‰å…¨ç›¸é—œå‡½å¼æŽ›è¼‰è‡³å…¨åŸŸï¼Œä¾›å¸³è™Ÿå®‰å…¨è¨­å®šé çš„æŒ‰éˆ•å‘¼å«
  window.loadAccountSecurity = loadAccountSecurity;
  window.changeCurrentUserPassword = changeCurrentUserPassword;
  window.deleteCurrentUserAccount = deleteCurrentUserAccount;

  // ç—…äººç®¡ç†æŒ‰éˆ•çš„å°è£å‡½å¼ï¼šç‚ºæŸ¥çœ‹ã€ç—…æ­·ã€ç·¨è¼¯å’Œåˆªé™¤æ“ä½œæ·»åŠ è®€å–åœˆï¼Œä¸¦åœ¨æ“ä½œå®Œæˆå¾Œæ¸…é™¤ã€‚
  async function handleViewPatient(ev, id) {
    let btn = ev && ev.currentTarget ? ev.currentTarget : null;
    if (btn) setButtonLoading(btn);
    try {
      await viewPatient(id);
    } catch (error) {
      console.error('Error viewing patient:', error);
    } finally {
      if (btn) clearButtonLoading(btn);
    }
  }

  async function handleShowMedicalHistory(ev, id) {
    let btn = ev && ev.currentTarget ? ev.currentTarget : null;
    if (btn) setButtonLoading(btn);
    try {
      await showPatientMedicalHistory(id);
    } catch (error) {
      console.error('Error showing medical history:', error);
    } finally {
      if (btn) clearButtonLoading(btn);
    }
  }

  async function handleEditPatient(ev, id) {
    let btn = ev && ev.currentTarget ? ev.currentTarget : null;
    if (btn) setButtonLoading(btn);
    try {
      await editPatient(id);
    } catch (error) {
      console.error('Error editing patient:', error);
    } finally {
      if (btn) clearButtonLoading(btn);
    }
  }

  async function handleDeletePatient(ev, id) {
    let btn = ev && ev.currentTarget ? ev.currentTarget : null;
    if (btn) setButtonLoading(btn);
    try {
      await deletePatient(id);
    } catch (error) {
      console.error('Error deleting patient:', error);
    } finally {
      if (btn) clearButtonLoading(btn);
    }
  }

  // å°‡é€™äº›å°è£å‡½å¼æŽ›è¼‰åˆ° windowï¼Œä¾› HTML çš„ onclick ç›´æŽ¥èª¿ç”¨
  window.handleViewPatient = handleViewPatient;
  window.handleShowMedicalHistory = handleShowMedicalHistory;
  window.handleEditPatient = handleEditPatient;
  window.handleDeletePatient = handleDeletePatient;

  // æ¨¡æ¿åº«ï¼šè¨ºæ–·æ¨¡æ¿èˆ‡é†«å›‘æ¨¡æ¿å½ˆçª—
  // é¡¯ç¤ºè¨ºæ–·æ¨¡æ¿é¸æ“‡å½ˆçª—ï¼Œä¸¦å‹•æ…‹ç”Ÿæˆæ¨¡æ¿åˆ—è¡¨
  function showDiagnosisTemplateModal() {
    try {
      const modal = document.getElementById('diagnosisTemplateModal');
      const listEl = document.getElementById('diagnosisTemplateList');
      if (!modal || !listEl) return;
      // åœ¨åˆ—è¡¨ä¸Šæ–¹æ”¾ç½®æœå°‹æ¬„ï¼Œè‹¥å°šæœªå­˜åœ¨å‰‡å»ºç«‹
      let searchInput = modal.querySelector('#diagnosisTemplateSearch');
      if (!searchInput) {
        searchInput = document.createElement('input');
        searchInput.id = 'diagnosisTemplateSearch';
        searchInput.type = 'text';
        searchInput.placeholder = 'æœå°‹è¨ºæ–·æ¨¡æ¿...';
        searchInput.className = 'w-full mb-3 px-3 py-2 border border-gray-300 rounded';
        // æ’å…¥è‡³åˆ—è¡¨å®¹å™¨ä¹‹å‰
        listEl.parentNode.insertBefore(searchInput, listEl);
        // åœ¨è¼¸å…¥æ™‚é‡æ–°æ¸²æŸ“åˆ—è¡¨
        searchInput.addEventListener('input', function() {
          showDiagnosisTemplateModal();
        });
      }
      // å–å¾—æœå°‹å­—ä¸²ä¸¦è½‰æˆå°å¯«ä»¥ä¾¿æ¯”å°
      const keyword = searchInput.value ? String(searchInput.value).trim().toLowerCase() : '';
      listEl.innerHTML = '';
      // å–å¾—æ¨¡æ¿åˆ—è¡¨
      const templates = Array.isArray(diagnosisTemplates) ? diagnosisTemplates : [];
      // æ ¹æ“šé—œéµå­—éŽæ¿¾
      let filtered = templates;
      if (keyword) {
        filtered = templates.filter(t => {
          if (!t) return false;
          const name = (t.name || '').toLowerCase();
          const category = (t.category || '').toLowerCase();
          const content = (t.content || '').toLowerCase();
          return name.includes(keyword) || category.includes(keyword) || content.includes(keyword);
        });
      }
      // ä¾åç¨±æŽ’åºï¼Œæ”¹å–„æœå°‹é«”é©—
      const sorted = filtered.slice().sort((a, b) => {
        const an = (a && a.name) ? a.name : '';
        const bn = (b && b.name) ? b.name : '';
        return an.localeCompare(bn, 'zh-Hans-CN', { sensitivity: 'base' });
      });
      sorted.forEach(template => {
        if (!template) return;
        const div = document.createElement('div');
        div.className = 'p-3 border border-gray-200 rounded-lg flex justify-between items-center hover:bg-gray-50';
        // å°æ¨¡æ¿åç¨±èˆ‡åˆ†é¡žé€²è¡Œè½‰ç¾©ï¼Œé¿å… XSS
        const safeName = template.name ? window.escapeHtml(template.name) : '';
        const safeCategory = template.category ? window.escapeHtml(template.category) : null;
        const categoryLine = safeCategory ? `<div class="text-sm text-gray-500">${safeCategory}</div>` : '';
        const safeId = String(template.id).replace(/"/g, '&quot;');
        div.innerHTML = `
            <div>
              <div class="font-medium text-gray-800">${safeName}</div>
              ${categoryLine}
            </div>
            <button type="button" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="selectDiagnosisTemplate('${safeId}')">å¥—ç”¨</button>
        `;
        listEl.appendChild(div);
      });
      modal.classList.remove('hidden');
    } catch (err) {
      console.error('é¡¯ç¤ºè¨ºæ–·æ¨¡æ¿å½ˆçª—å¤±æ•—:', err);
    }
  }

  function hideDiagnosisTemplateModal() {
    const modal = document.getElementById('diagnosisTemplateModal');
    if (modal) modal.classList.add('hidden');
  }

  function selectDiagnosisTemplate(id) {
    try {
      const templates = Array.isArray(diagnosisTemplates) ? diagnosisTemplates : [];
      const template = templates.find(t => String(t.id) === String(id));
      if (!template) return;
      // å¡«å…¥ä¸»è¨´èˆ‡è¨ºæ–·ç›¸é—œæ¬„ä½
      const formSymptoms = document.getElementById('formSymptoms');
      const formCurrentHistory = document.getElementById('formCurrentHistory');
      const formTongue = document.getElementById('formTongue');
      const formPulse = document.getElementById('formPulse');
      const formDiagnosis = document.getElementById('formDiagnosis');
      const formSyndrome = document.getElementById('formSyndrome');

      /**
       * å˜—è©¦å¾žæ¨¡æ¿çš„ content æ¬„ä½è§£æžç‰¹å®šçš„è¨ºæ–·æ¬„ç›®ï¼Œä¾‹å¦‚ã€Œä¸»è¨´ã€ã€ã€Œç¾ç—…å²ã€ã€ã€ŒèˆŒè±¡ã€ç­‰ã€‚
       * è‹¥æ¨¡æ¿å·²æœ‰å°æ‡‰å±¬æ€§ï¼ˆå¦‚ chiefComplaint ç­‰ï¼‰å‰‡å„ªå…ˆä½¿ç”¨è©²å±¬æ€§ã€‚
       * è§£æžé †åºï¼š
       *   - å…ˆæª¢æŸ¥æ¨¡æ¿å°æ‡‰æ¬„ä½æ˜¯å¦æœ‰è³‡æ–™ã€‚
       *   - å†å¾ž content ä¸­ä»¥é—œéµå­—åˆ‡å‰²ç²å–ã€‚
       *   - æœ€å¾Œé€€è€Œæ±‚å…¶æ¬¡ä½¿ç”¨æ•´æ®µ content æˆ–æ¨¡æ¿åç¨±ã€‚
       */
      const tmplContent = typeof template.content === 'string' ? template.content : '';
      // è§£æž content ä¸­æŒ‡å®šæ¨™é¡Œå¾Œçš„å…§å®¹ï¼Œä½¿ç”¨éžè²ªå©ªåŒ¹é…ï¼Œç›´åˆ°ä¸‹ä¸€å€‹å·²çŸ¥æ¨™é¡Œæˆ–å­—ä¸²çµå°¾
      function parseSection(keyword) {
        try {
          const pattern = new RegExp(String(keyword) + '[ï¼š:]\\s*([\\s\\S]*?)(?:\\n|$|ä¸»è¨´|ç¾ç—…å²|èˆŒè±¡|è„ˆè±¡|ä¸­é†«è¨ºæ–·|è­‰åž‹è¨ºæ–·|ç—‡ç‹€æè¿°|æª¢æŸ¥å»ºè­°|æ²»ç™‚å»ºè­°|å¾©è¨ºå®‰æŽ’)', 'i');
          const match = tmplContent.match(pattern);
          return match ? match[1].trim() : '';
        } catch (_e) {
          return '';
        }
      }

      // ä¸»è¨´ï¼šè‹¥å·²æœ‰å…§å®¹ï¼Œå‰‡é™„åŠ æ¨¡æ¿çš„ä¸»è¨´æˆ–ç—‡ç‹€æè¿°åˆ°ç¾æœ‰å…§å®¹
      if (formSymptoms) {
        let value = '';
        if (template.chiefComplaint) {
          value = template.chiefComplaint;
        } else {
          // å˜—è©¦å¾ž content è§£æžã€Œä¸»è¨´ã€æˆ–ã€Œç—‡ç‹€æè¿°ã€
          value = parseSection('ä¸»è¨´');
          if (!value) {
            value = parseSection('ç—‡ç‹€æè¿°');
          }
          // è‹¥ä»ç„¡æ³•å–å¾—ï¼Œä½¿ç”¨æ•´æ®µ content
          if (!value && tmplContent) {
            value = tmplContent;
          }
        }
        // è‹¥å–å¾—å…§å®¹ï¼Œé™„åŠ æˆ–è¦†è“‹
        if (value) {
          if (formSymptoms.value && formSymptoms.value.trim()) {
            formSymptoms.value = formSymptoms.value.trim() + '\n' + value;
          } else {
            formSymptoms.value = value;
          }
        }
      }

      // ç¾ç—…å²ï¼šè¼‰å…¥å¾Œè¿½åŠ è‡³ã€Œä¸»è¨´åŠç¾ç—…å²ã€æ¬„ä½ï¼ˆformSymptomsï¼‰å¾Œæ–¹ã€‚
      // ä¸å†å¯«å…¥ formCurrentHistoryï¼Œä»¥å…æ··æ·†ã€‚
      {
        let value = '';
        if (template.currentHistory) {
          value = template.currentHistory;
        } else {
          value = parseSection('ç¾ç—…å²');
        }
        if (value && formSymptoms) {
          // å°‡ç¾ç—…å²å…§å®¹åŠ åœ¨ä¸»è¨´å…§å®¹ä¹‹å¾Œ
          if (formSymptoms.value && formSymptoms.value.trim()) {
            formSymptoms.value = formSymptoms.value.trim() + '\n' + value;
          } else {
            formSymptoms.value = value;
          }
        }
      }

      // èˆŒè±¡ï¼šè‹¥å·²æœ‰å…§å®¹ï¼Œé™„åŠ æ¨¡æ¿çš„èˆŒè±¡
      if (formTongue) {
        let value = '';
        if (template.tongue) {
          value = template.tongue;
        } else {
          value = parseSection('èˆŒè±¡');
        }
        if (value) {
          if (formTongue.value && formTongue.value.trim()) {
            formTongue.value = formTongue.value.trim() + '\n' + value;
          } else {
            formTongue.value = value;
          }
        }
      }

      // è„ˆè±¡ï¼šè‹¥å·²æœ‰å…§å®¹ï¼Œé™„åŠ æ¨¡æ¿çš„è„ˆè±¡
      if (formPulse) {
        let value = '';
        if (template.pulse) {
          value = template.pulse;
        } else {
          value = parseSection('è„ˆè±¡');
        }
        if (value) {
          if (formPulse.value && formPulse.value.trim()) {
            formPulse.value = formPulse.value.trim() + '\n' + value;
          } else {
            formPulse.value = value;
          }
        }
      }

      // ä¸­é†«è¨ºæ–·ï¼šè‹¥å·²æœ‰å…§å®¹ï¼Œé™„åŠ æ¨¡æ¿çš„è¨ºæ–·
      if (formDiagnosis) {
        let value = '';
        if (template.tcmDiagnosis) {
          value = template.tcmDiagnosis;
        } else {
          value = parseSection('ä¸­é†«è¨ºæ–·');
        }
        // è‹¥ä»ç„¡å…§å®¹ï¼Œä½¿ç”¨æ¨¡æ¿åç¨±ä½œç‚ºè¨ºæ–·
        if (!value && template.name) {
          value = template.name;
        }
        if (value) {
          if (formDiagnosis.value && formDiagnosis.value.trim()) {
            formDiagnosis.value = formDiagnosis.value.trim() + '\n' + value;
          } else {
            formDiagnosis.value = value;
          }
        }
      }

      // è­‰åž‹è¨ºæ–·ï¼šè‹¥å·²æœ‰å…§å®¹ï¼Œé™„åŠ æ¨¡æ¿çš„è­‰åž‹è¨ºæ–·
      if (formSyndrome) {
        let value = '';
        if (template.syndromeDiagnosis) {
          value = template.syndromeDiagnosis;
        } else {
          value = parseSection('è­‰åž‹è¨ºæ–·');
        }
        if (value) {
          if (formSyndrome.value && formSyndrome.value.trim()) {
            formSyndrome.value = formSyndrome.value.trim() + '\n' + value;
          } else {
            formSyndrome.value = value;
          }
        }
      }

      hideDiagnosisTemplateModal();
      showToast('å·²è¼‰å…¥è¨ºæ–·æ¨¡æ¿', 'success');
    } catch (err) {
      console.error('é¸æ“‡è¨ºæ–·æ¨¡æ¿éŒ¯èª¤:', err);
    }
  }

  // é¡¯ç¤ºé†«å›‘æ¨¡æ¿é¸æ“‡å½ˆçª—ï¼Œä¸¦å‹•æ…‹ç”Ÿæˆåˆ—è¡¨
  async function showPrescriptionTemplateModal() {
    /**
     * é¡¯ç¤ºé†«å›‘æ¨¡æ¿é¸æ“‡å½ˆçª—ã€‚æ­¤å‡½å¼æœƒåœ¨å¿…è¦æ™‚å…ˆåˆå§‹åŒ–æ¨¡æ¿åº«è³‡æ–™ï¼Œ
     * ç„¶å¾Œæ ¹æ“šç›®å‰çš„é†«å›‘æ¨¡æ¿æ¸…å–®å‹•æ…‹ç”¢ç”Ÿåˆ—è¡¨ã€‚è‹¥ç„¡å¯ç”¨æ¨¡æ¿ï¼Œ
     * å°‡é¡¯ç¤ºæç¤ºè¨Šæ¯ã€‚æ‰€æœ‰æ“ä½œåŒ…å«åœ¨ try/catch ä¸­ï¼Œä»¥é¿å…æ„å¤–éŒ¯èª¤ç ´å£ž UIã€‚
     */
    try {
      const modal = document.getElementById('prescriptionTemplateModal');
      const listEl = document.getElementById('prescriptionTemplateList');
      if (!modal || !listEl) return;
      // å¦‚æžœæ¨¡æ¿å°šæœªè¼‰å…¥ï¼Œå˜—è©¦å¾žè³‡æ–™åº«åˆå§‹åŒ–ã€‚
      if (!Array.isArray(prescriptionTemplates) || prescriptionTemplates.length === 0) {
        if (typeof initTemplateLibrary === 'function') {
          try {
            await initTemplateLibrary();
          } catch (e) {
            console.error('åˆå§‹åŒ–æ¨¡æ¿åº«è³‡æ–™å¤±æ•—:', e);
          }
        }
      }
      // åœ¨åˆ—è¡¨ä¸Šæ–¹æ”¾ç½®æœå°‹æ¬„ï¼Œè‹¥å°šæœªå­˜åœ¨å‰‡å»ºç«‹
      let searchInput = modal.querySelector('#prescriptionTemplateSearch');
      if (!searchInput) {
        searchInput = document.createElement('input');
        searchInput.id = 'prescriptionTemplateSearch';
        searchInput.type = 'text';
        searchInput.placeholder = 'æœå°‹é†«å›‘æ¨¡æ¿...';
        searchInput.className = 'w-full mb-3 px-3 py-2 border border-gray-300 rounded';
        listEl.parentNode.insertBefore(searchInput, listEl);
        searchInput.addEventListener('input', function() {
          // é‡æ–°æ¸²æŸ“åˆ—è¡¨
          showPrescriptionTemplateModal();
        });
      }
      listEl.innerHTML = '';
      const templates = Array.isArray(prescriptionTemplates) ? prescriptionTemplates : [];
      // å–å¾—æœå°‹å­—ä¸²
      const keyword = searchInput.value ? String(searchInput.value).trim().toLowerCase() : '';
      if (!templates || templates.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'text-sm text-gray-500 text-center p-4';
        emptyDiv.textContent = 'ç›®å‰å°šç„¡é†«å›‘æ¨¡æ¿ï¼Œè«‹å…ˆå»ºç«‹æˆ–åŒæ­¥æ¨¡æ¿è³‡æ–™ã€‚';
        listEl.appendChild(emptyDiv);
      } else {
        // éŽæ¿¾åˆ—è¡¨
        let filtered = templates;
        if (keyword) {
          filtered = templates.filter(t => {
            if (!t) return false;
            const name = (t.name || '').toLowerCase();
            const category = (t.category || '').toLowerCase();
            const content = (t.content || '').toLowerCase();
            return name.includes(keyword) || category.includes(keyword) || content.includes(keyword);
          });
        }
        // ä¾åç¨±æŽ’åº
        const sorted = filtered.slice().sort((a, b) => {
          const an = (a && a.name) ? a.name : '';
          const bn = (b && b.name) ? b.name : '';
          return an.localeCompare(bn, 'zh-Hans-CN', { sensitivity: 'base' });
        });
        sorted.forEach(template => {
          if (!template) return;
          const div = document.createElement('div');
          div.className = 'p-3 border border-gray-200 rounded-lg flex justify-between items-center hover:bg-gray-50';
          // å°æ¨¡æ¿åç¨±èˆ‡åˆ†é¡žé€²è¡Œè½‰ç¾©ï¼Œé¿å… XSS
          const safeName = template.name ? window.escapeHtml(template.name) : '';
          const safeCategory = template.category ? window.escapeHtml(template.category) : null;
          const categoryLine = safeCategory ? `<div class="text-sm text-gray-500">${safeCategory}</div>` : '';
          div.innerHTML = `
            <div>
              <div class="font-medium text-gray-800">${safeName}</div>
              ${categoryLine}
            </div>
            <button type="button" class="text-xs bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded select-prescription-btn" data-id="${template.id}">å¥—ç”¨</button>
          `;
          listEl.appendChild(div);
        });
        // ç‚ºæ¯å€‹æŒ‰éˆ•æŽ›ä¸Šäº‹ä»¶ç›£è½
        const buttons = listEl.querySelectorAll('.select-prescription-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', function (evt) {
            const tid = evt.currentTarget.getAttribute('data-id');
            // ä½¿ç”¨å…¨åŸŸæŽ›è¼‰çš„æ–°ç‰ˆå‡½å¼è¼‰å…¥é†«å›‘æ¨¡æ¿
            if (window && typeof window.selectPrescriptionTemplate === 'function') {
              window.selectPrescriptionTemplate(tid);
            }
          });
        });
      }
      modal.classList.remove('hidden');
    } catch (err) {
      console.error('é¡¯ç¤ºé†«å›‘æ¨¡æ¿å½ˆçª—å¤±æ•—:', err);
      showToast('ç„¡æ³•é¡¯ç¤ºé†«å›‘æ¨¡æ¿', 'error');
    }
  }

  function hidePrescriptionTemplateModal() {
    const modal = document.getElementById('prescriptionTemplateModal');
    if (modal) modal.classList.add('hidden');
  }

// å°‡èˆŠç‰ˆé†«å›‘æ¨¡æ¿è¼‰å…¥å‡½å¼é‡æ–°å‘½åç‚º _oldSelectPrescriptionTemplateï¼Œé¿å…èˆ‡æ–°ç‰ˆè¡çª
function _oldSelectPrescriptionTemplate(id) {
    /**
     * é¸æ“‡é†«å›‘æ¨¡æ¿ä¸¦å¥—ç”¨åˆ°è¡¨å–®ä¸­ã€‚æ­¤å‡½å¼æœƒä¾åºå˜—è©¦å¾žæ¨¡æ¿çš„ contentã€noteã€
     * duration ä»¥åŠ followUp ä¸­è§£æžå‡ºæœè—¥æ–¹æ³•ã€æ³¨æ„äº‹é …ã€ç™‚ç¨‹èˆ‡è¤‡è¨ºå¤©æ•¸ã€‚
     * å®Œæˆå¾Œå°‡å€¼å¡«å…¥å°æ‡‰è¡¨å–®æ¬„ä½ï¼Œä¸¦æ›´æ–°è¤‡è¨ºæ—¥æœŸã€‚
     */
    try {
      const templates = Array.isArray(prescriptionTemplates) ? prescriptionTemplates : [];
      // ä»¥ String æ¯”è¼ƒï¼Œç¢ºä¿ä¸åŒé¡žåž‹çš„è­˜åˆ¥å€¼ä¹Ÿèƒ½åŒ¹é…
      const template = templates.find(t => String(t.id) === String(id));
      if (!template) {
        showToast('æ‰¾ä¸åˆ°é¸å®šçš„é†«å›‘æ¨¡æ¿', 'warning');
        return;
      }
      const usageField = document.getElementById('formUsage');
      const treatmentField = document.getElementById('formTreatmentCourse');
      const instructionsField = document.getElementById('formInstructions');
      // å®šç¾©è§£æžå™¨ï¼šè§£æžæ–‡å­—ä»¥å–å¾— usageã€instructionsã€treatment
      const parseSections = text => {
        let usage = '';
        let instructions = '';
        let treatment = '';
        if (!text || typeof text !== 'string') return { usage, instructions, treatment };
        const contentStr = String(text);
        // å®šç¾©å„å€å¡Šæ¨™é¡Œçš„å€™é¸é—œéµå­—
        const usageMarkers = ['æœè—¥æ–¹æ³•', 'æœç”¨æ–¹æ³•', 'æœç”¨æ–¹å¼', 'ç”¨è—¥æŒ‡å°Ž', 'æœè—¥æŒ‡å—', 'æœç”¨æŒ‡å—', 'ä¸­è—¥æœç”¨æ–¹æ³•', 'è¥¿è—¥æœç”¨æ–¹æ³•'];
        const instructionMarkers = ['æ³¨æ„äº‹é …', 'æ³¨æ„äº‹é¡¹', 'æ³¨æ„è¦é»ž', 'æ³¨æ„è¦ç‚¹', 'æ³¨æ„äº‹é …åŠå®åš€', 'é†«å›‘', 'åŒ»å˜±', 'æ³¨æ„'];
        const treatmentMarkers = ['ç™‚ç¨‹å®‰æŽ’', 'ç–—ç¨‹å®‰æŽ’', 'ç™‚ç¨‹', 'ç–—ç¨‹', 'æ²»ç™‚è¨ˆåŠƒ', 'æ²»ç–—è®¡åˆ’', 'æ²»ç™‚å®‰æŽ’', 'æ²»ç–—å®‰æŽ’'];
        // æ”¶é›†æ‰€æœ‰æ¨™é¡Œä½ç½®
        let positions = [];
        const collectPositions = (markers, type) => {
          markers.forEach(mk => {
            const pos = contentStr.indexOf(mk);
            if (pos !== -1) {
              positions.push({ pos, marker: mk, type });
            }
          });
        };
        collectPositions(usageMarkers, 'usage');
        collectPositions(instructionMarkers, 'instructions');
        collectPositions(treatmentMarkers, 'treatment');
        if (positions.length > 0) {
          // ä¾ä½ç½®æŽ’åºï¼Œå¦‚ä½ç½®ç›¸åŒå‰‡è¼ƒé•·çš„æ¨™é¡Œå„ªå…ˆï¼ˆé¿å…è¼ƒçŸ­çš„é—œéµå­—è¦†è“‹æŽ‰å®Œæ•´æ¨™é¡Œï¼‰
          positions.sort((a, b) => {
            if (a.pos === b.pos) {
              return b.marker.length - a.marker.length;
            }
            return a.pos - b.pos;
          });
          // ç§»é™¤åŒä¸€ä½ç½®çš„é‡è¤‡æ¨™é¡Œï¼Œåªä¿ç•™æœ€é•·çš„é‚£å€‹ï¼Œé¿å…åƒã€Œæ³¨æ„ã€èˆ‡ã€Œæ³¨æ„äº‹é …ã€é‡è¤‡è§£æž
          const unique = [];
          positions.forEach(item => {
            if (unique.length === 0 || unique[unique.length - 1].pos !== item.pos) {
              unique.push(item);
            }
          });
          positions = unique;
          const assigned = { usage: false, instructions: false, treatment: false };
          for (let i = 0; i < positions.length; i++) {
            const { pos, marker, type } = positions[i];
            let start = pos + marker.length;
            // åŽ»é™¤å†’è™Ÿã€å…¨è§’å†’è™Ÿä»¥åŠç©ºç™½
            const afterMarker = contentStr.substring(start).replace(/^[\s:ï¼š]+/, '');
            start = pos + marker.length + (contentStr.substring(start).length - afterMarker.length);
            let end = contentStr.length;
            if (i + 1 < positions.length) {
              end = positions[i + 1].pos;
            }
            if (!assigned[type]) {
              const extracted = contentStr.substring(start, end).trim();
              if (type === 'usage') usage = extracted;
              if (type === 'instructions') instructions = extracted;
              if (type === 'treatment') treatment = extracted;
              assigned[type] = true;
            }
          }
        }
        return { usage, instructions, treatment };
      };
      // å„²å­˜æœ€çµ‚è§£æžçµæžœ
      let usage = '';
      let instructions = '';
      let treatment = '';
      // å…ˆå¾ž content è§£æž
      if (template.content && typeof template.content === 'string') {
        const parsed = parseSections(template.content);
        usage = parsed.usage;
        instructions = parsed.instructions;
        treatment = parsed.treatment;
      }
      // æŽ¥è‘—ä½¿ç”¨ note è£œå……è³‡æ–™ï¼šä¸è¦†å¯«æœè—¥æ–¹æ³•ï¼Œåƒ…è£œå……ç™‚ç¨‹èˆ‡å°‡æ•´æ®µæ³¨æ„äº‹é …åˆä½µè‡³é†«å›‘æ¬„
      if (template.note && typeof template.note === 'string' && template.note.trim()) {
        const noteStr = template.note.trim();
        // è§£æž note ä»¥å–å¾—ç™‚ç¨‹è³‡è¨Šï¼Œè‹¥ treatment å°šæœªå¡«å¯«å‰‡ä½¿ç”¨
        const parsedNote = parseSections(template.note);
        if (!treatment && parsedNote.treatment) {
          treatment = parsedNote.treatment;
        }
        // å°‡ note å…§å®¹åˆä½µåˆ° instructions æ¬„ä½ï¼Œé¿å…è¦†å¯«åŽŸæœ¬çš„æœè—¥æ–¹æ³•
        if (noteStr) {
          if (instructions) {
            // è‹¥ existing instructions ä¸­å°šæœªåŒ…å« noteï¼Œå‰‡ä»¥æ›è¡Œåˆ†éš”å¾Œè¿½åŠ 
            if (!instructions.includes(noteStr)) {
              instructions = instructions + (instructions.endsWith('\n') ? '' : '\n') + noteStr;
            }
          } else {
            instructions = noteStr;
          }
        }
      }
      // è‹¥ä»ç‚ºç©ºï¼Œç›´æŽ¥ä½¿ç”¨ note æˆ– content ä½œç‚º usage
      if (!usage) {
        if (template.note && typeof template.note === 'string' && template.note.trim()) {
          usage = template.note.trim();
        } else if (template.content && typeof template.content === 'string') {
          usage = template.content.trim();
        }
      }
      // è‹¥ instructions ç‚ºç©ºï¼Œä¸” note ä¸ç­‰æ–¼ usageï¼Œä½¿ç”¨ note ä½œç‚º instructions
      if (!instructions) {
        if (template.note && typeof template.note === 'string' && template.note.trim()) {
          if (template.note.trim() !== usage) {
            instructions = template.note.trim();
          }
        }
      }
      // è‹¥ treatment ç‚ºç©ºï¼Œä½¿ç”¨ duration
      if (!treatment) {
        if (template.duration && typeof template.duration === 'string') {
          treatment = template.duration;
        }
      }
      // å°‡å€¼å¡«å…¥è¡¨å–®æ¬„ä½
      if (usageField) usageField.value = usage || '';
      if (instructionsField) instructionsField.value = instructions || '';
      if (treatmentField) treatmentField.value = treatment || '';
      // è‡ªå‹•å¡«å…¥è¤‡è¨ºæ—¥æœŸ
      try {
        const followUpField = document.getElementById('formFollowUpDate');
        if (followUpField) {
          let days = 0;
          // 1. è§£æž template.followUp
          if (template.followUp && typeof template.followUp === 'string') {
            // å…ˆç§»é™¤æ‹¬è™Ÿä»¥æ”¯æ´æ ¼å¼å¦‚ã€Œ3ï¼ˆé€±ï¼‰ã€æˆ–ã€Œ7ï¼ˆå¤©ï¼‰ã€
            const fuClean = template.followUp.replace(/[()ï¼ˆï¼‰]/g, '');
            const numMatch = fuClean.match(/(\d+)/);
            if (numMatch) {
              const num = parseInt(numMatch[1], 10);
              if (!isNaN(num)) {
                if (/å¤©|æ—¥/.test(fuClean)) {
                  days = num;
                } else if (/é€±|å‘¨/.test(fuClean)) {
                  days = num * 7;
                } else if (/æœˆ/.test(fuClean)) {
                  days = num * 30;
                }
              }
            }
            // å¦‚æžœé‚„ç„¡æ³•è§£æžï¼Œä»æŽ¡ç”¨èˆŠæœ‰æ­£å‰‡ä½œç‚ºå¾Œå‚™
            if (!days) {
              let match;
              match = fuClean.match(/(\d+)\s*(?:å€‹)?\s*(å¤©|æ—¥)/);
              if (match) {
                const num = parseInt(match[1], 10);
                if (!isNaN(num)) days = num;
              }
              if (!days) {
                match = fuClean.match(/(\d+)\s*(?:å€‹)?\s*[é€±å‘¨]/);
                if (match) {
                  const num = parseInt(match[1], 10);
                  if (!isNaN(num)) days = num * 7;
                }
              }
              if (!days) {
                match = fuClean.match(/(\d+)\s*(?:å€‹)?\s*æœˆ/);
                if (match) {
                  const num = parseInt(match[1], 10);
                  if (!isNaN(num)) days = num * 30;
                }
              }
            }
          }
          // 2. è‹¥æœªå¾—å‡ºçµæžœï¼Œå¾ž content æœå°‹å›ž/è¤‡è¨º
          const searchFollowUp = (str) => {
            if (!str || typeof str !== 'string') return 0;
            const re = /(\d+)\s*(?:å€‹)?\s*(å¤©|æ—¥|é€±|å‘¨|æœˆ)\s*(?:å¾Œ)?\s*[å›žè¤‡å¾©å¤][è¨ºè¯Š]/g;
            let matches = [];
            let m;
            while ((m = re.exec(str)) !== null) {
              matches.push(m);
            }
            if (matches.length > 0) {
              const last = matches[matches.length - 1];
              const num = parseInt(last[1], 10);
              const unit = last[2];
              if (!isNaN(num)) {
                if (unit === 'å¤©' || unit === 'æ—¥') return num;
                if (unit === 'é€±' || unit === 'å‘¨') return num * 7;
                if (unit === 'æœˆ') return num * 30;
              }
            }
            return 0;
          };
          if (days <= 0 && template.content && typeof template.content === 'string') {
            days = searchFollowUp(template.content);
          }
          if (days <= 0 && template.note && typeof template.note === 'string') {
            days = searchFollowUp(template.note);
          }
          if (days > 0) {
            // å–å¾—åŸºæº–æ—¥æœŸï¼šå„ªå…ˆä½¿ç”¨ formVisitTimeï¼Œå¦å‰‡ç‚ºç•¶å‰æ™‚é–“
            let baseDate = new Date();
            const visitField = document.getElementById('formVisitTime');
            if (visitField && visitField.value) {
              const parsed = new Date(visitField.value);
              if (!isNaN(parsed.getTime())) {
                baseDate = parsed;
              }
            }
            const followDate = new Date(baseDate.getTime() + days * 24 * 60 * 60 * 1000);
            const y = followDate.getFullYear();
            const mStr = String(followDate.getMonth() + 1).padStart(2, '0');
            const dStr = String(followDate.getDate()).padStart(2, '0');
            const hStr = String(followDate.getHours()).padStart(2, '0');
            const minStr = String(followDate.getMinutes()).padStart(2, '0');
            followUpField.value = `${y}-${mStr}-${dStr}T${hStr}:${minStr}`;
            try {
              // æ´¾ç™¼äº‹ä»¶é€šçŸ¥å¯èƒ½çš„ç›£è½å™¨
              followUpField.dispatchEvent(new Event('change'));
              followUpField.dispatchEvent(new Event('input'));
            } catch (e) {
              // ignore event dispatch errors
            }
          }
        }
      } catch (fuErr) {
        // è‹¥è§£æžè¤‡è¨ºæ—¥æœŸå¤±æ•—å‰‡å¿½ç•¥ï¼Œä¸æç¤ºä½¿ç”¨è€…
        console.warn('è§£æžè¤‡è¨ºæ—¥æœŸå¤±æ•—ï¼š', fuErr);
      }
      hidePrescriptionTemplateModal();
      showToast('å·²è¼‰å…¥é†«å›‘æ¨¡æ¿', 'success');
    } catch (err) {
      console.error('é¸æ“‡é†«å›‘æ¨¡æ¿éŒ¯èª¤:', err);
      showToast('è¼‰å…¥é†«å›‘æ¨¡æ¿å¤±æ•—', 'error');
    }
  }

  // å°‡æ¨¡æ¿ç›¸é—œå‡½å¼æŽ›è¼‰è‡³å…¨åŸŸï¼Œä¾› HTML æŒ‰éˆ•èª¿ç”¨
  window.showDiagnosisTemplateModal = showDiagnosisTemplateModal;
  window.hideDiagnosisTemplateModal = hideDiagnosisTemplateModal;
  window.selectDiagnosisTemplate = selectDiagnosisTemplate;
  window.showPrescriptionTemplateModal = showPrescriptionTemplateModal;
  window.hidePrescriptionTemplateModal = hidePrescriptionTemplateModal;
  // å®šç¾©æ–°ç‰ˆè¼‰å…¥é†«å›‘æ¨¡æ¿å‡½å¼ï¼Œåƒ…è™•ç†ç™‚ç¨‹ã€ä¸­è—¥æœç”¨æ–¹æ³•ã€è¤‡è¨ºæ™‚é–“ã€é†«å›‘åŠæ³¨æ„äº‹é …
  function selectPrescriptionTemplate(id) {
    try {
      const templates = Array.isArray(prescriptionTemplates) ? prescriptionTemplates : [];
      const template = templates.find(t => String(t.id) === String(id));
      if (!template) {
        showToast('æ‰¾ä¸åˆ°é¸å®šçš„é†«å›‘æ¨¡æ¿', 'warning');
        return;
      }
      const usageField = document.getElementById('formUsage');
      const treatmentField = document.getElementById('formTreatmentCourse');
      const instructionsField = document.getElementById('formInstructions');
      const followUpField = document.getElementById('formFollowUpDate');
      if (treatmentField) treatmentField.value = (template.duration && typeof template.duration === 'string') ? template.duration.trim() : '';
      // ä¿®æ­£è¼‰å…¥é†«å›‘æ¨¡æ¿æ™‚å°‡ã€Œä¸­è—¥æœç”¨æ–¹æ³•ã€èˆ‡ã€Œé†«å›‘åŠæ³¨æ„äº‹é …ã€æ¬„ä½å°æ‡‰éŒ¯ç½®çš„å•é¡Œ
      // åœ¨ç·¨è¼¯æ¨¡æ¿ä»‹é¢ä¸­ï¼Œ`note` å°æ‡‰çš„æ˜¯ã€Œä¸­è—¥æœç”¨æ–¹æ³•ã€ï¼Œ`content` å°æ‡‰çš„æ˜¯ã€Œé†«å›‘å…§å®¹åŠæ³¨æ„äº‹é …ã€ã€‚
      // å› æ­¤åœ¨å¥—ç”¨æ¨¡æ¿æ™‚ï¼Œæ‡‰å°‡ note å¡«å…¥ä½¿ç”¨æ–¹å¼æ¬„ä½ï¼Œcontent å¡«å…¥é†«å›‘æ¬„ä½ã€‚
      if (usageField) {
        // åŽŸæœ¬è¼‰å…¥é†«å›‘æ¨¡æ¿æœƒè¦†è“‹ã€Œä¸­è—¥æœç”¨æ–¹æ³•ã€æ¬„ä½å…§å®¹ï¼Œéœ€æ±‚æ”¹ç‚ºä¿ç•™æ—¢æœ‰æ–‡å­—ä¸¦é™„åŠ æ¨¡æ¿ä¸­çš„ç”¨è—¥èªªæ˜Žã€‚
        const existingVal = usageField.value || '';
        // å–å¾—æ¨¡æ¿å…§çš„ noteï¼ˆå°æ‡‰ä¸­è—¥æœç”¨æ–¹æ³•ï¼‰ï¼Œä¸¦åŽ»é™¤é¦–å°¾ç©ºç™½
        const newNote = (template.note && typeof template.note === 'string') ? template.note.trim() : '';
        if (newNote) {
          if (existingVal) {
            // è‹¥å·²æœ‰å…§å®¹ï¼Œå‰‡åœ¨æœ«å°¾é™„åŠ æ–°å…§å®¹ï¼Œä¸¦åœ¨å…©è€…é–“åŠ å…¥æ›è¡Œç¬¦ä»¥å€éš”
            const separator = existingVal.endsWith('\n') ? '' : '\n';
            usageField.value = existingVal + separator + newNote;
          } else {
            // è‹¥åŽŸæœ¬æ²’æœ‰å…§å®¹ï¼Œç›´æŽ¥å¡«å…¥æ–°å…§å®¹
            usageField.value = newNote;
          }
        }
      }
      if (instructionsField) {
        instructionsField.value = (template.content && typeof template.content === 'string') ? template.content.trim() : '';
      }
      try {
        if (followUpField) {
          // å…ˆå˜—è©¦è§£æžå«æ‹¬è™Ÿçš„è¤‡è¨ºæ™‚é–“ã€‚ä¾‹å¦‚ã€Œ3ï¼ˆé€±ï¼‰ã€æ‡‰è§£æžç‚º 21 å¤©ã€‚
          let days = 0;
          if (template.followUp && typeof template.followUp === 'string') {
            // ç§»é™¤ä¸­è‹±æ–‡æ‹¬è™Ÿï¼Œé¿å…åƒã€Œ7ï¼ˆå¤©ï¼‰ã€é€™æ¨£çš„æ ¼å¼ç„¡æ³•è§£æž
            const fuClean = template.followUp.replace(/[()ï¼ˆï¼‰]/g, '');
            const numMatch = fuClean.match(/(\d+)/);
            if (numMatch) {
              const num = parseInt(numMatch[1], 10);
              if (!isNaN(num)) {
                if (/å¤©|æ—¥/.test(fuClean)) {
                  days = num;
                } else if (/é€±|å‘¨/.test(fuClean)) {
                  days = num * 7;
                } else if (/æœˆ/.test(fuClean)) {
                  days = num * 30;
                }
              }
            }
          }
          // è‹¥å°šæœªè§£æžå‡ºå¤©æ•¸ï¼Œé€€å›žåŽŸæœ¬çš„æ­£å‰‡åŒ¹é…é‚è¼¯
          if (days === 0 && template.followUp && typeof template.followUp === 'string') {
            let match;
            const fu = template.followUp;
            match = fu.match(/(\d+)\s*(?:å€‹)?\s*(å¤©|æ—¥)/);
            if (match) {
              const num = parseInt(match[1], 10);
              if (!isNaN(num)) days = num;
            }
            if (!days) {
              match = fu.match(/(\d+)\s*(?:å€‹)?\s*[é€±å‘¨]/);
              if (match) {
                const num = parseInt(match[1], 10);
                if (!isNaN(num)) days = num * 7;
              }
            }
            if (!days) {
              match = fu.match(/(\d+)\s*(?:å€‹)?\s*æœˆ/);
              if (match) {
                const num = parseInt(match[1], 10);
                if (!isNaN(num)) days = num * 30;
              }
            }
          }
          if (days > 0) {
            // å–å¾—åŸºæº–æ—¥æœŸï¼šå„ªå…ˆä½¿ç”¨ formVisitTimeï¼Œå¦å‰‡ç‚ºç•¶å‰æ™‚é–“
            let baseDate = new Date();
            const visitField = document.getElementById('formVisitTime');
            if (visitField && visitField.value) {
              const parsed = new Date(visitField.value);
              if (!isNaN(parsed.getTime())) {
                baseDate = parsed;
              }
            }
            const followDate = new Date(baseDate.getTime() + days * 24 * 60 * 60 * 1000);
            const y = followDate.getFullYear();
            const mStr = String(followDate.getMonth() + 1).padStart(2, '0');
            const dStr = String(followDate.getDate()).padStart(2, '0');
            const hStr = String(followDate.getHours()).padStart(2, '0');
            const minStr = String(followDate.getMinutes()).padStart(2, '0');
            followUpField.value = `${y}-${mStr}-${dStr}T${hStr}:${minStr}`;
            try {
              // æ´¾ç™¼äº‹ä»¶ï¼Œè®“å¯èƒ½çš„ç›£è½å™¨èƒ½æ•æ‰åˆ°è®ŠåŒ–
              followUpField.dispatchEvent(new Event('change'));
              followUpField.dispatchEvent(new Event('input'));
            } catch (e) {
              // å¿½ç•¥äº‹ä»¶æ´¾ç™¼éŒ¯èª¤
            }
          }
        }
      } catch (fuErr) {
        console.warn('è§£æžè¤‡è¨ºæ—¥æœŸå¤±æ•—ï¼š', fuErr);
      }
      hidePrescriptionTemplateModal();
      showToast('å·²è¼‰å…¥é†«å›‘æ¨¡æ¿', 'success');
    } catch (err) {
      console.error('é¸æ“‡é†«å›‘æ¨¡æ¿éŒ¯èª¤:', err);
      showToast('è¼‰å…¥é†«å›‘æ¨¡æ¿å¤±æ•—', 'error');
    }
  }
  // å°‡æ–°ç‰ˆå‡½å¼æŽ›è¼‰åˆ°å…¨åŸŸ
  window.selectPrescriptionTemplate = selectPrescriptionTemplate;

  // ä»¥ä¸‹ç‚ºå°è£è¨ºæ–·æ¨¡æ¿èˆ‡é†«å›‘æ¨¡æ¿è¼‰å…¥æŒ‰éˆ•çš„å‡½å¼ã€‚
  // æŒ‰ä¸‹è¼‰å…¥æŒ‰éˆ•æ™‚é¡¯ç¤ºè®€å–åœˆï¼Œç¨ä½œå»¶é²å¾Œå†æ‰“é–‹å°æ‡‰çš„æ¨¡æ¿å½ˆçª—ï¼Œä¸¦æ–¼å®Œæˆå¾Œæ¢å¾©åŽŸå§‹æŒ‰éˆ•å…§å®¹ã€‚
  async function openDiagnosisTemplate(ev) {
    let btn = null;
    try {
      if (ev && ev.currentTarget) btn = ev.currentTarget;
      if (!btn) {
        btn = document.querySelector('button[onclick*="openDiagnosisTemplate"]');
      }
      if (btn) {
        setButtonLoading(btn);
      }
      await new Promise(resolve => setTimeout(resolve, 200));
      if (typeof showDiagnosisTemplateModal === 'function') {
        showDiagnosisTemplateModal();
      }
    } catch (err) {
      console.error('é–‹å•Ÿè¨ºæ–·æ¨¡æ¿æŒ‰éˆ•éŒ¯èª¤:', err);
    } finally {
      if (btn) {
        clearButtonLoading(btn);
      }
    }
  }

  async function openPrescriptionTemplate(ev) {
    let btn = null;
    try {
      // æ‰¾åˆ°è§¸ç™¼æŒ‰éˆ•
      if (ev && ev.currentTarget) btn = ev.currentTarget;
      if (!btn) {
        // å¾Œå‚™æœå°‹é é¢ä¸­çš„æŒ‰éˆ•
        btn = document.querySelector('button[onclick*="openPrescriptionTemplate"]');
      }
      if (btn) {
        setButtonLoading(btn);
      }
      // è‹¥æ¨¡æ¿å°šæœªè¼‰å…¥ï¼Œå˜—è©¦åˆå§‹åŒ–æ¨¡æ¿åº«
      if (!Array.isArray(prescriptionTemplates) || prescriptionTemplates.length === 0) {
        if (typeof initTemplateLibrary === 'function') {
          try {
            await initTemplateLibrary();
          } catch (initErr) {
            console.error('åˆå§‹åŒ–æ¨¡æ¿åº«å¤±æ•—:', initErr);
          }
        }
      }
      // å°å»¶é²è®“ä½¿ç”¨è€…æ„Ÿå—è®€å–åé¥‹
      await new Promise(resolve => setTimeout(resolve, 200));
      if (typeof showPrescriptionTemplateModal === 'function') {
        // ä½¿ç”¨ await ä»¥ç¢ºä¿å¦‚æœ‰ç•°æ­¥æ“ä½œå®Œæˆå¾Œå†ç¹¼çºŒ
        await showPrescriptionTemplateModal();
      }
    } catch (err) {
      console.error('é–‹å•Ÿé†«å›‘æ¨¡æ¿æŒ‰éˆ•éŒ¯èª¤:', err);
      showToast('è¼‰å…¥é†«å›‘æ¨¡æ¿å¤±æ•—', 'error');
    } finally {
      if (btn) {
        clearButtonLoading(btn);
      }
    }
  }

  // å°‡å°è£å‡½å¼æŽ›è¼‰è‡³å…¨åŸŸï¼Œä¾› HTML ç›´æŽ¥èª¿ç”¨
  window.openDiagnosisTemplate = openDiagnosisTemplate;
  window.openPrescriptionTemplate = openPrescriptionTemplate;

  /**
   * åœ¨ä½¿ç”¨è€…å˜—è©¦ç›´æŽ¥é—œé–‰æˆ–é‡æ–°æ•´ç†ç¶²é æ™‚æç¤ºç¢ºèªï¼Œé¿å…æœªä¿å­˜çš„å¥—ç¥¨ä½¿ç”¨ç´€éŒ„è¢«èª¤åˆ¤ç‚ºå–æ¶ˆã€‚
   *
   * å…ˆå‰çš„å¯¦ä½œä¸­æœƒåœ¨å–æ¶ˆè¨ºç—‡æˆ–é€€å‡ºç·¨è¼¯æ™‚ï¼Œå°‡ pendingPackageChanges ä¸­çš„è®Šæ›´å›žå¾©ã€‚
   * ä½†å¦‚æžœä½¿ç”¨è€…ç›´æŽ¥é—œé–‰ç€è¦½å™¨é ç±¤æˆ–åˆ·æ–°é é¢ï¼Œé€™äº›è®Šæ›´ä¸æ‡‰è‡ªå‹•å›žå¾©ï¼Œ
   * å¦å‰‡å°‡å°Žè‡´å¥—ç¥¨æ¬¡æ•¸è¢«ç„¡æ„é–“åŠ å›žã€‚ç‚ºæ­¤ï¼ŒåŠ å…¥ beforeunload ç›£è½å™¨ï¼Œ
   * ç•¶å­˜åœ¨æœªä¿å­˜çš„å¥—ç¥¨è®Šæ›´æ™‚ï¼Œæç¤ºä½¿ç”¨è€…ç¢ºèªé›¢é–‹ã€‚è‹¥ä½¿ç”¨è€…ä»é¸æ“‡é›¢é–‹ï¼Œ
   * æˆ‘å€‘ä¸æœƒåŸ·è¡Œ revertPendingPackageChangesï¼Œè€Œæ˜¯ä¿ç•™ç›®å‰è³‡æ–™åº«ä¸­çš„å¥—ç¥¨ç‹€æ…‹ã€‚
   */
  window.addEventListener('beforeunload', function (e) {
    try {
      // è‹¥æœ‰æš«å­˜çš„å¥—ç¥¨ä½¿ç”¨è®Šæ›´å°šæœªæ­£å¼ä¿å­˜ï¼Œå‰‡æç¤ºç¢ºèªé›¢é–‹
      if (pendingPackageChanges && pendingPackageChanges.length > 0) {
        // é˜»æ­¢é è¨­è¡Œç‚ºï¼Œä¸¦è¨­ç½® returnValue ä»¥ç¬¦åˆéƒ¨åˆ†ç€è¦½å™¨è¦æ±‚
        e.preventDefault();
        e.returnValue = '';
      }
    } catch (_e) {
      // å¿½ç•¥æ„å¤–éŒ¯èª¤ï¼Œé¿å…å½±éŸ¿é›¢é–‹æµç¨‹
    }
  });

  /**
   * åœ¨é é¢å¸è¼‰æ™‚æ¸…ç©ºæš«å­˜çš„å¥—ç¥¨è®Šæ›´ã€‚
   *
   * é›¢é–‹é é¢å¾Œï¼Œè¨˜æ†¶é«”ä¸­çš„ pendingPackageChanges å°‡æœƒå¤±æ•ˆï¼Œä¸éŽåœ¨æŸäº›ç€è¦½å™¨ä¸­
   * ä»æœ‰å¯èƒ½åœ¨å¾ŒçºŒåŸ·è¡ŒéžåŒæ­¥æˆ–åŒæ­¥å›žèª¿æ™‚å¼•ç”¨åˆ°èˆŠè³‡æ–™ã€‚ç‚ºå®‰å…¨èµ·è¦‹ï¼Œåœ¨ unload äº‹ä»¶
   * ä¸­é¡¯å¼å°‡æš«å­˜è®Šæ›´æ¸…ç©ºï¼Œç¢ºä¿å¾ŒçºŒä¸æœƒèª¤åˆ¤ç‚ºéœ€è¦å›žå¾©ã€‚
   */
  window.addEventListener('unload', function () {
    try {
      pendingPackageChanges = [];
    } catch (_e) {
      // è‹¥ç„¡æ³•æ¸…ç©ºï¼Œç•¥éŽå³å¯ï¼›åˆ·æ–°å¾Œæ­¤è®Šæ•¸æœƒé‡æ–°åˆå§‹åŒ–
    }
  });
})();
          // åˆ†é¡žæ•¸æ“š
          let categories = {
            herbs: ['æ„Ÿå†’é¡ž', 'æ¶ˆåŒ–ç³»çµ±', 'å©¦ç§‘èª¿ç†', 'è£œç›Šé¡ž', 'æ¸…ç†±é¡ž'],
            acupoints: ['é ­é¢éƒ¨', 'èƒ¸è…¹éƒ¨', 'å››è‚¢éƒ¨', 'èƒŒè…°éƒ¨', 'å…§ç§‘ç–¾ç—…', 'å©¦ç§‘ç–¾ç—…'],
            prescriptions: ['ç”¨è—¥æŒ‡å°Ž', 'ç”Ÿæ´»èª¿ç†', 'é£²é£Ÿå»ºè­°', 'é‹å‹•æŒ‡å°Ž', 'å¾©è¨ºæé†’', 'æ…¢æ€§ç—…ç®¡ç†', 'å©¦ç§‘èª¿ç†'],
            diagnosis: ['å…§ç§‘', 'å©¦ç§‘', 'å…’ç§‘', 'çš®è†šç§‘', 'éª¨å‚·ç§‘']
          };

          // å°‡åˆ†é¡žè³‡æ–™å…¬é–‹åˆ°å…¨åŸŸï¼Œè®“å…¶ä»–æ¨¡çµ„èƒ½å¤ è®€å–èˆ‡æ›´æ–°
          window.categories = categories;

          // -----------------------------------------------------------------------------
          // å€‹äººæ…£ç”¨è—¥æ–¹çµ„åˆåŠç©´ä½çµ„åˆçš„åˆ†é¡žï¼ˆç®¡ç†åˆ†é¡žï¼‰
          //
          // é€™äº›åˆ†é¡žç”¨æ–¼å¸¸ç”¨ä¸­è—¥çµ„åˆèˆ‡ç©´ä½çµ„åˆçš„ç®¡ç†ï¼Œå¯ä¾å€‹äººåå¥½èª¿æ•´ã€‚
          // é è¨­å€¼å–è‡ªå…¨åŸŸ categories.herbs èˆ‡ categories.acupointsï¼Œ
          // ä½†ç•¶ç”¨æˆ¶åœ¨å€‹äººè¨­å®šä¸­å¦è¡ŒæŒ‡å®šæ™‚æœƒè¢«è¦†è“‹ã€‚
          // é€éŽ window æ›éœ²è®“å…¶ä»–æ¨¡çµ„å¯ä»¥å­˜å–èˆ‡æ›´æ–°ã€‚
          let herbComboCategories = Array.isArray(categories.herbs) ? [...categories.herbs] : [];
          let acupointComboCategories = Array.isArray(categories.acupoints) ? [...categories.acupoints] : [];
          window.herbComboCategories = herbComboCategories;
          window.acupointComboCategories = acupointComboCategories;

        /**
         * åŒæ­¥å€‹äººæ…£ç”¨çµ„åˆåˆ†é¡žèˆ‡å…¨åŸŸåˆ†é¡žã€‚
         * ç•¶æ›´æ–° categories.herbs æˆ– categories.acupoints æ™‚ï¼Œ
         * å¦‚æžœå€‹äººåˆ†é¡žå°šæœªè¨­å®šæˆ–è€…èˆ‡å…¨åŸŸåˆ†é¡žä¿æŒä¸€è‡´ï¼Œ
         * å‰‡ä»¥æœ€æ–°çš„å…¨åŸŸåˆ†é¡žè¦†è“‹å€‹äººåˆ†é¡žã€‚æ­¤å‡½å¼ä¹Ÿæœƒæ›´æ–°å°æ‡‰çš„ window
         * è®Šæ•¸ï¼Œä»¥ä¾¿å…¶ä»–æ¨¡çµ„ç«‹å³å–å¾—æ­£ç¢ºçš„åˆ†é¡žè³‡æ–™ã€‚
         *
         * @param {string} type - è¦åŒæ­¥çš„åˆ†é¡žé¡žåž‹ï¼ˆ'herbs' æˆ– 'acupoints'ï¼‰
         */
        function refreshComboCategories(type) {
          try {
            if (type === 'herbs') {
              // è‹¥å€‹äººä¸­è—¥åˆ†é¡žä¸å­˜åœ¨ã€é•·åº¦èˆ‡å…¨åŸŸè³‡æ–™ä¸ä¸€è‡´ï¼Œæˆ–æœ‰ä»»æ„é …ç›®ä¸åŒï¼Œå‰‡é‡æ–°åŒæ­¥
              if (!Array.isArray(herbComboCategories) ||
                  herbComboCategories.length !== (categories.herbs ? categories.herbs.length : 0) ||
                  !herbComboCategories.every((c, idx) => categories.herbs && categories.herbs[idx] === c)) {
                herbComboCategories = Array.isArray(categories.herbs) ? [...categories.herbs] : [];
                window.herbComboCategories = herbComboCategories;
              }
            } else if (type === 'acupoints') {
              // åŒæ­¥ç©´ä½åˆ†é¡žï¼Œæ¢ä»¶åŒä¸Š
              if (!Array.isArray(acupointComboCategories) ||
                  acupointComboCategories.length !== (categories.acupoints ? categories.acupoints.length : 0) ||
                  !acupointComboCategories.every((c, idx) => categories.acupoints && categories.acupoints[idx] === c)) {
                acupointComboCategories = Array.isArray(categories.acupoints) ? [...categories.acupoints] : [];
                window.acupointComboCategories = acupointComboCategories;
              }
            }
          } catch (e) {
            console.error('åˆ·æ–°å€‹äººçµ„åˆåˆ†é¡žå¤±æ•—:', e);
          }

          // æ›´æ–°åˆ†é¡žå¾Œï¼Œé‡æ–°å»ºç«‹å€‹äººçµ„åˆæœå°‹èˆ‡åˆ†é¡žä»‹é¢ï¼Œä»¥åæ˜ æœ€æ–°çš„åˆ†é¡žè³‡æ–™
          try {
            if (typeof setupPersonalComboSearchAndFilter === 'function') {
              setupPersonalComboSearchAndFilter();
            }
          } catch (_e) {
            // è‹¥åˆå§‹åŒ–å¤±æ•—ï¼Œä¸é˜»æ–·æµç¨‹
          }
        }

/**
 * åˆ·æ–°æ¨¡æ¿åº«çš„åˆ†é¡žç¯©é¸ä¸‹æ‹‰é¸å–®ã€‚
 * æ­¤å‡½å¼æœƒæ ¹æ“šæœ€æ–°çš„ categories.prescriptions å’Œ categories.diagnosis
 * æ›´æ–°é†«å›‘æ¨¡æ¿èˆ‡è¨ºæ–·æ¨¡æ¿çš„åˆ†é¡žé¸æ“‡å™¨ï¼Œä»¥ä¾¿åœ¨æ¨¡æ¿åº«é é¢èƒ½å¤ é¡¯ç¤ºæ‰€æœ‰
 * å¯ç”¨åˆ†é¡žé€²è¡Œç¯©é¸ã€‚è‹¥ç•¶å‰é¸ä¸­çš„å€¼ä»å­˜åœ¨æ–¼æ–°çš„åˆ†é¡žæ¸…å–®ä¸­ï¼Œå‰‡ç¶­æŒé¸ä¸­ï¼›
 * å¦å‰‡æ¢å¾©åˆ°é è¨­çš„ã€Œå…¨éƒ¨é¡žåˆ¥ã€æˆ–ã€Œå…¨éƒ¨ç§‘åˆ¥ã€ã€‚
 */
function refreshTemplateCategoryFilters() {
  try {
    // é†«å›‘æ¨¡æ¿åˆ†é¡žç¯©é¸
    const pFilter = document.getElementById('prescriptionTemplateCategoryFilter');
    if (pFilter) {
      // ä¿å­˜ç›®å‰é¸ä¸­å€¼
      const prevValue = pFilter.value;
      // æ¸…ç©ºä¸¦æ·»åŠ é è¨­é¸é …
      pFilter.innerHTML = '';
      const defaultOpt = document.createElement('option');
      defaultOpt.value = 'å…¨éƒ¨é¡žåˆ¥';
      defaultOpt.textContent = 'å…¨éƒ¨é¡žåˆ¥';
      pFilter.appendChild(defaultOpt);
      // åŠ å…¥æ‰€æœ‰é†«å›‘åˆ†é¡ž
      const pCats = (categories && Array.isArray(categories.prescriptions)) ? categories.prescriptions : [];
      pCats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        pFilter.appendChild(opt);
      });
      // æ¢å¾©å…ˆå‰é¸é …ï¼ˆè‹¥ä»å­˜åœ¨ï¼‰
      if (prevValue && Array.from(pFilter.options).some(o => o.value === prevValue)) {
        pFilter.value = prevValue;
      } else {
        pFilter.value = 'å…¨éƒ¨é¡žåˆ¥';
      }
    }
    // è¨ºæ–·æ¨¡æ¿åˆ†é¡žç¯©é¸
    const dFilter = document.getElementById('diagnosisTemplateCategoryFilter');
    if (dFilter) {
      const prevValue2 = dFilter.value;
      dFilter.innerHTML = '';
      const defaultOpt2 = document.createElement('option');
      // ä½¿ç”¨åŽŸæœ¬çš„é è¨­æ–‡æ¡ˆç‚ºã€Œå…¨éƒ¨ç§‘åˆ¥ã€ï¼Œè‹¥éœ€è¦äº¦å¯ä½¿ç”¨ã€Œå…¨éƒ¨åˆ†é¡žã€
      defaultOpt2.value = 'å…¨éƒ¨ç§‘åˆ¥';
      defaultOpt2.textContent = 'å…¨éƒ¨ç§‘åˆ¥';
      dFilter.appendChild(defaultOpt2);
      const dCats = (categories && Array.isArray(categories.diagnosis)) ? categories.diagnosis : [];
      dCats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        dFilter.appendChild(opt);
      });
      if (prevValue2 && Array.from(dFilter.options).some(o => o.value === prevValue2)) {
        dFilter.value = prevValue2;
      } else {
        dFilter.value = 'å…¨éƒ¨ç§‘åˆ¥';
      }
    }
  } catch (e) {
    console.error('åˆ·æ–°æ¨¡æ¿åˆ†é¡žç¯©é¸ä¸‹æ‹‰é¸å–®å¤±æ•—:', e);
  }
}

        /**
         * å¾ž Firebase åˆå§‹åŒ–åˆ†é¡žè³‡æ–™ã€‚
         * å˜—è©¦è®€å–ä½æ–¼ 'categories/default' çš„æ–‡æª”ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å¯«å…¥ç•¶å‰é è¨­åˆ†é¡žã€‚
         * è®€å–æˆåŠŸå¾Œæœƒæ›´æ–° categories ç‰©ä»¶ä»¥åŠ window.categoriesã€‚
         */
        async function initCategoryData() {
          // å„ªå…ˆå¾žæœ¬åœ°è¼‰å…¥åˆ†é¡žè³‡æ–™
          let stored;
          try {
            stored = localStorage.getItem('categories');
            if (stored) {
              const localData = JSON.parse(stored);
              if (localData && typeof localData === 'object') {
                if (Array.isArray(localData.herbs)) categories.herbs = localData.herbs;
                if (Array.isArray(localData.acupoints)) categories.acupoints = localData.acupoints;
                if (Array.isArray(localData.prescriptions)) categories.prescriptions = localData.prescriptions;
                if (Array.isArray(localData.diagnosis)) categories.diagnosis = localData.diagnosis;
                // æ›´æ–°å…¨åŸŸå¼•ç”¨
                window.categories = categories;
                // æ›´æ–°æ¨¡æ¿åº«åˆ†é¡žç¯©é¸ä¸‹æ‹‰é¸å–®ï¼Œä»¥é¡¯ç¤ºæœ€æ–°çš„é†«å›‘èˆ‡è¨ºæ–·åˆ†é¡ž
                if (typeof refreshTemplateCategoryFilters === 'function') {
                  try {
                    refreshTemplateCategoryFilters();
                  } catch (_e) {}
                }
              }
            }
          } catch (err) {
            console.error('å¾žæœ¬åœ°è¼‰å…¥åˆ†é¡žè³‡æ–™å¤±æ•—:', err);
          }

          // å¦‚æžœæœ¬åœ°å·²ç¶“è¼‰å…¥åˆ†é¡žè³‡æ–™ï¼Œå‰‡ä¸å†å¾ž Firebase è®€å–ï¼Œæ¸›å°‘è®€å–é‡
          if (stored) {
            return;
          }

          // è‹¥ Firebase æœªå®šç¾©æˆ–ç¼ºå°‘ getDocï¼Œå‰‡ç›´æŽ¥çµæŸï¼Œä½¿ç”¨é è¨­æˆ–æœ¬åœ°è³‡æ–™
          if (!window.firebase || !window.firebase.getDoc || !window.firebase.doc || !window.firebase.db) {
            return;
          }

          // ç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆ
          await waitForFirebaseDb();
          try {
            const docRef = window.firebase.doc(window.firebase.db, 'categories', 'default');
            const docSnap = await window.firebase.getDoc(docRef);
            if (docSnap && docSnap.exists()) {
              const data = docSnap.data();
              if (data && typeof data === 'object') {
                if (Array.isArray(data.herbs)) {
                  categories.herbs = data.herbs;
                }
                if (Array.isArray(data.acupoints)) {
                  categories.acupoints = data.acupoints;
                }
                if (Array.isArray(data.prescriptions)) {
                  categories.prescriptions = data.prescriptions;
                }
                if (Array.isArray(data.diagnosis)) {
                  categories.diagnosis = data.diagnosis;
                }
              }
            } else {
              // è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ä¸€ä»½åŒ…å«ç•¶å‰åˆ†é¡žçš„æ–‡æª”
              await window.firebase.setDoc(docRef, {
                herbs: categories.herbs,
                acupoints: categories.acupoints,
                prescriptions: categories.prescriptions,
                diagnosis: categories.diagnosis
              });
            }
            // æ›´æ–°å…¨åŸŸå¼•ç”¨
            window.categories = categories;
            // æ›´æ–°æ¨¡æ¿åº«åˆ†é¡žç¯©é¸ä¸‹æ‹‰é¸å–®ï¼Œä»¥é¡¯ç¤ºæœ€æ–°çš„é†«å›‘èˆ‡è¨ºæ–·åˆ†é¡ž
            if (typeof refreshTemplateCategoryFilters === 'function') {
              try {
                refreshTemplateCategoryFilters();
              } catch (_e) {}
            }
          } catch (error) {
            console.error('è®€å–/åˆå§‹åŒ–åˆ†é¡žè³‡æ–™å¤±æ•—:', error);
          }
        }

        /**
         * å°‡æœ€æ–°çš„åˆ†é¡žè³‡æ–™å¯«å…¥ Firebaseã€‚
         * é€™æœƒè¦†è“‹å­˜å„²åœ¨ 'categories/default' æ–‡æª”ä¸­çš„ existing è³‡æ–™ã€‚
         */
        async function saveCategoriesToFirebase() {
          try {
            // Firebase ä¸å†ä½¿ç”¨ï¼šåƒ…å°‡åˆ†é¡žè³‡æ–™å„²å­˜è‡³ localStorage
            localStorage.setItem('categories', JSON.stringify(categories));
          } catch (err) {
            console.error('ä¿å­˜åˆ†é¡žè³‡æ–™è‡³æœ¬åœ°å¤±æ•—:', err);
          }
        }

        /**
         * å°‡ç•¶å‰åˆ†é¡žè³‡æ–™å¯«å…¥ç€è¦½å™¨çš„ localStorageã€‚
         * Firebase è‹¥ä¸å¯ç”¨æˆ–å¯«å…¥å¤±æ•—ï¼Œä»å¯é€šéŽæ­¤å‡½å¼ç¢ºä¿åˆ†é¡žè¨­å®šä¸æœƒéºå¤±ã€‚
         */
        function persistCategoriesLocally() {
          try {
            localStorage.setItem('categories', JSON.stringify(categories));
          } catch (err) {
            console.error('æœ¬åœ°ä¿å­˜åˆ†é¡žè³‡æ–™å¤±æ•—:', err);
          }
        }

          // æ•¸æ“šå­˜å„²
          // ç§»é™¤é è¨­çš„ä¸­è—¥çµ„åˆç¯„ä¾‹ï¼Œé è¨­ç‚ºç©ºé™£åˆ—ã€‚
          let herbCombinations = [];

          // ç§»é™¤é è¨­çš„ç©´ä½çµ„åˆç¯„ä¾‹ï¼Œé è¨­ç‚ºç©ºé™£åˆ—ã€‚
          let acupointCombinations = [];

          let prescriptionTemplates = [
            {
              id: 1,
              name: 'æ„Ÿå†’ç”¨è—¥æŒ‡å°Žæ¨¡æ¿',
              category: 'ç”¨è—¥æŒ‡å°Ž',
              duration: '7å¤©',
              followUp: '3å¤©å¾Œ',
              content: 'æœè—¥æ–¹æ³•ï¼šæ¯æ—¥ä¸‰æ¬¡ï¼Œé£¯å¾Œ30åˆ†é˜æº«æœã€‚æœè—¥æœŸé–“å¤šå–æº«é–‹æ°´ã€‚é¿å…ç”Ÿå†·ã€æ²¹è†©ã€è¾›è¾£é£Ÿç‰©ã€‚æ³¨æ„äº‹é …ï¼šå……åˆ†ä¼‘æ¯ï¼Œé¿å…ç†¬å¤œã€‚å¦‚ç—‡ç‹€åŠ é‡æˆ–æŒçºŒç™¼ç‡’è«‹ç«‹å³å›žè¨ºã€‚ç™‚ç¨‹å®‰æŽ’ï¼šå»ºè­°ç™‚ç¨‹7å¤©ï¼Œæœè—¥3å¤©å¾Œå›žè¨ºè©•ä¼°ã€‚',
              note: '',
              lastModified: '2024-02-15'
            }
          ];

          let diagnosisTemplates = [
            {
              id: 1,
              name: 'æ„Ÿå†’è¨ºæ–·æ¨¡æ¿',
              category: 'å…§ç§‘',
              content: 'ç—‡ç‹€æè¿°ï¼šæ‚£è€…è¡¨ç¾ç‚ºé¼»å¡žã€å–‰åš¨ç—›ã€å’³å—½ç­‰ç—‡ç‹€ã€‚æª¢æŸ¥å»ºè­°ï¼šè§€å¯Ÿå’½éƒ¨ç´…è…«ç‹€æ³ï¼Œæ¸¬é‡é«”æº«ã€‚æ²»ç™‚å»ºè­°ï¼šå»ºè­°ä½¿ç”¨ç–é¢¨è§£è¡¨é¡žä¸­è—¥ï¼Œæ­é…ä¼‘æ¯å’Œå¤šå–æ°´ã€‚å¾©è¨ºå®‰æŽ’ï¼š3å¤©å¾Œå›žè¨ºã€‚',
              lastModified: '2024-01-20'
            }
          ];

          // æ¸²æŸ“ä¸­è—¥çµ„åˆ
          function renderHerbCombinations(pageChange = false) {
            const container = document.getElementById('herbCombinationsContainer');
            if (!container) return;
            container.innerHTML = '';
            // æ›´æ–°ä¸­è—¥çµ„åˆç¸½æ•¸è‡³æ¨™ç±¤é¡¯ç¤º
            try {
              const totalCount = Array.isArray(herbCombinations)
                ? herbCombinations.filter(item => item && item.name && String(item.name).trim() !== '').length
                : 0;
              const countElem = document.getElementById('herbCount');
              if (countElem) {
                countElem.textContent = String(totalCount);
              }
            } catch (_e) {}
            // æ ¹æ“šæœå°‹é—œéµå­—èˆ‡åˆ†é¡žç¯©é¸æ¸…å–®
            let searchTerm = '';
            ['herbComboSearch', 'searchHerbCombo', 'searchHerbCombination', 'herbComboSearchInput'].some(id => {
              const el = document.getElementById(id);
              if (el) {
                searchTerm = (el.value || '').trim().toLowerCase();
                return true;
              }
              return false;
            });
            let selectedCategory = 'all';
            ['herbComboCategoryFilter', 'herbComboCategory', 'herbComboCategorySelect'].some(id => {
              const el = document.getElementById(id);
              if (el) {
                selectedCategory = el.value;
                return true;
              }
              return false;
            });
            let list = herbCombinations;
            if (searchTerm || (selectedCategory && selectedCategory !== 'all' && selectedCategory !== '')) {
              list = herbCombinations.filter(item => {
                let matchesSearch = true;
                if (searchTerm) {
                  const nameMatch = item.name && item.name.toLowerCase().includes(searchTerm);
                  const descMatch = item.description && item.description.toLowerCase().includes(searchTerm);
                  const ingredientsMatch = Array.isArray(item.ingredients) && item.ingredients.some(ing => {
                    return ing && ing.name && ing.name.toLowerCase().includes(searchTerm);
                  });
                  matchesSearch = nameMatch || descMatch || ingredientsMatch;
                }
                let matchesCategory = true;
                if (selectedCategory && selectedCategory !== 'all' && selectedCategory !== '') {
                  matchesCategory = item.category === selectedCategory;
                }
                return matchesSearch && matchesCategory;
              });
            }
            // éŽæ¿¾æŽ‰æœªå‘½åçš„æ–°å»ºçµ„åˆ
            list = Array.isArray(list)
              ? list.filter(item => item && item.name && String(item.name).trim() !== '')
              : [];
            // åˆ†é é‚è¼¯ï¼šåœ¨éžåˆ†é è®Šæ›´æƒ…æ³ä¸‹é‡ç½®ç•¶å‰é è‡³ 1
            if (!pageChange) {
              paginationSettings.personalHerbCombos.currentPage = 1;
            }
            const totalItems = Array.isArray(list) ? list.length : 0;
            const itemsPerPage = paginationSettings.personalHerbCombos.itemsPerPage;
            let currentPage = paginationSettings.personalHerbCombos.currentPage;
            const totalPages = totalItems > 0 ? Math.ceil(totalItems / itemsPerPage) : 1;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            paginationSettings.personalHerbCombos.currentPage = currentPage;
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = Array.isArray(list) ? list.slice(startIdx, endIdx) : [];
            if (!pageItems || pageItems.length === 0) {
              // ç„¡è³‡æ–™é¡¯ç¤ºæç¤ºä¸¦éš±è—åˆ†é 
              container.innerHTML = '<div class="w-full md:col-span-2 text-center text-gray-400 text-lg py-10">å‰µå»ºè‡ªå·±çš„çµ„åˆ</div>';
              const paginEl = ensurePaginationContainer('herbCombinationsContainer', 'herbCombosPagination');
              if (paginEl) {
                paginEl.innerHTML = '';
                paginEl.classList.add('hidden');
              }
              return;
            }
            // æ¸²æŸ“ç•¶å‰é é …ç›®
            pageItems.forEach(item => {
              const card = document.createElement('div');
              card.className = 'bg-white p-6 rounded-lg border-2 border-green-200';
              const category = item && item.category ? item.category : '';
              card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="text-lg font-semibold text-green-800">${item.name}</h3>
                    <div class="text-xs text-green-600 mt-1">${category}</div>
                  </div>
                  <div class="flex gap-2">
                    <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="showEditModal('herb', '${item.name}')">ç·¨è¼¯</button>
                    <button class="text-red-600 hover:text-red-800 text-sm" onclick="deleteHerbCombination(${item.id})">åˆªé™¤</button>
                  </div>
                </div>
                <p class="text-gray-600 mb-3">${item.description}</p>
                <div class="text-sm text-gray-700 space-y-1">
                  ${item.ingredients.map(ing => {
                    const dosage = ing && ing.dosage ? String(ing.dosage).trim() : '';
                    const displayDosage = dosage ? (dosage + 'å…‹') : '';
                    const nameVal = ing && ing.name ? ing.name : '';
                    // å–å¾—è©²è—¥æçš„æç¤ºå…§å®¹ä¸¦ç·¨ç¢¼
                    const tooltipContent = getHerbTooltipContent(nameVal);
                    const encoded = tooltipContent ? encodeURIComponent(tooltipContent) : '';
                    let attrs = '';
                    if (tooltipContent) {
                      // Use proper escaping for single quotes inside single-quoted strings. The
                      // original implementation attempted to escape the single quotes surrounding
                      // the `data-tooltip` attribute name using double backslashes (\\'), which
                      // resulted in the string being prematurely terminated and caused a
                      // `SyntaxError: Unexpected identifier` at runtime. To correctly embed
                      // single quotes within a single-quoted JavaScript string, a single
                      // backslash (\') should be used. This matches the pattern used in
                      // similar code elsewhere in this file (see line ~16266).
                      attrs = ' data-tooltip="' + encoded + '" onmouseenter="showTooltip(event, this.getAttribute(\'data-tooltip\'))" onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()"';
                    }
                    return '<div class="flex justify-between items-center p-2 bg-green-50 hover:bg-green-100 border border-green-200 rounded text-sm"' + attrs + '>' +
                      '<span class="text-green-800">' + nameVal + '</span>' +
                      '<span class="text-green-600">' + displayDosage + '</span>' +
                      '</div>';
                  }).join('')}
                </div>
              `;
              container.appendChild(card);
            });
            // åˆ†é æŽ§åˆ¶å…ƒä»¶
            const paginEl = ensurePaginationContainer('herbCombinationsContainer', 'herbCombosPagination');
            renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
              paginationSettings.personalHerbCombos.currentPage = newPage;
              renderHerbCombinations(true);
            }, paginEl);
          }

          function addNewHerbCombination() {
            // ä½¿ç”¨ç·¨è¼¯ä»‹é¢æ–°å¢žè—¥æ–¹çµ„åˆï¼šå»ºç«‹ä¸€å€‹ç©ºç™½é …ç›®ä¸¦ç«‹å³æ‰“é–‹ç·¨è¼¯è¦–çª—
            // å»ºç«‹ä¸€å€‹æ–°çš„è—¥æ–¹çµ„åˆï¼Œæ¨™è¨˜ç‚º isNew ä»¥ä¾¿å–æ¶ˆæ™‚ç§»é™¤
            const newItem = {
              id: Date.now(),
              // æ–°é …ç›®é è¨­åç¨±ç‚ºç©ºï¼Œä½¿ç”¨è€…å¯åœ¨ç·¨è¼¯è¦–çª—ä¸­å¡«å¯«
              name: '',
              // é è¨­åˆ†é¡žæŽ¡ç”¨å€‹äººæ…£ç”¨è—¥æ–¹çµ„åˆåˆ†é¡žï¼Œè‹¥ç„¡å‰‡å›žé€€è‡³å…¨åŸŸåˆ†é¡žï¼Œå¦‚æžœå…©è€…çš†ç„¡å‰‡ç©ºå­—ä¸²
              category: (typeof herbComboCategories !== 'undefined' && herbComboCategories.length > 0)
                ? herbComboCategories[0]
                : ((typeof categories !== 'undefined' && categories.herbs && categories.herbs.length > 0) ? categories.herbs[0] : ''),
              description: '',
              ingredients: [],
              lastModified: new Date().toISOString().split('T')[0],
              // æ¨™è¨˜æ­¤çµ„åˆç‚ºæ–°å»ºï¼Œç”¨æ–¼å–æ¶ˆæ™‚å›žæ”¶
              isNew: true
            };
            // å°‡æ–°çµ„åˆæš«å­˜åˆ°åˆ—è¡¨
            herbCombinations.push(newItem);
            // æ¸²æŸ“ä¸¦ç«‹å³é–‹å•Ÿç·¨è¼¯ä»‹é¢ï¼Œè®“ä½¿ç”¨è€…å¡«å¯«è©³ç´°è³‡æ–™
            renderHerbCombinations();
            showEditModal('herb', newItem.name);
          }


async function deleteHerbCombination(id) {
            // åˆªé™¤è—¥æ–¹çµ„åˆç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
            {
              const lang = localStorage.getItem('lang') || 'zh';
              const zhMsg = 'ç¢ºå®šè¦åˆªé™¤æ­¤è—¥æ–¹çµ„åˆå—Žï¼Ÿ';
              const enMsg = 'Are you sure you want to delete this herb combination?';
              const confirmed = await showConfirmation(lang === 'en' ? enMsg : zhMsg, 'warning');
              if (!confirmed) return;
            }
            herbCombinations = herbCombinations.filter(h => h.id !== id);
            renderHerbCombinations();
            // Persist changes for personal herb combinations
            if (typeof updatePersonalSettings === 'function') {
              try {
                updatePersonalSettings().catch((err) => console.error('æ›´æ–°å€‹äººè¨­ç½®å¤±æ•—:', err));
              } catch (_e) {}
            }
          }

          // æ¸²æŸ“ç©´ä½çµ„åˆ
          function renderAcupointCombinations(pageChange = false) {
            // æ ¹æ“šæœå°‹é—œéµå­—èˆ‡åˆ†é¡žç¯©é¸ä¸¦æ¸²æŸ“å€‹äººæ…£ç”¨ç©´ä½çµ„åˆã€‚
            const container = document.getElementById('acupointCombinationsContainer');
            if (!container) return;
            container.innerHTML = '';
            // æ›´æ–°ç©´ä½çµ„åˆç¸½æ•¸è‡³æ¨™ç±¤é¡¯ç¤º
            try {
              const totalCount = Array.isArray(acupointCombinations)
                ? acupointCombinations.filter(item => item && item.name && String(item.name).trim() !== '').length
                : 0;
              const countElem = document.getElementById('acupointCount');
              if (countElem) {
                countElem.textContent = String(totalCount);
              }
            } catch (_e) {}
            // å–å¾—æœå°‹å­—ä¸²ï¼Œæ”¯æ´å¤šå€‹å¯èƒ½çš„è¼¸å…¥æ¡† IDã€‚
            let searchTerm = '';
            ['acupointComboSearch', 'searchAcupointCombo', 'acupointComboSearchInput'].some(id => {
              const el = document.getElementById(id);
              if (el) {
                searchTerm = (el.value || '').trim().toLowerCase();
                return true;
              }
              return false;
            });
            // å–å¾—åˆ†é¡žç¯©é¸å€¼ï¼Œé è¨­ç‚º 'all'ã€‚
            let selectedCategory = 'all';
            ['acupointComboCategoryFilter', 'acupointComboCategory', 'acupointComboCategorySelect'].some(id => {
              const el = document.getElementById(id);
              if (el) {
                selectedCategory = el.value;
                return true;
              }
              return false;
            });
            // ç¯©é¸è³‡æ–™ï¼šä¾æ“šæœå°‹å­—ä¸²å’Œåˆ†é¡žã€‚
            let list = acupointCombinations;
            if (searchTerm || (selectedCategory && selectedCategory !== 'all' && selectedCategory !== '')) {
              list = acupointCombinations.filter(item => {
                // æœå°‹ï¼šæ¯”å°åç¨±ã€é‡æ³•èˆ‡ç©´ä½åç¨±æˆ–é¡žåž‹ã€‚
                let matchesSearch = true;
                if (searchTerm) {
                  const nameMatch = (item.name && item.name.toLowerCase().includes(searchTerm));
                  const techniqueMatch = (item.technique && item.technique.toLowerCase().includes(searchTerm));
                  const pointsMatch = Array.isArray(item.points) && item.points.some(pt => {
                    // æœå°‹ç©´ä½åç¨±
                    return pt && pt.name && pt.name.toLowerCase().includes(searchTerm);
                  });
                  matchesSearch = nameMatch || techniqueMatch || pointsMatch;
                }
                // åˆ†é¡žæ¢ä»¶ï¼šåªæœ‰åœ¨é¸å®šç‰¹å®šåˆ†é¡žæ™‚æ‰ç”Ÿæ•ˆã€‚
                let matchesCategory = true;
                if (selectedCategory && selectedCategory !== 'all' && selectedCategory !== '') {
                  matchesCategory = item.category === selectedCategory;
                }
                return matchesSearch && matchesCategory;
              });
            }
            // éŽæ¿¾æŽ‰æœªå‘½åçš„æ–°å»ºçµ„åˆï¼Œé¿å…é¡¯ç¤ºç©ºç™½å¡ç‰‡
            list = Array.isArray(list)
              ? list.filter(item => item && item.name && String(item.name).trim() !== '')
              : [];
            // åˆ†é é‚è¼¯ï¼šéžåˆ†é è®Šæ›´æ™‚å°‡é æ•¸é‡ç½®ç‚º 1
            if (!pageChange) {
              paginationSettings.personalAcupointCombos.currentPage = 1;
            }
            const totalItems = Array.isArray(list) ? list.length : 0;
            const itemsPerPage = paginationSettings.personalAcupointCombos.itemsPerPage;
            let currentPage = paginationSettings.personalAcupointCombos.currentPage;
            const totalPages = totalItems > 0 ? Math.ceil(totalItems / itemsPerPage) : 1;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            paginationSettings.personalAcupointCombos.currentPage = currentPage;
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = Array.isArray(list) ? list.slice(startIdx, endIdx) : [];
            if (!pageItems || pageItems.length === 0) {
              container.innerHTML = '<div class="w-full md:col-span-2 text-center text-gray-400 text-lg py-10">å‰µå»ºè‡ªå·±çš„çµ„åˆ</div>';
              const paginEl = ensurePaginationContainer('acupointCombinationsContainer', 'acupointCombosPagination');
              if (paginEl) {
                paginEl.innerHTML = '';
                paginEl.classList.add('hidden');
              }
              return;
            }
            // æ¸²æŸ“ç•¶å‰é è³‡æ–™
            pageItems.forEach(item => {
              const card = document.createElement('div');
              card.className = 'bg-white p-6 rounded-lg border-2 border-blue-200';
              const category = item && item.category ? item.category : '';
              card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="text-lg font-semibold text-blue-800">${item.name}</h3>
                    <div class="text-xs text-blue-600 mt-1">${category}</div>
                  </div>
                  <div class="flex gap-2">
                    <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="showEditModal('acupoint', '${item.name}')">ç·¨è¼¯</button>
                    <button class="text-red-600 hover:text-red-800 text-sm" onclick="deleteAcupointCombination(${item.id})">åˆªé™¤</button>
                  </div>
                </div>
                <div class="text-sm text-gray-700 space-y-1">
                  ${item.points.map(pt => {
                    // å–å¾—åç¨±ï¼Œè™•ç†å¯èƒ½ç‚ºç©ºæˆ–æœªå®šç¾©çš„æƒ…æ³
                    const nameVal = pt && pt.name ? pt.name : '';
                    // å–å¾—è©²ç©´ä½çš„æç¤ºå…§å®¹ä¸¦é€²è¡Œ URL ç·¨ç¢¼
                    const tooltipContent = getAcupointTooltipContent(nameVal);
                    const encoded = tooltipContent ? encodeURIComponent(tooltipContent) : '';
                    // çµ„åˆ tooltip å±¬æ€§èˆ‡äº‹ä»¶
                    let attrs = '';
                    if (tooltipContent) {
                      attrs = ' data-tooltip="' + encoded + '" onmouseenter="showTooltip(event, this.getAttribute(\'data-tooltip\'))" onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()"';
                    }
                    // è¿”å›žæ¸²æŸ“å­—ä¸²ï¼Œåªé¡¯ç¤ºç©´ä½åç¨±
                    return '<div class="flex items-center p-2 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded text-sm"' + attrs + '>' +
                      '<span class="text-blue-800">' + window.escapeHtml(nameVal) + '</span>' +
                      '</div>';
                  }).join('')}
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200 text-sm text-gray-600">
                  <p>é‡æ³•ï¼š${item.technique}</p>
                </div>
              `;
              container.appendChild(card);
            });
            // åˆ†é æŽ§åˆ¶
            const paginEl = ensurePaginationContainer('acupointCombinationsContainer', 'acupointCombosPagination');
            renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
              paginationSettings.personalAcupointCombos.currentPage = newPage;
              renderAcupointCombinations(true);
            }, paginEl);
          }

          function addNewAcupointCombination() {
            // ä½¿ç”¨ç·¨è¼¯ä»‹é¢æ–°å¢žç©´ä½çµ„åˆï¼šå»ºç«‹ä¸€å€‹ç©ºç™½é …ç›®ä¸¦ç«‹å³æ‰“é–‹ç·¨è¼¯è¦–çª—
            // å»ºç«‹ä¸€å€‹æ–°çš„ç©´ä½çµ„åˆï¼Œæ¨™è¨˜ç‚º isNew ä»¥ä¾¿å–æ¶ˆæ™‚ç§»é™¤
            const newItem = {
              id: Date.now(),
              name: '',
              // é è¨­åˆ†é¡žæŽ¡ç”¨å€‹äººæ…£ç”¨ç©´ä½çµ„åˆåˆ†é¡žï¼Œè‹¥ç„¡å‰‡å›žé€€è‡³å…¨åŸŸåˆ†é¡žï¼Œå¦‚æžœå…©è€…çš†ç„¡å‰‡ç©ºå­—ä¸²
              category: (typeof acupointComboCategories !== 'undefined' && acupointComboCategories.length > 0)
                ? acupointComboCategories[0]
                : ((typeof categories !== 'undefined' && categories.acupoints && categories.acupoints.length > 0) ? categories.acupoints[0] : ''),
              points: [],
              technique: '',
              frequency: 'ä½Ž',
              lastModified: new Date().toISOString().split('T')[0],
              isNew: true
            };
            // å°‡æ–°çµ„åˆæš«å­˜åˆ°åˆ—è¡¨
            acupointCombinations.push(newItem);
            renderAcupointCombinations();
            showEditModal('acupoint', newItem.name);
          }


async function deleteAcupointCombination(id) {
            // åˆªé™¤ç©´ä½çµ„åˆç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
            {
              const lang = localStorage.getItem('lang') || 'zh';
              const zhMsg = 'ç¢ºå®šè¦åˆªé™¤æ­¤ç©´ä½çµ„åˆå—Žï¼Ÿ';
              const enMsg = 'Are you sure you want to delete this acupuncture combination?';
              const confirmed = await showConfirmation(lang === 'en' ? enMsg : zhMsg, 'warning');
              if (!confirmed) return;
            }
            acupointCombinations = acupointCombinations.filter(a => a.id !== id);
            renderAcupointCombinations();
            // Persist changes for personal acupoint combinations
            if (typeof updatePersonalSettings === 'function') {
              try {
                updatePersonalSettings().catch((err) => console.error('æ›´æ–°å€‹äººè¨­ç½®å¤±æ•—:', err));
              } catch (_e) {}
            }
          }

        /**
         * åˆå§‹åŒ–å€‹äººå¸¸ç”¨ä¸­è—¥èˆ‡ç©´ä½çµ„åˆçš„æœå°‹èˆ‡åˆ†é¡žç¯©é¸ç•Œé¢ã€‚
         * æ­¤å‡½å¼æœƒåœ¨å€‹äººè¨­å®šä»‹é¢ä¸Šå‹•æ…‹æ’å…¥æœå°‹æ¡†èˆ‡åˆ†é¡žä¸‹æ‹‰é¸å–®ï¼Œ
         * ä¸¦æ ¹æ“šç•¶å‰çš„å€‹äººåˆ†é¡žï¼ˆherbComboCategoriesã€acupointComboCategoriesï¼‰
         * ç”¢ç”Ÿé¸é …ã€‚è‹¥å·²å­˜åœ¨å°æ‡‰çš„å…ƒç´ ï¼Œå°‡æœƒæ›´æ–°å…¶é¸é …å…§å®¹ã€‚
         *
         * èª¿ç”¨æœ¬å‡½å¼å¯ç¢ºä¿æœå°‹èˆ‡åˆ†é¡žä»‹é¢èˆ‡æœ€æ–°åˆ†é¡žä¿æŒåŒæ­¥ã€‚
         */
        function setupPersonalComboSearchAndFilter() {
          try {
            // ä¸­è—¥çµ„åˆå€åŸŸï¼šè‹¥ç•«é¢å·²å«æœå°‹è¼¸å…¥æ¡†èˆ‡åˆ†é¡žä¸‹æ‹‰é¸å–®ï¼Œåƒ…æ›´æ–°é¸é …ï¼›å¦å‰‡å»ºç«‹ä¹‹
            const herbContainer = document.getElementById('herbCombinationsContainer');
            if (herbContainer) {
              const existingSearch = document.getElementById('herbComboSearchInput');
              const existingSelect = document.getElementById('herbComboCategoryFilter');
              if (existingSearch && existingSelect) {
                // æ¸…ç©ºç¾æœ‰åˆ†é¡žé¸é …å¾Œé‡æ–°å»ºç«‹ï¼Œä»¥ç¬¦åˆæœ€æ–°åˆ†é¡ž
                existingSelect.innerHTML = '';
                const defaultOpt = document.createElement('option');
                defaultOpt.value = 'all';
                defaultOpt.textContent = 'å…¨éƒ¨åˆ†é¡ž';
                existingSelect.appendChild(defaultOpt);
                const herbCats = (typeof herbComboCategories !== 'undefined' && Array.isArray(herbComboCategories) && herbComboCategories.length > 0)
                  ? herbComboCategories
                  : ((categories && Array.isArray(categories.herbs)) ? categories.herbs : []);
                herbCats.forEach(cat => {
                  const opt = document.createElement('option');
                  opt.value = cat;
                  opt.textContent = cat;
                  existingSelect.appendChild(opt);
                });
                // ä¸é‡è¤‡ç¶å®šäº‹ä»¶ï¼Œäº‹ä»¶ç›£è½åœ¨åˆå§‹åŒ–å¾Œæœƒçµ±ä¸€æ·»åŠ 
              } else {
                // è‹¥å°šæœªå»ºç«‹æœå°‹å€å¡Šï¼ˆä¾‹å¦‚èˆŠç•«é¢ï¼‰ï¼Œç¶­æŒåŽŸå…ˆé‚è¼¯å»ºç«‹æœç´¢æ¬„èˆ‡åˆ†é¡žé¸å–®
                let herbWrapper = document.getElementById('herbComboSearchWrapper');
                if (!herbWrapper) {
                  herbWrapper = document.createElement('div');
                  herbWrapper.id = 'herbComboSearchWrapper';
                  herbWrapper.className = 'flex flex-wrap gap-2 mb-4';
                  herbContainer.parentNode.insertBefore(herbWrapper, herbContainer);
                }
                herbWrapper.innerHTML = '';
                const herbSearchInput = document.createElement('input');
                herbSearchInput.id = 'herbComboSearchInput';
                herbSearchInput.className = 'px-3 py-2 border border-gray-300 rounded flex-1';
                herbSearchInput.placeholder = 'æœç´¢å¸¸ç”¨è—¥æ–¹...';
                herbWrapper.appendChild(herbSearchInput);
                const herbSelect = document.createElement('select');
                herbSelect.id = 'herbComboCategoryFilter';
                herbSelect.className = 'px-3 py-2 border border-gray-300 rounded';
                const defOpt = document.createElement('option');
                defOpt.value = 'all';
                defOpt.textContent = 'å…¨éƒ¨åˆ†é¡ž';
                herbSelect.appendChild(defOpt);
                const herbCats2 = (typeof herbComboCategories !== 'undefined' && Array.isArray(herbComboCategories) && herbComboCategories.length > 0)
                  ? herbComboCategories
                  : ((categories && Array.isArray(categories.herbs)) ? categories.herbs : []);
                herbCats2.forEach(cat => {
                  const opt = document.createElement('option');
                  opt.value = cat;
                  opt.textContent = cat;
                  herbSelect.appendChild(opt);
                });
                herbWrapper.appendChild(herbSelect);
                // ç‚ºæ–°å»ºç«‹çš„æœå°‹èˆ‡åˆ†é¡žé¸å–®ç¶å®šäº‹ä»¶ï¼Œä»¥å³æ™‚åˆ·æ–°åˆ—è¡¨
                try {
                  herbSearchInput.addEventListener('input', function() {
                    if (typeof renderHerbCombinations === 'function') {
                      renderHerbCombinations();
                    }
                  });
                } catch (_e) {}
                try {
                  herbSelect.addEventListener('change', function() {
                    if (typeof renderHerbCombinations === 'function') {
                      renderHerbCombinations();
                    }
                  });
                } catch (_e) {}
              }
            }
            // ç©´ä½çµ„åˆå€åŸŸï¼šè‹¥ç•«é¢å·²æœ‰æœå°‹è¼¸å…¥æ¡†èˆ‡åˆ†é¡žä¸‹æ‹‰é¸å–®ï¼Œåƒ…æ›´æ–°é¸é …ï¼›å¦å‰‡å»ºç«‹ä¹‹
            const acupointContainer = document.getElementById('acupointCombinationsContainer');
            if (acupointContainer) {
              const existingAcuSearch = document.getElementById('acupointComboSearchInput');
              const existingAcuSelect = document.getElementById('acupointComboCategoryFilter');
              if (existingAcuSearch && existingAcuSelect) {
                existingAcuSelect.innerHTML = '';
                const acuDefaultOpt = document.createElement('option');
                acuDefaultOpt.value = 'all';
                acuDefaultOpt.textContent = 'å…¨éƒ¨åˆ†é¡ž';
                existingAcuSelect.appendChild(acuDefaultOpt);
                const acuCats = (typeof acupointComboCategories !== 'undefined' && Array.isArray(acupointComboCategories) && acupointComboCategories.length > 0)
                  ? acupointComboCategories
                  : ((categories && Array.isArray(categories.acupoints)) ? categories.acupoints : []);
                acuCats.forEach(cat => {
                  const opt = document.createElement('option');
                  opt.value = cat;
                  opt.textContent = cat;
                  existingAcuSelect.appendChild(opt);
                });
                // ä¸é‡è¤‡ç¶å®šäº‹ä»¶ï¼›çµ±ä¸€åœ¨å…¶ä»–åœ°æ–¹ç¶å®š
              } else {
                // èˆŠé‚è¼¯å»ºç«‹
                let acuWrapper = document.getElementById('acupointComboSearchWrapper');
                if (!acuWrapper) {
                  acuWrapper = document.createElement('div');
                  acuWrapper.id = 'acupointComboSearchWrapper';
                  acuWrapper.className = 'flex flex-wrap gap-2 mb-4';
                  acupointContainer.parentNode.insertBefore(acuWrapper, acupointContainer);
                }
                acuWrapper.innerHTML = '';
                const acuSearchInput = document.createElement('input');
                acuSearchInput.id = 'acupointComboSearchInput';
                acuSearchInput.className = 'px-3 py-2 border border-gray-300 rounded flex-1';
                acuSearchInput.placeholder = 'æœç´¢å¸¸ç”¨ç©´ä½çµ„åˆ...';
                acuWrapper.appendChild(acuSearchInput);
                const acuSelect = document.createElement('select');
                acuSelect.id = 'acupointComboCategoryFilter';
                acuSelect.className = 'px-3 py-2 border border-gray-300 rounded';
                const acuDefOpt = document.createElement('option');
                acuDefOpt.value = 'all';
                acuDefOpt.textContent = 'å…¨éƒ¨åˆ†é¡ž';
                acuSelect.appendChild(acuDefOpt);
                const acuCats2 = (typeof acupointComboCategories !== 'undefined' && Array.isArray(acupointComboCategories) && acupointComboCategories.length > 0)
                  ? acupointComboCategories
                  : ((categories && Array.isArray(categories.acupoints)) ? categories.acupoints : []);
                acuCats2.forEach(cat => {
                  const opt = document.createElement('option');
                  opt.value = cat;
                  opt.textContent = cat;
                  acuSelect.appendChild(opt);
                });
                acuWrapper.appendChild(acuSelect);
                // ç¶å®šäº‹ä»¶è‡³æ–°å»ºç«‹çš„ç©´ä½æœå°‹èˆ‡åˆ†é¡žé¸å–®
                try {
                  acuSearchInput.addEventListener('input', function() {
                    if (typeof renderAcupointCombinations === 'function') {
                      renderAcupointCombinations();
                    }
                  });
                } catch (_e) {}
                try {
                  acuSelect.addEventListener('change', function() {
                    if (typeof renderAcupointCombinations === 'function') {
                      renderAcupointCombinations();
                    }
                  });
                } catch (_e) {}
              }
            }
          } catch (error) {
            console.error('åˆå§‹åŒ–å€‹äººçµ„åˆæœå°‹åˆ†é¡žä»‹é¢éŒ¯èª¤:', error);
          }
        }

          // -----------------------------------------------------------------------------
          // å€‹äººè¨­ç½®ç›¸é—œå‡½å¼èˆ‡å¸¸ç”¨çµ„åˆè¼‰å…¥
          //
          // è®€å–ä¸¦ä¿å­˜ç•¶å‰ç”¨æˆ¶çš„å€‹äººè¨­ç½®ï¼ˆæ…£ç”¨ä¸­è—¥çµ„åˆåŠç©´ä½çµ„åˆï¼‰åˆ° Firebaseã€‚
          // é€™äº›å‡½å¼ä¸æœƒé˜»å¡žä¸»è¦æµç¨‹ï¼Œä½†æœƒåœ¨ç™»å…¥å¾Œè¼‰å…¥ä½¿ç”¨è€…çš„å€‹äººè¨­å®šï¼Œ
          // ä¸¦åœ¨ä»»ä½•ä¿®æ”¹æ™‚æ›´æ–°è‡³ Firestoreã€‚ä¹Ÿæä¾› UI å½ˆçª—è®“è¨ºç—‡æ™‚å¿«é€Ÿè¼‰å…¥
          // æ…£ç”¨çµ„åˆã€‚

          /**
           * å¾ž Firestore è¼‰å…¥ç•¶å‰ç”¨æˆ¶çš„å€‹äººè¨­ç½®ï¼ŒåŒ…æ‹¬æ…£ç”¨ä¸­è—¥çµ„åˆèˆ‡ç©´ä½çµ„åˆã€‚
           * å¦‚æžœæœªæ‰¾åˆ°ä»»ä½•è¨­å®šï¼Œå‰‡ä½¿ç”¨ç•¶å‰çš„é è¨­æ•¸æ“šæˆ–ç¶­æŒç©ºé™£åˆ—ã€‚
           */
          async function loadPersonalSettings() {
            try {
              // ç­‰å¾… Firebase èˆ‡è³‡æ–™ç®¡ç†å™¨åˆå§‹åŒ–
              await waitForFirebaseDb();
              await waitForFirebaseDataManager();
              // è‹¥æ²’æœ‰ç•¶å‰ç”¨æˆ¶è³‡æ–™ï¼Œç›´æŽ¥çµæŸ
              if (!currentUserData || !currentUserData.id) {
                return;
              }
              /*
               * å„ªå…ˆå˜—è©¦åˆ©ç”¨ Firestore çš„ getDoc API ç›´æŽ¥è®€å–ç•¶å‰ç”¨æˆ¶çš„æ–‡ä»¶ï¼Œ
               * ä»¥é¿å…æ‹‰å–æ‰€æœ‰ç”¨æˆ¶è³‡æ–™ã€‚å¦‚æžœ getDoc ä¸å­˜åœ¨æˆ–å¤±æ•—ï¼Œå‰‡é€€å›ž
               * åˆ°é€éŽ FirebaseDataManager.getUsers() å–å¾—ç”¨æˆ¶æ¸…å–®å¾Œå†ç¯©é¸ï¼Œ
               * ä»¥ç¢ºä¿å…¼å®¹èˆŠç’°å¢ƒã€‚
               */
              let userRecord = null;
              // å˜—è©¦ç›´æŽ¥è®€å–ç•¶å‰ç”¨æˆ¶çš„æ–‡ä»¶
              try {
                if (window.firebase && window.firebase.getDoc && window.firebase.doc) {
                  const docRef = window.firebase.doc(window.firebase.db, 'users', String(currentUserData.id));
                  const docSnap = await window.firebase.getDoc(docRef);
                  if (docSnap && docSnap.exists()) {
                    userRecord = { id: docSnap.id, ...docSnap.data() };
                  }
                }
              } catch (err) {
                console.error('ç›´æŽ¥è®€å–ç”¨æˆ¶æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
              }
              // è‹¥ç„¡æ³•ç›´æŽ¥å–å¾—ï¼Œæ”¹ç‚ºå¾žç”¨æˆ¶æ¸…å–®ä¸­ç¯©é¸
              if (!userRecord) {
                try {
                  // é€éŽ fetchUsers(true) ç²å–ç”¨æˆ¶åˆ—è¡¨ï¼Œä¸¦ä»¥å¿«å–é™ä½Žè®€å–é »çŽ‡
                  const userList = await fetchUsers(true);
                  if (Array.isArray(userList) && userList.length > 0) {
                    userRecord = userList.find(u => {
                      const idMatches = u && u.id !== undefined && currentUserData.id !== undefined;
                      return idMatches && String(u.id) === String(currentUserData.id);
                    });
                  }
                } catch (err) {
                  console.error('è®€å–ç”¨æˆ¶è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                }
              }
              if (userRecord && userRecord.personalSettings) {
                const personal = userRecord.personalSettings;
                // å¦‚æžœæœ‰ä¿å­˜çš„å€‹äººæ…£ç”¨ä¸­è—¥çµ„åˆï¼Œå‰‡è¼‰å…¥ï¼Œå¦å‰‡æ¸…ç©º
                if (Array.isArray(personal.herbCombinations)) {
                  herbCombinations = personal.herbCombinations;
                } else {
                  herbCombinations = [];
                }
                // å¦‚æžœæœ‰ä¿å­˜çš„å€‹äººç©´ä½çµ„åˆï¼Œå‰‡è¼‰å…¥ï¼Œå¦å‰‡æ¸…ç©º
                if (Array.isArray(personal.acupointCombinations)) {
                  acupointCombinations = personal.acupointCombinations;
                } else {
                  acupointCombinations = [];
                }
                // å€‹äººæ…£ç”¨çµ„åˆåˆ†é¡žè¼‰å…¥ï¼šè‹¥ personalSettings ä¸­åŒ…å«åˆ†é¡žï¼Œå‰‡è¦†è“‹é è¨­å€¼ï¼›å¦å‰‡é‡ç½®å€‹äººåˆ†é¡ž
                if (Array.isArray(personal.herbComboCategories)) {
                  // æ›´æ–°å€‹äººæ…£ç”¨åˆ†é¡ž
                  herbComboCategories = personal.herbComboCategories;
                  window.herbComboCategories = herbComboCategories;
                  try {
                    // åŒæ­¥è‡³å…¨åŸŸ categoriesï¼Œç¢ºä¿ç®¡ç†åˆ†é¡žå½ˆçª—èƒ½é¡¯ç¤ºå·²ä¿å­˜åˆ†é¡ž
                    categories.herbs = [...herbComboCategories];
                    if (window.categories && Array.isArray(window.categories.herbs)) {
                      window.categories.herbs = categories.herbs;
                    }
                  } catch (_e) {}
                } else {
                  // æ²’æœ‰å€‹äººåˆ†é¡žæ™‚ï¼Œæ¸…ç©ºå€‹äººåˆ†é¡žï¼Œä»¥å…æ®˜ç•™å‰ä¸€ä½ä½¿ç”¨è€…çš„è³‡æ–™
                  herbComboCategories = [];
                  window.herbComboCategories = [];
                }
                if (Array.isArray(personal.acupointComboCategories)) {
                  // æ›´æ–°å€‹äººæ…£ç”¨åˆ†é¡ž
                  acupointComboCategories = personal.acupointComboCategories;
                  window.acupointComboCategories = acupointComboCategories;
                  try {
                    // åŒæ­¥è‡³å…¨åŸŸ categoriesï¼Œç¢ºä¿ç®¡ç†åˆ†é¡žå½ˆçª—èƒ½é¡¯ç¤ºå·²ä¿å­˜åˆ†é¡ž
                    categories.acupoints = [...acupointComboCategories];
                    if (window.categories && Array.isArray(window.categories.acupoints)) {
                      window.categories.acupoints = categories.acupoints;
                    }
                  } catch (_e) {}
                } else {
                  // æ²’æœ‰å€‹äººåˆ†é¡žæ™‚ï¼Œæ¸…ç©ºå€‹äººåˆ†é¡ž
                  acupointComboCategories = [];
                  window.acupointComboCategories = [];
                }
              } else {
                // å¦‚æžœæ‰¾ä¸åˆ°ç”¨æˆ¶è¨˜éŒ„æˆ–ç”¨æˆ¶æ²’æœ‰å€‹äººè¨­ç½®ï¼Œå‰‡å°‡ç›¸é—œè³‡æ–™æ¸…ç©º
                herbCombinations = [];
                acupointCombinations = [];
                herbComboCategories = [];
                acupointComboCategories = [];
                window.herbComboCategories = [];
                window.acupointComboCategories = [];
              }
            } catch (error) {
              console.error('è®€å–å€‹äººè¨­ç½®å¤±æ•—:', error);
            } finally {
              // æ¸²æŸ“ UI ä»¥åæ˜ è¼‰å…¥çµæžœ
              try {
                if (typeof renderHerbCombinations === 'function') {
                  renderHerbCombinations();
                }
                if (typeof renderAcupointCombinations === 'function') {
                  renderAcupointCombinations();
                }
                // åœ¨è¼‰å…¥å€‹äººè¨­å®šå¾Œåˆ·æ–°æœå°‹èˆ‡åˆ†é¡žä»‹é¢ï¼Œç¢ºä¿é¸å–®èˆ‡æœ€æ–°è³‡æ–™åŒæ­¥
                if (typeof setupPersonalComboSearchAndFilter === 'function') {
                  try {
                    setupPersonalComboSearchAndFilter();
                  } catch (_e) {}
                }
              } catch (e) {
                console.error('æ¸²æŸ“å€‹äººè¨­ç½®å¤±æ•—:', e);
              }
            }
          }

          /**
           * å°‡ç•¶å‰çš„å€‹äººè¨­ç½®ä¿å­˜è‡³ Firestoreã€‚
           * åŒ…å«æ…£ç”¨ä¸­è—¥çµ„åˆå’Œæ…£ç”¨ç©´ä½çµ„åˆã€‚
           */
          async function updatePersonalSettings() {
            try {
              await waitForFirebaseDb();
              if (!currentUserData || !currentUserData.id) {
                return;
              }
              await window.firebase.updateDoc(
                window.firebase.doc(window.firebase.db, 'users', String(currentUserData.id)),
                {
                  personalSettings: {
                    herbCombinations: Array.isArray(herbCombinations) ? herbCombinations : [],
                    acupointCombinations: Array.isArray(acupointCombinations) ? acupointCombinations : [],
                    // ä¿å­˜å€‹äººåˆ†é¡žï¼šä¸­è—¥çµ„åˆåˆ†é¡žèˆ‡ç©´ä½çµ„åˆåˆ†é¡ž
                    herbComboCategories: Array.isArray(herbComboCategories) ? herbComboCategories : [],
                    acupointComboCategories: Array.isArray(acupointComboCategories) ? acupointComboCategories : []
                  },
                  updatedAt: new Date(),
                  updatedBy: currentUser || 'system'
                }
              );
            } catch (error) {
              console.error('æ›´æ–°å€‹äººè¨­ç½®è‡³ Firestore å¤±æ•—:', error);
            }
          }

          /**
           * é¡¯ç¤ºå¸¸ç”¨è—¥æ–¹çµ„åˆé¸æ“‡å½ˆçª—ã€‚åˆ—å‡ºæ‰€æœ‰å€‹äººæ…£ç”¨ä¸­è—¥çµ„åˆä¾›é¸æ“‡ã€‚
           */
          function showHerbComboModal() {
            try {
              const modal = document.getElementById('herbComboModal');
              const listContainer = document.getElementById('herbComboList');
              if (!modal || !listContainer) return;
              // åœ¨åˆ—è¡¨ä¸Šæ–¹æ”¾ç½®æœå°‹æ¬„ï¼Œè‹¥å°šæœªå­˜åœ¨å‰‡å»ºç«‹
              let searchInput = modal.querySelector('#herbComboSearch');
              if (!searchInput) {
                searchInput = document.createElement('input');
                searchInput.id = 'herbComboSearch';
                searchInput.type = 'text';
                searchInput.placeholder = 'æœå°‹å¸¸ç”¨è—¥æ–¹...';
                searchInput.className = 'w-full mb-3 px-3 py-2 border border-gray-300 rounded';
                listContainer.parentNode.insertBefore(searchInput, listContainer);
                searchInput.addEventListener('input', function() {
                  // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                  showHerbComboModal();
                });
              }
              listContainer.innerHTML = '';
              // éŽæ¿¾æŽ‰åç¨±ç‚ºç©ºç™½æˆ–æœªå‘½åçš„çµ„åˆï¼Œé¿å…é¡¯ç¤ºéŒ¯èª¤è³‡æ–™
              let combos = Array.isArray(herbCombinations)
                ? herbCombinations.filter(c => c && c.name && String(c.name).trim() !== '')
                : [];
              // å–å¾—æœå°‹é—œéµå­—
              const herbKeyword = searchInput.value ? String(searchInput.value).trim().toLowerCase() : '';
              if (herbKeyword) {
                combos = combos.filter(combo => {
                  const nameStr = combo.name ? combo.name.toLowerCase() : '';
                  // æœå°‹åç¨±æˆ–åŽŸæ–™
                  let ingredientsStr = '';
                  if (Array.isArray(combo.ingredients)) {
                    ingredientsStr = combo.ingredients.map(ing => (ing && ing.name ? String(ing.name).toLowerCase() : '')).join(' ');
                  }
                  return nameStr.includes(herbKeyword) || ingredientsStr.includes(herbKeyword);
                });
              }
              if (combos.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500">å°šæœªè¨­å®šå¸¸ç”¨è—¥æ–¹çµ„åˆ</div>';
              } else {
                // ä¾åç¨±æŽ’åº
                combos = combos.slice().sort((a, b) => {
                  const an = a && a.name ? a.name : '';
                  const bn = b && b.name ? b.name : '';
                  return an.localeCompare(bn, 'zh-Hans-CN', { sensitivity: 'base' });
                });
                combos.forEach(combo => {
                  const itemDiv = document.createElement('div');
                  itemDiv.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer';
                  // å°åç¨±èˆ‡åŽŸæ–™é€²è¡Œè½‰ç¾©ï¼Œé¿å… XSS
                  const safeComboName = combo.name ? window.escapeHtml(combo.name) : '';
                  const ingredientsText = (combo.ingredients && combo.ingredients.length > 0)
                    ? combo.ingredients.map(ing => {
                        const name = ing && ing.name ? window.escapeHtml(ing.name) : '';
                        if (ing && ing.dosage) {
                          // å°‡åŠ‘é‡ä¹Ÿè½‰ç¾©
                          const safeDosage = window.escapeHtml(String(ing.dosage));
                          return name + '(' + safeDosage + 'å…‹)';
                        }
                        return name;
                      }).join('ã€')
                    : '';
                  itemDiv.innerHTML = `
                    <div class="font-semibold text-gray-800 mb-1">${safeComboName}</div>
                    <div class="text-sm text-gray-600">${ingredientsText}</div>
                  `;
                  itemDiv.onclick = function() {
                    selectHerbCombo(combo.id);
                  };
                  listContainer.appendChild(itemDiv);
                });
              }
              modal.classList.remove('hidden');
            } catch (error) {
              console.error('é¡¯ç¤ºå¸¸ç”¨è—¥æ–¹å½ˆçª—éŒ¯èª¤:', error);
            }
          }

          function hideHerbComboModal() {
            const modal = document.getElementById('herbComboModal');
            if (modal) modal.classList.add('hidden');
          }

          /**
           * ç•¶é¸æ“‡æŸå€‹å¸¸ç”¨è—¥æ–¹çµ„åˆæ™‚ï¼Œå°‡å…¶è—¥æåŠ å…¥ç•¶å‰è™•æ–¹ã€‚
           * @param {number} comboId çµ„åˆçš„ ID
           */
          function selectHerbCombo(comboId) {
            try {
              const combo = herbCombinations.find(c => String(c.id) === String(comboId));
              if (!combo) return;
              hideHerbComboModal();
              if (!Array.isArray(combo.ingredients) || combo.ingredients.length === 0) return;
              combo.ingredients.forEach(ing => {
                if (!ing || !ing.name) return;
                const item = herbLibrary.find(h => h.name === ing.name);
                if (item) {
                  addToPrescription(item.type, item.id);
                  try {
                    const lastIndex = selectedPrescriptionItems.length - 1;
                    if (lastIndex >= 0 && ing.dosage) {
                      const numeric = String(ing.dosage).match(/[0-9.]+/);
                      selectedPrescriptionItems[lastIndex].customDosage = numeric ? numeric[0] : selectedPrescriptionItems[lastIndex].customDosage;
                    }
                  } catch (_e) {}
                } else {
                  const numeric = ing.dosage ? String(ing.dosage).match(/[0-9.]+/) : null;
                  selectedPrescriptionItems.push({
                    id: Date.now() + Math.random(),
                    type: 'herb',
                    name: ing.name,
                    dosage: ing.dosage || '',
                    // For herb combinations without a specified dosage, default to 1â€¯g.
                    customDosage: numeric ? numeric[0] : '1',
                    composition: null,
                    effects: ''
                  });
                }
              });
              updatePrescriptionDisplay();
              showToast('å·²è¼‰å…¥å¸¸ç”¨è—¥æ–¹çµ„åˆï¼š' + combo.name, 'success');
            } catch (error) {
              console.error('è¼‰å…¥å¸¸ç”¨è—¥æ–¹çµ„åˆéŒ¯èª¤:', error);
            }
          }

          /**
           * é¡¯ç¤ºå¸¸ç”¨ç©´ä½çµ„åˆé¸æ“‡å½ˆçª—ã€‚
           */
          function showAcupointComboModal() {
            try {
              const modal = document.getElementById('acupointComboModal');
              const listContainer = document.getElementById('acupointComboList');
              if (!modal || !listContainer) return;
              // åœ¨åˆ—è¡¨ä¸Šæ–¹æ”¾ç½®æœå°‹æ¬„ï¼Œè‹¥å°šæœªå­˜åœ¨å‰‡å»ºç«‹
              let searchInput = modal.querySelector('#acupointComboSearch');
              if (!searchInput) {
                searchInput = document.createElement('input');
                searchInput.id = 'acupointComboSearch';
                searchInput.type = 'text';
                searchInput.placeholder = 'æœå°‹å¸¸ç”¨ç©´ä½...';
                searchInput.className = 'w-full mb-3 px-3 py-2 border border-gray-300 rounded';
                listContainer.parentNode.insertBefore(searchInput, listContainer);
                searchInput.addEventListener('input', function() {
                  showAcupointComboModal();
                });
              }
              listContainer.innerHTML = '';
              let combos = Array.isArray(acupointCombinations)
                ? acupointCombinations.filter(c => c && c.name && String(c.name).trim() !== '')
                : [];
              // æœå°‹é—œéµå­—
              const acuKeyword = searchInput.value ? String(searchInput.value).trim().toLowerCase() : '';
              if (acuKeyword) {
                combos = combos.filter(combo => {
                  const nameStr = combo.name ? combo.name.toLowerCase() : '';
                  // å°‡ç©´ä½åç¨±ä¸²èµ·ä¾†ä¾›æœå°‹
                  let pointsStr = '';
                  if (Array.isArray(combo.points)) {
                    pointsStr = combo.points.map(pt => {
                      return pt && pt.name ? String(pt.name).toLowerCase() : '';
                    }).join(' ');
                  }
                  const techniqueStr = combo.technique ? String(combo.technique).toLowerCase() : '';
                  return nameStr.includes(acuKeyword) || pointsStr.includes(acuKeyword) || techniqueStr.includes(acuKeyword);
                });
              }
              if (combos.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500">å°šæœªè¨­å®šå¸¸ç”¨ç©´ä½çµ„åˆ</div>';
              } else {
                // ä¾åç¨±æŽ’åº
                combos = combos.slice().sort((a, b) => {
                  const an = a && a.name ? a.name : '';
                  const bn = b && b.name ? b.name : '';
                  return an.localeCompare(bn, 'zh-Hans-CN', { sensitivity: 'base' });
                });
                combos.forEach(combo => {
                  const itemDiv = document.createElement('div');
                  itemDiv.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer';
                  // çµ„åˆç©´ä½åç¨±ç”¨æ–¼åˆ—è¡¨é¡¯ç¤ºï¼ˆä¸å†é¡¯ç¤ºä¸»ç©´/é…ç©´ï¼‰
                  const pointsText = (combo.points && combo.points.length > 0)
                    ? combo.points.map(pt => {
                        const pName = pt && pt.name ? window.escapeHtml(pt.name) : '';
                        return pName;
                      }).join('ã€')
                    : '';
                  const safeComboName = combo.name ? window.escapeHtml(combo.name) : '';
                  itemDiv.innerHTML = `
                    <div class="font-semibold text-gray-800 mb-1">${safeComboName}</div>
                    <div class="text-sm text-gray-600">${pointsText}</div>
                  `;
                  itemDiv.onclick = function() {
                    selectAcupointCombo(combo.id);
                  };
                  listContainer.appendChild(itemDiv);
                });
              }
              modal.classList.remove('hidden');
            } catch (error) {
              console.error('é¡¯ç¤ºå¸¸ç”¨ç©´ä½å½ˆçª—éŒ¯èª¤:', error);
            }
          }

          function hideAcupointComboModal() {
            const modal = document.getElementById('acupointComboModal');
            if (modal) modal.classList.add('hidden');
          }

          /**
           * ç•¶é¸æ“‡æŸå€‹å¸¸ç”¨ç©´ä½çµ„åˆæ™‚ï¼Œå°‡å…¶å…§å®¹å¡«å…¥é‡ç¸å‚™è¨»æ¬„ã€‚
           * @param {number} comboId çµ„åˆçš„ ID
           */
          function selectAcupointCombo(comboId) {
            try {
              const combo = acupointCombinations.find(c => String(c.id) === String(comboId));
              if (!combo) return;
              hideAcupointComboModal();
              const notesEl = document.getElementById('formAcupunctureNotes');
              if (notesEl) {
                // è‹¥æœ‰æ—¢æœ‰å…§å®¹ï¼Œå°‡æ¸¸æ¨™ç§»è‡³æœ«å°¾ï¼Œæº–å‚™æ’å…¥
                // ä½¿ç”¨ addAcupointToNotes å°‡æ¯å€‹ç©´ä½ä»¥æ–¹å¡Šå½¢å¼æ’å…¥
                try {
                  if (Array.isArray(combo.points) && combo.points.length > 0) {
                    combo.points.forEach(pt => {
                      if (pt && pt.name) {
                        addAcupointToNotes(pt.name);
                      }
                    });
                  }
                  // æ’å…¥é‡æ³•æ–‡å­—ï¼ˆå¦‚æœ‰ï¼‰
                  if (combo.technique && combo.technique.trim()) {
                    // æ–°å¢žä¸€å€‹æ–‡å­—ç¯€é»žï¼ˆå«å‰å°Žæ–‡å­—ï¼‰
                    const prefix = 'é‡æ³•ï¼š';
                    // è‹¥å‚™è¨»å€å·²æœ‰å…§å®¹ä¸”æœ«å°¾ä¸æ˜¯ç©ºç™½ï¼Œå‰‡æ·»åŠ ä¸€å€‹ç©ºæ ¼åˆ†éš”
                    const lastChild = notesEl.lastChild;
                    if (lastChild && lastChild.nodeType === Node.TEXT_NODE) {
                      // ok
                    } else {
                      // è‹¥æœ€å¾Œä¸æ˜¯æ–‡å­—ç¯€é»žï¼Œå…ˆæ·»åŠ ä¸€å€‹ç©ºæ ¼
                      notesEl.appendChild(document.createTextNode(' '));
                    }
                    notesEl.appendChild(document.createTextNode(prefix + combo.technique));
                  }
                } catch (_e) {
                  // fallbackï¼šè‹¥ addAcupointToNotes åŸ·è¡Œå¤±æ•—ï¼Œå‰‡ç›´æŽ¥å°‡æ–‡å­—æ’å…¥
                  let noteStr = '';
                  if (Array.isArray(combo.points) && combo.points.length > 0) {
                    noteStr += combo.points.map(pt => pt.name).join('ã€');
                  }
                  if (combo.technique && combo.technique.trim()) {
                    if (noteStr.length > 0) noteStr += 'ï¼Œ';
                    noteStr += 'é‡æ³•ï¼š' + combo.technique;
                  }
                  notesEl.innerText = noteStr;
                }
              }
              showToast('å·²è¼‰å…¥å¸¸ç”¨ç©´ä½çµ„åˆï¼š' + combo.name, 'success');
            } catch (error) {
              console.error('è¼‰å…¥å¸¸ç”¨ç©´ä½çµ„åˆéŒ¯èª¤:', error);
            }
          }


          // æ¸²æŸ“é†«å›‘æ¨¡æ¿
          function renderPrescriptionTemplates(list, pageChange = false) {
            const container = document.getElementById('prescriptionTemplatesContainer');
            container.innerHTML = '';
            // å–å¾—è¦é¡¯ç¤ºçš„æ¨¡æ¿åˆ—è¡¨ï¼›è‹¥å‚³å…¥ç‰¹å®šåˆ—è¡¨å‰‡ä½¿ç”¨ä¹‹ï¼Œå¦å‰‡ä½¿ç”¨å…¨åŸŸåˆ—è¡¨ã€‚
            const templates = Array.isArray(list) ? list : prescriptionTemplates;
            // éŽæ¿¾æŽ‰å°šæœªå„²å­˜çš„æ–°å»ºé …ç›®
            const displayTemplates = Array.isArray(templates) ? templates.filter(t => !t.isNew) : [];
            // æ›´æ–°é†«å›‘æ¨¡æ¿ç¸½æ•¸è‡³æ¨™ç±¤é¡¯ç¤º
            try {
              const totalCount = Array.isArray(prescriptionTemplates)
                ? prescriptionTemplates.filter(p => p && !p.isNew).length
                : 0;
              const countElem = document.getElementById('prescriptionCount');
              if (countElem) {
                // Update the displayed total count
                const newCount = String(totalCount);
                countElem.textContent = newCount;
                /*
                 * Also update the i18n metadata on this element. When switching
                 * languages, the translation script relies on dataset.originalText
                 * to restore the original Chinese text. If this element was
                 * initialised with a placeholder value (e.g. "1") it will be
                 * stored as dataset.originalText and reused whenever the
                 * language toggles, causing the count to revert to that initial
                 * value. By refreshing dataset.originalText with the current
                 * count we ensure the translation logic treats the updated
                 * numeric value as the new "original" and does not revert it.
                 */
                try {
                  if (countElem.dataset) {
                    countElem.dataset.originalText = newCount;
                    // Reset lastLang so translation will re-evaluate this node
                    // the next time the language changes. An empty string
                    // forces translateNode to process the element instead of
                    // skipping it because of a matching lastLang.
                    countElem.dataset.lastLang = '';
                  }
                } catch (_err) {}
              }
            } catch (_e) {}
            // åˆ†é ï¼šè‹¥éžé é¢è·³è½‰å‰‡é‡ç½®è‡³ç¬¬ä¸€é 
            if (!pageChange) {
              paginationSettings.prescriptionTemplates.currentPage = 1;
            }
            const totalItems = displayTemplates.length;
            const itemsPerPage = paginationSettings.prescriptionTemplates.itemsPerPage;
            let currentPage = paginationSettings.prescriptionTemplates.currentPage;
            const totalPages = totalItems > 0 ? Math.ceil(totalItems / itemsPerPage) : 1;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            paginationSettings.prescriptionTemplates.currentPage = currentPage;
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = displayTemplates.slice(startIdx, endIdx);
            // è‹¥ç„¡æ¨¡æ¿è³‡æ–™
            if (!pageItems || pageItems.length === 0) {
              container.innerHTML = '<div class="text-center text-gray-500 py-8">æš«ç„¡é†«å›‘æ¨¡æ¿</div>';
              const paginEl = ensurePaginationContainer('prescriptionTemplatesContainer', 'prescriptionTemplatesPagination');
              if (paginEl) {
                paginEl.innerHTML = '';
                paginEl.classList.add('hidden');
              }
              return;
            }
            // æ¸²æŸ“ç•¶å‰é æ¨¡æ¿
            pageItems.forEach(item => {
              const card = document.createElement('div');
              card.className = 'bg-white p-6 rounded-lg border-2 border-purple-200';
              card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="text-lg font-semibold text-purple-800">${item.name}</h3>
                    <div class="flex gap-2 mt-1">
                      <span class="text-sm bg-purple-100 text-purple-700 px-2 py-1 rounded">${item.category}</span>
                      <span class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded">ç™‚ç¨‹: ${item.duration}</span>
                      <span class="text-sm bg-orange-100 text-orange-700 px-2 py-1 rounded">è¤‡è¨º: ${item.followUp}</span>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    
                  </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg text-gray-700">
                  ${item.content.split('\n').map(p => '<p class="mb-2">' + p + '</p>').join('')}
                </div>
              `;
              container.appendChild(card);
            });
            // åˆ†é æŽ§åˆ¶
            const paginEl = ensurePaginationContainer('prescriptionTemplatesContainer', 'prescriptionTemplatesPagination');
            renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
              paginationSettings.prescriptionTemplates.currentPage = newPage;
              renderPrescriptionTemplates(templates, true);
            }, paginEl);
          }


          // æ¸²æŸ“è¨ºæ–·æ¨¡æ¿
          function renderDiagnosisTemplates(list, pageChange = false) {
            const container = document.getElementById('diagnosisTemplatesContainer');
            container.innerHTML = '';
            // å–å¾—è¦é¡¯ç¤ºçš„è¨ºæ–·æ¨¡æ¿åˆ—è¡¨ï¼›è‹¥å‚³å…¥ç‰¹å®šåˆ—è¡¨å‰‡ä½¿ç”¨ä¹‹ï¼Œå¦å‰‡ä½¿ç”¨å…¨åŸŸåˆ—è¡¨ã€‚
            const templates = Array.isArray(list) ? list : diagnosisTemplates;
            // éŽæ¿¾æŽ‰å°šæœªå„²å­˜çš„æ¨¡æ¿
            const displayTemplates = Array.isArray(templates) ? templates.filter(t => !t.isNew) : [];
            // æ›´æ–°è¨ºæ–·æ¨¡æ¿ç¸½æ•¸è‡³æ¨™ç±¤é¡¯ç¤º
            try {
              const totalCount = Array.isArray(diagnosisTemplates)
                ? diagnosisTemplates.filter(t => t && !t.isNew).length
                : 0;
              const countElem = document.getElementById('diagnosisCount');
              if (countElem) {
                // Update the displayed total count
                const newCount = String(totalCount);
                countElem.textContent = newCount;
                /*
                 * Refresh the i18n metadata for this element. Without updating
                 * dataset.originalText the translation system will revert this
                 * count back to its initial value (often 1) whenever the
                 * language is toggled. Setting dataset.originalText to the
                 * current count ensures that language switching preserves the
                 * correct value. Resetting dataset.lastLang forces the
                 * translation function to reprocess this element when the
                 * language changes, thereby using the updated originalText.
                 */
                try {
                  if (countElem.dataset) {
                    countElem.dataset.originalText = newCount;
                    countElem.dataset.lastLang = '';
                  }
                } catch (_err) {}
              }
            } catch (_e) {}
            // åˆ†é ï¼šéžé é¢è·³è½‰æ™‚é‡ç½®é æ•¸
            if (!pageChange) {
              paginationSettings.diagnosisTemplates.currentPage = 1;
            }
            const totalItems = displayTemplates.length;
            const itemsPerPage = paginationSettings.diagnosisTemplates.itemsPerPage;
            let currentPage = paginationSettings.diagnosisTemplates.currentPage;
            const totalPages = totalItems > 0 ? Math.ceil(totalItems / itemsPerPage) : 1;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            paginationSettings.diagnosisTemplates.currentPage = currentPage;
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = displayTemplates.slice(startIdx, endIdx);
            // è‹¥ç„¡è³‡æ–™é¡¯ç¤ºæç¤ºä¸¦éš±è—åˆ†é 
            if (!pageItems || pageItems.length === 0) {
              container.innerHTML = '<div class="text-center text-gray-500 py-8">æš«ç„¡è¨ºæ–·æ¨¡æ¿</div>';
              const paginEl = ensurePaginationContainer('diagnosisTemplatesContainer', 'diagnosisTemplatesPagination');
              if (paginEl) {
                paginEl.innerHTML = '';
                paginEl.classList.add('hidden');
              }
              return;
            }
            // æ¸²æŸ“ç•¶å‰é è³‡æ–™
            pageItems.forEach(item => {
              const card = document.createElement('div');
              card.className = 'bg-white p-6 rounded-lg border-2 border-orange-200';
              // Build display content for diagnosis template fields.
              let contentHtml = '';
              if (item.chiefComplaint || item.currentHistory || item.tongue || item.pulse || item.tcmDiagnosis || item.syndromeDiagnosis) {
                const parts = [];
                if (item.chiefComplaint) {
                  parts.push('<p class="mb-2"><strong>ä¸»è¨´ï¼š</strong>' + String(item.chiefComplaint).split('\n').map(l => l).join('<br>') + '</p>');
                }
                if (item.currentHistory) {
                  parts.push('<p class="mb-2"><strong>ç¾ç—…å²ï¼š</strong>' + String(item.currentHistory).split('\n').map(l => l).join('<br>') + '</p>');
                }
                if (item.tongue) {
                  parts.push('<p class="mb-2"><strong>èˆŒè±¡ï¼š</strong>' + String(item.tongue).split('\n').map(l => l).join('<br>') + '</p>');
                }
                if (item.pulse) {
                  parts.push('<p class="mb-2"><strong>è„ˆè±¡ï¼š</strong>' + String(item.pulse).split('\n').map(l => l).join('<br>') + '</p>');
                }
                if (item.tcmDiagnosis) {
                  parts.push('<p class="mb-2"><strong>ä¸­é†«è¨ºæ–·ï¼š</strong>' + String(item.tcmDiagnosis).split('\n').map(l => l).join('<br>') + '</p>');
                }
                if (item.syndromeDiagnosis) {
                  parts.push('<p class="mb-2"><strong>è­‰åž‹è¨ºæ–·ï¼š</strong>' + String(item.syndromeDiagnosis).split('\n').map(l => l).join('<br>') + '</p>');
                }
                contentHtml = parts.join('');
              } else if (item.content) {
                contentHtml = item.content.split('\n').map(p => '<p class="mb-2">' + p + '</p>').join('');
              }
              card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="text-lg font-semibold text-orange-800">${item.name}</h3>
                    <div class="flex gap-2 mt-1">
                      <span class="text-sm bg-orange-100 text-orange-700 px-2 py-1 rounded">${item.category}</span>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    
                  </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg text-gray-700">
                  ${contentHtml}
                </div>
              `;
              container.appendChild(card);
            });
            // åˆ†é æŽ§åˆ¶
            const paginEl = ensurePaginationContainer('diagnosisTemplatesContainer', 'diagnosisTemplatesPagination');
            renderPagination(totalItems, itemsPerPage, currentPage, function(newPage) {
              paginationSettings.diagnosisTemplates.currentPage = newPage;
              renderDiagnosisTemplates(templates, true);
            }, paginEl);
          }

          

          /**
           * åˆå§‹åŒ–æ¨¡æ¿åº«æœå°‹åŠŸèƒ½ï¼Œç¶å®šæœå°‹å’Œåˆ†é¡žè®Šæ›´äº‹ä»¶ã€‚
           * æ ¹æ“šè¼¸å…¥çš„åç¨±é—œéµå­—å’Œé¸æ“‡çš„åˆ†é¡žç¯©é¸é†«å›‘æˆ–è¨ºæ–·æ¨¡æ¿ï¼Œä¸¦é‡æ–°æ¸²æŸ“åˆ—è¡¨ã€‚
           * ä½¿ç”¨è€…è¼¸å…¥æˆ–é¸æ“‡è®Šæ›´æ™‚å³æ™‚è§¸ç™¼ã€‚
           */
          function setupTemplateLibrarySearch() {
            try {
              // é†«å›‘æ¨¡æ¿æœå°‹èˆ‡åˆ†é¡ž
              const pInput = document.getElementById('prescriptionTemplateSearch');
              const pCategory = document.getElementById('prescriptionTemplateCategoryFilter');
              /**
               * ä¾æ“šæœå°‹å­—ä¸²å’Œåˆ†é¡žç¯©é¸é†«å›‘æ¨¡æ¿ã€‚
               * ä»¥å‰åƒ…æ¯”å°æ¨¡æ¿åç¨±ï¼Œç¾åœ¨æ”¹ç‚ºå°‡æ¨¡æ¿çš„æ‰€æœ‰ä¸»è¦æ¬„ä½åˆä½µå¾Œé€²è¡Œå…¨æ–‡æœå°‹ï¼Œ
               * ä»¥ä¾¿ä½¿ç”¨è€…èƒ½é€éŽå…§å®¹é—œéµå­—å¿«é€Ÿæ‰¾åˆ°ç›¸é—œé†«å›‘æ¨¡æ¿ã€‚
               */
              const filterPrescriptions = function() {
                const term = pInput ? pInput.value.trim().toLowerCase() : '';
                const cat = pCategory ? pCategory.value : '';
                let filtered = Array.isArray(prescriptionTemplates) ? prescriptionTemplates.filter(item => {
                  // å…¨æ–‡æœå°‹ï¼šå°‡æ‰€æœ‰å€¼ï¼ˆå­—ä¸²/æ•¸å€¼/é™£åˆ—ï¼‰ä¸²æŽ¥ä¸¦è½‰å°å¯«
                  if (!term) return true;
                  try {
                    let combined = '';
                    Object.keys(item).forEach(key => {
                      if (['id', 'isNew', 'lastModified'].includes(key)) return;
                      const v = item[key];
                      if (!v) return;
                      if (Array.isArray(v)) {
                        combined += ' ' + v.join(' ');
                      } else if (typeof v === 'string' || typeof v === 'number') {
                        combined += ' ' + String(v);
                      }
                    });
                    combined = combined.toLowerCase();
                    return combined.includes(term);
                  } catch (_e) {
                    return false;
                  }
                }) : [];
                // è‹¥é¸æ“‡éžå…¨éƒ¨é¡žåˆ¥ï¼Œå‰‡ä¾æ“šé¡žåˆ¥é€²ä¸€æ­¥ç¯©é¸
                if (cat && cat !== 'å…¨éƒ¨é¡žåˆ¥' && cat !== 'å…¨éƒ¨åˆ†é¡ž') {
                  filtered = filtered.filter(item => item.category === cat);
                }
                // æœå°‹æˆ–åˆ†é¡žè®Šæ›´æ™‚å°‡é ç¢¼é‡ç½®ç‚º 1
                paginationSettings.prescriptionTemplates.currentPage = 1;
                renderPrescriptionTemplates(filtered);
              };
              if (pInput) {
                pInput.addEventListener('input', filterPrescriptions);
              }
              if (pCategory) {
                pCategory.addEventListener('change', filterPrescriptions);
              }

              // è¨ºæ–·æ¨¡æ¿æœå°‹èˆ‡åˆ†é¡ž
              const dInput = document.getElementById('diagnosisTemplateSearch');
              const dCategory = document.getElementById('diagnosisTemplateCategoryFilter');
              /**
               * ä¾æ“šæœå°‹å­—ä¸²å’Œåˆ†é¡žç¯©é¸è¨ºæ–·æ¨¡æ¿ã€‚
               * èˆ‡é†«å›‘æ¨¡æ¿é¡žä¼¼ï¼Œå°‡æ¨¡æ¿çš„ä¸»è¦å…§å®¹ï¼ˆåŒ…å«ä¸»è¨´ã€ç¾ç—…å²ã€èˆŒè±¡ã€è„ˆè±¡ã€
               * ä¸­é†«è¨ºæ–·ã€è­‰åž‹è¨ºæ–·åŠä¸€èˆ¬ content æ¬„ä½ï¼‰åˆä½µç‚ºä¸€æ®µæ–‡å­—é€²è¡Œå…¨æ–‡æœå°‹ã€‚
               */
              const filterDiagnosis = function() {
                const term = dInput ? dInput.value.trim().toLowerCase() : '';
                const cat = dCategory ? dCategory.value : '';
                let filtered = Array.isArray(diagnosisTemplates) ? diagnosisTemplates.filter(item => {
                  if (!term) return true;
                  try {
                    let combined = '';
                    Object.keys(item).forEach(key => {
                      if (['id', 'isNew', 'lastModified'].includes(key)) return;
                      const v = item[key];
                      if (!v) return;
                      if (Array.isArray(v)) {
                        combined += ' ' + v.join(' ');
                      } else if (typeof v === 'string' || typeof v === 'number') {
                        combined += ' ' + String(v);
                      }
                    });
                    combined = combined.toLowerCase();
                    return combined.includes(term);
                  } catch (_e) {
                    return false;
                  }
                }) : [];
                if (cat && cat !== 'å…¨éƒ¨ç§‘åˆ¥' && cat !== 'å…¨éƒ¨åˆ†é¡ž') {
                  filtered = filtered.filter(item => item.category === cat);
                }
                // æœå°‹æˆ–åˆ†é¡žè®Šæ›´æ™‚é‡ç½®é ç¢¼
                paginationSettings.diagnosisTemplates.currentPage = 1;
                renderDiagnosisTemplates(filtered);
              };
              if (dInput) {
                dInput.addEventListener('input', filterDiagnosis);
              }
              if (dCategory) {
                dCategory.addEventListener('change', filterDiagnosis);
              }
            } catch (e) {
              console.error('åˆå§‹åŒ–æ¨¡æ¿åº«æœå°‹åŠŸèƒ½å¤±æ•—:', e);
            }
          }

          // åˆ‡æ›å€‹äººè¨­ç½®æ¨™ç±¤
          function switchPersonalTab(tabId) {
            const tabContents = document.querySelectorAll('.personal-tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));
            if (tabId === 'herbs') {
              document.getElementById('herbsContent').classList.remove('hidden');
            } else if (tabId === 'acupoints') {
              document.getElementById('acupointsContent').classList.remove('hidden');
            }
            const tabButtons = ['herbsTab', 'acupointsTab'];
            tabButtons.forEach(buttonId => {
              const button = document.getElementById(buttonId);
              if (buttonId === tabId + 'Tab') {
                button.className = 'px-6 py-3 text-amber-700 border-b-2 border-amber-500 font-medium';
              } else {
                button.className = 'px-6 py-3 text-gray-500 hover:text-amber-700 font-medium';
              }
            });
          }

          // åˆ‡æ›æ¨¡æ¿åº«æ¨™ç±¤
          function switchTemplateTab(tabId) {
            const tabContents = document.querySelectorAll('.template-tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));
            if (tabId === 'prescriptions') {
              document.getElementById('prescriptionsContent').classList.remove('hidden');
            } else if (tabId === 'diagnosis') {
              document.getElementById('diagnosisContent').classList.remove('hidden');
            }
            const tabButtons = ['prescriptionsTab', 'diagnosisTab'];
            tabButtons.forEach(buttonId => {
              const button = document.getElementById(buttonId);
              if (buttonId === tabId + 'Tab') {
                button.className = 'px-6 py-3 text-amber-700 border-b-2 border-amber-500 font-medium';
              } else {
                button.className = 'px-6 py-3 text-gray-500 hover:text-amber-700 font-medium';
              }
            });

            // æ¯æ¬¡åˆ‡æ›æ¨¡æ¿æ¨™ç±¤æ™‚æ›´æ–°åˆ†é¡žä¸‹æ‹‰é¸å–®ï¼Œ
            // ä»¥ä¾¿ç«‹å³åæ˜ æ–°å¢žæˆ–åˆªé™¤å¾Œçš„åˆ†é¡ž
            if (typeof refreshTemplateCategoryFilters === 'function') {
              try {
                refreshTemplateCategoryFilters();
              } catch (_e) {}
            }
          }

          // é¡¯ç¤ºåˆ†é¡žç®¡ç†å½ˆçª—
          function showCategoryModal(type) {
            const modal = document.getElementById('categoryModal');
            const titleEl = document.getElementById('categoryModalTitle');
            const listEl = document.getElementById('categoryList');
            const titles = {
              herbs: 'ç®¡ç†ä¸­è—¥åˆ†é¡ž',
              acupoints: 'ç®¡ç†ç©´ä½åˆ†é¡ž',
              prescriptions: 'ç®¡ç†é†«å›‘åˆ†é¡ž',
              diagnosis: 'ç®¡ç†è¨ºæ–·åˆ†é¡ž'
            };
            titleEl.textContent = titles[type] || 'ç®¡ç†åˆ†é¡ž';
            modal.classList.remove('hidden');
            modal.dataset.type = type;
            // æ¸²æŸ“åˆ†é¡žåˆ—è¡¨
            listEl.innerHTML = '';
            // ç‚º herbs å’Œ acupoints é¸æ“‡ä¾†æºï¼šè‹¥å…¨åŸŸ categories ä¸­æœ‰å€¼å‰‡ä½¿ç”¨ï¼Œå¦å‰‡ä½¿ç”¨å€‹äººåˆ†é¡ž
            let sourceList = [];
            try {
              if (type === 'herbs') {
                if (Array.isArray(categories.herbs) && categories.herbs.length > 0) {
                  sourceList = categories.herbs;
                } else if (Array.isArray(herbComboCategories) && herbComboCategories.length > 0) {
                  sourceList = herbComboCategories;
                }
              } else if (type === 'acupoints') {
                if (Array.isArray(categories.acupoints) && categories.acupoints.length > 0) {
                  sourceList = categories.acupoints;
                } else if (Array.isArray(acupointComboCategories) && acupointComboCategories.length > 0) {
                  sourceList = acupointComboCategories;
                }
              } else {
                // å…¶ä»–åˆ†é¡žï¼ˆprescriptions, diagnosisï¼‰ç›´æŽ¥è®€å–å…¨åŸŸ categories
                if (categories[type] && Array.isArray(categories[type])) {
                  sourceList = categories[type];
                }
              }
            } catch (_e) {
              // è‹¥å‡ºç¾éŒ¯èª¤å‰‡ä¿æŒç©ºåˆ—è¡¨
            }
            // fallback: è‹¥ä¾†æºåˆ—è¡¨ä»ç‚ºç©ºï¼Œå˜—è©¦ä½¿ç”¨ categories[type]
            if ((!sourceList || sourceList.length === 0) && categories[type] && Array.isArray(categories[type])) {
              sourceList = categories[type];
            }
            sourceList.forEach((cat, idx) => {
              const div = document.createElement('div');
              div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
              div.innerHTML = `
                <span class="text-gray-700">${cat}</span>
                <button onclick="removeCategory('${type}', ${idx})" class="text-red-600 hover:text-red-800 text-sm">åˆªé™¤</button>
              `;
              listEl.appendChild(div);
            });
          }

          function hideCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
            document.getElementById('newCategoryInput').value = '';
          }

          function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const type = document.getElementById('categoryModal').dataset.type;
            const newCategory = input.value.trim();
            // å°‡åˆ†é¡žåç¨±çµ±ä¸€è½‰ç‚ºå°å¯«ä¸¦ç§»é™¤ç©ºç™½ï¼Œç”¨æ–¼æª¢æŸ¥æ˜¯å¦é‡è¤‡
            const normalizedNew = newCategory.replace(/\s+/g, '').toLowerCase();
            const hasDup = Array.isArray(categories[type]) && categories[type].some(cat => {
              return String(cat).replace(/\s+/g, '').toLowerCase() === normalizedNew;
            });
            if (newCategory && !hasDup) {
              // æŽ¨å…¥æœªè™•ç†éŽçš„åˆ†é¡žåç¨±ï¼Œä»¥ä¿ç•™ä½¿ç”¨è€…è¼¸å…¥çš„åŽŸå§‹æ ¼å¼
              categories[type].push(newCategory);
              // å¦‚ç‚ºé†«å›‘æˆ–è¨ºæ–·åˆ†é¡žï¼Œåˆ·æ–°æ¨¡æ¿åˆ†é¡žç¯©é¸ä¸‹æ‹‰é¸å–®
              if (type === 'prescriptions' || type === 'diagnosis') {
                if (typeof refreshTemplateCategoryFilters === 'function') {
                  try {
                    refreshTemplateCategoryFilters();
                  } catch (_e) {}
                }
              }
              // è‹¥ä¿®æ”¹çš„æ˜¯ä¸­è—¥æˆ–ç©´ä½åˆ†é¡žï¼Œæ›´æ–°å€‹äººæ…£ç”¨åˆ†é¡ž
              if (typeof refreshComboCategories === 'function') {
                refreshComboCategories(type);
              }
              showCategoryModal(type);
              input.value = '';
              // å°‡æ›´æ–°å¾Œçš„åˆ†é¡žå„²å­˜è‡³ Firebase æˆ–æœ¬åœ°
              if (typeof saveCategoriesToFirebase === 'function') {
                try {
                  saveCategoriesToFirebase().catch(err => console.error('ä¿å­˜åˆ†é¡žè³‡æ–™å¤±æ•—:', err));
                } catch (_e) {}
              }
              // ç«‹å³åœ¨ localStorage ä¸­ä¿å­˜åˆ†é¡žï¼Œé¿å…éžåŒæ­¥æˆ– Firebase ä¸å¯ç”¨æ™‚è³‡æ–™éºå¤±
              if (typeof persistCategoriesLocally === 'function') {
                try {
                  persistCategoriesLocally();
                } catch (_e) {}
              }
              // å¦‚å±¬ herbs æˆ– acupointsï¼ŒåŒæ­¥ä¿å­˜å€‹äººè¨­å®šä¸­çš„åˆ†é¡žè³‡æ–™
              if ((type === 'herbs' || type === 'acupoints') && typeof updatePersonalSettings === 'function') {
                try {
                  updatePersonalSettings().catch(err => console.error('æ›´æ–°å€‹äººè¨­ç½®å¤±æ•—:', err));
                } catch (_e) {}
              }
            }
          }

          async function removeCategory(type, index) {
            // åˆªé™¤æ­¤åˆ†é¡žç¢ºèªè¨Šæ¯æ”¯æ´ä¸­è‹±æ–‡
            {
              const lang = localStorage.getItem('lang') || 'zh';
              const zhMsg = 'ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡žå—Žï¼Ÿ';
              const enMsg = 'Are you sure you want to delete this category?';
              const confirmed = await showConfirmation(lang === 'en' ? enMsg : zhMsg, 'warning');
              if (!confirmed) {
                return;
              }
            }
            // å…ˆå¾žå…¨åŸŸåˆ†é¡žä¸­ç§»é™¤ç›®æ¨™åˆ†é¡žä¸¦å–å¾—è¢«ç§»é™¤çš„åç¨±
            let removedArr = [];
            try {
              removedArr = categories[type].splice(index, 1);
            } catch (_e) {
              removedArr = [];
              const removed = Array.isArray(removedArr) ? removedArr[0] : undefined;
              // è‹¥ä¿®æ”¹çš„æ˜¯ä¸­è—¥æˆ–ç©´ä½åˆ†é¡žï¼Œå‰‡éœ€åŒæ­¥æ›´æ–°å€‹äººæ…£ç”¨åˆ†é¡žï¼Œç§»é™¤å·²åˆªé™¤çš„åˆ†é¡ž
              try {
                if (type === 'herbs' && Array.isArray(herbComboCategories)) {
                  if (removed !== undefined) {
                    herbComboCategories = herbComboCategories.filter(cat => cat !== removed);
                    window.herbComboCategories = herbComboCategories;
                  }
                } else if (type === 'acupoints' && Array.isArray(acupointComboCategories)) {
                  if (removed !== undefined) {
                    acupointComboCategories = acupointComboCategories.filter(cat => cat !== removed);
                    window.acupointComboCategories = acupointComboCategories;
                  }
                }
              } catch (_e) {}
              // æ›´æ–°æœå°‹èˆ‡åˆ†é¡žé¸å–®ï¼Œä½¿ UI ç«‹å³åæ˜ æœ€æ–°çš„åˆ†é¡ž
              try {
                if (typeof refreshComboCategories === 'function') {
                  refreshComboCategories(type);
                }
                if (typeof setupPersonalComboSearchAndFilter === 'function') {
                  setupPersonalComboSearchAndFilter();
                }
              } catch (_e) {}
              // è‹¥åˆªé™¤çš„æ˜¯é†«å›‘æˆ–è¨ºæ–·åˆ†é¡žï¼Œåˆ·æ–°æ¨¡æ¿åˆ†é¡žç¯©é¸ä¸‹æ‹‰é¸å–®
              if (type === 'prescriptions' || type === 'diagnosis') {
                if (typeof refreshTemplateCategoryFilters === 'function') {
                  try {
                    refreshTemplateCategoryFilters();
                  } catch (_e) {}
                }
              }
              // é‡æ–°æ¸²æŸ“åˆ†é¡žç®¡ç†å½ˆçª—
              showCategoryModal(type);
              // å°‡æ›´æ–°å¾Œçš„åˆ†é¡žå„²å­˜è‡³ Firebase æˆ–æœ¬åœ°
              if (typeof saveCategoriesToFirebase === 'function') {
                try {
                  saveCategoriesToFirebase().catch(err => console.error('ä¿å­˜åˆ†é¡žè³‡æ–™å¤±æ•—:', err));
                } catch (_e) {}
              }
              // ç«‹å³åœ¨ localStorage ä¸­ä¿å­˜åˆ†é¡žï¼Œé¿å…éžåŒæ­¥æˆ– Firebase ä¸å¯ç”¨æ™‚è³‡æ–™éºå¤±
              if (typeof persistCategoriesLocally === 'function') {
                try {
                  persistCategoriesLocally();
                } catch (_e) {}
              }
              // å¦‚å±¬ herbs æˆ– acupointsï¼ŒåŒæ­¥ä¿å­˜å€‹äººè¨­å®šä¸­çš„åˆ†é¡žè³‡æ–™
              if ((type === 'herbs' || type === 'acupoints') && typeof updatePersonalSettings === 'function') {
                try {
                  updatePersonalSettings().catch(err => console.error('æ›´æ–°å€‹äººè¨­ç½®å¤±æ•—:', err));
                } catch (_e) {}
              }
            }
          }

          // é¡¯ç¤ºç·¨è¼¯å½ˆçª—
          function showEditModal(itemType, title) {
            const modal = document.getElementById('editModal');
            const modalTitle = document.getElementById('editModalTitle');
            const modalContent = document.getElementById('editModalContent');
            // å°‡ç•¶å‰ç·¨è¼¯é¡žåž‹å­˜æ–¼ modal dataset ä¸­ï¼Œä»¥ä¾¿ä¿å­˜æ™‚ä½¿ç”¨
            modal.dataset.editType = itemType;
            // æ ¹æ“š itemType å°‹æ‰¾å°æ‡‰çš„è³‡æ–™é™£åˆ—èˆ‡é¡¯ç¤ºåç¨±
            let item = null;
            const typeNames = {
              herb: 'è—¥æ–¹çµ„åˆ',
              acupoint: 'ç©´ä½çµ„åˆ',
              prescription: 'é†«å›‘æ¨¡æ¿',
              diagnosis: 'è¨ºæ–·æ¨¡æ¿'
            };
            if (itemType === 'herb') {
              item = herbCombinations.find(h => h.name === title);
            } else if (itemType === 'acupoint') {
              item = acupointCombinations.find(a => a.name === title);
            } else if (itemType === 'prescription') {
              // ç•¶æ¨™é¡Œç‚ºç©ºæ™‚ï¼Œå„ªå…ˆå°‹æ‰¾æ¨™è¨˜ç‚ºæ–°å»ºçš„é …ç›®ï¼Œé¿å…å–éŒ¯å°è±¡
              if (title && title.trim()) {
                item = prescriptionTemplates.find(p => p.name === title);
              } else {
                item = prescriptionTemplates.find(p => p.isNew);
                // fallbackï¼šè‹¥ä»æ‰¾ä¸åˆ°ï¼Œå‰‡å¾žå¾Œå¾€å‰å°‹æ‰¾åç¨±ç‚ºç©ºç™½çš„é …ç›®
                if (!item) {
                  for (let i = prescriptionTemplates.length - 1; i >= 0; i--) {
                    const candidate = prescriptionTemplates[i];
                    if (!candidate.name) {
                      item = candidate;
                      break;
                    }
                  }
                }
              }
            } else if (itemType === 'diagnosis') {
              if (title && title.trim()) {
                item = diagnosisTemplates.find(d => d.name === title);
              } else {
                item = diagnosisTemplates.find(d => d.isNew);
                if (!item) {
                  for (let i = diagnosisTemplates.length - 1; i >= 0; i--) {
                    const candidate = diagnosisTemplates[i];
                    if (!candidate.name) {
                      item = candidate;
                      break;
                    }
                  }
                }
              }
            }
            // è‹¥æ‰¾ä¸åˆ°é …ç›®å‰‡è¿”å›žï¼Œä¸é¡¯ç¤ºç·¨è¼¯çª—
            if (!item) return;
            // è¨­å®šç•¶å‰ç·¨è¼¯é …ç›® id æ–¼ dataset ä¸­
            modal.dataset.itemId = item.id;
            // æ¨™é¡Œé¡¯ç¤ºåˆ¤æ–·ï¼šè‹¥ title ç‚ºç©ºï¼Œè¡¨ç¤ºæ–°å»º
            if (title && title.trim()) {
              modalTitle.textContent = 'ç·¨è¼¯' + title;
            } else {
              modalTitle.textContent = 'æ–°å¢ž' + (typeNames[itemType] || 'é …ç›®');
            }
            // æ¨™è¨˜ç•¶å‰æ˜¯å¦ç‚ºæ–°å»ºï¼Œç”¨æ–¼å–æ¶ˆæ™‚æ¸…é™¤
            if (item && item.isNew) {
              modal.dataset.isNew = 'true';
            } else {
              // è‹¥ä¸æ˜¯æ–°å»ºï¼Œç¢ºä¿æ¨™è¨˜è¢«æ¸…é™¤
              delete modal.dataset.isNew;
            }
            // é¡¯ç¤º modal
            modal.classList.remove('hidden');
            // è‹¥ç‚ºç©´ä½çµ„åˆï¼Œä½¿ç”¨æœå°‹ä»‹é¢åŠæç¤ºæ¡†é¡¯ç¤ºå®Œæ•´è³‡æ–™ã€‚æ­¤é‚è¼¯å°‡åœ¨æ­¤è¿”å›žï¼Œé¿å…é€²å…¥èˆŠçš„ç©´ä½åˆ†æ”¯ã€‚
            if (itemType === 'acupoint') {
              // å»ºç«‹å·²å­˜åœ¨ç©´ä½è¡Œçš„ HTMLï¼Œæ¯è¡ŒåŒ…å«æç¤ºè³‡è¨Šã€åç¨±èˆ‡åˆªé™¤æŒ‰éˆ•
              const acupointRowsHtml = Array.isArray(item.points)
                ? item.points.map(pt => {
                    const nameVal = (pt && pt.name) ? pt.name : '';
                    const tooltipContent = getAcupointTooltipContent(nameVal);
                    const encoded = tooltipContent ? encodeURIComponent(tooltipContent) : '';
                    const nameAttr = nameVal ? (' data-acupoint-name="' + nameVal.replace(/\"/g, '&quot;') + '"') : '';
                    let tooltipAttr = '';
                    if (tooltipContent) {
                      // å°‡é¼ æ¨™æç¤ºå­—ä¸²ä¸­çš„å–®å¼•è™Ÿæ­£ç¢ºè·³è„«ï¼Œä½¿ç”¨ data-tooltip å±¬æ€§
                      tooltipAttr = ' data-tooltip="' + encoded + '" onmouseenter="showTooltip(event, this.getAttribute(\'data-tooltip\'))" onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()"';
                    }
                    return '<div class="flex items-center gap-2 p-2 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded"' + nameAttr + tooltipAttr + '>' +
                      '<span class="flex-1 text-blue-800">' + (typeof window !== 'undefined' && window.escapeHtml ? window.escapeHtml(nameVal) : nameVal) + '</span>' +
                      '<button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeParentElement(this)">åˆªé™¤</button>' +
                      '</div>';
                  }).join('')
                : '';
              modalContent.innerHTML = `
                <div class="space-y-4">
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">çµ„åˆåç¨± *</label>
                    <input type="text" id="acupointNameInput" value="${item.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">åˆ†é¡ž</label>
                    <select id="acupointCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                      ${(Array.isArray(acupointComboCategories) && acupointComboCategories.length > 0 ? acupointComboCategories : categories.acupoints).map(cat => '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>').join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">æœå°‹ç©´ä½</label>
                    <input type="text" id="acupointPointSearch" placeholder="æœå°‹ç©´ä½åç¨±ã€å®šä½ã€åŠŸèƒ½æˆ–ç¶“çµ¡..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none" oninput="searchAcupointForCombo()">
                    <div id="acupointPointSearchResults" class="hidden">
                      <div class="bg-white border border-blue-200 rounded max-h-40 overflow-y-auto">
                        <div id="acupointPointSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2"></div>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">ç©´ä½</label>
                    <div id="acupointPoints" class="space-y-2">${acupointRowsHtml}</div>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">é‡æ³•</label>
                    <input type="text" id="acupointTechniqueInput" value="${item.technique || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                  </div>
                </div>
              `;
              return;
            }
            // æ ¹æ“šä¸åŒé¡žåž‹æ¸²æŸ“ç·¨è¼¯å…§å®¹
            if (itemType === 'herb') {
              // ä½¿ç”¨ç¶ è‰²é•·æ–¹æ ¼é¡¯ç¤ºæ—¢æœ‰è—¥æï¼Œä¸¦æä¾›æœå°‹åŠŸèƒ½æ–°å¢žè—¥æ
              // æ¯å€‹è—¥æè¡ŒåŒ…å«åç¨±ï¼ˆä¸å¯ç·¨è¼¯ï¼‰ã€åŠ‘é‡è¼¸å…¥æ¡†ã€å–®ä½èˆ‡åˆªé™¤æŒ‰éˆ•
              const herbIngredientsHtml = Array.isArray(item.ingredients)
                ? item.ingredients.map(ing => {
                    const nameVal = (ing && ing.name) ? ing.name : '';
                    const dosageVal = (ing && ing.dosage) ? ing.dosage : '';
                    // å–å¾—æç¤ºå…§å®¹ä¸¦é€²è¡Œ URI ç·¨ç¢¼ä¾›å±¬æ€§ä½¿ç”¨
                    const tooltipContent = getHerbTooltipContent(nameVal);
                    const encoded = tooltipContent ? encodeURIComponent(tooltipContent) : '';
                    // å±¬æ€§å­—ä¸²ï¼šè‹¥å­˜åœ¨åç¨±å‰‡æ·»åŠ  data-herb-nameï¼Œè‹¥å­˜åœ¨ tooltip å‰‡æ·»åŠ ç›¸é—œå±¬æ€§èˆ‡äº‹ä»¶
                    const nameAttr = nameVal ? (' data-herb-name="' + nameVal.replace(/\"/g, '&quot;') + '"') : '';
                    let tooltipAttr = '';
                    if (tooltipContent) {
                      tooltipAttr = ' data-tooltip="' + encoded + '" onmouseenter="showTooltip(event, this.getAttribute(\'data-tooltip\'))" onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()"';
                    }
                    return '<div class="flex items-center gap-2 p-2 bg-green-50 hover:bg-green-100 border border-green-200 rounded"' + nameAttr + tooltipAttr + '>' +
                      // åç¨±ä»¥ span é¡¯ç¤ºï¼Œä¸å¯ç·¨è¼¯
                      '<span class="flex-1 text-green-800">' + (typeof window !== 'undefined' && window.escapeHtml ? window.escapeHtml(nameVal) : nameVal) + '</span>' +
                      // åŠ‘é‡è¼¸å…¥æ¬„
                      '<input type="number" value="' + (dosageVal || '') + '" placeholder="" class="w-20 px-2 py-1 border border-gray-300 rounded">' +
                      '<span class="text-sm text-gray-700">å…‹</span>' +
                    '<button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeParentElement(this)">åˆªé™¤</button>' +
                      '</div>';
                  }).join('')
                : '';
              modalContent.innerHTML = `
                <div class="space-y-4">
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">çµ„åˆåç¨± *</label>
                    <input type="text" id="herbNameInput" value="${item.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">åˆ†é¡ž</label>
                    <select id="herbCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                      ${(Array.isArray(herbComboCategories) && herbComboCategories.length > 0 ? herbComboCategories : categories.herbs).map(cat => '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>').join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">é©æ‡‰ç—‡æè¿°</label>
                    <textarea id="herbDescriptionTextarea" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none" rows="3">${item.description || ''}</textarea>
                  </div>
                  <!-- å…ˆé¡¯ç¤ºæœå°‹æ¬„ï¼Œå†åˆ—å‡ºå·²æ·»åŠ çš„è—¥æåˆ—è¡¨ -->
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">æœå°‹è—¥ææˆ–æ–¹åŠ‘</label>
                    <input type="text" id="herbIngredientSearch" placeholder="æœå°‹ä¸­è—¥æã€æ–¹åŠ‘åç¨±æˆ–åŠŸèƒ½..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none" oninput="searchHerbForCombo()">
                    <div id="herbIngredientSearchResults" class="hidden">
                      <div class="bg-white border border-green-200 rounded max-h-40 overflow-y-auto">
                        <div id="herbIngredientSearchList" class="grid grid-cols-1 md:grid-cols-2 gap-2 p-2"></div>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">è—¥æ</label>
                    <div id="herbIngredients" class="space-y-2">
                      ${herbIngredientsHtml}
                    </div>
                  </div>
                </div>
              `;
            } else if (itemType === 'acupoint') {
              modalContent.innerHTML = `
                <div class="space-y-4">
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">çµ„åˆåç¨± *</label>
                    <input type="text" id="acupointNameInput" value="${item.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">åˆ†é¡ž</label>
                    <select id="acupointCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                      ${(Array.isArray(acupointComboCategories) && acupointComboCategories.length > 0 ? acupointComboCategories : categories.acupoints).map(cat => '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>').join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">ç©´ä½åˆ—è¡¨</label>
                    <div id="acupointPoints" class="space-y-2">
${item.points.map(pt => {
  const nameVal = pt && pt.name ? pt.name : '';
  return '<div class="flex items-center gap-2"><input type="text" value="' + nameVal + '" placeholder="ç©´ä½åç¨±" class="flex-1 px-2 py-1 border border-gray-300 rounded"><button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeParentElement(this)">åˆªé™¤</button></div>';
}).join('')}
                    </div>
                    <button onclick="addAcupointPointField()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ æ–°å¢žç©´ä½</button>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">é‡æ³•</label>
                    <input type="text" id="acupointTechniqueInput" value="${item.technique || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                  </div>
                </div>
              `;
            } else if (itemType === 'prescription') {
              // è§£æžè¤‡è¨ºæ™‚é–“ï¼Œæ“·å–æ•¸é‡èˆ‡å–®ä½ï¼ˆå¤©ã€å‘¨ã€æœˆï¼‰ä¾›é è¨­å€¼ä½¿ç”¨
              let followNum = '';
              let followUnit = '';
              if (item && item.followUp) {
                const matchFU = String(item.followUp).match(/(\d+)\s*[ï¼ˆ(]?([å¤©å‘¨æœˆ])[^)ï¼‰]*[)ï¼‰]?/);
                if (matchFU) {
                  followNum = matchFU[1] || '';
                  followUnit = matchFU[2] || '';
                } else {
                  // è‹¥æœªåŒ…å«æ•¸å­—ï¼Œåƒ…è§£æžå–®ä½
                  if (String(item.followUp).includes('å¤©')) followUnit = 'å¤©';
                  else if (String(item.followUp).includes('å‘¨')) followUnit = 'å‘¨';
                  else if (String(item.followUp).includes('æœˆ')) followUnit = 'æœˆ';
                }
              }
              modalContent.innerHTML = `
                <div class="space-y-4">
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">æ¨¡æ¿åç¨± *</label>
                    <input type="text" id="prescriptionNameInput" value="${item.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">åˆ†é¡ž</label>
                      <select id="prescriptionCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                        ${categories.prescriptions.map(cat => '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>').join('')}
                      </select>
                    </div>
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">ç™‚ç¨‹æ™‚é–“</label>
                      <input type="text" id="prescriptionDurationInput" value="${item.duration || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">è¤‡è¨ºæ™‚é–“</label>
                      <div class="flex gap-2">
                        <input type="number" id="prescriptionFollowUpNumberInput" value="${followNum}" min="1" class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                        <select id="prescriptionFollowUpUnitInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                          <option value="å¤©" ${followUnit === 'å¤©' ? 'selected' : ''}>å¤©</option>
                          <option value="å‘¨" ${followUnit === 'å‘¨' ? 'selected' : ''}>å‘¨</option>
                          <option value="æœˆ" ${followUnit === 'æœˆ' ? 'selected' : ''}>æœˆ</option>
                        </select>
                      </div>
                    </div>
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">ä¸­è—¥æœç”¨æ–¹æ³•</label>
                      <input type="text" id="prescriptionNoteInput" value="${item.note || ''}" placeholder="å¦‚ï¼šæœè—¥å®Œç•¢å¾Œ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none">
                    </div>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">é†«å›‘å…§å®¹åŠæ³¨æ„äº‹é …</label>
                    <textarea id="prescriptionContentTextarea" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-400 focus:outline-none" rows="5">${item.content || ''}</textarea>
                  </div>
                </div>
              `;
            } else if (itemType === 'diagnosis') {
              modalContent.innerHTML = `
                <div class="space-y-4">
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">æ¨¡æ¿åç¨± *</label>
                    <input type="text" id="diagnosisNameInput" value="${item.name}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">ç§‘åˆ¥</label>
                    <select id="diagnosisCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                      ${categories.diagnosis.map(cat => '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>').join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">ä¸»è¨´</label>
                    <textarea id="diagnosisChiefComplaintInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3">${item.chiefComplaint || ''}</textarea>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">ç¾ç—…å²</label>
                    <textarea id="diagnosisCurrentHistoryInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="6">${item.currentHistory || ''}</textarea>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">èˆŒè±¡</label>
                      <textarea id="diagnosisTongueInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="2">${item.tongue || ''}</textarea>
                    </div>
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">è„ˆè±¡</label>
                      <textarea id="diagnosisPulseInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="2">${item.pulse || ''}</textarea>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">ä¸­é†«è¨ºæ–·</label>
                      <textarea id="diagnosisTcmDiagnosisInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="2">${item.tcmDiagnosis || ''}</textarea>
                    </div>
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">è­‰åž‹è¨ºæ–·</label>
                      <textarea id="diagnosisSyndromeDiagnosisInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="2">${item.syndromeDiagnosis || ''}</textarea>
                    </div>
                  </div>
                </div>
              `;
            }
          }

          function hideEditModal() {
            const modal = document.getElementById('editModal');
            if (!modal) return;
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å»ºé …ç›®ï¼Œå¦‚æžœå–æ¶ˆå‰‡å¾žé™£åˆ—ä¸­ç§»é™¤
            const isNew = modal.dataset.isNew === 'true';
            const editType = modal.dataset.editType;
            const itemIdStr = modal.dataset.itemId;
            if (isNew && editType && itemIdStr) {
              const itemId = parseInt(itemIdStr, 10);
              if (editType === 'herb') {
                herbCombinations = herbCombinations.filter(h => h.id !== itemId);
                renderHerbCombinations();
              } else if (editType === 'acupoint') {
                acupointCombinations = acupointCombinations.filter(a => a.id !== itemId);
                renderAcupointCombinations();
              } else if (editType === 'prescription') {
                // å¦‚æžœå–æ¶ˆæ–°å»ºçš„é†«å›‘æ¨¡æ¿ï¼Œç§»é™¤è©²é …
                prescriptionTemplates = prescriptionTemplates.filter(p => p.id !== itemId);
                renderPrescriptionTemplates();
              } else if (editType === 'diagnosis') {
                // å¦‚æžœå–æ¶ˆæ–°å»ºçš„è¨ºæ–·æ¨¡æ¿ï¼Œç§»é™¤è©²é …
                diagnosisTemplates = diagnosisTemplates.filter(d => d.id !== itemId);
                renderDiagnosisTemplates();
              }
              // é‡ç½® dataset æ¨™è¨˜
              delete modal.dataset.isNew;
              // é‡å° herb èˆ‡ acupoint ä¿å­˜å€‹äººè¨­å®š
              if (editType === 'herb' || editType === 'acupoint') {
                if (typeof updatePersonalSettings === 'function') {
                  try {
                    updatePersonalSettings().catch((err) => console.error('æ›´æ–°å€‹äººè¨­ç½®å¤±æ•—:', err));
                  } catch (_e) {}
                }
              }
            }
            modal.classList.add('hidden');
          }

          async function saveEdit() {
            const modal = document.getElementById('editModal');
            const editType = modal.dataset.editType;
            const itemIdStr = modal.dataset.itemId;
            if (!editType || !itemIdStr) {
              // è‹¥æ²’æœ‰è¨­å®šé¡žåž‹æˆ– IDï¼Œå‰‡ç„¡æ³•ä¿å­˜
              return;
            }
            const itemId = parseInt(itemIdStr, 10);
            // æ ¹æ“š editType æ‰¾åˆ°å°æ‡‰çš„é …ç›®ä¸¦æ›´æ–°
            if (editType === 'herb') {
              const item = herbCombinations.find(h => h.id === itemId);
              if (!item) return;
              // æª¢æŸ¥åç¨±å¿…å¡«
              const nameVal = (document.getElementById('herbNameInput').value || '').trim();
              if (!nameVal) {
                // è‹¥åç¨±ç‚ºç©ºï¼Œæç¤ºéŒ¯èª¤ä¸¦åœæ­¢ä¿å­˜ã€‚æ”¹ç”¨é ‚éƒ¨å½ˆçª—æç¤ºï¼Œä¸å†ä½¿ç”¨ç€è¦½å™¨ alertã€‚
                showToast('è«‹è¼¸å…¥çµ„åˆåç¨±ï¼', 'error');
                return;
              }
              // æ›´æ–°è³‡æ–™
              item.name = nameVal;
              item.category = document.getElementById('herbCategorySelect').value;
              item.description = document.getElementById('herbDescriptionTextarea').value;
              const ingredientRows = document.querySelectorAll('#herbIngredients > div');
              // å°‡æ¯ä¸€åˆ—çš„è³‡æ–™å–å‡ºç‚ºç‰©ä»¶é™£åˆ—
              const newIngredients = Array.from(ingredientRows).map(row => {
                // å„ªå…ˆä½¿ç”¨ dataset.herbNameï¼ˆæ–°è¨­è¨ˆï¼‰ï¼›è‹¥ä¸å­˜åœ¨å‰‡é€€å›žèˆŠçµæ§‹
                let name = '';
                let dosage = '';
                if (row.dataset && row.dataset.herbName) {
                  name = row.dataset.herbName;
                  const dosageInput = row.querySelector('input[type="number"]');
                  dosage = dosageInput ? dosageInput.value : '';
                } else {
                  const select = row.querySelector('select');
                  const inputs = row.querySelectorAll('input');
                  if (select) {
                    name = select.value;
                    dosage = inputs[0] ? inputs[0].value : '';
                  } else if (inputs.length >= 2) {
                    name = inputs[0].value;
                    dosage = inputs[1].value;
                  } else if (inputs.length === 1) {
                    name = inputs[0].value;
                  }
                }
                return { name: name, dosage: dosage };
              });
              // éŽæ¿¾å‡ºåç¨±éžç©ºçš„è—¥æï¼Œç”¨æ–¼æª¢æŸ¥æ˜¯å¦è‡³å°‘æ–°å¢žä¸€é …
              const validIngredients = newIngredients.filter(ing => ing && ing.name && String(ing.name).trim() !== '');
              if (validIngredients.length === 0) {
                // è‹¥æ²’æœ‰ä»»ä½•è—¥æï¼Œæç¤ºéŒ¯èª¤ä¸¦ä¸­æ­¢ä¿å­˜
                showToast('è«‹è‡³å°‘æ·»åŠ ä¸€å€‹è—¥æï¼', 'error');
                return;
              }
              item.ingredients = newIngredients;
              item.lastModified = new Date().toISOString().split('T')[0];
              // æ¨™è¨˜ç‚ºå·²ä¿å­˜ï¼ˆéžæ–°å»ºï¼‰ï¼Œé¿å…å–æ¶ˆæ™‚è¢«ç§»é™¤
              if (item.isNew) {
                item.isNew = false;
              }
              // ä¹Ÿæ›´æ–° modal çš„ isNew æ¨™è¨˜
              modal.dataset.isNew = 'false';
              renderHerbCombinations();
              // Persist changes for personal herb combinations to Firestore
              if (typeof updatePersonalSettings === 'function') {
                try {
                  updatePersonalSettings().catch((err) => console.error('æ›´æ–°å€‹äººè¨­ç½®å¤±æ•—:', err));
                } catch (_e) {}
              }
            } else if (editType === 'acupoint') {
              const item = acupointCombinations.find(a => a.id === itemId);
              if (!item) return;
              // æª¢æŸ¥åç¨±å¿…å¡«
              const acupointNameVal = (document.getElementById('acupointNameInput').value || '').trim();
              if (!acupointNameVal) {
                // ä½¿ç”¨çµ±ä¸€çš„å³ä¸Šè§’æç¤ºé¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
                showToast('è«‹è¼¸å…¥çµ„åˆåç¨±ï¼', 'error');
                return;
              }
              item.name = acupointNameVal;
              item.category = document.getElementById('acupointCategorySelect').value;
              const pointRows = document.querySelectorAll('#acupointPoints > div');
              // å°‡æ¯ä¸€åˆ—çš„ç©´ä½è³‡æ–™å–å‡ºç‚ºç‰©ä»¶é™£åˆ—ï¼Œæ”¯æ´æ–°èˆŠå…©ç¨®çµæ§‹
              const newPoints = Array.from(pointRows).map(row => {
                let name = '';
                // åç¨±å¯ä»¥å¾ž dataset.acupointName æˆ– input å–å¾—ã€‚
                if (row.dataset && row.dataset.acupointName) {
                  name = row.dataset.acupointName;
                } else {
                  const inputs = row.querySelectorAll('input');
                  if (inputs.length >= 1) {
                    name = inputs[0].value;
                  }
                }
                // ç”±æ–¼å·²å–æ¶ˆä¸»ç©´/é…ç©´é¸æ“‡ï¼Œä»ä¿ç•™ç©ºå­—ä¸²å±¬æ€§ä»¥èˆ‡èˆŠè³‡æ–™æ ¼å¼ç›¸å®¹
                return { name: name, type: '' };
              });
              // éŽæ¿¾å‡ºåç¨±éžç©ºçš„ç©´ä½ï¼Œç”¨æ–¼æª¢æŸ¥æ˜¯å¦è‡³å°‘æ–°å¢žä¸€é …
              const validPoints = newPoints.filter(pt => pt && pt.name && String(pt.name).trim() !== '');
              if (validPoints.length === 0) {
                // è‹¥æ²’æœ‰ä»»ä½•ç©´ä½ï¼Œæç¤ºéŒ¯èª¤ä¸¦ä¸­æ­¢ä¿å­˜
                showToast('è«‹è‡³å°‘æ·»åŠ ä¸€å€‹ç©´ä½ï¼', 'error');
                return;
              }
              item.points = newPoints;
              item.technique = document.getElementById('acupointTechniqueInput').value;
              item.lastModified = new Date().toISOString().split('T')[0];
              // æ¨™è¨˜ç‚ºå·²ä¿å­˜ï¼ˆéžæ–°å»ºï¼‰ï¼Œé¿å…å–æ¶ˆæ™‚è¢«ç§»é™¤
              if (item.isNew) {
                item.isNew = false;
              }
              // æ›´æ–° modal çš„ isNew æ¨™è¨˜
              modal.dataset.isNew = 'false';
              renderAcupointCombinations();
              // Persist changes for personal acupoint combinations to Firestore
              if (typeof updatePersonalSettings === 'function') {
                try {
                  updatePersonalSettings().catch((err) => console.error('æ›´æ–°å€‹äººè¨­ç½®å¤±æ•—:', err));
                } catch (_e) {}
              }
            } else if (editType === 'prescription') {
              const item = prescriptionTemplates.find(p => p.id === itemId);
              if (!item) return;
              // æª¢æŸ¥æ¨¡æ¿åç¨±å¿…å¡«
              const presNameVal = (document.getElementById('prescriptionNameInput').value || '').trim();
              if (!presNameVal) {
                // ä½¿ç”¨é ‚éƒ¨å½ˆçª—æç¤ºç”¨æˆ¶è¼¸å…¥æ¨¡æ¿åç¨±
                showToast('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ï¼', 'error');
                return;
              }
              item.name = presNameVal;
              item.category = document.getElementById('prescriptionCategorySelect').value;
              item.duration = document.getElementById('prescriptionDurationInput').value;
              // å–å¾—è¤‡è¨ºæ™‚é–“çš„æ•¸é‡èˆ‡å–®ä½ï¼Œçµ„åˆç‚ºã€Œæ•¸é‡ï¼ˆå–®ä½ï¼‰ã€çš„æ ¼å¼
              const fuNumEl = document.getElementById('prescriptionFollowUpNumberInput');
              const fuUnitEl = document.getElementById('prescriptionFollowUpUnitInput');
              const fuNumVal = fuNumEl ? (fuNumEl.value || '').trim() : '';
              const fuUnitVal = fuUnitEl ? fuUnitEl.value : '';
              if (fuNumVal) {
                item.followUp = fuNumVal + 'ï¼ˆ' + fuUnitVal + 'ï¼‰';
              } else {
                item.followUp = fuUnitVal;
              }
              item.content = document.getElementById('prescriptionContentTextarea').value;
              // å„²å­˜ä¸­è—¥æœç”¨æ–¹æ³•ï¼ˆnoteï¼‰åˆ°æ¨¡æ¿é …ã€‚è‹¥ç„¡è¼¸å…¥å‰‡å­˜ç‚ºç©ºå­—ä¸²ã€‚
              const noteVal = document.getElementById('prescriptionNoteInput') ? document.getElementById('prescriptionNoteInput').value : '';
              item.note = noteVal;
              item.lastModified = new Date().toISOString().split('T')[0];
              // æ¨™è¨˜ç‚ºå·²ä¿å­˜ï¼ˆéžæ–°å»ºï¼‰ï¼Œé¿å…å–æ¶ˆæ™‚è¢«ç§»é™¤
              if (item.isNew) {
                item.isNew = false;
              }
              modal.dataset.isNew = 'false';
              // ä¸å†å°‡é†«å›‘æ¨¡æ¿è³‡æ–™å¯«å…¥ Firestoreï¼›ç›´æŽ¥é‡æ–°æ¸²æŸ“åˆ—è¡¨
              renderPrescriptionTemplates();
            } else if (editType === 'diagnosis') {
              const item = diagnosisTemplates.find(d => d.id === itemId);
              if (!item) return;
              // æª¢æŸ¥æ¨¡æ¿åç¨±å¿…å¡«
              const diagNameVal = (document.getElementById('diagnosisNameInput').value || '').trim();
              if (!diagNameVal) {
                // ä½¿ç”¨é ‚éƒ¨å½ˆçª—æç¤ºç”¨æˆ¶è¼¸å…¥è¨ºæ–·æ¨¡æ¿åç¨±
                showToast('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ï¼', 'error');
                return;
              }
              item.name = diagNameVal;
              item.category = document.getElementById('diagnosisCategorySelect').value;
              // å„²å­˜å„è¨ºæ–·æ¬„ä½å…§å®¹
              item.chiefComplaint = document.getElementById('diagnosisChiefComplaintInput').value;
              item.currentHistory = document.getElementById('diagnosisCurrentHistoryInput').value;
              item.tongue = document.getElementById('diagnosisTongueInput').value;
              item.pulse = document.getElementById('diagnosisPulseInput').value;
              item.tcmDiagnosis = document.getElementById('diagnosisTcmDiagnosisInput').value;
              item.syndromeDiagnosis = document.getElementById('diagnosisSyndromeDiagnosisInput').value;
              // ç§»é™¤èˆŠè¨ºæ–·å…§å®¹æ¬„ä½ï¼Œé¿å…æ··æ·†ï¼ˆè‹¥å­˜åœ¨ï¼‰
              item.content = '';
              item.lastModified = new Date().toISOString().split('T')[0];
              // æ¨™è¨˜ç‚ºå·²ä¿å­˜ï¼ˆéžæ–°å»ºï¼‰ï¼Œé¿å…å–æ¶ˆæ™‚è¢«ç§»é™¤
              if (item.isNew) {
                item.isNew = false;
              }
              modal.dataset.isNew = 'false';
              // ä¸å†å°‡è¨ºæ–·æ¨¡æ¿è³‡æ–™å¯«å…¥ Firestoreï¼›ç›´æŽ¥é‡æ–°æ¸²æŸ“åˆ—è¡¨
              renderDiagnosisTemplates();
            }
            // ä¿å­˜æˆåŠŸå¾Œé¡¯ç¤ºæˆåŠŸæç¤ºï¼Œä¸å†ä½¿ç”¨ç€è¦½å™¨ alert
            showToast('ä¿å­˜æˆåŠŸï¼', 'success');
            hideEditModal();
          }


          function addAcupointPointField() {
            const container = document.getElementById('acupointPoints');
            const div = document.createElement('div');
            // ä½¿ç”¨ flex å¸ƒå±€è®“åˆªé™¤æŒ‰éˆ•ç½®æ–¼å³å´
            div.className = 'flex items-center gap-2';
            // å»ºç«‹åç¨±èˆ‡é¡žåž‹è¼¸å…¥æ¡†ä»¥åŠåˆªé™¤æŒ‰éˆ•ï¼Œåˆªé™¤æŒ‰éˆ•é»žæ“Šå¾Œå¯ç§»é™¤æ‰€åœ¨è¡Œ
    // èª¿æ•´ç©´ä½åç¨±æ¬„ä½å¯¬åº¦ç‚ºä¸€åŠï¼Œé¿å…åœ¨æ‰‹æ©Ÿæˆ–å°èž¢å¹•ä¸ŠéŽé•·
    // åªå»ºç«‹ç©´ä½åç¨±è¼¸å…¥æ¡†èˆ‡åˆªé™¤æŒ‰éˆ•ï¼Œä¸å†é¡¯ç¤ºä¸»ç©´/é…ç©´é¸æ“‡
    div.innerHTML = '<input type="text" placeholder="ç©´ä½åç¨±" class="flex-1 px-2 py-1 border border-gray-300 rounded"><button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeParentElement(this)">åˆªé™¤</button>';
            container.appendChild(div);
          }

          /*
           * æœç´¢ä¸¦æ–°å¢žè—¥æè‡³å€‹äººæ…£ç”¨è—¥æ–¹çµ„åˆã€‚
           * åœ¨ç·¨è¼¯è—¥æ–¹æ™‚ï¼Œä½¿ç”¨è€…å¯ä»¥åœ¨æœå°‹æ¬„è¼¸å…¥é—œéµå­—æœå°‹ä¸­è—¥åº«ä¸­çš„è—¥æï¼Œä¸¦é»žæ“Šçµæžœå°‡å…¶åŠ å…¥è—¥æåˆ—è¡¨ã€‚
           */
          function searchHerbForCombo() {
            const input = document.getElementById('herbIngredientSearch');
            if (!input) return;
            // ç¶å®šéµç›¤äº‹ä»¶ä»¥æ”¯æ´æ–¹å‘éµé¸æ“‡èˆ‡ Enter é¸å–ï¼Œé¿å…é‡è¤‡ç¶å®š
            try {
              if (!input.dataset.bindKeyDown) {
                input.addEventListener('keydown', handleHerbIngredientSearchKeyDown);
                input.dataset.bindKeyDown = 'true';
              }
            } catch (_e) {
              /* å¿½ç•¥ç¶å®šéŒ¯èª¤ */
            }
            // æ¯æ¬¡æœå°‹å‰é‡ç½®é¸ä¸­ç´¢å¼•
            herbIngredientSearchSelectionIndex = -1;
            const searchTerm = input.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('herbIngredientSearchResults');
            const resultsList = document.getElementById('herbIngredientSearchList');
            if (!resultsContainer || !resultsList) return;
            if (searchTerm.length < 1) {
              // æœå°‹å­—ä¸²ç‚ºç©ºæ™‚ï¼Œé‡ç½®ç´¢å¼•
              herbIngredientSearchSelectionIndex = -1;
              resultsContainer.classList.add('hidden');
              // ç•¶æœå°‹å­—ä¸²ç‚ºç©ºæ™‚ï¼ŒåŒæ­¥éš±è—ä»»ä½•æç¤ºæ¡†
              if (typeof hideTooltip === 'function') {
                hideTooltip();
              }
              return;
            }
            // æœç´¢ä¸¦æ ¹æ“šåŒ¹é…ç¨‹åº¦æŽ’åº herbLibrary ä¸­çš„ä¸­è—¥æèˆ‡æ–¹åŠ‘ï¼ˆåç¨±ã€åˆ¥åã€è‹±æ–‡åæˆ–åŠŸæ•ˆï¼‰
            let matched = (Array.isArray(herbLibrary) ? herbLibrary : [])
              .filter(item => item && (item.type === 'herb' || item.type === 'formula') && (
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.alias && item.alias.toLowerCase().includes(searchTerm)) ||
                (item.englishName && item.englishName.toLowerCase().includes(searchTerm)) ||
                (item.effects && item.effects.toLowerCase().includes(searchTerm))
              ))
              .map(item => {
                const ln = item.name ? item.name.toLowerCase() : '';
                const la = item.alias ? item.alias.toLowerCase() : '';
                const en = item.englishName ? item.englishName.toLowerCase() : '';
                const le = item.effects ? item.effects.toLowerCase() : '';
                let score = Infinity;
                if (ln.includes(searchTerm)) {
                  score = ln.indexOf(searchTerm);
                } else if (la.includes(searchTerm)) {
                  score = 100 + la.indexOf(searchTerm);
                } else if (en.includes(searchTerm)) {
                  score = 200 + en.indexOf(searchTerm);
                } else if (le.includes(searchTerm)) {
                  score = 300 + le.indexOf(searchTerm);
                }
                return { item, score };
              })
              .sort((a, b) => a.score - b.score)
              .map(obj => obj.item);
            // åªå–å‰ 10 ç­†
            matched = matched.slice(0, 10);
            if (matched.length === 0) {
              resultsList.innerHTML = '<div class="p-2 text-center text-gray-500 text-sm">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è—¥æ</div>';
              resultsContainer.classList.remove('hidden');
              // æ²’æœ‰ç¬¦åˆé …ç›®æ™‚ï¼Œéš±è—æç¤ºæ¡†
              if (typeof hideTooltip === 'function') {
                hideTooltip();
              }
              return;
            }
            // é¡¯ç¤ºæœå°‹çµæžœï¼šç§»é™¤åŠ‘é‡é¡¯ç¤ºä¸¦ä½¿ç”¨ tooltip é¡¯ç¤ºè©³ç´°è³‡æ–™
            resultsList.innerHTML = matched.map(item => {
              const safeName = (item.name || '').replace(/'/g, "\\'");
              // æ§‹å»ºè©³ç´°è³‡è¨Šå…§å®¹
              const details = [];
              details.push('åç¨±ï¼š' + (item.name || ''));
              if (item.alias) details.push('åˆ¥åï¼š' + item.alias);
              if (item.type === 'herb') {
                if (item.nature) details.push('æ€§å‘³ï¼š' + item.nature);
                if (item.meridian) details.push('æ­¸ç¶“ï¼š' + item.meridian);
              }
              if (item.effects) details.push('åŠŸæ•ˆï¼š' + item.effects);
              if (item.indications) details.push('ä¸»æ²»ï¼š' + item.indications);
              if (item.type === 'formula') {
                if (item.composition) details.push('çµ„æˆï¼š' + item.composition.replace(/\n/g, 'ã€'));
                if (item.usage) details.push('ç”¨æ³•ï¼š' + item.usage);
              }
              if (item.cautions) details.push('æ³¨æ„ï¼š' + item.cautions);
              const encoded = encodeURIComponent(details.join('\n'));
              // ä½¿ç”¨æ¨¡æ¿å­—ä¸²ä¾†çµ„åˆ HTMLï¼Œé¿å…å­—ä¸²ä¸²æŽ¥æ™‚çš„å¼•è™Ÿè½‰ç¾©éŒ¯èª¤
              // é€™è£¡ä½¿ç”¨å–®å¼•è™ŸåŒ…è£¹ safeName åƒæ•¸ï¼Œä¸¦ç¢ºä¿ä»»ä½•å–®å¼•è™Ÿéƒ½å·²åœ¨ä¸Šæ–¹ä»¥ \\ æ›¿æ›
              return `<div class="p-2 bg-green-50 hover:bg-green-100 border border-green-200 rounded cursor-pointer text-center text-sm" data-tooltip="${encoded}" onmouseenter="showTooltip(event, this.getAttribute('data-tooltip'))" onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()" onclick="addHerbToCombo('${safeName}', '')">${window.escapeHtml(item.name)}</div>`;
            }).join('');
            resultsContainer.classList.remove('hidden');
          }

          /**
           * å°‡æŒ‡å®šè—¥æåç¨±èˆ‡åŠ‘é‡åŠ å…¥ç›®å‰ç·¨è¼¯çš„è—¥æåˆ—è¡¨ã€‚
           * æ–°å¢žå¾Œæœƒæ¸…ç©ºæœå°‹æ¬„ä¸¦éš±è—æœå°‹çµæžœã€‚
           * @param {string} name è—¥æåç¨±
           * @param {string} dosage é è¨­åŠ‘é‡
           */
          function addHerbToCombo(name, dosage) {
            const container = document.getElementById('herbIngredients');
            if (!container) return;
            // å»ºç«‹æ–°çš„ä¸€è¡Œï¼Œä¸¦ä½¿ç”¨ç¶ è‰²èƒŒæ™¯èˆ‡é‚Šæ¡†æ¨£å¼
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 bg-green-50 hover:bg-green-100 border border-green-200 rounded';
            // å„²å­˜è—¥æåç¨±æ–¼ datasetï¼Œæ–¹ä¾¿å¾ŒçºŒä¿å­˜æ™‚è®€å–
            if (name) {
              div.dataset.herbName = name;
            }
            // è¨­å®šæç¤ºå…§å®¹ï¼ˆè‹¥æŸ¥è©¢ä¸åˆ°å‰‡ä¸è¨­å®šï¼‰
            const tooltipContent = getHerbTooltipContent(name || '');
            if (tooltipContent) {
              const encoded = encodeURIComponent(tooltipContent);
              div.setAttribute('data-tooltip', encoded);
              div.addEventListener('mouseenter', function(e) {
                showTooltip(e, this.getAttribute('data-tooltip'));
              });
              div.addEventListener('mousemove', function(e) {
                moveTooltip(e);
              });
              div.addEventListener('mouseleave', function() {
                hideTooltip();
              });
            }
            // åç¨±ä»¥ span é¡¯ç¤ºï¼ˆä¸å¯ç·¨è¼¯ï¼‰
            const nameSpan = document.createElement('span');
            nameSpan.className = 'flex-1 text-green-800';
            nameSpan.textContent = name || '';
            div.appendChild(nameSpan);
            // åŠ‘é‡è¼¸å…¥æ¬„
            const dosageInput = document.createElement('input');
            dosageInput.type = 'number';
            dosageInput.value = '';
            dosageInput.placeholder = '';
            dosageInput.className = 'w-20 px-2 py-1 border border-gray-300 rounded';
            div.appendChild(dosageInput);
            // å–®ä½
            const unitSpan = document.createElement('span');
            unitSpan.textContent = 'å…‹';
            unitSpan.className = 'text-sm text-gray-700';
            div.appendChild(unitSpan);
            // åˆªé™¤æŒ‰éˆ•
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'åˆªé™¤';
            deleteBtn.className = 'text-red-500 hover:text-red-700 text-sm';
            deleteBtn.addEventListener('click', function() {
              if (div && div.parentElement) {
                div.parentElement.removeChild(div);
              }
            });
            div.appendChild(deleteBtn);
            container.appendChild(div);
            const resultsContainer = document.getElementById('herbIngredientSearchResults');
            if (resultsContainer) {
              resultsContainer.classList.add('hidden');
            }
            const searchInput = document.getElementById('herbIngredientSearch');
            if (searchInput) {
              searchInput.value = '';
            }
            // æ–°å¢žå®Œè—¥æå¾Œéš±è—æç¤ºæ¡†ï¼Œä»¥å…ç•™ä¸‹æ®˜å½±
            if (typeof hideTooltip === 'function') {
              hideTooltip();
            }
          }

          // å°‡è‡ªè¨‚å‡½å¼æŽ›è¼‰è‡³ windowï¼Œä½¿å…¶å¯æ–¼å…§åµŒäº‹ä»¶è™•ç†å™¨ä¸­è¢«å‘¼å«
          window.searchHerbForCombo = searchHerbForCombo;
          window.addHerbToCombo = addHerbToCombo;

          /*
           * æœç´¢ä¸¦æ–°å¢žç©´ä½è‡³å€‹äººæ…£ç”¨ç©´ä½çµ„åˆã€‚
           * åœ¨ç·¨è¼¯ç©´ä½çµ„åˆæ™‚ï¼Œä½¿ç”¨è€…å¯ä»¥åœ¨æœå°‹æ¬„è¼¸å…¥é—œéµå­—æœå°‹ç©´ä½åº«ä¸­çš„ç©´ä½ï¼Œä¸¦é»žæ“Šçµæžœå°‡å…¶åŠ å…¥ç©´ä½åˆ—è¡¨ã€‚
           */
          async function searchAcupointForCombo() {
            const input = document.getElementById('acupointPointSearch');
            if (!input) return;
            // ç¶å®šéµç›¤äº‹ä»¶ä»¥æ”¯æ´æ–¹å‘éµé¸æ“‡èˆ‡ Enter é¸å–ï¼Œé¿å…é‡è¤‡ç¶å®š
            try {
              if (!input.dataset.bindKeyDown) {
                input.addEventListener('keydown', handleAcupointComboSearchKeyDown);
                input.dataset.bindKeyDown = 'true';
              }
            } catch (_e) {
              /* å¿½ç•¥ç¶å®šéŒ¯èª¤ */
            }
            // æ¯æ¬¡æœå°‹å‰é‡ç½®é¸ä¸­ç´¢å¼•
            acupointComboSearchSelectionIndex = -1;
            const searchTerm = input.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('acupointPointSearchResults');
            const resultsList = document.getElementById('acupointPointSearchList');
            if (!resultsContainer || !resultsList) return;
            // å¦‚æžœå°šæœªè¼‰å…¥ç©´ä½åº«è³‡æ–™ï¼Œå‰‡å˜—è©¦åˆå§‹åŒ–ä¸€æ¬¡ã€‚
            // ç”±æ–¼ initAcupointLibrary è¿”å›ž promiseï¼Œé€™è£¡ä½¿ç”¨ await ä»¥ç¢ºä¿è³‡æ–™å°±ç·’å¾Œå†é€²è¡Œæœå°‹ã€‚
            try {
              if (!acupointLibraryLoaded || !Array.isArray(acupointLibrary) || acupointLibrary.length === 0) {
                await initAcupointLibrary();
              }
            } catch (_e) {
              // åˆå§‹åŒ–å¤±æ•—æ™‚ä¸ä¸­æ–·æœå°‹æµç¨‹ï¼Œåƒ…è¨˜éŒ„éŒ¯èª¤ä¸¦ç¹¼çºŒã€‚
              console.error('è¼‰å…¥ç©´ä½åº«è³‡æ–™å¤±æ•—ï¼š', _e);
            }
            if (searchTerm.length < 1) {
              // è‹¥è¼¸å…¥ç‚ºç©ºï¼Œéš±è—çµæžœå®¹å™¨ä¸¦éš±è—æç¤ºæ¡†
              resultsContainer.classList.add('hidden');
              if (typeof hideTooltip === 'function') {
                hideTooltip();
              }
              return;
            }
            // éŽæ¿¾ä¸¦æ ¹æ“šåŒ¹é…ç¨‹åº¦æŽ’åº acupointLibrary ä¸­çš„ç©´ä½ï¼ˆåç¨±ã€ç¶“çµ¡ã€å®šä½ã€åŠŸæ•ˆã€ä¸»æ²»æˆ–è‹±æ–‡åï¼‰
            let matched = (Array.isArray(acupointLibrary) ? acupointLibrary : [])
              .filter(item => item && (
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.meridian && item.meridian.toLowerCase().includes(searchTerm)) ||
                (item.location && item.location.toLowerCase().includes(searchTerm)) ||
                (item.functions && (Array.isArray(item.functions) ? item.functions.join(' ').toLowerCase().includes(searchTerm) : String(item.functions).toLowerCase().includes(searchTerm))) ||
                (item.indications && (Array.isArray(item.indications) ? item.indications.join(' ').toLowerCase().includes(searchTerm) : String(item.indications).toLowerCase().includes(searchTerm))) ||
                (item.englishName && item.englishName.toLowerCase().includes(searchTerm))
              ))
              .map(item => {
                const n = item.name ? item.name.toLowerCase() : '';
                const m = item.meridian ? item.meridian.toLowerCase() : '';
                const l = item.location ? item.location.toLowerCase() : '';
                const f = item.functions ? (Array.isArray(item.functions) ? item.functions.join(' ').toLowerCase() : String(item.functions).toLowerCase()) : '';
                const i = item.indications ? (Array.isArray(item.indications) ? item.indications.join(' ').toLowerCase() : String(item.indications).toLowerCase()) : '';
                const e = item.englishName ? item.englishName.toLowerCase() : '';
                let score = Infinity;
                if (n.includes(searchTerm)) {
                  score = n.indexOf(searchTerm);
                } else if (m.includes(searchTerm)) {
                  score = 100 + m.indexOf(searchTerm);
                } else if (l.includes(searchTerm)) {
                  score = 200 + l.indexOf(searchTerm);
                } else if (f.includes(searchTerm)) {
                  score = 300 + f.indexOf(searchTerm);
                } else if (i.includes(searchTerm)) {
                  score = 400 + i.indexOf(searchTerm);
                } else if (e.includes(searchTerm)) {
                  score = 500 + e.indexOf(searchTerm);
                }
                return { item, score };
              })
              .sort((a, b) => a.score - b.score)
              .map(obj => obj.item);
            // åªé¡¯ç¤ºå‰åé …
            matched = matched.slice(0, 10);
            if (matched.length === 0) {
              resultsList.innerHTML = '<div class="p-2 text-center text-gray-500 text-sm">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç©´ä½</div>';
              resultsContainer.classList.remove('hidden');
              // æ²’æœ‰åŒ¹é…é …ç›®æ™‚ä¹Ÿéš±è—æç¤ºæ¡†
              if (typeof hideTooltip === 'function') {
                hideTooltip();
              }
              return;
            }
            // é¡¯ç¤ºæœå°‹çµæžœï¼Œæ¯å€‹çµæžœå¯é»žæ“ŠåŠ å…¥ç©´ä½æ¸…å–®ï¼Œä¸¦é¡¯ç¤º tooltip è©³ç´°è³‡æ–™
            resultsList.innerHTML = matched.map(item => {
              const safeName = (item.name || '').replace(/'/g, "\\'");
              const details = [];
              details.push('åç¨±ï¼š' + (item.name || ''));
              if (item.meridian) details.push('ç¶“çµ¡ï¼š' + item.meridian);
              if (item.location) details.push('å®šä½ï¼š' + item.location);
              if (item.functions) {
                const funcs = Array.isArray(item.functions) ? item.functions.join('ã€') : String(item.functions);
                details.push('åŠŸæ•ˆï¼š' + funcs);
              }
              if (item.indications) {
                const inds = Array.isArray(item.indications) ? item.indications.join('ã€') : String(item.indications);
                details.push('ä¸»æ²»ï¼š' + inds);
              }
              if (item.method) details.push('é‡æ³•ï¼š' + item.method);
              if (item.category) details.push('åˆ†é¡žï¼š' + item.category);
              const encoded = encodeURIComponent(details.join('\n'));
              // ä½¿ç”¨æ¨¡æ¿å­—ä¸²ä¾†çµ„åˆ HTMLï¼Œé¿å…å­—ä¸²ä¸²æŽ¥æ™‚çš„å¼•è™Ÿè½‰ç¾©éŒ¯èª¤
              // æ³¨æ„ safeName ä¸­çš„å–®å¼•è™Ÿå·²ä½¿ç”¨ \ æ›¿æ›ï¼Œå› æ­¤å¯ä»¥å®‰å…¨åœ°æ”¾å…¥å–®å¼•è™ŸåŒ…è£¹çš„ onclick å¼•æ•¸
              return `<div class="p-2 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded cursor-pointer text-center text-sm" data-tooltip="${encoded}" onmouseenter="showTooltip(event, this.getAttribute('data-tooltip'))" onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()" onclick="addAcupointToCombo('${safeName}')">${window.escapeHtml(item.name)}</div>`;
            }).join('');
            resultsContainer.classList.remove('hidden');
          }

          /**
           * å°‡æŒ‡å®šç©´ä½åç¨±åŠ å…¥ç›®å‰ç·¨è¼¯çš„ç©´ä½åˆ—è¡¨ã€‚
           * æ–°å¢žå¾Œæœƒæ¸…ç©ºæœå°‹æ¬„ä¸¦éš±è—æœå°‹çµæžœã€‚
           * @param {string} name ç©´ä½åç¨±
           */
          function addAcupointToCombo(name) {
            const container = document.getElementById('acupointPoints');
            if (!container) return;
            // å»ºç«‹æ–°çš„ä¸€è¡Œï¼Œä½¿ç”¨è—è‰²èƒŒæ™¯èˆ‡é‚Šæ¡†æ¨£å¼
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded';
            // å„²å­˜ç©´ä½åç¨±æ–¼ datasetï¼Œæ–¹ä¾¿å¾ŒçºŒä¿å­˜æ™‚è®€å–
            if (name) {
              div.dataset.acupointName = name;
            }
            // è¨­å®šæç¤ºå…§å®¹ï¼ˆè‹¥æŸ¥è©¢ä¸åˆ°å‰‡ä¸è¨­å®šï¼‰
            const tooltipContent = getAcupointTooltipContent(name || '');
            if (tooltipContent) {
              const encoded = encodeURIComponent(tooltipContent);
              div.setAttribute('data-tooltip', encoded);
              div.addEventListener('mouseenter', function(e) {
                showTooltip(e, this.getAttribute('data-tooltip'));
              });
              div.addEventListener('mousemove', function(e) {
                moveTooltip(e);
              });
              div.addEventListener('mouseleave', function() {
                hideTooltip();
              });
            }
            // åç¨±ä»¥ span é¡¯ç¤º
            const nameSpan = document.createElement('span');
            nameSpan.className = 'flex-1 text-blue-800';
            nameSpan.textContent = name || '';
            div.appendChild(nameSpan);
    // ä¸å†é¡¯ç¤ºä¸»ç©´/é…ç©´é¸æ“‡ï¼Œåƒ…é¡¯ç¤ºåç¨±èˆ‡åˆªé™¤æŒ‰éˆ•
            // åˆªé™¤æŒ‰éˆ•
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'åˆªé™¤';
            deleteBtn.className = 'text-red-500 hover:text-red-700 text-sm';
            deleteBtn.addEventListener('click', function() {
              if (div && div.parentElement) {
                div.parentElement.removeChild(div);
              }
            });
            div.appendChild(deleteBtn);
            container.appendChild(div);
            // æ¸…ç©ºæœå°‹æ¬„ä¸¦éš±è—çµæžœ
            const resultsContainer = document.getElementById('acupointPointSearchResults');
            if (resultsContainer) {
              resultsContainer.classList.add('hidden');
            }
            const searchInput = document.getElementById('acupointPointSearch');
            if (searchInput) {
              searchInput.value = '';
            }
            // æ–°å¢žå®Œç©´ä½å¾Œéš±è—æç¤ºæ¡†ï¼Œä»¥å…ç•™ä¸‹æ®˜å½±
            if (typeof hideTooltip === 'function') {
              hideTooltip();
            }
          }

          /**
           * å–å¾—æŒ‡å®šç©´ä½çš„å®Œæ•´æç¤ºå…§å®¹ã€‚
           * æ ¹æ“š acupointLibrary ä¸­çš„è³‡æ–™çµ„åˆåç¨±ã€ç¶“çµ¡ã€å®šä½ã€åŠŸæ•ˆã€ä¸»æ²»ã€é‡æ³•èˆ‡åˆ†é¡žã€‚
           * å¦‚æžœæ‰¾ä¸åˆ°å°æ‡‰çš„è³‡æ–™å‰‡å›žå‚³ç©ºå­—ä¸²ã€‚
           * @param {string} name ç©´ä½åç¨±
           * @returns {string} çµ„åˆçš„è©³ç´°å…§å®¹ï¼Œä»¥æ›è¡Œç¬¦åˆ†éš”
           */
          function getAcupointTooltipContent(name) {
            if (!name || !Array.isArray(acupointLibrary) || acupointLibrary.length === 0) return '';
            const item = acupointLibrary.find(a => a && a.name === name);
            if (!item) return '';
            const details = [];
            details.push('åç¨±ï¼š' + (item.name || ''));
            if (item.meridian) details.push('ç¶“çµ¡ï¼š' + item.meridian);
            if (item.location) details.push('å®šä½ï¼š' + item.location);
            if (item.functions) {
              const funcs = Array.isArray(item.functions) ? item.functions.join('ã€') : String(item.functions);
              details.push('åŠŸæ•ˆï¼š' + funcs);
            }
            if (item.indications) {
              const inds = Array.isArray(item.indications) ? item.indications.join('ã€') : String(item.indications);
              details.push('ä¸»æ²»ï¼š' + inds);
            }
            if (item.method) details.push('é‡æ³•ï¼š' + item.method);
            if (item.category) details.push('åˆ†é¡žï¼š' + item.category);
            return details.join('\n');
          }

          // å°‡ç©´ä½æœç´¢èˆ‡æ–°å¢žå‡½å¼æŽ›è¼‰è‡³ windowï¼Œä½¿å…¶å¯ç”±è¡Œå…§äº‹ä»¶èª¿ç”¨
          window.searchAcupointForCombo = searchAcupointForCombo;
          window.addAcupointToCombo = addAcupointToCombo;

  /**
   * è‡ªè¨‚å·¥å…·æç¤ºå‡½å¼ï¼šé¡¯ç¤ºã€ç§»å‹•èˆ‡éš±è—ã€‚
   * æ­¤ tooltip æœƒç«‹å³é¡¯ç¤ºä¸¦è·Ÿéš¨æ»‘é¼ ç§»å‹•ï¼Œå±•ç¤ºå®Œæ•´çš„ä¸­è—¥ææˆ–æ–¹åŠ‘è³‡è¨Šã€‚
   * @param {MouseEvent} event æ»‘é¼ äº‹ä»¶
   * @param {string} encodedContent encodeURIComponent è™•ç†å¾Œçš„æç¤ºå…§å®¹
   */
  function showTooltip(event, encodedContent) {
    const tooltip = document.getElementById('tooltip');
    if (!tooltip) return;
    const content = decodeURIComponent(encodedContent || '');
    // ä½¿ç”¨ innerText å¯ä»¥è™•ç†æ›è¡Œç¬¦è™Ÿï¼Œé¿å… XSS
    tooltip.innerText = content;
    tooltip.classList.remove('hidden');
    // è¨­ç½®åˆå§‹ä½ç½®ï¼Œç¨å¾®åç§»ä»¥å…é®æ“‹æ¸¸æ¨™
    const offsetX = 10;
    const offsetY = 10;
    // ä½¿ç”¨ clientX/clientY ä»¥å–å¾—è¦–çª—å…§åº§æ¨™ï¼Œé…åˆ position:fixed è®“æç¤ºé è¿‘æ¸¸æ¨™
    // è‹¥ä½¿ç”¨ pageX/pageYï¼Œç•¶ç•«é¢æœ‰æ»¾å‹•æ™‚æœƒå°Žè‡´ä½ç½®åç§»
    tooltip.style.left = (event.clientX + offsetX) + 'px';
    tooltip.style.top = (event.clientY + offsetY) + 'px';
  }

  function moveTooltip(event) {
    const tooltip = document.getElementById('tooltip');
    if (!tooltip || tooltip.classList.contains('hidden')) return;
    const offsetX = 10;
    const offsetY = 10;
    // ä½¿ç”¨ clientX/clientY ä»¥å–å¾—è¦–çª—å…§åº§æ¨™ï¼Œé…åˆ position:fixed è®“æç¤ºé è¿‘æ¸¸æ¨™
    tooltip.style.left = (event.clientX + offsetX) + 'px';
    tooltip.style.top = (event.clientY + offsetY) + 'px';
  }

  function hideTooltip() {
    const tooltip = document.getElementById('tooltip');
    if (!tooltip) return;
    tooltip.classList.add('hidden');
  }

/**
 * ç§»é™¤å…ƒç´ æ‰€åœ¨çš„çˆ¶ç¯€é»žï¼Œä¸¦åœ¨ç§»é™¤å‰éš±è—ä»»ä½•æ®˜ç•™çš„ tooltipã€‚
 * æ­¤å‡½å¼ç”¨æ–¼ inline äº‹ä»¶è™•ç†å™¨ï¼Œé¿å…åœ¨ HTML ä¸­æ’°å¯«å¤šæ¢æ•˜è¿°å°Žè‡´è§£æžéŒ¯èª¤ã€‚
 * @param {HTMLElement} el è§¸ç™¼äº‹ä»¶çš„å…ƒç´ ï¼ˆé€šå¸¸æ˜¯åˆªé™¤æŒ‰éˆ•æœ¬èº«ï¼‰
 */
function removeParentElement(el) {
  try {
    // å¦‚æžœæœ‰å®šç¾© hideTooltipï¼Œå‰‡å…ˆéš±è—æç¤ºæ¡†
    if (typeof hideTooltip === 'function') {
      hideTooltip();
    }
  } catch (_e) {
    // å¿½ç•¥ä»»ä½•éŒ¯èª¤
  }
  if (el && el.parentElement) {
    el.parentElement.remove();
  }
}

// å°‡ removeParentElement æŽ›è¼‰åˆ°å…¨åŸŸ windowï¼Œä½¿å…¶å¯ç”± inline handler èª¿ç”¨
if (typeof window !== 'undefined' && !window.removeParentElement) {
  window.removeParentElement = removeParentElement;
}

  /**
   * å–å¾—æŒ‡å®šä¸­è—¥ææˆ–æ–¹åŠ‘çš„å®Œæ•´æç¤ºå…§å®¹ã€‚
   * æ ¹æ“š herbLibrary ä¸­çš„è³‡æ–™çµ„åˆåç¨±ã€åˆ¥åã€æ€§å‘³ã€æ­¸ç¶“ã€åŠŸæ•ˆã€ä¸»æ²»ã€çµ„æˆã€ç”¨æ³•èˆ‡æ³¨æ„äº‹é …ã€‚
   * å¦‚æžœæ‰¾ä¸åˆ°å°æ‡‰çš„è³‡æ–™å‰‡å›žå‚³ç©ºå­—ä¸²ã€‚
   * @param {string} name è—¥ææˆ–æ–¹åŠ‘åç¨±
   * @returns {string} çµ„åˆçš„è©³ç´°å…§å®¹ï¼Œä»¥æ›è¡Œç¬¦åˆ†éš”
   */
  function getHerbTooltipContent(name) {
    if (!name || !Array.isArray(herbLibrary) || herbLibrary.length === 0) return '';
    // å˜—è©¦åœ¨ herbLibrary ä¸­å°‹æ‰¾åç¨±ç²¾ç¢ºåŒ¹é…çš„è³‡æ–™
    const item = herbLibrary.find(h => h && h.name === name);
    if (!item) return '';
    const details = [];
    details.push('åç¨±ï¼š' + (item.name || ''));
    if (item.alias) details.push('åˆ¥åï¼š' + item.alias);
    // ä¸­è—¥æé¡žåž‹ç‰¹æœ‰å±¬æ€§
    if (item.type === 'herb') {
      if (item.nature) details.push('æ€§å‘³ï¼š' + item.nature);
      if (item.meridian) details.push('æ­¸ç¶“ï¼š' + item.meridian);
    }
    // åŠŸæ•ˆèˆ‡ä¸»æ²»
    if (item.effects) details.push('åŠŸæ•ˆï¼š' + item.effects);
    if (item.indications) details.push('ä¸»æ²»ï¼š' + item.indications);
    // æ–¹åŠ‘é¡žåž‹çš„å…¶ä»–å±¬æ€§
    if (item.type === 'formula') {
      if (item.composition) details.push('çµ„æˆï¼š' + item.composition.replace(/\n/g, 'ã€'));
      if (item.usage) details.push('ç”¨æ³•ï¼š' + item.usage);
    }
    if (item.cautions) details.push('æ³¨æ„ï¼š' + item.cautions);
    return details.join('\n');
  }

  // å°‡ tooltip å‡½å¼æŽ›è¼‰è‡³ windowï¼Œä¾›è¡Œå…§äº‹ä»¶è™•ç†å™¨èª¿ç”¨
  window.showTooltip = showTooltip;
  window.moveTooltip = moveTooltip;
  window.hideTooltip = hideTooltip;

  /**
   * æ¸…ç©ºç©´ä½æœå°‹æ¬„ï¼Œä¸¦éš±è—æœå°‹çµæžœã€‚
   * ç”¨æ–¼é‡ç¸å‚™è¨»å€åŸŸçš„ç©´ä½å¿«é€Ÿæœå°‹ã€‚
   */
  function clearAcupointNotesSearch() {
    try {
      const input = document.getElementById('acupointNotesSearch');
      const results = document.getElementById('acupointNotesSearchResults');
      if (input) {
        input.value = '';
      }
      if (results) {
        results.classList.add('hidden');
      }
      // éš±è—æç¤ºæµ®çª—
      if (typeof hideTooltip === 'function') {
        hideTooltip();
      }
    } catch (_e) {
      console.error('æ¸…ç©ºç©´ä½æœç´¢æ¬„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', _e);
    }
  }

  /**
   * åœ¨é‡ç¸å‚™è¨»å€åŸŸæœå°‹ç©´ä½ã€‚
   * æ ¹æ“šè¼¸å…¥çš„é—œéµå­—æ–¼ acupointLibrary ä¸­ç¯©é¸åç¨±ã€ç¶“çµ¡ã€å®šä½ã€åŠŸæ•ˆæˆ–ä¸»æ²»ã€‚
   * å‹•æ…‹é¡¯ç¤ºæœå°‹çµæžœï¼Œé»žæ“Šå¯åŠ å…¥é‡ç¸å‚™è¨»ã€‚
   */
  async function searchAcupointForNotes() {
    try {
      const input = document.getElementById('acupointNotesSearch');
      const resultsContainer = document.getElementById('acupointNotesSearchResults');
      const resultsList = document.getElementById('acupointNotesSearchList');
      if (!input || !resultsContainer || !resultsList) return;
      const searchTerm = (input.value || '').trim().toLowerCase();
      // è‹¥å°šæœªè¼‰å…¥ç©´ä½åº«è³‡æ–™ï¼Œå‰‡åˆå§‹åŒ–ä¸€æ¬¡
      try {
        if (!acupointLibraryLoaded || !Array.isArray(acupointLibrary) || acupointLibrary.length === 0) {
          await initAcupointLibrary();
        }
      } catch (_er) {
        console.error('è¼‰å…¥ç©´ä½åº«å¤±æ•—ï¼š', _er);
      }
      if (!searchTerm) {
        resultsContainer.classList.add('hidden');
        // æœå°‹æ¬„æ¸…ç©ºæ™‚éš±è—æç¤º
        if (typeof hideTooltip === 'function') {
          hideTooltip();
        }
        return;
      }
      // åœ¨ç©´ä½åº«ä¸­éŽæ¿¾ç¬¦åˆæœå°‹å­—ä¸²çš„é …ç›®ä¸¦ä¾åŒ¹é…åº¦æŽ’åº
      let matched = (Array.isArray(acupointLibrary) ? acupointLibrary : [])
        .filter(item => item && (
          (item.name && item.name.toLowerCase().includes(searchTerm)) ||
          (item.meridian && item.meridian.toLowerCase().includes(searchTerm)) ||
          (item.location && item.location.toLowerCase().includes(searchTerm)) ||
          (item.functions && (Array.isArray(item.functions) ? item.functions.join(' ').toLowerCase().includes(searchTerm) : String(item.functions).toLowerCase().includes(searchTerm))) ||
          (item.indications && (Array.isArray(item.indications) ? item.indications.join(' ').toLowerCase().includes(searchTerm) : String(item.indications).toLowerCase().includes(searchTerm))) ||
          (item.englishName && item.englishName.toLowerCase().includes(searchTerm))
        ))
        .map(item => {
          const nameStr = item.name ? item.name.toLowerCase() : '';
          const meridianStr = item.meridian ? item.meridian.toLowerCase() : '';
          const locStr = item.location ? item.location.toLowerCase() : '';
          const funcStr = item.functions ? (Array.isArray(item.functions) ? item.functions.join(' ').toLowerCase() : String(item.functions).toLowerCase()) : '';
          const indStr = item.indications ? (Array.isArray(item.indications) ? item.indications.join(' ').toLowerCase() : String(item.indications).toLowerCase()) : '';
          const engStr = item.englishName ? item.englishName.toLowerCase() : '';
          let score = Infinity;
          if (nameStr.includes(searchTerm)) {
            score = nameStr.indexOf(searchTerm);
          } else if (meridianStr.includes(searchTerm)) {
            score = 100 + meridianStr.indexOf(searchTerm);
          } else if (locStr.includes(searchTerm)) {
            score = 200 + locStr.indexOf(searchTerm);
          } else if (funcStr.includes(searchTerm)) {
            score = 300 + funcStr.indexOf(searchTerm);
          } else if (indStr.includes(searchTerm)) {
            score = 400 + indStr.indexOf(searchTerm);
          } else if (engStr.includes(searchTerm)) {
            score = 500 + engStr.indexOf(searchTerm);
          }
          return { item, score };
        })
        .sort((a, b) => a.score - b.score)
        .map(obj => obj.item);
      // é™åˆ¶çµæžœæ•¸é‡é¿å…ä¸€æ¬¡è¼‰å…¥å¤ªå¤š
      matched = matched.slice(0, 10);
      if (!matched || matched.length === 0) {
        resultsList.innerHTML = '<div class="p-2 text-center text-gray-500 text-sm">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç©´ä½</div>';
        resultsContainer.classList.remove('hidden');
        // æ²’æœ‰çµæžœæ™‚éš±è—æç¤º
        if (typeof hideTooltip === 'function') {
          hideTooltip();
        }
        return;
      }
      // å»ºç«‹çµæžœåˆ—è¡¨ï¼Œæ¯å€‹çµæžœå¯ä»¥é»žæ“ŠåŠ å…¥é‡ç¸å‚™è¨»
      resultsList.innerHTML = matched.map(item => {
        const safeName = (item.name || '').replace(/'/g, "\\'");
        // æ±ºå®šé¡¯ç¤ºåç¨±ï¼šè‹±èªžä»‹é¢ä¸”æœ‰è‹±è­¯åç¨±æ™‚é¡¯ç¤ºè‹±è­¯åç¨±ï¼Œå¦å‰‡é¡¯ç¤ºä¸­æ–‡åç¨±
        let displayName = item.name || '';
        try {
          const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
          if (langSel && langSel.toLowerCase().startsWith('en') && item.englishName) {
            displayName = item.englishName;
          }
        } catch (_e) {
          displayName = item.name || '';
        }
        const details = [];
        details.push('åç¨±ï¼š' + (item.name || ''));
        if (item.meridian) details.push('ç¶“çµ¡ï¼š' + item.meridian);
        if (item.location) details.push('å®šä½ï¼š' + item.location);
        if (item.functions) {
          const funcs = Array.isArray(item.functions) ? item.functions.join('ã€') : String(item.functions);
          details.push('åŠŸæ•ˆï¼š' + funcs);
        }
        if (item.indications) {
          const inds = Array.isArray(item.indications) ? item.indications.join('ã€') : String(item.indications);
          details.push('ä¸»æ²»ï¼š' + inds);
        }
        if (item.method) details.push('é‡æ³•ï¼š' + item.method);
        if (item.category) details.push('åˆ†é¡žï¼š' + item.category);
        const encoded = encodeURIComponent(details.join('\n'));
        // ä½¿ç”¨è—è‰²èƒŒæ™¯èˆ‡é‚Šæ¡†å‘ˆç¾æœå°‹çµæžœï¼Œæ¯å€‹çµæžœå¯é»žæ“ŠåŠ å…¥å‚™è¨»
        return `<div class="p-2 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded cursor-pointer text-center text-sm" data-tooltip="${encoded}" onmouseenter="showTooltip(event, this.getAttribute('data-tooltip'))" onmousemove="moveTooltip(event)" onmouseleave="hideTooltip()" onclick="addAcupointToNotes('${safeName}')">${window.escapeHtml(displayName)}</div>`;
      }).join('');
      resultsContainer.classList.remove('hidden');
    } catch (e) {
      console.error('æœå°‹ç©´ä½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', e);
    }
  }

  /**
   * å°‡æŒ‡å®šç©´ä½åç¨±åŠ å…¥é‡ç¸å‚™è¨»çš„æ–¹å¡Šåˆ—è¡¨ã€‚
   * æ–°å¢žå¾Œæ›´æ–° textareaï¼Œæ¸…é™¤æœå°‹æ¬„èˆ‡çµæžœã€‚
   * @param {string} name ç©´ä½åç¨±
   */
  function addAcupointToNotes(name) {
    try {
      if (!name) return;
      const form = document.getElementById('formAcupunctureNotes');
      if (!form) return;
      // å»ºç«‹ä»£è¡¨ç©´ä½çš„ span å…ƒç´ 
      const span = document.createElement('span');
      // ä½¿ç”¨ç¨å¤§çš„å­—é«”ï¼Œå°‡åŽŸæœ¬çš„ text-xs æ”¹ç‚º text-sm ä»¥å¢žå¤§é¡¯ç¤ºç©´ä½åç¨±çš„å­—é«”
      span.className = 'inline-flex items-center justify-center bg-blue-100 border border-blue-200 rounded text-sm text-blue-800 px-1 py-0.5 mr-1 cursor-pointer';
      // è®“æ­¤æ–¹å¡Šæœ¬èº«ä¸å¯ç·¨è¼¯ï¼Œé¿å…ç”¨æˆ¶ä¿®æ”¹å…§æ–‡å­—
      span.setAttribute('contenteditable', 'false');
      span.dataset.acupointName = name;
      span.textContent = name;
      // è¨­å®š tooltip å…§å®¹
      const tooltipContent = getAcupointTooltipContent(name || '');
      if (tooltipContent) {
        const encoded = encodeURIComponent(tooltipContent);
        span.setAttribute('data-tooltip', encoded);
        span.addEventListener('mouseenter', function(e) { showTooltip(e, this.getAttribute('data-tooltip')); });
        span.addEventListener('mousemove', function(e) { moveTooltip(e); });
        span.addEventListener('mouseleave', function() { hideTooltip(); });
      }
      // é»žæ“Šæ–¹å¡Šå¯åˆªé™¤è©²é …
      span.addEventListener('click', function() {
        const parent = span.parentNode;
        if (parent) {
          // è‹¥æ–¹å¡Šå¾Œæœ‰å–®ç¨çš„ç©ºç™½æ–‡å­—ç¯€é»žï¼Œä¸€ä½µåˆªé™¤ï¼Œé¿å…ç•™ä¸‹æ®˜é¤˜ç©ºæ ¼
          const next = span.nextSibling;
          if (next && next.nodeType === Node.TEXT_NODE && /^\s*$/.test(next.textContent)) {
            parent.removeChild(next);
          }
          parent.removeChild(span);
        }
        if (typeof hideTooltip === 'function') hideTooltip();
      });
      // åœ¨è™•ç†æ’å…¥å‰ï¼Œç´€éŒ„ç•¶å‰æ»¾å‹•ä½ç½®ï¼Œä»¥ä¾¿æ’å…¥å¾Œæ¢å¾©æ»¾å‹•ä½ç½®
      const scrollXBefore = window.pageXOffset || document.documentElement.scrollLeft || 0;
      const scrollYBefore = window.pageYOffset || document.documentElement.scrollTop || 0;

      // å°‡ç„¦é»žè¨­è‡³é‡ç¸å‚™è¨»æ¬„ï¼Œç¢ºä¿æ¸¸æ¨™å®šä½æ–¼å¯ç·¨è¼¯å€ï¼Œä½†é¿å…æ²å‹•ç•«é¢
      if (typeof form.focus === 'function') {
        try {
          // preventScroll é¿å…è‡ªå‹•æ²å‹•ç•«é¢
          form.focus({ preventScroll: true });
        } catch (_er) {
          // è‹¥ç€è¦½å™¨ä¸æ”¯æ´ preventScrollï¼Œå‰‡æ”¹ç”¨ä¸€èˆ¬ focus
          form.focus();
        }
      }
      // å–å¾—ç•¶å‰é¸å–ç¯„åœ
      const sel = window.getSelection();
      let range = null;
      let insertAtEnd = true;
      if (sel && sel.rangeCount > 0) {
        range = sel.getRangeAt(0);
        // æª¢æŸ¥é¸å–ç¯„åœæ˜¯å¦ä½æ–¼é‡ç¸å‚™è¨»æ¬„å…§
        let container = range.commonAncestorContainer || range.startContainer;
        // è‹¥ç‚ºæ–‡æœ¬ç¯€é»žå‰‡å–å…¶çˆ¶å…ƒç´ åˆ¤æ–·
        if (container && container.nodeType === Node.TEXT_NODE) {
          container = container.parentNode;
        }
        if (container && form.contains(container)) {
          insertAtEnd = false;
        }
      }
      if (insertAtEnd || !range) {
        // è‹¥æ¸¸æ¨™ä¸åœ¨å‚™è¨»æ¬„å…§ï¼Œæˆ–æ²’æœ‰é¸å–ç¯„åœï¼Œå‰‡å°‡ span æ’å…¥è‡³æœ€å¾Œ
        form.appendChild(span);
        // åœ¨æ–¹å¡Šä¹‹å¾ŒåŠ ä¸Šä¸€å€‹ç©ºæ ¼ä»¥å€éš”å¾ŒçºŒè¼¸å…¥
        const space = document.createTextNode(' ');
        form.appendChild(space);
        // å°‡æ¸¸æ¨™ç§»åˆ°ç©ºæ ¼ä¹‹å¾Œ
        if (sel) {
          const newRange = document.createRange();
          newRange.setStartAfter(space);
          newRange.collapse(true);
          sel.removeAllRanges();
          sel.addRange(newRange);
        }
      } else {
        // åœ¨é¸å–ä½ç½®æ’å…¥ span åŠç©ºæ ¼åˆ†éš”ç¬¦
        range.deleteContents();
        range.insertNode(span);
        // åœ¨ span å¾Œæ’å…¥ä¸€å€‹ç©ºæ ¼ï¼Œä»¥å…èˆ‡å¾ŒçºŒå…§å®¹é»åœ¨ä¸€èµ·
        const space = document.createTextNode(' ');
        span.after(space);
        // å°‡æ¸¸æ¨™ç§»åˆ°ç©ºæ ¼ä¹‹å¾Œ
        if (sel) {
          const newRange = document.createRange();
          newRange.setStartAfter(space);
          newRange.collapse(true);
          sel.removeAllRanges();
          sel.addRange(newRange);
        }
      }
      // æ’å…¥å¾Œæ¸…ç©ºæœå°‹æ¬„ä¸¦éš±è—çµæžœèˆ‡æç¤º
      clearAcupointNotesSearch();
      // æ¢å¾©æ’å…¥å‰çš„æ»¾å‹•ä½ç½®ï¼Œä»¥é¿å…ç•«é¢ç§»å‹•
      try {
        window.scrollTo({ left: scrollXBefore, top: scrollYBefore, behavior: 'auto' });
      } catch (_e) {
        // è‹¥ç€è¦½å™¨ä¸æ”¯æ´ scrollTo çš„é¸é …å¯«æ³•ï¼Œå›žé€€åˆ°ç°¡å–®èª¿ç”¨
        window.scrollTo(scrollXBefore, scrollYBefore);
      }
    } catch (err) {
      console.error('æ–°å¢žç©´ä½åˆ°é‡ç¸å‚™è¨»æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', err);
    }
  }

  /**
   * åˆå§‹åŒ–é‡ç¸å‚™è¨»æ¬„ä¸­çš„å·²å­˜åœ¨ç©´ä½æ–¹å¡Šï¼Œç‚ºæ¯å€‹æ–¹å¡ŠæŽ›è¼‰æ»‘é¼ æç¤ºèˆ‡åˆªé™¤äº‹ä»¶ã€‚
   * åœ¨è¼‰å…¥æ­·å²ç—…æ­·æˆ–ç·¨è¼¯æ¨¡å¼æ™‚å‘¼å«æ­¤å‡½å¼ï¼Œä»¥ä¾¿æ–¹å¡Šä»å…·å‚™æç¤ºèˆ‡åˆªé™¤åŠŸèƒ½ã€‚
   */
  function initializeAcupointNotesSpans() {
    try {
      const container = document.getElementById('formAcupunctureNotes');
      if (!container) return;
      // æŸ¥æ‰¾æ‰€æœ‰å…·æœ‰ data-acupoint-name å±¬æ€§çš„ spanï¼Œä»£è¡¨ç©´ä½æ–¹å¡Š
      const spans = container.querySelectorAll('span[data-acupoint-name]');
      spans.forEach(span => {
        // ç¢ºä¿æ–¹å¡Šæœ¬èº«ä¸å¯ç·¨è¼¯
        span.setAttribute('contenteditable', 'false');
        const encoded = span.getAttribute('data-tooltip');
        if (encoded) {
          span.addEventListener('mouseenter', function(e) {
            showTooltip(e, encoded);
          });
          span.addEventListener('mousemove', function(e) {
            moveTooltip(e);
          });
          span.addEventListener('mouseleave', function() {
            hideTooltip();
          });
        }
        // é»žæ“Šæ–¹å¡Šå¯åˆªé™¤è‡ªèº«èˆ‡å¾Œæ–¹ç©ºç™½
        span.addEventListener('click', function() {
          const parent = span.parentNode;
          if (parent) {
            const next = span.nextSibling;
            if (next && next.nodeType === Node.TEXT_NODE && /^\s*$/.test(next.textContent)) {
              parent.removeChild(next);
            }
            parent.removeChild(span);
          }
          hideTooltip();
        });
      });
    } catch (err) {
      console.error('åˆå§‹åŒ–é‡ç¸å‚™è¨»æ–¹å¡Šå¤±æ•—:', err);
    }
  }

  // å°‡åˆå§‹åŒ–å‡½å¼æŽ›è¼‰è‡³ windowï¼Œæ–¹ä¾¿å¤–éƒ¨å‘¼å«
  window.initializeAcupointNotesSpans = initializeAcupointNotesSpans;

  /**
   * å°‡åŒ…å« HTML æ¨™ç±¤çš„å­—ä¸²è½‰æ›ç‚ºç´”æ–‡å­—ã€‚
   * ç”¨æ–¼åœ¨ç—…æ­·æŸ¥çœ‹æ¨¡å¼ä¸‹é¡¯ç¤ºé‡ç¸å‚™è¨»ï¼Œé¿å…ç›´æŽ¥é¡¯ç¤ºæ–¹å¡Šã€‚
   * @param {string} html å¸¶æœ‰ HTML å…§å®¹çš„å­—ä¸²
   * @returns {string} åŽ»é™¤æ¨™ç±¤å¾Œçš„ç´”æ–‡å­—
   */
  function stripHtmlTags(html) {
    try {
      if (!html) return '';
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      // ä½¿ç”¨ innerText å–å¾—ç´”æ–‡å­—ï¼Œé¿å…åŒ…å« HTML æ¨™ç±¤
      return tmp.innerText || tmp.textContent || '';
    } catch (_err) {
      // è‹¥æœ‰éŒ¯èª¤å‰‡å›žå‚³åŽŸå§‹å­—ä¸²ï¼Œé¿å…ç¨‹å¼ä¸­æ–·
      return html;
    }
  }

  // å°‡ stripHtmlTags å‡½å¼æŽ›è¼‰åˆ° window ä¾›æ¨¡æ¿èª¿ç”¨
  window.stripHtmlTags = stripHtmlTags;

  // å°‡è‡ªè¨‚å‡½å¼æŽ›è¼‰è‡³ window ç‰©ä»¶ï¼Œä»¥ä¾¿ HTML å…§åµŒäº‹ä»¶èª¿ç”¨
  window.searchAcupointForNotes = searchAcupointForNotes;
  window.addAcupointToNotes = addAcupointToNotes;
  window.clearAcupointNotesSearch = clearAcupointNotesSearch;

          // åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹æ¸²æŸ“è—¥æ–¹ã€ç©´ä½èˆ‡æ¨¡æ¿åˆ—è¡¨
            renderHerbCombinations();
            renderAcupointCombinations();
            renderPrescriptionTemplates();
            renderDiagnosisTemplates();
            // åœ¨æ¸²æŸ“æ¨¡æ¿å¾Œåˆå§‹åŒ–æœå°‹åŠŸèƒ½ï¼Œç¢ºä¿å¯æ‰¾åˆ°ç›¸é—œå…ƒç´ 
            try {
                if (typeof setupTemplateLibrarySearch === 'function') {
                    setupTemplateLibrarySearch();
                }
            } catch (_e) {
                console.error('åˆå§‹åŒ–æ¨¡æ¿åº«æœå°‹åŠŸèƒ½å¤±æ•—:', _e);
            }

            // ç›£è½é‡ç¸å‚™è¨»è¼¸å…¥å€çš„è¼¸å…¥äº‹ä»¶ï¼Œç•¶ç”¨éµç›¤åˆªé™¤æ–¹å¡Šæˆ–ç·¨è¼¯å…§å®¹æ™‚éš±è—æµ®çª—
            try {
                const acnForm = document.getElementById('formAcupunctureNotes');
                if (acnForm) {
                    acnForm.addEventListener('input', function() {
                        if (typeof hideTooltip === 'function') {
                            hideTooltip();
                        }
                    });
                }
            } catch (_e) {
                console.error('åˆå§‹åŒ–é‡ç¸å‚™è¨»è¼¸å…¥å€äº‹ä»¶å¤±æ•—:', _e);
            }

            /**
             * ä¸€äº›å½ˆçª—ï¼ˆä¾‹å¦‚åˆ†é¡žç®¡ç†èˆ‡ç·¨è¼¯å½ˆçª—ï¼‰åŽŸæœ¬æ˜¯åœ¨å€‹åˆ¥åŠŸèƒ½å€å¡Šä¸‹çš„å®¹å™¨ä¸­å®šç¾©ã€‚
             * ç•¶é€™äº›çˆ¶å®¹å™¨è¢«åˆ‡æ›ç‚º hidden æ™‚ï¼Œå½ˆçª—ä¹Ÿæœƒéš¨ä¹‹è¢«éš±è—ï¼Œå°Žè‡´ä½¿ç”¨è€…åœ¨å…¶ä»–åŠŸèƒ½é ç„¡æ³•å½ˆå‡ºå°è©±æ¡†ã€‚
             * ç‚ºè§£æ±ºæ­¤å•é¡Œï¼Œå°‡é€™äº›å½ˆçª—ç¯€é»žç§»å‹•åˆ° body åº•ä¸‹ï¼Œé¿å…å—çˆ¶å±¤é¡¯ç¤ºç‹€æ…‹å½±éŸ¿ã€‚
             */
            // å°‡éœ€è¦åœ¨è¨ºç—‡ç³»çµ±ä¸­ä½¿ç”¨çš„å½ˆçª—ç¯€é»žç§»å‹•åˆ° body åº•ä¸‹ï¼Œé¿å…è¢«éš±è—å€åŸŸé®è”½
            // å°‡éœ€è¦åœ¨è¨ºç—‡ç³»çµ±ä¸­ä½¿ç”¨çš„å½ˆçª—ç¯€é»žç§»å‹•åˆ° body åº•ä¸‹ï¼Œé¿å…å—çˆ¶å®¹å™¨é¡¯ç¤ºç‹€æ…‹å½±éŸ¿
            // åŒ…å«è¨ºæ–·æ¨¡æ¿èˆ‡é†«å›‘æ¨¡æ¿å½ˆçª—åœ¨å…§çš„æ‰€æœ‰æ¨¡æ…‹æ¡†
            [
                'categoryModal',
                'editModal',
                'herbComboModal',
                'acupointComboModal',
                // æ–°å¢žå°‡è¨ºæ–·æ¨¡æ¿èˆ‡é†«å›‘æ¨¡æ¿å½ˆçª—ç§»è‡³ bodyï¼Œé¿å…å› çˆ¶å±¤éš±è—è€Œç„¡æ³•é¡¯ç¤º
                'diagnosisTemplateModal',
                'prescriptionTemplateModal'
            ].forEach(function(id) {
                const modal = document.getElementById(id);
                if (modal && modal.parentElement !== document.body) {
                    document.body.appendChild(modal);
                }
            });

            // åœ¨æ·»åŠ äº‹ä»¶ç›£è½å‰ï¼Œå…ˆåˆå§‹åŒ–å€‹äººå¸¸ç”¨çµ„åˆçš„æœå°‹èˆ‡åˆ†é¡žç¯©é¸ä»‹é¢
            try {
                if (typeof setupPersonalComboSearchAndFilter === 'function') {
                    setupPersonalComboSearchAndFilter();
                }
            } catch (_e) {
                // è‹¥åˆå§‹åŒ–å¤±æ•—ï¼Œä¸å½±éŸ¿å¾ŒçºŒæµç¨‹
            }

            // ç›£è½å€‹äººæ…£ç”¨è—¥æ–¹èˆ‡ç©´ä½çµ„åˆçš„æœå°‹èˆ‡åˆ†é¡žè®Šæ›´ï¼Œä»¥å³æ™‚åˆ·æ–°åˆ—è¡¨
            try {
                // æœå°‹è¼¸å…¥æ¡†ï¼šå°æ‡‰ä¸åŒå¯èƒ½çš„ ID
                const herbSearchIds = ['herbComboSearch', 'searchHerbCombo', 'searchHerbCombination', 'herbComboSearchInput'];
                herbSearchIds.forEach(function(id) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', function() {
                            renderHerbCombinations();
                        });
                    }
                });
                // è—¥æ–¹åˆ†é¡žä¸‹æ‹‰é¸å–®
                const herbCatIds = ['herbComboCategoryFilter', 'herbComboCategory', 'herbComboCategorySelect'];
                herbCatIds.forEach(function(id) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', function() {
                            renderHerbCombinations();
                        });
                    }
                });
                // ç©´ä½æœå°‹è¼¸å…¥
                const acuSearchIds = ['acupointComboSearch', 'searchAcupointCombo', 'acupointComboSearchInput'];
                acuSearchIds.forEach(function(id) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', function() {
                            renderAcupointCombinations();
                        });
                    }
                });
                // ç©´ä½åˆ†é¡žä¸‹æ‹‰é¸å–®
                const acuCatIds = ['acupointComboCategoryFilter', 'acupointComboCategory', 'acupointComboCategorySelect'];
                acuCatIds.forEach(function(id) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', function() {
                            renderAcupointCombinations();
                        });
                    }
                });
            } catch (e) {
                console.error('åˆå§‹åŒ–æœå°‹èˆ‡åˆ†é¡žç›£è½å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
            }

            
          });

// å…¨å±€èˆ‡ç™»å…¥ç‰ˆæ¬Šè²æ˜Žåˆå§‹åŒ–ï¼šåœ¨ DOMContentLoaded å¾Œæ’å…¥å°æ‡‰çš„ç‰ˆæ¬Šè³‡è¨Šã€‚
document.addEventListener('DOMContentLoaded', function () {
  try {
    // æ’å…¥ç™»å…¥é ç‰ˆæ¬Šè²æ˜Žï¼ˆä½æ–¼ç™»å…¥æŒ‰éˆ•ä¸‹æ–¹ï¼‰
    const loginPage = document.getElementById('loginPage');
    if (loginPage && !document.getElementById('loginCopyright')) {
      // å°‹æ‰¾ç™»å…¥å¡ç‰‡å®¹å™¨
      let cardContainer = null;
      // å˜—è©¦å°‹æ‰¾å…·æœ‰ shadow æ¨£å¼çš„ç™»å…¥å¡ç‰‡
      cardContainer = loginPage.querySelector('.bg-white.rounded-2xl.shadow-2xl');
      // è‹¥æœªæ‰¾åˆ°ï¼Œå‰‡é€€è€Œæ±‚å…¶æ¬¡å°‹æ‰¾é¦–å€‹ç™½è‰²èƒŒæ™¯å®¹å™¨
      if (!cardContainer) {
        cardContainer = loginPage.querySelector('.bg-white');
      }
      if (cardContainer) {
        const loginCopy = document.createElement('div');
        loginCopy.id = 'loginCopyright';
        loginCopy.className = 'text-center mt-8 text-xs text-gray-400';
        loginCopy.innerHTML = `
          <div class="border-t border-gray-200 pt-4">
            Copyright Â© 2025 <span class="text-gray-600 font-medium">åé†«æœ‰é™å…¬å¸</span>. All rights reserved.
          </div>
        `;
        cardContainer.appendChild(loginCopy);
      }
    }

    // æ’å…¥å…¨å±€ç‰ˆæ¬Šè²æ˜Žï¼ˆé é¢åº•éƒ¨ï¼‰
    if (!document.getElementById('globalCopyright')) {
      const globalContainer = document.createElement('div');
      globalContainer.id = 'globalCopyright';
      globalContainer.className = 'max-w-7xl mx-auto px-4 py-4 mt-8';
      globalContainer.innerHTML = `
        <div class="text-center border-t border-gray-200 pt-4">
          <div class="text-xs text-gray-400">
            Copyright Â© 2025 <span class="text-gray-600 font-medium">åé†«æœ‰é™å…¬å¸</span>. All rights reserved.
          </div>
        </div>
      `;
      // é è¨­éš±è—ï¼Œç™»å…¥é é¢é¡¯ç¤ºæ™‚ä¸é¡¯ç¤ºå…¨å±€ç‰ˆæ¬Š
      globalContainer.style.display = 'none';
      document.body.appendChild(globalContainer);
    }

    // æ ¹æ“šç›®å‰é é¢ç‹€æ…‹é¡¯ç¤ºæˆ–éš±è—å°æ‡‰ç‰ˆæ¬Š
    const loginVisible = loginPage && !loginPage.classList.contains('hidden') && window.getComputedStyle(loginPage).display !== 'none';
    const globalCopyright = document.getElementById('globalCopyright');
    const loginCopyright = document.getElementById('loginCopyright');
    if (loginVisible) {
      if (globalCopyright) globalCopyright.style.display = 'none';
      if (loginCopyright) loginCopyright.style.display = '';
    } else {
      if (globalCopyright) globalCopyright.style.display = '';
      if (loginCopyright) loginCopyright.style.display = 'none';
    }
  } catch (e) {
    console.error('åˆå§‹åŒ–ç‰ˆæ¬Šè³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤', e);
  }
});

/**
 * é¡¯ç¤ºä¸»ç³»çµ±é é¢åº•éƒ¨çš„ç‰ˆæ¬Šè²æ˜Žï¼Œéš±è—ç™»å…¥é å…§çš„ç‰ˆæ¬Šã€‚
 */
function showGlobalCopyright() {
  try {
    const globalCopyright = document.getElementById('globalCopyright');
    const loginCopyright = document.getElementById('loginCopyright');
    if (globalCopyright) {
      globalCopyright.style.display = '';
    }
    if (loginCopyright) {
      loginCopyright.style.display = 'none';
    }
  } catch (e) {
    console.error('é¡¯ç¤ºå…¨å±€ç‰ˆæ¬Šæ™‚ç™¼ç”ŸéŒ¯èª¤', e);
  }
}

/**
 * é¡¯ç¤ºç™»å…¥é å…§çš„ç‰ˆæ¬Šè²æ˜Žï¼Œéš±è—é é¢åº•éƒ¨çš„ç‰ˆæ¬Šã€‚
 */
function hideGlobalCopyright() {
  try {
    const globalCopyright = document.getElementById('globalCopyright');
    const loginCopyright = document.getElementById('loginCopyright');
    if (globalCopyright) {
      globalCopyright.style.display = 'none';
    }
    if (loginCopyright) {
      loginCopyright.style.display = '';
    }
  } catch (e) {
    console.error('éš±è—å…¨å±€ç‰ˆæ¬Šæ™‚ç™¼ç”ŸéŒ¯èª¤', e);
  }
}

/**
 * ç¶²è·¯ç‹€æ…‹æª¢æ¸¬èˆ‡æç¤ºã€‚
 *
 * é€éŽç€è¦½å™¨çš„ online/offline äº‹ä»¶èˆ‡ Firebase é€£ç·šç‹€æ…‹ï¼Œ
 * åœ¨é›¢ç·šæ™‚é¡¯ç¤ºè¦†è“‹å±¤åŠæç¤ºè¨Šæ¯ï¼Œæš«åœæ‰€æœ‰æ“ä½œã€‚
 * é‡æ–°é€£ç·šå¾Œï¼Œç§»é™¤è¦†è“‹å±¤ä¸¦æç¤ºä½¿ç”¨è€…é‡æ–°æ“ä½œæˆ–è‡ªå‹•é‡è©¦ã€‚
 */
(function() {
  // ç´€éŒ„ç•¶å‰æ˜¯å¦å·²ç¶“è™•æ–¼é›¢ç·šç‹€æ…‹ï¼Œé¿å…é‡è¤‡æç¤º
  let wasOffline = false;

  /**
   * é¡¯ç¤ºç¶²è·¯é›¢ç·šè¦†è“‹å±¤ã€‚
   * @param {string} message é¡¯ç¤ºçš„è¨Šæ¯
   */
  function showOfflineOverlay(message) {
    let overlay = document.getElementById('networkOverlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'networkOverlay';
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.zIndex = '9999';
      overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';
      overlay.style.color = '#fff';
      overlay.style.fontSize = '1.5rem';
      overlay.style.textAlign = 'center';
      overlay.style.padding = '20px';
      document.body.appendChild(overlay);
    }
    overlay.innerHTML = message;
    overlay.style.display = 'flex';
  }

  /**
   * éš±è—ç¶²è·¯é›¢ç·šè¦†è“‹å±¤ã€‚
   */
  function hideOfflineOverlay() {
    const overlay = document.getElementById('networkOverlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }

  /**
   * æ ¹æ“šç€è¦½å™¨èˆ‡ Firebase é€£ç·šç‹€æ…‹æ›´æ–° UIã€‚
   * åœ¨é›¢ç·šæ™‚é¡¯ç¤ºè¦†è“‹å±¤èˆ‡æç¤ºï¼›åœ¨ç·šä¸Šæ™‚ç§»é™¤è¦†è“‹å±¤ä¸¦æç¤ºã€‚
   */
  function updateNetworkStatus() {
    // å¦‚æžœå°šæœªå–å¾— Firebase é€£ç·šç‹€æ…‹ï¼Œå…ˆåªæª¢æŸ¥ç€è¦½å™¨çš„ online ç‹€æ…‹ï¼›é¿å…åˆå§‹è¼‰å…¥éšŽæ®µèª¤åˆ¤ç‚ºé›¢ç·š
    const firebaseReady = window.firebaseStatusInitialized === true;
    const online = navigator.onLine && (firebaseReady ? window.firebaseConnected : true);
    // ç•¶é›¢ç·šä¸”å…ˆå‰æœªè™•æ–¼é›¢ç·šç‹€æ…‹æ™‚è™•ç†
    if (!online && !wasOffline) {
      wasOffline = true;
      // é¡¯ç¤ºè¦†è“‹å±¤ï¼Œä½¿ç”¨ã€Œç¶²çµ¡é€£ç·šä¸­â€¦ã€æç¤ºæ–‡å­—
      showOfflineOverlay('ç¶²çµ¡é€£ç·šä¸­â€¦');
      // ä¸å†é¡¯ç¤ºé›¢ç·šå½ˆçª—ï¼Œä»¥å…å¹²æ“¾ä½¿ç”¨è€…
    } else if (online && wasOffline) {
      // ç•¶é‡æ–°é€£ç·šä¸”ä¹‹å‰è™•æ–¼é›¢ç·šç‹€æ…‹æ™‚è™•ç†
      wasOffline = false;
      hideOfflineOverlay();
      // ä¸å†é¡¯ç¤ºæ¢å¾©å½ˆçª—ï¼Œåƒ…ç§»é™¤è¦†è“‹å±¤
      // å¯åœ¨æ­¤è™•é€²è¡Œè³‡æ–™é‡æ–°è¼‰å…¥æˆ–å…¶ä»–é‚è¼¯
    }
  }

  // å°‡æ›´æ–°å‡½å¼æŽ›è‡³å…¨åŸŸï¼Œä»¥ä¾¿å…¶ä»–æ¨¡çµ„å‘¼å«
  window.updateNetworkStatus = updateNetworkStatus;

  // ç›£è½ç€è¦½å™¨ç·šä¸Š/é›¢ç·šäº‹ä»¶
  window.addEventListener('online', updateNetworkStatus);
  window.addEventListener('offline', updateNetworkStatus);

  // ç›£è½ Firebase é€£ç·šç‹€æ…‹æ”¹è®Šäº‹ä»¶
  window.addEventListener('firebaseConnectionChanged', updateNetworkStatus);

  // åœ¨ DOMContentLoaded å¾Œç«‹å³æª¢æ¸¬ç¶²è·¯ç‹€æ…‹
  document.addEventListener('DOMContentLoaded', updateNetworkStatus);
})();

/*
 * å…¨åŸŸéµç›¤å¿«æ·èˆ‡é–’ç½®ç›£æŽ§ IIFE
 *
 * æä¾›æŒ‰éµæŽ§åˆ¶ï¼š
 *  1. Escï¼šè‹¥æœ‰å½ˆçª—å‰‡é—œé–‰å½ˆçª—ï¼›è‹¥ç„¡å½ˆçª—å‰‡åˆ‡æ›å´é‚ŠåŠŸèƒ½é¸å–®ï¼ˆé–‹å•Ÿæˆ–é—œé–‰ï¼‰ã€‚
 *  2. Enterï¼šåœ¨å½ˆçª—ä¸­æŒ‰ä¸‹ Enter æœƒè§¸ç™¼ä¸»è¦æ“ä½œï¼Œä¾‹å¦‚å„²å­˜ã€ç¢ºå®šæˆ–ç¢ºèªæŽ›è™Ÿã€‚
 *  3. ArrowLeft / ArrowRightï¼šç•¶æŸ¥çœ‹ç—…æ­·æˆ–è¨ºç—‡è¨˜éŒ„å½ˆçª—é–‹å•Ÿæ™‚ï¼Œä½¿ç”¨å·¦å³æ–¹å‘éµåˆ‡æ›è¼ƒèˆŠ/è¼ƒæ–°ç´€éŒ„ã€‚
 *
 * æ­¤ IIFE äº¦æä¾›é–’ç½®è‡ªå‹•ç™»å‡ºåŠŸèƒ½ã€‚ç™»å…¥æ™‚å¯èª¿ç”¨ startInactivityMonitoring() é–‹å§‹ç›£æŽ§ï¼›ç™»å‡ºæ™‚èª¿ç”¨ stopInactivityMonitoring() åœæ­¢ã€‚
 */
(function() {
  // ======== å…¨åŸŸæŒ‰éµè™•ç†é‚è¼¯ ========
  /**
   * å…¨åŸŸéµç›¤äº‹ä»¶è™•ç†å‡½å¼
   * @param {KeyboardEvent} ev 
   */
  function handleGlobalKeyDown(ev) {
    const key = ev && ev.key;
    const eventType = ev && ev.type;
    // åªè™•ç†ç‰¹å®šæŒ‰éµ
    if (!key || !(['Escape', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(key))) {
      return;
    }
    // åƒ…åœ¨ä¸»ç³»çµ±é é¢é¡¯ç¤ºæ™‚éŸ¿æ‡‰
    const mainSystem = document.getElementById('mainSystem');
    if (!mainSystem || mainSystem.classList.contains('hidden')) {
      return;
    }
    // æ”¶é›†å¯è¦–å½ˆçª—
    // é è¨­åªé¸å–å›ºå®šå®šä½ (position: fixed) çš„å½ˆçª—ï¼Œä¸¦ä¸” ID åŒ…å« "modal"ï¼Œä¸”æœªè¢« Tailwind çš„ hidden é¡žåˆ¥éš±è—ã€‚
    // å¦å¤–ç´å…¥æŽ’ç­ç®¡ç†çš„å½ˆçª—ï¼ˆ#scheduleManagement .modal.showï¼‰ä»¥æ”¯æ´ ESC/Enter å¿«æ·æ“ä½œã€‚
    const modalNodes = [];
    // é¸å– .fixed çš„å½ˆçª—
    document.querySelectorAll('.fixed').forEach(el => modalNodes.push(el));
    // ç´å…¥æŽ’ç­ç®¡ç†ä¸­çš„ .modal.show è¦–çª—
    document.querySelectorAll('#scheduleManagement .modal.show').forEach(el => modalNodes.push(el));
    const modals = modalNodes.filter(el => {
      // æŽ’ç­ç®¡ç†çš„è¦–çª—ä»¥ .show ç‚ºé¡¯ç¤ºæ¨™è¨˜ï¼Œç„¡éœ€åˆ¤æ–· hidden
      if (el.matches('#scheduleManagement .modal.show')) {
        return true;
      }
      // å…¶ä»–å½ˆçª—éœ€ç¬¦åˆæ¢ä»¶ï¼šæœªéš±è—ä¸” id åç¨±å« modal
      const id = (el.id || '').toLowerCase();
      return !el.classList.contains('hidden') && id.includes('modal');
    });
    // å–å¾—äº‹ä»¶ç›®æ¨™å…ƒç´ ï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦åœ¨å¯ç·¨è¼¯æ¬„ä½ä¸­
    const target = ev.target;
    const tagName = target && target.tagName ? target.tagName.toUpperCase() : '';
    // å°‡ SELECT å¾žå¯ç·¨è¼¯è¼¸å…¥æŽ’é™¤ï¼Œè®“åœ¨ä¸‹æ‹‰é¸å–®ä¸­æŒ‰ Enter ä¹Ÿèƒ½è§¸ç™¼å¿«æ·æ“ä½œ
    const isEditableInput = tagName === 'INPUT' || tagName === 'TEXTAREA' || (target && target.isContentEditable);

    // è™•ç†å·¦å³æ–¹å‘éµï¼šåœ¨ keydown éšŽæ®µæ ¹æ“šæƒ…å¢ƒåˆ‡æ›é é¢ã€‚
    if (key === 'ArrowLeft' || key === 'ArrowRight') {
      // åªåœ¨ keydown äº‹ä»¶è™•ç†æ–¹å‘éµï¼Œé¿å… keypress é‡è¤‡è™•ç†
      if (eventType !== 'keydown') {
        return;
      }
      const direction = key === 'ArrowLeft' ? -1 : 1;
      if (modals.length > 0 && !isEditableInput) {
        // è‹¥æœ‰ç—…æ­·æˆ–è¨ºç—‡å½ˆçª—ï¼Œå„ªå…ˆåˆ‡æ›å½ˆçª—å…§å®¹é 
        const activeModal = modals[modals.length - 1];
        const modalId = activeModal.id || '';
        try {
          if (modalId === 'patientMedicalHistoryModal' && typeof changePatientHistoryPage === 'function') {
            changePatientHistoryPage(direction);
            ev.preventDefault();
            ev.stopPropagation();
            return;
          }
          if (modalId === 'medicalHistoryModal' && typeof changeConsultationHistoryPage === 'function') {
            changeConsultationHistoryPage(direction);
            ev.preventDefault();
            ev.stopPropagation();
            return;
          }
        } catch (_e) {
          // è‹¥æ›é å¤±æ•—å‰‡å¿½ç•¥
        }
      }
      // å¦‚æžœæ²’æœ‰å½ˆçª—ä¸¦ä¸”ç›®å‰ç„¦é»žä¸åœ¨å¯ç·¨è¼¯è¼¸å…¥ä¸­ï¼Œå‰‡å˜—è©¦åœ¨æœ‰åˆ†é çš„åˆ—è¡¨ä¸­æ›é 
      if (!isEditableInput) {
        try {
          if (typeof navigatePagination === 'function') {
            navigatePagination(direction);
            ev.preventDefault();
            ev.stopPropagation();
          }
        } catch (_e) {
          // å¿½ç•¥æ›é éŒ¯èª¤ä»¥é¿å…å½±éŸ¿å…¶ä»–æ“ä½œ
        }
      }
      return;
    }

    // è™•ç† Esc éµï¼šåƒ…åœ¨ keydown éšŽæ®µé—œé–‰èŠå¤©è¦–çª—ã€å½ˆçª—æˆ–åˆ‡æ›å´é‚Šæ¬„
    if (key === 'Escape') {
      // åƒ…è™•ç† keydownï¼Œå¿½ç•¥ keypress
      if (eventType !== 'keydown') {
        return;
      }
      // é¦–å…ˆè™•ç†èŠå¤©å½ˆçª—ã€‚å¦‚æžœèŠå¤©å½ˆçª—å­˜åœ¨ä¸”æœªéš±è—ï¼Œå‰‡å„ªå…ˆé—œé–‰
      try {
        const chatPopup = document.getElementById('chatPopup');
        if (chatPopup && !chatPopup.classList.contains('hidden')) {
          // éš±è—èŠå¤©è¦–çª—
          chatPopup.classList.add('hidden');
          ev.preventDefault();
          ev.stopPropagation();
          return;
        }
      } catch (_e) {
        // å¿½ç•¥æŸ¥æ‰¾æˆ–é—œé–‰èŠå¤©å½ˆçª—æ™‚çš„éŒ¯èª¤
      }
      if (modals.length > 0) {
        const modal = modals[modals.length - 1];
        const modalId = modal.id || '';
        // è‹¥ç‚ºæŽ’ç­ç®¡ç†çš„æŽ’ç­æˆ–å›ºå®šç­è¦–çª—ï¼Œç›´æŽ¥èª¿ç”¨å…¶é—œé–‰å‡½å¼
        try {
          if (modalId === 'shiftModal' && typeof scheduleCloseModal === 'function') {
            scheduleCloseModal();
            ev.preventDefault();
            ev.stopPropagation();
            return;
          }
          if (modalId === 'fixedScheduleModal' && typeof scheduleCloseFixedScheduleModal === 'function') {
            scheduleCloseFixedScheduleModal();
            ev.preventDefault();
            ev.stopPropagation();
            return;
          }
        } catch (_e) {
          // ignore errors and continue fallback
        }
        // å˜—è©¦å°‹æ‰¾å–æ¶ˆ/é—œé–‰æŒ‰éˆ•ï¼Œé¿å…é¸ä¸­å°Žè¦½æŒ‰éˆ•ï¼ˆå¦‚ä¸Šä¸€é /ä¸‹ä¸€é ï¼‰
        let cancelBtn =
          modal.querySelector('button[id*="cancel" i]') ||
          modal.querySelector('button[id*="hide" i]') ||
          modal.querySelector('button[id*="close" i]') ||
          modal.querySelector('button[onclick*="hide"]') ||
          modal.querySelector('button[onclick*="close"]');
        if (cancelBtn && typeof cancelBtn.click === 'function') {
          cancelBtn.click();
        } else {
          // è‹¥æ‰¾ä¸åˆ°å¯é»žæ“Šçš„é—œé–‰æŒ‰éˆ•ï¼Œä¾å½ˆçª— id å‘¼å«æŒ‡å®šçš„é—œé–‰å‡½å¼æˆ–ç›´æŽ¥éš±è—
          try {
            if (modalId === 'patientDetailModal' && typeof closePatientDetail === 'function') {
              closePatientDetail();
            } else if (modalId === 'patientMedicalHistoryModal' && typeof closePatientMedicalHistoryModal === 'function') {
              closePatientMedicalHistoryModal();
            } else if (modalId === 'medicalHistoryModal' && typeof closeMedicalHistoryModal === 'function') {
              closeMedicalHistoryModal();
            } else if (modalId === 'registrationModal' && typeof closeRegistrationModal === 'function') {
              closeRegistrationModal();
            } else {
              // å°æ–¼æŽ’ç­ç®¡ç†æ¨¡æ…‹æ¡†ä»¥å¤–çš„å›ºå®šå®šä½å½ˆçª—ï¼Œå¯å˜—è©¦ç”¨ Tailwind çš„ hidden é¡žé—œé–‰
              modal.classList.add('hidden');
            }
          } catch (_e) {
            // è‹¥èª¿ç”¨é—œé–‰å‡½å¼å¤±æ•—ï¼Œç›´æŽ¥éš±è—
            modal.classList.add('hidden');
          }
        }
        ev.preventDefault();
        ev.stopPropagation();
      } else {
        // ç„¡å½ˆçª—æ™‚åˆ‡æ›å´é‚Šæ¬„ï¼šé–‹å•Ÿæˆ–é—œé–‰
        const sidebar = document.getElementById('sidebar');
        if (sidebar && typeof toggleSidebar === 'function') {
          toggleSidebar();
          ev.preventDefault();
          ev.stopPropagation();
        }
      }
      return;
    }

    // è™•ç† Enter éµï¼šåœ¨å½ˆçª—ä¸­è§¸ç™¼ä¸»è¦æ“ä½œã€‚åƒ…åœ¨ keypress éšŽæ®µè™•ç†ï¼Œé¿å…åœ¨ keydown é‡è¤‡è§¸ç™¼ã€‚
    if (key === 'Enter') {
      // åƒ…è™•ç† keypress äº‹ä»¶ï¼Œå¿½ç•¥ keydown ä»¥é¿å…é‡è¤‡è§¸ç™¼
      if (eventType !== 'keypress') {
        return;
      }
      // æ²’æœ‰å½ˆçª—æ™‚ç„¡éœ€è™•ç†
      if (modals.length === 0) {
        return;
      }
      const modal = modals[modals.length - 1];
      const modalId = modal.id || '';
      // è‹¥ç‚ºæŽ›è™Ÿå½ˆçª—ï¼Œç›´æŽ¥åŸ·è¡Œ confirmRegistrationï¼ˆå³ä½¿ç„¦é»žåœ¨ä¸‹æ‹‰é¸å–®ä¸­ï¼‰
      if (modalId === 'registrationModal' && typeof confirmRegistration === 'function') {
        try {
          confirmRegistration();
        } catch (_e) {
          // å¿½ç•¥éŒ¯èª¤
        }
        ev.preventDefault();
        ev.stopPropagation();
        return;
      }
      // æŽ’ç­ç®¡ç†å½ˆçª—ï¼šshiftModal èˆ‡ fixedScheduleModal
      // æŒ‰ Enter æ™‚ç›´æŽ¥åŸ·è¡Œæ–°å¢žæˆ–å»ºç«‹ï¼Œç„¡è«–ç„¦é»žæ˜¯å¦åœ¨ä¸‹æ‹‰é¸å–®ä¸­ã€‚
      try {
        if (modalId === 'shiftModal' && typeof scheduleAddShift === 'function') {
          scheduleAddShift();
          ev.preventDefault();
          ev.stopPropagation();
          return;
        }
        if (modalId === 'fixedScheduleModal' && typeof scheduleCreateFixedSchedule === 'function') {
          scheduleCreateFixedSchedule();
          ev.preventDefault();
          ev.stopPropagation();
          return;
        }
      } catch (_e) {
        // å¿½ç•¥èª¿ç”¨éŒ¯èª¤ï¼Œç¹¼çºŒä»¥ä¸‹é‚è¼¯
      }
      // åœ¨å…¶ä»–å¯ç·¨è¼¯è¼¸å…¥ï¼ˆå¦‚ INPUT/TEXTAREA/contentEditableï¼‰ä¸­ï¼Œä¸æ””æˆª Enter
      if (isEditableInput) {
        return;
      }
      // ä¸€èˆ¬å½ˆçª—ï¼šå°‹æ‰¾ä¸»è¦ç¢ºèªæŒ‰éˆ•
      const buttons = Array.from(modal.querySelectorAll('button')).filter(btn => !btn.disabled && btn.offsetParent !== null);
      let confirmBtn = null;
      // å„ªå…ˆæ ¹æ“š id æˆ– onclick å±¬æ€§åŒ¹é… save/confirm/apply/ok æˆ–åŒ…å« confirm
      confirmBtn = buttons.find(btn => {
        const idAttr = btn.id || '';
        const onclickAttr = (btn.getAttribute && btn.getAttribute('onclick')) || '';
        return /save|confirm|apply|ok/i.test(idAttr) || /confirm/i.test(onclickAttr);
      });
      if (!confirmBtn) {
        // å†ä»¥æŒ‰éˆ•æ–‡å­—åŒ¹é…å¸¸è¦‹ä¸­æ–‡æ–‡æ¡ˆ
        confirmBtn = buttons.find(btn => {
          const text = (btn.textContent || '').trim();
          return /å„²å­˜|ä¿å­˜|æ›´æ–°|ç¢ºå®š|å¥—ç”¨|æ–°å¢ž|ç¢ºèª|æŽ›è™Ÿ/.test(text);
        });
      }
      if (!confirmBtn) {
        // å–ç¬¬ä¸€å€‹èƒŒæ™¯éžç°è‰²æŒ‰éˆ•
        confirmBtn = buttons.find(btn => !/bg-gray/.test(btn.className || ''));
      }
      if (!confirmBtn && buttons.length > 0) {
        // æœ€å¾Œé€€è€Œæ±‚å…¶æ¬¡å–æœ€å¾Œä¸€å€‹æŒ‰éˆ•
        confirmBtn = buttons[buttons.length - 1];
      }
      if (confirmBtn && typeof confirmBtn.click === 'function') {
        confirmBtn.click();
        ev.preventDefault();
        ev.stopPropagation();
      }
      return;
    }
  }
  // è¨»å†Šå…¨åŸŸéµç›¤ç›£è½
  // ä½¿ç”¨ capture éšŽæ®µä¸¦åŒæ™‚ç›£è½ keydown èˆ‡ keypressï¼Œä»¥ä¾¿åœ¨æŸäº›è¡¨å–®å…ƒä»¶ï¼ˆå¦‚ <select>ï¼‰ä¸­
  // æŒ‰ä¸‹ Enter æ™‚ä»èƒ½æ•æ‰äº‹ä»¶ã€‚å°æ–¼ä¸åŒäº‹ä»¶é¡žåž‹ä½¿ç”¨åŒä¸€è™•ç†å‡½å¼ã€‚
  document.addEventListener('keydown', handleGlobalKeyDown, true);
  document.addEventListener('keypress', handleGlobalKeyDown, true);

  // ======== é–’ç½®è‡ªå‹•ç™»å‡ºé‚è¼¯ ========
  // é–’ç½®æ™‚é–“é™åˆ¶ï¼ˆæ¯«ç§’ï¼‰ï¼Œé è¨­ç‚º 30 åˆ†é˜
  const INACTIVITY_LIMIT = 30 * 60 * 1000;
  let inactivityTimeoutId = null;
  let activityHandler = null;
  const activityEvents = ['mousemove', 'keydown', 'click', 'touchstart', 'scroll'];

  /**
   * é‡ç½®é–’ç½®è¨ˆæ™‚å™¨ã€‚
   */
  function resetInactivityTimer() {
    if (inactivityTimeoutId) {
      clearTimeout(inactivityTimeoutId);
    }
    inactivityTimeoutId = setTimeout(() => {
      try {
        // åˆ°é”é–’ç½®æ™‚é–“å¾Œè‡ªå‹•ç™»å‡º
        if (typeof showToast === 'function') {
          const lang = localStorage.getItem('lang') || 'zh';
          const zhMsg = 'é–’ç½®æ™‚é–“éŽé•·ï¼Œè‡ªå‹•ç™»å‡º';
          const enMsg = 'Logged out due to inactivity';
          showToast(lang === 'en' ? enMsg : zhMsg, 'warning');
        }
        if (typeof logout === 'function') {
          logout();
        }
      } catch (e) {
        console.error('è‡ªå‹•ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
      }
    }, INACTIVITY_LIMIT);
  }

  /**
   * é–‹å§‹é–’ç½®ç›£æŽ§ã€‚åœ¨ç™»å…¥å¾Œèª¿ç”¨ã€‚
   */
  function startInactivityMonitoring() {
    stopInactivityMonitoring();
    activityHandler = function() {
      resetInactivityTimer();
    };
    activityEvents.forEach(evt => {
      document.addEventListener(evt, activityHandler);
    });
    resetInactivityTimer();
  }

  /**
   * åœæ­¢é–’ç½®ç›£æŽ§ã€‚åœ¨ç™»å‡ºå¾Œèª¿ç”¨ã€‚
   */
  function stopInactivityMonitoring() {
    if (activityHandler) {
      activityEvents.forEach(evt => {
        document.removeEventListener(evt, activityHandler);
      });
      activityHandler = null;
    }
    if (inactivityTimeoutId) {
      clearTimeout(inactivityTimeoutId);
      inactivityTimeoutId = null;
    }
  }

  // å°‡æŽ§åˆ¶å‡½å¼æŽ›åˆ° windowï¼Œä½¿å…¶å¯è¢«å¤–éƒ¨èª¿ç”¨
  window.startInactivityMonitoring = startInactivityMonitoring;
  window.stopInactivityMonitoring = stopInactivityMonitoring;
})();

/*
 * ç©´ä½åœ–é¸å–åŠŸèƒ½
 *
 * åœ¨é‡ç¸å‚™è¨»å€åŸŸæä¾›ä¸€å€‹æŒ‰éˆ•ï¼Œé»žæ“Šå¯é–‹å•Ÿç©´ä½åœ–çš„å½ˆçª—ï¼Œä½¿ç”¨è€…å¯åœ¨åœ–ä¸Šé¸æ“‡ç©´ä½ã€‚
 * æ–¼å½ˆçª—ç¢ºèªå¾Œï¼Œé¸å–çš„ç©´ä½æœƒä»¥æ–¹å¡Šå½¢å¼æ·»åŠ è‡³é‡ç¸å‚™è¨»è¼¸å…¥å€ã€‚
 */
(function() {
  /**
   * é–‹å•Ÿç©´ä½é¸æ“‡åœ°åœ–çš„å½ˆçª—ã€‚
   * æœƒè‡ªå‹•åˆå§‹åŒ–ç©´ä½åº«èˆ‡åº§æ¨™è³‡æ–™ï¼Œä¸¦åœ¨å½ˆçª—å…§é¡¯ç¤ºå¯äº’å‹•çš„ç©´ä½åœ–ã€‚
   * ä½¿ç”¨è€…é»žæ“Šç©´ä½å¾Œå¯é¸å–æˆ–å–æ¶ˆï¼ŒæŒ‰ä¸‹ç¢ºèªå¾Œå°‡æ–°å¢žé¸å–çš„ç©´ä½è‡³é‡ç¸å‚™è¨»ã€‚
   */
  async function openAcupointMapForNotes() {
    try {
      // ç¢ºä¿ç©´ä½åº«å·²è¼‰å…¥
      if (!window.acupointLibraryLoaded || !Array.isArray(window.acupointLibrary) || window.acupointLibrary.length === 0) {
        if (typeof initAcupointLibrary === 'function') {
          try {
            await initAcupointLibrary();
          } catch (_initErr) {
            console.error('è¼‰å…¥ç©´ä½åº«å¤±æ•—ï¼š', _initErr);
          }
        }
      }
      // å¥—ç”¨åº§æ¨™è³‡æ–™ï¼ˆè‹¥å‡½å¼å­˜åœ¨ï¼‰
      try {
        if (typeof window.applyAcupointCoordinates === 'function') {
          window.applyAcupointCoordinates();
        }
      } catch (_cErr) {}
      // å¾žå‚™è¨»æ¬„æ”¶é›†å·²å­˜åœ¨çš„ç©´ä½åç¨±
      const existingSpans = document.querySelectorAll('#formAcupunctureNotes span[data-acupoint-name]');
      const existingSet = new Set();
      existingSpans.forEach(span => {
        const n = span && span.dataset ? span.dataset.acupointName : '';
        if (n) existingSet.add(n);
      });
      // åˆå§‹åŒ–é¸å–åå–®ç‚ºå·²æœ‰ç©´ä½
      const selectedNames = Array.from(existingSet);
      // æ±ºå®šä»‹é¢èªžè¨€
      let lang = 'zh';
      try {
        const langSel = (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) ? localStorage.getItem('lang') : 'zh';
        if (langSel) lang = langSel.toLowerCase();
      } catch (_e) {}
      const isEn = lang.startsWith('en');
      const title = isEn ? 'Select Acupoints' : 'é¸æ“‡ç©´ä½';
      const confirmText = isEn ? 'Confirm' : 'ç¢ºå®š';
      const cancelText = isEn ? 'Cancel' : 'å–æ¶ˆ';
      // é–‹å•Ÿå½ˆçª—
      await Swal.fire({
        title: title,
        html: '<div id="acupointSelectMapContainer" style="width:100%;height:420px;"></div>',
        width: '80%',
        showCancelButton: true,
        confirmButtonText: confirmText,
        cancelButtonText: cancelText,
        focusConfirm: false,
        didOpen: () => {
          initAcupointSelectionMapForNotes('acupointSelectMapContainer', selectedNames, existingSet);
        },
        preConfirm: () => {
          return selectedNames.slice();
        }
      }).then(result => {
        try {
          if (result && result.value && Array.isArray(result.value)) {
            result.value.forEach(name => {
              if (!existingSet.has(name)) {
                try {
                  if (typeof addAcupointToNotes === 'function') {
                    addAcupointToNotes(name);
                  }
                } catch (_addErr) {
                  console.error('åŠ å…¥ç©´ä½åˆ°å‚™è¨»å¤±æ•—ï¼š', _addErr);
                }
              }
            });
          }
        } catch (_resErr) {
          console.error('è™•ç†ç©´ä½é¸å–çµæžœæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', _resErr);
        }
      });
    } catch (err) {
      console.error('é–‹å•Ÿç©´ä½åœ–å½ˆçª—å¤±æ•—ï¼š', err);
    }
  }

  /**
   * åˆå§‹åŒ–ç©´ä½é¸æ“‡åœ°åœ–ï¼Œä¸¦åœ¨åœ–ä¸Šæ·»åŠ ç©´ä½æ¨™è¨˜ã€‚
   * @param {string} containerId ç›®æ¨™å®¹å™¨çš„ ID
   * @param {string[]} selectedNames é¸å–çš„ç©´ä½åç¨±é™£åˆ—ï¼Œæœƒåœ¨ä½¿ç”¨è€…äº’å‹•æ™‚æ›´æ–°
   * @param {Set<string>} existingSet å·²å­˜åœ¨æ–¼å‚™è¨»ä¸­çš„ç©´ä½åç¨±é›†åˆ
   */
  function initAcupointSelectionMapForNotes(containerId, selectedNames, existingSet) {
    try {
      const container = document.getElementById(containerId);
      if (!container) return;
      // è¼‰å…¥ç©´ä½åœ–å½±åƒ
      const img = new Image();
      img.src = 'images/combined_three.png';
      img.onload = function() {
        try {
          const w = img.width;
          const h = img.height;
          // å¥—ç”¨åº§æ¨™è³‡æ–™ï¼Œä»¥ç¢ºä¿æ‰€æœ‰ç©´ä½éƒ½å…·å‚™ x/y
          try {
            if (typeof window.applyAcupointCoordinates === 'function') {
              window.applyAcupointCoordinates();
            }
          } catch (_er) {}
          // å»ºç«‹åœ°åœ–
          const map = L.map(container, {
            crs: L.CRS.Simple,
            maxZoom: 4,
            zoomControl: true,
            attributionControl: false
          });
          const bounds = [[0, 0], [h, w]];
          L.imageOverlay(img.src, bounds).addTo(map);
          const baseZoom = map.getBoundsZoom(bounds);
          const initialZoom = baseZoom - 1;
          if (typeof map.setMinZoom === 'function') {
            map.setMinZoom(initialZoom);
          } else {
            map.options.minZoom = initialZoom;
          }
          if (typeof map.setMaxBounds === 'function') {
            map.setMaxBounds(bounds);
          }
          map.options.maxBoundsViscosity = 1.0;
          map.setView([h / 2, w / 2], initialZoom);
          const defaultStyle = { color: '#2563eb', fillColor: '#2563eb', weight: 0, fillOpacity: 0.85, radius: 4 };
          const selectedStyle = { color: '#dc2626', fillColor: '#dc2626', weight: 0, fillOpacity: 0.85, radius: 5 };
          const library = Array.isArray(window.acupointLibrary) ? window.acupointLibrary : [];
          library.forEach(ac => {
            if (ac && typeof ac.x === 'number' && typeof ac.y === 'number') {
              const lat = h * ac.y;
              const lon = w * ac.x;
              const marker = L.circleMarker([lat, lon], Object.assign({}, defaultStyle));
              marker.acName = ac.name || '';
              marker.selected = false;
              // è‹¥ç©´ä½å·²åœ¨å‚™è¨»ä¸­æˆ–é è¨­é¸å–ï¼Œæ¨™è¨˜ç‚ºå·²é¸
              if (existingSet.has(marker.acName) || selectedNames.includes(marker.acName)) {
                marker.selected = true;
                marker.setStyle(selectedStyle);
              }
              marker.addTo(map);
              // åˆ‡æ›é¸å–ç‹€æ…‹
              marker.on('click', function() {
                marker.selected = !marker.selected;
                if (marker.selected) {
                  marker.setStyle(selectedStyle);
                  if (!selectedNames.includes(marker.acName)) {
                    selectedNames.push(marker.acName);
                  }
                } else {
                  marker.setStyle(defaultStyle);
                  const idx = selectedNames.indexOf(marker.acName);
                  if (idx >= 0) {
                    selectedNames.splice(idx, 1);
                  }
                }
              });
              // ç¶å®šç°¡æ˜“æç¤ºæˆ–è©³ç´°å…§å®¹
              try {
                let tooltipContent = '';
                if (typeof getAcupointTooltipContent === 'function') {
                  tooltipContent = getAcupointTooltipContent(marker.acName) || '';
                } else {
                  tooltipContent = marker.acName;
                }
                const html = String(tooltipContent).replace(/\n/g, '<br>');
                marker.bindTooltip(html, { direction: 'top', offset: [0, -10], opacity: 0.9 });
              } catch (_tipErr) {
                // å¦‚æžœç„¡æ³•å–å¾—æç¤ºå‰‡å¿½ç•¥
              }
            }
          });
        } catch (innerErr) {
          console.error('åˆå§‹åŒ–ç©´ä½é¸æ“‡åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', innerErr);
        }
      };
      img.onerror = function() {
        console.warn('ç„¡æ³•è¼‰å…¥ç©´ä½åœ–å½±åƒ');
      };
    } catch (outerErr) {
      console.error('åˆå§‹åŒ–ç©´ä½é¸æ“‡åœ°åœ–å¤±æ•—ï¼š', outerErr);
    }
  }
  // å°‡é–‹å•Ÿå½ˆçª—çš„å‡½å¼æŽ›è¼‰è‡³ windowï¼Œä¾› HTML æŒ‰éˆ•èª¿ç”¨
  if (typeof window !== 'undefined') {
    window.openAcupointMapForNotes = openAcupointMapForNotes;
  }
})();
